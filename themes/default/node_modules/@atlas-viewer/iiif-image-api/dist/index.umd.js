(function(s,m){typeof exports=="object"&&typeof module<"u"?m(exports):typeof define=="function"&&define.amd?define(["exports"],m):(s=typeof globalThis<"u"?globalThis:s||self,m(s.IIIFImageApi={}))})(this,function(s){"use strict";function m(i){return i.endsWith("info.json")?i:i.endsWith("/")?`${i}info.json`:`${i}/info.json`}const ne="http://library.stanford.edu/iiif/image-api/compliance.html#level0",O="http://library.stanford.edu/iiif/image-api/compliance.html#level1",L="http://library.stanford.edu/iiif/image-api/compliance.html#level2",re="http://library.stanford.edu/iiif/image-api/conformance.html#level0",z="http://library.stanford.edu/iiif/image-api/conformance.html#level1",M="http://library.stanford.edu/iiif/image-api/conformance.html#level2",ae="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0",C="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1",N="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2",se="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0",b="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1",R="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2",oe="http://iiif.io/api/image/1/level0.json",le="http://iiif.io/api/image/1/profiles/level0.json",P="http://iiif.io/api/image/1/level1.json",W="http://iiif.io/api/image/1/profiles/level1.json",j="http://iiif.io/api/image/1/level2.json",G="http://iiif.io/api/image/1/profiles/level2.json",fe="http://iiif.io/api/image/2/level0.json",he="http://iiif.io/api/image/2/profiles/level0.json",$="http://iiif.io/api/image/2/level1.json",T="http://iiif.io/api/image/2/profiles/level1.json",B="http://iiif.io/api/image/2/level2.json",V="http://iiif.io/api/image/2/profiles/level2.json",ue="level0",H="level1",k="level2",ce="http://iiif.io/api/image/2/level0",D="http://iiif.io/api/image/2/level1",Q="http://iiif.io/api/image/2/level2",U=[Q,L,M,N,R,j,G,B,V,k],J=[...U,D,O,z,C,b,P,W,$,T,H],Z=[ce,D,Q,ne,O,L,re,z,M,ae,C,N,se,b,R,oe,le,P,W,j,G,fe,he,$,T,B,V,ue,H,k],De=Z,de={extraFormats:["jpg"],extraQualities:["default"],extraFeatures:["sizeByWhListed"]},ge={extraFormats:["jpg"],extraQualities:["default"],extraFeatures:["baseUriRedirect","cors","jsonldMediaType","regionByPx","regionSquare","sizeByWhListed","sizeByH","sizeByW","sizeByWh"]},me={extraFormats:["jpg","png"],extraQualities:["default"],extraFeatures:["baseUriRedirect","cors","jsonldMediaType","regionByPct","regionByPx","regionSquare","rotationBy90s","sizeByWhListed","sizeByConfinedWh","sizeByH","sizeByPct","sizeByW","sizeByWh"]},K=["baseUriRedirect","canonicalLinkHeader","cors","jsonldMediaType","mirroring","profileLinkHeader","regionByPct","regionByPx","regionSquare","rotationArbitrary","rotationBy90s","sizeByConfinedWh","sizeByH","sizeByPct","sizeByW","sizeByWh","sizeUpscaling","sizeByWhListed","sizeByDistortedWh","sizeByForcedWh"];function Ie(i){return U.indexOf(i)!==-1?me:J.indexOf(i)!==-1?ge:de}function X(i){const e=i?Array.isArray(i.profile)?i.profile:[i.profile]:[],t={extraQualities:[],extraFormats:[],extraFeatures:[]};for(let n of e)if(typeof n=="string"&&(n=Ie(n)),!!n){if(n.formats)for(const r of n.formats)t.extraFormats.indexOf(r)===-1&&t.extraFormats.push(r);if(n.qualities)for(const r of n.qualities)t.extraQualities.indexOf(r)===-1&&t.extraQualities.push(r);if(n.supports)for(const r of n.supports)t.extraFeatures.indexOf(r)===-1&&t.extraFeatures.push(r);if(n.maxHeight&&(t.maxHeight=n.maxHeight),n.maxWidth&&(t.maxWidth=n.maxWidth),n.maxArea&&(t.maxArea=n.maxArea),n.extraFormats)for(const r of n.extraFormats)t.extraFormats.indexOf(r)===-1&&t.extraFormats.push(r);if(n.extraQualities)for(const r of n.extraQualities)t.extraQualities.indexOf(r)===-1&&t.extraQualities.push(r);if(n.extraFeatures)for(const r of n.extraFeatures)t.extraFeatures.indexOf(r)===-1&&t.extraFeatures.push(r);n.maxHeight&&(t.maxHeight=n.maxHeight),n.maxWidth&&(t.maxWidth=n.maxWidth),n.maxArea&&(t.maxArea=n.maxArea)}if(i.extraFormats)for(const n of i.extraFormats)t.extraFormats.indexOf(n)===-1&&t.extraFormats.push(n);if(i.extraFeatures)for(const n of i.extraFeatures)t.extraFeatures.indexOf(n)===-1&&t.extraFeatures.push(n);if(i.extraQualities)for(const n of i.extraQualities)t.extraQualities.indexOf(n)===-1&&t.extraQualities.push(n);return t}function _e(i){try{if(i==="full")return{full:!0};if(i==="square")return{square:!0};const e=i.startsWith("pct:"),n=i.substr(e?4:0).split(",").map(r=>parseFloat(r));return{x:n[0],y:n[1],w:n[2],h:n[3],percent:e}}catch{throw new Error("Expected 'full', 'square' or 'x,y,w,h'. Found "+i)}}function pe(i){const e={upscaled:!1,max:!1,confined:!1};if(i[0]==="^"&&(e.upscaled=!0,i=i.slice(1)),i==="max"||i==="full")return e.max=!0,e.serialiseAsFull=i==="full",e;if(i[0]==="!"&&(e.confined=!0,i=i.slice(1)),i[0]==="p")return e.percentScale=parseFloat(i.slice(4)),e;const t=i.split(",").map(n=>n.trim());return t.length&&(t[0]!==""&&(e.width=parseInt(t[0],10)),t[1]!==""?(e.height=parseInt(t[1],10),e.version=2):e.version=3),e}function Fe(i){const e={angle:0};if(i[0]==="!"&&(e.mirror=!0,i=i.substr(1)),e.angle=parseFloat(i)%360,Number.isNaN(e.angle))throw new Error(`Invalid rotation ${i}`);return e}function Se(i,e=""){const t=i.match(/^(([a-zA-Z]+):\/\/([^/]+))?((.*)+)/);if(!t)throw new Error(`Invalid or unknown input ${i}`);const n=t[2],r=t[3];let a=t[4];if(a[0]==="/"&&(a=a.substr(1)),e.length>0){if(e[0]==="/"&&(e=e.substr(1)),e!==a.substr(0,e.length))throw new Error(`Path does not start with prefix (path: ${a}, prefix: ${e})`);a=a.substr(e.length)}return{scheme:n,server:r,path:a,prefix:e}}function xe(i,e=""){const{path:t,scheme:n,server:r,prefix:a}=Se(i,e),o=t.split("/").reverse(),[l,f,c,h,...g]=o,I=g.reverse().filter(Boolean).join("/");if(o.length===1||l==="")return{type:"base",scheme:n,server:r,prefix:a,identifier:I};if(l==="info.json"){const[,...d]=o;return{type:"info",scheme:n,server:r,prefix:a,identifier:d.reverse().filter(Boolean).join("/")}}const x=l.split(".");return{type:"image",scheme:n,server:r,prefix:a,identifier:I,originalPath:t,region:_e(h),size:pe(c),rotation:Fe(f),quality:x[0],format:x[1]}}function ye(i){const e=xe(m(i.id));if(e.type!=="info")throw new Error("Invalid service URL");const t=X(i);return{identifier:e.identifier,originalPath:"",server:e.server,prefix:e.prefix,scheme:e.scheme,type:"image",quality:t.extraQualities.indexOf("default")===-1?t.extraQualities[0]:"default",region:{full:!0},size:{max:!0,upscaled:!1,confined:!1},format:"jpg",rotation:{angle:0}}}function Ee(i,e,t){const n=t.length,r=[];for(let a=0;a<n;a++){const l=t[a].width;r.push(i/l)}return r}function ve(i,e,t){const n=t.length,r=[];for(let a=0;a<n;a++){const o=t[a];r.push({width:Math.floor(i/o),height:Math.floor(e/o)})}return r}function u(i){if(i["@id"])return i["@id"];if(i.id)return i.id}function y(i){if(!i||!i.profile||!u(i))return!1;const e=Array.isArray(i.profile)?i.profile:[i.profile];for(const t of e)if(typeof t=="string"&&Z.indexOf(t)!==-1)return!0;return!1}function we(i){if(!y(i))return!1;const e=Array.isArray(i.profile)?i.profile:[i.profile];for(const t of e)if(typeof t=="string"){if(J.indexOf(t)!==-1)return!0}else{const n=[...t.supports||[],...t.extraFeatures||[]];if(n.indexOf("regionByPx")!==-1&&(n.indexOf("sizeByW")!==-1||n.indexOf("sizeByWh")!==-1))return!0}return!1}function v(i,e){if(e&&e.profile){const t=e.profile;if(t){const n=Array.isArray(t)?t:[t];return n.includes(`level${i}`)||n.includes(`http://iiif.io/api/image/2/level${i}.json`)||n.includes(`http://iiif.io/api/image/1/level${i}.json`)||n.includes(`http://iiif.io/api/image/1/profiles/level${i}.json`)}}return!1}function w(i){return y(i)?v(0,i)?0:v(1,i)?1:v(2,i)?2:null:null}function Y(i){return(i["@context"]?Array.isArray(i["@context"])?i["@context"]:[i["@context"]]:[]).indexOf("http://iiif.io/api/image/3/context.json")!==-1}function Ae(i){if(!we(i))return[];const e=[],t=Array.isArray(i.profile)?i.profile:[i.profile],n=t.length;for(let r=0;r<n;r++){const a=t[r];if(typeof a!="string"&&(a.maxHeight||a.maxWidth))return[{id:u(i),type:"variable",minWidth:0,minHeight:0,maxHeight:a.maxHeight||a.maxWidth,maxWidth:a.maxWidth||a.maxHeight,level:w(i),version:i["@context"]==="http://iiif.io/api/image/3/context.json"?3:2}]}if(i.tiles){const r=i.tiles.length;for(let a=0;a<r;a++){const o=i.tiles[a];(o.height||o.width)&&e.push({id:u(i),type:"variable",minHeight:0,minWidth:0,maxHeight:o.height||o.width,maxWidth:o.width,level:w(i),version:Y(i)?3:2})}}return e}function q(i){const e=/^.*\/(full)\/(((\d+),(\d+)?)|max)\/(\d+)\/default\.(jpg|png|jpeg)$/,t=i.match(e);if(t){const n=t[1],r=parseInt(t[4],10),a=parseInt(t[5],10),o=t[7];if((n==="max"||n==="full")&&r&&a&&o)return{type:"fixed",id:i,height:a,width:r}}return{type:"unknown",id:i}}function Oe(i){if(i["@type"])return i["@type"];if(i.type)return i.type}function Le(i){if(typeof i=="string")return q(i);const e=Oe(i);if(e!=="Image"&&e!=="sc:Image")return null;const t=i,n=u(t);return n?n&&t.width&&t.height?{id:n,type:"fixed",width:t.width,height:t.height,unsafe:!0}:q(n):null}function ze(i){return y(i)?(i&&i.sizes?i.sizes:[]).map(e=>({id:u(i),type:"fixed-service",height:e.height,width:e.width,level:w(i),version:Y(i)?3:2})):[]}function ee(i){const e=[],t=i.length;for(let n=0;n<t;n++){const r=ze(i[n]);r.length&&e.push(...r);const a=Ae(i[n]);a.length&&e.push(...a)}return e}function ie(i){const e=i.service?Array.isArray(i.service)?i.service:[i.service]:[],t=e.length,n=[];for(let r=0;r<t;r++)y(e[r])&&n.push(e[r]);return n}function Me(i,e=!0,t){const n=[],r=Le(i);if(r===null)return n;const a=i;if(n.push(r),e&&a.width&&a.height){const o=[],l=ie(a);for(const f of l){const c={id:u(f),width:a.width,height:a.height};if(t.canLoadSync(c)){const h=t.loadServiceSync(c);h&&(h.height||(h.height=a.height),h.width||(h.width=a.width),o.push(...ee([h])))}}if(o.length)return n.push(...o),n}return a.service&&n.push(...ee(a.service)),n}function Ce({x:i=0,y:e=0,w:t,h:n,full:r,square:a,percent:o}){if(r)return"full";if(a)return"square";if(typeof t>"u"||typeof n>"u")throw new Error("RegionParameter: invalid region");const l=`${i},${e},${t},${n}`;return o?`pct:${l}`:l}function Ne({max:i,percentScale:e,upscaled:t,confined:n,width:r,height:a,serialiseAsFull:o,version:l}){const f=[];return t&&f.push("^"),i?(f.push(o?"full":"max"),f.join("")):(n&&f.push("!"),e&&f.push(`pct:${e}`),r&&f.push(`${r}`),f.push(","),a&&l===3&&f.push(`${a}`),f.join(""))}function be(i){return`${i.mirror?"!":""}${(i.angle||0)%360}`}var Qe=Object.defineProperty,Ue=Object.defineProperties,Je=Object.getOwnPropertyDescriptors,Re=Object.getOwnPropertySymbols,Ze=Object.prototype.hasOwnProperty,Ke=Object.prototype.propertyIsEnumerable,Pe=(i,e,t)=>e in i?Qe(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,_=(i,e)=>{for(var t in e||(e={}))Ze.call(e,t)&&Pe(i,t,e[t]);if(Re)for(var t of Re(e))Ke.call(e,t)&&Pe(i,t,e[t]);return i},p=(i,e)=>Ue(i,Je(e));function We(i,e){const t=i.prefix.startsWith("/")?i.prefix.substr(1):i.prefix,n=`${i.scheme}://${i.server}/${t?`${t}/`:""}${i.identifier}`;if(i.type==="base")return n;if(i.type==="info")return`${n}/info.json`;let{size:r}=i;const{region:a,rotation:o,format:l,quality:f}=i;if(e){const c=e["@context"]?Array.isArray(e["@context"])?e["@context"]:[e["@context"]]:[],h=c.indexOf("http://iiif.io/api/image/2/context.json")!==-1,g=c.indexOf("http://iiif.io/api/image/3/context.json")!==-1;if((r.width===e.width&&!r.height||r.height===e.height&&!r.width||r.width===e.width&&r.height===e.height)&&(r=p(_({},r),{max:!0})),h&&(r.max&&!r.serialiseAsFull&&(r=p(_({},r),{serialiseAsFull:!0})),!r.max&&r.width&&r.height&&(r=p(_({},r),{height:void 0})),r=p(_({},r),{version:2})),g){if(r.max&&r.serialiseAsFull&&(r=p(_({},r),{serialiseAsFull:!1})),r.width&&!r.height&&e.width&&e.height){const I=e.height/e.width;r=p(_({},r),{height:Math.ceil(r.width*I)})}r=p(_({},r),{version:3})}}return[n,Ce(a),Ne(r),be(o),`${f}.${l}`].filter(Boolean).join("/")}function A(i,e,t){const n=ye({"@context":i.version===3?"http://iiif.io/api/image/3/context.json":"http://iiif.io/api/image/2/context.json",id:m(u(i)),profile:i.level===null||typeof i.level>"u"?"level0":`level${i.level}}`,type:i.version===3?"ImageService3":"ImageService2"});if(n.type!=="image")throw new Error("Invalid service");return n.size.max=!1,n.size.width=e,n.size.height=t,{id:We(n),type:"fixed",width:e,height:t||i.height/(i.width||1)*e,unsafe:i.width>e}}function F(i){const e=i.replace(/(https?:\/\/)?(www.)?/i,"");return e.indexOf("/")!==-1?e.split("/")[0]:e}function Xe(i){if(!i.width||!i.height)return null;if(i.tiles){const e=i.tiles.sort((n,r)=>Math.max(...r.scaleFactors)-Math.max(...n.scaleFactors)),t=e.length;for(let n=0;n<t;n++){const r=e[n],a=r.width;if(!a)continue;const o=r.scaleFactors.length,l=r.scaleFactors.sort();for(let f=0;f<o;f++){const c=l[f];if(i.width/c<=a&&i.height/c<=a)return{id:u(i),type:"fixed-service",width:i.width/c|0,height:i.height/c|0,level:w(i),version:Y(i)?3:2}}}}return null}function te(i,e){if(!y(i))return[!1,"Not a valid image service"];e.extraFeatures=e.extraFeatures?e.extraFeatures:[];const t=X(i);if(e.exactSize){let n=!1;if(i.sizes)for(const r of i.sizes)r.width&&r.width===e.exactSize.width&&(K.indexOf("sizeByW")!==-1||r.height&&r.height===e.exactSize.height)&&(n=!0),r.height&&r.height===e.exactSize.height&&(K.indexOf("sizeByH")!==-1||r.width&&r.width===e.exactSize.width)&&(n=!0);n||(e.maxWidth=Math.max(e.maxWidth||0,e.exactSize.width||0)||void 0,e.maxHeight=Math.max(e.maxHeight||0,e.exactSize.height||0)||void 0,e.maxArea=Math.max(e.maxArea||0,(e.exactSize.width&&e.exactSize.height?e.exactSize.width*e.exactSize.height:e.maxArea)||0)||void 0,!e.exactSize.height&&e.exactSize.width?e.extraFeatures.indexOf("sizeByW")===-1&&e.extraFeatures.push("sizeByW"):!e.exactSize.width&&e.exactSize.height&&e.extraFeatures.indexOf("sizeByH")===-1&&e.extraFeatures.push("sizeByH"))}if(e.maxArea&&t.maxArea&&e.maxArea>t.maxArea)return[!1,`Max area is ${t.maxArea}`];if(e.maxWidth&&t.maxWidth&&e.maxWidth>t.maxWidth)return[!1,`Max width is ${t.maxWidth}`];if(e.maxHeight&&t.maxHeight&&e.maxHeight>t.maxHeight)return[!1,`Max height is ${t.maxHeight}`];if(e.extraFeatures){const n=[];for(const r of e.extraFeatures)t.extraFeatures.indexOf(r)===-1&&n.push(r);if(n.length)return[!1,`Missing features: ${n.join(", ")}`]}if(e.extraFormats){const n=[];for(const r of e.extraFormats)t.extraFormats.indexOf(r)===-1&&n.push(r);if(n.length)return[!1,`Missing formats: ${n.join(", ")}`]}if(e.extraQualities){const n=[];for(const r of e.extraQualities)t.extraQualities.indexOf(r)===-1&&n.push(r);if(n.length)return[!1,`Missing qualities: ${n.join(", ")}`]}return[!0]}function Ye(i,e){return te(i,{extraFormats:[e]})}function qe(i,e){if(e.type!=="image")return[!0];const t=[];e.rotation.mirror&&t.push("mirroring"),e.region.percent&&t.push("regionByPct"),e.region.square?t.push("regionSquare"):e.region.full||t.push("regionByPx"),e.rotation.angle&&(e.rotation.angle%90?t.push("rotationArbitrary"):t.push("rotationBy90s")),e.size.confined&&t.push("sizeByConfinedWh"),!e.size.width&&e.size.height&&t.push("sizeByH"),e.size.percentScale&&t.push("sizeByPct"),(i.sizes||[]).find(o=>o.width===e.size.width&&!e.size.height||o.height===e.size.height&&!e.size.width||o.height===e.size.height&&o.width===e.size.width)?t.push("sizeByWhListed"):(e.size.width&&!e.size.height&&t.push("sizeByW"),e.size.width&&e.size.height&&t.push("sizeByWh")),e.size.upscaled&&t.push("sizeUpscaling");const[r,a]=te(i,{extraFeatures:t,extraQualities:[e.quality],extraFormats:[e.format],exactSize:e.size});return r?[!0]:[!1,a]}function je(i,e,t){const n=i.width?i.width:i.maxWidth;return t.height<=i.maxHeight&&t.width<=i.maxWidth&&t.height>=i.minHeight&&t.width>=i.minWidth&&(!e||Math.abs(t.width-n)<Math.abs(e.width-n))}function Ge(i,e){const t=[],n=Object.assign({unsafeImageService:!1,atAnyCost:!0,fallback:!0,minHeight:64,minWidth:64,maxHeight:1/0,maxWidth:1/0,returnAllOptions:!1,preferFixedSize:!1,allowUnsafe:!1,explain:!1,height:0,width:0},i),r=(h,g=0)=>n.explain?t.push(new Array(g).fill(0).map(I=>"    ").join("")+h().trim()):void 0,a=[],o=[];let l=null;r(()=>`Using configuration: ${JSON.stringify(n,null,2)}`);const f=(h,g)=>{if(r(()=>"Swapping choice",3),je(n,g,h)){if(n.preferFixedSize&&h.unsafe){r(()=>`We found an image that was marked as unsafe, but it was the best size. (${h.id})`,4),o.push(h);return}n.returnAllOptions&&g&&o.push(g),r(()=>`We found a new image that was the best size. (${h.id})`,4),l=h}else n.returnAllOptions&&o.push(h)};r(()=>`The input shows we have ${e.length} list(s) of candidates to choose from.`);const c=e.length;for(let h=0;h<c;h++){const g=e[h]();r(()=>`Candidate group ${h}: ${JSON.stringify(g,null,2)}`,1);const I=g.length;r(()=>`Checking candidate list number ${h} and found ${I} potential ways of creating image(s)`,1);for(let x=0;x<I;x++){const d=g[x];if(r(()=>`-> Checking candidate ${x}`,1),d.type==="unknown"&&n.atAnyCost&&(r(()=>`We've found an unknown image type, adding this to the "last resort" list`,2),a.push(d)),d.type==="fixed"&&(d.unsafe?(r(()=>`We've found an unsafe fixed image type, adding this to the "last resort" list`,2),a.push(d)):(r(()=>"We've found a fixed size image, checking if it matches the request",2),f(d,l))),d.type==="fixed-service")if(n.unsafeImageService){r(()=>"Checking for an image from the tile source, without calculating the right height and width (unsafeImageService)",2);const E=A(d,n.width,n.height);f(E,l)}else{r(()=>"Checking for an image from the tile source 3",2);const E=A(d,d.width,d.height);f(E,l)}if(d.type==="variable"&&d.maxWidth){const E=A({id:d.id,type:"fixed-service",width:d.maxWidth,height:d.maxWidth,level:d.level,version:d.version},d.maxWidth);f(E,l)}}if(l&&!n.returnAllOptions){if(l.unsafe||n.allowUnsafe)continue;r(()=>`We found a match in choice list number ${h}, no searching any more`);break}}return n.atAnyCost&&o.length===0?(r(()=>l?`We found an image! ${l.id} of type ${l.type}`:'We found no images, but "atAnyCost" is set, so returning that'),{best:l||a[0],fallback:a.slice(1),log:t}):n.returnAllOptions?(r(()=>"Returning all options that we have found"),{best:n.atAnyCost?l||o[0]||a[0]:l||o[0],fallback:[...o,...a],log:t}):(r(()=>"Returning the best image that we found, and a fallback"),{best:l||o[0]||null,fallback:l?o:o.slice(1),log:t})}var ei=Object.defineProperty,ii=Object.defineProperties,ti=Object.getOwnPropertyDescriptors,$e=Object.getOwnPropertySymbols,ni=Object.prototype.hasOwnProperty,ri=Object.prototype.propertyIsEnumerable,Te=(i,e,t)=>e in i?ei(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,ai=(i,e)=>{for(var t in e||(e={}))ni.call(e,t)&&Te(i,t,e[t]);if($e)for(var t of $e(e))ri.call(e,t)&&Te(i,t,e[t]);return i},si=(i,e)=>ii(i,ti(e));function Be(i,e,t){const n=i>e?i:e,r=t.length,a=[];for(let o=0;o<r;o++){const l=t[o];let f=l.scaleFactors[0],c=n/f;const h=[f];for(;c>=l.width;)f=f*2,h.push(f),c=c/2;a.push(si(ai({},l),{scaleFactors:h}))}return a}function Ve(i,e){if(i.length!==e.length)return!1;if(i.length===0&&e.length===0)return!0;const t=i.length;let n=!0;for(let a=0;a<t;a++){const o=i[a],l=e[a];if(o.width!==l.width||o.height!==l.height){n=!1;break}}if(n)return!0;let r=0;for(let a=0;a<t;a++)for(let o=0;o<t;o++)if(i[a].width===e[o].width&&i[a].height===e[o].height){r++;break}return r===t}function He(i){return v(0,i)}var S=(i,e,t)=>new Promise((n,r)=>{var a=f=>{try{l(t.next(f))}catch(c){r(c)}},o=f=>{try{l(t.throw(f))}catch(c){r(c)}},l=f=>f.done?n(f.value):Promise.resolve(f.value).then(a,o);l((t=t.apply(i,e)).next())});class ke{constructor(){this.config={verificationsRequired:1,approximateServices:!0,enableFetching:!0,disableThrottling:!1},this.fetchingCount=0,this.imageServices={},this.knownImageServers={}}setConfig(e){Object.assign(this.config,e)}sample(e,t,n=!0){const r=F(u(e)),a=m(u(e)),o=this.knownImageServers[r];return this.imageServices[a]=Object.assign(e,{real:!0}),!o&&e.tiles&&!He(e)?(this.knownImageServers[r]={verifications:0,malformed:!1,root:r,preLoaded:n,sampledId:u(e),verified:!1,server:null,result:{context:e["@context"]||[],sampledProfile:e.profile,resourceServiceRatio:t&&e.height?t.height/e.height:1,sampledSizes:e.sizes||[],sizeRatios:Ee(e.width,e.height,e.sizes||[]),sampledTiles:e.tiles||[]}},!0):this.verify(e)}preLoad(e,t=!0){this.knownImageServers[e.root]=e,t&&(this.knownImageServers[e.root].malformed=!1,this.knownImageServers[e.root].verifications=this.config.verificationsRequired)}predict(e,t=!1,n=!1){const r=e==null?void 0:e.source,a=F(u(e)),o=this.knownImageServers[a];if(!o||!o.result||!((r==null?void 0:r.height)||e.height)||!((r==null?void 0:r.width)||e.width)||!n&&(o.malformed||o.verifications<this.config.verificationsRequired)||He(e.source))return null;const l=m(u(e));return this.imageServices[l]||(this.imageServices[l]={"@context":o.result.context,"@id":u(e),id:u(e),protocol:"http://iiif.io/api/image",tiles:(r==null?void 0:r.tiles)||Be(e.width,e.height,o.result.sampledTiles),sizes:(r==null?void 0:r.sizes)||ve(Math.round(e.width/o.result.resourceServiceRatio),Math.round(e.height/o.result.resourceServiceRatio),o.result.sizeRatios),profile:(r==null?void 0:r.profile)||o.result.sampledProfile,height:(r==null?void 0:r.height)||e.height,width:(r==null?void 0:r.width)||e.width,real:!1}),this.imageServices[l]}getThumbnailFromResource(e,t){return S(this,arguments,function*(n,r,a=!0,o=[]){const l=n?yield this.getImageCandidates(n,a):[];return Ge(r,[()=>o,()=>l])})}getImageCandidates(e,t=!0){return S(this,null,function*(){const n=e;if(t&&n.height&&n.width){const r=ie(n);for(const a of r){const o={id:u(a),width:a.width?a.width:n.width,height:a.height?a.height:n.height,source:a};yield this.loadService(o)}}return Me(e,t,this)})}verify(e){return S(this,null,function*(){const t=this.predict(e,!1,!0),n=yield this.fetchService(u(e));if(!t)return!1;const r=t.height===n.height&&t.width===n.width&&t["@context"]===n["@context"]&&Ve(t.sizes||[],n.sizes||[]);if(r){const a=F(u(e));this.knownImageServers[a].verifications+=1,this.knownImageServers[a].verifications>=this.config.verificationsRequired&&(this.knownImageServers[a].verified=!0)}return r})}canLoadSync(e){const t=typeof e=="string"?e:u(e),n=m(t);if(this.imageServices[n])return!0;const r=this.knownImageServers[F(t)];return r&&!r.malformed&&r.verifications>=this.config.verificationsRequired}markAsMalformed(e){return S(this,null,function*(){return this.knownImageServers[F(u(e))].malformed=!0,this.loadService(e,!0)})}fetchService(e,t=!1){return S(this,null,function*(){const n=m(e);if(this.imageServices[n]&&(!t||this.imageServices[n].real))return this.imageServices[n];if(!this.config.enableFetching)throw new Error("Fetching is not enabled");const r=yield this.fetch(n).then(a=>a.json());return!r.id&&r["@id"]&&(r.id=r["@id"]),r.id!==e&&(r.id=e,r["@id"]&&(r["@id"]=e)),this.imageServices[n]=Object.assign(r,{real:!0}),this.imageServices[n]})}fetch(e,t){return S(this,null,function*(){return fetch(e,t)})}loadService(e,t=!1){return S(this,null,function*(){if(!this.config.disableThrottling){let a=!0;for(;a;)if(this.fetchingCount>=this.config.verificationsRequired)yield new Promise(o=>setTimeout(o,500));else{a=!1;break}}const n=this.knownImageServers[F(u(e))];if(n&&!n.malformed&&!t){yield n.result;const a=this.loadServiceSync(e);if(a)return a}this.fetchingCount++;const r=yield this.fetchService(u(e),t);return this.fetchingCount--,r.real&&this.sample(r,e),r})}loadServiceSync(e){const t=m(u(e));return this.imageServices[t]?this.imageServices[t]:this.predict(e)}}const oi=new ke;s.IIIF_1_IMAGE_LEVEL_0=oe,s.IIIF_1_IMAGE_LEVEL_0_PROFILE=le,s.IIIF_1_IMAGE_LEVEL_1=P,s.IIIF_1_IMAGE_LEVEL_1_PROFILE=W,s.IIIF_1_IMAGE_LEVEL_2=j,s.IIIF_1_IMAGE_LEVEL_2_PROFILE=G,s.IIIF_2_IMAGE_LEVEL_0=fe,s.IIIF_2_IMAGE_LEVEL_0_NO_JSON=ce,s.IIIF_2_IMAGE_LEVEL_0_PROFILE=he,s.IIIF_2_IMAGE_LEVEL_1=$,s.IIIF_2_IMAGE_LEVEL_1_NO_JSON=D,s.IIIF_2_IMAGE_LEVEL_1_PROFILE=T,s.IIIF_2_IMAGE_LEVEL_2=B,s.IIIF_2_IMAGE_LEVEL_2_NO_JSON=Q,s.IIIF_2_IMAGE_LEVEL_2_PROFILE=V,s.IIIF_3_IMAGE_LEVEL_0=ue,s.IIIF_3_IMAGE_LEVEL_1=H,s.IIIF_3_IMAGE_LEVEL_2=k,s.ImageServiceLoader=ke,s.STANFORD_IIIF_1_IMAGE_COMPLIANCE_0=ae,s.STANFORD_IIIF_1_IMAGE_COMPLIANCE_1=C,s.STANFORD_IIIF_1_IMAGE_COMPLIANCE_2=N,s.STANFORD_IIIF_1_IMAGE_CONFORMANCE_0=se,s.STANFORD_IIIF_1_IMAGE_CONFORMANCE_1=b,s.STANFORD_IIIF_1_IMAGE_CONFORMANCE_2=R,s.STANFORD_IIIF_IMAGE_COMPLIANCE_0=ne,s.STANFORD_IIIF_IMAGE_COMPLIANCE_1=O,s.STANFORD_IIIF_IMAGE_COMPLIANCE_2=L,s.STANFORD_IIIF_IMAGE_CONFORMANCE_0=re,s.STANFORD_IIIF_IMAGE_CONFORMANCE_1=z,s.STANFORD_IIIF_IMAGE_CONFORMANCE_2=M,s.canonicalServiceUrl=m,s.combineProfiles=X,s.createImageServiceRequest=ye,s.extraFeatures=K,s.extractFixedSizeScales=Ee,s.fixedSizesFromScales=ve,s.getCustomSizeFromService=Ae,s.getFixedSizeFromImage=Le,s.getFixedSizesFromService=ze,s.getId=u,s.getImageCandidates=Me,s.getImageCandidatesFromService=ee,s.getImageFromTileSource=A,s.getImageServerFromId=F,s.getImageServices=ie,s.getSmallestScaleFactorAsSingleImage=Xe,s.getType=Oe,s.imageServiceLoader=oi,s.imageServiceProfiles=Z,s.imageServiceRequestToString=We,s.imageServiceSupportsFormat=Ye,s.imageServiceSupportsRequest=qe,s.inferSizeFromUrl=q,s.isBestMatch=je,s.isImageService=y,s.level0=de,s.level0Support=De,s.level1=ge,s.level1Support=J,s.level2=me,s.level2Support=U,s.levelToProfile=Ie,s.parseImageServiceRequest=xe,s.parseImageServiceUrl=Se,s.parseRegionParameter=_e,s.parseRotationParameter=Fe,s.parseSizeParameter=pe,s.pickBestFromCandidates=Ge,s.regionParameterToString=Ce,s.rotationParameterToString=be,s.sampledTilesToTiles=Be,s.sizeParameterToString=Ne,s.sizesMatch=Ve,s.supports=te,s.supportsCustomSizes=we,Object.defineProperty(s,"__esModule",{value:!0})});
