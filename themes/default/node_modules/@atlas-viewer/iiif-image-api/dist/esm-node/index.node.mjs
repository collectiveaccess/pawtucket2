import Qi from"node-fetch";function p(e){return e.endsWith("info.json")?e:e.endsWith("/")?`${e}info.json`:`${e}/info.json`}const ei="http://library.stanford.edu/iiif/image-api/compliance.html#level0",O="http://library.stanford.edu/iiif/image-api/compliance.html#level1",z="http://library.stanford.edu/iiif/image-api/compliance.html#level2",ti="http://library.stanford.edu/iiif/image-api/conformance.html#level0",A="http://library.stanford.edu/iiif/image-api/conformance.html#level1",E="http://library.stanford.edu/iiif/image-api/conformance.html#level2",ni="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0",b="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1",L="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2",ri="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0",M="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1",W="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2",si="http://iiif.io/api/image/1/level0.json",ai="http://iiif.io/api/image/1/profiles/level0.json",j="http://iiif.io/api/image/1/level1.json",$="http://iiif.io/api/image/1/profiles/level1.json",C="http://iiif.io/api/image/1/level2.json",P="http://iiif.io/api/image/1/profiles/level2.json",oi="http://iiif.io/api/image/2/level0.json",fi="http://iiif.io/api/image/2/profiles/level0.json",B="http://iiif.io/api/image/2/level1.json",N="http://iiif.io/api/image/2/profiles/level1.json",R="http://iiif.io/api/image/2/level2.json",H="http://iiif.io/api/image/2/profiles/level2.json",li="level0",T="level1",G="level2",hi="http://iiif.io/api/image/2/level0",k="http://iiif.io/api/image/2/level1",Q="http://iiif.io/api/image/2/level2",V=[Q,z,E,L,W,C,P,R,H,G],D=[...V,k,O,A,b,M,j,$,B,N,T],U=[hi,k,Q,ei,O,z,ti,A,E,ni,b,L,ri,M,W,si,ai,j,$,C,P,oi,fi,B,N,R,H,li,T,G],Vi=U,ui={extraFormats:["jpg"],extraQualities:["default"],extraFeatures:["sizeByWhListed"]},ci={extraFormats:["jpg"],extraQualities:["default"],extraFeatures:["baseUriRedirect","cors","jsonldMediaType","regionByPx","regionSquare","sizeByWhListed","sizeByH","sizeByW","sizeByWh"]},di={extraFormats:["jpg","png"],extraQualities:["default"],extraFeatures:["baseUriRedirect","cors","jsonldMediaType","regionByPct","regionByPx","regionSquare","rotationBy90s","sizeByWhListed","sizeByConfinedWh","sizeByH","sizeByPct","sizeByW","sizeByWh"]},J=["baseUriRedirect","canonicalLinkHeader","cors","jsonldMediaType","mirroring","profileLinkHeader","regionByPct","regionByPx","regionSquare","rotationArbitrary","rotationBy90s","sizeByConfinedWh","sizeByH","sizeByPct","sizeByW","sizeByWh","sizeUpscaling","sizeByWhListed","sizeByDistortedWh","sizeByForcedWh"];function gi(e){return V.indexOf(e)!==-1?di:D.indexOf(e)!==-1?ci:ui}function Z(e){const i=e?Array.isArray(e.profile)?e.profile:[e.profile]:[],t={extraQualities:[],extraFormats:[],extraFeatures:[]};for(let n of i)if(typeof n=="string"&&(n=gi(n)),!!n){if(n.formats)for(const r of n.formats)t.extraFormats.indexOf(r)===-1&&t.extraFormats.push(r);if(n.qualities)for(const r of n.qualities)t.extraQualities.indexOf(r)===-1&&t.extraQualities.push(r);if(n.supports)for(const r of n.supports)t.extraFeatures.indexOf(r)===-1&&t.extraFeatures.push(r);if(n.maxHeight&&(t.maxHeight=n.maxHeight),n.maxWidth&&(t.maxWidth=n.maxWidth),n.maxArea&&(t.maxArea=n.maxArea),n.extraFormats)for(const r of n.extraFormats)t.extraFormats.indexOf(r)===-1&&t.extraFormats.push(r);if(n.extraQualities)for(const r of n.extraQualities)t.extraQualities.indexOf(r)===-1&&t.extraQualities.push(r);if(n.extraFeatures)for(const r of n.extraFeatures)t.extraFeatures.indexOf(r)===-1&&t.extraFeatures.push(r);n.maxHeight&&(t.maxHeight=n.maxHeight),n.maxWidth&&(t.maxWidth=n.maxWidth),n.maxArea&&(t.maxArea=n.maxArea)}if(e.extraFormats)for(const n of e.extraFormats)t.extraFormats.indexOf(n)===-1&&t.extraFormats.push(n);if(e.extraFeatures)for(const n of e.extraFeatures)t.extraFeatures.indexOf(n)===-1&&t.extraFeatures.push(n);if(e.extraQualities)for(const n of e.extraQualities)t.extraQualities.indexOf(n)===-1&&t.extraQualities.push(n);return t}function pi(e){try{if(e==="full")return{full:!0};if(e==="square")return{square:!0};const i=e.startsWith("pct:"),n=e.substr(i?4:0).split(",").map(r=>parseFloat(r));return{x:n[0],y:n[1],w:n[2],h:n[3],percent:i}}catch{throw new Error("Expected 'full', 'square' or 'x,y,w,h'. Found "+e)}}function mi(e){const i={upscaled:!1,max:!1,confined:!1};if(e[0]==="^"&&(i.upscaled=!0,e=e.slice(1)),e==="max"||e==="full")return i.max=!0,i.serialiseAsFull=e==="full",i;if(e[0]==="!"&&(i.confined=!0,e=e.slice(1)),e[0]==="p")return i.percentScale=parseFloat(e.slice(4)),i;const t=e.split(",").map(n=>n.trim());return t.length&&(t[0]!==""&&(i.width=parseInt(t[0],10)),t[1]!==""?(i.height=parseInt(t[1],10),i.version=2):i.version=3),i}function xi(e){const i={angle:0};if(e[0]==="!"&&(i.mirror=!0,e=e.substr(1)),i.angle=parseFloat(e)%360,Number.isNaN(i.angle))throw new Error(`Invalid rotation ${e}`);return i}function Ii(e,i=""){const t=e.match(/^(([a-zA-Z]+):\/\/([^/]+))?((.*)+)/);if(!t)throw new Error(`Invalid or unknown input ${e}`);const n=t[2],r=t[3];let s=t[4];if(s[0]==="/"&&(s=s.substr(1)),i.length>0){if(i[0]==="/"&&(i=i.substr(1)),i!==s.substr(0,i.length))throw new Error(`Path does not start with prefix (path: ${s}, prefix: ${i})`);s=s.substr(i.length)}return{scheme:n,server:r,path:s,prefix:i}}function yi(e,i=""){const{path:t,scheme:n,server:r,prefix:s}=Ii(e,i),a=t.split("/").reverse(),[o,f,c,l,...d]=a,g=d.reverse().filter(Boolean).join("/");if(a.length===1||o==="")return{type:"base",scheme:n,server:r,prefix:s,identifier:g};if(o==="info.json"){const[,...u]=a;return{type:"info",scheme:n,server:r,prefix:s,identifier:u.reverse().filter(Boolean).join("/")}}const m=o.split(".");return{type:"image",scheme:n,server:r,prefix:s,identifier:g,originalPath:t,region:pi(l),size:mi(c),rotation:xi(f),quality:m[0],format:m[1]}}function _i(e){const i=yi(p(e.id));if(i.type!=="info")throw new Error("Invalid service URL");const t=Z(e);return{identifier:i.identifier,originalPath:"",server:i.server,prefix:i.prefix,scheme:i.scheme,type:"image",quality:t.extraQualities.indexOf("default")===-1?t.extraQualities[0]:"default",region:{full:!0},size:{max:!0,upscaled:!1,confined:!1},format:"jpg",rotation:{angle:0}}}function wi(e,i,t){const n=t.length,r=[];for(let s=0;s<n;s++){const o=t[s].width;r.push(e/o)}return r}function Si(e,i,t){const n=t.length,r=[];for(let s=0;s<n;s++){const a=t[s];r.push({width:Math.floor(e/a),height:Math.floor(i/a)})}return r}function h(e){if(e["@id"])return e["@id"];if(e.id)return e.id}function _(e){if(!e||!e.profile||!h(e))return!1;const i=Array.isArray(e.profile)?e.profile:[e.profile];for(const t of i)if(typeof t=="string"&&U.indexOf(t)!==-1)return!0;return!1}function vi(e){if(!_(e))return!1;const i=Array.isArray(e.profile)?e.profile:[e.profile];for(const t of i)if(typeof t=="string"){if(D.indexOf(t)!==-1)return!0}else{const n=[...t.supports||[],...t.extraFeatures||[]];if(n.indexOf("regionByPx")!==-1&&(n.indexOf("sizeByW")!==-1||n.indexOf("sizeByWh")!==-1))return!0}return!1}function S(e,i){if(i&&i.profile){const t=i.profile;if(t){const n=Array.isArray(t)?t:[t];return n.includes(`level${e}`)||n.includes(`http://iiif.io/api/image/2/level${e}.json`)||n.includes(`http://iiif.io/api/image/1/level${e}.json`)||n.includes(`http://iiif.io/api/image/1/profiles/level${e}.json`)}}return!1}function v(e){return _(e)?S(0,e)?0:S(1,e)?1:S(2,e)?2:null:null}function K(e){return(e["@context"]?Array.isArray(e["@context"])?e["@context"]:[e["@context"]]:[]).indexOf("http://iiif.io/api/image/3/context.json")!==-1}function Fi(e){if(!vi(e))return[];const i=[],t=Array.isArray(e.profile)?e.profile:[e.profile],n=t.length;for(let r=0;r<n;r++){const s=t[r];if(typeof s!="string"&&(s.maxHeight||s.maxWidth))return[{id:h(e),type:"variable",minWidth:0,minHeight:0,maxHeight:s.maxHeight||s.maxWidth,maxWidth:s.maxWidth||s.maxHeight,level:v(e),version:e["@context"]==="http://iiif.io/api/image/3/context.json"?3:2}]}if(e.tiles){const r=e.tiles.length;for(let s=0;s<r;s++){const a=e.tiles[s];(a.height||a.width)&&i.push({id:h(e),type:"variable",minHeight:0,minWidth:0,maxHeight:a.height||a.width,maxWidth:a.width,level:v(e),version:K(e)?3:2})}}return i}function X(e){const i=/^.*\/(full)\/(((\d+),(\d+)?)|max)\/(\d+)\/default\.(jpg|png|jpeg)$/,t=e.match(i);if(t){const n=t[1],r=parseInt(t[4],10),s=parseInt(t[5],10),a=t[7];if((n==="max"||n==="full")&&r&&s&&a)return{type:"fixed",id:e,height:s,width:r}}return{type:"unknown",id:e}}function Oi(e){if(e["@type"])return e["@type"];if(e.type)return e.type}function zi(e){if(typeof e=="string")return X(e);const i=Oi(e);if(i!=="Image"&&i!=="sc:Image")return null;const t=e,n=h(t);return n?n&&t.width&&t.height?{id:n,type:"fixed",width:t.width,height:t.height,unsafe:!0}:X(n):null}function Ai(e){return _(e)?(e&&e.sizes?e.sizes:[]).map(i=>({id:h(e),type:"fixed-service",height:i.height,width:i.width,level:v(e),version:K(e)?3:2})):[]}function Y(e){const i=[],t=e.length;for(let n=0;n<t;n++){const r=Ai(e[n]);r.length&&i.push(...r);const s=Fi(e[n]);s.length&&i.push(...s)}return i}function q(e){const i=e.service?Array.isArray(e.service)?e.service:[e.service]:[],t=i.length,n=[];for(let r=0;r<t;r++)_(i[r])&&n.push(i[r]);return n}function Ei(e,i=!0,t){const n=[],r=zi(e);if(r===null)return n;const s=e;if(n.push(r),i&&s.width&&s.height){const a=[],o=q(s);for(const f of o){const c={id:h(f),width:s.width,height:s.height};if(t.canLoadSync(c)){const l=t.loadServiceSync(c);l&&(l.height||(l.height=s.height),l.width||(l.width=s.width),a.push(...Y([l])))}}if(a.length)return n.push(...a),n}return s.service&&n.push(...Y(s.service)),n}function bi({x:e=0,y:i=0,w:t,h:n,full:r,square:s,percent:a}){if(r)return"full";if(s)return"square";if(typeof t>"u"||typeof n>"u")throw new Error("RegionParameter: invalid region");const o=`${e},${i},${t},${n}`;return a?`pct:${o}`:o}function Li({max:e,percentScale:i,upscaled:t,confined:n,width:r,height:s,serialiseAsFull:a,version:o}){const f=[];return t&&f.push("^"),e?(f.push(a?"full":"max"),f.join("")):(n&&f.push("!"),i&&f.push(`pct:${i}`),r&&f.push(`${r}`),f.push(","),s&&o===3&&f.push(`${s}`),f.join(""))}function Mi(e){return`${e.mirror?"!":""}${(e.angle||0)%360}`}var Di=Object.defineProperty,Ui=Object.defineProperties,Ji=Object.getOwnPropertyDescriptors,Wi=Object.getOwnPropertySymbols,Zi=Object.prototype.hasOwnProperty,Ki=Object.prototype.propertyIsEnumerable,ji=(e,i,t)=>i in e?Di(e,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[i]=t,x=(e,i)=>{for(var t in i||(i={}))Zi.call(i,t)&&ji(e,t,i[t]);if(Wi)for(var t of Wi(i))Ki.call(i,t)&&ji(e,t,i[t]);return e},I=(e,i)=>Ui(e,Ji(i));function $i(e,i){const t=e.prefix.startsWith("/")?e.prefix.substr(1):e.prefix,n=`${e.scheme}://${e.server}/${t?`${t}/`:""}${e.identifier}`;if(e.type==="base")return n;if(e.type==="info")return`${n}/info.json`;let{size:r}=e;const{region:s,rotation:a,format:o,quality:f}=e;if(i){const c=i["@context"]?Array.isArray(i["@context"])?i["@context"]:[i["@context"]]:[],l=c.indexOf("http://iiif.io/api/image/2/context.json")!==-1,d=c.indexOf("http://iiif.io/api/image/3/context.json")!==-1;if((r.width===i.width&&!r.height||r.height===i.height&&!r.width||r.width===i.width&&r.height===i.height)&&(r=I(x({},r),{max:!0})),l&&(r.max&&!r.serialiseAsFull&&(r=I(x({},r),{serialiseAsFull:!0})),!r.max&&r.width&&r.height&&(r=I(x({},r),{height:void 0})),r=I(x({},r),{version:2})),d){if(r.max&&r.serialiseAsFull&&(r=I(x({},r),{serialiseAsFull:!1})),r.width&&!r.height&&i.width&&i.height){const g=i.height/i.width;r=I(x({},r),{height:Math.ceil(r.width*g)})}r=I(x({},r),{version:3})}}return[n,bi(s),Li(r),Mi(a),`${f}.${o}`].filter(Boolean).join("/")}function F(e,i,t){const n=_i({"@context":e.version===3?"http://iiif.io/api/image/3/context.json":"http://iiif.io/api/image/2/context.json",id:p(h(e)),profile:e.level===null||typeof e.level>"u"?"level0":`level${e.level}}`,type:e.version===3?"ImageService3":"ImageService2"});if(n.type!=="image")throw new Error("Invalid service");return n.size.max=!1,n.size.width=i,n.size.height=t,{id:$i(n),type:"fixed",width:i,height:t||e.height/(e.width||1)*i,unsafe:e.width>i}}function y(e){const i=e.replace(/(https?:\/\/)?(www.)?/i,"");return i.indexOf("/")!==-1?i.split("/")[0]:i}function Xi(e){if(!e.width||!e.height)return null;if(e.tiles){const i=e.tiles.sort((n,r)=>Math.max(...r.scaleFactors)-Math.max(...n.scaleFactors)),t=i.length;for(let n=0;n<t;n++){const r=i[n],s=r.width;if(!s)continue;const a=r.scaleFactors.length,o=r.scaleFactors.sort();for(let f=0;f<a;f++){const c=o[f];if(e.width/c<=s&&e.height/c<=s)return{id:h(e),type:"fixed-service",width:e.width/c|0,height:e.height/c|0,level:v(e),version:K(e)?3:2}}}}return null}function ii(e,i){if(!_(e))return[!1,"Not a valid image service"];i.extraFeatures=i.extraFeatures?i.extraFeatures:[];const t=Z(e);if(i.exactSize){let n=!1;if(e.sizes)for(const r of e.sizes)r.width&&r.width===i.exactSize.width&&(J.indexOf("sizeByW")!==-1||r.height&&r.height===i.exactSize.height)&&(n=!0),r.height&&r.height===i.exactSize.height&&(J.indexOf("sizeByH")!==-1||r.width&&r.width===i.exactSize.width)&&(n=!0);n||(i.maxWidth=Math.max(i.maxWidth||0,i.exactSize.width||0)||void 0,i.maxHeight=Math.max(i.maxHeight||0,i.exactSize.height||0)||void 0,i.maxArea=Math.max(i.maxArea||0,(i.exactSize.width&&i.exactSize.height?i.exactSize.width*i.exactSize.height:i.maxArea)||0)||void 0,!i.exactSize.height&&i.exactSize.width?i.extraFeatures.indexOf("sizeByW")===-1&&i.extraFeatures.push("sizeByW"):!i.exactSize.width&&i.exactSize.height&&i.extraFeatures.indexOf("sizeByH")===-1&&i.extraFeatures.push("sizeByH"))}if(i.maxArea&&t.maxArea&&i.maxArea>t.maxArea)return[!1,`Max area is ${t.maxArea}`];if(i.maxWidth&&t.maxWidth&&i.maxWidth>t.maxWidth)return[!1,`Max width is ${t.maxWidth}`];if(i.maxHeight&&t.maxHeight&&i.maxHeight>t.maxHeight)return[!1,`Max height is ${t.maxHeight}`];if(i.extraFeatures){const n=[];for(const r of i.extraFeatures)t.extraFeatures.indexOf(r)===-1&&n.push(r);if(n.length)return[!1,`Missing features: ${n.join(", ")}`]}if(i.extraFormats){const n=[];for(const r of i.extraFormats)t.extraFormats.indexOf(r)===-1&&n.push(r);if(n.length)return[!1,`Missing formats: ${n.join(", ")}`]}if(i.extraQualities){const n=[];for(const r of i.extraQualities)t.extraQualities.indexOf(r)===-1&&n.push(r);if(n.length)return[!1,`Missing qualities: ${n.join(", ")}`]}return[!0]}function Yi(e,i){return ii(e,{extraFormats:[i]})}function qi(e,i){if(i.type!=="image")return[!0];const t=[];i.rotation.mirror&&t.push("mirroring"),i.region.percent&&t.push("regionByPct"),i.region.square?t.push("regionSquare"):i.region.full||t.push("regionByPx"),i.rotation.angle&&(i.rotation.angle%90?t.push("rotationArbitrary"):t.push("rotationBy90s")),i.size.confined&&t.push("sizeByConfinedWh"),!i.size.width&&i.size.height&&t.push("sizeByH"),i.size.percentScale&&t.push("sizeByPct"),(e.sizes||[]).find(a=>a.width===i.size.width&&!i.size.height||a.height===i.size.height&&!i.size.width||a.height===i.size.height&&a.width===i.size.width)?t.push("sizeByWhListed"):(i.size.width&&!i.size.height&&t.push("sizeByW"),i.size.width&&i.size.height&&t.push("sizeByWh")),i.size.upscaled&&t.push("sizeUpscaling");const[r,s]=ii(e,{extraFeatures:t,extraQualities:[i.quality],extraFormats:[i.format],exactSize:i.size});return r?[!0]:[!1,s]}function Ci(e,i,t){const n=e.width?e.width:e.maxWidth;return t.height<=e.maxHeight&&t.width<=e.maxWidth&&t.height>=e.minHeight&&t.width>=e.minWidth&&(!i||Math.abs(t.width-n)<Math.abs(i.width-n))}function Pi(e,i){const t=[],n=Object.assign({unsafeImageService:!1,atAnyCost:!0,fallback:!0,minHeight:64,minWidth:64,maxHeight:1/0,maxWidth:1/0,returnAllOptions:!1,preferFixedSize:!1,allowUnsafe:!1,explain:!1,height:0,width:0},e),r=(l,d=0)=>n.explain?t.push(new Array(d).fill(0).map(g=>"    ").join("")+l().trim()):void 0,s=[],a=[];let o=null;r(()=>`Using configuration: ${JSON.stringify(n,null,2)}`);const f=(l,d)=>{if(r(()=>"Swapping choice",3),Ci(n,d,l)){if(n.preferFixedSize&&l.unsafe){r(()=>`We found an image that was marked as unsafe, but it was the best size. (${l.id})`,4),a.push(l);return}n.returnAllOptions&&d&&a.push(d),r(()=>`We found a new image that was the best size. (${l.id})`,4),o=l}else n.returnAllOptions&&a.push(l)};r(()=>`The input shows we have ${i.length} list(s) of candidates to choose from.`);const c=i.length;for(let l=0;l<c;l++){const d=i[l]();r(()=>`Candidate group ${l}: ${JSON.stringify(d,null,2)}`,1);const g=d.length;r(()=>`Checking candidate list number ${l} and found ${g} potential ways of creating image(s)`,1);for(let m=0;m<g;m++){const u=d[m];if(r(()=>`-> Checking candidate ${m}`,1),u.type==="unknown"&&n.atAnyCost&&(r(()=>`We've found an unknown image type, adding this to the "last resort" list`,2),s.push(u)),u.type==="fixed"&&(u.unsafe?(r(()=>`We've found an unsafe fixed image type, adding this to the "last resort" list`,2),s.push(u)):(r(()=>"We've found a fixed size image, checking if it matches the request",2),f(u,o))),u.type==="fixed-service")if(n.unsafeImageService){r(()=>"Checking for an image from the tile source, without calculating the right height and width (unsafeImageService)",2);const w=F(u,n.width,n.height);f(w,o)}else{r(()=>"Checking for an image from the tile source 3",2);const w=F(u,u.width,u.height);f(w,o)}if(u.type==="variable"&&u.maxWidth){const w=F({id:u.id,type:"fixed-service",width:u.maxWidth,height:u.maxWidth,level:u.level,version:u.version},u.maxWidth);f(w,o)}}if(o&&!n.returnAllOptions){if(o.unsafe||n.allowUnsafe)continue;r(()=>`We found a match in choice list number ${l}, no searching any more`);break}}return n.atAnyCost&&a.length===0?(r(()=>o?`We found an image! ${o.id} of type ${o.type}`:'We found no images, but "atAnyCost" is set, so returning that'),{best:o||s[0],fallback:s.slice(1),log:t}):n.returnAllOptions?(r(()=>"Returning all options that we have found"),{best:n.atAnyCost?o||a[0]||s[0]:o||a[0],fallback:[...a,...s],log:t}):(r(()=>"Returning the best image that we found, and a fallback"),{best:o||a[0]||null,fallback:o?a:a.slice(1),log:t})}var ie=Object.defineProperty,ee=Object.defineProperties,te=Object.getOwnPropertyDescriptors,Bi=Object.getOwnPropertySymbols,ne=Object.prototype.hasOwnProperty,re=Object.prototype.propertyIsEnumerable,Ni=(e,i,t)=>i in e?ie(e,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[i]=t,se=(e,i)=>{for(var t in i||(i={}))ne.call(i,t)&&Ni(e,t,i[t]);if(Bi)for(var t of Bi(i))re.call(i,t)&&Ni(e,t,i[t]);return e},ae=(e,i)=>ee(e,te(i));function Ri(e,i,t){const n=e>i?e:i,r=t.length,s=[];for(let a=0;a<r;a++){const o=t[a];let f=o.scaleFactors[0],c=n/f;const l=[f];for(;c>=o.width;)f=f*2,l.push(f),c=c/2;s.push(ae(se({},o),{scaleFactors:l}))}return s}function Hi(e,i){if(e.length!==i.length)return!1;if(e.length===0&&i.length===0)return!0;const t=e.length;let n=!0;for(let s=0;s<t;s++){const a=e[s],o=i[s];if(a.width!==o.width||a.height!==o.height){n=!1;break}}if(n)return!0;let r=0;for(let s=0;s<t;s++)for(let a=0;a<t;a++)if(e[s].width===i[a].width&&e[s].height===i[a].height){r++;break}return r===t}function Ti(e){return S(0,e)}class Gi{constructor(){this.config={verificationsRequired:1,approximateServices:!0,enableFetching:!0,disableThrottling:!1},this.fetchingCount=0,this.imageServices={},this.knownImageServers={}}setConfig(i){Object.assign(this.config,i)}sample(i,t,n=!0){const r=y(h(i)),s=p(h(i)),a=this.knownImageServers[r];return this.imageServices[s]=Object.assign(i,{real:!0}),!a&&i.tiles&&!Ti(i)?(this.knownImageServers[r]={verifications:0,malformed:!1,root:r,preLoaded:n,sampledId:h(i),verified:!1,server:null,result:{context:i["@context"]||[],sampledProfile:i.profile,resourceServiceRatio:t&&i.height?t.height/i.height:1,sampledSizes:i.sizes||[],sizeRatios:wi(i.width,i.height,i.sizes||[]),sampledTiles:i.tiles||[]}},!0):this.verify(i)}preLoad(i,t=!0){this.knownImageServers[i.root]=i,t&&(this.knownImageServers[i.root].malformed=!1,this.knownImageServers[i.root].verifications=this.config.verificationsRequired)}predict(i,t=!1,n=!1){const r=i==null?void 0:i.source,s=y(h(i)),a=this.knownImageServers[s];if(!a||!a.result||!((r==null?void 0:r.height)||i.height)||!((r==null?void 0:r.width)||i.width)||!n&&(a.malformed||a.verifications<this.config.verificationsRequired)||Ti(i.source))return null;const o=p(h(i));return this.imageServices[o]||(this.imageServices[o]={"@context":a.result.context,"@id":h(i),id:h(i),protocol:"http://iiif.io/api/image",tiles:(r==null?void 0:r.tiles)||Ri(i.width,i.height,a.result.sampledTiles),sizes:(r==null?void 0:r.sizes)||Si(Math.round(i.width/a.result.resourceServiceRatio),Math.round(i.height/a.result.resourceServiceRatio),a.result.sizeRatios),profile:(r==null?void 0:r.profile)||a.result.sampledProfile,height:(r==null?void 0:r.height)||i.height,width:(r==null?void 0:r.width)||i.width,real:!1}),this.imageServices[o]}async getThumbnailFromResource(i,t,n=!0,r=[]){const s=i?await this.getImageCandidates(i,n):[];return Pi(t,[()=>r,()=>s])}async getImageCandidates(i,t=!0){const n=i;if(t&&n.height&&n.width){const r=q(n);for(const s of r){const a={id:h(s),width:s.width?s.width:n.width,height:s.height?s.height:n.height,source:s};await this.loadService(a)}}return Ei(i,t,this)}async verify(i){const t=this.predict(i,!1,!0),n=await this.fetchService(h(i));if(!t)return!1;const r=t.height===n.height&&t.width===n.width&&t["@context"]===n["@context"]&&Hi(t.sizes||[],n.sizes||[]);if(r){const s=y(h(i));this.knownImageServers[s].verifications+=1,this.knownImageServers[s].verifications>=this.config.verificationsRequired&&(this.knownImageServers[s].verified=!0)}return r}canLoadSync(i){const t=typeof i=="string"?i:h(i),n=p(t);if(this.imageServices[n])return!0;const r=this.knownImageServers[y(t)];return r&&!r.malformed&&r.verifications>=this.config.verificationsRequired}async markAsMalformed(i){return this.knownImageServers[y(h(i))].malformed=!0,this.loadService(i,!0)}async fetchService(i,t=!1){const n=p(i);if(this.imageServices[n]&&(!t||this.imageServices[n].real))return this.imageServices[n];if(!this.config.enableFetching)throw new Error("Fetching is not enabled");const r=await this.fetch(n).then(s=>s.json());return!r.id&&r["@id"]&&(r.id=r["@id"]),r.id!==i&&(r.id=i,r["@id"]&&(r["@id"]=i)),this.imageServices[n]=Object.assign(r,{real:!0}),this.imageServices[n]}async fetch(i,t){return fetch(i,t)}async loadService(i,t=!1){if(!this.config.disableThrottling){let s=!0;for(;s;)if(this.fetchingCount>=this.config.verificationsRequired)await new Promise(a=>setTimeout(a,500));else{s=!1;break}}const n=this.knownImageServers[y(h(i))];if(n&&!n.malformed&&!t){await n.result;const s=this.loadServiceSync(i);if(s)return s}this.fetchingCount++;const r=await this.fetchService(h(i),t);return this.fetchingCount--,r.real&&this.sample(r,i),r}loadServiceSync(i){const t=p(h(i));return this.imageServices[t]?this.imageServices[t]:this.predict(i)}}new Gi;class ki extends Gi{async fetch(i,t){return Qi(i,t)}}const oe=new ki;export{si as IIIF_1_IMAGE_LEVEL_0,ai as IIIF_1_IMAGE_LEVEL_0_PROFILE,j as IIIF_1_IMAGE_LEVEL_1,$ as IIIF_1_IMAGE_LEVEL_1_PROFILE,C as IIIF_1_IMAGE_LEVEL_2,P as IIIF_1_IMAGE_LEVEL_2_PROFILE,oi as IIIF_2_IMAGE_LEVEL_0,hi as IIIF_2_IMAGE_LEVEL_0_NO_JSON,fi as IIIF_2_IMAGE_LEVEL_0_PROFILE,B as IIIF_2_IMAGE_LEVEL_1,k as IIIF_2_IMAGE_LEVEL_1_NO_JSON,N as IIIF_2_IMAGE_LEVEL_1_PROFILE,R as IIIF_2_IMAGE_LEVEL_2,Q as IIIF_2_IMAGE_LEVEL_2_NO_JSON,H as IIIF_2_IMAGE_LEVEL_2_PROFILE,li as IIIF_3_IMAGE_LEVEL_0,T as IIIF_3_IMAGE_LEVEL_1,G as IIIF_3_IMAGE_LEVEL_2,ki as ImageServiceLoader,ni as STANFORD_IIIF_1_IMAGE_COMPLIANCE_0,b as STANFORD_IIIF_1_IMAGE_COMPLIANCE_1,L as STANFORD_IIIF_1_IMAGE_COMPLIANCE_2,ri as STANFORD_IIIF_1_IMAGE_CONFORMANCE_0,M as STANFORD_IIIF_1_IMAGE_CONFORMANCE_1,W as STANFORD_IIIF_1_IMAGE_CONFORMANCE_2,ei as STANFORD_IIIF_IMAGE_COMPLIANCE_0,O as STANFORD_IIIF_IMAGE_COMPLIANCE_1,z as STANFORD_IIIF_IMAGE_COMPLIANCE_2,ti as STANFORD_IIIF_IMAGE_CONFORMANCE_0,A as STANFORD_IIIF_IMAGE_CONFORMANCE_1,E as STANFORD_IIIF_IMAGE_CONFORMANCE_2,p as canonicalServiceUrl,Z as combineProfiles,_i as createImageServiceRequest,J as extraFeatures,wi as extractFixedSizeScales,Si as fixedSizesFromScales,Fi as getCustomSizeFromService,zi as getFixedSizeFromImage,Ai as getFixedSizesFromService,h as getId,Ei as getImageCandidates,Y as getImageCandidatesFromService,F as getImageFromTileSource,y as getImageServerFromId,q as getImageServices,Xi as getSmallestScaleFactorAsSingleImage,Oi as getType,oe as imageServiceLoader,U as imageServiceProfiles,$i as imageServiceRequestToString,Yi as imageServiceSupportsFormat,qi as imageServiceSupportsRequest,X as inferSizeFromUrl,Ci as isBestMatch,_ as isImageService,ui as level0,Vi as level0Support,ci as level1,D as level1Support,di as level2,V as level2Support,gi as levelToProfile,yi as parseImageServiceRequest,Ii as parseImageServiceUrl,pi as parseRegionParameter,xi as parseRotationParameter,mi as parseSizeParameter,Pi as pickBestFromCandidates,bi as regionParameterToString,Mi as rotationParameterToString,Ri as sampledTilesToTiles,Li as sizeParameterToString,Hi as sizesMatch,ii as supports,vi as supportsCustomSizes};
