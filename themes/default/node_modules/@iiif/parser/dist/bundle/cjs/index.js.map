{"version":3,"file":"index.js","sources":["../../../src/presentation-3/empty-types.ts","../../../src/shared/ensure-array.ts","../../../src/presentation-3/traverse.ts","../../../src/presentation-2/traverse.ts","../../../src/shared/image-api-profiles.ts","../../../src/presentation-2/upgrader.ts","../../../src/presentation-3/normalize.ts","../../../src/presentation-3/serialize.ts","../../../src/presentation-3/serialize-presentation-2.ts","../../../src/presentation-3/serialize-presentation-3.ts"],"sourcesContent":["import {\n  AnnotationNormalized,\n  AnnotationPageNormalized,\n  CanvasNormalized,\n  CollectionNormalized,\n  ManifestNormalized,\n  RangeNormalized,\n  ResourceProviderNormalized,\n} from '@iiif/presentation-3';\n\nexport const EMPTY = [];\n// Prevent accidental mutation\nObject.freeze(EMPTY);\n\nexport const emptyAnnotation: AnnotationNormalized = {\n  id: 'https://iiif-parser/annotation',\n  type: 'Annotation',\n  behavior: EMPTY,\n  label: null,\n  thumbnail: EMPTY,\n  summary: null,\n  requiredStatement: null,\n  metadata: EMPTY,\n  seeAlso: EMPTY,\n  homepage: EMPTY,\n  logo: EMPTY,\n  rendering: EMPTY,\n  service: EMPTY,\n  accessibility: EMPTY,\n  audience: EMPTY,\n  body: EMPTY,\n  bodyValue: null,\n  canonical: null,\n  created: null,\n  creator: EMPTY,\n  generated: null,\n  generator: EMPTY,\n  modified: null,\n  motivation: EMPTY,\n  rights: EMPTY,\n  stylesheet: null,\n  target: EMPTY,\n  timeMode: undefined, // @todo bug? should be null.\n  via: EMPTY,\n  partOf: EMPTY,\n};\n\nexport const emptyAnnotationPage: AnnotationPageNormalized = {\n  id: 'https://iiif-parser/annotation-page',\n  type: 'AnnotationPage',\n  behavior: EMPTY,\n  motivation: null,\n  label: null,\n  thumbnail: EMPTY,\n  summary: null,\n  requiredStatement: null,\n  metadata: EMPTY,\n  rights: null,\n  provider: EMPTY,\n  items: EMPTY,\n  seeAlso: EMPTY,\n  homepage: EMPTY,\n  logo: EMPTY,\n  rendering: EMPTY,\n  service: EMPTY,\n};\n\nexport const emptyCanvas: CanvasNormalized = {\n  id: 'https://iiif-parser/empty-canvas',\n  type: 'Canvas',\n  label: null,\n  behavior: EMPTY,\n  motivation: null,\n  thumbnail: EMPTY,\n  posterCanvas: null,\n  accompanyingCanvas: null,\n  placeholderCanvas: null,\n  summary: null,\n  requiredStatement: null,\n  metadata: EMPTY,\n  rights: null,\n  navDate: null,\n  provider: EMPTY,\n  items: EMPTY,\n  annotations: EMPTY,\n  seeAlso: EMPTY,\n  homepage: EMPTY,\n  logo: EMPTY,\n  partOf: EMPTY,\n  rendering: EMPTY,\n  service: EMPTY,\n  duration: 0,\n  height: 0,\n  width: 0,\n};\n\nexport const emptyCollection: CollectionNormalized = {\n  id: 'https://iiif-parser/empty-collection',\n  type: 'Collection',\n  label: null,\n  viewingDirection: 'left-to-right',\n  behavior: EMPTY,\n  motivation: null,\n  thumbnail: EMPTY,\n  posterCanvas: null,\n  accompanyingCanvas: null,\n  placeholderCanvas: null,\n  summary: null,\n  requiredStatement: null,\n  metadata: EMPTY,\n  rights: null,\n  navDate: null,\n  provider: EMPTY,\n  items: EMPTY,\n  annotations: EMPTY,\n  seeAlso: EMPTY,\n  homepage: EMPTY,\n  logo: EMPTY,\n  partOf: EMPTY,\n  rendering: EMPTY,\n  service: EMPTY,\n  services: EMPTY,\n};\n\nexport const emptyManifest: ManifestNormalized = {\n  id: 'https://iiif-parser/empty-manifest',\n  type: 'Manifest',\n  annotations: EMPTY,\n  behavior: EMPTY,\n  homepage: EMPTY,\n  items: EMPTY,\n  label: null,\n  logo: EMPTY,\n  metadata: EMPTY,\n  motivation: null,\n  navDate: null,\n  provider: EMPTY,\n  partOf: EMPTY,\n  posterCanvas: null,\n  accompanyingCanvas: null,\n  placeholderCanvas: null,\n  rendering: EMPTY,\n  requiredStatement: null,\n  rights: null,\n  seeAlso: EMPTY,\n  service: EMPTY,\n  services: EMPTY,\n  start: null,\n  structures: EMPTY,\n  summary: null,\n  thumbnail: EMPTY,\n  viewingDirection: 'left-to-right',\n};\n\nexport const emptyRange: RangeNormalized = {\n  id: 'https://iiif-parser/empty-canvas',\n  type: 'Range',\n  label: null,\n  behavior: EMPTY,\n  motivation: null,\n  thumbnail: EMPTY,\n  posterCanvas: null,\n  accompanyingCanvas: null,\n  placeholderCanvas: null,\n  summary: null,\n  requiredStatement: null,\n  metadata: EMPTY,\n  rights: null,\n  navDate: null,\n  provider: EMPTY,\n  items: EMPTY,\n  annotations: EMPTY,\n  seeAlso: EMPTY,\n  homepage: EMPTY,\n  logo: EMPTY,\n  partOf: EMPTY,\n  rendering: EMPTY,\n  service: EMPTY,\n  start: null,\n  supplementary: null,\n  viewingDirection: 'left-to-right',\n};\n\nexport const emptyAgent: ResourceProviderNormalized = {\n  id: 'https://iiif-parser/empty-agent',\n  type: 'Agent',\n  label: {},\n  logo: EMPTY,\n  seeAlso: EMPTY,\n  homepage: EMPTY,\n};\n","export function ensureArray<T>(maybeArray: T | T[]): T[] {\n  if (Array.isArray(maybeArray)) {\n    return maybeArray;\n  }\n  return [maybeArray];\n}\n","import {\n  Agent,\n  Annotation,\n  AnnotationCollection,\n  AnnotationPage,\n  Canvas,\n  ChoiceBody,\n  ChoiceTarget,\n  Collection,\n  ContentResource,\n  DescriptiveProperties,\n  IIIFExternalWebResource,\n  LinkingProperties,\n  Manifest,\n  Range,\n  RangeItems,\n  Required,\n  Service,\n  ResourceProvider,\n} from '@iiif/presentation-3';\nimport { ensureArray } from '../shared/ensure-array';\n\nexport const types = [\n  'Collection',\n  'Manifest',\n  'Canvas',\n  'AnnotationPage',\n  'AnnotationCollection',\n  'Annotation',\n  'ContentResource',\n  'Range',\n  'Service',\n  'Selector',\n  'Agent',\n];\n\nexport type Traversal<T> = (jsonLd: T) => Partial<T> | any;\n\nexport type TraversalMap = {\n  collection?: Array<Traversal<Collection>>;\n  manifest?: Array<Traversal<Manifest>>;\n  canvas?: Array<Traversal<Canvas>>;\n  annotationCollection?: Array<Traversal<AnnotationCollection>>;\n  annotationPage?: Array<Traversal<AnnotationPage>>;\n  annotation?: Array<Traversal<Annotation>>;\n  contentResource?: Array<Traversal<ContentResource>>;\n  choice?: Array<Traversal<ChoiceTarget | ChoiceBody>>;\n  range?: Array<Traversal<Range>>;\n  service?: Array<Traversal<Service>>;\n  agent?: Array<Traversal<ResourceProvider>>;\n};\n\nexport type TraverseOptions = {\n  allowUndefinedReturn: boolean;\n};\n\nexport function identifyResource(resource: any): string {\n  if (typeof resource === 'undefined' || resource === null) {\n    throw new Error('Null or undefined is not a valid entity.');\n  }\n  if (Array.isArray(resource)) {\n    throw new Error('Array is not a valid entity');\n  }\n  if (typeof resource !== 'object') {\n    throw new Error(`${typeof resource} is not a valid entity`);\n  }\n\n  if (typeof resource!.type === 'string') {\n    const hasType = types.indexOf(resource.type);\n    if (hasType !== -1) {\n      return types[hasType];\n    }\n  }\n\n  if (resource!.profile) {\n    return 'Service';\n  }\n\n  throw new Error('Resource type is not known');\n}\n\nexport class Traverse {\n  private traversals: Required<TraversalMap>;\n\n  private options: TraverseOptions;\n\n  constructor(traversals: TraversalMap, options: Partial<TraverseOptions> = {}) {\n    this.traversals = {\n      collection: [],\n      manifest: [],\n      canvas: [],\n      annotationCollection: [],\n      annotationPage: [],\n      annotation: [],\n      contentResource: [],\n      choice: [],\n      range: [],\n      service: [],\n      agent: [],\n      ...traversals,\n    };\n    this.options = {\n      allowUndefinedReturn: false,\n      ...options,\n    };\n  }\n\n  static all(traversal: (resource: any) => any) {\n    return new Traverse({\n      collection: [traversal],\n      manifest: [traversal],\n      canvas: [traversal],\n      annotationCollection: [traversal],\n      annotationPage: [traversal],\n      annotation: [traversal],\n      contentResource: [traversal],\n      choice: [traversal],\n      range: [traversal],\n      service: [traversal],\n    });\n  }\n\n  traverseDescriptive<T extends Partial<DescriptiveProperties>>(resource: T) {\n    if (resource.thumbnail) {\n      resource.thumbnail = resource.thumbnail.map((thumbnail) =>\n        this.traverseType(thumbnail, this.traversals.contentResource)\n      );\n    }\n    if (resource.provider) {\n      resource.provider = resource.provider.map((agent) => this.traverseAgent(agent));\n    }\n    return resource;\n  }\n\n  traverseLinking<T extends Partial<LinkingProperties>>(resource: T) {\n    if (resource.seeAlso) {\n      resource.seeAlso = resource.seeAlso.map((content) => this.traverseType(content, this.traversals.contentResource));\n    }\n    if (resource.service) {\n      resource.service = ensureArray(resource.service).map((service) =>\n        this.traverseType(service, this.traversals.service)\n      );\n    }\n    if (resource.services) {\n      resource.services = resource.services.map((service) => this.traverseType(service, this.traversals.service));\n    }\n    if (resource.logo) {\n      resource.logo = resource.logo.map((content) => this.traverseType(content, this.traversals.contentResource));\n    }\n    if (resource.homepage) {\n      resource.homepage = resource.homepage.map((homepage) =>\n        this.traverseType(homepage, this.traversals.contentResource)\n      );\n    }\n    if (resource.partOf) {\n      // Array<ContentResource | Canvas | AnnotationCollection>\n      (resource as any).partOf = resource.partOf.map((partOf) => {\n        if (typeof partOf === 'string' || !partOf.type) {\n          return this.traverseType(partOf as ContentResource, this.traversals.contentResource);\n        }\n        if (partOf.type === 'Canvas') {\n          return this.traverseType(partOf as Canvas, this.traversals.canvas);\n        }\n        if (partOf.type === 'AnnotationCollection') {\n          return this.traverseType(partOf as AnnotationCollection, this.traversals.annotationCollection);\n        }\n        if (partOf.type === 'Collection') {\n          return this.traverseType(partOf as Collection, this.traversals.collection);\n        }\n        return this.traverseType(partOf as ContentResource, this.traversals.contentResource);\n      });\n    }\n    if (resource.start) {\n      resource.start = resource.start ? this.traverseType(resource.start, this.traversals.canvas) : null;\n    }\n    if (resource.rendering) {\n      resource.rendering = resource.rendering.map((content) =>\n        this.traverseType(content, this.traversals.contentResource)\n      );\n    }\n    if (resource.supplementary) {\n      resource.supplementary = resource.supplementary.map((content) =>\n        this.traverseType(content, this.traversals.contentResource)\n      );\n    }\n\n    return resource;\n  }\n\n  traverseCollectionItems(collection: Collection): Collection {\n    if (collection.items) {\n      collection.items.map((collectionOrManifest: Manifest | Collection) => {\n        if (collectionOrManifest.type === 'Collection') {\n          return this.traverseCollection(collectionOrManifest as Collection);\n        }\n        return this.traverseManifest(collectionOrManifest as Manifest);\n      });\n    }\n\n    return collection;\n  }\n\n  traverseCollection(collection: Collection): Collection {\n    return this.traverseType<Collection>(\n      this.traverseDescriptive(\n        this.traverseInlineAnnotationPages(\n          this.traverseLinking(this.traversePosterCanvas(this.traverseCollectionItems(collection)))\n        )\n      ),\n      this.traversals.collection\n    );\n  }\n\n  traverseManifestItems(manifest: Manifest): Manifest {\n    if (manifest.items) {\n      manifest.items = manifest.items.map((canvas) => this.traverseCanvas(canvas));\n    }\n    return manifest;\n  }\n\n  traverseManifestStructures(manifest: Manifest): Manifest {\n    if (manifest.structures) {\n      manifest.structures = manifest.structures.map((range) => this.traverseRange(range));\n    }\n    return manifest;\n  }\n\n  traverseManifest(manifest: Manifest): Manifest {\n    return this.traverseType<Manifest>(\n      this.traverseInlineAnnotationPages(\n        this.traverseManifestStructures(\n          this.traversePosterCanvas(\n            this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(manifest)))\n          )\n        )\n      ),\n      this.traversals.manifest\n    );\n  }\n\n  traverseCanvasItems(canvas: Canvas): Canvas {\n    canvas.items = (canvas.items || []).map((annotationPage: AnnotationPage): AnnotationPage => {\n      return this.traverseAnnotationPage(annotationPage);\n    });\n\n    return canvas;\n  }\n\n  traverseInlineAnnotationPages<T extends Manifest | Canvas | Range | string>(resource: T): T {\n    if (typeof resource === 'string' || !resource) {\n      return resource;\n    }\n    if (resource.annotations) {\n      resource.annotations = resource.annotations.map((annotationPage: AnnotationPage): AnnotationPage => {\n        return this.traverseAnnotationPage(annotationPage);\n      });\n    }\n\n    return resource;\n  }\n\n  traverseCanvas(canvas: Canvas): Canvas {\n    return this.traverseType<Canvas>(\n      this.traverseInlineAnnotationPages(\n        this.traversePosterCanvas(this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(canvas))))\n      ),\n      this.traversals.canvas\n    );\n  }\n\n  traverseAnnotationPageItems(annotationPage: AnnotationPage): AnnotationPage {\n    if (annotationPage.items) {\n      annotationPage.items = annotationPage.items.map((annotation: Annotation): Annotation => {\n        return this.traverseAnnotation(annotation);\n      });\n    }\n    return annotationPage;\n  }\n\n  traverseAnnotationPage(annotationPageJson: AnnotationPage): AnnotationPage {\n    return this.traverseType<AnnotationPage>(\n      this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationPageItems(annotationPageJson) as any)),\n      this.traversals.annotationPage\n    );\n  }\n\n  // Disabling these.\n\n  traverseAnnotationBody(annotation: Annotation): Annotation {\n    if (Array.isArray(annotation.body)) {\n      annotation.body = annotation.body.map((annotationBody: any): ContentResource => {\n        return this.traverseContentResource(annotationBody);\n      });\n    } else if (annotation.body) {\n      annotation.body = this.traverseContentResource(annotation.body as ContentResource);\n    }\n\n    return annotation;\n  }\n\n  /*\n  traverseAnnotationTarget(annotation: Annotation): Annotation {\n    if (Array.isArray(annotation.target)) {\n      annotation.target = annotation.target.map(\n        (annotationBody: ContentResource): ContentResource => {\n          return this.traverseContentResource(annotationBody);\n        }\n      );\n    } else if (annotation.target) {\n      annotation.target = this.traverseContentResource(annotation.target);\n    }\n\n    return annotation;\n  }\n  */\n\n  traversePosterCanvas<T extends Collection | Manifest | Canvas | Range>(json: T): T {\n    // @deprecated\n    if (json.posterCanvas) {\n      json.posterCanvas = this.traverseCanvas(json.posterCanvas);\n    }\n\n    if (json.placeholderCanvas) {\n      json.placeholderCanvas = this.traverseCanvas(json.placeholderCanvas);\n    }\n\n    if (json.accompanyingCanvas) {\n      json.accompanyingCanvas = this.traverseCanvas(json.accompanyingCanvas);\n    }\n\n    return json;\n  }\n\n  // @todo traverseAnnotationSelector\n  traverseAnnotation(annotationJson: Annotation): Annotation {\n    return this.traverseType<Annotation>(\n      // Disabled these for now.\n      // this.traverseAnnotationTarget(this.traverseLinking(this.traverseAnnotationBody(annotationJson))),\n      this.traverseLinking(this.traverseAnnotationBody(annotationJson)),\n      this.traversals.annotation\n    );\n  }\n\n  traverseContentResourceLinking(contentResourceJson: ContentResource): ContentResource {\n    if (typeof contentResourceJson === 'string' || !contentResourceJson) {\n      return contentResourceJson;\n    }\n    if (contentResourceJson && (contentResourceJson as IIIFExternalWebResource)!.service) {\n      (contentResourceJson as IIIFExternalWebResource).service = ensureArray(\n        (contentResourceJson as IIIFExternalWebResource).service || []\n      ).map((service) => this.traverseType(service, this.traversals.service));\n    }\n\n    return contentResourceJson;\n  }\n\n  traverseContentResource(contentResourceJson: ContentResource): ContentResource {\n    if ((contentResourceJson as any).type === 'Choice') {\n      (contentResourceJson as any).items = (contentResourceJson as any).items.map((choiceItem: ContentResource) => {\n        return this.traverseContentResource(choiceItem);\n      });\n    }\n\n    return this.traverseType<ContentResource>(\n      // This needs an `any` because of the scope of W3C annotation bodies (covered by ContentResource).\n      // ContentResources are permitted to have a `.annotations` property, so we can pass it as any  for this\n      // case.\n      this.traverseInlineAnnotationPages(this.traverseContentResourceLinking(contentResourceJson) as any),\n      this.traversals.contentResource\n    );\n  }\n\n  traverseRangeRanges(range: Range): Range {\n    if (range.items) {\n      range.items = range.items.map((rangeOrManifest: RangeItems) => {\n        if (typeof rangeOrManifest === 'string') {\n          return this.traverseCanvas({ id: rangeOrManifest, type: 'Canvas' });\n        }\n        if (rangeOrManifest.type === 'Manifest') {\n          return this.traverseManifest(rangeOrManifest as Manifest);\n        }\n        return this.traverseRange(rangeOrManifest as Range);\n      });\n    }\n\n    return range;\n  }\n\n  traverseRange(range: Range): Range {\n    return this.traverseType<Range>(\n      this.traversePosterCanvas(this.traverseDescriptive(this.traverseLinking(this.traverseRangeRanges(range)))),\n      this.traversals.range\n    );\n  }\n\n  traverseAgent(agent: ResourceProvider) {\n    return this.traverseType<ResourceProvider>(\n      this.traverseDescriptive(this.traverseLinking(agent)),\n      this.traversals.agent\n    );\n  }\n\n  traverseType<T>(object: T, traversals: Array<Traversal<T>>): T {\n    return traversals.reduce((acc: T, traversal: Traversal<T>): T => {\n      const returnValue = traversal(acc);\n      if (typeof returnValue === 'undefined' && !this.options.allowUndefinedReturn) {\n        return acc;\n      }\n      return returnValue;\n    }, object);\n  }\n\n  traverseService(service: Service): Service {\n    return this.traverseType<Service>(service, this.traversals.service);\n  }\n\n  traverseUnknown(resource: any) {\n    const type = identifyResource(resource);\n\n    switch (type) {\n      case 'Collection':\n        return this.traverseCollection(resource as Collection);\n      case 'Manifest':\n        return this.traverseManifest(resource as Manifest);\n      case 'Canvas':\n        return this.traverseCanvas(resource as Canvas);\n      case 'AnnotationPage':\n        return this.traverseAnnotationPage(resource as AnnotationPage);\n      case 'Annotation':\n        return this.traverseAnnotation(resource as Annotation);\n      case 'ContentResource':\n        return this.traverseContentResource(resource as ContentResource);\n      case 'Range':\n        return this.traverseRange(resource as Range);\n      case 'Service':\n        return this.traverseService(resource as Service);\n      case 'Agent':\n        return this.traverseAgent(resource as ResourceProvider);\n      default:\n        throw new Error(`Unknown or unsupported resource type of ${type}`);\n    }\n  }\n}\n","import {\n  Annotation,\n  AnnotationList,\n  Canvas,\n  ChoiceEmbeddedContent,\n  Collection,\n  CommonContentResource,\n  ContentResource,\n  DescriptiveProperties,\n  Layer,\n  LinkingProperties,\n  Manifest,\n  OneOrMany,\n  Range,\n  RightsProperties,\n  Sequence,\n  Service,\n  TraversableEntityTypes,\n  Traversal,\n  TraversalMap,\n} from '@iiif/presentation-2';\n\nexport const types: TraversableEntityTypes[] = [\n  'sc:Collection',\n  'sc:Manifest',\n  'sc:Canvas',\n  'sc:AnnotationList',\n  'oa:Annotation',\n  'sc:Range',\n  'sc:Layer',\n  'sc:Sequence',\n  'oa:Choice',\n  // Opaque.\n  'Service',\n  'ContentResource',\n];\n\nexport type TraverseOptions = {\n  convertPropsToArray: boolean;\n  mergeMemberProperties: boolean;\n  allowUndefinedReturn: boolean;\n};\n\nexport function identifyResource(resource: any): TraversableEntityTypes {\n  if (typeof resource === 'undefined' || resource === null) {\n    throw new Error('Null or undefined is not a valid entity.');\n  }\n  if (Array.isArray(resource)) {\n    throw new Error('Array is not a valid entity');\n  }\n  if (typeof resource !== 'object') {\n    throw new Error(`${typeof resource} is not a valid entity`);\n  }\n\n  if (typeof resource['@type'] === 'string') {\n    const hasType = types.indexOf(resource['@type'] as any);\n    if (hasType !== -1) {\n      return types[hasType];\n    }\n  }\n\n  if (resource.profile) {\n    return 'Service';\n  }\n\n  if (resource.format) {\n    return 'ContentResource';\n  }\n\n  // Big o'l fallback.\n  if (resource['@type']) {\n    return 'ContentResource';\n  }\n\n  throw new Error('Resource type is not known');\n}\n\nexport class Traverse<\n  T extends {\n    Collection: any;\n    Manifest: any;\n    Canvas: any;\n    AnnotationList: any;\n    Sequence: any;\n    Annotation: any;\n    ContentResource: any;\n    Choice: any;\n    Range: any;\n    Service: any;\n    Layer: any;\n  } = {\n    Collection: Collection;\n    Manifest: Manifest;\n    Canvas: Canvas;\n    AnnotationList: AnnotationList;\n    Sequence: Sequence;\n    Annotation: Annotation;\n    ContentResource: CommonContentResource;\n    Choice: ChoiceEmbeddedContent;\n    Range: Range;\n    Service: Service;\n    Layer: Layer;\n  }\n> {\n  private traversals: Required<TraversalMap>;\n  private options: TraverseOptions;\n\n  constructor(traversals: Partial<TraversalMap>, options: Partial<TraverseOptions> = {}) {\n    this.traversals = {\n      collection: [],\n      manifest: [],\n      canvas: [],\n      annotationList: [],\n      sequence: [],\n      annotation: [],\n      contentResource: [],\n      choice: [],\n      range: [],\n      service: [],\n      layer: [],\n      ...traversals,\n    };\n    this.options = {\n      convertPropsToArray: true,\n      mergeMemberProperties: true,\n      allowUndefinedReturn: false,\n      ...options,\n    };\n  }\n\n  static all(traversal: (resource: any) => any) {\n    return new Traverse({\n      collection: [traversal],\n      manifest: [traversal],\n      canvas: [traversal],\n      annotationList: [traversal],\n      sequence: [traversal],\n      annotation: [traversal],\n      contentResource: [traversal],\n      choice: [traversal],\n      range: [traversal],\n      service: [traversal],\n      layer: [traversal],\n    });\n  }\n\n  traverseCollection(collection: Collection): T['Collection'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseCollectionItems(collection))),\n      this.traversals.collection\n    );\n  }\n\n  traverseCollectionItems(collection: Collection): Collection {\n    if (this.options.mergeMemberProperties) {\n      const members = [\n        ...(collection.manifests || []).map((manifest) => {\n          if (typeof manifest === 'string') {\n            return { '@id': manifest, '@type': 'sc:Manifest' };\n          }\n          return manifest;\n        }),\n        ...(collection.collections || []).map((subCollection) => {\n          if (typeof subCollection === 'string') {\n            return { '@id': subCollection, '@type': 'sc:Collection' };\n          }\n          return subCollection;\n        }),\n        ...(collection.members || []),\n      ];\n\n      delete collection.collections;\n      delete collection.manifests;\n      collection.members = members;\n    }\n\n    if (collection.manifests) {\n      collection.manifests = collection.manifests.map((manifest) =>\n        this.traverseManifest(\n          typeof manifest === 'string'\n            ? ({ '@id': manifest, '@type': 'sc:Manifest' } as Manifest)\n            : (manifest as Manifest)\n        )\n      );\n    }\n\n    if (collection.collections) {\n      collection.collections = collection.collections.map((subCollection) =>\n        this.traverseCollection(\n          typeof subCollection === 'string'\n            ? ({ '@id': subCollection, '@type': 'sc:Collection' } as Collection)\n            : (subCollection as Collection)\n        )\n      );\n    }\n\n    if (collection.members) {\n      collection.members = collection.members.map((member) => {\n        if (typeof member === 'string') {\n          return member;\n        }\n        return this.traverseUnknown(member);\n      });\n    }\n\n    return collection;\n  }\n\n  traverseManifest(manifest: Manifest): T['Manifest'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(manifest))),\n      this.traversals.manifest\n    );\n  }\n\n  traverseManifestItems(manifest: Manifest): Manifest {\n    if (manifest.sequences) {\n      manifest.sequences = manifest.sequences.map((sequence) => this.traverseSequence(sequence));\n    }\n    if (manifest.structures) {\n      manifest.structures = manifest.structures.map((structure) => this.traverseRange(structure));\n    }\n    return manifest;\n  }\n\n  traverseSequence(sequence: Sequence): T['Sequence'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseSequenceItems(sequence))),\n      this.traversals.sequence\n    );\n  }\n\n  traverseSequenceItems(sequence: Sequence): Sequence {\n    if (sequence.canvases) {\n      sequence.canvases = sequence.canvases.map((canvas) => this.traverseCanvas(canvas));\n    }\n    return sequence;\n  }\n\n  traverseCanvas(canvas: Canvas): T['Canvas'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(canvas))),\n      this.traversals.canvas\n    );\n  }\n\n  traverseCanvasItems(canvas: Canvas): Canvas {\n    if (canvas.images) {\n      canvas.images = canvas.images.map((image) => this.traverseAnnotation(image));\n    }\n    if (canvas.otherContent) {\n      canvas.otherContent = canvas.otherContent.map((annotationList) => this.traverseAnnotationList(annotationList));\n    }\n    return canvas;\n  }\n\n  traverseRange(range: Range): T['Range'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseRangeItems(range))),\n      this.traversals.range\n    );\n  }\n\n  traverseRangeItems(range: Range): Range {\n    if (this.options.mergeMemberProperties) {\n      const members = [\n        ...(range.ranges || []).map((innerRange: any) => {\n          if (typeof innerRange === 'string') {\n            return { '@id': innerRange, '@type': 'sc:Range' };\n          }\n          return innerRange;\n        }),\n        ...(range.canvases || []).map((canvas: any) => {\n          if (typeof canvas === 'string') {\n            return { '@id': canvas, '@type': 'sc:Canvas' };\n          }\n          return canvas;\n        }),\n        ...(range.members || []),\n      ];\n\n      delete range.ranges;\n      delete range.canvases;\n      range.members = members.length ? members.map((member) => this.traverseUnknown(member)) : undefined;\n    }\n    return range;\n  }\n\n  traverseAnnotationList(annotationList: AnnotationList): T['AnnotationList'] {\n    const list =\n      typeof annotationList === 'string'\n        ? ({ '@id': annotationList, '@type': 'sc:AnnotationList' } as any)\n        : annotationList;\n\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseAnnotationListItems(list)),\n      this.traversals.annotationList\n    );\n  }\n\n  traverseAnnotationListItems(annotationList: AnnotationList): AnnotationList {\n    if (annotationList.resources) {\n      annotationList.resources = annotationList.resources.map((annotation) => this.traverseAnnotation(annotation));\n    }\n\n    return annotationList;\n  }\n\n  traverseAnnotation(annotation: Annotation): T['Annotation'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationItems(annotation))),\n      this.traversals.annotation\n    );\n  }\n\n  traverseAnnotationItems(annotation: Annotation): Annotation {\n    if (annotation.resource) {\n      if (Array.isArray(annotation.resource)) {\n        annotation.resource = annotation.resource.map((res) =>\n          this.traverseContentResource(res as CommonContentResource)\n        );\n      } else {\n        annotation.resource = this.traverseContentResource(annotation.resource as CommonContentResource);\n      }\n    }\n\n    if (annotation.on) {\n      // selector - just traverse the annotations.\n      // annotation.on = this.traverseSelector(annotation.on);\n    }\n\n    return annotation;\n  }\n\n  traverseLayer(layer: Layer): T['Layer'] {\n    return this.traverseType(this.traverseLinking(this.traverseLayerItems(layer)), this.traversals.layer);\n  }\n\n  traverseLayerItems(layer: Layer): Layer {\n    if (layer.otherContent) {\n      layer.otherContent = layer.otherContent.map((annotationList) => this.traverseAnnotationList(annotationList));\n    }\n    return layer;\n  }\n\n  traverseChoice(choice: ChoiceEmbeddedContent): T['Choice'] {\n    return this.traverseType(this.traverseChoiceItems(choice), this.traversals.choice);\n  }\n\n  traverseChoiceItems(choice: ChoiceEmbeddedContent) {\n    if (choice.default && choice.default !== 'rdf:nil') {\n      choice.default = this.traverseContentResource(choice.default);\n    }\n    if (choice.item && choice.item !== 'rdf:nil') {\n      choice.item = choice.item.map((item) => this.traverseContentResource(item));\n    }\n\n    return choice;\n  }\n\n  traverseService(service: Service): T['Service'] {\n    return this.traverseType(this.traverseLinking(service as any), this.traversals.service);\n  }\n\n  traverseContentResource(contentResource: CommonContentResource): T['ContentResource'] {\n    if (contentResource['@type'] === 'oa:Choice') {\n      return this.traverseChoice(contentResource as any);\n    }\n\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(contentResource as any)),\n      this.traversals.contentResource\n    );\n  }\n\n  traverseUnknown(item: any) {\n    if (!item['@type'] || typeof item === 'string') {\n      // Unknown item.\n      return item;\n    }\n    switch (identifyResource(item)) {\n      case 'sc:Collection':\n        return this.traverseCollection(item);\n      case 'sc:Manifest':\n        return this.traverseManifest(item);\n      case 'sc:Canvas':\n        return this.traverseCanvas(item);\n      case 'sc:Sequence':\n        return this.traverseSequence(item);\n      case 'sc:Range':\n        return this.traverseRange(item);\n      case 'oa:Annotation':\n        return this.traverseAnnotation(item);\n      case 'sc:AnnotationList':\n        return this.traverseAnnotationList(item);\n      case 'sc:Layer':\n        return this.traverseLayer(item);\n      case 'Service':\n        return this.traverseService(item);\n      case 'oa:Choice':\n        return this.traverseChoice(item);\n      case 'ContentResource':\n        return this.traverseContentResource(item);\n    }\n\n    if (item.profile) {\n      return this.traverseService(item);\n    }\n\n    return item;\n  }\n\n  traverseImageResource(contentResource: OneOrMany<string | ContentResource>) {\n    const wasArray = Array.isArray(contentResource);\n    const resourceList = Array.isArray(contentResource) ? contentResource : [contentResource];\n    const newResourceList: any[] = [];\n\n    for (const singleResource of resourceList) {\n      if (typeof singleResource === 'string') {\n        newResourceList.push(\n          this.traverseContentResource({\n            '@id': singleResource,\n            '@type': 'dctypes:Image',\n          })\n        );\n      } else {\n        newResourceList.push(this.traverseContentResource(singleResource as any));\n      }\n    }\n\n    if (!wasArray && !this.options.convertPropsToArray) {\n      return newResourceList[0];\n    }\n\n    return newResourceList;\n  }\n\n  traverseDescriptive<T extends Partial<DescriptiveProperties & RightsProperties>>(resource: T) {\n    if (resource.thumbnail) {\n      resource.thumbnail = this.traverseImageResource(resource.thumbnail);\n    }\n\n    if (resource.logo) {\n      resource.logo = this.traverseImageResource(resource.logo);\n    }\n\n    return resource;\n  }\n\n  traverseOneOrMoreServices(allServices: OneOrMany<any>) {\n    const wasArray = Array.isArray(allServices);\n    const services = Array.isArray(allServices) ? allServices : [allServices];\n    const newServices = [];\n    for (const service of services) {\n      newServices.push(this.traverseService(service));\n    }\n\n    if (!wasArray && !this.options.convertPropsToArray) {\n      return newServices[0];\n    }\n\n    return newServices;\n  }\n\n  traverseLinking<T extends Partial<LinkingProperties>>(resource: T) {\n    if (resource.related) {\n      resource.related = this.traverseOneOrManyType(resource.related, this.traversals.contentResource);\n    }\n    if (resource.rendering) {\n      resource.rendering = this.traverseOneOrManyType(resource.rendering, this.traversals.contentResource);\n    }\n    if (resource.service) {\n      resource.service = this.traverseOneOrMoreServices(resource.service);\n    }\n    if (resource.seeAlso) {\n      resource.seeAlso = this.traverseOneOrManyType(resource.seeAlso, this.traversals.contentResource);\n    }\n    if (resource.within) {\n      if (typeof resource.within === 'string') {\n        // I don't know. skip?\n      } else {\n        resource.within = this.traverseOneOrManyType(\n          resource.within as CommonContentResource,\n          this.traversals.contentResource\n        );\n      }\n    }\n    if (resource.startCanvas) {\n      if (typeof resource.startCanvas === 'string') {\n        resource.startCanvas = this.traverseType(\n          { '@id': resource.startCanvas, '@type': 'sc:Canvas' } as Canvas,\n          this.traversals.canvas\n        );\n      } else if (resource.startCanvas) {\n        this.traverseType(resource.startCanvas as any, this.traversals.canvas);\n      }\n    }\n    if (resource.contentLayer) {\n      if (typeof resource.contentLayer === 'string') {\n        resource.contentLayer = this.traverseLayer({\n          '@id': resource.contentLayer,\n          '@type': 'sc:Layer',\n        });\n      } else {\n        resource.contentLayer = this.traverseLayer(resource.contentLayer);\n      }\n    }\n    return resource;\n  }\n\n  traverseOneOrManyType<T, Return = T>(object: T | T[], traversals: Array<Traversal<T>>): Return {\n    if (!Array.isArray(object)) {\n      if (this.options.convertPropsToArray) {\n        object = [object] as T[];\n      } else {\n        return this.traverseType(object, traversals);\n      }\n    }\n    return object.map((singleObj) => this.traverseType(singleObj, traversals)) as any;\n  }\n\n  traverseType<T, Return = T>(object: T, traversals: Array<Traversal<T>>): Return {\n    return traversals.reduce((acc: T, traversal: Traversal<T>): T => {\n      const returnValue = traversal(acc);\n      if (typeof returnValue === 'undefined' && !this.options.allowUndefinedReturn) {\n        return acc;\n      }\n      return returnValue;\n    }, object) as any;\n  }\n}\n","export const STANFORD_IIIF_IMAGE_COMPLIANCE_0 = 'http://library.stanford.edu/iiif/image-api/compliance.html#level0';\nexport const STANFORD_IIIF_IMAGE_COMPLIANCE_1 = 'http://library.stanford.edu/iiif/image-api/compliance.html#level1';\nexport const STANFORD_IIIF_IMAGE_COMPLIANCE_2 = 'http://library.stanford.edu/iiif/image-api/compliance.html#level2';\nexport const STANFORD_IIIF_IMAGE_CONFORMANCE_0 = 'http://library.stanford.edu/iiif/image-api/conformance.html#level0';\nexport const STANFORD_IIIF_IMAGE_CONFORMANCE_1 = 'http://library.stanford.edu/iiif/image-api/conformance.html#level1';\nexport const STANFORD_IIIF_IMAGE_CONFORMANCE_2 = 'http://library.stanford.edu/iiif/image-api/conformance.html#level2';\nexport const STANFORD_IIIF_1_IMAGE_COMPLIANCE_0 =\n  'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0';\nexport const STANFORD_IIIF_1_IMAGE_COMPLIANCE_1 =\n  'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1';\nexport const STANFORD_IIIF_1_IMAGE_COMPLIANCE_2 =\n  'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2';\nexport const STANFORD_IIIF_1_IMAGE_CONFORMANCE_0 =\n  'http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0';\nexport const STANFORD_IIIF_1_IMAGE_CONFORMANCE_1 =\n  'http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1';\nexport const STANFORD_IIIF_1_IMAGE_CONFORMANCE_2 =\n  'http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2';\nexport const IIIF_1_IMAGE_LEVEL_0 = 'http://iiif.io/api/image/1/level0.json';\nexport const IIIF_1_IMAGE_LEVEL_0_PROFILE = 'http://iiif.io/api/image/1/profiles/level0.json';\nexport const IIIF_1_IMAGE_LEVEL_1 = 'http://iiif.io/api/image/1/level1.json';\nexport const IIIF_1_IMAGE_LEVEL_1_PROFILE = 'http://iiif.io/api/image/1/profiles/level1.json';\nexport const IIIF_1_IMAGE_LEVEL_2 = 'http://iiif.io/api/image/1/level2.json';\nexport const IIIF_1_IMAGE_LEVEL_2_PROFILE = 'http://iiif.io/api/image/1/profiles/level2.json';\nexport const IIIF_2_IMAGE_LEVEL_0 = 'http://iiif.io/api/image/2/level0.json';\nexport const IIIF_2_IMAGE_LEVEL_0_PROFILE = 'http://iiif.io/api/image/2/profiles/level0.json';\nexport const IIIF_2_IMAGE_LEVEL_1 = 'http://iiif.io/api/image/2/level1.json';\nexport const IIIF_2_IMAGE_LEVEL_1_PROFILE = 'http://iiif.io/api/image/2/profiles/level1.json';\nexport const IIIF_2_IMAGE_LEVEL_2 = 'http://iiif.io/api/image/2/level2.json';\nexport const IIIF_2_IMAGE_LEVEL_2_PROFILE = 'http://iiif.io/api/image/2/profiles/level2.json';\nexport const IIIF_3_IMAGE_LEVEL_0 = 'level0';\nexport const IIIF_3_IMAGE_LEVEL_1 = 'level1';\nexport const IIIF_3_IMAGE_LEVEL_2 = 'level2';\n\n// Non-standard\nexport const IIIF_2_IMAGE_LEVEL_0_NO_JSON = 'http://iiif.io/api/image/2/level0';\nexport const IIIF_2_IMAGE_LEVEL_1_NO_JSON = 'http://iiif.io/api/image/2/level1';\nexport const IIIF_2_IMAGE_LEVEL_2_NO_JSON = 'http://iiif.io/api/image/2/level2';\n\nexport const level1Support = [\n  IIIF_2_IMAGE_LEVEL_1_NO_JSON,\n  IIIF_2_IMAGE_LEVEL_2_NO_JSON,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_2,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_2,\n  IIIF_1_IMAGE_LEVEL_1,\n  IIIF_1_IMAGE_LEVEL_1_PROFILE,\n  IIIF_1_IMAGE_LEVEL_2,\n  IIIF_1_IMAGE_LEVEL_2_PROFILE,\n  IIIF_2_IMAGE_LEVEL_1,\n  IIIF_2_IMAGE_LEVEL_1_PROFILE,\n  IIIF_2_IMAGE_LEVEL_2,\n  IIIF_2_IMAGE_LEVEL_2_PROFILE,\n  IIIF_3_IMAGE_LEVEL_1,\n  IIIF_3_IMAGE_LEVEL_2,\n];\n\nexport const imageServiceProfiles = [\n  IIIF_2_IMAGE_LEVEL_0_NO_JSON,\n  IIIF_2_IMAGE_LEVEL_1_NO_JSON,\n  IIIF_2_IMAGE_LEVEL_2_NO_JSON,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_0,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_0,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_2,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_0,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_0,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_2,\n  IIIF_1_IMAGE_LEVEL_0,\n  IIIF_1_IMAGE_LEVEL_0_PROFILE,\n  IIIF_1_IMAGE_LEVEL_1,\n  IIIF_1_IMAGE_LEVEL_1_PROFILE,\n  IIIF_1_IMAGE_LEVEL_2,\n  IIIF_1_IMAGE_LEVEL_2_PROFILE,\n  IIIF_2_IMAGE_LEVEL_0,\n  IIIF_2_IMAGE_LEVEL_0_PROFILE,\n  IIIF_2_IMAGE_LEVEL_1,\n  IIIF_2_IMAGE_LEVEL_1_PROFILE,\n  IIIF_2_IMAGE_LEVEL_2,\n  IIIF_2_IMAGE_LEVEL_2_PROFILE,\n  IIIF_3_IMAGE_LEVEL_0,\n  IIIF_3_IMAGE_LEVEL_1,\n  IIIF_3_IMAGE_LEVEL_2,\n];\n","import * as Presentation3 from '@iiif/presentation-3';\nimport * as Presentation2 from '@iiif/presentation-2';\nimport { imageServiceProfiles, level1Support } from '../shared/image-api-profiles';\nimport { Traverse } from './traverse';\nimport { ensureArray } from '../shared/ensure-array';\n\nconst configuration = {\n  attributionLabel: 'Attribution',\n  lang: 'none',\n  providerId: 'http://example.org/provider',\n  providerName: 'Unknown',\n};\n\nexport function convertLanguageMapping(\n  inputLangProperty?: Presentation2.OneOrMany<Presentation2.LanguageProperty>,\n  defaultLang = 'none'\n): Presentation3.InternationalString {\n  if (!inputLangProperty) {\n    return {};\n  }\n\n  const arrayOfValues = Array.isArray(inputLangProperty) ? inputLangProperty : [inputLangProperty];\n\n  const languageMap: Presentation3.InternationalString = {};\n\n  for (const language of arrayOfValues) {\n    // For strings \"label\": [\"a value\"]\n    if (typeof language === 'string') {\n      languageMap[defaultLang] = languageMap[defaultLang] ? languageMap[defaultLang] : [];\n      (languageMap[defaultLang] as string[]).push(language || '');\n      continue;\n    }\n\n    // For maps without a language\n    if (!language['@language']) {\n      languageMap[defaultLang] = languageMap[defaultLang] ? languageMap[defaultLang] : [];\n      (languageMap[defaultLang] as string[]).push(language['@value'] || '');\n      continue;\n    }\n\n    // Default case with language.\n    const lang = language['@language'];\n    languageMap[lang] = languageMap[lang] ? languageMap[lang] : [];\n    (languageMap[lang] as string[]).push(language['@value'] || '');\n  }\n  return languageMap;\n}\n\nexport function getProfile(profile: any | any[]): string | undefined {\n  if (Array.isArray(profile)) {\n    return getProfile(profile.find((s) => typeof s === 'string'));\n  }\n\n  if (imageServiceProfiles.indexOf(profile) !== -1) {\n    return 'level2';\n  }\n\n  if (level1Support.indexOf(profile) !== -1) {\n    return 'level1';\n  }\n\n  if (typeof profile !== 'string') {\n    return undefined;\n  }\n\n  return profile;\n}\n\nexport function getTypeFromContext(inputContexts: string | string[]): string | undefined {\n  const contexts: string[] = Array.isArray(inputContexts) ? inputContexts : [inputContexts];\n\n  for (const context of contexts) {\n    switch (context) {\n      case 'http://iiif.io/api/image/2/context.json':\n      case 'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2':\n        return 'ImageService2';\n      case 'http://iiif.io/api/image/1/context.json':\n      case 'http://library.stanford.edu/iiif/image-api/1.1/context.json':\n        return 'ImageService1';\n      case 'http://iiif.io/api/annex/openannotation/context.json':\n        return 'ImageApiSelector';\n    }\n  }\n\n  return undefined;\n}\n\nfunction getTypeFromProfile(inputProfile: string): string | undefined {\n  switch (inputProfile) {\n    case 'http://iiif.io/api/image/2/level0.json':\n    case 'http://iiif.io/api/image/2/level1.json':\n    case 'http://iiif.io/api/image/2/level2.json':\n      return 'ImageService2';\n\n    case 'http://iiif.io/api/auth/1/kiosk':\n    case 'http://iiif.io/api/auth/1/login':\n    case 'http://iiif.io/api/auth/1/clickthrough':\n    case 'http://iiif.io/api/auth/1/external':\n    case 'http://iiif.io/api/auth/0/kiosk':\n    case 'http://iiif.io/api/auth/0/login':\n    case 'http://iiif.io/api/auth/0/clickthrough':\n    case 'http://iiif.io/api/auth/0/external':\n      return 'AuthCookieService1';\n\n    case 'http://iiif.io/api/auth/1/token':\n    case 'http://iiif.io/api/auth/0/token':\n      return 'AuthTokenService1';\n    case 'http://iiif.io/api/auth/1/logout':\n    case 'http://iiif.io/api/auth/0/logout':\n      return 'AuthLogoutService1';\n\n    case 'http://iiif.io/api/search/1/search':\n    case 'http://iiif.io/api/search/0/search':\n      return 'SearchService1';\n    case 'http://iiif.io/api/search/1/autocomplete':\n    case 'http://iiif.io/api/search/0/autocomplete':\n      return 'AutoCompleteService1';\n  }\n\n  return undefined;\n}\n\nfunction removePrefix(str: string) {\n  for (const prefix of ['sc', 'oa', 'dcterms', 'dctypes', 'iiif']) {\n    if (str.startsWith(`${prefix}:`)) {\n      return str.slice(prefix.length + 1);\n    }\n  }\n\n  return str;\n}\n\nconst knownTypes = ['Collection', 'Manifest', 'Annotation', 'AnnotationPage', 'Range', 'Service'];\n\nfunction getNewType(resource: any): string {\n  const id = resource['@id'] || resource.id;\n  let oldType: string | string[] = resource['@type'] || resource.type;\n  const profile: any = resource.profile || undefined;\n  const context: any = resource['@context'] || undefined;\n\n  if (profile) {\n    const possibleType = getTypeFromProfile(profile);\n    if (possibleType) {\n      return possibleType;\n    }\n  }\n\n  if (context) {\n    const possibleType = getTypeFromContext(context);\n    if (possibleType) {\n      return possibleType;\n    }\n  }\n\n  if (oldType) {\n    if (Array.isArray(oldType)) {\n      if (oldType.indexOf('oa:CssStylesheet') !== -1) {\n        return 'CssStylesheet';\n      }\n      if (oldType.indexOf('cnt:ContentAsText') !== -1) {\n        return 'TextualBody';\n      }\n      // Nothing we can do?\n      oldType = oldType[0];\n    }\n\n    for (const prefix of ['sc', 'oa', 'dcterms', 'dctypes', 'iiif']) {\n      if (oldType.startsWith(`${prefix}:`)) {\n        oldType = oldType.slice(prefix.length + 1);\n        break;\n      }\n    }\n\n    switch (oldType) {\n      case 'Layer':\n        return 'AnnotationCollection';\n      case 'AnnotationList':\n        return 'AnnotationPage';\n      case 'cnt:ContentAsText':\n        return 'TextualBody';\n      // @todo There are definitely some missing annotation types here.\n    }\n  }\n\n  if (oldType && knownTypes.indexOf(oldType) !== -1) {\n    return oldType;\n  }\n\n  if (resource.format) {\n    if (resource.format.startsWith('image/')) {\n      return 'Image';\n    }\n    if (resource.format.startsWith('text/')) {\n      return 'Text';\n    }\n    if (resource.format === 'application/pdf') {\n      return 'Text';\n    }\n    if (resource.format.startsWith('application/')) {\n      return 'Dataset';\n    }\n  }\n\n  if (id && (id.endsWith('.jpg') || id.endsWith('.png') || id.endsWith('.jpeg'))) {\n    return 'Image';\n  }\n\n  if (!oldType) {\n    return 'unknown';\n  }\n\n  // Again, nothing we can do.\n  return oldType as string;\n}\n\nconst licenseRegex = /http(s)?:\\/\\/(creativecommons.org|rightsstatements.org)[^\"'\\\\<\\n]+/gm;\n\nfunction extractLicense(license: string) {\n  const matches = license.match(licenseRegex);\n  if (matches) {\n    return matches[0];\n  }\n\n  return license;\n}\n\nasync function getContentTypeOfRemoteResource(resourceId: string): Promise<string | undefined> {\n  try {\n    const response = await fetch(resourceId, { method: 'HEAD' });\n    const headers = response.headers;\n\n    return headers.get('content-type') || undefined;\n  } catch (e) {\n    // do nothing.\n  }\n\n  return undefined;\n}\n\nfunction fixLicense(\n  license: Presentation2.RightsProperties['license'],\n  licenseLabel = 'Rights/License',\n  lang = 'none'\n): [Presentation3.DescriptiveProperties['rights'], Presentation3.DescriptiveProperties['metadata']] {\n  let rights: Presentation3.DescriptiveProperties['rights'] = null;\n  const metadata: Presentation3.DescriptiveProperties['metadata'] = [];\n\n  const licenseList = Array.isArray(license) ? license : [license];\n\n  for (const rawLicense of licenseList) {\n    const singleLicense = rawLicense ? extractLicense(rawLicense) : undefined;\n\n    if (\n      singleLicense &&\n      (singleLicense.indexOf('creativecommons.org') !== -1 || singleLicense.indexOf('rightsstatements.org') !== -1)\n    ) {\n      if (singleLicense.startsWith('https://')) {\n        rights = `http://${singleLicense.slice(8)}`;\n      } else {\n        rights = singleLicense;\n      }\n      continue;\n    }\n    if (singleLicense) {\n      metadata.push({\n        label: { [lang]: [licenseLabel] },\n        value: { [lang]: [singleLicense] },\n      });\n    }\n  }\n\n  return [rights, metadata];\n}\n\nconst removeContexts = [\n  'http://iiif.io/api/presentation/2/context.json',\n  'http://iiif.io/api/image/2/context.json',\n  'http://iiif.io/api/image/1/context.json',\n  'http://library.stanford.edu/iiif/image-api/1.1/context.json',\n  'http://iiif.io/api/search/1/context.json',\n  'http://iiif.io/api/search/0/context.json',\n  'http://iiif.io/api/auth/1/context.json',\n  'http://iiif.io/api/auth/0/context.json',\n  'http://iiif.io/api/annex/openannotation/context.json',\n];\n\nfunction fixContext(inputContext: string | string[] | undefined): string | string[] | undefined {\n  if (inputContext) {\n    const contexts = Array.isArray(inputContext) ? inputContext : [inputContext];\n\n    const newContexts = [];\n    for (const context of contexts) {\n      if (context === 'http://iiif.io/api/presentation/2/context.json') {\n        newContexts.push('http://iiif.io/api/presentation/3/context.json');\n      }\n      if (removeContexts.indexOf(context) !== -1) {\n        continue;\n      }\n      newContexts.push(context);\n    }\n\n    if (contexts.length) {\n      return newContexts.length === 1 ? newContexts[0] : newContexts;\n    }\n  }\n\n  return undefined;\n}\n\nfunction convertMetadata(\n  metadata: Presentation2.DescriptiveProperties['metadata']\n): Presentation3.DescriptiveProperties['metadata'] {\n  if (!metadata) {\n    return [];\n  }\n\n  return metadata.map((item): Presentation3.MetadataItem => {\n    return {\n      label: convertLanguageMapping(item.label),\n      value: convertLanguageMapping(item.value),\n    };\n  });\n}\n\nfunction removeUndefinedProperties(obj: any) {\n  for (const prop in obj) {\n    if (typeof obj[prop] === 'undefined' || obj[prop] === null) {\n      delete obj[prop];\n    }\n  }\n  return obj;\n}\n\nlet mintedIdCounter = 0;\n\nfunction mintNewIdFromResource(\n  resource: Presentation3.SomeRequired<Presentation2.TechnicalProperties, '@type'>,\n  subresource?: string\n) {\n  const origId = encodeURI((resource as { id?: string }).id || resource['@id'] || '').trim();\n\n  if (origId && subresource) {\n    return `${origId}/${subresource}`;\n  }\n\n  if (origId) {\n    return origId;\n  }\n\n  mintedIdCounter++;\n\n  // @todo.\n  return `http://example.org/${resource['@type']}${subresource ? `/${subresource}` : ''}/${mintedIdCounter}`;\n}\n\n// @todo this was removed due to identifiers not being able to be used externally after upgrading.\nfunction resolveDecodedURI(uri: string) {\n  return encodeURI(decodeURIComponent(uri)).trim();\n}\n\nfunction technicalProperties<T extends Partial<Presentation3.TechnicalProperties>>(\n  resource: Presentation3.SomeRequired<Presentation2.TechnicalProperties, '@type'> & {\n    motivation?: string | string[] | null;\n    format?: string;\n    profile?: any;\n    '@context'?: string | string[] | undefined;\n  }\n) {\n  const allBehaviours = [...(resource.behavior || [])];\n\n  if (resource.viewingHint) {\n    allBehaviours.push(resource.viewingHint);\n  }\n\n  let motivation: string | string[] | undefined;\n  if (Array.isArray(resource.motivation)) {\n    motivation = resource.motivation.map(removePrefix);\n  } else if (resource.motivation) {\n    motivation = removePrefix(resource.motivation);\n  }\n\n  return {\n    '@context': resource['@context'] ? fixContext(resource['@context']) : undefined,\n    id: (resource['@id'] || mintNewIdFromResource(resource)).trim(),\n    type: getNewType(resource) as any,\n    behavior: allBehaviours.length ? allBehaviours : undefined,\n    // format: This will be an optional async post-process step.\n    height: resource.height ? resource.height : undefined,\n    width: resource.width ? resource.width : undefined,\n    motivation,\n    viewingDirection: resource.viewingDirection,\n    profile: resource.profile,\n    format: resource.format ? resource.format : undefined,\n    duration: undefined,\n    timeMode: undefined,\n  } as any;\n}\n\nfunction descriptiveProperties<T extends Partial<Presentation3.DescriptiveProperties>>(\n  resource: Presentation2.DescriptiveProperties &\n    Presentation2.RightsProperties &\n    Partial<Presentation2.TechnicalProperties>\n): T {\n  const [rights, extraMetadata] = fixLicense(resource.license);\n  const allMetadata = [...(resource.metadata ? convertMetadata(resource.metadata) : []), ...extraMetadata];\n\n  return {\n    rights,\n    metadata: allMetadata.length ? allMetadata : undefined,\n    label: resource.label ? convertLanguageMapping(resource.label) : undefined,\n    requiredStatement: resource.attribution\n      ? {\n          label: convertLanguageMapping(configuration.attributionLabel),\n          value: convertLanguageMapping(resource.attribution),\n        }\n      : undefined,\n    navDate: resource.navDate,\n    summary: resource.description ? convertLanguageMapping(resource.description) : undefined,\n    thumbnail: resource.thumbnail as any,\n  } as T;\n}\n\nfunction parseWithin(resource: Presentation2.AbstractResource): undefined | Presentation3.LinkingProperties['partOf'] {\n  if (!resource.within) {\n    return undefined;\n  }\n\n  const withinProperties = Array.isArray(resource.within) ? resource.within : [resource.within];\n  const returnPartOf: Presentation3.LinkingProperties['partOf'] = [];\n\n  for (const within of withinProperties) {\n    if (typeof within === 'string') {\n      if (within) {\n        switch (resource['@type']) {\n          case 'sc:Manifest':\n            returnPartOf.push({ id: within, type: 'Collection' });\n            break;\n          // @todo are there more cases?\n        }\n      }\n    } else if ((within as any)['@id']) {\n      returnPartOf.push({\n        id: (within as any)['@id'], // as any since content resources don't require an `@id`\n        type: getNewType(within) as any,\n      });\n    } else {\n      // Content resource.\n    }\n  }\n\n  return returnPartOf.length ? returnPartOf : undefined;\n}\n\nfunction linkingProperties(resource: Presentation2.LinkingProperties & Presentation2.RightsProperties) {\n  // @todo related links to metadata.\n\n  const related = resource.related ? (Array.isArray(resource.related) ? resource.related : [resource.related]) : [];\n  const layer = resource.contentLayer as Presentation2.Layer;\n\n  return {\n    provider:\n      resource.logo || related.length\n        ? [\n            {\n              id: configuration.providerId,\n              type: 'Agent' as const,\n              homepage: related.length ? [related[0] as any] : undefined,\n              logo: resource.logo ? (Array.isArray(resource.logo) ? resource.logo : [resource.logo]) : undefined,\n              label: convertLanguageMapping(configuration.providerName),\n            },\n          ]\n        : undefined,\n    partOf: parseWithin(resource),\n    rendering: resource.rendering,\n    seeAlso: resource.seeAlso,\n    start: resource.startCanvas as any,\n    service: resource.service ? ensureArray(resource.service as any) : undefined,\n    supplementary: layer ? [layer as any] : undefined,\n  };\n}\n\n// FIXME: Is this function really needed?\nfunction embeddedContentProperties(resource: Presentation2.CharsEmbeddedContent) {\n  return {\n    chars: resource.chars,\n    format: resource.format ? resource.format : undefined,\n    language: resource.language,\n  };\n}\n\nfunction upgradeCollection(collection: Presentation2.Collection): Presentation3.Collection {\n  return removeUndefinedProperties({\n    ...technicalProperties(collection),\n    ...descriptiveProperties<Presentation3.SomeRequired<Presentation3.CollectionDescriptive, 'label'>>(collection),\n    ...linkingProperties(collection),\n    items: collection.members as any,\n  });\n}\n\nfunction flattenArray<T>(array: T[][]): T[] {\n  const returnArr: T[] = [];\n  for (const arr of array || []) {\n    returnArr.push(...arr);\n  }\n  return returnArr;\n}\n\nfunction upgradeManifest(manifest: Presentation2.Manifest): Presentation3.Manifest {\n  const allCanvases = [];\n  const behavior = [];\n  for (const sequence of manifest.sequences || []) {\n    if (sequence.canvases.length) {\n      allCanvases.push(...sequence.canvases);\n    }\n    if (sequence.behavior) {\n      behavior.push(...sequence.behavior);\n    }\n  }\n\n  // This comes from the sequence.\n  const technical = technicalProperties(manifest);\n  if (behavior.length) {\n    if (technical.behavior) {\n      technical.behavior.push(...behavior);\n    } else {\n      technical.behavior = behavior;\n    }\n  }\n\n  return removeUndefinedProperties({\n    ...technical,\n    ...descriptiveProperties(manifest),\n    ...linkingProperties(manifest),\n    items: allCanvases,\n    structures: manifest.structures as any,\n  });\n}\n\nfunction upgradeCanvas(canvas: Presentation2.Canvas): Presentation3.Canvas {\n  return removeUndefinedProperties({\n    ...technicalProperties(canvas),\n    ...descriptiveProperties(canvas),\n    ...linkingProperties(canvas),\n    annotations: canvas.otherContent && canvas.otherContent.length ? (canvas.otherContent as any[]) : undefined,\n    items:\n      canvas.images && canvas.images.length\n        ? [\n            {\n              id: mintNewIdFromResource(canvas, 'annotation-page'),\n              type: 'AnnotationPage',\n              items: canvas.images as any,\n            },\n          ]\n        : undefined,\n  });\n}\n\nfunction upgradeAnnotationList(annotationPage: Presentation2.AnnotationList): Presentation3.AnnotationPage {\n  return removeUndefinedProperties({\n    ...(technicalProperties(annotationPage) as any),\n    ...(descriptiveProperties(annotationPage) as any),\n    ...(linkingProperties(annotationPage) as any),\n    items: annotationPage.resources && annotationPage.resources.length ? (annotationPage.resources as any) : undefined,\n  });\n}\n\nfunction upgradeSequence(sequence: Presentation2.Sequence): {\n  canvases: Presentation3.Canvas[];\n  behavior?: string[];\n} {\n  /*\n    rng = {\"id\": s.get('@id', self.mint_uri()), \"type\": \"Range\"}\n    rng['behavior'] = ['sequence']\n    rng['items'] = []\n    for c in s['canvases']:\n      if type(c) == dict:\n        rng['items'].append({\"id\": c['@id'], \"type\": \"Canvas\"})\n      elif type(c) in STR_TYPES:\n        rng['items'].append({\"id\": c, \"type\": \"Canvas\"})\n    # Copy other properties and hand off to _generic\n    del s['canvases']\n    for k in s.keys():\n      if not k in ['@id', '@type']:\n        rng[k] = s[k]\n    self.process_generic(rng)\n    what['_structures'].append(rng)\n   */\n\n  if (!sequence.canvases || sequence.canvases.length === 0) {\n    return {\n      canvases: [],\n      behavior: [],\n    };\n  }\n\n  // @todo possibly return some ranges too.\n  return {\n    canvases: sequence.canvases as any[],\n    behavior: sequence.viewingHint ? [sequence.viewingHint] : [],\n  };\n}\n\nfunction upgradeAnnotation(annotation: Presentation2.Annotation): Presentation3.Annotation {\n  function upgradeTarget(target: typeof annotation.on): Presentation3.AnnotationTarget {\n    if (Array.isArray(target)) {\n      if (target.length > 1) {\n        return { type: 'List', items: target.map(upgradeTarget) as Presentation3.Target[] };\n      }\n      target = target[0];\n    }\n    if (typeof target === 'string') {\n      return encodeURI(target).trim();\n    } else if ('@type' in target) {\n      let source: string | Presentation3.Reference<'Canvas'> | Presentation3.Reference<'Image'>;\n      if (typeof target.full === 'string') {\n        source = target.full;\n      } else if (target.full['@type'] === 'dctypes:Image') {\n        source = { id: target.full['@id'], type: 'Image' };\n      } else if (target.full['@type'] === 'sc:Canvas') {\n        source = { id: target.full['@id'], type: 'Canvas' };\n      } else {\n        throw new Error(`Unsupported source type on annotation: ${target.full['@type']}`);\n      }\n      return {\n        type: 'SpecificResource',\n        source,\n        selector: upgradeSelector(target.selector),\n      };\n    } else {\n      return encodeURI(target['@id']).trim();\n    }\n  }\n  return removeUndefinedProperties({\n    ...(technicalProperties(annotation) as any),\n    ...(descriptiveProperties(annotation) as any),\n    ...(linkingProperties(annotation) as any),\n    target: upgradeTarget(annotation.on),\n    body: Array.isArray(annotation.resource)\n      ? annotation.resource.map(upgradeContentResource)\n      : upgradeContentResource(annotation.resource),\n    // @todo stylesheet upgrade.\n  });\n}\n\nfunction upgradeContentResource(inputContentResource: Presentation2.ContentResource): Presentation3.ContentResource {\n  const contentResource = inputContentResource as Presentation2.CommonContentResource;\n  // @todo there might be some field dropped here.\n  return removeUndefinedProperties({\n    ...(technicalProperties(contentResource) as any),\n    ...(descriptiveProperties(contentResource) as any),\n    ...(linkingProperties(contentResource as any) as any),\n    ...(embeddedContentProperties(contentResource as any) as any),\n  });\n}\n\nfunction upgradeChoice(choice: Presentation2.ChoiceEmbeddedContent): Presentation3.ChoiceBody {\n  const items = [];\n\n  if (choice.default && choice.default !== 'rdf:nil') {\n    items.push(choice.default);\n  }\n\n  if (choice.item && choice.item !== 'rdf:nil') {\n    items.push(...choice.item);\n  }\n\n  return {\n    ...technicalProperties(choice),\n    ...descriptiveProperties(choice),\n    items: items as any,\n  };\n}\n\nfunction upgradeRange(range: Presentation2.Range): Presentation3.Range {\n  // range.members;\n  // range.canvases;\n  // Range.\n  // At the moment a range only references other ranges by id.\n  // So we need to first get\n  return removeUndefinedProperties({\n    ...technicalProperties(range),\n    ...descriptiveProperties(range),\n    ...linkingProperties(range),\n    items: range.members as any,\n  } as Presentation3.Range);\n}\n\nfunction upgradeService(service: Presentation2.Service): Presentation3.Service {\n  const { '@id': id, '@type': type, '@context': context, profile, ...additionalProps } = service as any;\n\n  const newService: any = {};\n\n  if (id) {\n    newService['@id'] = id;\n  }\n\n  newService['@type'] = getNewType(service);\n\n  if (newService['@type'] === 'unknown') {\n    // @todo handle case where there might be multiple contexts.\n    if (context && context.length) {\n      newService['@context'] = context;\n    }\n    newService['@type'] = 'Service'; // optional on services.\n  }\n\n  if (profile) {\n    newService.profile = getProfile(profile);\n  }\n\n  return removeUndefinedProperties({\n    ...newService,\n    ...additionalProps,\n  });\n}\n\nfunction upgradeLayer(layer: Presentation2.Layer): Presentation3.AnnotationCollection {\n  return removeUndefinedProperties({\n    ...technicalProperties(layer),\n    ...descriptiveProperties(layer),\n    ...linkingProperties(layer),\n  });\n}\n\nexport const presentation2to3 = new Traverse<{\n  Collection: Presentation3.Collection;\n  Manifest: Presentation3.Manifest;\n  Canvas: Presentation3.Canvas;\n  AnnotationList: Presentation3.AnnotationPage;\n  Sequence: Presentation3.Canvas[];\n  Annotation: Presentation3.Annotation;\n  ContentResource: Presentation3.ContentResource;\n  Choice: Presentation3.ChoiceBody;\n  Range: Presentation3.Range;\n  Service: Presentation3.Service;\n  Layer: Presentation3.AnnotationCollection;\n}>({\n  collection: [upgradeCollection],\n  manifest: [upgradeManifest],\n  canvas: [upgradeCanvas],\n  annotationList: [upgradeAnnotationList],\n  sequence: [upgradeSequence],\n  annotation: [upgradeAnnotation],\n  contentResource: [upgradeContentResource],\n  choice: [upgradeChoice],\n  range: [upgradeRange],\n  service: [upgradeService],\n  layer: [upgradeLayer],\n});\n\nexport function convertPresentation2(entity: any): Presentation3.Manifest | Presentation3.Collection {\n  if (\n    (entity &&\n      entity['@context'] &&\n      (entity['@context'] === 'http://iiif.io/api/presentation/2/context.json' ||\n        entity['@context'].indexOf('http://iiif.io/api/presentation/2/context.json') !== -1 ||\n        // Yale context.\n        entity['@context'] === 'http://www.shared-canvas.org/ns/context.json')) ||\n    entity['@context'] === 'http://iiif.io/api/image/2/context.json'\n  ) {\n    return presentation2to3.traverseUnknown(entity);\n  }\n  return entity;\n}\n\nfunction upgradeSelector(\n  selector: Presentation2.ContentResourceSelector\n): Presentation3.Selector | Presentation3.Selector[] {\n  const isSvgSelector =\n    ((Array.isArray(selector['@type']) && selector['@type'].includes('oa:SvgSelector')) ||\n      selector['@type'] == 'oa:SvgSelector') &&\n    ('chars' in selector || 'value' in selector);\n  if (isSvgSelector) {\n    return {\n      type: 'SvgSelector',\n      value: 'chars' in selector ? selector.chars : selector.value,\n    };\n  }\n  if (selector['@type'] === 'oa:FragmentSelector') {\n    return {\n      type: 'FragmentSelector',\n      value: selector.value,\n    };\n  }\n  if (selector['@type'] === 'oa:Choice') {\n    return [\n      upgradeSelector(selector.default) as Presentation3.Selector,\n      ...((Array.isArray(selector.item) ? selector.item : [selector.item]).map(\n        upgradeSelector\n      ) as Presentation3.Selector[]),\n    ];\n  }\n  if (selector['@type'] == 'iiif:ImageApiSelector') {\n    return {\n      type: 'ImageApiSelector',\n      region: 'region' in selector ? selector.region : undefined,\n      rotation: 'rotation' in selector ? selector.rotation : undefined,\n    };\n  }\n  throw new Error(`Unsupported selector type: ${selector['@type']}`);\n}\n","import { Traverse } from './traverse';\nimport {\n  Annotation,\n  AnnotationPage,\n  AnnotationPageNormalized,\n  Canvas,\n  CanvasNormalized,\n  Collection,\n  CollectionNormalized,\n  Manifest,\n  ManifestNormalized,\n  PolyEntity,\n  Range,\n  RangeNormalized,\n  Reference,\n  ResourceProvider,\n  ResourceProviderNormalized,\n} from '@iiif/presentation-3';\nimport {\n  EMPTY,\n  emptyAgent,\n  emptyAnnotationPage,\n  emptyCanvas,\n  emptyCollection,\n  emptyManifest,\n  emptyRange,\n} from './empty-types';\nimport { convertPresentation2 } from '../presentation-2';\nimport { NormalizedEntity } from './serialize';\n\nexport const defaultEntities = {\n  Collection: {},\n  Manifest: {},\n  Canvas: {},\n  AnnotationPage: {},\n  AnnotationCollection: {},\n  Annotation: {},\n  ContentResource: {},\n  Range: {},\n  Service: {},\n  Selector: {},\n  Agent: {},\n};\n\nexport function getDefaultEntities() {\n  return {\n    Collection: {},\n    Manifest: {},\n    Canvas: {},\n    AnnotationPage: {},\n    AnnotationCollection: {},\n    Annotation: {},\n    ContentResource: {},\n    Range: {},\n    Service: {},\n    Selector: {},\n    Agent: {},\n  };\n}\n\nfunction getResource(entityOrString: PolyEntity, type: string): Reference {\n  if (typeof entityOrString === 'string') {\n    return { id: entityOrString, type };\n  }\n  if (!entityOrString.id) {\n    throw new Error(`Invalid resource does not have an ID (${type})`);\n  }\n  return entityOrString as Reference;\n}\n\nfunction mapToEntities(entities: Record<string, Record<string, NormalizedEntity>>) {\n  return <T extends Reference | string>(type: string, defaultStringType?: string) => {\n    const storeType = entities[type] ? entities[type] : {};\n    return (r: T): T => {\n      const resource = getResource(r, defaultStringType || type);\n      if (resource && resource.id && type) {\n        storeType[resource.id] = storeType[resource.id]\n          ? (mergeEntities(storeType[resource.id], resource) as any)\n          : Object.assign({}, resource);\n        return {\n          id: resource.id,\n          type: type === 'ContentResource' ? type : resource.type,\n        } as T;\n      }\n      return resource as T;\n    };\n  };\n}\n\nfunction merge(existing: any, incoming: any): any {\n  if (!incoming) {\n    // Falsy values are ignored\n    return existing;\n  }\n  if (Array.isArray(existing)) {\n    if (!Array.isArray(incoming)) {\n      throw new Error('Cannot merge array with non-array');\n    }\n    // For arrays, we check if any of the incoming values are not already in the\n    // existing values and add them if this is not the case. If the incoming\n    // value is an entity that is already in the existing values, it will be\n    // merged with the existing value.\n    const merged = [...existing];\n    for (const item of incoming) {\n      if (item === null || item === undefined) {\n        continue;\n      }\n      if (Array.isArray(item)) {\n        // FIXME: How to handle this properly?\n        merged.push(item);\n      } else if (typeof item === 'object' && item.id && item.type) {\n        const existingIdx = merged.findIndex((e) => e.id === item.id && e.type === item.type);\n        if (existingIdx >= 0) {\n          merged[existingIdx] = merge(merged[existingIdx], item);\n        }\n      } else if (existing.indexOf(item) === -1) {\n        merged.push(item);\n      }\n    }\n    return merged;\n  } else if (typeof existing === 'object') {\n    if (Array.isArray(incoming) || typeof incoming !== 'object') {\n      throw new Error('Cannot merge object with non-object');\n    }\n    // For objects, we check the existing object for non-existing or \"empty\"\n    // properties and use the value from the incoming object for them\n    const merged = { ...existing };\n    for (const [key, val] of Object.entries(incoming)) {\n      const currentVal = merged[key];\n      if (currentVal === EMPTY || !currentVal) {\n        merged[key] = val;\n      } else {\n        merged[key] = merge(currentVal, val);\n      }\n    }\n    return merged;\n  } else if (existing) {\n    return existing;\n  }\n  return incoming;\n}\n\nexport function mergeEntities(existing: NormalizedEntity, incoming: any): NormalizedEntity {\n  if (typeof existing === 'string') {\n    return existing;\n  }\n  if (incoming.id !== (existing as any).id || incoming.type !== (existing as any).type) {\n    throw new Error('Can only merge entities with identical identifiers and type!');\n  }\n  return merge({ ...existing }, incoming);\n}\n\nfunction recordTypeInMapping(mapping: Record<string, string>) {\n  return <T extends Reference | string>(type: string, defaultStringType?: string) => {\n    return (r: T): T => {\n      const { id, type: foundType } = getResource(r, defaultStringType || type);\n      if (typeof id === 'undefined') {\n        throw new Error('Found invalid entity without an ID.');\n      }\n      if (type === 'ContentResource') {\n        mapping[id] = type;\n      } else {\n        mapping[id] = foundType as any;\n      }\n      return r;\n    };\n  };\n}\n\n/**\n * A string hashing function based on Daniel J. Bernstein's popular 'times 33' hash algorithm.\n * @author MatthewBarker <mrjbarker@hotmail.com>\n */\nfunction hash(object: any): string {\n  const text = JSON.stringify(object);\n\n  let numHash = 5381,\n    index = text.length;\n\n  while (index) {\n    numHash = (numHash * 33) ^ text.charCodeAt(--index);\n  }\n\n  const num = numHash >>> 0;\n\n  const hexString = num.toString(16);\n  if (hexString.length % 2) {\n    return '0' + hexString;\n  }\n  return hexString;\n}\n\nfunction addMissingIdToContentResource<T extends Partial<Reference>>(type: string) {\n  return (resource: T | string): T => {\n    if (typeof resource === 'string') {\n      return { id: resource, type } as T;\n    }\n    if (!resource.id) {\n      return { id: `vault://${hash(resource)}`, type, ...resource };\n    }\n    if (!resource.type) {\n      return { type, ...resource };\n    }\n    return resource;\n  };\n}\n\nfunction ensureDefaultFields<T, R>(defaultResource: R) {\n  return (resource: T): R => {\n    return {\n      ...defaultResource,\n      ...resource,\n    };\n  };\n}\n\nfunction ensureArray<T>(maybeArray: T | T[]): T[] {\n  if (Array.isArray(maybeArray)) {\n    return maybeArray;\n  }\n  return [maybeArray];\n}\n\nfunction ensureArrayOnAnnotation(annotation: Annotation): Annotation {\n  if (annotation.body) {\n    annotation.body = ensureArray(annotation.body);\n  }\n  if (annotation.seeAlso) {\n    annotation.seeAlso = ensureArray(annotation.seeAlso);\n  }\n  if (annotation.body) {\n    annotation.body = ensureArray(annotation.body);\n  }\n  if (annotation.audience) {\n    annotation.audience = ensureArray(annotation.audience);\n  }\n  if (annotation.accessibility) {\n    annotation.accessibility = ensureArray(annotation.accessibility);\n  }\n  if (annotation.motivation) {\n    annotation.motivation = ensureArray(annotation.motivation);\n  }\n\n  return annotation;\n}\n\nexport function normalize(unknownEntity: unknown) {\n  const entity = convertPresentation2(unknownEntity);\n  const entities = getDefaultEntities();\n  const mapping = {};\n  const addToEntities = mapToEntities(entities);\n  const addToMapping = recordTypeInMapping(mapping);\n\n  const traversal = new Traverse({\n    collection: [\n      ensureDefaultFields<Collection, CollectionNormalized>(emptyCollection),\n      addToMapping<Collection>('Collection'),\n      addToEntities<Collection>('Collection'),\n    ],\n    manifest: [\n      ensureDefaultFields<Manifest, ManifestNormalized>(emptyManifest),\n      addToMapping<Manifest>('Manifest'),\n      addToEntities<Manifest>('Manifest'),\n    ],\n    canvas: [\n      ensureDefaultFields<Canvas, CanvasNormalized>(emptyCanvas),\n      addToMapping<Canvas>('Canvas'),\n      addToEntities<Canvas>('Canvas'),\n    ],\n    annotationPage: [\n      addMissingIdToContentResource('AnnotationPage'),\n      ensureDefaultFields<AnnotationPage, AnnotationPageNormalized>(emptyAnnotationPage),\n      addToMapping<AnnotationPage>('AnnotationPage'),\n      addToEntities<AnnotationPage>('AnnotationPage'),\n    ],\n    annotation: [\n      // This won't be normalized before going into the state.\n      // It will be normalized through selectors and pattern matching.\n      addMissingIdToContentResource('Annotation'),\n      ensureArrayOnAnnotation,\n      addToMapping<Annotation>('Annotation'),\n      addToEntities<Annotation>('Annotation'),\n    ],\n    contentResource: [\n      // This won't be normalized before going into the state.\n      // It will be normalized through selectors and pattern matching.\n      addMissingIdToContentResource<any>('ContentResource'),\n      addToMapping<any>('ContentResource'),\n      addToEntities<any>('ContentResource'),\n    ],\n    range: [\n      // This will add a LOT to the state, maybe this will be configurable down the line.\n      ensureDefaultFields<Range, RangeNormalized>(emptyRange),\n      addToMapping<Range>('Range', 'Canvas'),\n      addToEntities<Range>('Range', 'Canvas'),\n    ],\n    agent: [\n      ensureDefaultFields<ResourceProvider, ResourceProviderNormalized>(emptyAgent),\n      addToMapping<ResourceProvider>('Agent'),\n      addToEntities<ResourceProvider>('Agent'),\n    ],\n    // Remove this, content resources are NOT usually processed by this library.\n    // They need to be available in full when they get passed down the chain.\n    // There may be a better way to preserve annotations and content resources.\n    // service: [\n    //   ensureDefaultFields<Service, ServiceNormalized>(emptyService),\n    //   addToMapping<Service>('Service'),\n    //   addToEntities<Service>('Service'),\n    // ],\n  });\n  const resource = traversal.traverseUnknown(entity) as Reference;\n\n  return { entities, resource, mapping };\n}\n","import {\n  AnnotationCollection,\n  AnnotationCollectionNormalized,\n  AnnotationNormalized,\n  AnnotationPageNormalized,\n  CanvasNormalized,\n  CollectionNormalized,\n  ContentResource,\n  ManifestNormalized,\n  RangeNormalized,\n  Reference,\n  Selector,\n  ServiceNormalized,\n  ResourceProviderNormalized\n} from '@iiif/presentation-3';\n\nexport const UNSET = '__$UNSET$__';\nexport const UNWRAP = '__$UNWRAP$__';\n\nexport type Field = any[];\n\nexport type CompatibleStore<T extends string = string> = {\n  requests: {\n    [url: string]: { resourceUri?: string } & any;\n  };\n  entities: {\n    [type in T]: {\n      [id: string]: NormalizedEntity;\n    };\n  };\n  mapping: {\n    [id: string]: T;\n  };\n};\n\nexport type NormalizedEntity =\n  | CollectionNormalized\n  | ManifestNormalized\n  | CanvasNormalized\n  | AnnotationPageNormalized\n  | AnnotationCollectionNormalized\n  | AnnotationCollection\n  | AnnotationNormalized\n  | ContentResource\n  | RangeNormalized\n  | ServiceNormalized\n  | Selector\n  | ResourceProviderNormalized;\n\ntype SerializerContext = {\n  isTopLevel?: boolean;\n};\n\nexport type Serializer<Type extends NormalizedEntity> = (\n  entity: Type,\n  state: any,\n  context: SerializerContext\n) => Generator<Reference | Reference[], typeof UNSET | Field[], any>;\n\nexport type SerializeConfig = {\n  Collection?: Serializer<CollectionNormalized>;\n  Manifest?: Serializer<ManifestNormalized>;\n  Canvas?: Serializer<CanvasNormalized>;\n  AnnotationPage?: Serializer<AnnotationPageNormalized>;\n  AnnotationCollection?: Serializer<AnnotationCollectionNormalized>;\n  Annotation?: Serializer<AnnotationNormalized>;\n  ContentResource?: Serializer<ContentResource>;\n  Range?: Serializer<RangeNormalized>;\n  Service?: Serializer<ServiceNormalized>;\n  Selector?: Serializer<Selector>;\n  Agent?: Serializer<ResourceProviderNormalized>;\n};\n\nfunction resolveIfExists<T extends NormalizedEntity>(state: CompatibleStore, url: string): T | undefined {\n  const request = state.requests[url];\n  // Return the resource.\n  const resourceType = state.mapping[url];\n  if (!resourceType || (request && request.resourceUri && !state.entities[resourceType][request.resourceUri])) {\n    // Continue refetching resource, this is an invalid state.\n    return undefined;\n  }\n  return state.entities[resourceType][request ? request.resourceUri : url] as T;\n}\n\nexport function serializedFieldsToObject<T>(fields: Field[] | [string]): T {\n  const object: any = {};\n\n  for (const [key, value] of fields) {\n    if (key === UNWRAP && value !== UNSET) {\n      return value as T;\n    }\n    if (value !== UNSET && typeof value !== 'undefined' && value !== null) {\n      object[key] = value;\n    }\n  }\n\n  return object as T;\n}\n\nexport function serialize<Return>(state: CompatibleStore, subject: Reference, config: SerializeConfig): Return {\n  if (!subject.type || !subject.id) {\n    throw new Error('Unknown entity');\n  }\n\n  if (!config[subject.type as keyof SerializeConfig]) {\n    throw new Error(`Serializer not found for ${subject.type}`);\n  }\n\n  function flatten(sub: Reference) {\n    const generator = config[sub.type as keyof SerializeConfig];\n    if (!generator) {\n      return UNSET;\n    }\n\n    const resource = resolveIfExists(state, sub.id) || (sub.id && sub.type ? sub : null);\n    if (!resource) {\n      return UNSET;\n    }\n    const iterator = generator(resource as any, state, { isTopLevel: subject.id === sub.id });\n    let current = iterator.next();\n    while (!current.done) {\n      const requestToHydrate: Reference | Reference[] = current.value as any;\n      let next: any = UNSET;\n\n      if (requestToHydrate) {\n        if (Array.isArray(requestToHydrate)) {\n          const nextList: any[] = [];\n          for (const req of requestToHydrate) {\n            nextList.push(flatten(req));\n          }\n          next = nextList;\n        } else {\n          next = flatten(requestToHydrate);\n        }\n      }\n      current = iterator.next(next);\n    }\n\n    if (current.value === UNSET) {\n      return UNSET;\n    }\n\n    return serializedFieldsToObject(current.value);\n  }\n\n  return flatten(subject) as Return;\n}\n","import { SerializeConfig } from './serialize';\nimport {\n  DescriptiveNormalized,\n  InternationalString,\n  LinkingNormalized,\n  TechnicalProperties,\n} from '@iiif/presentation-3';\nimport * as Presentation2 from '@iiif/presentation-2';\n\nexport function languageString2to3(\n  value: InternationalString | null | undefined\n): Presentation2.LanguageProperty | Presentation2.LanguageProperty[] | undefined {\n  if (!value) {\n    return undefined;\n  }\n\n  const languages = Object.keys(value);\n\n  if (languages.length === 0) {\n    return undefined;\n  }\n\n  // If there is only one, then return it as a string.\n  if (languages.length === 1) {\n    const language = languages[0];\n    if (!language) {\n      return '';\n    }\n\n    const singleValue = (value[language] || []).join('');\n\n    if (language === '@none' || language === 'none' || language === 'en') {\n      return singleValue;\n    }\n\n    return {\n      '@language': language,\n      '@value': singleValue,\n    };\n  }\n\n  return languages.map((language) => {\n    return {\n      '@language': language,\n      '@value': (value[language] || []).join(''),\n    };\n  });\n}\n\nfunction parseCanvasTarget(target: any): any {\n  if (Array.isArray(target)) {\n    return target.map((t) => parseCanvasTarget(t));\n  }\n\n  if (typeof target === 'string') {\n    return target;\n  }\n\n  if (target.type && target.type === 'Canvas') {\n    return target.id;\n  }\n\n  return target;\n}\n\nfunction unNestArray<T>(oneOrArray: T[] | undefined, onlyOne = false): T | T[] | undefined {\n  if (!oneOrArray) {\n    return undefined;\n  }\n\n  if (oneOrArray.length > 1 && !onlyOne) {\n    return oneOrArray;\n  }\n  return oneOrArray[0] || undefined;\n}\n\nfunction convertService(service: any) {\n  if (!service) {\n    return undefined;\n  }\n\n  if (typeof service === 'string') {\n    return {\n      '@id': service,\n    };\n  }\n\n  if ('@id' in service) {\n    const newService = { ...service };\n    delete newService['@type'];\n    return newService;\n  }\n\n  // @todo support auth.\n  return {\n    '@context': 'http://iiif.io/api/image/2/context.json',\n    '@id': service.id,\n    profile: `http://iiif.io/api/image/2/profiles/${service.profile}.json`,\n  };\n}\n\nfunction technicalProperties(props: Partial<TechnicalProperties>, type?: string) {\n  return [\n    ['@id', props.id],\n    ['@type', type],\n    ['format', props.format],\n    ['height', props.height],\n    ['width', props.width],\n    ['viewingDirection', props.viewingDirection !== 'left-to-right' ? props.viewingDirection : undefined],\n    // @todo Viewing hint is merged with behavior\n    // ['viewingHint', props.]\n  ];\n}\n\nfunction* descriptiveProperties(prop: Partial<DescriptiveNormalized>): Generator<any, any, any> {\n  const provider = prop.provider ? yield prop.provider[0] : undefined;\n\n  return [\n    ['label', languageString2to3(prop.label)],\n    [\n      'metadata',\n      prop.metadata && prop.metadata.length\n        ? prop.metadata.map((item) => ({\n            label: languageString2to3(item.label) || '',\n            value: languageString2to3(item.value) || '',\n          }))\n        : undefined,\n    ],\n    ['description', languageString2to3(prop.summary)],\n    ['thumbnail', unNestArray(yield prop.thumbnail)],\n    ['navDate', prop.navDate],\n    // @todo these needs consideration if the way provider is parsed changes.\n    ['logo', provider ? unNestArray(provider.logo) : undefined],\n    ['homepage', provider ? provider.homepage : undefined],\n    ['attribution', prop.requiredStatement ? languageString2to3(prop.requiredStatement.value) : undefined],\n  ];\n}\n\nfunction* linkingProperties(prop: Partial<LinkingNormalized>) {\n  return [\n    ['seeAlso', unNestArray(yield prop.seeAlso)],\n    // @todo support more services (like auth)\n    ['service', unNestArray((prop.service || []).map(convertService))],\n    ['rendering', unNestArray(yield prop.rendering)],\n    // @todo part of to within\n    // ['within', unNestArray(yield prop.partOf)],\n    // @todo this may not work completely.\n    ['startCanvas', prop.start ? prop.start.id : undefined],\n  ];\n}\n\nexport const serializeConfigPresentation2: SerializeConfig = {\n  Manifest: function* (entity) {\n    return [\n      ...technicalProperties(entity, 'sc:Manifest'),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      // Structural.\n      // @todo structures\n      [\n        'sequences',\n        [\n          {\n            '@id': `${entity.id}/sequence0`,\n            '@type': 'sc:Sequence',\n            canvases: yield entity.items,\n          },\n        ],\n      ],\n      ['structures', yield entity.structures],\n    ];\n  },\n\n  Canvas: function* (entity) {\n    const paintingPage = yield entity.items;\n    const resources = paintingPage[0];\n    return [\n      // Items.\n      ...technicalProperties(entity, 'sc:Canvas'),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['images', resources ? [resources.resources] : undefined],\n      [\n        'annotations',\n        entity.annotations && entity.annotations.length ? unNestArray(yield entity.annotations) : undefined,\n      ],\n    ];\n  },\n\n  AnnotationPage: function* (entity) {\n    return [\n      ...technicalProperties(entity, 'sc:AnnotationList'),\n      ...(yield* descriptiveProperties(entity)),\n      ['resources', entity.items && entity.items.length ? unNestArray(yield entity.items) : undefined],\n    ];\n  },\n\n  Annotation: function* (entity) {\n    return [\n      ['@id', entity.id],\n      ['@type', 'oa:Annotation'],\n      // This could be improved.\n      ['motivation', 'sc:painting'],\n      ['on', parseCanvasTarget(entity.target)],\n      ['resource', unNestArray(yield entity.body, true)],\n    ];\n  },\n\n  ContentResource: function* (entity: any) {\n    switch (entity.type) {\n      case 'Image':\n        return [\n          // Image properties.\n          ...technicalProperties(entity, 'dctypes:Image'),\n          ...(yield* descriptiveProperties(entity)),\n          ...(yield* linkingProperties(entity)),\n        ];\n      case 'Text':\n      case 'Dataset':\n      default:\n        return [...technicalProperties(entity, undefined), ...(yield* descriptiveProperties(entity))];\n    }\n  },\n\n  AnnotationCollection: function* (entity) {\n    return [\n      // @todo expand properties if they are actually used.\n      ['@id', entity.id],\n      ['@type', 'sc:Layer'],\n      ['label', languageString2to3(entity.label)],\n    ];\n  },\n\n  Collection: function* (entity) {\n    return [\n      ...technicalProperties(entity, 'sc:Collection'),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['members', yield* entity.items],\n    ];\n  },\n\n  Range: function* (entity) {\n    const members = [];\n    const canvases = [];\n\n    if (entity.items) {\n      for (const item of entity.items) {\n        const canvas = yield item;\n        members.push({\n          '@id': item.id,\n          '@type': item.type,\n          label: canvas ? canvas.label : undefined,\n          within: entity.id,\n        });\n        if (item.type === 'Canvas') {\n          canvases.push(item.id);\n        }\n      }\n    }\n\n    return [\n      ...technicalProperties(entity, 'sc:Range'),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['canvases', canvases.length === members.length ? canvases : undefined],\n      ['members', canvases.length !== members.length ? members : undefined],\n    ];\n  },\n};\n","import { SerializeConfig, UNWRAP } from './serialize';\nimport {\n  DescriptiveNormalized,\n  ImageService2,\n  ImageService3,\n  LinkingNormalized,\n  TechnicalProperties,\n} from '@iiif/presentation-3';\n\nfunction technicalProperties(entity: Partial<TechnicalProperties>): Array<[keyof TechnicalProperties, any]> {\n  return [\n    // Technical\n    ['id', !entity.id?.startsWith('vault://') ? entity.id : undefined],\n    ['type', entity.type],\n    ['format', entity.format],\n    ['profile', entity.profile],\n    ['height', entity.height],\n    ['width', entity.width],\n    ['duration', entity.duration || undefined],\n    ['viewingDirection', entity.viewingDirection !== 'left-to-right' ? entity.viewingDirection : undefined],\n    ['behavior', entity.behavior && entity.behavior.length ? entity.behavior : undefined],\n    ['timeMode', entity.timeMode],\n    ['motivation', Array.isArray(entity.motivation) ? entity.motivation[0] : entity.motivation],\n  ];\n}\n\nfunction filterEmpty<T>(item?: T[]): T[] | undefined {\n  if (!item || item.length === 0) {\n    return undefined;\n  }\n  return item;\n}\n\nfunction service2compat(service: ImageService3): ImageService2 | ImageService3 {\n  if (service && service.type && service.type === 'ImageService2') {\n    const { id, type, profile: _profile, ..._service } = service as any;\n\n    const profile =\n      typeof _profile === 'string'\n        ? _profile\n        : Array.isArray(_profile)\n        ? _profile.find((p) => typeof p === 'string')\n        : '';\n\n    return {\n      '@id': id,\n      '@type': type,\n      profile: profile\n        ? profile.startsWith('http')\n          ? profile\n          : `http://iiif.io/api/image/2/${profile}.json`\n        : 'http://iiif.io/api/image/2/level0.json',\n      ..._service,\n    } as any;\n  }\n\n  return service;\n}\n\nfunction filterService2Compat(services?: any[]) {\n  if (!services || services.length === 0) {\n    return undefined;\n  }\n\n  return (services as any[]).map(service2compat);\n}\n\nfunction* descriptiveProperties(\n  entity: Partial<DescriptiveNormalized>\n): Generator<any, any, Array<[keyof DescriptiveNormalized, any]>> {\n  return [\n    ['label', entity.label],\n    ['metadata', filterEmpty(entity.metadata)],\n    ['summary', entity.summary],\n    ['requiredStatement', entity.requiredStatement],\n    ['rights', entity.rights],\n    ['navDate', entity.navDate],\n    ['language', entity.language],\n    // We yield these fully as they are embedded in here.\n    ['thumbnail', filterEmpty(yield entity.thumbnail)],\n    ['placeholderCanvas', yield entity.placeholderCanvas],\n    ['accompanyingCanvas', yield entity.accompanyingCanvas],\n\n    // @todo need to test this one.\n    ['provider', filterEmpty(yield entity.provider)],\n  ];\n}\n\nfunction* linkingProperties(\n  entity: Partial<LinkingNormalized>\n): Generator<any, any, Array<[keyof LinkingNormalized, any]>> {\n  return [\n    ['seeAlso', filterEmpty(yield entity.seeAlso)],\n    ['service', filterService2Compat(entity.service)],\n    ['services', filterService2Compat(entity.services)],\n    ['rendering', filterEmpty(yield entity.rendering)],\n    ['supplementary', filterEmpty(yield entity.supplementary)],\n    ['homepage', filterEmpty(yield entity.homepage)],\n    ['logo', filterEmpty(yield entity.logo)],\n\n    // Don't yield these, they are references.\n    ['partOf', filterEmpty(yield entity.partOf)],\n    ['start', entity.start],\n  ];\n}\n\nexport const serializeConfigPresentation3: SerializeConfig = {\n  Manifest: function* (entity, state, { isTopLevel }) {\n    if (!isTopLevel) {\n      return [\n        // Only a snippet.\n        ...technicalProperties(entity),\n        ...(yield* descriptiveProperties(entity)),\n      ];\n    }\n\n    return [\n      ['@context', 'http://iiif.io/api/presentation/3/context.json'],\n      ...technicalProperties(entity),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['items', yield entity.items],\n      ['structures', filterEmpty(yield entity.structures)],\n      ['annotations', filterEmpty(yield entity.annotations)],\n    ];\n  },\n\n  Canvas: function* (entity) {\n    return [\n      // Items.\n      ...technicalProperties(entity),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['items', yield entity.items],\n      ['annotations', filterEmpty(yield entity.annotations)],\n    ];\n  },\n\n  Agent: function* (entity) {\n    return [\n      //\n      ['id', entity.id],\n      ['type', 'Agent'],\n      ['label', entity.label],\n      ...(yield* linkingProperties(entity as any)),\n    ];\n  },\n\n  AnnotationPage: function* (entity) {\n    const entries = Object.entries(entity)\n      .map(([key, item]) => {\n        return [key, Array.isArray(item) ? filterEmpty(item as any) : item];\n      })\n      .filter(([key, value]) => {\n        return key !== 'items';\n      });\n\n    return [\n      // Any more properties?\n      ...entries,\n      ...(yield* linkingProperties(entity)),\n      ['items', yield entity.items],\n    ];\n  },\n\n  Service: function* (entity) {\n    // Are there other properties on a service?\n    return [[UNWRAP, service2compat(entity as any)]];\n  },\n\n  Annotation: function* (entity) {\n    const entries = Object.entries(entity)\n      .map(([key, item]) => {\n        if (key === 'motivation') {\n          // Annotation non-array items can be added here.\n          return [key, Array.isArray(item) ? item[0] : item];\n        }\n\n        return [key, Array.isArray(item) ? filterEmpty(item as any) : item];\n      })\n      .filter(([key]) => {\n        return key !== 'body';\n      });\n\n    const resolvedBody = yield entity.body;\n\n    return [...entries, ['body', resolvedBody.length === 1 ? resolvedBody[0] : resolvedBody]];\n  },\n\n  ContentResource: function* (entity: any) {\n    return [\n      // Image properties.\n      ...technicalProperties(entity),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['annotations', filterEmpty(yield entity.annotations)],\n      ['items', filterEmpty(yield entity.items)],\n    ];\n  },\n\n  AnnotationCollection: function* (entity) {\n    return [\n      // @todo expand properties if they are actually used.\n      ['id', entity.id],\n      ['type', 'AnnotationCollection'],\n      ['label', entity.label],\n    ];\n  },\n\n  Collection: function* (entity, state, { isTopLevel }) {\n    if (isTopLevel) {\n      return [\n        ['@context', 'http://iiif.io/api/presentation/3/context.json'],\n        ...technicalProperties(entity),\n        ...(yield* descriptiveProperties(entity)),\n        ...(yield* linkingProperties(entity)),\n        ['items', filterEmpty(yield entity.items)],\n      ];\n    }\n    return [...technicalProperties(entity), ...(yield* descriptiveProperties(entity))];\n  },\n\n  Range: function* (entity) {\n    const rangeItems = [];\n\n    for (const item of entity.items) {\n      if (item.type === 'Range') {\n        // Resolve the full range\n        rangeItems.push(yield item);\n      } else {\n        // Just push the reference.\n        // @todo could also push in the label of the item?\n        rangeItems.push(item);\n      }\n    }\n\n    return [\n      ...technicalProperties(entity),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['items', rangeItems],\n      ['annotations', filterEmpty(yield entity.annotations)],\n    ];\n  },\n};\n"],"names":["EMPTY","Object","freeze","emptyAnnotation","id","type","behavior","label","thumbnail","summary","requiredStatement","metadata","seeAlso","homepage","logo","rendering","service","accessibility","audience","body","bodyValue","canonical","created","creator","generated","generator","modified","motivation","rights","stylesheet","target","timeMode","via","partOf","emptyAnnotationPage","provider","items","emptyCanvas","posterCanvas","accompanyingCanvas","placeholderCanvas","navDate","annotations","duration","height","width","emptyCollection","viewingDirection","services","emptyManifest","start","structures","emptyRange","supplementary","emptyAgent","ensureArray","maybeArray","Array","isArray","types","identifyResource","resource","Error","hasType","indexOf","profile","Traverse","constructor","traversals","options","__publicField","this","collection","manifest","canvas","annotationCollection","annotationPage","annotation","contentResource","choice","range","agent","allowUndefinedReturn","static","traversal","traverseDescriptive","map","traverseType","traverseAgent","traverseLinking","content","traverseCollectionItems","collectionOrManifest","traverseCollection","traverseManifest","traverseInlineAnnotationPages","traversePosterCanvas","traverseManifestItems","traverseCanvas","traverseManifestStructures","traverseRange","traverseCanvasItems","traverseAnnotationPage","traverseAnnotationPageItems","traverseAnnotation","annotationPageJson","traverseAnnotationBody","annotationBody","traverseContentResource","json","annotationJson","traverseContentResourceLinking","contentResourceJson","choiceItem","traverseRangeRanges","rangeOrManifest","object","reduce","acc","returnValue","traverseService","traverseUnknown","annotationList","sequence","layer","convertPropsToArray","mergeMemberProperties","members","manifests","collections","subCollection","member","sequences","traverseSequence","structure","traverseSequenceItems","canvases","images","image","otherContent","traverseAnnotationList","traverseRangeItems","ranges","innerRange","length","list","traverseAnnotationListItems","resources","traverseAnnotationItems","res","on","traverseLayer","traverseLayerItems","traverseChoice","traverseChoiceItems","default","item","format","traverseImageResource","wasArray","resourceList","newResourceList","singleResource","push","traverseOneOrMoreServices","allServices","newServices","related","traverseOneOrManyType","within","startCanvas","contentLayer","singleObj","level1Support","imageServiceProfiles","configuration","convertLanguageMapping","inputLangProperty","defaultLang","arrayOfValues","languageMap","language","lang","getProfile","find","s","removePrefix","str","prefix","startsWith","slice","knownTypes","getNewType","oldType","context","possibleType","inputProfile","getTypeFromProfile","inputContexts","contexts","getTypeFromContext","endsWith","licenseRegex","extractLicense","license","matches","match","removeContexts","fixContext","inputContext","newContexts","removeUndefinedProperties","obj","prop","mintedIdCounter","mintNewIdFromResource","subresource","origId","encodeURI","trim","technicalProperties","allBehaviours","viewingHint","descriptiveProperties","extraMetadata","licenseLabel","licenseList","rawLicense","singleLicense","value","fixLicense","allMetadata","attribution","description","parseWithin","withinProperties","returnPartOf","linkingProperties","upgradeContentResource","inputContentResource","chars","presentation2to3","allCanvases","technical","upgradeTarget","source","full","selector","upgradeSelector","additionalProps","newService","includes","region","rotation","getDefaultEntities","Collection","Manifest","Canvas","AnnotationPage","AnnotationCollection","Annotation","ContentResource","Range","Service","Selector","Agent","getResource","entityOrString","merge","existing","incoming","merged","existingIdx","findIndex","e","key","val","entries","currentVal","mergeEntities","hash","text","JSON","stringify","numHash","index","charCodeAt","hexString","toString","addMissingIdToContentResource","ensureDefaultFields","defaultResource","ensureArrayOnAnnotation","UNSET","UNWRAP","serializedFieldsToObject","fields","languageString2to3","languages","keys","singleValue","join","parseCanvasTarget","t","unNestArray","oneOrArray","onlyOne","convertService","props","serializeConfigPresentation2","entity","_a","filterEmpty","service2compat","_profile","_service","p","filterService2Compat","serializeConfigPresentation3","state","isTopLevel","filter","resolvedBody","rangeItems","unknownEntity","convertPresentation2","entities","mapping","addToEntities","defaultStringType","storeType","r","assign","mapToEntities","addToMapping","foundType","recordTypeInMapping","subject","config","flatten","sub","url","request","requests","resourceType","resourceUri","resolveIfExists","iterator","current","next","done","requestToHydrate","nextList","req"],"mappings":"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"}