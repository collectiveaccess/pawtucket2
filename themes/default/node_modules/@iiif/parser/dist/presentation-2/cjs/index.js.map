{"version":3,"file":"index.js","sources":["../../../src/presentation-2/traverse.ts","../../../src/shared/image-api-profiles.ts","../../../src/presentation-2/upgrader.ts","../../../src/shared/ensure-array.ts"],"sourcesContent":["import {\n  Annotation,\n  AnnotationList,\n  Canvas,\n  ChoiceEmbeddedContent,\n  Collection,\n  CommonContentResource,\n  ContentResource,\n  DescriptiveProperties,\n  Layer,\n  LinkingProperties,\n  Manifest,\n  OneOrMany,\n  Range,\n  RightsProperties,\n  Sequence,\n  Service,\n  TraversableEntityTypes,\n  Traversal,\n  TraversalMap,\n} from '@iiif/presentation-2';\n\nexport const types: TraversableEntityTypes[] = [\n  'sc:Collection',\n  'sc:Manifest',\n  'sc:Canvas',\n  'sc:AnnotationList',\n  'oa:Annotation',\n  'sc:Range',\n  'sc:Layer',\n  'sc:Sequence',\n  'oa:Choice',\n  // Opaque.\n  'Service',\n  'ContentResource',\n];\n\nexport type TraverseOptions = {\n  convertPropsToArray: boolean;\n  mergeMemberProperties: boolean;\n  allowUndefinedReturn: boolean;\n};\n\nexport function identifyResource(resource: any): TraversableEntityTypes {\n  if (typeof resource === 'undefined' || resource === null) {\n    throw new Error('Null or undefined is not a valid entity.');\n  }\n  if (Array.isArray(resource)) {\n    throw new Error('Array is not a valid entity');\n  }\n  if (typeof resource !== 'object') {\n    throw new Error(`${typeof resource} is not a valid entity`);\n  }\n\n  if (typeof resource['@type'] === 'string') {\n    const hasType = types.indexOf(resource['@type'] as any);\n    if (hasType !== -1) {\n      return types[hasType];\n    }\n  }\n\n  if (resource.profile) {\n    return 'Service';\n  }\n\n  if (resource.format) {\n    return 'ContentResource';\n  }\n\n  // Big o'l fallback.\n  if (resource['@type']) {\n    return 'ContentResource';\n  }\n\n  throw new Error('Resource type is not known');\n}\n\nexport class Traverse<\n  T extends {\n    Collection: any;\n    Manifest: any;\n    Canvas: any;\n    AnnotationList: any;\n    Sequence: any;\n    Annotation: any;\n    ContentResource: any;\n    Choice: any;\n    Range: any;\n    Service: any;\n    Layer: any;\n  } = {\n    Collection: Collection;\n    Manifest: Manifest;\n    Canvas: Canvas;\n    AnnotationList: AnnotationList;\n    Sequence: Sequence;\n    Annotation: Annotation;\n    ContentResource: CommonContentResource;\n    Choice: ChoiceEmbeddedContent;\n    Range: Range;\n    Service: Service;\n    Layer: Layer;\n  }\n> {\n  private traversals: Required<TraversalMap>;\n  private options: TraverseOptions;\n\n  constructor(traversals: Partial<TraversalMap>, options: Partial<TraverseOptions> = {}) {\n    this.traversals = {\n      collection: [],\n      manifest: [],\n      canvas: [],\n      annotationList: [],\n      sequence: [],\n      annotation: [],\n      contentResource: [],\n      choice: [],\n      range: [],\n      service: [],\n      layer: [],\n      ...traversals,\n    };\n    this.options = {\n      convertPropsToArray: true,\n      mergeMemberProperties: true,\n      allowUndefinedReturn: false,\n      ...options,\n    };\n  }\n\n  static all(traversal: (resource: any) => any) {\n    return new Traverse({\n      collection: [traversal],\n      manifest: [traversal],\n      canvas: [traversal],\n      annotationList: [traversal],\n      sequence: [traversal],\n      annotation: [traversal],\n      contentResource: [traversal],\n      choice: [traversal],\n      range: [traversal],\n      service: [traversal],\n      layer: [traversal],\n    });\n  }\n\n  traverseCollection(collection: Collection): T['Collection'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseCollectionItems(collection))),\n      this.traversals.collection\n    );\n  }\n\n  traverseCollectionItems(collection: Collection): Collection {\n    if (this.options.mergeMemberProperties) {\n      const members = [\n        ...(collection.manifests || []).map((manifest) => {\n          if (typeof manifest === 'string') {\n            return { '@id': manifest, '@type': 'sc:Manifest' };\n          }\n          return manifest;\n        }),\n        ...(collection.collections || []).map((subCollection) => {\n          if (typeof subCollection === 'string') {\n            return { '@id': subCollection, '@type': 'sc:Collection' };\n          }\n          return subCollection;\n        }),\n        ...(collection.members || []),\n      ];\n\n      delete collection.collections;\n      delete collection.manifests;\n      collection.members = members;\n    }\n\n    if (collection.manifests) {\n      collection.manifests = collection.manifests.map((manifest) =>\n        this.traverseManifest(\n          typeof manifest === 'string'\n            ? ({ '@id': manifest, '@type': 'sc:Manifest' } as Manifest)\n            : (manifest as Manifest)\n        )\n      );\n    }\n\n    if (collection.collections) {\n      collection.collections = collection.collections.map((subCollection) =>\n        this.traverseCollection(\n          typeof subCollection === 'string'\n            ? ({ '@id': subCollection, '@type': 'sc:Collection' } as Collection)\n            : (subCollection as Collection)\n        )\n      );\n    }\n\n    if (collection.members) {\n      collection.members = collection.members.map((member) => {\n        if (typeof member === 'string') {\n          return member;\n        }\n        return this.traverseUnknown(member);\n      });\n    }\n\n    return collection;\n  }\n\n  traverseManifest(manifest: Manifest): T['Manifest'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(manifest))),\n      this.traversals.manifest\n    );\n  }\n\n  traverseManifestItems(manifest: Manifest): Manifest {\n    if (manifest.sequences) {\n      manifest.sequences = manifest.sequences.map((sequence) => this.traverseSequence(sequence));\n    }\n    if (manifest.structures) {\n      manifest.structures = manifest.structures.map((structure) => this.traverseRange(structure));\n    }\n    return manifest;\n  }\n\n  traverseSequence(sequence: Sequence): T['Sequence'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseSequenceItems(sequence))),\n      this.traversals.sequence\n    );\n  }\n\n  traverseSequenceItems(sequence: Sequence): Sequence {\n    if (sequence.canvases) {\n      sequence.canvases = sequence.canvases.map((canvas) => this.traverseCanvas(canvas));\n    }\n    return sequence;\n  }\n\n  traverseCanvas(canvas: Canvas): T['Canvas'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(canvas))),\n      this.traversals.canvas\n    );\n  }\n\n  traverseCanvasItems(canvas: Canvas): Canvas {\n    if (canvas.images) {\n      canvas.images = canvas.images.map((image) => this.traverseAnnotation(image));\n    }\n    if (canvas.otherContent) {\n      canvas.otherContent = canvas.otherContent.map((annotationList) => this.traverseAnnotationList(annotationList));\n    }\n    return canvas;\n  }\n\n  traverseRange(range: Range): T['Range'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseRangeItems(range))),\n      this.traversals.range\n    );\n  }\n\n  traverseRangeItems(range: Range): Range {\n    if (this.options.mergeMemberProperties) {\n      const members = [\n        ...(range.ranges || []).map((innerRange: any) => {\n          if (typeof innerRange === 'string') {\n            return { '@id': innerRange, '@type': 'sc:Range' };\n          }\n          return innerRange;\n        }),\n        ...(range.canvases || []).map((canvas: any) => {\n          if (typeof canvas === 'string') {\n            return { '@id': canvas, '@type': 'sc:Canvas' };\n          }\n          return canvas;\n        }),\n        ...(range.members || []),\n      ];\n\n      delete range.ranges;\n      delete range.canvases;\n      range.members = members.length ? members.map((member) => this.traverseUnknown(member)) : undefined;\n    }\n    return range;\n  }\n\n  traverseAnnotationList(annotationList: AnnotationList): T['AnnotationList'] {\n    const list =\n      typeof annotationList === 'string'\n        ? ({ '@id': annotationList, '@type': 'sc:AnnotationList' } as any)\n        : annotationList;\n\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseAnnotationListItems(list)),\n      this.traversals.annotationList\n    );\n  }\n\n  traverseAnnotationListItems(annotationList: AnnotationList): AnnotationList {\n    if (annotationList.resources) {\n      annotationList.resources = annotationList.resources.map((annotation) => this.traverseAnnotation(annotation));\n    }\n\n    return annotationList;\n  }\n\n  traverseAnnotation(annotation: Annotation): T['Annotation'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationItems(annotation))),\n      this.traversals.annotation\n    );\n  }\n\n  traverseAnnotationItems(annotation: Annotation): Annotation {\n    if (annotation.resource) {\n      if (Array.isArray(annotation.resource)) {\n        annotation.resource = annotation.resource.map((res) =>\n          this.traverseContentResource(res as CommonContentResource)\n        );\n      } else {\n        annotation.resource = this.traverseContentResource(annotation.resource as CommonContentResource);\n      }\n    }\n\n    if (annotation.on) {\n      // selector - just traverse the annotations.\n      // annotation.on = this.traverseSelector(annotation.on);\n    }\n\n    return annotation;\n  }\n\n  traverseLayer(layer: Layer): T['Layer'] {\n    return this.traverseType(this.traverseLinking(this.traverseLayerItems(layer)), this.traversals.layer);\n  }\n\n  traverseLayerItems(layer: Layer): Layer {\n    if (layer.otherContent) {\n      layer.otherContent = layer.otherContent.map((annotationList) => this.traverseAnnotationList(annotationList));\n    }\n    return layer;\n  }\n\n  traverseChoice(choice: ChoiceEmbeddedContent): T['Choice'] {\n    return this.traverseType(this.traverseChoiceItems(choice), this.traversals.choice);\n  }\n\n  traverseChoiceItems(choice: ChoiceEmbeddedContent) {\n    if (choice.default && choice.default !== 'rdf:nil') {\n      choice.default = this.traverseContentResource(choice.default);\n    }\n    if (choice.item && choice.item !== 'rdf:nil') {\n      choice.item = choice.item.map((item) => this.traverseContentResource(item));\n    }\n\n    return choice;\n  }\n\n  traverseService(service: Service): T['Service'] {\n    return this.traverseType(this.traverseLinking(service as any), this.traversals.service);\n  }\n\n  traverseContentResource(contentResource: CommonContentResource): T['ContentResource'] {\n    if (contentResource['@type'] === 'oa:Choice') {\n      return this.traverseChoice(contentResource as any);\n    }\n\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(contentResource as any)),\n      this.traversals.contentResource\n    );\n  }\n\n  traverseUnknown(item: any) {\n    if (!item['@type'] || typeof item === 'string') {\n      // Unknown item.\n      return item;\n    }\n    switch (identifyResource(item)) {\n      case 'sc:Collection':\n        return this.traverseCollection(item);\n      case 'sc:Manifest':\n        return this.traverseManifest(item);\n      case 'sc:Canvas':\n        return this.traverseCanvas(item);\n      case 'sc:Sequence':\n        return this.traverseSequence(item);\n      case 'sc:Range':\n        return this.traverseRange(item);\n      case 'oa:Annotation':\n        return this.traverseAnnotation(item);\n      case 'sc:AnnotationList':\n        return this.traverseAnnotationList(item);\n      case 'sc:Layer':\n        return this.traverseLayer(item);\n      case 'Service':\n        return this.traverseService(item);\n      case 'oa:Choice':\n        return this.traverseChoice(item);\n      case 'ContentResource':\n        return this.traverseContentResource(item);\n    }\n\n    if (item.profile) {\n      return this.traverseService(item);\n    }\n\n    return item;\n  }\n\n  traverseImageResource(contentResource: OneOrMany<string | ContentResource>) {\n    const wasArray = Array.isArray(contentResource);\n    const resourceList = Array.isArray(contentResource) ? contentResource : [contentResource];\n    const newResourceList: any[] = [];\n\n    for (const singleResource of resourceList) {\n      if (typeof singleResource === 'string') {\n        newResourceList.push(\n          this.traverseContentResource({\n            '@id': singleResource,\n            '@type': 'dctypes:Image',\n          })\n        );\n      } else {\n        newResourceList.push(this.traverseContentResource(singleResource as any));\n      }\n    }\n\n    if (!wasArray && !this.options.convertPropsToArray) {\n      return newResourceList[0];\n    }\n\n    return newResourceList;\n  }\n\n  traverseDescriptive<T extends Partial<DescriptiveProperties & RightsProperties>>(resource: T) {\n    if (resource.thumbnail) {\n      resource.thumbnail = this.traverseImageResource(resource.thumbnail);\n    }\n\n    if (resource.logo) {\n      resource.logo = this.traverseImageResource(resource.logo);\n    }\n\n    return resource;\n  }\n\n  traverseOneOrMoreServices(allServices: OneOrMany<any>) {\n    const wasArray = Array.isArray(allServices);\n    const services = Array.isArray(allServices) ? allServices : [allServices];\n    const newServices = [];\n    for (const service of services) {\n      newServices.push(this.traverseService(service));\n    }\n\n    if (!wasArray && !this.options.convertPropsToArray) {\n      return newServices[0];\n    }\n\n    return newServices;\n  }\n\n  traverseLinking<T extends Partial<LinkingProperties>>(resource: T) {\n    if (resource.related) {\n      resource.related = this.traverseOneOrManyType(resource.related, this.traversals.contentResource);\n    }\n    if (resource.rendering) {\n      resource.rendering = this.traverseOneOrManyType(resource.rendering, this.traversals.contentResource);\n    }\n    if (resource.service) {\n      resource.service = this.traverseOneOrMoreServices(resource.service);\n    }\n    if (resource.seeAlso) {\n      resource.seeAlso = this.traverseOneOrManyType(resource.seeAlso, this.traversals.contentResource);\n    }\n    if (resource.within) {\n      if (typeof resource.within === 'string') {\n        // I don't know. skip?\n      } else {\n        resource.within = this.traverseOneOrManyType(\n          resource.within as CommonContentResource,\n          this.traversals.contentResource\n        );\n      }\n    }\n    if (resource.startCanvas) {\n      if (typeof resource.startCanvas === 'string') {\n        resource.startCanvas = this.traverseType(\n          { '@id': resource.startCanvas, '@type': 'sc:Canvas' } as Canvas,\n          this.traversals.canvas\n        );\n      } else if (resource.startCanvas) {\n        this.traverseType(resource.startCanvas as any, this.traversals.canvas);\n      }\n    }\n    if (resource.contentLayer) {\n      if (typeof resource.contentLayer === 'string') {\n        resource.contentLayer = this.traverseLayer({\n          '@id': resource.contentLayer,\n          '@type': 'sc:Layer',\n        });\n      } else {\n        resource.contentLayer = this.traverseLayer(resource.contentLayer);\n      }\n    }\n    return resource;\n  }\n\n  traverseOneOrManyType<T, Return = T>(object: T | T[], traversals: Array<Traversal<T>>): Return {\n    if (!Array.isArray(object)) {\n      if (this.options.convertPropsToArray) {\n        object = [object] as T[];\n      } else {\n        return this.traverseType(object, traversals);\n      }\n    }\n    return object.map((singleObj) => this.traverseType(singleObj, traversals)) as any;\n  }\n\n  traverseType<T, Return = T>(object: T, traversals: Array<Traversal<T>>): Return {\n    return traversals.reduce((acc: T, traversal: Traversal<T>): T => {\n      const returnValue = traversal(acc);\n      if (typeof returnValue === 'undefined' && !this.options.allowUndefinedReturn) {\n        return acc;\n      }\n      return returnValue;\n    }, object) as any;\n  }\n}\n","export const STANFORD_IIIF_IMAGE_COMPLIANCE_0 = 'http://library.stanford.edu/iiif/image-api/compliance.html#level0';\nexport const STANFORD_IIIF_IMAGE_COMPLIANCE_1 = 'http://library.stanford.edu/iiif/image-api/compliance.html#level1';\nexport const STANFORD_IIIF_IMAGE_COMPLIANCE_2 = 'http://library.stanford.edu/iiif/image-api/compliance.html#level2';\nexport const STANFORD_IIIF_IMAGE_CONFORMANCE_0 = 'http://library.stanford.edu/iiif/image-api/conformance.html#level0';\nexport const STANFORD_IIIF_IMAGE_CONFORMANCE_1 = 'http://library.stanford.edu/iiif/image-api/conformance.html#level1';\nexport const STANFORD_IIIF_IMAGE_CONFORMANCE_2 = 'http://library.stanford.edu/iiif/image-api/conformance.html#level2';\nexport const STANFORD_IIIF_1_IMAGE_COMPLIANCE_0 =\n  'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0';\nexport const STANFORD_IIIF_1_IMAGE_COMPLIANCE_1 =\n  'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1';\nexport const STANFORD_IIIF_1_IMAGE_COMPLIANCE_2 =\n  'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2';\nexport const STANFORD_IIIF_1_IMAGE_CONFORMANCE_0 =\n  'http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0';\nexport const STANFORD_IIIF_1_IMAGE_CONFORMANCE_1 =\n  'http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1';\nexport const STANFORD_IIIF_1_IMAGE_CONFORMANCE_2 =\n  'http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2';\nexport const IIIF_1_IMAGE_LEVEL_0 = 'http://iiif.io/api/image/1/level0.json';\nexport const IIIF_1_IMAGE_LEVEL_0_PROFILE = 'http://iiif.io/api/image/1/profiles/level0.json';\nexport const IIIF_1_IMAGE_LEVEL_1 = 'http://iiif.io/api/image/1/level1.json';\nexport const IIIF_1_IMAGE_LEVEL_1_PROFILE = 'http://iiif.io/api/image/1/profiles/level1.json';\nexport const IIIF_1_IMAGE_LEVEL_2 = 'http://iiif.io/api/image/1/level2.json';\nexport const IIIF_1_IMAGE_LEVEL_2_PROFILE = 'http://iiif.io/api/image/1/profiles/level2.json';\nexport const IIIF_2_IMAGE_LEVEL_0 = 'http://iiif.io/api/image/2/level0.json';\nexport const IIIF_2_IMAGE_LEVEL_0_PROFILE = 'http://iiif.io/api/image/2/profiles/level0.json';\nexport const IIIF_2_IMAGE_LEVEL_1 = 'http://iiif.io/api/image/2/level1.json';\nexport const IIIF_2_IMAGE_LEVEL_1_PROFILE = 'http://iiif.io/api/image/2/profiles/level1.json';\nexport const IIIF_2_IMAGE_LEVEL_2 = 'http://iiif.io/api/image/2/level2.json';\nexport const IIIF_2_IMAGE_LEVEL_2_PROFILE = 'http://iiif.io/api/image/2/profiles/level2.json';\nexport const IIIF_3_IMAGE_LEVEL_0 = 'level0';\nexport const IIIF_3_IMAGE_LEVEL_1 = 'level1';\nexport const IIIF_3_IMAGE_LEVEL_2 = 'level2';\n\n// Non-standard\nexport const IIIF_2_IMAGE_LEVEL_0_NO_JSON = 'http://iiif.io/api/image/2/level0';\nexport const IIIF_2_IMAGE_LEVEL_1_NO_JSON = 'http://iiif.io/api/image/2/level1';\nexport const IIIF_2_IMAGE_LEVEL_2_NO_JSON = 'http://iiif.io/api/image/2/level2';\n\nexport const level1Support = [\n  IIIF_2_IMAGE_LEVEL_1_NO_JSON,\n  IIIF_2_IMAGE_LEVEL_2_NO_JSON,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_2,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_2,\n  IIIF_1_IMAGE_LEVEL_1,\n  IIIF_1_IMAGE_LEVEL_1_PROFILE,\n  IIIF_1_IMAGE_LEVEL_2,\n  IIIF_1_IMAGE_LEVEL_2_PROFILE,\n  IIIF_2_IMAGE_LEVEL_1,\n  IIIF_2_IMAGE_LEVEL_1_PROFILE,\n  IIIF_2_IMAGE_LEVEL_2,\n  IIIF_2_IMAGE_LEVEL_2_PROFILE,\n  IIIF_3_IMAGE_LEVEL_1,\n  IIIF_3_IMAGE_LEVEL_2,\n];\n\nexport const imageServiceProfiles = [\n  IIIF_2_IMAGE_LEVEL_0_NO_JSON,\n  IIIF_2_IMAGE_LEVEL_1_NO_JSON,\n  IIIF_2_IMAGE_LEVEL_2_NO_JSON,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_0,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_0,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_2,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_0,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_0,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_2,\n  IIIF_1_IMAGE_LEVEL_0,\n  IIIF_1_IMAGE_LEVEL_0_PROFILE,\n  IIIF_1_IMAGE_LEVEL_1,\n  IIIF_1_IMAGE_LEVEL_1_PROFILE,\n  IIIF_1_IMAGE_LEVEL_2,\n  IIIF_1_IMAGE_LEVEL_2_PROFILE,\n  IIIF_2_IMAGE_LEVEL_0,\n  IIIF_2_IMAGE_LEVEL_0_PROFILE,\n  IIIF_2_IMAGE_LEVEL_1,\n  IIIF_2_IMAGE_LEVEL_1_PROFILE,\n  IIIF_2_IMAGE_LEVEL_2,\n  IIIF_2_IMAGE_LEVEL_2_PROFILE,\n  IIIF_3_IMAGE_LEVEL_0,\n  IIIF_3_IMAGE_LEVEL_1,\n  IIIF_3_IMAGE_LEVEL_2,\n];\n","import * as Presentation3 from '@iiif/presentation-3';\nimport * as Presentation2 from '@iiif/presentation-2';\nimport { imageServiceProfiles, level1Support } from '../shared/image-api-profiles';\nimport { Traverse } from './traverse';\nimport { ensureArray } from '../shared/ensure-array';\n\nconst configuration = {\n  attributionLabel: 'Attribution',\n  lang: 'none',\n  providerId: 'http://example.org/provider',\n  providerName: 'Unknown',\n};\n\nexport function convertLanguageMapping(\n  inputLangProperty?: Presentation2.OneOrMany<Presentation2.LanguageProperty>,\n  defaultLang = 'none'\n): Presentation3.InternationalString {\n  if (!inputLangProperty) {\n    return {};\n  }\n\n  const arrayOfValues = Array.isArray(inputLangProperty) ? inputLangProperty : [inputLangProperty];\n\n  const languageMap: Presentation3.InternationalString = {};\n\n  for (const language of arrayOfValues) {\n    // For strings \"label\": [\"a value\"]\n    if (typeof language === 'string') {\n      languageMap[defaultLang] = languageMap[defaultLang] ? languageMap[defaultLang] : [];\n      (languageMap[defaultLang] as string[]).push(language || '');\n      continue;\n    }\n\n    // For maps without a language\n    if (!language['@language']) {\n      languageMap[defaultLang] = languageMap[defaultLang] ? languageMap[defaultLang] : [];\n      (languageMap[defaultLang] as string[]).push(language['@value'] || '');\n      continue;\n    }\n\n    // Default case with language.\n    const lang = language['@language'];\n    languageMap[lang] = languageMap[lang] ? languageMap[lang] : [];\n    (languageMap[lang] as string[]).push(language['@value'] || '');\n  }\n  return languageMap;\n}\n\nexport function getProfile(profile: any | any[]): string | undefined {\n  if (Array.isArray(profile)) {\n    return getProfile(profile.find((s) => typeof s === 'string'));\n  }\n\n  if (imageServiceProfiles.indexOf(profile) !== -1) {\n    return 'level2';\n  }\n\n  if (level1Support.indexOf(profile) !== -1) {\n    return 'level1';\n  }\n\n  if (typeof profile !== 'string') {\n    return undefined;\n  }\n\n  return profile;\n}\n\nexport function getTypeFromContext(inputContexts: string | string[]): string | undefined {\n  const contexts: string[] = Array.isArray(inputContexts) ? inputContexts : [inputContexts];\n\n  for (const context of contexts) {\n    switch (context) {\n      case 'http://iiif.io/api/image/2/context.json':\n      case 'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2':\n        return 'ImageService2';\n      case 'http://iiif.io/api/image/1/context.json':\n      case 'http://library.stanford.edu/iiif/image-api/1.1/context.json':\n        return 'ImageService1';\n      case 'http://iiif.io/api/annex/openannotation/context.json':\n        return 'ImageApiSelector';\n    }\n  }\n\n  return undefined;\n}\n\nfunction getTypeFromProfile(inputProfile: string): string | undefined {\n  switch (inputProfile) {\n    case 'http://iiif.io/api/image/2/level0.json':\n    case 'http://iiif.io/api/image/2/level1.json':\n    case 'http://iiif.io/api/image/2/level2.json':\n      return 'ImageService2';\n\n    case 'http://iiif.io/api/auth/1/kiosk':\n    case 'http://iiif.io/api/auth/1/login':\n    case 'http://iiif.io/api/auth/1/clickthrough':\n    case 'http://iiif.io/api/auth/1/external':\n    case 'http://iiif.io/api/auth/0/kiosk':\n    case 'http://iiif.io/api/auth/0/login':\n    case 'http://iiif.io/api/auth/0/clickthrough':\n    case 'http://iiif.io/api/auth/0/external':\n      return 'AuthCookieService1';\n\n    case 'http://iiif.io/api/auth/1/token':\n    case 'http://iiif.io/api/auth/0/token':\n      return 'AuthTokenService1';\n    case 'http://iiif.io/api/auth/1/logout':\n    case 'http://iiif.io/api/auth/0/logout':\n      return 'AuthLogoutService1';\n\n    case 'http://iiif.io/api/search/1/search':\n    case 'http://iiif.io/api/search/0/search':\n      return 'SearchService1';\n    case 'http://iiif.io/api/search/1/autocomplete':\n    case 'http://iiif.io/api/search/0/autocomplete':\n      return 'AutoCompleteService1';\n  }\n\n  return undefined;\n}\n\nfunction removePrefix(str: string) {\n  for (const prefix of ['sc', 'oa', 'dcterms', 'dctypes', 'iiif']) {\n    if (str.startsWith(`${prefix}:`)) {\n      return str.slice(prefix.length + 1);\n    }\n  }\n\n  return str;\n}\n\nconst knownTypes = ['Collection', 'Manifest', 'Annotation', 'AnnotationPage', 'Range', 'Service'];\n\nfunction getNewType(resource: any): string {\n  const id = resource['@id'] || resource.id;\n  let oldType: string | string[] = resource['@type'] || resource.type;\n  const profile: any = resource.profile || undefined;\n  const context: any = resource['@context'] || undefined;\n\n  if (profile) {\n    const possibleType = getTypeFromProfile(profile);\n    if (possibleType) {\n      return possibleType;\n    }\n  }\n\n  if (context) {\n    const possibleType = getTypeFromContext(context);\n    if (possibleType) {\n      return possibleType;\n    }\n  }\n\n  if (oldType) {\n    if (Array.isArray(oldType)) {\n      if (oldType.indexOf('oa:CssStylesheet') !== -1) {\n        return 'CssStylesheet';\n      }\n      if (oldType.indexOf('cnt:ContentAsText') !== -1) {\n        return 'TextualBody';\n      }\n      // Nothing we can do?\n      oldType = oldType[0];\n    }\n\n    for (const prefix of ['sc', 'oa', 'dcterms', 'dctypes', 'iiif']) {\n      if (oldType.startsWith(`${prefix}:`)) {\n        oldType = oldType.slice(prefix.length + 1);\n        break;\n      }\n    }\n\n    switch (oldType) {\n      case 'Layer':\n        return 'AnnotationCollection';\n      case 'AnnotationList':\n        return 'AnnotationPage';\n      case 'cnt:ContentAsText':\n        return 'TextualBody';\n      // @todo There are definitely some missing annotation types here.\n    }\n  }\n\n  if (oldType && knownTypes.indexOf(oldType) !== -1) {\n    return oldType;\n  }\n\n  if (resource.format) {\n    if (resource.format.startsWith('image/')) {\n      return 'Image';\n    }\n    if (resource.format.startsWith('text/')) {\n      return 'Text';\n    }\n    if (resource.format === 'application/pdf') {\n      return 'Text';\n    }\n    if (resource.format.startsWith('application/')) {\n      return 'Dataset';\n    }\n  }\n\n  if (id && (id.endsWith('.jpg') || id.endsWith('.png') || id.endsWith('.jpeg'))) {\n    return 'Image';\n  }\n\n  if (!oldType) {\n    return 'unknown';\n  }\n\n  // Again, nothing we can do.\n  return oldType as string;\n}\n\nconst licenseRegex = /http(s)?:\\/\\/(creativecommons.org|rightsstatements.org)[^\"'\\\\<\\n]+/gm;\n\nfunction extractLicense(license: string) {\n  const matches = license.match(licenseRegex);\n  if (matches) {\n    return matches[0];\n  }\n\n  return license;\n}\n\nasync function getContentTypeOfRemoteResource(resourceId: string): Promise<string | undefined> {\n  try {\n    const response = await fetch(resourceId, { method: 'HEAD' });\n    const headers = response.headers;\n\n    return headers.get('content-type') || undefined;\n  } catch (e) {\n    // do nothing.\n  }\n\n  return undefined;\n}\n\nfunction fixLicense(\n  license: Presentation2.RightsProperties['license'],\n  licenseLabel = 'Rights/License',\n  lang = 'none'\n): [Presentation3.DescriptiveProperties['rights'], Presentation3.DescriptiveProperties['metadata']] {\n  let rights: Presentation3.DescriptiveProperties['rights'] = null;\n  const metadata: Presentation3.DescriptiveProperties['metadata'] = [];\n\n  const licenseList = Array.isArray(license) ? license : [license];\n\n  for (const rawLicense of licenseList) {\n    const singleLicense = rawLicense ? extractLicense(rawLicense) : undefined;\n\n    if (\n      singleLicense &&\n      (singleLicense.indexOf('creativecommons.org') !== -1 || singleLicense.indexOf('rightsstatements.org') !== -1)\n    ) {\n      if (singleLicense.startsWith('https://')) {\n        rights = `http://${singleLicense.slice(8)}`;\n      } else {\n        rights = singleLicense;\n      }\n      continue;\n    }\n    if (singleLicense) {\n      metadata.push({\n        label: { [lang]: [licenseLabel] },\n        value: { [lang]: [singleLicense] },\n      });\n    }\n  }\n\n  return [rights, metadata];\n}\n\nconst removeContexts = [\n  'http://iiif.io/api/presentation/2/context.json',\n  'http://iiif.io/api/image/2/context.json',\n  'http://iiif.io/api/image/1/context.json',\n  'http://library.stanford.edu/iiif/image-api/1.1/context.json',\n  'http://iiif.io/api/search/1/context.json',\n  'http://iiif.io/api/search/0/context.json',\n  'http://iiif.io/api/auth/1/context.json',\n  'http://iiif.io/api/auth/0/context.json',\n  'http://iiif.io/api/annex/openannotation/context.json',\n];\n\nfunction fixContext(inputContext: string | string[] | undefined): string | string[] | undefined {\n  if (inputContext) {\n    const contexts = Array.isArray(inputContext) ? inputContext : [inputContext];\n\n    const newContexts = [];\n    for (const context of contexts) {\n      if (context === 'http://iiif.io/api/presentation/2/context.json') {\n        newContexts.push('http://iiif.io/api/presentation/3/context.json');\n      }\n      if (removeContexts.indexOf(context) !== -1) {\n        continue;\n      }\n      newContexts.push(context);\n    }\n\n    if (contexts.length) {\n      return newContexts.length === 1 ? newContexts[0] : newContexts;\n    }\n  }\n\n  return undefined;\n}\n\nfunction convertMetadata(\n  metadata: Presentation2.DescriptiveProperties['metadata']\n): Presentation3.DescriptiveProperties['metadata'] {\n  if (!metadata) {\n    return [];\n  }\n\n  return metadata.map((item): Presentation3.MetadataItem => {\n    return {\n      label: convertLanguageMapping(item.label),\n      value: convertLanguageMapping(item.value),\n    };\n  });\n}\n\nfunction removeUndefinedProperties(obj: any) {\n  for (const prop in obj) {\n    if (typeof obj[prop] === 'undefined' || obj[prop] === null) {\n      delete obj[prop];\n    }\n  }\n  return obj;\n}\n\nlet mintedIdCounter = 0;\n\nfunction mintNewIdFromResource(\n  resource: Presentation3.SomeRequired<Presentation2.TechnicalProperties, '@type'>,\n  subresource?: string\n) {\n  const origId = encodeURI((resource as { id?: string }).id || resource['@id'] || '').trim();\n\n  if (origId && subresource) {\n    return `${origId}/${subresource}`;\n  }\n\n  if (origId) {\n    return origId;\n  }\n\n  mintedIdCounter++;\n\n  // @todo.\n  return `http://example.org/${resource['@type']}${subresource ? `/${subresource}` : ''}/${mintedIdCounter}`;\n}\n\n// @todo this was removed due to identifiers not being able to be used externally after upgrading.\nfunction resolveDecodedURI(uri: string) {\n  return encodeURI(decodeURIComponent(uri)).trim();\n}\n\nfunction technicalProperties<T extends Partial<Presentation3.TechnicalProperties>>(\n  resource: Presentation3.SomeRequired<Presentation2.TechnicalProperties, '@type'> & {\n    motivation?: string | string[] | null;\n    format?: string;\n    profile?: any;\n    '@context'?: string | string[] | undefined;\n  }\n) {\n  const allBehaviours = [...(resource.behavior || [])];\n\n  if (resource.viewingHint) {\n    allBehaviours.push(resource.viewingHint);\n  }\n\n  let motivation: string | string[] | undefined;\n  if (Array.isArray(resource.motivation)) {\n    motivation = resource.motivation.map(removePrefix);\n  } else if (resource.motivation) {\n    motivation = removePrefix(resource.motivation);\n  }\n\n  return {\n    '@context': resource['@context'] ? fixContext(resource['@context']) : undefined,\n    id: (resource['@id'] || mintNewIdFromResource(resource)).trim(),\n    type: getNewType(resource) as any,\n    behavior: allBehaviours.length ? allBehaviours : undefined,\n    // format: This will be an optional async post-process step.\n    height: resource.height ? resource.height : undefined,\n    width: resource.width ? resource.width : undefined,\n    motivation,\n    viewingDirection: resource.viewingDirection,\n    profile: resource.profile,\n    format: resource.format ? resource.format : undefined,\n    duration: undefined,\n    timeMode: undefined,\n  } as any;\n}\n\nfunction descriptiveProperties<T extends Partial<Presentation3.DescriptiveProperties>>(\n  resource: Presentation2.DescriptiveProperties &\n    Presentation2.RightsProperties &\n    Partial<Presentation2.TechnicalProperties>\n): T {\n  const [rights, extraMetadata] = fixLicense(resource.license);\n  const allMetadata = [...(resource.metadata ? convertMetadata(resource.metadata) : []), ...extraMetadata];\n\n  return {\n    rights,\n    metadata: allMetadata.length ? allMetadata : undefined,\n    label: resource.label ? convertLanguageMapping(resource.label) : undefined,\n    requiredStatement: resource.attribution\n      ? {\n          label: convertLanguageMapping(configuration.attributionLabel),\n          value: convertLanguageMapping(resource.attribution),\n        }\n      : undefined,\n    navDate: resource.navDate,\n    summary: resource.description ? convertLanguageMapping(resource.description) : undefined,\n    thumbnail: resource.thumbnail as any,\n  } as T;\n}\n\nfunction parseWithin(resource: Presentation2.AbstractResource): undefined | Presentation3.LinkingProperties['partOf'] {\n  if (!resource.within) {\n    return undefined;\n  }\n\n  const withinProperties = Array.isArray(resource.within) ? resource.within : [resource.within];\n  const returnPartOf: Presentation3.LinkingProperties['partOf'] = [];\n\n  for (const within of withinProperties) {\n    if (typeof within === 'string') {\n      if (within) {\n        switch (resource['@type']) {\n          case 'sc:Manifest':\n            returnPartOf.push({ id: within, type: 'Collection' });\n            break;\n          // @todo are there more cases?\n        }\n      }\n    } else if ((within as any)['@id']) {\n      returnPartOf.push({\n        id: (within as any)['@id'], // as any since content resources don't require an `@id`\n        type: getNewType(within) as any,\n      });\n    } else {\n      // Content resource.\n    }\n  }\n\n  return returnPartOf.length ? returnPartOf : undefined;\n}\n\nfunction linkingProperties(resource: Presentation2.LinkingProperties & Presentation2.RightsProperties) {\n  // @todo related links to metadata.\n\n  const related = resource.related ? (Array.isArray(resource.related) ? resource.related : [resource.related]) : [];\n  const layer = resource.contentLayer as Presentation2.Layer;\n\n  return {\n    provider:\n      resource.logo || related.length\n        ? [\n            {\n              id: configuration.providerId,\n              type: 'Agent' as const,\n              homepage: related.length ? [related[0] as any] : undefined,\n              logo: resource.logo ? (Array.isArray(resource.logo) ? resource.logo : [resource.logo]) : undefined,\n              label: convertLanguageMapping(configuration.providerName),\n            },\n          ]\n        : undefined,\n    partOf: parseWithin(resource),\n    rendering: resource.rendering,\n    seeAlso: resource.seeAlso,\n    start: resource.startCanvas as any,\n    service: resource.service ? ensureArray(resource.service as any) : undefined,\n    supplementary: layer ? [layer as any] : undefined,\n  };\n}\n\n// FIXME: Is this function really needed?\nfunction embeddedContentProperties(resource: Presentation2.CharsEmbeddedContent) {\n  return {\n    chars: resource.chars,\n    format: resource.format ? resource.format : undefined,\n    language: resource.language,\n  };\n}\n\nfunction upgradeCollection(collection: Presentation2.Collection): Presentation3.Collection {\n  return removeUndefinedProperties({\n    ...technicalProperties(collection),\n    ...descriptiveProperties<Presentation3.SomeRequired<Presentation3.CollectionDescriptive, 'label'>>(collection),\n    ...linkingProperties(collection),\n    items: collection.members as any,\n  });\n}\n\nfunction flattenArray<T>(array: T[][]): T[] {\n  const returnArr: T[] = [];\n  for (const arr of array || []) {\n    returnArr.push(...arr);\n  }\n  return returnArr;\n}\n\nfunction upgradeManifest(manifest: Presentation2.Manifest): Presentation3.Manifest {\n  const allCanvases = [];\n  const behavior = [];\n  for (const sequence of manifest.sequences || []) {\n    if (sequence.canvases.length) {\n      allCanvases.push(...sequence.canvases);\n    }\n    if (sequence.behavior) {\n      behavior.push(...sequence.behavior);\n    }\n  }\n\n  // This comes from the sequence.\n  const technical = technicalProperties(manifest);\n  if (behavior.length) {\n    if (technical.behavior) {\n      technical.behavior.push(...behavior);\n    } else {\n      technical.behavior = behavior;\n    }\n  }\n\n  return removeUndefinedProperties({\n    ...technical,\n    ...descriptiveProperties(manifest),\n    ...linkingProperties(manifest),\n    items: allCanvases,\n    structures: manifest.structures as any,\n  });\n}\n\nfunction upgradeCanvas(canvas: Presentation2.Canvas): Presentation3.Canvas {\n  return removeUndefinedProperties({\n    ...technicalProperties(canvas),\n    ...descriptiveProperties(canvas),\n    ...linkingProperties(canvas),\n    annotations: canvas.otherContent && canvas.otherContent.length ? (canvas.otherContent as any[]) : undefined,\n    items:\n      canvas.images && canvas.images.length\n        ? [\n            {\n              id: mintNewIdFromResource(canvas, 'annotation-page'),\n              type: 'AnnotationPage',\n              items: canvas.images as any,\n            },\n          ]\n        : undefined,\n  });\n}\n\nfunction upgradeAnnotationList(annotationPage: Presentation2.AnnotationList): Presentation3.AnnotationPage {\n  return removeUndefinedProperties({\n    ...(technicalProperties(annotationPage) as any),\n    ...(descriptiveProperties(annotationPage) as any),\n    ...(linkingProperties(annotationPage) as any),\n    items: annotationPage.resources && annotationPage.resources.length ? (annotationPage.resources as any) : undefined,\n  });\n}\n\nfunction upgradeSequence(sequence: Presentation2.Sequence): {\n  canvases: Presentation3.Canvas[];\n  behavior?: string[];\n} {\n  /*\n    rng = {\"id\": s.get('@id', self.mint_uri()), \"type\": \"Range\"}\n    rng['behavior'] = ['sequence']\n    rng['items'] = []\n    for c in s['canvases']:\n      if type(c) == dict:\n        rng['items'].append({\"id\": c['@id'], \"type\": \"Canvas\"})\n      elif type(c) in STR_TYPES:\n        rng['items'].append({\"id\": c, \"type\": \"Canvas\"})\n    # Copy other properties and hand off to _generic\n    del s['canvases']\n    for k in s.keys():\n      if not k in ['@id', '@type']:\n        rng[k] = s[k]\n    self.process_generic(rng)\n    what['_structures'].append(rng)\n   */\n\n  if (!sequence.canvases || sequence.canvases.length === 0) {\n    return {\n      canvases: [],\n      behavior: [],\n    };\n  }\n\n  // @todo possibly return some ranges too.\n  return {\n    canvases: sequence.canvases as any[],\n    behavior: sequence.viewingHint ? [sequence.viewingHint] : [],\n  };\n}\n\nfunction upgradeAnnotation(annotation: Presentation2.Annotation): Presentation3.Annotation {\n  function upgradeTarget(target: typeof annotation.on): Presentation3.AnnotationTarget {\n    if (Array.isArray(target)) {\n      if (target.length > 1) {\n        return { type: 'List', items: target.map(upgradeTarget) as Presentation3.Target[] };\n      }\n      target = target[0];\n    }\n    if (typeof target === 'string') {\n      return encodeURI(target).trim();\n    } else if ('@type' in target) {\n      let source: string | Presentation3.Reference<'Canvas'> | Presentation3.Reference<'Image'>;\n      if (typeof target.full === 'string') {\n        source = target.full;\n      } else if (target.full['@type'] === 'dctypes:Image') {\n        source = { id: target.full['@id'], type: 'Image' };\n      } else if (target.full['@type'] === 'sc:Canvas') {\n        source = { id: target.full['@id'], type: 'Canvas' };\n      } else {\n        throw new Error(`Unsupported source type on annotation: ${target.full['@type']}`);\n      }\n      return {\n        type: 'SpecificResource',\n        source,\n        selector: upgradeSelector(target.selector),\n      };\n    } else {\n      return encodeURI(target['@id']).trim();\n    }\n  }\n  return removeUndefinedProperties({\n    ...(technicalProperties(annotation) as any),\n    ...(descriptiveProperties(annotation) as any),\n    ...(linkingProperties(annotation) as any),\n    target: upgradeTarget(annotation.on),\n    body: Array.isArray(annotation.resource)\n      ? annotation.resource.map(upgradeContentResource)\n      : upgradeContentResource(annotation.resource),\n    // @todo stylesheet upgrade.\n  });\n}\n\nfunction upgradeContentResource(inputContentResource: Presentation2.ContentResource): Presentation3.ContentResource {\n  const contentResource = inputContentResource as Presentation2.CommonContentResource;\n  // @todo there might be some field dropped here.\n  return removeUndefinedProperties({\n    ...(technicalProperties(contentResource) as any),\n    ...(descriptiveProperties(contentResource) as any),\n    ...(linkingProperties(contentResource as any) as any),\n    ...(embeddedContentProperties(contentResource as any) as any),\n  });\n}\n\nfunction upgradeChoice(choice: Presentation2.ChoiceEmbeddedContent): Presentation3.ChoiceBody {\n  const items = [];\n\n  if (choice.default && choice.default !== 'rdf:nil') {\n    items.push(choice.default);\n  }\n\n  if (choice.item && choice.item !== 'rdf:nil') {\n    items.push(...choice.item);\n  }\n\n  return {\n    ...technicalProperties(choice),\n    ...descriptiveProperties(choice),\n    items: items as any,\n  };\n}\n\nfunction upgradeRange(range: Presentation2.Range): Presentation3.Range {\n  // range.members;\n  // range.canvases;\n  // Range.\n  // At the moment a range only references other ranges by id.\n  // So we need to first get\n  return removeUndefinedProperties({\n    ...technicalProperties(range),\n    ...descriptiveProperties(range),\n    ...linkingProperties(range),\n    items: range.members as any,\n  } as Presentation3.Range);\n}\n\nfunction upgradeService(service: Presentation2.Service): Presentation3.Service {\n  const { '@id': id, '@type': type, '@context': context, profile, ...additionalProps } = service as any;\n\n  const newService: any = {};\n\n  if (id) {\n    newService['@id'] = id;\n  }\n\n  newService['@type'] = getNewType(service);\n\n  if (newService['@type'] === 'unknown') {\n    // @todo handle case where there might be multiple contexts.\n    if (context && context.length) {\n      newService['@context'] = context;\n    }\n    newService['@type'] = 'Service'; // optional on services.\n  }\n\n  if (profile) {\n    newService.profile = getProfile(profile);\n  }\n\n  return removeUndefinedProperties({\n    ...newService,\n    ...additionalProps,\n  });\n}\n\nfunction upgradeLayer(layer: Presentation2.Layer): Presentation3.AnnotationCollection {\n  return removeUndefinedProperties({\n    ...technicalProperties(layer),\n    ...descriptiveProperties(layer),\n    ...linkingProperties(layer),\n  });\n}\n\nexport const presentation2to3 = new Traverse<{\n  Collection: Presentation3.Collection;\n  Manifest: Presentation3.Manifest;\n  Canvas: Presentation3.Canvas;\n  AnnotationList: Presentation3.AnnotationPage;\n  Sequence: Presentation3.Canvas[];\n  Annotation: Presentation3.Annotation;\n  ContentResource: Presentation3.ContentResource;\n  Choice: Presentation3.ChoiceBody;\n  Range: Presentation3.Range;\n  Service: Presentation3.Service;\n  Layer: Presentation3.AnnotationCollection;\n}>({\n  collection: [upgradeCollection],\n  manifest: [upgradeManifest],\n  canvas: [upgradeCanvas],\n  annotationList: [upgradeAnnotationList],\n  sequence: [upgradeSequence],\n  annotation: [upgradeAnnotation],\n  contentResource: [upgradeContentResource],\n  choice: [upgradeChoice],\n  range: [upgradeRange],\n  service: [upgradeService],\n  layer: [upgradeLayer],\n});\n\nexport function convertPresentation2(entity: any): Presentation3.Manifest | Presentation3.Collection {\n  if (\n    (entity &&\n      entity['@context'] &&\n      (entity['@context'] === 'http://iiif.io/api/presentation/2/context.json' ||\n        entity['@context'].indexOf('http://iiif.io/api/presentation/2/context.json') !== -1 ||\n        // Yale context.\n        entity['@context'] === 'http://www.shared-canvas.org/ns/context.json')) ||\n    entity['@context'] === 'http://iiif.io/api/image/2/context.json'\n  ) {\n    return presentation2to3.traverseUnknown(entity);\n  }\n  return entity;\n}\n\nfunction upgradeSelector(\n  selector: Presentation2.ContentResourceSelector\n): Presentation3.Selector | Presentation3.Selector[] {\n  const isSvgSelector =\n    ((Array.isArray(selector['@type']) && selector['@type'].includes('oa:SvgSelector')) ||\n      selector['@type'] == 'oa:SvgSelector') &&\n    ('chars' in selector || 'value' in selector);\n  if (isSvgSelector) {\n    return {\n      type: 'SvgSelector',\n      value: 'chars' in selector ? selector.chars : selector.value,\n    };\n  }\n  if (selector['@type'] === 'oa:FragmentSelector') {\n    return {\n      type: 'FragmentSelector',\n      value: selector.value,\n    };\n  }\n  if (selector['@type'] === 'oa:Choice') {\n    return [\n      upgradeSelector(selector.default) as Presentation3.Selector,\n      ...((Array.isArray(selector.item) ? selector.item : [selector.item]).map(\n        upgradeSelector\n      ) as Presentation3.Selector[]),\n    ];\n  }\n  if (selector['@type'] == 'iiif:ImageApiSelector') {\n    return {\n      type: 'ImageApiSelector',\n      region: 'region' in selector ? selector.region : undefined,\n      rotation: 'rotation' in selector ? selector.rotation : undefined,\n    };\n  }\n  throw new Error(`Unsupported selector type: ${selector['@type']}`);\n}\n","export function ensureArray<T>(maybeArray: T | T[]): T[] {\n  if (Array.isArray(maybeArray)) {\n    return maybeArray;\n  }\n  return [maybeArray];\n}\n"],"names":["types","identifyResource","resource","Error","Array","isArray","hasType","indexOf","profile","format","Traverse","constructor","traversals","options","__publicField","this","collection","manifest","canvas","annotationList","sequence","annotation","contentResource","choice","range","service","layer","convertPropsToArray","mergeMemberProperties","allowUndefinedReturn","static","traversal","traverseCollection","traverseType","traverseDescriptive","traverseLinking","traverseCollectionItems","members","manifests","map","collections","subCollection","traverseManifest","member","traverseUnknown","traverseManifestItems","sequences","traverseSequence","structures","structure","traverseRange","traverseSequenceItems","canvases","traverseCanvas","traverseCanvasItems","images","image","traverseAnnotation","otherContent","traverseAnnotationList","traverseRangeItems","ranges","innerRange","length","list","traverseAnnotationListItems","resources","traverseAnnotationItems","res","traverseContentResource","on","traverseLayer","traverseLayerItems","traverseChoice","traverseChoiceItems","default","item","traverseService","traverseImageResource","wasArray","resourceList","newResourceList","singleResource","push","thumbnail","logo","traverseOneOrMoreServices","allServices","services","newServices","related","traverseOneOrManyType","rendering","seeAlso","within","startCanvas","contentLayer","object","singleObj","reduce","acc","returnValue","level1Support","imageServiceProfiles","configuration","convertLanguageMapping","inputLangProperty","defaultLang","arrayOfValues","languageMap","language","lang","getProfile","find","s","getTypeFromContext","inputContexts","contexts","context","removePrefix","str","prefix","startsWith","slice","knownTypes","getNewType","id","oldType","type","possibleType","inputProfile","getTypeFromProfile","endsWith","licenseRegex","extractLicense","license","matches","match","removeContexts","fixContext","inputContext","newContexts","removeUndefinedProperties","obj","prop","mintedIdCounter","mintNewIdFromResource","subresource","origId","encodeURI","trim","technicalProperties","allBehaviours","behavior","motivation","viewingHint","height","width","viewingDirection","duration","timeMode","descriptiveProperties","rights","extraMetadata","licenseLabel","metadata","licenseList","rawLicense","singleLicense","label","value","fixLicense","allMetadata","requiredStatement","attribution","navDate","summary","description","parseWithin","withinProperties","returnPartOf","linkingProperties","provider","homepage","partOf","start","maybeArray","supplementary","upgradeContentResource","inputContentResource","chars","presentation2to3","items","allCanvases","technical","annotations","annotationPage","target","upgradeTarget","source","full","selector","upgradeSelector","body","additionalProps","newService","includes","region","rotation","entity"],"mappings":"4QAsBO,MAAMA,EAAkC,CAC7C,gBACA,cACA,YACA,oBACA,gBACA,WACA,WACA,cACA,YAEA,UACA,mBASK,SAASC,EAAiBC,GAC/B,GAAI,MAAOA,EACH,MAAA,IAAIC,MAAM,4CAEd,GAAAC,MAAMC,QAAQH,GACV,MAAA,IAAIC,MAAM,+BAEd,GAAoB,iBAAbD,EACT,MAAM,IAAIC,aAAgBD,EAAV,0BAGd,GAA6B,iBAAtBA,EAAS,SAAuB,CACzC,MAAMI,EAAUN,EAAMO,QAAQL,EAAS,UACvC,IAAoB,IAAhBI,EACF,OAAON,EAAMM,EAEjB,CAEA,GAAIJ,EAASM,QACJ,MAAA,UAGT,GAAIN,EAASO,OACJ,MAAA,kBAIT,GAAIP,EAAS,SACJ,MAAA,kBAGH,MAAA,IAAIC,MAAM,6BAClB,CAEO,MAAMO,EA8BXC,YAAYC,EAAmCC,EAAoC,IAH3EC,EAAAC,KAAA,cACAD,EAAAC,KAAA,WAGNA,KAAKH,WAAa,CAChBI,WAAY,GACZC,SAAU,GACVC,OAAQ,GACRC,eAAgB,GAChBC,SAAU,GACVC,WAAY,GACZC,gBAAiB,GACjBC,OAAQ,GACRC,MAAO,GACPC,QAAS,GACTC,MAAO,MACJd,GAELG,KAAKF,QAAU,CACbc,qBAAqB,EACrBC,uBAAuB,EACvBC,sBAAsB,KACnBhB,EAEP,CAEAiB,WAAWC,GACT,OAAO,IAAIrB,EAAS,CAClBM,WAAY,CAACe,GACbd,SAAU,CAACc,GACXb,OAAQ,CAACa,GACTZ,eAAgB,CAACY,GACjBX,SAAU,CAACW,GACXV,WAAY,CAACU,GACbT,gBAAiB,CAACS,GAClBR,OAAQ,CAACQ,GACTP,MAAO,CAACO,GACRN,QAAS,CAACM,GACVL,MAAO,CAACK,IAEZ,CAEAC,mBAAmBhB,GACjB,OAAOD,KAAKkB,aACVlB,KAAKmB,oBAAoBnB,KAAKoB,gBAAgBpB,KAAKqB,wBAAwBpB,KAC3ED,KAAKH,WAAWI,WAEpB,CAEAoB,wBAAwBpB,GAClB,GAAAD,KAAKF,QAAQe,sBAAuB,CACtC,MAAMS,EAAU,KACVrB,EAAWsB,WAAa,IAAIC,KAAKtB,GACX,iBAAbA,EACF,CAAE,MAAOA,EAAU,QAAS,eAE9BA,QAELD,EAAWwB,aAAe,IAAID,KAAKE,GACR,iBAAlBA,EACF,CAAE,MAAOA,EAAe,QAAS,iBAEnCA,OAELzB,EAAWqB,SAAW,WAGrBrB,EAAWwB,mBACXxB,EAAWsB,UAClBtB,EAAWqB,QAAUA,CACvB,CA+BO,OA7BHrB,EAAWsB,YACFtB,EAAAsB,UAAYtB,EAAWsB,UAAUC,KAAKtB,GAC/CF,KAAK2B,iBACiB,iBAAbzB,EACF,CAAE,MAAOA,EAAU,QAAS,eAC5BA,MAKPD,EAAWwB,cACFxB,EAAAwB,YAAcxB,EAAWwB,YAAYD,KAAKE,GACnD1B,KAAKiB,mBACsB,iBAAlBS,EACF,CAAE,MAAOA,EAAe,QAAS,iBACjCA,MAKPzB,EAAWqB,UACbrB,EAAWqB,QAAUrB,EAAWqB,QAAQE,KAAKI,GACrB,iBAAXA,EACFA,EAEF5B,KAAK6B,gBAAgBD,MAIzB3B,CACT,CAEA0B,iBAAiBzB,GACf,OAAOF,KAAKkB,aACVlB,KAAKmB,oBAAoBnB,KAAKoB,gBAAgBpB,KAAK8B,sBAAsB5B,KACzEF,KAAKH,WAAWK,SAEpB,CAEA4B,sBAAsB5B,GAOb,OANHA,EAAS6B,YACF7B,EAAA6B,UAAY7B,EAAS6B,UAAUP,KAAKnB,GAAaL,KAAKgC,iBAAiB3B,MAE9EH,EAAS+B,aACF/B,EAAA+B,WAAa/B,EAAS+B,WAAWT,KAAKU,GAAclC,KAAKmC,cAAcD,MAE3EhC,CACT,CAEA8B,iBAAiB3B,GACf,OAAOL,KAAKkB,aACVlB,KAAKmB,oBAAoBnB,KAAKoB,gBAAgBpB,KAAKoC,sBAAsB/B,KACzEL,KAAKH,WAAWQ,SAEpB,CAEA+B,sBAAsB/B,GAIb,OAHHA,EAASgC,WACFhC,EAAAgC,SAAWhC,EAASgC,SAASb,KAAKrB,GAAWH,KAAKsC,eAAenC,MAErEE,CACT,CAEAiC,eAAenC,GACb,OAAOH,KAAKkB,aACVlB,KAAKmB,oBAAoBnB,KAAKoB,gBAAgBpB,KAAKuC,oBAAoBpC,KACvEH,KAAKH,WAAWM,OAEpB,CAEAoC,oBAAoBpC,GAOX,OANHA,EAAOqC,SACFrC,EAAAqC,OAASrC,EAAOqC,OAAOhB,KAAKiB,GAAUzC,KAAK0C,mBAAmBD,MAEnEtC,EAAOwC,eACFxC,EAAAwC,aAAexC,EAAOwC,aAAanB,KAAKpB,GAAmBJ,KAAK4C,uBAAuBxC,MAEzFD,CACT,CAEAgC,cAAc1B,GACZ,OAAOT,KAAKkB,aACVlB,KAAKmB,oBAAoBnB,KAAKoB,gBAAgBpB,KAAK6C,mBAAmBpC,KACtET,KAAKH,WAAWY,MAEpB,CAEAoC,mBAAmBpC,GACb,GAAAT,KAAKF,QAAQe,sBAAuB,CACtC,MAAMS,EAAU,KACVb,EAAMqC,QAAU,IAAItB,KAAKuB,GACD,iBAAfA,EACF,CAAE,MAAOA,EAAY,QAAS,YAEhCA,QAELtC,EAAM4B,UAAY,IAAIb,KAAKrB,GACP,iBAAXA,EACF,CAAE,MAAOA,EAAQ,QAAS,aAE5BA,OAELM,EAAMa,SAAW,WAGhBb,EAAMqC,cACNrC,EAAM4B,SACP5B,EAAAa,QAAUA,EAAQ0B,OAAS1B,EAAQE,KAAKI,GAAW5B,KAAK6B,gBAAgBD,UAAW,CAC3F,CACO,OAAAnB,CACT,CAEAmC,uBAAuBxC,GACf,MAAA6C,EACsB,iBAAnB7C,EACF,CAAE,MAAOA,EAAgB,QAAS,qBACnCA,EAEN,OAAOJ,KAAKkB,aACVlB,KAAKmB,oBAAoBnB,KAAKkD,4BAA4BD,IAC1DjD,KAAKH,WAAWO,eAEpB,CAEA8C,4BAA4B9C,GAKnB,OAJHA,EAAe+C,YACF/C,EAAA+C,UAAY/C,EAAe+C,UAAU3B,KAAKlB,GAAeN,KAAK0C,mBAAmBpC,MAG3FF,CACT,CAEAsC,mBAAmBpC,GACjB,OAAON,KAAKkB,aACVlB,KAAKmB,oBAAoBnB,KAAKoB,gBAAgBpB,KAAKoD,wBAAwB9C,KAC3EN,KAAKH,WAAWS,WAEpB,CAEA8C,wBAAwB9C,GAgBf,OAfHA,EAAWnB,WACTE,MAAMC,QAAQgB,EAAWnB,UAChBmB,EAAAnB,SAAWmB,EAAWnB,SAASqC,KAAK6B,GAC7CrD,KAAKsD,wBAAwBD,KAG/B/C,EAAWnB,SAAWa,KAAKsD,wBAAwBhD,EAAWnB,WAI9DmB,EAAWiD,GAKRjD,CACT,CAEAkD,cAAc7C,GACL,OAAAX,KAAKkB,aAAalB,KAAKoB,gBAAgBpB,KAAKyD,mBAAmB9C,IAASX,KAAKH,WAAWc,MACjG,CAEA8C,mBAAmB9C,GAIV,OAHHA,EAAMgC,eACFhC,EAAAgC,aAAehC,EAAMgC,aAAanB,KAAKpB,GAAmBJ,KAAK4C,uBAAuBxC,MAEvFO,CACT,CAEA+C,eAAelD,GACN,OAAAR,KAAKkB,aAAalB,KAAK2D,oBAAoBnD,GAASR,KAAKH,WAAWW,OAC7E,CAEAmD,oBAAoBnD,GAQX,OAPHA,EAAOoD,SAA8B,YAAnBpD,EAAOoD,UAC3BpD,EAAOoD,QAAU5D,KAAKsD,wBAAwB9C,EAAOoD,UAEnDpD,EAAOqD,MAAwB,YAAhBrD,EAAOqD,OACjBrD,EAAAqD,KAAOrD,EAAOqD,KAAKrC,KAAKqC,GAAS7D,KAAKsD,wBAAwBO,MAGhErD,CACT,CAEAsD,gBAAgBpD,GACP,OAAAV,KAAKkB,aAAalB,KAAKoB,gBAAgBV,GAAiBV,KAAKH,WAAWa,QACjF,CAEA4C,wBAAwB/C,GAClB,MAA6B,cAA7BA,EAAgB,SACXP,KAAK0D,eAAenD,GAGtBP,KAAKkB,aACVlB,KAAKmB,oBAAoBnB,KAAKoB,gBAAgBb,IAC9CP,KAAKH,WAAWU,gBAEpB,CAEAsB,gBAAgBgC,GACd,IAAKA,EAAK,UAA4B,iBAATA,EAEpB,OAAAA,EAED,OAAA3E,EAAiB2E,IACvB,IAAK,gBACI,OAAA7D,KAAKiB,mBAAmB4C,GACjC,IAAK,cACI,OAAA7D,KAAK2B,iBAAiBkC,GAC/B,IAAK,YACI,OAAA7D,KAAKsC,eAAeuB,GAC7B,IAAK,cACI,OAAA7D,KAAKgC,iBAAiB6B,GAC/B,IAAK,WACI,OAAA7D,KAAKmC,cAAc0B,GAC5B,IAAK,gBACI,OAAA7D,KAAK0C,mBAAmBmB,GACjC,IAAK,oBACI,OAAA7D,KAAK4C,uBAAuBiB,GACrC,IAAK,WACI,OAAA7D,KAAKwD,cAAcK,GAC5B,IAAK,UACI,OAAA7D,KAAK8D,gBAAgBD,GAC9B,IAAK,YACI,OAAA7D,KAAK0D,eAAeG,GAC7B,IAAK,kBACI,OAAA7D,KAAKsD,wBAAwBO,GAGxC,OAAIA,EAAKpE,QACAO,KAAK8D,gBAAgBD,GAGvBA,CACT,CAEAE,sBAAsBxD,GACd,MAAAyD,EAAW3E,MAAMC,QAAQiB,GACzB0D,EAAe5E,MAAMC,QAAQiB,GAAmBA,EAAkB,CAACA,GACnE2D,EAAyB,GAE/B,IAAA,MAAWC,KAAkBF,EACG,iBAAnBE,EACOD,EAAAE,KACdpE,KAAKsD,wBAAwB,CAC3B,MAAOa,EACP,QAAS,mBAIbD,EAAgBE,KAAKpE,KAAKsD,wBAAwBa,IAItD,OAAKH,GAAahE,KAAKF,QAAQc,oBAIxBsD,EAHEA,EAAgB,EAI3B,CAEA/C,oBAAiFhC,GASxE,OARHA,EAASkF,YACXlF,EAASkF,UAAYrE,KAAK+D,sBAAsB5E,EAASkF,YAGvDlF,EAASmF,OACXnF,EAASmF,KAAOtE,KAAK+D,sBAAsB5E,EAASmF,OAG/CnF,CACT,CAEAoF,0BAA0BC,GAClB,MAAAR,EAAW3E,MAAMC,QAAQkF,GACzBC,EAAWpF,MAAMC,QAAQkF,GAAeA,EAAc,CAACA,GACvDE,EAAc,GACpB,IAAA,MAAWhE,KAAW+D,EACpBC,EAAYN,KAAKpE,KAAK8D,gBAAgBpD,IAGxC,OAAKsD,GAAahE,KAAKF,QAAQc,oBAIxB8D,EAHEA,EAAY,EAIvB,CAEAtD,gBAAsDjC,GA2C7C,OA1CHA,EAASwF,UACXxF,EAASwF,QAAU3E,KAAK4E,sBAAsBzF,EAASwF,QAAS3E,KAAKH,WAAWU,kBAE9EpB,EAAS0F,YACX1F,EAAS0F,UAAY7E,KAAK4E,sBAAsBzF,EAAS0F,UAAW7E,KAAKH,WAAWU,kBAElFpB,EAASuB,UACXvB,EAASuB,QAAUV,KAAKuE,0BAA0BpF,EAASuB,UAEzDvB,EAAS2F,UACX3F,EAAS2F,QAAU9E,KAAK4E,sBAAsBzF,EAAS2F,QAAS9E,KAAKH,WAAWU,kBAE9EpB,EAAS4F,SACoB,iBAApB5F,EAAS4F,SAGlB5F,EAAS4F,OAAS/E,KAAK4E,sBACrBzF,EAAS4F,OACT/E,KAAKH,WAAWU,mBAIlBpB,EAAS6F,cACyB,iBAAzB7F,EAAS6F,YAClB7F,EAAS6F,YAAchF,KAAKkB,aAC1B,CAAE,MAAO/B,EAAS6F,YAAa,QAAS,aACxChF,KAAKH,WAAWM,QAEThB,EAAS6F,aAClBhF,KAAKkB,aAAa/B,EAAS6F,YAAoBhF,KAAKH,WAAWM,SAG/DhB,EAAS8F,eAC0B,iBAA1B9F,EAAS8F,aACT9F,EAAA8F,aAAejF,KAAKwD,cAAc,CACzC,MAAOrE,EAAS8F,aAChB,QAAS,aAGX9F,EAAS8F,aAAejF,KAAKwD,cAAcrE,EAAS8F,eAGjD9F,CACT,CAEAyF,sBAAqCM,EAAiBrF,GACpD,IAAKR,MAAMC,QAAQ4F,GAAS,CACtB,IAAAlF,KAAKF,QAAQc,oBAGR,OAAAZ,KAAKkB,aAAagE,EAAQrF,GAFjCqF,EAAS,CAACA,EAId,CACO,OAAAA,EAAO1D,KAAK2D,GAAcnF,KAAKkB,aAAaiE,EAAWtF,IAChE,CAEAqB,aAA4BgE,EAAWrF,GACrC,OAAOA,EAAWuF,QAAO,CAACC,EAAQrE,KAC1B,MAAAsE,EAActE,EAAUqE,GAC9B,YAA2B,IAAhBC,GAAgCtF,KAAKF,QAAQgB,qBAGjDwE,EAFED,CAEF,GACNH,EACL,ECjhBK,MAuCMK,EAAgB,CAHe,oCACA,oCApCI,oEACA,oEAEC,qEACA,qEAI/C,wEAEA,wEAIA,yEAEA,yEAGkC,yCACQ,kDACR,yCACQ,kDAGR,yCACQ,kDACR,yCACQ,kDAER,SACA,UA8BvBC,EAAuB,CA3BQ,oCACA,oCACA,oCArCI,oEACA,oEACA,oEACC,qEACA,qEACA,qEAE/C,wEAEA,wEAEA,wEAEA,yEAEA,yEAEA,yEACkC,yCACQ,kDACR,yCACQ,kDACR,yCACQ,kDACR,yCACQ,kDACR,yCACQ,kDACR,yCACQ,kDACR,SACA,SACA,UC1BpC,MAAMC,EACc,cADdA,EAGQ,8BAHRA,EAIU,UAGA,SAAAC,EACdC,EACAC,EAAc,QAEd,IAAKD,EACH,MAAO,GAGT,MAAME,EAAgBxG,MAAMC,QAAQqG,GAAqBA,EAAoB,CAACA,GAExEG,EAAiD,CAAA,EAEvD,IAAA,MAAWC,KAAYF,EAAe,CAEhC,GAAoB,iBAAbE,EAAuB,CAChCD,EAAYF,GAAeE,EAAYF,GAAeE,EAAYF,GAAe,GACpEE,EAAAF,GAA0BxB,KAAK2B,GAAY,IACxD,QACF,CAGI,IAACA,EAAS,aAAc,CAC1BD,EAAYF,GAAeE,EAAYF,GAAeE,EAAYF,GAAe,GAChFE,EAAYF,GAA0BxB,KAAK2B,EAAS,WAAa,IAClE,QACF,CAGA,MAAMC,EAAOD,EAAS,aACtBD,EAAYE,GAAQF,EAAYE,GAAQF,EAAYE,GAAQ,GAC3DF,EAAYE,GAAmB5B,KAAK2B,EAAS,WAAa,GAC7D,CACO,OAAAD,CACT,CAEO,SAASG,EAAWxG,GACrB,OAAAJ,MAAMC,QAAQG,GACTwG,EAAWxG,EAAQyG,MAAMC,GAAmB,iBAANA,MAGG,IAA9CX,EAAqBhG,QAAQC,GACxB,UAGkC,IAAvC8F,EAAc/F,QAAQC,GACjB,SAGc,iBAAZA,EAIJA,OAJH,CAKN,CAEO,SAAS2G,EAAmBC,GACjC,MAAMC,EAAqBjH,MAAMC,QAAQ+G,GAAiBA,EAAgB,CAACA,GAE3E,IAAA,MAAWE,KAAWD,EACpB,OAAQC,GACN,IAAK,0CACL,IAAK,wEACI,MAAA,gBACT,IAAK,0CACL,IAAK,8DACI,MAAA,gBACT,IAAK,uDACI,MAAA,mBAKf,CAqCA,SAASC,EAAaC,GACpB,IAAA,MAAWC,IAAU,CAAC,KAAM,KAAM,UAAW,UAAW,QACtD,GAAID,EAAIE,WAAW,GAAGD,MACpB,OAAOD,EAAIG,MAAMF,EAAO1D,OAAS,GAI9B,OAAAyD,CACT,CAEA,MAAMI,EAAa,CAAC,aAAc,WAAY,aAAc,iBAAkB,QAAS,WAEvF,SAASC,EAAW3H,GACZ,MAAA4H,EAAK5H,EAAS,QAAUA,EAAS4H,GACnC,IAAAC,EAA6B7H,EAAS,UAAYA,EAAS8H,KACzD,MAAAxH,EAAeN,EAASM,cAAW,EACnC8G,EAAepH,EAAS,kBAAe,EAE7C,GAAIM,EAAS,CACL,MAAAyH,EAtDV,SAA4BC,GAC1B,OAAQA,GACN,IAAK,yCACL,IAAK,yCACL,IAAK,yCACI,MAAA,gBAET,IAAK,kCACL,IAAK,kCACL,IAAK,yCACL,IAAK,qCACL,IAAK,kCACL,IAAK,kCACL,IAAK,yCACL,IAAK,qCACI,MAAA,qBAET,IAAK,kCACL,IAAK,kCACI,MAAA,oBACT,IAAK,mCACL,IAAK,mCACI,MAAA,qBAET,IAAK,qCACL,IAAK,qCACI,MAAA,iBACT,IAAK,2CACL,IAAK,2CACI,MAAA,uBAIb,CAqByBC,CAAmB3H,GACxC,GAAIyH,EACK,OAAAA,CAEX,CAEA,GAAIX,EAAS,CACL,MAAAW,EAAed,EAAmBG,GACxC,GAAIW,EACK,OAAAA,CAEX,CAEA,GAAIF,EAAS,CACP,GAAA3H,MAAMC,QAAQ0H,GAAU,CAC1B,IAAgD,IAA5CA,EAAQxH,QAAQ,oBACX,MAAA,gBAET,IAAiD,IAA7CwH,EAAQxH,QAAQ,qBACX,MAAA,cAGTwH,EAAUA,EAAQ,EACpB,CAEA,IAAA,MAAWN,IAAU,CAAC,KAAM,KAAM,UAAW,UAAW,QACtD,GAAIM,EAAQL,WAAW,GAAGD,MAAY,CACpCM,EAAUA,EAAQJ,MAAMF,EAAO1D,OAAS,GACxC,KACF,CAGF,OAAQgE,GACN,IAAK,QACI,MAAA,uBACT,IAAK,iBACI,MAAA,iBACT,IAAK,oBACI,MAAA,cAGb,CAEA,GAAIA,IAA+C,IAApCH,EAAWrH,QAAQwH,GACzB,OAAAA,EAGT,GAAI7H,EAASO,OAAQ,CACnB,GAAIP,EAASO,OAAOiH,WAAW,UACtB,MAAA,QAET,GAAIxH,EAASO,OAAOiH,WAAW,SACtB,MAAA,OAEL,GAAoB,oBAApBxH,EAASO,OACJ,MAAA,OAET,GAAIP,EAASO,OAAOiH,WAAW,gBACtB,MAAA,SAEX,CAEA,OAAII,IAAOA,EAAGM,SAAS,SAAWN,EAAGM,SAAS,SAAWN,EAAGM,SAAS,UAC5D,QAGJL,GACI,SAKX,CAEA,MAAMM,EAAe,uEAErB,SAASC,EAAeC,GAChB,MAAAC,EAAUD,EAAQE,MAAMJ,GAC9B,OAAIG,EACKA,EAAQ,GAGVD,CACT,CAkDA,MAAMG,EAAiB,CACrB,iDACA,0CACA,0CACA,8DACA,2CACA,2CACA,yCACA,yCACA,wDAGF,SAASC,EAAWC,GAClB,GAAIA,EAAc,CAChB,MAAMvB,EAAWjH,MAAMC,QAAQuI,GAAgBA,EAAe,CAACA,GAEzDC,EAAc,GACpB,IAAA,MAAWvB,KAAWD,EACJ,mDAAZC,GACFuB,EAAY1D,KAAK,mDAEyB,IAAxCuD,EAAenI,QAAQ+G,IAG3BuB,EAAY1D,KAAKmC,GAGnB,GAAID,EAAStD,OACX,OAA8B,IAAvB8E,EAAY9E,OAAe8E,EAAY,GAAKA,CAEvD,CAGF,CAiBA,SAASC,EAA0BC,GACjC,IAAA,MAAWC,KAAQD,OACQ,IAAdA,EAAIC,IAAuC,OAAdD,EAAIC,WACnCD,EAAIC,GAGR,OAAAD,CACT,CAEA,IAAIE,EAAkB,EAEtB,SAASC,EACPhJ,EACAiJ,GAEM,MAAAC,EAASC,UAAWnJ,EAA6B4H,IAAM5H,EAAS,QAAU,IAAIoJ,OAEpF,OAAIF,GAAUD,EACL,GAAGC,KAAUD,IAGlBC,IAIJH,IAGO,sBAAsB/I,EAAS,WAAWiJ,EAAc,IAAIA,IAAgB,MAAMF,IAC3F,CAOA,SAASM,EACPrJ,GAOA,MAAMsJ,EAAgB,IAAKtJ,EAASuJ,UAAY,IAM5C,IAAAC,EAOG,OAXHxJ,EAASyJ,aACGH,EAAArE,KAAKjF,EAASyJ,aAI1BvJ,MAAMC,QAAQH,EAASwJ,YACZA,EAAAxJ,EAASwJ,WAAWnH,IAAIgF,GAC5BrH,EAASwJ,aACLA,EAAAnC,EAAarH,EAASwJ,aAG9B,CACL,WAAYxJ,EAAS,YAAcyI,EAAWzI,EAAS,kBAAe,EACtE4H,IAAK5H,EAAS,QAAUgJ,EAAsBhJ,IAAWoJ,OACzDtB,KAAMH,EAAW3H,GACjBuJ,SAAUD,EAAczF,OAASyF,OAAgB,EAEjDI,OAAQ1J,EAAS0J,OAAS1J,EAAS0J,YAAS,EAC5CC,MAAO3J,EAAS2J,MAAQ3J,EAAS2J,WAAQ,EACzCH,aACAI,iBAAkB5J,EAAS4J,iBAC3BtJ,QAASN,EAASM,QAClBC,OAAQP,EAASO,OAASP,EAASO,YAAS,EAC5CsJ,cAAU,EACVC,cAAU,EAEd,CAEA,SAASC,EACP/J,GAIA,MAAOgK,EAAQC,GApKjB,SACE5B,EACA6B,EAAe,iBACfrD,EAAO,QAEP,IAAImD,EAAwD,KAC5D,MAAMG,EAA4D,GAE5DC,EAAclK,MAAMC,QAAQkI,GAAWA,EAAU,CAACA,GAExD,IAAA,MAAWgC,KAAcD,EAAa,CACpC,MAAME,EAAgBD,EAAajC,EAAeiC,QAAc,GAG9DC,QACCA,EAAcjK,QAAQ,yBACvB,IADwDiK,EAAcjK,QAAQ,wBAS5EiK,GACFH,EAASlF,KAAK,CACZsF,MAAO,CAAE1D,CAACA,GAAO,CAACqD,IAClBM,MAAO,CAAE3D,CAACA,GAAO,CAACyD,MATTN,EADPM,EAAc9C,WAAW,YAClB,UAAU8C,EAAc7C,MAAM,KAE9B6C,CAUf,CAEO,MAAA,CAACN,EAAQG,EAClB,CAmIkCM,CAAWzK,EAASqI,SAC9CqC,EAAc,IAAK1K,EAASmK,UA9FlCA,EA8F6DnK,EAASmK,SA5FjEA,EAIEA,EAAS9H,KAAKqC,IACZ,CACL6F,MAAOhE,EAAuB7B,EAAK6F,OACnCC,MAAOjE,EAAuB7B,EAAK8F,WAN9B,IA2FyE,MAAQP,GA/F5F,IACEE,EAgGO,MAAA,CACLH,SACAG,SAAUO,EAAY7G,OAAS6G,OAAc,EAC7CH,MAAOvK,EAASuK,MAAQhE,EAAuBvG,EAASuK,YAAS,EACjEI,kBAAmB3K,EAAS4K,YACxB,CACEL,MAAOhE,EAAuBD,GAC9BkE,MAAOjE,EAAuBvG,EAAS4K,mBAEzC,EACJC,QAAS7K,EAAS6K,QAClBC,QAAS9K,EAAS+K,YAAcxE,EAAuBvG,EAAS+K,kBAAe,EAC/E7F,UAAWlF,EAASkF,UAExB,CAEA,SAAS8F,EAAYhL,GACf,IAACA,EAAS4F,OACL,OAGH,MAAAqF,EAAmB/K,MAAMC,QAAQH,EAAS4F,QAAU5F,EAAS4F,OAAS,CAAC5F,EAAS4F,QAChFsF,EAA0D,GAEhE,IAAA,MAAWtF,KAAUqF,EACf,GAAkB,iBAAXrF,GACT,GAAIA,GAEK,gBADC5F,EAAS,SAEbkL,EAAajG,KAAK,CAAE2C,GAAIhC,EAAQkC,KAAM,oBAKlClC,EAAe,QACzBsF,EAAajG,KAAK,CAChB2C,GAAKhC,EAAe,OACpBkC,KAAMH,EAAW/B,KAOhB,OAAAsF,EAAarH,OAASqH,OAAe,CAC9C,CAEA,SAASC,EAAkBnL,GAGzB,MAAMwF,EAAUxF,EAASwF,QAAWtF,MAAMC,QAAQH,EAASwF,SAAWxF,EAASwF,QAAU,CAACxF,EAASwF,SAAY,GACzGhE,EAAQxB,EAAS8F,aAEhB,MAAA,CACLsF,SACEpL,EAASmF,MAAQK,EAAQ3B,OACrB,CACE,CACE+D,GAAItB,EACJwB,KAAM,QACNuD,SAAU7F,EAAQ3B,OAAS,CAAC2B,EAAQ,SAAa,EACjDL,KAAMnF,EAASmF,KAAQjF,MAAMC,QAAQH,EAASmF,MAAQnF,EAASmF,KAAO,CAACnF,EAASmF,WAAS,EACzFoF,MAAOhE,EAAuBD,UAGlC,EACNgF,OAAQN,EAAYhL,GACpB0F,UAAW1F,EAAS0F,UACpBC,QAAS3F,EAAS2F,QAClB4F,MAAOvL,EAAS6F,YAChBtE,QAASvB,EAASuB,SC5dSiK,ED4daxL,EAASuB,QC3d/CrB,MAAMC,QAAQqL,GACTA,EAEF,CAACA,SDwd6D,EACnEC,cAAejK,EAAQ,CAACA,QAAgB,GC7drC,IAAwBgK,CD+d/B,CAqKA,SAASE,EAAuBC,GAC9B,MAAMvK,EAAkBuK,EAExB,OAAO/C,EAA0B,IAC3BS,EAAoBjI,MACpB2I,EAAsB3I,MACtB+J,EAAkB/J,OAxKSpB,EAyKDoB,EAxKzB,CACLwK,MAAO5L,EAAS4L,MAChBrL,OAAQP,EAASO,OAASP,EAASO,YAAS,EAC5CqG,SAAU5G,EAAS4G,aAJvB,IAAmC5G,CA2KnC,CAuEa,MAAA6L,EAAmB,IAAIrL,EAYjC,CACDM,WAAY,CAvPd,SAA2BA,GACzB,OAAO8H,EAA0B,IAC5BS,EAAoBvI,MACpBiJ,EAAgGjJ,MAChGqK,EAAkBrK,GACrBgL,MAAOhL,EAAWqB,SAEtB,GAiPEpB,SAAU,CAvOZ,SAAyBA,GACvB,MAAMgL,EAAc,GACdxC,EAAW,GACjB,IAAA,MAAWrI,KAAYH,EAAS6B,WAAa,GACvC1B,EAASgC,SAASW,QACRkI,EAAA9G,QAAQ/D,EAASgC,UAE3BhC,EAASqI,UACFA,EAAAtE,QAAQ/D,EAASqI,UAKxB,MAAAyC,EAAY3C,EAAoBtI,GAStC,OARIwI,EAAS1F,SACPmI,EAAUzC,SACFyC,EAAAzC,SAAStE,QAAQsE,GAE3ByC,EAAUzC,SAAWA,GAIlBX,EAA0B,IAC5BoD,KACAjC,EAAsBhJ,MACtBoK,EAAkBpK,GACrB+K,MAAOC,EACPjJ,WAAY/B,EAAS+B,YAEzB,GA2ME9B,OAAQ,CAzMV,SAAuBA,GACrB,OAAO4H,EAA0B,IAC5BS,EAAoBrI,MACpB+I,EAAsB/I,MACtBmK,EAAkBnK,GACrBiL,YAAajL,EAAOwC,cAAgBxC,EAAOwC,aAAaK,OAAU7C,EAAOwC,kBAAyB,EAClGsI,MACE9K,EAAOqC,QAAUrC,EAAOqC,OAAOQ,OAC3B,CACE,CACE+D,GAAIoB,EAAsBhI,EAAQ,mBAClC8G,KAAM,iBACNgE,MAAO9K,EAAOqC,cAGlB,GAEV,GAyLEpC,eAAgB,CAvLlB,SAA+BiL,GAC7B,OAAOtD,EAA0B,IAC3BS,EAAoB6C,MACpBnC,EAAsBmC,MACtBf,EAAkBe,GACtBJ,MAAOI,EAAelI,WAAakI,EAAelI,UAAUH,OAAUqI,EAAelI,eAAoB,GAE7G,GAiLE9C,SAAU,CA/KZ,SAAyBA,GAsBvB,OAAKA,EAASgC,UAAyC,IAA7BhC,EAASgC,SAASW,OAQrC,CACLX,SAAUhC,EAASgC,SACnBqG,SAAUrI,EAASuI,YAAc,CAACvI,EAASuI,aAAe,IATnD,CACLvG,SAAU,GACVqG,SAAU,GAShB,GA8IEpI,WAAY,CA5Id,SAA2BA,GA8BzB,OAAOyH,EAA0B,IAC3BS,EAAoBlI,MACpB4I,EAAsB5I,MACtBgK,EAAkBhK,GACtBgL,OAjCF,SAASC,EAAcD,GACjB,GAAAjM,MAAMC,QAAQgM,GAAS,CACrB,GAAAA,EAAOtI,OAAS,EAClB,MAAO,CAAEiE,KAAM,OAAQgE,MAAOK,EAAO9J,IAAI+J,IAE3CD,EAASA,EAAO,EAClB,CACI,GAAkB,iBAAXA,EACF,OAAAhD,UAAUgD,GAAQ/C,OAAK,GACrB,UAAW+C,EAAQ,CACxB,IAAAE,EACA,GAAuB,iBAAhBF,EAAOG,KAChBD,EAASF,EAAOG,UACP,GAAyB,kBAAzBH,EAAOG,KAAK,SACrBD,EAAS,CAAEzE,GAAIuE,EAAOG,KAAK,OAAQxE,KAAM,aAChC,IAAyB,cAAzBqE,EAAOG,KAAK,SAGrB,MAAM,IAAIrM,MAAM,0CAA0CkM,EAAOG,KAAK,YAFtED,EAAS,CAAEzE,GAAIuE,EAAOG,KAAK,OAAQxE,KAAM,SAG3C,CACO,MAAA,CACLA,KAAM,mBACNuE,SACAE,SAAUC,EAAgBL,EAAOI,UACnC,CAEA,OAAOpD,UAAUgD,EAAO,QAAQ/C,MAEpC,CAKUgD,CAAcjL,EAAWiD,IACjCqI,KAAMvM,MAAMC,QAAQgB,EAAWnB,UAC3BmB,EAAWnB,SAASqC,IAAIqJ,GACxBA,EAAuBvK,EAAWnB,WAG1C,GAqGEoB,gBAAiB,CAACsK,GAClBrK,OAAQ,CAzFV,SAAuBA,GACrB,MAAMyK,EAAQ,GAUP,OARHzK,EAAOoD,SAA8B,YAAnBpD,EAAOoD,SACrBqH,EAAA7G,KAAK5D,EAAOoD,SAGhBpD,EAAOqD,MAAwB,YAAhBrD,EAAOqD,MAClBoH,EAAA7G,QAAQ5D,EAAOqD,MAGhB,IACF2E,EAAoBhI,MACpB0I,EAAsB1I,GACzByK,QAEJ,GA0EExK,MAAO,CAxET,SAAsBA,GAMpB,OAAOsH,EAA0B,IAC5BS,EAAoB/H,MACpByI,EAAsBzI,MACtB6J,EAAkB7J,GACrBwK,MAAOxK,EAAMa,SAEjB,GA6DEZ,QAAS,CA3DX,SAAwBA,GAChB,MAAE,MAAOqG,EAAI,QAASE,EAAM,WAAYV,EAAA9G,QAASA,KAAYoM,GAAoBnL,EAEjFoL,EAAkB,CAAA,EAoBxB,OAlBI/E,IACF+E,EAAW,OAAS/E,GAGX+E,EAAA,SAAWhF,EAAWpG,GAEL,YAAxBoL,EAAW,WAETvF,GAAWA,EAAQvD,SACrB8I,EAAW,YAAcvF,GAE3BuF,EAAW,SAAW,WAGpBrM,IACSqM,EAAArM,QAAUwG,EAAWxG,IAG3BsI,EAA0B,IAC5B+D,KACAD,GAEP,GAiCElL,MAAO,CA/BT,SAAsBA,GACpB,OAAOoH,EAA0B,IAC5BS,EAAoB7H,MACpBuI,EAAsBvI,MACtB2J,EAAkB3J,IAEzB,KA2CA,SAASgL,EACPD,GAMA,IAHIrM,MAAMC,QAAQoM,EAAS,WAAaA,EAAS,SAASK,SAAS,mBAC1C,kBAArBL,EAAS,YACV,UAAWA,GAAY,UAAWA,GAE5B,MAAA,CACLzE,KAAM,cACN0C,MAAO,UAAW+B,EAAWA,EAASX,MAAQW,EAAS/B,OAGvD,GAAsB,wBAAtB+B,EAAS,SACJ,MAAA,CACLzE,KAAM,mBACN0C,MAAO+B,EAAS/B,OAGhB,GAAsB,cAAtB+B,EAAS,SACJ,MAAA,CACLC,EAAgBD,EAAS9H,aACpBvE,MAAMC,QAAQoM,EAAS7H,MAAQ6H,EAAS7H,KAAO,CAAC6H,EAAS7H,OAAOrC,IACnEmK,IAIF,GAAqB,yBAArBD,EAAS,SACJ,MAAA,CACLzE,KAAM,mBACN+E,OAAQ,WAAYN,EAAWA,EAASM,YAAS,EACjDC,SAAU,aAAcP,EAAWA,EAASO,cAAW,GAG3D,MAAM,IAAI7M,MAAM,8BAA8BsM,EAAS,WACzD,kFAlDO,SAA8BQ,GACnC,OACGA,GACCA,EAAO,cACiB,mDAAvBA,EAAO,cAGN,IAFAA,EAAO,YAAY1M,QAAQ,mDAEJ,iDAAvB0M,EAAO,cACY,4CAAvBA,EAAO,YAEAlB,EAAiBnJ,gBAAgBqK,GAEnCA,CACT"}