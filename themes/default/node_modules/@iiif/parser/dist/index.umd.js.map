{"version":3,"file":"index.umd.js","sources":["../src/presentation-2/traverse.ts","../src/shared/image-api-profiles.ts","../src/shared/ensure-array.ts","../src/presentation-2/upgrader.ts","../src/presentation-3/empty-types.ts","../src/presentation-3/traverse.ts","../src/presentation-3/normalize.ts","../src/presentation-3/serialize.ts","../src/presentation-3/serialize-presentation-2.ts","../src/presentation-3/serialize-presentation-3.ts","../src/index.umd.ts"],"sourcesContent":["import {\n  Annotation,\n  AnnotationList,\n  Canvas,\n  ChoiceEmbeddedContent,\n  Collection,\n  CommonContentResource,\n  ContentResource,\n  DescriptiveProperties,\n  Layer,\n  LinkingProperties,\n  Manifest,\n  OneOrMany,\n  Range,\n  RightsProperties,\n  Sequence,\n  Service,\n  TraversableEntityTypes,\n  Traversal,\n  TraversalMap,\n} from '@iiif/presentation-2';\n\nexport const types: TraversableEntityTypes[] = [\n  'sc:Collection',\n  'sc:Manifest',\n  'sc:Canvas',\n  'sc:AnnotationList',\n  'oa:Annotation',\n  'sc:Range',\n  'sc:Layer',\n  'sc:Sequence',\n  'oa:Choice',\n  // Opaque.\n  'Service',\n  'ContentResource',\n];\n\nexport type TraverseOptions = {\n  convertPropsToArray: boolean;\n  mergeMemberProperties: boolean;\n  allowUndefinedReturn: boolean;\n};\n\nexport function identifyResource(resource: any): TraversableEntityTypes {\n  if (typeof resource === 'undefined' || resource === null) {\n    throw new Error('Null or undefined is not a valid entity.');\n  }\n  if (Array.isArray(resource)) {\n    throw new Error('Array is not a valid entity');\n  }\n  if (typeof resource !== 'object') {\n    throw new Error(`${typeof resource} is not a valid entity`);\n  }\n\n  if (typeof resource['@type'] === 'string') {\n    const hasType = types.indexOf(resource['@type'] as any);\n    if (hasType !== -1) {\n      return types[hasType];\n    }\n  }\n\n  if (resource.profile) {\n    return 'Service';\n  }\n\n  if (resource.format) {\n    return 'ContentResource';\n  }\n\n  // Big o'l fallback.\n  if (resource['@type']) {\n    return 'ContentResource';\n  }\n\n  throw new Error('Resource type is not known');\n}\n\nexport class Traverse<\n  T extends {\n    Collection: any;\n    Manifest: any;\n    Canvas: any;\n    AnnotationList: any;\n    Sequence: any;\n    Annotation: any;\n    ContentResource: any;\n    Choice: any;\n    Range: any;\n    Service: any;\n    Layer: any;\n  } = {\n    Collection: Collection;\n    Manifest: Manifest;\n    Canvas: Canvas;\n    AnnotationList: AnnotationList;\n    Sequence: Sequence;\n    Annotation: Annotation;\n    ContentResource: CommonContentResource;\n    Choice: ChoiceEmbeddedContent;\n    Range: Range;\n    Service: Service;\n    Layer: Layer;\n  }\n> {\n  private traversals: Required<TraversalMap>;\n  private options: TraverseOptions;\n\n  constructor(traversals: Partial<TraversalMap>, options: Partial<TraverseOptions> = {}) {\n    this.traversals = {\n      collection: [],\n      manifest: [],\n      canvas: [],\n      annotationList: [],\n      sequence: [],\n      annotation: [],\n      contentResource: [],\n      choice: [],\n      range: [],\n      service: [],\n      layer: [],\n      ...traversals,\n    };\n    this.options = {\n      convertPropsToArray: true,\n      mergeMemberProperties: true,\n      allowUndefinedReturn: false,\n      ...options,\n    };\n  }\n\n  static all(traversal: (resource: any) => any) {\n    return new Traverse({\n      collection: [traversal],\n      manifest: [traversal],\n      canvas: [traversal],\n      annotationList: [traversal],\n      sequence: [traversal],\n      annotation: [traversal],\n      contentResource: [traversal],\n      choice: [traversal],\n      range: [traversal],\n      service: [traversal],\n      layer: [traversal],\n    });\n  }\n\n  traverseCollection(collection: Collection): T['Collection'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseCollectionItems(collection))),\n      this.traversals.collection\n    );\n  }\n\n  traverseCollectionItems(collection: Collection): Collection {\n    if (this.options.mergeMemberProperties) {\n      const members = [\n        ...(collection.manifests || []).map((manifest) => {\n          if (typeof manifest === 'string') {\n            return { '@id': manifest, '@type': 'sc:Manifest' };\n          }\n          return manifest;\n        }),\n        ...(collection.collections || []).map((subCollection) => {\n          if (typeof subCollection === 'string') {\n            return { '@id': subCollection, '@type': 'sc:Collection' };\n          }\n          return subCollection;\n        }),\n        ...(collection.members || []),\n      ];\n\n      delete collection.collections;\n      delete collection.manifests;\n      collection.members = members;\n    }\n\n    if (collection.manifests) {\n      collection.manifests = collection.manifests.map((manifest) =>\n        this.traverseManifest(\n          typeof manifest === 'string'\n            ? ({ '@id': manifest, '@type': 'sc:Manifest' } as Manifest)\n            : (manifest as Manifest)\n        )\n      );\n    }\n\n    if (collection.collections) {\n      collection.collections = collection.collections.map((subCollection) =>\n        this.traverseCollection(\n          typeof subCollection === 'string'\n            ? ({ '@id': subCollection, '@type': 'sc:Collection' } as Collection)\n            : (subCollection as Collection)\n        )\n      );\n    }\n\n    if (collection.members) {\n      collection.members = collection.members.map((member) => {\n        if (typeof member === 'string') {\n          return member;\n        }\n        return this.traverseUnknown(member);\n      });\n    }\n\n    return collection;\n  }\n\n  traverseManifest(manifest: Manifest): T['Manifest'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(manifest))),\n      this.traversals.manifest\n    );\n  }\n\n  traverseManifestItems(manifest: Manifest): Manifest {\n    if (manifest.sequences) {\n      manifest.sequences = manifest.sequences.map((sequence) => this.traverseSequence(sequence));\n    }\n    if (manifest.structures) {\n      manifest.structures = manifest.structures.map((structure) => this.traverseRange(structure));\n    }\n    return manifest;\n  }\n\n  traverseSequence(sequence: Sequence): T['Sequence'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseSequenceItems(sequence))),\n      this.traversals.sequence\n    );\n  }\n\n  traverseSequenceItems(sequence: Sequence): Sequence {\n    if (sequence.canvases) {\n      sequence.canvases = sequence.canvases.map((canvas) => this.traverseCanvas(canvas));\n    }\n    return sequence;\n  }\n\n  traverseCanvas(canvas: Canvas): T['Canvas'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(canvas))),\n      this.traversals.canvas\n    );\n  }\n\n  traverseCanvasItems(canvas: Canvas): Canvas {\n    if (canvas.images) {\n      canvas.images = canvas.images.map((image) => this.traverseAnnotation(image));\n    }\n    if (canvas.otherContent) {\n      canvas.otherContent = canvas.otherContent.map((annotationList) => this.traverseAnnotationList(annotationList));\n    }\n    return canvas;\n  }\n\n  traverseRange(range: Range): T['Range'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseRangeItems(range))),\n      this.traversals.range\n    );\n  }\n\n  traverseRangeItems(range: Range): Range {\n    if (this.options.mergeMemberProperties) {\n      const members = [\n        ...(range.ranges || []).map((innerRange: any) => {\n          if (typeof innerRange === 'string') {\n            return { '@id': innerRange, '@type': 'sc:Range' };\n          }\n          return innerRange;\n        }),\n        ...(range.canvases || []).map((canvas: any) => {\n          if (typeof canvas === 'string') {\n            return { '@id': canvas, '@type': 'sc:Canvas' };\n          }\n          return canvas;\n        }),\n        ...(range.members || []),\n      ];\n\n      delete range.ranges;\n      delete range.canvases;\n      range.members = members.length ? members.map((member) => this.traverseUnknown(member)) : undefined;\n    }\n    return range;\n  }\n\n  traverseAnnotationList(annotationList: AnnotationList): T['AnnotationList'] {\n    const list =\n      typeof annotationList === 'string'\n        ? ({ '@id': annotationList, '@type': 'sc:AnnotationList' } as any)\n        : annotationList;\n\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseAnnotationListItems(list)),\n      this.traversals.annotationList\n    );\n  }\n\n  traverseAnnotationListItems(annotationList: AnnotationList): AnnotationList {\n    if (annotationList.resources) {\n      annotationList.resources = annotationList.resources.map((annotation) => this.traverseAnnotation(annotation));\n    }\n\n    return annotationList;\n  }\n\n  traverseAnnotation(annotation: Annotation): T['Annotation'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationItems(annotation))),\n      this.traversals.annotation\n    );\n  }\n\n  traverseAnnotationItems(annotation: Annotation): Annotation {\n    if (annotation.resource) {\n      if (Array.isArray(annotation.resource)) {\n        annotation.resource = annotation.resource.map((res) =>\n          this.traverseContentResource(res as CommonContentResource)\n        );\n      } else {\n        annotation.resource = this.traverseContentResource(annotation.resource as CommonContentResource);\n      }\n    }\n\n    if (annotation.on) {\n      // selector - just traverse the annotations.\n      // annotation.on = this.traverseSelector(annotation.on);\n    }\n\n    return annotation;\n  }\n\n  traverseLayer(layer: Layer): T['Layer'] {\n    return this.traverseType(this.traverseLinking(this.traverseLayerItems(layer)), this.traversals.layer);\n  }\n\n  traverseLayerItems(layer: Layer): Layer {\n    if (layer.otherContent) {\n      layer.otherContent = layer.otherContent.map((annotationList) => this.traverseAnnotationList(annotationList));\n    }\n    return layer;\n  }\n\n  traverseChoice(choice: ChoiceEmbeddedContent): T['Choice'] {\n    return this.traverseType(this.traverseChoiceItems(choice), this.traversals.choice);\n  }\n\n  traverseChoiceItems(choice: ChoiceEmbeddedContent) {\n    if (choice.default && choice.default !== 'rdf:nil') {\n      choice.default = this.traverseContentResource(choice.default);\n    }\n    if (choice.item && choice.item !== 'rdf:nil') {\n      choice.item = choice.item.map((item) => this.traverseContentResource(item));\n    }\n\n    return choice;\n  }\n\n  traverseService(service: Service): T['Service'] {\n    return this.traverseType(this.traverseLinking(service as any), this.traversals.service);\n  }\n\n  traverseContentResource(contentResource: CommonContentResource): T['ContentResource'] {\n    if (contentResource['@type'] === 'oa:Choice') {\n      return this.traverseChoice(contentResource as any);\n    }\n\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(contentResource as any)),\n      this.traversals.contentResource\n    );\n  }\n\n  traverseUnknown(item: any) {\n    if (!item['@type'] || typeof item === 'string') {\n      // Unknown item.\n      return item;\n    }\n    switch (identifyResource(item)) {\n      case 'sc:Collection':\n        return this.traverseCollection(item);\n      case 'sc:Manifest':\n        return this.traverseManifest(item);\n      case 'sc:Canvas':\n        return this.traverseCanvas(item);\n      case 'sc:Sequence':\n        return this.traverseSequence(item);\n      case 'sc:Range':\n        return this.traverseRange(item);\n      case 'oa:Annotation':\n        return this.traverseAnnotation(item);\n      case 'sc:AnnotationList':\n        return this.traverseAnnotationList(item);\n      case 'sc:Layer':\n        return this.traverseLayer(item);\n      case 'Service':\n        return this.traverseService(item);\n      case 'oa:Choice':\n        return this.traverseChoice(item);\n      case 'ContentResource':\n        return this.traverseContentResource(item);\n    }\n\n    if (item.profile) {\n      return this.traverseService(item);\n    }\n\n    return item;\n  }\n\n  traverseImageResource(contentResource: OneOrMany<string | ContentResource>) {\n    const wasArray = Array.isArray(contentResource);\n    const resourceList = Array.isArray(contentResource) ? contentResource : [contentResource];\n    const newResourceList: any[] = [];\n\n    for (const singleResource of resourceList) {\n      if (typeof singleResource === 'string') {\n        newResourceList.push(\n          this.traverseContentResource({\n            '@id': singleResource,\n            '@type': 'dctypes:Image',\n          })\n        );\n      } else {\n        newResourceList.push(this.traverseContentResource(singleResource as any));\n      }\n    }\n\n    if (!wasArray && !this.options.convertPropsToArray) {\n      return newResourceList[0];\n    }\n\n    return newResourceList;\n  }\n\n  traverseDescriptive<T extends Partial<DescriptiveProperties & RightsProperties>>(resource: T) {\n    if (resource.thumbnail) {\n      resource.thumbnail = this.traverseImageResource(resource.thumbnail);\n    }\n\n    if (resource.logo) {\n      resource.logo = this.traverseImageResource(resource.logo);\n    }\n\n    return resource;\n  }\n\n  traverseOneOrMoreServices(allServices: OneOrMany<any>) {\n    const wasArray = Array.isArray(allServices);\n    const services = Array.isArray(allServices) ? allServices : [allServices];\n    const newServices = [];\n    for (const service of services) {\n      newServices.push(this.traverseService(service));\n    }\n\n    if (!wasArray && !this.options.convertPropsToArray) {\n      return newServices[0];\n    }\n\n    return newServices;\n  }\n\n  traverseLinking<T extends Partial<LinkingProperties>>(resource: T) {\n    if (resource.related) {\n      resource.related = this.traverseOneOrManyType(resource.related, this.traversals.contentResource);\n    }\n    if (resource.rendering) {\n      resource.rendering = this.traverseOneOrManyType(resource.rendering, this.traversals.contentResource);\n    }\n    if (resource.service) {\n      resource.service = this.traverseOneOrMoreServices(resource.service);\n    }\n    if (resource.seeAlso) {\n      resource.seeAlso = this.traverseOneOrManyType(resource.seeAlso, this.traversals.contentResource);\n    }\n    if (resource.within) {\n      if (typeof resource.within === 'string') {\n        // I don't know. skip?\n      } else {\n        resource.within = this.traverseOneOrManyType(\n          resource.within as CommonContentResource,\n          this.traversals.contentResource\n        );\n      }\n    }\n    if (resource.startCanvas) {\n      if (typeof resource.startCanvas === 'string') {\n        resource.startCanvas = this.traverseType(\n          { '@id': resource.startCanvas, '@type': 'sc:Canvas' } as Canvas,\n          this.traversals.canvas\n        );\n      } else if (resource.startCanvas) {\n        this.traverseType(resource.startCanvas as any, this.traversals.canvas);\n      }\n    }\n    if (resource.contentLayer) {\n      if (typeof resource.contentLayer === 'string') {\n        resource.contentLayer = this.traverseLayer({\n          '@id': resource.contentLayer,\n          '@type': 'sc:Layer',\n        });\n      } else {\n        resource.contentLayer = this.traverseLayer(resource.contentLayer);\n      }\n    }\n    return resource;\n  }\n\n  traverseOneOrManyType<T, Return = T>(object: T | T[], traversals: Array<Traversal<T>>): Return {\n    if (!Array.isArray(object)) {\n      if (this.options.convertPropsToArray) {\n        object = [object] as T[];\n      } else {\n        return this.traverseType(object, traversals);\n      }\n    }\n    return object.map((singleObj) => this.traverseType(singleObj, traversals)) as any;\n  }\n\n  traverseType<T, Return = T>(object: T, traversals: Array<Traversal<T>>): Return {\n    return traversals.reduce((acc: T, traversal: Traversal<T>): T => {\n      const returnValue = traversal(acc);\n      if (typeof returnValue === 'undefined' && !this.options.allowUndefinedReturn) {\n        return acc;\n      }\n      return returnValue;\n    }, object) as any;\n  }\n}\n","export const STANFORD_IIIF_IMAGE_COMPLIANCE_0 = 'http://library.stanford.edu/iiif/image-api/compliance.html#level0';\nexport const STANFORD_IIIF_IMAGE_COMPLIANCE_1 = 'http://library.stanford.edu/iiif/image-api/compliance.html#level1';\nexport const STANFORD_IIIF_IMAGE_COMPLIANCE_2 = 'http://library.stanford.edu/iiif/image-api/compliance.html#level2';\nexport const STANFORD_IIIF_IMAGE_CONFORMANCE_0 = 'http://library.stanford.edu/iiif/image-api/conformance.html#level0';\nexport const STANFORD_IIIF_IMAGE_CONFORMANCE_1 = 'http://library.stanford.edu/iiif/image-api/conformance.html#level1';\nexport const STANFORD_IIIF_IMAGE_CONFORMANCE_2 = 'http://library.stanford.edu/iiif/image-api/conformance.html#level2';\nexport const STANFORD_IIIF_1_IMAGE_COMPLIANCE_0 =\n  'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0';\nexport const STANFORD_IIIF_1_IMAGE_COMPLIANCE_1 =\n  'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1';\nexport const STANFORD_IIIF_1_IMAGE_COMPLIANCE_2 =\n  'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2';\nexport const STANFORD_IIIF_1_IMAGE_CONFORMANCE_0 =\n  'http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0';\nexport const STANFORD_IIIF_1_IMAGE_CONFORMANCE_1 =\n  'http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1';\nexport const STANFORD_IIIF_1_IMAGE_CONFORMANCE_2 =\n  'http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2';\nexport const IIIF_1_IMAGE_LEVEL_0 = 'http://iiif.io/api/image/1/level0.json';\nexport const IIIF_1_IMAGE_LEVEL_0_PROFILE = 'http://iiif.io/api/image/1/profiles/level0.json';\nexport const IIIF_1_IMAGE_LEVEL_1 = 'http://iiif.io/api/image/1/level1.json';\nexport const IIIF_1_IMAGE_LEVEL_1_PROFILE = 'http://iiif.io/api/image/1/profiles/level1.json';\nexport const IIIF_1_IMAGE_LEVEL_2 = 'http://iiif.io/api/image/1/level2.json';\nexport const IIIF_1_IMAGE_LEVEL_2_PROFILE = 'http://iiif.io/api/image/1/profiles/level2.json';\nexport const IIIF_2_IMAGE_LEVEL_0 = 'http://iiif.io/api/image/2/level0.json';\nexport const IIIF_2_IMAGE_LEVEL_0_PROFILE = 'http://iiif.io/api/image/2/profiles/level0.json';\nexport const IIIF_2_IMAGE_LEVEL_1 = 'http://iiif.io/api/image/2/level1.json';\nexport const IIIF_2_IMAGE_LEVEL_1_PROFILE = 'http://iiif.io/api/image/2/profiles/level1.json';\nexport const IIIF_2_IMAGE_LEVEL_2 = 'http://iiif.io/api/image/2/level2.json';\nexport const IIIF_2_IMAGE_LEVEL_2_PROFILE = 'http://iiif.io/api/image/2/profiles/level2.json';\nexport const IIIF_3_IMAGE_LEVEL_0 = 'level0';\nexport const IIIF_3_IMAGE_LEVEL_1 = 'level1';\nexport const IIIF_3_IMAGE_LEVEL_2 = 'level2';\n\n// Non-standard\nexport const IIIF_2_IMAGE_LEVEL_0_NO_JSON = 'http://iiif.io/api/image/2/level0';\nexport const IIIF_2_IMAGE_LEVEL_1_NO_JSON = 'http://iiif.io/api/image/2/level1';\nexport const IIIF_2_IMAGE_LEVEL_2_NO_JSON = 'http://iiif.io/api/image/2/level2';\n\nexport const level1Support = [\n  IIIF_2_IMAGE_LEVEL_1_NO_JSON,\n  IIIF_2_IMAGE_LEVEL_2_NO_JSON,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_2,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_2,\n  IIIF_1_IMAGE_LEVEL_1,\n  IIIF_1_IMAGE_LEVEL_1_PROFILE,\n  IIIF_1_IMAGE_LEVEL_2,\n  IIIF_1_IMAGE_LEVEL_2_PROFILE,\n  IIIF_2_IMAGE_LEVEL_1,\n  IIIF_2_IMAGE_LEVEL_1_PROFILE,\n  IIIF_2_IMAGE_LEVEL_2,\n  IIIF_2_IMAGE_LEVEL_2_PROFILE,\n  IIIF_3_IMAGE_LEVEL_1,\n  IIIF_3_IMAGE_LEVEL_2,\n];\n\nexport const imageServiceProfiles = [\n  IIIF_2_IMAGE_LEVEL_0_NO_JSON,\n  IIIF_2_IMAGE_LEVEL_1_NO_JSON,\n  IIIF_2_IMAGE_LEVEL_2_NO_JSON,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_0,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_0,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_2,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_0,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_0,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_2,\n  IIIF_1_IMAGE_LEVEL_0,\n  IIIF_1_IMAGE_LEVEL_0_PROFILE,\n  IIIF_1_IMAGE_LEVEL_1,\n  IIIF_1_IMAGE_LEVEL_1_PROFILE,\n  IIIF_1_IMAGE_LEVEL_2,\n  IIIF_1_IMAGE_LEVEL_2_PROFILE,\n  IIIF_2_IMAGE_LEVEL_0,\n  IIIF_2_IMAGE_LEVEL_0_PROFILE,\n  IIIF_2_IMAGE_LEVEL_1,\n  IIIF_2_IMAGE_LEVEL_1_PROFILE,\n  IIIF_2_IMAGE_LEVEL_2,\n  IIIF_2_IMAGE_LEVEL_2_PROFILE,\n  IIIF_3_IMAGE_LEVEL_0,\n  IIIF_3_IMAGE_LEVEL_1,\n  IIIF_3_IMAGE_LEVEL_2,\n];\n","export function ensureArray<T>(maybeArray: T | T[]): T[] {\n  if (Array.isArray(maybeArray)) {\n    return maybeArray;\n  }\n  return [maybeArray];\n}\n","import * as Presentation3 from '@iiif/presentation-3';\nimport * as Presentation2 from '@iiif/presentation-2';\nimport { imageServiceProfiles, level1Support } from '../shared/image-api-profiles';\nimport { Traverse } from './traverse';\nimport { ensureArray } from '../shared/ensure-array';\n\nconst configuration = {\n  attributionLabel: 'Attribution',\n  lang: 'none',\n  providerId: 'http://example.org/provider',\n  providerName: 'Unknown',\n};\n\nexport function convertLanguageMapping(\n  inputLangProperty?: Presentation2.OneOrMany<Presentation2.LanguageProperty>,\n  defaultLang = 'none'\n): Presentation3.InternationalString {\n  if (!inputLangProperty) {\n    return {};\n  }\n\n  const arrayOfValues = Array.isArray(inputLangProperty) ? inputLangProperty : [inputLangProperty];\n\n  const languageMap: Presentation3.InternationalString = {};\n\n  for (const language of arrayOfValues) {\n    // For strings \"label\": [\"a value\"]\n    if (typeof language === 'string') {\n      languageMap[defaultLang] = languageMap[defaultLang] ? languageMap[defaultLang] : [];\n      (languageMap[defaultLang] as string[]).push(language || '');\n      continue;\n    }\n\n    // For maps without a language\n    if (!language['@language']) {\n      languageMap[defaultLang] = languageMap[defaultLang] ? languageMap[defaultLang] : [];\n      (languageMap[defaultLang] as string[]).push(language['@value'] || '');\n      continue;\n    }\n\n    // Default case with language.\n    const lang = language['@language'];\n    languageMap[lang] = languageMap[lang] ? languageMap[lang] : [];\n    (languageMap[lang] as string[]).push(language['@value'] || '');\n  }\n  return languageMap;\n}\n\nexport function getProfile(profile: any | any[]): string | undefined {\n  if (Array.isArray(profile)) {\n    return getProfile(profile.find((s) => typeof s === 'string'));\n  }\n\n  if (imageServiceProfiles.indexOf(profile) !== -1) {\n    return 'level2';\n  }\n\n  if (level1Support.indexOf(profile) !== -1) {\n    return 'level1';\n  }\n\n  if (typeof profile !== 'string') {\n    return undefined;\n  }\n\n  return profile;\n}\n\nexport function getTypeFromContext(inputContexts: string | string[]): string | undefined {\n  const contexts: string[] = Array.isArray(inputContexts) ? inputContexts : [inputContexts];\n\n  for (const context of contexts) {\n    switch (context) {\n      case 'http://iiif.io/api/image/2/context.json':\n      case 'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2':\n        return 'ImageService2';\n      case 'http://iiif.io/api/image/1/context.json':\n      case 'http://library.stanford.edu/iiif/image-api/1.1/context.json':\n        return 'ImageService1';\n      case 'http://iiif.io/api/annex/openannotation/context.json':\n        return 'ImageApiSelector';\n    }\n  }\n\n  return undefined;\n}\n\nfunction getTypeFromProfile(inputProfile: string): string | undefined {\n  switch (inputProfile) {\n    case 'http://iiif.io/api/image/2/level0.json':\n    case 'http://iiif.io/api/image/2/level1.json':\n    case 'http://iiif.io/api/image/2/level2.json':\n      return 'ImageService2';\n\n    case 'http://iiif.io/api/auth/1/kiosk':\n    case 'http://iiif.io/api/auth/1/login':\n    case 'http://iiif.io/api/auth/1/clickthrough':\n    case 'http://iiif.io/api/auth/1/external':\n    case 'http://iiif.io/api/auth/0/kiosk':\n    case 'http://iiif.io/api/auth/0/login':\n    case 'http://iiif.io/api/auth/0/clickthrough':\n    case 'http://iiif.io/api/auth/0/external':\n      return 'AuthCookieService1';\n\n    case 'http://iiif.io/api/auth/1/token':\n    case 'http://iiif.io/api/auth/0/token':\n      return 'AuthTokenService1';\n    case 'http://iiif.io/api/auth/1/logout':\n    case 'http://iiif.io/api/auth/0/logout':\n      return 'AuthLogoutService1';\n\n    case 'http://iiif.io/api/search/1/search':\n    case 'http://iiif.io/api/search/0/search':\n      return 'SearchService1';\n    case 'http://iiif.io/api/search/1/autocomplete':\n    case 'http://iiif.io/api/search/0/autocomplete':\n      return 'AutoCompleteService1';\n  }\n\n  return undefined;\n}\n\nfunction removePrefix(str: string) {\n  for (const prefix of ['sc', 'oa', 'dcterms', 'dctypes', 'iiif']) {\n    if (str.startsWith(`${prefix}:`)) {\n      return str.slice(prefix.length + 1);\n    }\n  }\n\n  return str;\n}\n\nconst knownTypes = ['Collection', 'Manifest', 'Annotation', 'AnnotationPage', 'Range', 'Service'];\n\nfunction getNewType(resource: any): string {\n  const id = resource['@id'] || resource.id;\n  let oldType: string | string[] = resource['@type'] || resource.type;\n  const profile: any = resource.profile || undefined;\n  const context: any = resource['@context'] || undefined;\n\n  if (profile) {\n    const possibleType = getTypeFromProfile(profile);\n    if (possibleType) {\n      return possibleType;\n    }\n  }\n\n  if (context) {\n    const possibleType = getTypeFromContext(context);\n    if (possibleType) {\n      return possibleType;\n    }\n  }\n\n  if (oldType) {\n    if (Array.isArray(oldType)) {\n      if (oldType.indexOf('oa:CssStylesheet') !== -1) {\n        return 'CssStylesheet';\n      }\n      if (oldType.indexOf('cnt:ContentAsText') !== -1) {\n        return 'TextualBody';\n      }\n      // Nothing we can do?\n      oldType = oldType[0];\n    }\n\n    for (const prefix of ['sc', 'oa', 'dcterms', 'dctypes', 'iiif']) {\n      if (oldType.startsWith(`${prefix}:`)) {\n        oldType = oldType.slice(prefix.length + 1);\n        break;\n      }\n    }\n\n    switch (oldType) {\n      case 'Layer':\n        return 'AnnotationCollection';\n      case 'AnnotationList':\n        return 'AnnotationPage';\n      case 'cnt:ContentAsText':\n        return 'TextualBody';\n      // @todo There are definitely some missing annotation types here.\n    }\n  }\n\n  if (oldType && knownTypes.indexOf(oldType) !== -1) {\n    return oldType;\n  }\n\n  if (resource.format) {\n    if (resource.format.startsWith('image/')) {\n      return 'Image';\n    }\n    if (resource.format.startsWith('text/')) {\n      return 'Text';\n    }\n    if (resource.format === 'application/pdf') {\n      return 'Text';\n    }\n    if (resource.format.startsWith('application/')) {\n      return 'Dataset';\n    }\n  }\n\n  if (id && (id.endsWith('.jpg') || id.endsWith('.png') || id.endsWith('.jpeg'))) {\n    return 'Image';\n  }\n\n  if (!oldType) {\n    return 'unknown';\n  }\n\n  // Again, nothing we can do.\n  return oldType as string;\n}\n\nconst licenseRegex = /http(s)?:\\/\\/(creativecommons.org|rightsstatements.org)[^\"'\\\\<\\n]+/gm;\n\nfunction extractLicense(license: string) {\n  const matches = license.match(licenseRegex);\n  if (matches) {\n    return matches[0];\n  }\n\n  return license;\n}\n\nasync function getContentTypeOfRemoteResource(resourceId: string): Promise<string | undefined> {\n  try {\n    const response = await fetch(resourceId, { method: 'HEAD' });\n    const headers = response.headers;\n\n    return headers.get('content-type') || undefined;\n  } catch (e) {\n    // do nothing.\n  }\n\n  return undefined;\n}\n\nfunction fixLicense(\n  license: Presentation2.RightsProperties['license'],\n  licenseLabel = 'Rights/License',\n  lang = 'none'\n): [Presentation3.DescriptiveProperties['rights'], Presentation3.DescriptiveProperties['metadata']] {\n  let rights: Presentation3.DescriptiveProperties['rights'] = null;\n  const metadata: Presentation3.DescriptiveProperties['metadata'] = [];\n\n  const licenseList = Array.isArray(license) ? license : [license];\n\n  for (const rawLicense of licenseList) {\n    const singleLicense = rawLicense ? extractLicense(rawLicense) : undefined;\n\n    if (\n      singleLicense &&\n      (singleLicense.indexOf('creativecommons.org') !== -1 || singleLicense.indexOf('rightsstatements.org') !== -1)\n    ) {\n      if (singleLicense.startsWith('https://')) {\n        rights = `http://${singleLicense.slice(8)}`;\n      } else {\n        rights = singleLicense;\n      }\n      continue;\n    }\n    if (singleLicense) {\n      metadata.push({\n        label: { [lang]: [licenseLabel] },\n        value: { [lang]: [singleLicense] },\n      });\n    }\n  }\n\n  return [rights, metadata];\n}\n\nconst removeContexts = [\n  'http://iiif.io/api/presentation/2/context.json',\n  'http://iiif.io/api/image/2/context.json',\n  'http://iiif.io/api/image/1/context.json',\n  'http://library.stanford.edu/iiif/image-api/1.1/context.json',\n  'http://iiif.io/api/search/1/context.json',\n  'http://iiif.io/api/search/0/context.json',\n  'http://iiif.io/api/auth/1/context.json',\n  'http://iiif.io/api/auth/0/context.json',\n  'http://iiif.io/api/annex/openannotation/context.json',\n];\n\nfunction fixContext(inputContext: string | string[] | undefined): string | string[] | undefined {\n  if (inputContext) {\n    const contexts = Array.isArray(inputContext) ? inputContext : [inputContext];\n\n    const newContexts = [];\n    for (const context of contexts) {\n      if (context === 'http://iiif.io/api/presentation/2/context.json') {\n        newContexts.push('http://iiif.io/api/presentation/3/context.json');\n      }\n      if (removeContexts.indexOf(context) !== -1) {\n        continue;\n      }\n      newContexts.push(context);\n    }\n\n    if (contexts.length) {\n      return newContexts.length === 1 ? newContexts[0] : newContexts;\n    }\n  }\n\n  return undefined;\n}\n\nfunction convertMetadata(\n  metadata: Presentation2.DescriptiveProperties['metadata']\n): Presentation3.DescriptiveProperties['metadata'] {\n  if (!metadata) {\n    return [];\n  }\n\n  return metadata.map((item): Presentation3.MetadataItem => {\n    return {\n      label: convertLanguageMapping(item.label),\n      value: convertLanguageMapping(item.value),\n    };\n  });\n}\n\nfunction removeUndefinedProperties(obj: any) {\n  for (const prop in obj) {\n    if (typeof obj[prop] === 'undefined' || obj[prop] === null) {\n      delete obj[prop];\n    }\n  }\n  return obj;\n}\n\nlet mintedIdCounter = 0;\n\nfunction mintNewIdFromResource(\n  resource: Presentation3.SomeRequired<Presentation2.TechnicalProperties, '@type'>,\n  subresource?: string\n) {\n  const origId = encodeURI((resource as { id?: string }).id || resource['@id'] || '').trim();\n\n  if (origId && subresource) {\n    return `${origId}/${subresource}`;\n  }\n\n  if (origId) {\n    return origId;\n  }\n\n  mintedIdCounter++;\n\n  // @todo.\n  return `http://example.org/${resource['@type']}${subresource ? `/${subresource}` : ''}/${mintedIdCounter}`;\n}\n\n// @todo this was removed due to identifiers not being able to be used externally after upgrading.\nfunction resolveDecodedURI(uri: string) {\n  return encodeURI(decodeURIComponent(uri)).trim();\n}\n\nfunction technicalProperties<T extends Partial<Presentation3.TechnicalProperties>>(\n  resource: Presentation3.SomeRequired<Presentation2.TechnicalProperties, '@type'> & {\n    motivation?: string | string[] | null;\n    format?: string;\n    profile?: any;\n    '@context'?: string | string[] | undefined;\n  }\n) {\n  const allBehaviours = [...(resource.behavior || [])];\n\n  if (resource.viewingHint) {\n    allBehaviours.push(resource.viewingHint);\n  }\n\n  let motivation: string | string[] | undefined;\n  if (Array.isArray(resource.motivation)) {\n    motivation = resource.motivation.map(removePrefix);\n  } else if (resource.motivation) {\n    motivation = removePrefix(resource.motivation);\n  }\n\n  return {\n    '@context': resource['@context'] ? fixContext(resource['@context']) : undefined,\n    id: (resource['@id'] || mintNewIdFromResource(resource)).trim(),\n    type: getNewType(resource) as any,\n    behavior: allBehaviours.length ? allBehaviours : undefined,\n    // format: This will be an optional async post-process step.\n    height: resource.height ? resource.height : undefined,\n    width: resource.width ? resource.width : undefined,\n    motivation,\n    viewingDirection: resource.viewingDirection,\n    profile: resource.profile,\n    format: resource.format ? resource.format : undefined,\n    duration: undefined,\n    timeMode: undefined,\n  } as any;\n}\n\nfunction descriptiveProperties<T extends Partial<Presentation3.DescriptiveProperties>>(\n  resource: Presentation2.DescriptiveProperties &\n    Presentation2.RightsProperties &\n    Partial<Presentation2.TechnicalProperties>\n): T {\n  const [rights, extraMetadata] = fixLicense(resource.license);\n  const allMetadata = [...(resource.metadata ? convertMetadata(resource.metadata) : []), ...extraMetadata];\n\n  return {\n    rights,\n    metadata: allMetadata.length ? allMetadata : undefined,\n    label: resource.label ? convertLanguageMapping(resource.label) : undefined,\n    requiredStatement: resource.attribution\n      ? {\n          label: convertLanguageMapping(configuration.attributionLabel),\n          value: convertLanguageMapping(resource.attribution),\n        }\n      : undefined,\n    navDate: resource.navDate,\n    summary: resource.description ? convertLanguageMapping(resource.description) : undefined,\n    thumbnail: resource.thumbnail as any,\n  } as T;\n}\n\nfunction parseWithin(resource: Presentation2.AbstractResource): undefined | Presentation3.LinkingProperties['partOf'] {\n  if (!resource.within) {\n    return undefined;\n  }\n\n  const withinProperties = Array.isArray(resource.within) ? resource.within : [resource.within];\n  const returnPartOf: Presentation3.LinkingProperties['partOf'] = [];\n\n  for (const within of withinProperties) {\n    if (typeof within === 'string') {\n      if (within) {\n        switch (resource['@type']) {\n          case 'sc:Manifest':\n            returnPartOf.push({ id: within, type: 'Collection' });\n            break;\n          // @todo are there more cases?\n        }\n      }\n    } else if ((within as any)['@id']) {\n      returnPartOf.push({\n        id: (within as any)['@id'], // as any since content resources don't require an `@id`\n        type: getNewType(within) as any,\n      });\n    } else {\n      // Content resource.\n    }\n  }\n\n  return returnPartOf.length ? returnPartOf : undefined;\n}\n\nfunction linkingProperties(resource: Presentation2.LinkingProperties & Presentation2.RightsProperties) {\n  // @todo related links to metadata.\n\n  const related = resource.related ? (Array.isArray(resource.related) ? resource.related : [resource.related]) : [];\n  const layer = resource.contentLayer as Presentation2.Layer;\n\n  return {\n    provider:\n      resource.logo || related.length\n        ? [\n            {\n              id: configuration.providerId,\n              type: 'Agent' as const,\n              homepage: related.length ? [related[0] as any] : undefined,\n              logo: resource.logo ? (Array.isArray(resource.logo) ? resource.logo : [resource.logo]) : undefined,\n              label: convertLanguageMapping(configuration.providerName),\n            },\n          ]\n        : undefined,\n    partOf: parseWithin(resource),\n    rendering: resource.rendering,\n    seeAlso: resource.seeAlso,\n    start: resource.startCanvas as any,\n    service: resource.service ? ensureArray(resource.service as any) : undefined,\n    supplementary: layer ? [layer as any] : undefined,\n  };\n}\n\n// FIXME: Is this function really needed?\nfunction embeddedContentProperties(resource: Presentation2.CharsEmbeddedContent) {\n  return {\n    chars: resource.chars,\n    format: resource.format ? resource.format : undefined,\n    language: resource.language,\n  };\n}\n\nfunction upgradeCollection(collection: Presentation2.Collection): Presentation3.Collection {\n  return removeUndefinedProperties({\n    ...technicalProperties(collection),\n    ...descriptiveProperties<Presentation3.SomeRequired<Presentation3.CollectionDescriptive, 'label'>>(collection),\n    ...linkingProperties(collection),\n    items: collection.members as any,\n  });\n}\n\nfunction flattenArray<T>(array: T[][]): T[] {\n  const returnArr: T[] = [];\n  for (const arr of array || []) {\n    returnArr.push(...arr);\n  }\n  return returnArr;\n}\n\nfunction upgradeManifest(manifest: Presentation2.Manifest): Presentation3.Manifest {\n  const allCanvases = [];\n  const behavior = [];\n  for (const sequence of manifest.sequences || []) {\n    if (sequence.canvases.length) {\n      allCanvases.push(...sequence.canvases);\n    }\n    if (sequence.behavior) {\n      behavior.push(...sequence.behavior);\n    }\n  }\n\n  // This comes from the sequence.\n  const technical = technicalProperties(manifest);\n  if (behavior.length) {\n    if (technical.behavior) {\n      technical.behavior.push(...behavior);\n    } else {\n      technical.behavior = behavior;\n    }\n  }\n\n  return removeUndefinedProperties({\n    ...technical,\n    ...descriptiveProperties(manifest),\n    ...linkingProperties(manifest),\n    items: allCanvases,\n    structures: manifest.structures as any,\n  });\n}\n\nfunction upgradeCanvas(canvas: Presentation2.Canvas): Presentation3.Canvas {\n  return removeUndefinedProperties({\n    ...technicalProperties(canvas),\n    ...descriptiveProperties(canvas),\n    ...linkingProperties(canvas),\n    annotations: canvas.otherContent && canvas.otherContent.length ? (canvas.otherContent as any[]) : undefined,\n    items:\n      canvas.images && canvas.images.length\n        ? [\n            {\n              id: mintNewIdFromResource(canvas, 'annotation-page'),\n              type: 'AnnotationPage',\n              items: canvas.images as any,\n            },\n          ]\n        : undefined,\n  });\n}\n\nfunction upgradeAnnotationList(annotationPage: Presentation2.AnnotationList): Presentation3.AnnotationPage {\n  return removeUndefinedProperties({\n    ...(technicalProperties(annotationPage) as any),\n    ...(descriptiveProperties(annotationPage) as any),\n    ...(linkingProperties(annotationPage) as any),\n    items: annotationPage.resources && annotationPage.resources.length ? (annotationPage.resources as any) : undefined,\n  });\n}\n\nfunction upgradeSequence(sequence: Presentation2.Sequence): {\n  canvases: Presentation3.Canvas[];\n  behavior?: string[];\n} {\n  /*\n    rng = {\"id\": s.get('@id', self.mint_uri()), \"type\": \"Range\"}\n    rng['behavior'] = ['sequence']\n    rng['items'] = []\n    for c in s['canvases']:\n      if type(c) == dict:\n        rng['items'].append({\"id\": c['@id'], \"type\": \"Canvas\"})\n      elif type(c) in STR_TYPES:\n        rng['items'].append({\"id\": c, \"type\": \"Canvas\"})\n    # Copy other properties and hand off to _generic\n    del s['canvases']\n    for k in s.keys():\n      if not k in ['@id', '@type']:\n        rng[k] = s[k]\n    self.process_generic(rng)\n    what['_structures'].append(rng)\n   */\n\n  if (!sequence.canvases || sequence.canvases.length === 0) {\n    return {\n      canvases: [],\n      behavior: [],\n    };\n  }\n\n  // @todo possibly return some ranges too.\n  return {\n    canvases: sequence.canvases as any[],\n    behavior: sequence.viewingHint ? [sequence.viewingHint] : [],\n  };\n}\n\nfunction upgradeAnnotation(annotation: Presentation2.Annotation): Presentation3.Annotation {\n  function upgradeTarget(target: typeof annotation.on): Presentation3.AnnotationTarget {\n    if (Array.isArray(target)) {\n      if (target.length > 1) {\n        return { type: 'List', items: target.map(upgradeTarget) as Presentation3.Target[] };\n      }\n      target = target[0];\n    }\n    if (typeof target === 'string') {\n      return encodeURI(target).trim();\n    } else if ('@type' in target) {\n      let source: string | Presentation3.Reference<'Canvas'> | Presentation3.Reference<'Image'>;\n      if (typeof target.full === 'string') {\n        source = target.full;\n      } else if (target.full['@type'] === 'dctypes:Image') {\n        source = { id: target.full['@id'], type: 'Image' };\n      } else if (target.full['@type'] === 'sc:Canvas') {\n        source = { id: target.full['@id'], type: 'Canvas' };\n      } else {\n        throw new Error(`Unsupported source type on annotation: ${target.full['@type']}`);\n      }\n      return {\n        type: 'SpecificResource',\n        source,\n        selector: upgradeSelector(target.selector),\n      };\n    } else {\n      return encodeURI(target['@id']).trim();\n    }\n  }\n  return removeUndefinedProperties({\n    ...(technicalProperties(annotation) as any),\n    ...(descriptiveProperties(annotation) as any),\n    ...(linkingProperties(annotation) as any),\n    target: upgradeTarget(annotation.on),\n    body: Array.isArray(annotation.resource)\n      ? annotation.resource.map(upgradeContentResource)\n      : upgradeContentResource(annotation.resource),\n    // @todo stylesheet upgrade.\n  });\n}\n\nfunction upgradeContentResource(inputContentResource: Presentation2.ContentResource): Presentation3.ContentResource {\n  const contentResource = inputContentResource as Presentation2.CommonContentResource;\n  // @todo there might be some field dropped here.\n  return removeUndefinedProperties({\n    ...(technicalProperties(contentResource) as any),\n    ...(descriptiveProperties(contentResource) as any),\n    ...(linkingProperties(contentResource as any) as any),\n    ...(embeddedContentProperties(contentResource as any) as any),\n  });\n}\n\nfunction upgradeChoice(choice: Presentation2.ChoiceEmbeddedContent): Presentation3.ChoiceBody {\n  const items = [];\n\n  if (choice.default && choice.default !== 'rdf:nil') {\n    items.push(choice.default);\n  }\n\n  if (choice.item && choice.item !== 'rdf:nil') {\n    items.push(...choice.item);\n  }\n\n  return {\n    ...technicalProperties(choice),\n    ...descriptiveProperties(choice),\n    items: items as any,\n  };\n}\n\nfunction upgradeRange(range: Presentation2.Range): Presentation3.Range {\n  // range.members;\n  // range.canvases;\n  // Range.\n  // At the moment a range only references other ranges by id.\n  // So we need to first get\n  return removeUndefinedProperties({\n    ...technicalProperties(range),\n    ...descriptiveProperties(range),\n    ...linkingProperties(range),\n    items: range.members as any,\n  } as Presentation3.Range);\n}\n\nfunction upgradeService(service: Presentation2.Service): Presentation3.Service {\n  const { '@id': id, '@type': type, '@context': context, profile, ...additionalProps } = service as any;\n\n  const newService: any = {};\n\n  if (id) {\n    newService['@id'] = id;\n  }\n\n  newService['@type'] = getNewType(service);\n\n  if (newService['@type'] === 'unknown') {\n    // @todo handle case where there might be multiple contexts.\n    if (context && context.length) {\n      newService['@context'] = context;\n    }\n    newService['@type'] = 'Service'; // optional on services.\n  }\n\n  if (profile) {\n    newService.profile = getProfile(profile);\n  }\n\n  return removeUndefinedProperties({\n    ...newService,\n    ...additionalProps,\n  });\n}\n\nfunction upgradeLayer(layer: Presentation2.Layer): Presentation3.AnnotationCollection {\n  return removeUndefinedProperties({\n    ...technicalProperties(layer),\n    ...descriptiveProperties(layer),\n    ...linkingProperties(layer),\n  });\n}\n\nexport const presentation2to3 = new Traverse<{\n  Collection: Presentation3.Collection;\n  Manifest: Presentation3.Manifest;\n  Canvas: Presentation3.Canvas;\n  AnnotationList: Presentation3.AnnotationPage;\n  Sequence: Presentation3.Canvas[];\n  Annotation: Presentation3.Annotation;\n  ContentResource: Presentation3.ContentResource;\n  Choice: Presentation3.ChoiceBody;\n  Range: Presentation3.Range;\n  Service: Presentation3.Service;\n  Layer: Presentation3.AnnotationCollection;\n}>({\n  collection: [upgradeCollection],\n  manifest: [upgradeManifest],\n  canvas: [upgradeCanvas],\n  annotationList: [upgradeAnnotationList],\n  sequence: [upgradeSequence],\n  annotation: [upgradeAnnotation],\n  contentResource: [upgradeContentResource],\n  choice: [upgradeChoice],\n  range: [upgradeRange],\n  service: [upgradeService],\n  layer: [upgradeLayer],\n});\n\nexport function convertPresentation2(entity: any): Presentation3.Manifest | Presentation3.Collection {\n  if (\n    (entity &&\n      entity['@context'] &&\n      (entity['@context'] === 'http://iiif.io/api/presentation/2/context.json' ||\n        entity['@context'].indexOf('http://iiif.io/api/presentation/2/context.json') !== -1 ||\n        // Yale context.\n        entity['@context'] === 'http://www.shared-canvas.org/ns/context.json')) ||\n    entity['@context'] === 'http://iiif.io/api/image/2/context.json'\n  ) {\n    return presentation2to3.traverseUnknown(entity);\n  }\n  return entity;\n}\n\nfunction upgradeSelector(\n  selector: Presentation2.ContentResourceSelector\n): Presentation3.Selector | Presentation3.Selector[] {\n  const isSvgSelector =\n    ((Array.isArray(selector['@type']) && selector['@type'].includes('oa:SvgSelector')) ||\n      selector['@type'] == 'oa:SvgSelector') &&\n    ('chars' in selector || 'value' in selector);\n  if (isSvgSelector) {\n    return {\n      type: 'SvgSelector',\n      value: 'chars' in selector ? selector.chars : selector.value,\n    };\n  }\n  if (selector['@type'] === 'oa:FragmentSelector') {\n    return {\n      type: 'FragmentSelector',\n      value: selector.value,\n    };\n  }\n  if (selector['@type'] === 'oa:Choice') {\n    return [\n      upgradeSelector(selector.default) as Presentation3.Selector,\n      ...((Array.isArray(selector.item) ? selector.item : [selector.item]).map(\n        upgradeSelector\n      ) as Presentation3.Selector[]),\n    ];\n  }\n  if (selector['@type'] == 'iiif:ImageApiSelector') {\n    return {\n      type: 'ImageApiSelector',\n      region: 'region' in selector ? selector.region : undefined,\n      rotation: 'rotation' in selector ? selector.rotation : undefined,\n    };\n  }\n  throw new Error(`Unsupported selector type: ${selector['@type']}`);\n}\n","import {\n  AnnotationNormalized,\n  AnnotationPageNormalized,\n  CanvasNormalized,\n  CollectionNormalized,\n  ManifestNormalized,\n  RangeNormalized,\n  ResourceProviderNormalized,\n} from '@iiif/presentation-3';\n\nexport const EMPTY = [];\n// Prevent accidental mutation\nObject.freeze(EMPTY);\n\nexport const emptyAnnotation: AnnotationNormalized = {\n  id: 'https://iiif-parser/annotation',\n  type: 'Annotation',\n  behavior: EMPTY,\n  label: null,\n  thumbnail: EMPTY,\n  summary: null,\n  requiredStatement: null,\n  metadata: EMPTY,\n  seeAlso: EMPTY,\n  homepage: EMPTY,\n  logo: EMPTY,\n  rendering: EMPTY,\n  service: EMPTY,\n  accessibility: EMPTY,\n  audience: EMPTY,\n  body: EMPTY,\n  bodyValue: null,\n  canonical: null,\n  created: null,\n  creator: EMPTY,\n  generated: null,\n  generator: EMPTY,\n  modified: null,\n  motivation: EMPTY,\n  rights: EMPTY,\n  stylesheet: null,\n  target: EMPTY,\n  timeMode: undefined, // @todo bug? should be null.\n  via: EMPTY,\n  partOf: EMPTY,\n};\n\nexport const emptyAnnotationPage: AnnotationPageNormalized = {\n  id: 'https://iiif-parser/annotation-page',\n  type: 'AnnotationPage',\n  behavior: EMPTY,\n  motivation: null,\n  label: null,\n  thumbnail: EMPTY,\n  summary: null,\n  requiredStatement: null,\n  metadata: EMPTY,\n  rights: null,\n  provider: EMPTY,\n  items: EMPTY,\n  seeAlso: EMPTY,\n  homepage: EMPTY,\n  logo: EMPTY,\n  rendering: EMPTY,\n  service: EMPTY,\n};\n\nexport const emptyCanvas: CanvasNormalized = {\n  id: 'https://iiif-parser/empty-canvas',\n  type: 'Canvas',\n  label: null,\n  behavior: EMPTY,\n  motivation: null,\n  thumbnail: EMPTY,\n  posterCanvas: null,\n  accompanyingCanvas: null,\n  placeholderCanvas: null,\n  summary: null,\n  requiredStatement: null,\n  metadata: EMPTY,\n  rights: null,\n  navDate: null,\n  provider: EMPTY,\n  items: EMPTY,\n  annotations: EMPTY,\n  seeAlso: EMPTY,\n  homepage: EMPTY,\n  logo: EMPTY,\n  partOf: EMPTY,\n  rendering: EMPTY,\n  service: EMPTY,\n  duration: 0,\n  height: 0,\n  width: 0,\n};\n\nexport const emptyCollection: CollectionNormalized = {\n  id: 'https://iiif-parser/empty-collection',\n  type: 'Collection',\n  label: null,\n  viewingDirection: 'left-to-right',\n  behavior: EMPTY,\n  motivation: null,\n  thumbnail: EMPTY,\n  posterCanvas: null,\n  accompanyingCanvas: null,\n  placeholderCanvas: null,\n  summary: null,\n  requiredStatement: null,\n  metadata: EMPTY,\n  rights: null,\n  navDate: null,\n  provider: EMPTY,\n  items: EMPTY,\n  annotations: EMPTY,\n  seeAlso: EMPTY,\n  homepage: EMPTY,\n  logo: EMPTY,\n  partOf: EMPTY,\n  rendering: EMPTY,\n  service: EMPTY,\n  services: EMPTY,\n};\n\nexport const emptyManifest: ManifestNormalized = {\n  id: 'https://iiif-parser/empty-manifest',\n  type: 'Manifest',\n  annotations: EMPTY,\n  behavior: EMPTY,\n  homepage: EMPTY,\n  items: EMPTY,\n  label: null,\n  logo: EMPTY,\n  metadata: EMPTY,\n  motivation: null,\n  navDate: null,\n  provider: EMPTY,\n  partOf: EMPTY,\n  posterCanvas: null,\n  accompanyingCanvas: null,\n  placeholderCanvas: null,\n  rendering: EMPTY,\n  requiredStatement: null,\n  rights: null,\n  seeAlso: EMPTY,\n  service: EMPTY,\n  services: EMPTY,\n  start: null,\n  structures: EMPTY,\n  summary: null,\n  thumbnail: EMPTY,\n  viewingDirection: 'left-to-right',\n};\n\nexport const emptyRange: RangeNormalized = {\n  id: 'https://iiif-parser/empty-canvas',\n  type: 'Range',\n  label: null,\n  behavior: EMPTY,\n  motivation: null,\n  thumbnail: EMPTY,\n  posterCanvas: null,\n  accompanyingCanvas: null,\n  placeholderCanvas: null,\n  summary: null,\n  requiredStatement: null,\n  metadata: EMPTY,\n  rights: null,\n  navDate: null,\n  provider: EMPTY,\n  items: EMPTY,\n  annotations: EMPTY,\n  seeAlso: EMPTY,\n  homepage: EMPTY,\n  logo: EMPTY,\n  partOf: EMPTY,\n  rendering: EMPTY,\n  service: EMPTY,\n  start: null,\n  supplementary: null,\n  viewingDirection: 'left-to-right',\n};\n\nexport const emptyAgent: ResourceProviderNormalized = {\n  id: 'https://iiif-parser/empty-agent',\n  type: 'Agent',\n  label: {},\n  logo: EMPTY,\n  seeAlso: EMPTY,\n  homepage: EMPTY,\n};\n","import {\n  Agent,\n  Annotation,\n  AnnotationCollection,\n  AnnotationPage,\n  Canvas,\n  ChoiceBody,\n  ChoiceTarget,\n  Collection,\n  ContentResource,\n  DescriptiveProperties,\n  IIIFExternalWebResource,\n  LinkingProperties,\n  Manifest,\n  Range,\n  RangeItems,\n  Required,\n  Service,\n  ResourceProvider,\n} from '@iiif/presentation-3';\nimport { ensureArray } from '../shared/ensure-array';\n\nexport const types = [\n  'Collection',\n  'Manifest',\n  'Canvas',\n  'AnnotationPage',\n  'AnnotationCollection',\n  'Annotation',\n  'ContentResource',\n  'Range',\n  'Service',\n  'Selector',\n  'Agent',\n];\n\nexport type Traversal<T> = (jsonLd: T) => Partial<T> | any;\n\nexport type TraversalMap = {\n  collection?: Array<Traversal<Collection>>;\n  manifest?: Array<Traversal<Manifest>>;\n  canvas?: Array<Traversal<Canvas>>;\n  annotationCollection?: Array<Traversal<AnnotationCollection>>;\n  annotationPage?: Array<Traversal<AnnotationPage>>;\n  annotation?: Array<Traversal<Annotation>>;\n  contentResource?: Array<Traversal<ContentResource>>;\n  choice?: Array<Traversal<ChoiceTarget | ChoiceBody>>;\n  range?: Array<Traversal<Range>>;\n  service?: Array<Traversal<Service>>;\n  agent?: Array<Traversal<ResourceProvider>>;\n};\n\nexport type TraverseOptions = {\n  allowUndefinedReturn: boolean;\n};\n\nexport function identifyResource(resource: any): string {\n  if (typeof resource === 'undefined' || resource === null) {\n    throw new Error('Null or undefined is not a valid entity.');\n  }\n  if (Array.isArray(resource)) {\n    throw new Error('Array is not a valid entity');\n  }\n  if (typeof resource !== 'object') {\n    throw new Error(`${typeof resource} is not a valid entity`);\n  }\n\n  if (typeof resource!.type === 'string') {\n    const hasType = types.indexOf(resource.type);\n    if (hasType !== -1) {\n      return types[hasType];\n    }\n  }\n\n  if (resource!.profile) {\n    return 'Service';\n  }\n\n  throw new Error('Resource type is not known');\n}\n\nexport class Traverse {\n  private traversals: Required<TraversalMap>;\n\n  private options: TraverseOptions;\n\n  constructor(traversals: TraversalMap, options: Partial<TraverseOptions> = {}) {\n    this.traversals = {\n      collection: [],\n      manifest: [],\n      canvas: [],\n      annotationCollection: [],\n      annotationPage: [],\n      annotation: [],\n      contentResource: [],\n      choice: [],\n      range: [],\n      service: [],\n      agent: [],\n      ...traversals,\n    };\n    this.options = {\n      allowUndefinedReturn: false,\n      ...options,\n    };\n  }\n\n  static all(traversal: (resource: any) => any) {\n    return new Traverse({\n      collection: [traversal],\n      manifest: [traversal],\n      canvas: [traversal],\n      annotationCollection: [traversal],\n      annotationPage: [traversal],\n      annotation: [traversal],\n      contentResource: [traversal],\n      choice: [traversal],\n      range: [traversal],\n      service: [traversal],\n    });\n  }\n\n  traverseDescriptive<T extends Partial<DescriptiveProperties>>(resource: T) {\n    if (resource.thumbnail) {\n      resource.thumbnail = resource.thumbnail.map((thumbnail) =>\n        this.traverseType(thumbnail, this.traversals.contentResource)\n      );\n    }\n    if (resource.provider) {\n      resource.provider = resource.provider.map((agent) => this.traverseAgent(agent));\n    }\n    return resource;\n  }\n\n  traverseLinking<T extends Partial<LinkingProperties>>(resource: T) {\n    if (resource.seeAlso) {\n      resource.seeAlso = resource.seeAlso.map((content) => this.traverseType(content, this.traversals.contentResource));\n    }\n    if (resource.service) {\n      resource.service = ensureArray(resource.service).map((service) =>\n        this.traverseType(service, this.traversals.service)\n      );\n    }\n    if (resource.services) {\n      resource.services = resource.services.map((service) => this.traverseType(service, this.traversals.service));\n    }\n    if (resource.logo) {\n      resource.logo = resource.logo.map((content) => this.traverseType(content, this.traversals.contentResource));\n    }\n    if (resource.homepage) {\n      resource.homepage = resource.homepage.map((homepage) =>\n        this.traverseType(homepage, this.traversals.contentResource)\n      );\n    }\n    if (resource.partOf) {\n      // Array<ContentResource | Canvas | AnnotationCollection>\n      (resource as any).partOf = resource.partOf.map((partOf) => {\n        if (typeof partOf === 'string' || !partOf.type) {\n          return this.traverseType(partOf as ContentResource, this.traversals.contentResource);\n        }\n        if (partOf.type === 'Canvas') {\n          return this.traverseType(partOf as Canvas, this.traversals.canvas);\n        }\n        if (partOf.type === 'AnnotationCollection') {\n          return this.traverseType(partOf as AnnotationCollection, this.traversals.annotationCollection);\n        }\n        if (partOf.type === 'Collection') {\n          return this.traverseType(partOf as Collection, this.traversals.collection);\n        }\n        return this.traverseType(partOf as ContentResource, this.traversals.contentResource);\n      });\n    }\n    if (resource.start) {\n      resource.start = resource.start ? this.traverseType(resource.start, this.traversals.canvas) : null;\n    }\n    if (resource.rendering) {\n      resource.rendering = resource.rendering.map((content) =>\n        this.traverseType(content, this.traversals.contentResource)\n      );\n    }\n    if (resource.supplementary) {\n      resource.supplementary = resource.supplementary.map((content) =>\n        this.traverseType(content, this.traversals.contentResource)\n      );\n    }\n\n    return resource;\n  }\n\n  traverseCollectionItems(collection: Collection): Collection {\n    if (collection.items) {\n      collection.items.map((collectionOrManifest: Manifest | Collection) => {\n        if (collectionOrManifest.type === 'Collection') {\n          return this.traverseCollection(collectionOrManifest as Collection);\n        }\n        return this.traverseManifest(collectionOrManifest as Manifest);\n      });\n    }\n\n    return collection;\n  }\n\n  traverseCollection(collection: Collection): Collection {\n    return this.traverseType<Collection>(\n      this.traverseDescriptive(\n        this.traverseInlineAnnotationPages(\n          this.traverseLinking(this.traversePosterCanvas(this.traverseCollectionItems(collection)))\n        )\n      ),\n      this.traversals.collection\n    );\n  }\n\n  traverseManifestItems(manifest: Manifest): Manifest {\n    if (manifest.items) {\n      manifest.items = manifest.items.map((canvas) => this.traverseCanvas(canvas));\n    }\n    return manifest;\n  }\n\n  traverseManifestStructures(manifest: Manifest): Manifest {\n    if (manifest.structures) {\n      manifest.structures = manifest.structures.map((range) => this.traverseRange(range));\n    }\n    return manifest;\n  }\n\n  traverseManifest(manifest: Manifest): Manifest {\n    return this.traverseType<Manifest>(\n      this.traverseInlineAnnotationPages(\n        this.traverseManifestStructures(\n          this.traversePosterCanvas(\n            this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(manifest)))\n          )\n        )\n      ),\n      this.traversals.manifest\n    );\n  }\n\n  traverseCanvasItems(canvas: Canvas): Canvas {\n    canvas.items = (canvas.items || []).map((annotationPage: AnnotationPage): AnnotationPage => {\n      return this.traverseAnnotationPage(annotationPage);\n    });\n\n    return canvas;\n  }\n\n  traverseInlineAnnotationPages<T extends Manifest | Canvas | Range | string>(resource: T): T {\n    if (typeof resource === 'string' || !resource) {\n      return resource;\n    }\n    if (resource.annotations) {\n      resource.annotations = resource.annotations.map((annotationPage: AnnotationPage): AnnotationPage => {\n        return this.traverseAnnotationPage(annotationPage);\n      });\n    }\n\n    return resource;\n  }\n\n  traverseCanvas(canvas: Canvas): Canvas {\n    return this.traverseType<Canvas>(\n      this.traverseInlineAnnotationPages(\n        this.traversePosterCanvas(this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(canvas))))\n      ),\n      this.traversals.canvas\n    );\n  }\n\n  traverseAnnotationPageItems(annotationPage: AnnotationPage): AnnotationPage {\n    if (annotationPage.items) {\n      annotationPage.items = annotationPage.items.map((annotation: Annotation): Annotation => {\n        return this.traverseAnnotation(annotation);\n      });\n    }\n    return annotationPage;\n  }\n\n  traverseAnnotationPage(annotationPageJson: AnnotationPage): AnnotationPage {\n    return this.traverseType<AnnotationPage>(\n      this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationPageItems(annotationPageJson) as any)),\n      this.traversals.annotationPage\n    );\n  }\n\n  // Disabling these.\n\n  traverseAnnotationBody(annotation: Annotation): Annotation {\n    if (Array.isArray(annotation.body)) {\n      annotation.body = annotation.body.map((annotationBody: any): ContentResource => {\n        return this.traverseContentResource(annotationBody);\n      });\n    } else if (annotation.body) {\n      annotation.body = this.traverseContentResource(annotation.body as ContentResource);\n    }\n\n    return annotation;\n  }\n\n  /*\n  traverseAnnotationTarget(annotation: Annotation): Annotation {\n    if (Array.isArray(annotation.target)) {\n      annotation.target = annotation.target.map(\n        (annotationBody: ContentResource): ContentResource => {\n          return this.traverseContentResource(annotationBody);\n        }\n      );\n    } else if (annotation.target) {\n      annotation.target = this.traverseContentResource(annotation.target);\n    }\n\n    return annotation;\n  }\n  */\n\n  traversePosterCanvas<T extends Collection | Manifest | Canvas | Range>(json: T): T {\n    // @deprecated\n    if (json.posterCanvas) {\n      json.posterCanvas = this.traverseCanvas(json.posterCanvas);\n    }\n\n    if (json.placeholderCanvas) {\n      json.placeholderCanvas = this.traverseCanvas(json.placeholderCanvas);\n    }\n\n    if (json.accompanyingCanvas) {\n      json.accompanyingCanvas = this.traverseCanvas(json.accompanyingCanvas);\n    }\n\n    return json;\n  }\n\n  // @todo traverseAnnotationSelector\n  traverseAnnotation(annotationJson: Annotation): Annotation {\n    return this.traverseType<Annotation>(\n      // Disabled these for now.\n      // this.traverseAnnotationTarget(this.traverseLinking(this.traverseAnnotationBody(annotationJson))),\n      this.traverseLinking(this.traverseAnnotationBody(annotationJson)),\n      this.traversals.annotation\n    );\n  }\n\n  traverseContentResourceLinking(contentResourceJson: ContentResource): ContentResource {\n    if (typeof contentResourceJson === 'string' || !contentResourceJson) {\n      return contentResourceJson;\n    }\n    if (contentResourceJson && (contentResourceJson as IIIFExternalWebResource)!.service) {\n      (contentResourceJson as IIIFExternalWebResource).service = ensureArray(\n        (contentResourceJson as IIIFExternalWebResource).service || []\n      ).map((service) => this.traverseType(service, this.traversals.service));\n    }\n\n    return contentResourceJson;\n  }\n\n  traverseContentResource(contentResourceJson: ContentResource): ContentResource {\n    if ((contentResourceJson as any).type === 'Choice') {\n      (contentResourceJson as any).items = (contentResourceJson as any).items.map((choiceItem: ContentResource) => {\n        return this.traverseContentResource(choiceItem);\n      });\n    }\n\n    return this.traverseType<ContentResource>(\n      // This needs an `any` because of the scope of W3C annotation bodies (covered by ContentResource).\n      // ContentResources are permitted to have a `.annotations` property, so we can pass it as any  for this\n      // case.\n      this.traverseInlineAnnotationPages(this.traverseContentResourceLinking(contentResourceJson) as any),\n      this.traversals.contentResource\n    );\n  }\n\n  traverseRangeRanges(range: Range): Range {\n    if (range.items) {\n      range.items = range.items.map((rangeOrManifest: RangeItems) => {\n        if (typeof rangeOrManifest === 'string') {\n          return this.traverseCanvas({ id: rangeOrManifest, type: 'Canvas' });\n        }\n        if (rangeOrManifest.type === 'Manifest') {\n          return this.traverseManifest(rangeOrManifest as Manifest);\n        }\n        return this.traverseRange(rangeOrManifest as Range);\n      });\n    }\n\n    return range;\n  }\n\n  traverseRange(range: Range): Range {\n    return this.traverseType<Range>(\n      this.traversePosterCanvas(this.traverseDescriptive(this.traverseLinking(this.traverseRangeRanges(range)))),\n      this.traversals.range\n    );\n  }\n\n  traverseAgent(agent: ResourceProvider) {\n    return this.traverseType<ResourceProvider>(\n      this.traverseDescriptive(this.traverseLinking(agent)),\n      this.traversals.agent\n    );\n  }\n\n  traverseType<T>(object: T, traversals: Array<Traversal<T>>): T {\n    return traversals.reduce((acc: T, traversal: Traversal<T>): T => {\n      const returnValue = traversal(acc);\n      if (typeof returnValue === 'undefined' && !this.options.allowUndefinedReturn) {\n        return acc;\n      }\n      return returnValue;\n    }, object);\n  }\n\n  traverseService(service: Service): Service {\n    return this.traverseType<Service>(service, this.traversals.service);\n  }\n\n  traverseUnknown(resource: any) {\n    const type = identifyResource(resource);\n\n    switch (type) {\n      case 'Collection':\n        return this.traverseCollection(resource as Collection);\n      case 'Manifest':\n        return this.traverseManifest(resource as Manifest);\n      case 'Canvas':\n        return this.traverseCanvas(resource as Canvas);\n      case 'AnnotationPage':\n        return this.traverseAnnotationPage(resource as AnnotationPage);\n      case 'Annotation':\n        return this.traverseAnnotation(resource as Annotation);\n      case 'ContentResource':\n        return this.traverseContentResource(resource as ContentResource);\n      case 'Range':\n        return this.traverseRange(resource as Range);\n      case 'Service':\n        return this.traverseService(resource as Service);\n      case 'Agent':\n        return this.traverseAgent(resource as ResourceProvider);\n      default:\n        throw new Error(`Unknown or unsupported resource type of ${type}`);\n    }\n  }\n}\n","import { Traverse } from './traverse';\nimport {\n  Annotation,\n  AnnotationPage,\n  AnnotationPageNormalized,\n  Canvas,\n  CanvasNormalized,\n  Collection,\n  CollectionNormalized,\n  Manifest,\n  ManifestNormalized,\n  PolyEntity,\n  Range,\n  RangeNormalized,\n  Reference,\n  ResourceProvider,\n  ResourceProviderNormalized,\n} from '@iiif/presentation-3';\nimport {\n  EMPTY,\n  emptyAgent,\n  emptyAnnotationPage,\n  emptyCanvas,\n  emptyCollection,\n  emptyManifest,\n  emptyRange,\n} from './empty-types';\nimport { convertPresentation2 } from '../presentation-2';\nimport { NormalizedEntity } from './serialize';\n\nexport const defaultEntities = {\n  Collection: {},\n  Manifest: {},\n  Canvas: {},\n  AnnotationPage: {},\n  AnnotationCollection: {},\n  Annotation: {},\n  ContentResource: {},\n  Range: {},\n  Service: {},\n  Selector: {},\n  Agent: {},\n};\n\nexport function getDefaultEntities() {\n  return {\n    Collection: {},\n    Manifest: {},\n    Canvas: {},\n    AnnotationPage: {},\n    AnnotationCollection: {},\n    Annotation: {},\n    ContentResource: {},\n    Range: {},\n    Service: {},\n    Selector: {},\n    Agent: {},\n  };\n}\n\nfunction getResource(entityOrString: PolyEntity, type: string): Reference {\n  if (typeof entityOrString === 'string') {\n    return { id: entityOrString, type };\n  }\n  if (!entityOrString.id) {\n    throw new Error(`Invalid resource does not have an ID (${type})`);\n  }\n  return entityOrString as Reference;\n}\n\nfunction mapToEntities(entities: Record<string, Record<string, NormalizedEntity>>) {\n  return <T extends Reference | string>(type: string, defaultStringType?: string) => {\n    const storeType = entities[type] ? entities[type] : {};\n    return (r: T): T => {\n      const resource = getResource(r, defaultStringType || type);\n      if (resource && resource.id && type) {\n        storeType[resource.id] = storeType[resource.id]\n          ? (mergeEntities(storeType[resource.id], resource) as any)\n          : Object.assign({}, resource);\n        return {\n          id: resource.id,\n          type: type === 'ContentResource' ? type : resource.type,\n        } as T;\n      }\n      return resource as T;\n    };\n  };\n}\n\nfunction merge(existing: any, incoming: any): any {\n  if (!incoming) {\n    // Falsy values are ignored\n    return existing;\n  }\n  if (Array.isArray(existing)) {\n    if (!Array.isArray(incoming)) {\n      throw new Error('Cannot merge array with non-array');\n    }\n    // For arrays, we check if any of the incoming values are not already in the\n    // existing values and add them if this is not the case. If the incoming\n    // value is an entity that is already in the existing values, it will be\n    // merged with the existing value.\n    const merged = [...existing];\n    for (const item of incoming) {\n      if (item === null || item === undefined) {\n        continue;\n      }\n      if (Array.isArray(item)) {\n        // FIXME: How to handle this properly?\n        merged.push(item);\n      } else if (typeof item === 'object' && item.id && item.type) {\n        const existingIdx = merged.findIndex((e) => e.id === item.id && e.type === item.type);\n        if (existingIdx >= 0) {\n          merged[existingIdx] = merge(merged[existingIdx], item);\n        }\n      } else if (existing.indexOf(item) === -1) {\n        merged.push(item);\n      }\n    }\n    return merged;\n  } else if (typeof existing === 'object') {\n    if (Array.isArray(incoming) || typeof incoming !== 'object') {\n      throw new Error('Cannot merge object with non-object');\n    }\n    // For objects, we check the existing object for non-existing or \"empty\"\n    // properties and use the value from the incoming object for them\n    const merged = { ...existing };\n    for (const [key, val] of Object.entries(incoming)) {\n      const currentVal = merged[key];\n      if (currentVal === EMPTY || !currentVal) {\n        merged[key] = val;\n      } else {\n        merged[key] = merge(currentVal, val);\n      }\n    }\n    return merged;\n  } else if (existing) {\n    return existing;\n  }\n  return incoming;\n}\n\nexport function mergeEntities(existing: NormalizedEntity, incoming: any): NormalizedEntity {\n  if (typeof existing === 'string') {\n    return existing;\n  }\n  if (incoming.id !== (existing as any).id || incoming.type !== (existing as any).type) {\n    throw new Error('Can only merge entities with identical identifiers and type!');\n  }\n  return merge({ ...existing }, incoming);\n}\n\nfunction recordTypeInMapping(mapping: Record<string, string>) {\n  return <T extends Reference | string>(type: string, defaultStringType?: string) => {\n    return (r: T): T => {\n      const { id, type: foundType } = getResource(r, defaultStringType || type);\n      if (typeof id === 'undefined') {\n        throw new Error('Found invalid entity without an ID.');\n      }\n      if (type === 'ContentResource') {\n        mapping[id] = type;\n      } else {\n        mapping[id] = foundType as any;\n      }\n      return r;\n    };\n  };\n}\n\n/**\n * A string hashing function based on Daniel J. Bernstein's popular 'times 33' hash algorithm.\n * @author MatthewBarker <mrjbarker@hotmail.com>\n */\nfunction hash(object: any): string {\n  const text = JSON.stringify(object);\n\n  let numHash = 5381,\n    index = text.length;\n\n  while (index) {\n    numHash = (numHash * 33) ^ text.charCodeAt(--index);\n  }\n\n  const num = numHash >>> 0;\n\n  const hexString = num.toString(16);\n  if (hexString.length % 2) {\n    return '0' + hexString;\n  }\n  return hexString;\n}\n\nfunction addMissingIdToContentResource<T extends Partial<Reference>>(type: string) {\n  return (resource: T | string): T => {\n    if (typeof resource === 'string') {\n      return { id: resource, type } as T;\n    }\n    if (!resource.id) {\n      return { id: `vault://${hash(resource)}`, type, ...resource };\n    }\n    if (!resource.type) {\n      return { type, ...resource };\n    }\n    return resource;\n  };\n}\n\nfunction ensureDefaultFields<T, R>(defaultResource: R) {\n  return (resource: T): R => {\n    return {\n      ...defaultResource,\n      ...resource,\n    };\n  };\n}\n\nfunction ensureArray<T>(maybeArray: T | T[]): T[] {\n  if (Array.isArray(maybeArray)) {\n    return maybeArray;\n  }\n  return [maybeArray];\n}\n\nfunction ensureArrayOnAnnotation(annotation: Annotation): Annotation {\n  if (annotation.body) {\n    annotation.body = ensureArray(annotation.body);\n  }\n  if (annotation.seeAlso) {\n    annotation.seeAlso = ensureArray(annotation.seeAlso);\n  }\n  if (annotation.body) {\n    annotation.body = ensureArray(annotation.body);\n  }\n  if (annotation.audience) {\n    annotation.audience = ensureArray(annotation.audience);\n  }\n  if (annotation.accessibility) {\n    annotation.accessibility = ensureArray(annotation.accessibility);\n  }\n  if (annotation.motivation) {\n    annotation.motivation = ensureArray(annotation.motivation);\n  }\n\n  return annotation;\n}\n\nexport function normalize(unknownEntity: unknown) {\n  const entity = convertPresentation2(unknownEntity);\n  const entities = getDefaultEntities();\n  const mapping = {};\n  const addToEntities = mapToEntities(entities);\n  const addToMapping = recordTypeInMapping(mapping);\n\n  const traversal = new Traverse({\n    collection: [\n      ensureDefaultFields<Collection, CollectionNormalized>(emptyCollection),\n      addToMapping<Collection>('Collection'),\n      addToEntities<Collection>('Collection'),\n    ],\n    manifest: [\n      ensureDefaultFields<Manifest, ManifestNormalized>(emptyManifest),\n      addToMapping<Manifest>('Manifest'),\n      addToEntities<Manifest>('Manifest'),\n    ],\n    canvas: [\n      ensureDefaultFields<Canvas, CanvasNormalized>(emptyCanvas),\n      addToMapping<Canvas>('Canvas'),\n      addToEntities<Canvas>('Canvas'),\n    ],\n    annotationPage: [\n      addMissingIdToContentResource('AnnotationPage'),\n      ensureDefaultFields<AnnotationPage, AnnotationPageNormalized>(emptyAnnotationPage),\n      addToMapping<AnnotationPage>('AnnotationPage'),\n      addToEntities<AnnotationPage>('AnnotationPage'),\n    ],\n    annotation: [\n      // This won't be normalized before going into the state.\n      // It will be normalized through selectors and pattern matching.\n      addMissingIdToContentResource('Annotation'),\n      ensureArrayOnAnnotation,\n      addToMapping<Annotation>('Annotation'),\n      addToEntities<Annotation>('Annotation'),\n    ],\n    contentResource: [\n      // This won't be normalized before going into the state.\n      // It will be normalized through selectors and pattern matching.\n      addMissingIdToContentResource<any>('ContentResource'),\n      addToMapping<any>('ContentResource'),\n      addToEntities<any>('ContentResource'),\n    ],\n    range: [\n      // This will add a LOT to the state, maybe this will be configurable down the line.\n      ensureDefaultFields<Range, RangeNormalized>(emptyRange),\n      addToMapping<Range>('Range', 'Canvas'),\n      addToEntities<Range>('Range', 'Canvas'),\n    ],\n    agent: [\n      ensureDefaultFields<ResourceProvider, ResourceProviderNormalized>(emptyAgent),\n      addToMapping<ResourceProvider>('Agent'),\n      addToEntities<ResourceProvider>('Agent'),\n    ],\n    // Remove this, content resources are NOT usually processed by this library.\n    // They need to be available in full when they get passed down the chain.\n    // There may be a better way to preserve annotations and content resources.\n    // service: [\n    //   ensureDefaultFields<Service, ServiceNormalized>(emptyService),\n    //   addToMapping<Service>('Service'),\n    //   addToEntities<Service>('Service'),\n    // ],\n  });\n  const resource = traversal.traverseUnknown(entity) as Reference;\n\n  return { entities, resource, mapping };\n}\n","import {\n  AnnotationCollection,\n  AnnotationCollectionNormalized,\n  AnnotationNormalized,\n  AnnotationPageNormalized,\n  CanvasNormalized,\n  CollectionNormalized,\n  ContentResource,\n  ManifestNormalized,\n  RangeNormalized,\n  Reference,\n  Selector,\n  ServiceNormalized,\n  ResourceProviderNormalized\n} from '@iiif/presentation-3';\n\nexport const UNSET = '__$UNSET$__';\nexport const UNWRAP = '__$UNWRAP$__';\n\nexport type Field = any[];\n\nexport type CompatibleStore<T extends string = string> = {\n  requests: {\n    [url: string]: { resourceUri?: string } & any;\n  };\n  entities: {\n    [type in T]: {\n      [id: string]: NormalizedEntity;\n    };\n  };\n  mapping: {\n    [id: string]: T;\n  };\n};\n\nexport type NormalizedEntity =\n  | CollectionNormalized\n  | ManifestNormalized\n  | CanvasNormalized\n  | AnnotationPageNormalized\n  | AnnotationCollectionNormalized\n  | AnnotationCollection\n  | AnnotationNormalized\n  | ContentResource\n  | RangeNormalized\n  | ServiceNormalized\n  | Selector\n  | ResourceProviderNormalized;\n\ntype SerializerContext = {\n  isTopLevel?: boolean;\n};\n\nexport type Serializer<Type extends NormalizedEntity> = (\n  entity: Type,\n  state: any,\n  context: SerializerContext\n) => Generator<Reference | Reference[], typeof UNSET | Field[], any>;\n\nexport type SerializeConfig = {\n  Collection?: Serializer<CollectionNormalized>;\n  Manifest?: Serializer<ManifestNormalized>;\n  Canvas?: Serializer<CanvasNormalized>;\n  AnnotationPage?: Serializer<AnnotationPageNormalized>;\n  AnnotationCollection?: Serializer<AnnotationCollectionNormalized>;\n  Annotation?: Serializer<AnnotationNormalized>;\n  ContentResource?: Serializer<ContentResource>;\n  Range?: Serializer<RangeNormalized>;\n  Service?: Serializer<ServiceNormalized>;\n  Selector?: Serializer<Selector>;\n  Agent?: Serializer<ResourceProviderNormalized>;\n};\n\nfunction resolveIfExists<T extends NormalizedEntity>(state: CompatibleStore, url: string): T | undefined {\n  const request = state.requests[url];\n  // Return the resource.\n  const resourceType = state.mapping[url];\n  if (!resourceType || (request && request.resourceUri && !state.entities[resourceType][request.resourceUri])) {\n    // Continue refetching resource, this is an invalid state.\n    return undefined;\n  }\n  return state.entities[resourceType][request ? request.resourceUri : url] as T;\n}\n\nexport function serializedFieldsToObject<T>(fields: Field[] | [string]): T {\n  const object: any = {};\n\n  for (const [key, value] of fields) {\n    if (key === UNWRAP && value !== UNSET) {\n      return value as T;\n    }\n    if (value !== UNSET && typeof value !== 'undefined' && value !== null) {\n      object[key] = value;\n    }\n  }\n\n  return object as T;\n}\n\nexport function serialize<Return>(state: CompatibleStore, subject: Reference, config: SerializeConfig): Return {\n  if (!subject.type || !subject.id) {\n    throw new Error('Unknown entity');\n  }\n\n  if (!config[subject.type as keyof SerializeConfig]) {\n    throw new Error(`Serializer not found for ${subject.type}`);\n  }\n\n  function flatten(sub: Reference) {\n    const generator = config[sub.type as keyof SerializeConfig];\n    if (!generator) {\n      return UNSET;\n    }\n\n    const resource = resolveIfExists(state, sub.id) || (sub.id && sub.type ? sub : null);\n    if (!resource) {\n      return UNSET;\n    }\n    const iterator = generator(resource as any, state, { isTopLevel: subject.id === sub.id });\n    let current = iterator.next();\n    while (!current.done) {\n      const requestToHydrate: Reference | Reference[] = current.value as any;\n      let next: any = UNSET;\n\n      if (requestToHydrate) {\n        if (Array.isArray(requestToHydrate)) {\n          const nextList: any[] = [];\n          for (const req of requestToHydrate) {\n            nextList.push(flatten(req));\n          }\n          next = nextList;\n        } else {\n          next = flatten(requestToHydrate);\n        }\n      }\n      current = iterator.next(next);\n    }\n\n    if (current.value === UNSET) {\n      return UNSET;\n    }\n\n    return serializedFieldsToObject(current.value);\n  }\n\n  return flatten(subject) as Return;\n}\n","import { SerializeConfig } from './serialize';\nimport {\n  DescriptiveNormalized,\n  InternationalString,\n  LinkingNormalized,\n  TechnicalProperties,\n} from '@iiif/presentation-3';\nimport * as Presentation2 from '@iiif/presentation-2';\n\nexport function languageString2to3(\n  value: InternationalString | null | undefined\n): Presentation2.LanguageProperty | Presentation2.LanguageProperty[] | undefined {\n  if (!value) {\n    return undefined;\n  }\n\n  const languages = Object.keys(value);\n\n  if (languages.length === 0) {\n    return undefined;\n  }\n\n  // If there is only one, then return it as a string.\n  if (languages.length === 1) {\n    const language = languages[0];\n    if (!language) {\n      return '';\n    }\n\n    const singleValue = (value[language] || []).join('');\n\n    if (language === '@none' || language === 'none' || language === 'en') {\n      return singleValue;\n    }\n\n    return {\n      '@language': language,\n      '@value': singleValue,\n    };\n  }\n\n  return languages.map((language) => {\n    return {\n      '@language': language,\n      '@value': (value[language] || []).join(''),\n    };\n  });\n}\n\nfunction parseCanvasTarget(target: any): any {\n  if (Array.isArray(target)) {\n    return target.map((t) => parseCanvasTarget(t));\n  }\n\n  if (typeof target === 'string') {\n    return target;\n  }\n\n  if (target.type && target.type === 'Canvas') {\n    return target.id;\n  }\n\n  return target;\n}\n\nfunction unNestArray<T>(oneOrArray: T[] | undefined, onlyOne = false): T | T[] | undefined {\n  if (!oneOrArray) {\n    return undefined;\n  }\n\n  if (oneOrArray.length > 1 && !onlyOne) {\n    return oneOrArray;\n  }\n  return oneOrArray[0] || undefined;\n}\n\nfunction convertService(service: any) {\n  if (!service) {\n    return undefined;\n  }\n\n  if (typeof service === 'string') {\n    return {\n      '@id': service,\n    };\n  }\n\n  if ('@id' in service) {\n    const newService = { ...service };\n    delete newService['@type'];\n    return newService;\n  }\n\n  // @todo support auth.\n  return {\n    '@context': 'http://iiif.io/api/image/2/context.json',\n    '@id': service.id,\n    profile: `http://iiif.io/api/image/2/profiles/${service.profile}.json`,\n  };\n}\n\nfunction technicalProperties(props: Partial<TechnicalProperties>, type?: string) {\n  return [\n    ['@id', props.id],\n    ['@type', type],\n    ['format', props.format],\n    ['height', props.height],\n    ['width', props.width],\n    ['viewingDirection', props.viewingDirection !== 'left-to-right' ? props.viewingDirection : undefined],\n    // @todo Viewing hint is merged with behavior\n    // ['viewingHint', props.]\n  ];\n}\n\nfunction* descriptiveProperties(prop: Partial<DescriptiveNormalized>): Generator<any, any, any> {\n  const provider = prop.provider ? yield prop.provider[0] : undefined;\n\n  return [\n    ['label', languageString2to3(prop.label)],\n    [\n      'metadata',\n      prop.metadata && prop.metadata.length\n        ? prop.metadata.map((item) => ({\n            label: languageString2to3(item.label) || '',\n            value: languageString2to3(item.value) || '',\n          }))\n        : undefined,\n    ],\n    ['description', languageString2to3(prop.summary)],\n    ['thumbnail', unNestArray(yield prop.thumbnail)],\n    ['navDate', prop.navDate],\n    // @todo these needs consideration if the way provider is parsed changes.\n    ['logo', provider ? unNestArray(provider.logo) : undefined],\n    ['homepage', provider ? provider.homepage : undefined],\n    ['attribution', prop.requiredStatement ? languageString2to3(prop.requiredStatement.value) : undefined],\n  ];\n}\n\nfunction* linkingProperties(prop: Partial<LinkingNormalized>) {\n  return [\n    ['seeAlso', unNestArray(yield prop.seeAlso)],\n    // @todo support more services (like auth)\n    ['service', unNestArray((prop.service || []).map(convertService))],\n    ['rendering', unNestArray(yield prop.rendering)],\n    // @todo part of to within\n    // ['within', unNestArray(yield prop.partOf)],\n    // @todo this may not work completely.\n    ['startCanvas', prop.start ? prop.start.id : undefined],\n  ];\n}\n\nexport const serializeConfigPresentation2: SerializeConfig = {\n  Manifest: function* (entity) {\n    return [\n      ...technicalProperties(entity, 'sc:Manifest'),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      // Structural.\n      // @todo structures\n      [\n        'sequences',\n        [\n          {\n            '@id': `${entity.id}/sequence0`,\n            '@type': 'sc:Sequence',\n            canvases: yield entity.items,\n          },\n        ],\n      ],\n      ['structures', yield entity.structures],\n    ];\n  },\n\n  Canvas: function* (entity) {\n    const paintingPage = yield entity.items;\n    const resources = paintingPage[0];\n    return [\n      // Items.\n      ...technicalProperties(entity, 'sc:Canvas'),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['images', resources ? [resources.resources] : undefined],\n      [\n        'annotations',\n        entity.annotations && entity.annotations.length ? unNestArray(yield entity.annotations) : undefined,\n      ],\n    ];\n  },\n\n  AnnotationPage: function* (entity) {\n    return [\n      ...technicalProperties(entity, 'sc:AnnotationList'),\n      ...(yield* descriptiveProperties(entity)),\n      ['resources', entity.items && entity.items.length ? unNestArray(yield entity.items) : undefined],\n    ];\n  },\n\n  Annotation: function* (entity) {\n    return [\n      ['@id', entity.id],\n      ['@type', 'oa:Annotation'],\n      // This could be improved.\n      ['motivation', 'sc:painting'],\n      ['on', parseCanvasTarget(entity.target)],\n      ['resource', unNestArray(yield entity.body, true)],\n    ];\n  },\n\n  ContentResource: function* (entity: any) {\n    switch (entity.type) {\n      case 'Image':\n        return [\n          // Image properties.\n          ...technicalProperties(entity, 'dctypes:Image'),\n          ...(yield* descriptiveProperties(entity)),\n          ...(yield* linkingProperties(entity)),\n        ];\n      case 'Text':\n      case 'Dataset':\n      default:\n        return [...technicalProperties(entity, undefined), ...(yield* descriptiveProperties(entity))];\n    }\n  },\n\n  AnnotationCollection: function* (entity) {\n    return [\n      // @todo expand properties if they are actually used.\n      ['@id', entity.id],\n      ['@type', 'sc:Layer'],\n      ['label', languageString2to3(entity.label)],\n    ];\n  },\n\n  Collection: function* (entity) {\n    return [\n      ...technicalProperties(entity, 'sc:Collection'),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['members', yield* entity.items],\n    ];\n  },\n\n  Range: function* (entity) {\n    const members = [];\n    const canvases = [];\n\n    if (entity.items) {\n      for (const item of entity.items) {\n        const canvas = yield item;\n        members.push({\n          '@id': item.id,\n          '@type': item.type,\n          label: canvas ? canvas.label : undefined,\n          within: entity.id,\n        });\n        if (item.type === 'Canvas') {\n          canvases.push(item.id);\n        }\n      }\n    }\n\n    return [\n      ...technicalProperties(entity, 'sc:Range'),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['canvases', canvases.length === members.length ? canvases : undefined],\n      ['members', canvases.length !== members.length ? members : undefined],\n    ];\n  },\n};\n","import { SerializeConfig, UNWRAP } from './serialize';\nimport {\n  DescriptiveNormalized,\n  ImageService2,\n  ImageService3,\n  LinkingNormalized,\n  TechnicalProperties,\n} from '@iiif/presentation-3';\n\nfunction technicalProperties(entity: Partial<TechnicalProperties>): Array<[keyof TechnicalProperties, any]> {\n  return [\n    // Technical\n    ['id', !entity.id?.startsWith('vault://') ? entity.id : undefined],\n    ['type', entity.type],\n    ['format', entity.format],\n    ['profile', entity.profile],\n    ['height', entity.height],\n    ['width', entity.width],\n    ['duration', entity.duration || undefined],\n    ['viewingDirection', entity.viewingDirection !== 'left-to-right' ? entity.viewingDirection : undefined],\n    ['behavior', entity.behavior && entity.behavior.length ? entity.behavior : undefined],\n    ['timeMode', entity.timeMode],\n    ['motivation', Array.isArray(entity.motivation) ? entity.motivation[0] : entity.motivation],\n  ];\n}\n\nfunction filterEmpty<T>(item?: T[]): T[] | undefined {\n  if (!item || item.length === 0) {\n    return undefined;\n  }\n  return item;\n}\n\nfunction service2compat(service: ImageService3): ImageService2 | ImageService3 {\n  if (service && service.type && service.type === 'ImageService2') {\n    const { id, type, profile: _profile, ..._service } = service as any;\n\n    const profile =\n      typeof _profile === 'string'\n        ? _profile\n        : Array.isArray(_profile)\n        ? _profile.find((p) => typeof p === 'string')\n        : '';\n\n    return {\n      '@id': id,\n      '@type': type,\n      profile: profile\n        ? profile.startsWith('http')\n          ? profile\n          : `http://iiif.io/api/image/2/${profile}.json`\n        : 'http://iiif.io/api/image/2/level0.json',\n      ..._service,\n    } as any;\n  }\n\n  return service;\n}\n\nfunction filterService2Compat(services?: any[]) {\n  if (!services || services.length === 0) {\n    return undefined;\n  }\n\n  return (services as any[]).map(service2compat);\n}\n\nfunction* descriptiveProperties(\n  entity: Partial<DescriptiveNormalized>\n): Generator<any, any, Array<[keyof DescriptiveNormalized, any]>> {\n  return [\n    ['label', entity.label],\n    ['metadata', filterEmpty(entity.metadata)],\n    ['summary', entity.summary],\n    ['requiredStatement', entity.requiredStatement],\n    ['rights', entity.rights],\n    ['navDate', entity.navDate],\n    ['language', entity.language],\n    // We yield these fully as they are embedded in here.\n    ['thumbnail', filterEmpty(yield entity.thumbnail)],\n    ['placeholderCanvas', yield entity.placeholderCanvas],\n    ['accompanyingCanvas', yield entity.accompanyingCanvas],\n\n    // @todo need to test this one.\n    ['provider', filterEmpty(yield entity.provider)],\n  ];\n}\n\nfunction* linkingProperties(\n  entity: Partial<LinkingNormalized>\n): Generator<any, any, Array<[keyof LinkingNormalized, any]>> {\n  return [\n    ['seeAlso', filterEmpty(yield entity.seeAlso)],\n    ['service', filterService2Compat(entity.service)],\n    ['services', filterService2Compat(entity.services)],\n    ['rendering', filterEmpty(yield entity.rendering)],\n    ['supplementary', filterEmpty(yield entity.supplementary)],\n    ['homepage', filterEmpty(yield entity.homepage)],\n    ['logo', filterEmpty(yield entity.logo)],\n\n    // Don't yield these, they are references.\n    ['partOf', filterEmpty(yield entity.partOf)],\n    ['start', entity.start],\n  ];\n}\n\nexport const serializeConfigPresentation3: SerializeConfig = {\n  Manifest: function* (entity, state, { isTopLevel }) {\n    if (!isTopLevel) {\n      return [\n        // Only a snippet.\n        ...technicalProperties(entity),\n        ...(yield* descriptiveProperties(entity)),\n      ];\n    }\n\n    return [\n      ['@context', 'http://iiif.io/api/presentation/3/context.json'],\n      ...technicalProperties(entity),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['items', yield entity.items],\n      ['structures', filterEmpty(yield entity.structures)],\n      ['annotations', filterEmpty(yield entity.annotations)],\n    ];\n  },\n\n  Canvas: function* (entity) {\n    return [\n      // Items.\n      ...technicalProperties(entity),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['items', yield entity.items],\n      ['annotations', filterEmpty(yield entity.annotations)],\n    ];\n  },\n\n  Agent: function* (entity) {\n    return [\n      //\n      ['id', entity.id],\n      ['type', 'Agent'],\n      ['label', entity.label],\n      ...(yield* linkingProperties(entity as any)),\n    ];\n  },\n\n  AnnotationPage: function* (entity) {\n    const entries = Object.entries(entity)\n      .map(([key, item]) => {\n        return [key, Array.isArray(item) ? filterEmpty(item as any) : item];\n      })\n      .filter(([key, value]) => {\n        return key !== 'items';\n      });\n\n    return [\n      // Any more properties?\n      ...entries,\n      ...(yield* linkingProperties(entity)),\n      ['items', yield entity.items],\n    ];\n  },\n\n  Service: function* (entity) {\n    // Are there other properties on a service?\n    return [[UNWRAP, service2compat(entity as any)]];\n  },\n\n  Annotation: function* (entity) {\n    const entries = Object.entries(entity)\n      .map(([key, item]) => {\n        if (key === 'motivation') {\n          // Annotation non-array items can be added here.\n          return [key, Array.isArray(item) ? item[0] : item];\n        }\n\n        return [key, Array.isArray(item) ? filterEmpty(item as any) : item];\n      })\n      .filter(([key]) => {\n        return key !== 'body';\n      });\n\n    const resolvedBody = yield entity.body;\n\n    return [...entries, ['body', resolvedBody.length === 1 ? resolvedBody[0] : resolvedBody]];\n  },\n\n  ContentResource: function* (entity: any) {\n    return [\n      // Image properties.\n      ...technicalProperties(entity),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['annotations', filterEmpty(yield entity.annotations)],\n      ['items', filterEmpty(yield entity.items)],\n    ];\n  },\n\n  AnnotationCollection: function* (entity) {\n    return [\n      // @todo expand properties if they are actually used.\n      ['id', entity.id],\n      ['type', 'AnnotationCollection'],\n      ['label', entity.label],\n    ];\n  },\n\n  Collection: function* (entity, state, { isTopLevel }) {\n    if (isTopLevel) {\n      return [\n        ['@context', 'http://iiif.io/api/presentation/3/context.json'],\n        ...technicalProperties(entity),\n        ...(yield* descriptiveProperties(entity)),\n        ...(yield* linkingProperties(entity)),\n        ['items', filterEmpty(yield entity.items)],\n      ];\n    }\n    return [...technicalProperties(entity), ...(yield* descriptiveProperties(entity))];\n  },\n\n  Range: function* (entity) {\n    const rangeItems = [];\n\n    for (const item of entity.items) {\n      if (item.type === 'Range') {\n        // Resolve the full range\n        rangeItems.push(yield item);\n      } else {\n        // Just push the reference.\n        // @todo could also push in the label of the item?\n        rangeItems.push(item);\n      }\n    }\n\n    return [\n      ...technicalProperties(entity),\n      ...(yield* descriptiveProperties(entity)),\n      ...(yield* linkingProperties(entity)),\n      ['items', rangeItems],\n      ['annotations', filterEmpty(yield entity.annotations)],\n    ];\n  },\n};\n","import * as Presentation2 from './presentation-2';\nimport * as Presentation3 from './presentation-3';\n\nexport default {\n  Presentation2,\n  Presentation3,\n};\n"],"names":["types","identifyResource","resource","Error","Array","isArray","hasType","indexOf","profile","format","Traverse","constructor","traversals","options","__publicField","this","collection","manifest","canvas","annotationList","sequence","annotation","contentResource","choice","range","service","layer","convertPropsToArray","mergeMemberProperties","allowUndefinedReturn","static","traversal","traverseCollection","traverseType","traverseDescriptive","traverseLinking","traverseCollectionItems","members","manifests","map","collections","subCollection","traverseManifest","member","traverseUnknown","traverseManifestItems","sequences","traverseSequence","structures","structure","traverseRange","traverseSequenceItems","canvases","traverseCanvas","traverseCanvasItems","images","image","traverseAnnotation","otherContent","traverseAnnotationList","traverseRangeItems","ranges","innerRange","length","list","traverseAnnotationListItems","resources","traverseAnnotationItems","res","traverseContentResource","on","traverseLayer","traverseLayerItems","traverseChoice","traverseChoiceItems","default","item","traverseService","traverseImageResource","wasArray","resourceList","newResourceList","singleResource","push","thumbnail","logo","traverseOneOrMoreServices","allServices","services","newServices","related","traverseOneOrManyType","rendering","seeAlso","within","startCanvas","contentLayer","object","singleObj","reduce","acc","returnValue","STANFORD_IIIF_IMAGE_COMPLIANCE_1","STANFORD_IIIF_IMAGE_COMPLIANCE_2","STANFORD_IIIF_IMAGE_CONFORMANCE_1","STANFORD_IIIF_IMAGE_CONFORMANCE_2","STANFORD_IIIF_1_IMAGE_COMPLIANCE_1","STANFORD_IIIF_1_IMAGE_COMPLIANCE_2","STANFORD_IIIF_1_IMAGE_CONFORMANCE_1","STANFORD_IIIF_1_IMAGE_CONFORMANCE_2","IIIF_1_IMAGE_LEVEL_1","IIIF_1_IMAGE_LEVEL_1_PROFILE","IIIF_1_IMAGE_LEVEL_2","IIIF_1_IMAGE_LEVEL_2_PROFILE","IIIF_2_IMAGE_LEVEL_1","IIIF_2_IMAGE_LEVEL_1_PROFILE","IIIF_2_IMAGE_LEVEL_2","IIIF_2_IMAGE_LEVEL_2_PROFILE","IIIF_3_IMAGE_LEVEL_1","IIIF_3_IMAGE_LEVEL_2","IIIF_2_IMAGE_LEVEL_1_NO_JSON","IIIF_2_IMAGE_LEVEL_2_NO_JSON","level1Support","imageServiceProfiles","ensureArray","maybeArray","configuration","convertLanguageMapping","inputLangProperty","defaultLang","arrayOfValues","languageMap","language","lang","getProfile","find","s","getTypeFromContext","inputContexts","contexts","context","removePrefix","str","prefix","startsWith","slice","knownTypes","getNewType","id","oldType","type","possibleType","inputProfile","getTypeFromProfile","endsWith","licenseRegex","extractLicense","license","matches","match","removeContexts","fixContext","inputContext","newContexts","removeUndefinedProperties","obj","prop","mintedIdCounter","mintNewIdFromResource","subresource","origId","encodeURI","trim","technicalProperties","allBehaviours","behavior","motivation","viewingHint","height","width","viewingDirection","duration","timeMode","descriptiveProperties","rights","extraMetadata","licenseLabel","metadata","licenseList","rawLicense","singleLicense","label","value","fixLicense","allMetadata","requiredStatement","attribution","navDate","summary","description","parseWithin","withinProperties","returnPartOf","linkingProperties","provider","homepage","partOf","start","supplementary","upgradeContentResource","inputContentResource","chars","presentation2to3","items","allCanvases","technical","annotations","annotationPage","target","upgradeTarget","source","full","selector","upgradeSelector","body","additionalProps","newService","convertPresentation2","entity","includes","region","rotation","EMPTY","Object","freeze","emptyAnnotation","accessibility","audience","bodyValue","canonical","created","creator","generated","generator","modified","stylesheet","via","emptyAnnotationPage","emptyCanvas","posterCanvas","accompanyingCanvas","placeholderCanvas","emptyCollection","emptyManifest","emptyRange","emptyAgent","annotationCollection","agent","traverseAgent","content","collectionOrManifest","traverseInlineAnnotationPages","traversePosterCanvas","traverseManifestStructures","traverseAnnotationPage","traverseAnnotationPageItems","annotationPageJson","traverseAnnotationBody","annotationBody","json","annotationJson","traverseContentResourceLinking","contentResourceJson","choiceItem","traverseRangeRanges","rangeOrManifest","getDefaultEntities","Collection","Manifest","Canvas","AnnotationPage","AnnotationCollection","Annotation","ContentResource","Range","Service","Selector","Agent","getResource","entityOrString","merge","existing","incoming","merged","existingIdx","findIndex","e","key","val","entries","currentVal","mergeEntities","hash","text","JSON","stringify","numHash","index","charCodeAt","hexString","toString","addMissingIdToContentResource","ensureDefaultFields","defaultResource","ensureArrayOnAnnotation","UNSET","UNWRAP","serializedFieldsToObject","fields","languageString2to3","languages","keys","singleValue","join","parseCanvasTarget","t","unNestArray","oneOrArray","onlyOne","convertService","props","serializeConfigPresentation2","_a","filterEmpty","service2compat","_profile","_service","p","filterService2Compat","serializeConfigPresentation3","state","isTopLevel","filter","resolvedBody","rangeItems","Presentation2","Presentation3","unknownEntity","entities","mapping","addToEntities","defaultStringType","storeType","r","assign","mapToEntities","addToMapping","foundType","recordTypeInMapping","subject","config","flatten","sub","url","request","requests","resourceType","resourceUri","resolveIfExists","iterator","current","next","done","requestToHydrate","nextList","req"],"mappings":"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"}