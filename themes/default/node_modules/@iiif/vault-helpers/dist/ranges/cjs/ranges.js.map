{"version":3,"file":"ranges.js","sources":["../../../src/ranges.ts"],"sourcesContent":["import { Vault } from '@iiif/vault';\nimport { ManifestNormalized, RangeNormalized, Reference } from '@iiif/presentation-3';\n\nexport function createRangeHelper(vault: Vault) {\n  return {\n    findFirstCanvasFromRange: (range: RangeNormalized) => findFirstCanvasFromRange(vault, range),\n    findAllCanvasesInRange: (range: RangeNormalized) => findAllCanvasesInRange(vault, range),\n    findManifestSelectedRange: (manifest: ManifestNormalized, canvasId: string) =>\n      findManifestSelectedRange(vault, manifest, canvasId),\n    findSelectedRange: (range: RangeNormalized, canvasId: string) => findSelectedRange(vault, range, canvasId),\n  };\n}\n\nexport function findFirstCanvasFromRange(vault: Vault, range: RangeNormalized): null | Reference<'Canvas'> {\n  for (const inner of range.items) {\n    if (inner.type === 'Canvas') {\n      return inner as Reference<'Canvas'>;\n    }\n    if (inner.type === 'Range') {\n      const found = findFirstCanvasFromRange(vault, vault.get(inner));\n      if (found) {\n        return found;\n      }\n    }\n  }\n  return null;\n}\n\nexport function findAllCanvasesInRange(vault: Vault, range: RangeNormalized): Array<Reference<'Canvas'>> {\n  const found: Reference<'Canvas'>[] = [];\n  for (const inner of range.items) {\n    if (inner.type === 'Canvas') {\n      if (inner.id.indexOf('#') !== -1) {\n        found.push({ id: inner.id.split('#')[0], type: 'Canvas' });\n      } else {\n        found.push(inner as Reference<'Canvas'>);\n      }\n    }\n    if (inner.type === 'Range') {\n      found.push(...findAllCanvasesInRange(vault, vault.get(inner)));\n    }\n    if ((inner as any).type === 'SpecificResource') {\n      const sourceId = typeof (inner as any).source === 'string' ? (inner as any).source : (inner as any).source.id;\n      found.push({ id: sourceId, type: 'Canvas' });\n    }\n  }\n  return found;\n}\n\nexport function findManifestSelectedRange(\n  vault: Vault,\n  manifest: ManifestNormalized,\n  canvasId: string\n): null | RangeNormalized {\n  for (const range of manifest.structures) {\n    const found = findSelectedRange(vault, vault.get(range), canvasId);\n    if (found) {\n      return found;\n    }\n  }\n\n  return null;\n}\n\nexport function findSelectedRange(vault: Vault, range: RangeNormalized, canvasId: string): null | RangeNormalized {\n  for (const inner of range.items) {\n    const parsedId = inner.id?.split('#')[0];\n    if ((inner as any).type === 'SpecificResource' && (inner as any).source === canvasId) {\n      return range;\n    }\n    if (inner.type === 'Canvas' && canvasId === parsedId) {\n      return range;\n    }\n    if (inner.type === 'Range') {\n      const found = findSelectedRange(vault, vault.get(inner), canvasId);\n      if (found) {\n        return found;\n      }\n    }\n  }\n  return null;\n}\n"],"names":["createRangeHelper","vault","range","findFirstCanvasFromRange","findAllCanvasesInRange","manifest","canvasId","findManifestSelectedRange","findSelectedRange","inner","found","sourceId","parsedId","_a"],"mappings":"4GAGO,SAASA,EAAkBC,EAAc,CACvC,MAAA,CACL,yBAA2BC,GAA2BC,EAAyBF,EAAOC,CAAK,EAC3F,uBAAyBA,GAA2BE,EAAuBH,EAAOC,CAAK,EACvF,0BAA2B,CAACG,EAA8BC,IACxDC,EAA0BN,EAAOI,EAAUC,CAAQ,EACrD,kBAAmB,CAACJ,EAAwBI,IAAqBE,EAAkBP,EAAOC,EAAOI,CAAQ,CAAA,CAE7G,CAEgB,SAAAH,EAAyBF,EAAcC,EAAoD,CAC9F,UAAAO,KAASP,EAAM,MAAO,CAC3B,GAAAO,EAAM,OAAS,SACV,OAAAA,EAEL,GAAAA,EAAM,OAAS,QAAS,CAC1B,MAAMC,EAAQP,EAAyBF,EAAOA,EAAM,IAAIQ,CAAK,CAAC,EAC9D,GAAIC,EACK,OAAAA,CAEX,CACF,CACO,OAAA,IACT,CAEgB,SAAAN,EAAuBH,EAAcC,EAAoD,CACvG,MAAMQ,EAA+B,CAAA,EAC1B,UAAAD,KAASP,EAAM,MAWnB,GAVDO,EAAM,OAAS,WACbA,EAAM,GAAG,QAAQ,GAAG,IAAM,GACtBC,EAAA,KAAK,CAAE,GAAID,EAAM,GAAG,MAAM,GAAG,EAAE,GAAI,KAAM,QAAU,CAAA,EAEzDC,EAAM,KAAKD,CAA4B,GAGvCA,EAAM,OAAS,SACXC,EAAA,KAAK,GAAGN,EAAuBH,EAAOA,EAAM,IAAIQ,CAAK,CAAC,CAAC,EAE1DA,EAAc,OAAS,mBAAoB,CACxC,MAAAE,EAAW,OAAQF,EAAc,QAAW,SAAYA,EAAc,OAAUA,EAAc,OAAO,GAC3GC,EAAM,KAAK,CAAE,GAAIC,EAAU,KAAM,SAAU,CAC7C,CAEK,OAAAD,CACT,CAEgB,SAAAH,EACdN,EACAI,EACAC,EACwB,CACb,UAAAJ,KAASG,EAAS,WAAY,CACvC,MAAMK,EAAQF,EAAkBP,EAAOA,EAAM,IAAIC,CAAK,EAAGI,CAAQ,EACjE,GAAII,EACK,OAAAA,CAEX,CAEO,OAAA,IACT,CAEgB,SAAAF,EAAkBP,EAAcC,EAAwBI,EAA0C,OACrG,UAAAG,KAASP,EAAM,MAAO,CAC/B,MAAMU,GAAWC,EAAAJ,EAAM,KAAN,YAAAI,EAAU,MAAM,KAAK,GAItC,GAHKJ,EAAc,OAAS,oBAAuBA,EAAc,SAAWH,GAGxEG,EAAM,OAAS,UAAYH,IAAaM,EACnC,OAAAV,EAEL,GAAAO,EAAM,OAAS,QAAS,CAC1B,MAAMC,EAAQF,EAAkBP,EAAOA,EAAM,IAAIQ,CAAK,EAAGH,CAAQ,EACjE,GAAII,EACK,OAAAA,CAEX,CACF,CACO,OAAA,IACT"}