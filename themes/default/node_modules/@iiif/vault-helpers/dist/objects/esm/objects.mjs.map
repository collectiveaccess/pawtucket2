{"version":3,"file":"objects.mjs","sources":["../../../src/objects.ts"],"sourcesContent":["import { Vault } from '@iiif/vault';\nimport { Manifest, Reference } from '@iiif/presentation-3';\n\nfunction defineProperty(name: string, prototype: any, vault: Vault) {\n  prototype[DEFINED] = prototype[DEFINED] || [];\n  prototype[DEFINED].push(name);\n\n  Object.defineProperty(prototype, name, {\n    get(): any {\n      if (typeof prototype[REFS][name] === 'undefined') {\n        return undefined;\n      }\n\n      const ref = prototype[REFS][name];\n      if (!ref) {\n        return ref;\n      }\n\n      return wrapObject(vault.get(prototype[REFS][name]), vault);\n    },\n    set(items: any) {\n      const existing = prototype[REFS][name];\n      if (existing !== items) {\n        this[REFS][name] = items;\n\n        // This was a hack, but a much more clever implementation here could make very flexible editing.\n        // For example - manifest.label = \"Something\" -> manifest.label = {none: \"something\"}; etc.\n        // Although this might be better in a different library completely.\n        // if (this[REACTIVE]) {\n        //   vault.modifyEntityField({ id: prototype.id, type: prototype.type }, name, unwrapObject(items));\n        // }\n      }\n    },\n  });\n}\n\nconst REFS = Symbol.for('_refs_');\nconst REACTIVE = Symbol.for('_reactive_');\nconst DEFINED = Symbol.for('_defined_');\n\nfunction createPrototype(vault: Vault, reactive = false) {\n  const prototype = {\n    id: null,\n    [DEFINED]: [] as any[],\n    [REFS]: {},\n    [REACTIVE]: null as null | (() => void),\n\n    is(refOrObject: any) {\n      if (typeof refOrObject === 'string') {\n        return this.id === refOrObject;\n      }\n\n      if (refOrObject.id) {\n        return refOrObject.id === this.id;\n      }\n\n      return false;\n    },\n\n    reactive() {\n      if (this[REACTIVE]) {\n        return;\n      }\n\n      this[REACTIVE] = this.subscribe(() => this.refresh(), true);\n\n      return () => {\n        this.unreactive();\n      };\n    },\n\n    refresh() {\n      if (this.id) {\n        const fresh = this.unwrap();\n        for (const key of Object.keys(fresh || {})) {\n          if (this[DEFINED].includes(key)) {\n            (this as any)[REFS][key] = fresh[key as any];\n          } else {\n            (this as any)[key] = fresh[key as any];\n          }\n        }\n      }\n    },\n\n    unreactive() {\n      if (this[REACTIVE]) {\n        this[REACTIVE]();\n        this[REACTIVE] = null;\n      }\n    },\n\n    unwrap() {\n      if (!this.id) {\n        throw new Error('Invalid object');\n      }\n      return vault.get(this.id);\n    },\n\n    toPresentation3() {\n      return vault.toPresentation3(this.unwrap() as any);\n    },\n\n    toPresentation2() {\n      return vault.toPresentation2(this.unwrap() as any);\n    },\n\n    toJSON() {\n      const that = this as any;\n      return {\n        ...that,\n        items: that.items,\n        annotations: that.annotations,\n        structures: that.structures,\n        seeAlso: that.seeAlso,\n        service: that.service,\n        services: that.services,\n        rendering: that.rendering,\n        partOf: that.partOf,\n        start: that.start,\n        supplementary: that.supplementary,\n        homepage: that.homepage,\n        thumbnail: that.thumbnail,\n        placeholderCanvas: that.placeholderCanvas,\n        accompanyingCanvas: that.accompanyingCanvas,\n        provider: that.provider,\n      };\n    },\n    subscribe(subscription: (object: any, vault: Vault) => void, skipInitial = true) {\n      return vault.subscribe(\n        () => {\n          return this.id ? vault.get(this.id) : null;\n        },\n        subscription,\n        skipInitial\n      );\n    },\n  };\n\n  // Structural\n  defineProperty('items', prototype, vault);\n  defineProperty('annotations', prototype, vault);\n  defineProperty('structures', prototype, vault);\n\n  // Linking\n  defineProperty('seeAlso', prototype, vault);\n  defineProperty('service', prototype, vault);\n  defineProperty('services', prototype, vault);\n  defineProperty('rendering', prototype, vault);\n  defineProperty('partOf', prototype, vault);\n  defineProperty('start', prototype, vault);\n  defineProperty('supplementary', prototype, vault);\n  defineProperty('homepage', prototype, vault);\n\n  // Descriptive\n  defineProperty('thumbnail', prototype, vault);\n  defineProperty('placeholderCanvas', prototype, vault);\n  defineProperty('accompanyingCanvas', prototype, vault);\n  defineProperty('provider', prototype, vault);\n\n  // Annotation\n  defineProperty('body', prototype, vault);\n  defineProperty('logo', prototype, vault);\n\n  return prototype;\n}\n\nexport function unwrapObject(object: any): any {\n  if (Array.isArray(object)) {\n    return object.map((o) => unwrapObject(o)) as any;\n  }\n\n  if (!object || !object.type) {\n    return object;\n  }\n\n  return { id: object.id, type: object.type };\n}\n\nexport function wrapObject(object: any, vault: Vault, reactive = false): any {\n  if (Array.isArray(object)) {\n    return object.map((o) => wrapObject(o, vault, reactive));\n  }\n\n  if (!object || !object.type || !object.id) {\n    return object;\n  }\n\n  const prototype = createPrototype(vault, reactive);\n  const newObject = Object.create(prototype);\n\n  const wrapped =  Object.assign(newObject, object) as any;\n\n  if (reactive) {\n    wrapped.reactive();\n  }\n\n  return wrapped;\n}\n\nexport function createObjectsHelper(vault: Vault) {\n  return {\n    get(id: string | Reference | string[] | Reference[], reactive = false) {\n      return wrapObject(vault.get(id as any), vault, reactive);\n    },\n    async load(id: string | Reference<any>, json?: any): Promise<Manifest> {\n      return wrapObject(await vault.load(id, json), vault);\n    },\n    async loadManifest(id: string | Reference<any>, json?: any): Promise<Manifest> {\n      return wrapObject(await vault.loadManifest(id, json), vault);\n    },\n    async loadCollection(id: string | Reference<any>, json?: any) {\n      return wrapObject(await vault.loadCollection(id, json), vault);\n    },\n    wrapObject<T>(objectType: Reference<T>) {\n      return wrapObject(vault.get(objectType, { skipSelfReturn: false }), vault);\n    },\n    isWrapped(object: any) {\n      return !!object[DEFINED];\n    },\n  };\n}\n"],"names":[],"mappings":"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"}