"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});var J=function(){function e(t,a){var r=[],i=!0,s=!1,n=void 0;try{for(var o=t[Symbol.iterator](),u;!(i=(u=o.next()).done)&&(r.push(u.value),!(a&&r.length===a));i=!0);}catch(h){s=!0,n=h}finally{try{!i&&o.return&&o.return()}finally{if(s)throw n}}return r}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),C=Math.PI*2,_=function(t,a,r,i,s,n,o){var u=t.x,h=t.y;u*=a,h*=r;var y=i*u-s*h,f=s*u+i*h;return{x:y+n,y:f+o}},K=function(t,a){var r=a===1.5707963267948966?.551915024494:a===-1.5707963267948966?-.551915024494:1.3333333333333333*Math.tan(a/4),i=Math.cos(t),s=Math.sin(t),n=Math.cos(t+a),o=Math.sin(t+a);return[{x:i-s*r,y:s+i*r},{x:n+o*r,y:o-n*r},{x:n,y:o}]},D=function(t,a,r,i){var s=t*i-a*r<0?-1:1,n=t*r+a*i;return n>1&&(n=1),n<-1&&(n=-1),s*Math.acos(n)},E=function(t,a,r,i,s,n,o,u,h,y,f,d){var v=Math.pow(s,2),c=Math.pow(n,2),w=Math.pow(f,2),b=Math.pow(d,2),M=v*c-v*b-c*w;M<0&&(M=0),M/=v*b+c*w,M=Math.sqrt(M)*(o===u?-1:1);var l=M*s/n*d,p=M*-n/s*f,x=y*l-h*p+(t+r)/2,m=h*l+y*p+(a+i)/2,A=(f-l)/s,g=(d-p)/n,k=(-f-l)/s,S=(-d-p)/n,T=D(1,0,A,g),F=D(A,g,k,S);return u===0&&F>0&&(F-=C),u===1&&F<0&&(F+=C),[x,m,T,F]},tt=function(t){var a=t.px,r=t.py,i=t.cx,s=t.cy,n=t.rx,o=t.ry,u=t.xAxisRotation,h=u===void 0?0:u,y=t.largeArcFlag,f=y===void 0?0:y,d=t.sweepFlag,v=d===void 0?0:d,c=[];if(n===0||o===0)return[];var w=Math.sin(h*C/360),b=Math.cos(h*C/360),M=b*(a-i)/2+w*(r-s)/2,l=-w*(a-i)/2+b*(r-s)/2;if(M===0&&l===0)return[];n=Math.abs(n),o=Math.abs(o);var p=Math.pow(M,2)/Math.pow(n,2)+Math.pow(l,2)/Math.pow(o,2);p>1&&(n*=Math.sqrt(p),o*=Math.sqrt(p));var x=E(a,r,i,s,n,o,f,v,w,b,M,l),m=J(x,4),A=m[0],g=m[1],k=m[2],S=m[3],T=Math.abs(S)/(C/4);Math.abs(1-T)<1e-7&&(T=1);var F=Math.max(Math.ceil(T),1);S/=F;for(var Q=0;Q<F;Q++)c.push(K(k,S)),k+=S;return c.map(function(R){var V=_(R[0],n,o,b,w,A,g),G=V.x,W=V.y,I=_(R[1],n,o,b,w,A,g),Y=I.x,H=I.y,X=_(R[2],n,o,b,w,A,g),Z=X.x,P=X.y;return{x1:G,y1:W,x2:Y,y2:H,x:Z,y:P}})},et=st,B={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0},rt=/([astvzqmhlc])([^astvzqmhlc]*)/ig;function st(e){var t=[];return e.replace(rt,function(a,r,i){var s=r.toLowerCase();for(i=nt(i),s=="m"&&i.length>2&&(t.push([r].concat(i.splice(0,2))),s="l",r=r=="m"?"l":"L");;){if(i.length==B[s])return i.unshift(r),t.push(i);if(i.length<B[s])throw new Error("malformed path data");t.push([r].concat(i.splice(0,B[s])))}}),t}var at=/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/ig;function nt(e){var t=e.match(at);return t?t.map(Number):[]}var it=ot;function ot(e){var t=0,a=0,r=0,i=0;return e.map(function(s){s=s.slice();var n=s[0],o=n.toUpperCase();if(n!=o)switch(s[0]=o,n){case"a":s[6]+=r,s[7]+=i;break;case"v":s[1]+=i;break;case"h":s[1]+=r;break;default:for(var u=1;u<s.length;)s[u++]+=r,s[u++]+=i}switch(o){case"Z":r=t,i=a;break;case"H":r=s[1];break;case"V":i=s[1];break;case"M":r=t=s[1],i=a=s[2];break;default:r=s[s.length-2],i=s[s.length-1]}return s})}function ct(e){const t=et(e),a=it(t);let r,i=0,s=0,n=0,o=0,u,h,y=0,f=0;const d=[];for(let v=0;v<a.length;v++){let c=a[v];const w=c[0];switch(w){case"M":i=c[1],s=c[2];break;case"H":c=["L",c[1],s];break;case"V":c=["L",i,c[1]];break;case"S":{let b=y,M=f;(r==="C"||r=="S")&&(b+=b-n,M+=M-o),c=["C",b,M,c[1],c[2],c[3],c[4]]}break;case"T":r==="Q"||r=="T"?(u=y*2-u,h=f*2-h):(u=y,h=f),c=["Q",u,h,c[1],c[2]];break;case"Q":u=c[1],h=c[2];break;case"A":{const b=tt({px:y,py:f,cx:c[6],cy:c[7],rx:c[1],ry:c[2],xAxisRotation:c[3],largeArcFlag:c[4],sweepFlag:c[5]});if(!b.length)continue;for(const[M,l]of b.entries())c=["C",l.x1,l.y1,l.x2,l.y2,l.x,l.y],M<b.length-1&&d.push(c);c=c}break;case"Z":c=["L",i,s];break}r=w,y=c[c.length-2],f=c[c.length-1],["C","Q","A"].indexOf(w)>-1?(n=c[c.length-4],o=c[c.length-3]):(n=y,o=f),d.push(c)}return d}/** Code to "flatten" quadratic and cubic Bézier curves to polylines.
 *
 * All code in this module is based on JavaScript code by Raph Levien, published on his blog at
 * https://raphlinus.github.io/.
 * I merely changed the structure a bit, removed some unneeded parts and added some comments and type hints.
 *
 * Flattening of quadratic Bézier curves:
 * - Article: https://raphlinus.github.io/graphics/curves/2019/12/23/flatten-quadbez.html
 * - Code: https://github.com/raphlinus/raphlinus.github.io/blob/master/_posts/2019-12-23-flatten-quadbez.md?plain=1#L73-L212
 *
 * Flattening of cubic Bézier curves: https://levien.com/tmp/flatten.html
 *
 * Note that the code in this module has a different license than the rest of the package,
 * due to the inclusion of Apache-licensed third party code.
 *
 * @license
 * Copyright 2022 Johannes Baiter <johannes.baiter@gmail.com>
 * Copyright 2019, 2022 Raph Levien <raph.levien@gmail.com>
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function lt(e,t,a,r=1){return new U(e,t,a).subdivide(r)}function ut(e,t,a,r,i=1){return new $(new Float64Array([e.x,e.y,t.x,t.y,a.x,a.y,r.x,r.y])).subdivide(i)}function pt(e){return e.x*e.x+e.y*e.y}function L(e){return e/(1-.67+Math.pow(Math.pow(.67,4)+.25*e*e,.25))}function O(e){return e*(1-.39+Math.sqrt(.39*.39+.25*e*e))}class U{constructor(t,a,r){this.start=t,this.control=a,this.end=r}eval(t){const a=1-t;return{x:this.start.x*a*a+2*this.control.x*a*t+this.end.x*t*t,y:this.start.y*a*a+2*this.control.y*a*t+this.end.y*t*t}}mapToBasic(){const{x:t,y:a}=this.start,{x:r,y:i}=this.control,{x:s,y:n}=this.end,o=2*r-t-s,u=2*i-a-n,h=(r-t)*o+(i-a)*u,y=(s-r)*o+(n-i)*u,f=(s-t)*u-(n-a)*o,d=h/f,v=y/f,c=Math.abs(f)/(Math.hypot(o,u)*Math.abs(v-d));return{x0:t,x2:s,scale:c,cross:f}}subdivide(t){const a=this.mapToBasic(),r=L(a.x0),i=L(a.x2),s=.5*Math.abs(i-r)*Math.sqrt(a.scale/t),n=Math.ceil(s),o=O(r),u=O(i),h=[0];for(let y=1;y<n;y++){const d=(O(r+(i-r)*y/n)-o)/(u-o);h.push(d)}return h.push(1),h.map(y=>this.eval(y))}}class ${constructor(t){this.c=t}weightsum(t,a,r,i){const s=t*this.c[0]+a*this.c[2]+r*this.c[4]+i*this.c[6],n=t*this.c[1]+a*this.c[3]+r*this.c[5]+i*this.c[7];return{x:s,y:n}}eval(t){const a=1-t,r=a*a*a,i=3*a*a*t,s=3*a*t*t,n=t*t*t;return this.weightsum(r,i,s,n)}deriv(t){const a=1-t,r=-3*a*a,i=3*t*t,s=-6*t*a-r,n=6*t*a-i;return this.weightsum(r,s,n,i)}midpoint_quadbez(){const t=this.weightsum(-.25,.75,.75,-.25);return new U({x:this.c[0],y:this.c[1]},t,{x:this.c[6],y:this.c[7]})}subsegment(t,a){const r=new Float64Array(8),i=this.eval(t),s=this.eval(a);r[0]=i.x,r[1]=i.y;const n=(a-t)/3,o=this.deriv(t);r[2]=i.x+n*o.x,r[3]=i.y+n*o.y;const u=this.deriv(a);return r[4]=s.x-n*u.x,r[5]=s.y-n*u.y,r[6]=s.x,r[7]=s.y,new $(r)}subdivide(t){const a=.1*t,r=t-a,i=Math.sqrt(r),s=pt(this.weightsum(1,-3,3,-1)),n=Math.ceil(Math.pow(s/(432*a*a),1/6)),o=[];let u=0;for(let c=0;c<n;c++){const w=c/n,b=(c+1)/n,M=this.subsegment(w,b).midpoint_quadbez(),l=M.mapToBasic(),p=L(l.x0),x=L(l.x2),m=Math.sqrt(l.scale);let A=Math.abs(x-p)*m;if(Math.sign(l.x0)!=Math.sign(l.x2)){const g=i/m,k=i*Math.abs(x-p)/L(g);A=Math.max(A,k)}o.push({quad:M,a0:p,a2:x,val:A}),u+=A}const h=.5*u/i,y=Math.ceil(h),f=[{x:this.c[0],y:this.c[1]}];let d=0,v=0;for(let c=1;c<y;c++){const w=u*c/y;for(;d+o[v].val<w;)d+=o[v].val,v++;const b=o[v].a0,M=o[v].a2,l=O(b),p=O(M),x=b+(M-b)*(w-d)/o[v].val,A=(O(x)-l)/(p-l);f.push(o[v].quad.eval(A))}return f.push({x:this.c[6],y:this.c[7]}),f}}const ht=/&?(xywh=)?(pixel:|percent:|pct:)?([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?)/,yt=/&?(t=)(npt:)?([0-9]+(.[0-9]+)?)?(,([0-9]+(.[0-9]+)?))?/,N=/^rgba\((\d+),(\d+),(\d+),([0-9.]+)\)$/;function z(e,{domParser:t,svgPreprocessor:a}={}){var r,i;if(Array.isArray(e))return e.reduce((s,n)=>{const{selector:o,selectors:u}=z(n);return o&&(s.selector||(s.selector=o),s.selectors.push(...u)),s},{selector:null,selectors:[]});if(!e)return{selector:null,selectors:[]};if(typeof e=="string"){const[s,n]=e.split("#");return n?z({type:"FragmentSelector",value:n}):{selector:null,selectors:[]}}if(e.type==="PointSelector"&&(e.t||e.t===0)){const s={type:"TemporalSelector",temporal:{startTime:e.t}};return{selector:s,selectors:[s]}}if(e.type==="FragmentSelector"){const s=ht.exec(e.value);if(s){const o={type:"BoxSelector",spatial:{unit:s[2]==="percent:"||s[2]==="pct:"?"percent":"pixel",x:parseFloat(s[3]),y:parseFloat(s[4]),width:parseFloat(s[5]),height:parseFloat(s[6])}};return{selector:o,selectors:[o]}}const n=e.value.match(yt);if(n){const o={type:"TemporalSelector",temporal:{startTime:n[4]?parseFloat(n[4]):0,endTime:n[7]?parseFloat(n[7]):void 0}};return{selector:o,selectors:[o]}}return{selector:null,selectors:[]}}if(e.type==="SvgSelector"&&"value"in e){t||(typeof window!="undefined"?t=new window.DOMParser:console.warn("No DOMParser available, cannot parse SVG selector, `points`, `spatial` and `style` will be unavailable and the SVG will not be normalized."));let s=[],n,o,u=(r=a==null?void 0:a(e.value))!=null?r:e.value,h;if(t){const f=t.parseFromString(e.value,"image/svg+xml").querySelector("svg");if(!f)return console.warn(`Illegal SVG selector: ${e.value}`),{selector:null,selectors:[]};const d=j(f);d&&(s=d.points,h=d.shapeType,n=[Math.min(...s.map(v=>v[0])),Math.min(...s.map(v=>v[1])),Math.max(...s.map(v=>v[0])),Math.max(...s.map(v=>v[1]))],{style:o,svg:u}=(i=xt(d.element))!=null?i:{svg:u})}const y={type:"SvgSelector",svg:u,svgShape:h,style:o,points:s.length?s:void 0,spatial:n?{unit:"pixel",x:n[0],y:n[1],width:n[2]-n[0],height:n[3]-n[1]}:void 0};return{selector:y,selectors:[y]}}return{selector:null,selectors:[]}}function ft(e){const t=e.map(r=>r[0]).reduce((r,i)=>(r[i]+=1,r),{C:0,Q:0,L:0,M:0}),a=new Set(e.map(r=>r[0]));if(t.C>0||t.Q>0)return"path";if(t.L>0&&(a.size===1||a.size===2&&a.has("M"))){if(t.L===4)return"rect";const r=e.slice(-1)[0];return e[0][0]==="M"&&r[0]==="L"&&r[1]==e[0][1]&&r[2]===e[0][2]||r[1]===0&&r[2]===0?"polygon":"polyline"}return"path"}function j(e){var t,a,r,i,s,n,o,u,h,y,f,d,v,c,w,b,M;for(const l of Array.from(e.children))switch(l==null?void 0:l.tagName.toLowerCase()){case"g":{const p=j(l);if(p)return p}continue;case"path":{const p=l.getAttribute("d");if(!p)continue;const x=ct(p);return{element:l,points:vt(x),shapeType:ft(x)}}case"circle":{const p=parseFloat((t=l.getAttribute("cx"))!=null?t:"0"),x=parseFloat((a=l.getAttribute("cy"))!=null?a:"0"),m=parseFloat((r=l.getAttribute("r"))!=null?r:"0");if(!m)continue;const A=[];for(let g=0;g<=360;g+=12){const k=g*Math.PI/180;A.push([p+m*Math.cos(k),x+m*Math.sin(k)])}return{element:l,points:A,shapeType:"circle"}}case"ellipse":{const p=parseFloat((i=l.getAttribute("cx"))!=null?i:"0"),x=parseFloat((s=l.getAttribute("cy"))!=null?s:"0"),m=parseFloat((n=l.getAttribute("rx"))!=null?n:"0"),A=parseFloat((o=l.getAttribute("ry"))!=null?o:"0");if(!m&&!A)continue;const g=[];for(let k=0;k<=360;k+=12){const S=Math.tan(k/360*Math.PI),T=m*(1-S**2)/(1+S**2),F=A*2*S/(1+S**2);g.push([p+T,x+F])}return{element:l,points:g,shapeType:"ellipse"}}case"line":{const p=parseFloat((u=l.getAttribute("x0"))!=null?u:"0"),x=parseFloat((h=l.getAttribute("y0"))!=null?h:"0"),m=parseFloat((y=l.getAttribute("x1"))!=null?y:"0"),A=parseFloat((f=l.getAttribute("y1"))!=null?f:"0");if(p===m&&x===A)continue;return{element:l,points:[[p,x],[m,A]],shapeType:"polyline"}}case"polygon":case"polyline":{const p=(v=(d=l.getAttribute("points"))==null?void 0:d.split(" ").map(m=>m.split(",").map(parseFloat)))!=null?v:[];if(!p.length)continue;let x="polyline";return l.tagName.toLowerCase()==="polygon"&&(p.push(p[0]),x="polygon"),{element:l,points:p,shapeType:x}}case"rect":{const p=parseFloat((c=l.getAttribute("x"))!=null?c:"0"),x=parseFloat((w=l.getAttribute("y"))!=null?w:"0"),m=parseFloat((b=l.getAttribute("width"))!=null?b:"0"),A=parseFloat((M=l.getAttribute("height"))!=null?M:"0");if(!m||!A)continue;return{element:l,points:[[p,x],[p+m,x],[p+m,x+A],[p,x+A],[p,x]],shapeType:"rect"}}default:continue}return null}function vt(e){var a;const t=[];for(let r=0;r<e.length;r++){const i=(a=t[t.length-1])!=null?a:[0,0],s=e[r];switch(s[0]){case"M":case"L":t.push([s[1],s[2]]);continue;case"C":t.push(...ut({x:i[0],y:i[1]},{x:s[1],y:s[2]},{x:s[3],y:s[4]},{x:s[5],y:s[6]}).map(n=>[n.x,n.y]).slice(1));continue;case"Q":t.push(...lt({x:i[0],y:i[1]},{x:s[1],y:s[2]},{x:s[3],y:s[4]}).map(n=>[n.x,n.y]).slice(1));continue}}return t}function xt(e){const t={};if(e.hasAttribute("fill")?(t.fill=e.getAttribute("fill"),e.removeAttribute("fill")):e.style.fill&&(t.fill=e.style.fill),t.fill){const r=N.exec(t.fill);r&&(t.fillOpacity=parseFloat(r[4]),t.fill=`rgb(${r[1]}, ${r[2]}, ${r[3]})`)}if(e.hasAttribute("fill-opacity")?(t.fillOpacity=parseFloat(e.getAttribute("fill-opacity")),e.removeAttribute("fill-opacity")):e.style.fillOpacity&&(t.fillOpacity=parseFloat(e.style.fillOpacity)),e.hasAttribute("stroke")?(t.stroke=e.getAttribute("stroke"),e.removeAttribute("stroke")):e.style.stroke&&(t.stroke=e.style.stroke),t.stroke){const r=N.exec(t.stroke);r&&(t.strokeOpacity=parseFloat(r[4]),t.stroke=`rgb(${r[1]}, ${r[2]}, ${r[3]})`)}e.hasAttribute("stroke-opacity")?(t.strokeOpacity=parseFloat(e.getAttribute("stroke-opacity")),e.removeAttribute("stroke-opacity")):e.style.strokeOpacity&&(t.strokeOpacity=parseFloat(e.style.strokeOpacity)),e.hasAttribute("stroke-width")?(t.strokeWidth=e.getAttribute("stroke-width"),e.removeAttribute("stroke-width")):e.style.strokeWidth&&(t.strokeWidth=e.style.strokeWidth),e.hasAttribute("stroke-dasharray")?(t.strokeDasharray=e.getAttribute("stroke-dasharray"),e.removeAttribute("stroke-dasharray")):e.style.strokeDasharray&&(t.strokeDasharray=e.style.strokeDasharray);let a=e;for(;a.tagName.toLowerCase()!=="svg";)if(a=a.parentElement,a===null)throw new Error("Could not find root SVG element");return{svg:a.outerHTML,style:Object.keys(t).length>0?t:void 0}}function q(e,t={}){if(Array.isArray(e))return q(e[0]);if(typeof e=="string"){const[a,r]=e.split("#");return r?q({type:"SpecificResource",source:{id:a,type:"Unknown"},selector:{type:"FragmentSelector",value:r}}):{type:"SpecificResource",source:{id:a,type:t.typeMap&&t.typeMap[a]||"Unknown"},selector:null,selectors:[]}}if(e.type==="Choice"||e.type==="List"||e.type==="Composite"||e.type==="Independents")return q(e.items[0]);if(e.type==="SpecificResource"){e.source.type==="Canvas"&&e.source.partOf&&typeof e.source.partOf=="string"&&(e.source.partOf=[{id:e.source.partOf,type:"Manifest"}]);const{selector:a,selectors:r}=e.selector?z(e.selector,t):{selector:null,selectors:[]};return{type:"SpecificResource",source:e.source,selector:a,selectors:r}}if(e.id){e.type==="Canvas"&&e.partOf&&typeof e.partOf=="string"&&(e.partOf=[{id:e.partOf,type:"Manifest"}]);const[a,r]=e.id.split("#");return r?q({type:"SpecificResource",source:{...e,id:a},selector:{type:"FragmentSelector",value:r}}):{type:"SpecificResource",source:{...e,id:a},selector:null,selectors:[]}}return{type:"SpecificResource",source:e,selector:null,selectors:[]}}exports.expandTarget=q;exports.parseSelector=z;
//# sourceMappingURL=annotation-targets.js.map
