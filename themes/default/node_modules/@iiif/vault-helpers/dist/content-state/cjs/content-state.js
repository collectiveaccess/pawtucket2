"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});var et=function(){function t(e,a){var r=[],o=!0,n=!1,s=void 0;try{for(var i=e[Symbol.iterator](),u;!(o=(u=i.next()).done)&&(r.push(u.value),!(a&&r.length===a));o=!0);}catch(f){n=!0,s=f}finally{try{!o&&i.return&&i.return()}finally{if(n)throw s}}return r}return function(e,a){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),q=Math.PI*2,z=function(e,a,r,o,n,s,i){var u=e.x,f=e.y;u*=a,f*=r;var h=o*u-n*f,y=n*u+o*f;return{x:h+s,y:y+i}},rt=function(e,a){var r=a===1.5707963267948966?.551915024494:a===-1.5707963267948966?-.551915024494:1.3333333333333333*Math.tan(a/4),o=Math.cos(e),n=Math.sin(e),s=Math.cos(e+a),i=Math.sin(e+a);return[{x:o-n*r,y:n+o*r},{x:s+i*r,y:i-s*r},{x:s,y:i}]},V=function(e,a,r,o){var n=e*o-a*r<0?-1:1,s=e*r+a*o;return s>1&&(s=1),s<-1&&(s=-1),n*Math.acos(s)},at=function(e,a,r,o,n,s,i,u,f,h,y,x){var d=Math.pow(n,2),c=Math.pow(s,2),w=Math.pow(y,2),b=Math.pow(x,2),g=d*c-d*b-c*w;g<0&&(g=0),g/=d*b+c*w,g=Math.sqrt(g)*(i===u?-1:1);var l=g*n/s*x,p=g*-s/n*y,v=h*l-f*p+(e+r)/2,m=f*l+h*p+(a+o)/2,A=(y-l)/n,M=(x-p)/s,S=(-y-l)/n,k=(-x-p)/s,F=V(1,0,A,M),C=V(A,M,S,k);return u===0&&C>0&&(C-=q),u===1&&C<0&&(C+=q),[v,m,F,C]},nt=function(e){var a=e.px,r=e.py,o=e.cx,n=e.cy,s=e.rx,i=e.ry,u=e.xAxisRotation,f=u===void 0?0:u,h=e.largeArcFlag,y=h===void 0?0:h,x=e.sweepFlag,d=x===void 0?0:x,c=[];if(s===0||i===0)return[];var w=Math.sin(f*q/360),b=Math.cos(f*q/360),g=b*(a-o)/2+w*(r-n)/2,l=-w*(a-o)/2+b*(r-n)/2;if(g===0&&l===0)return[];s=Math.abs(s),i=Math.abs(i);var p=Math.pow(g,2)/Math.pow(s,2)+Math.pow(l,2)/Math.pow(i,2);p>1&&(s*=Math.sqrt(p),i*=Math.sqrt(p));var v=at(a,r,o,n,s,i,y,d,w,b,g,l),m=et(v,4),A=m[0],M=m[1],S=m[2],k=m[3],F=Math.abs(k)/(q/4);Math.abs(1-F)<1e-7&&(F=1);var C=Math.max(Math.ceil(F),1);k/=C;for(var $=0;$<C;$++)c.push(rt(S,k)),S+=k;return c.map(function(R){var Q=z(R[0],s,i,b,w,A,M),H=Q.x,P=Q.y,D=z(R[1],s,i,b,w,A,M),Z=D.x,K=D.y,U=z(R[2],s,i,b,w,A,M),E=U.x,tt=U.y;return{x1:H,y1:P,x2:Z,y2:K,x:E,y:tt}})},st=it,_={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0},ot=/([astvzqmhlc])([^astvzqmhlc]*)/ig;function it(t){var e=[];return t.replace(ot,function(a,r,o){var n=r.toLowerCase();for(o=lt(o),n=="m"&&o.length>2&&(e.push([r].concat(o.splice(0,2))),n="l",r=r=="m"?"l":"L");;){if(o.length==_[n])return o.unshift(r),e.push(o);if(o.length<_[n])throw new Error("malformed path data");e.push([r].concat(o.splice(0,_[n])))}}),e}var ct=/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/ig;function lt(t){var e=t.match(ct);return e?e.map(Number):[]}var ut=pt;function pt(t){var e=0,a=0,r=0,o=0;return t.map(function(n){n=n.slice();var s=n[0],i=s.toUpperCase();if(s!=i)switch(n[0]=i,s){case"a":n[6]+=r,n[7]+=o;break;case"v":n[1]+=o;break;case"h":n[1]+=r;break;default:for(var u=1;u<n.length;)n[u++]+=r,n[u++]+=o}switch(i){case"Z":r=e,o=a;break;case"H":r=n[1];break;case"V":o=n[1];break;case"M":r=e=n[1],o=a=n[2];break;default:r=n[n.length-2],o=n[n.length-1]}return n})}function ft(t){const e=st(t),a=ut(e);let r,o=0,n=0,s=0,i=0,u,f,h=0,y=0;const x=[];for(let d=0;d<a.length;d++){let c=a[d];const w=c[0];switch(w){case"M":o=c[1],n=c[2];break;case"H":c=["L",c[1],n];break;case"V":c=["L",o,c[1]];break;case"S":{let b=h,g=y;(r==="C"||r=="S")&&(b+=b-s,g+=g-i),c=["C",b,g,c[1],c[2],c[3],c[4]]}break;case"T":r==="Q"||r=="T"?(u=h*2-u,f=y*2-f):(u=h,f=y),c=["Q",u,f,c[1],c[2]];break;case"Q":u=c[1],f=c[2];break;case"A":{const b=nt({px:h,py:y,cx:c[6],cy:c[7],rx:c[1],ry:c[2],xAxisRotation:c[3],largeArcFlag:c[4],sweepFlag:c[5]});if(!b.length)continue;for(const[g,l]of b.entries())c=["C",l.x1,l.y1,l.x2,l.y2,l.x,l.y],g<b.length-1&&x.push(c);c=c}break;case"Z":c=["L",o,n];break}r=w,h=c[c.length-2],y=c[c.length-1],["C","Q","A"].indexOf(w)>-1?(s=c[c.length-4],i=c[c.length-3]):(s=h,i=y),x.push(c)}return x}/** Code to "flatten" quadratic and cubic Bézier curves to polylines.
 *
 * All code in this module is based on JavaScript code by Raph Levien, published on his blog at
 * https://raphlinus.github.io/.
 * I merely changed the structure a bit, removed some unneeded parts and added some comments and type hints.
 *
 * Flattening of quadratic Bézier curves:
 * - Article: https://raphlinus.github.io/graphics/curves/2019/12/23/flatten-quadbez.html
 * - Code: https://github.com/raphlinus/raphlinus.github.io/blob/master/_posts/2019-12-23-flatten-quadbez.md?plain=1#L73-L212
 *
 * Flattening of cubic Bézier curves: https://levien.com/tmp/flatten.html
 *
 * Note that the code in this module has a different license than the rest of the package,
 * due to the inclusion of Apache-licensed third party code.
 *
 * @license
 * Copyright 2022 Johannes Baiter <johannes.baiter@gmail.com>
 * Copyright 2019, 2022 Raph Levien <raph.levien@gmail.com>
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ht(t,e,a,r=1){return new j(t,e,a).subdivide(r)}function yt(t,e,a,r,o=1){return new N(new Float64Array([t.x,t.y,e.x,e.y,a.x,a.y,r.x,r.y])).subdivide(o)}function dt(t){return t.x*t.x+t.y*t.y}function L(t){return t/(1-.67+Math.pow(Math.pow(.67,4)+.25*t*t,.25))}function O(t){return t*(1-.39+Math.sqrt(.39*.39+.25*t*t))}class j{constructor(e,a,r){this.start=e,this.control=a,this.end=r}eval(e){const a=1-e;return{x:this.start.x*a*a+2*this.control.x*a*e+this.end.x*e*e,y:this.start.y*a*a+2*this.control.y*a*e+this.end.y*e*e}}mapToBasic(){const{x:e,y:a}=this.start,{x:r,y:o}=this.control,{x:n,y:s}=this.end,i=2*r-e-n,u=2*o-a-s,f=(r-e)*i+(o-a)*u,h=(n-r)*i+(s-o)*u,y=(n-e)*u-(s-a)*i,x=f/y,d=h/y,c=Math.abs(y)/(Math.hypot(i,u)*Math.abs(d-x));return{x0:e,x2:n,scale:c,cross:y}}subdivide(e){const a=this.mapToBasic(),r=L(a.x0),o=L(a.x2),n=.5*Math.abs(o-r)*Math.sqrt(a.scale/e),s=Math.ceil(n),i=O(r),u=O(o),f=[0];for(let h=1;h<s;h++){const x=(O(r+(o-r)*h/s)-i)/(u-i);f.push(x)}return f.push(1),f.map(h=>this.eval(h))}}class N{constructor(e){this.c=e}weightsum(e,a,r,o){const n=e*this.c[0]+a*this.c[2]+r*this.c[4]+o*this.c[6],s=e*this.c[1]+a*this.c[3]+r*this.c[5]+o*this.c[7];return{x:n,y:s}}eval(e){const a=1-e,r=a*a*a,o=3*a*a*e,n=3*a*e*e,s=e*e*e;return this.weightsum(r,o,n,s)}deriv(e){const a=1-e,r=-3*a*a,o=3*e*e,n=-6*e*a-r,s=6*e*a-o;return this.weightsum(r,n,s,o)}midpoint_quadbez(){const e=this.weightsum(-.25,.75,.75,-.25);return new j({x:this.c[0],y:this.c[1]},e,{x:this.c[6],y:this.c[7]})}subsegment(e,a){const r=new Float64Array(8),o=this.eval(e),n=this.eval(a);r[0]=o.x,r[1]=o.y;const s=(a-e)/3,i=this.deriv(e);r[2]=o.x+s*i.x,r[3]=o.y+s*i.y;const u=this.deriv(a);return r[4]=n.x-s*u.x,r[5]=n.y-s*u.y,r[6]=n.x,r[7]=n.y,new N(r)}subdivide(e){const a=.1*e,r=e-a,o=Math.sqrt(r),n=dt(this.weightsum(1,-3,3,-1)),s=Math.ceil(Math.pow(n/(432*a*a),1/6)),i=[];let u=0;for(let c=0;c<s;c++){const w=c/s,b=(c+1)/s,g=this.subsegment(w,b).midpoint_quadbez(),l=g.mapToBasic(),p=L(l.x0),v=L(l.x2),m=Math.sqrt(l.scale);let A=Math.abs(v-p)*m;if(Math.sign(l.x0)!=Math.sign(l.x2)){const M=o/m,S=o*Math.abs(v-p)/L(M);A=Math.max(A,S)}i.push({quad:g,a0:p,a2:v,val:A}),u+=A}const f=.5*u/o,h=Math.ceil(f),y=[{x:this.c[0],y:this.c[1]}];let x=0,d=0;for(let c=1;c<h;c++){const w=u*c/h;for(;x+i[d].val<w;)x+=i[d].val,d++;const b=i[d].a0,g=i[d].a2,l=O(b),p=O(g),v=b+(g-b)*(w-x)/i[d].val,A=(O(v)-l)/(p-l);y.push(i[d].quad.eval(A))}return y.push({x:this.c[6],y:this.c[7]}),y}}const vt=/&?(xywh=)?(pixel:|percent:|pct:)?([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?)/,xt=/&?(t=)(npt:)?([0-9]+(.[0-9]+)?)?(,([0-9]+(.[0-9]+)?))?/,X=/^rgba\((\d+),(\d+),(\d+),([0-9.]+)\)$/;function B(t,{domParser:e,svgPreprocessor:a}={}){var r,o;if(Array.isArray(t))return t.reduce((n,s)=>{const{selector:i,selectors:u}=B(s);return i&&(n.selector||(n.selector=i),n.selectors.push(...u)),n},{selector:null,selectors:[]});if(!t)return{selector:null,selectors:[]};if(typeof t=="string"){const[n,s]=t.split("#");return s?B({type:"FragmentSelector",value:s}):{selector:null,selectors:[]}}if(t.type==="PointSelector"&&(t.t||t.t===0)){const n={type:"TemporalSelector",temporal:{startTime:t.t}};return{selector:n,selectors:[n]}}if(t.type==="FragmentSelector"){const n=vt.exec(t.value);if(n){const i={type:"BoxSelector",spatial:{unit:n[2]==="percent:"||n[2]==="pct:"?"percent":"pixel",x:parseFloat(n[3]),y:parseFloat(n[4]),width:parseFloat(n[5]),height:parseFloat(n[6])}};return{selector:i,selectors:[i]}}const s=t.value.match(xt);if(s){const i={type:"TemporalSelector",temporal:{startTime:s[4]?parseFloat(s[4]):0,endTime:s[7]?parseFloat(s[7]):void 0}};return{selector:i,selectors:[i]}}return{selector:null,selectors:[]}}if(t.type==="SvgSelector"&&"value"in t){e||(typeof window!="undefined"?e=new window.DOMParser:console.warn("No DOMParser available, cannot parse SVG selector, `points`, `spatial` and `style` will be unavailable and the SVG will not be normalized."));let n=[],s,i,u=(r=a==null?void 0:a(t.value))!=null?r:t.value,f;if(e){const y=e.parseFromString(t.value,"image/svg+xml").querySelector("svg");if(!y)return console.warn(`Illegal SVG selector: ${t.value}`),{selector:null,selectors:[]};const x=W(y);x&&(n=x.points,f=x.shapeType,s=[Math.min(...n.map(d=>d[0])),Math.min(...n.map(d=>d[1])),Math.max(...n.map(d=>d[0])),Math.max(...n.map(d=>d[1]))],{style:i,svg:u}=(o=mt(x.element))!=null?o:{svg:u})}const h={type:"SvgSelector",svg:u,svgShape:f,style:i,points:n.length?n:void 0,spatial:s?{unit:"pixel",x:s[0],y:s[1],width:s[2]-s[0],height:s[3]-s[1]}:void 0};return{selector:h,selectors:[h]}}return{selector:null,selectors:[]}}function bt(t){const e=t.map(r=>r[0]).reduce((r,o)=>(r[o]+=1,r),{C:0,Q:0,L:0,M:0}),a=new Set(t.map(r=>r[0]));if(e.C>0||e.Q>0)return"path";if(e.L>0&&(a.size===1||a.size===2&&a.has("M"))){if(e.L===4)return"rect";const r=t.slice(-1)[0];return t[0][0]==="M"&&r[0]==="L"&&r[1]==t[0][1]&&r[2]===t[0][2]||r[1]===0&&r[2]===0?"polygon":"polyline"}return"path"}function W(t){var e,a,r,o,n,s,i,u,f,h,y,x,d,c,w,b,g;for(const l of Array.from(t.children))switch(l==null?void 0:l.tagName.toLowerCase()){case"g":{const p=W(l);if(p)return p}continue;case"path":{const p=l.getAttribute("d");if(!p)continue;const v=ft(p);return{element:l,points:gt(v),shapeType:bt(v)}}case"circle":{const p=parseFloat((e=l.getAttribute("cx"))!=null?e:"0"),v=parseFloat((a=l.getAttribute("cy"))!=null?a:"0"),m=parseFloat((r=l.getAttribute("r"))!=null?r:"0");if(!m)continue;const A=[];for(let M=0;M<=360;M+=12){const S=M*Math.PI/180;A.push([p+m*Math.cos(S),v+m*Math.sin(S)])}return{element:l,points:A,shapeType:"circle"}}case"ellipse":{const p=parseFloat((o=l.getAttribute("cx"))!=null?o:"0"),v=parseFloat((n=l.getAttribute("cy"))!=null?n:"0"),m=parseFloat((s=l.getAttribute("rx"))!=null?s:"0"),A=parseFloat((i=l.getAttribute("ry"))!=null?i:"0");if(!m&&!A)continue;const M=[];for(let S=0;S<=360;S+=12){const k=Math.tan(S/360*Math.PI),F=m*(1-k**2)/(1+k**2),C=A*2*k/(1+k**2);M.push([p+F,v+C])}return{element:l,points:M,shapeType:"ellipse"}}case"line":{const p=parseFloat((u=l.getAttribute("x0"))!=null?u:"0"),v=parseFloat((f=l.getAttribute("y0"))!=null?f:"0"),m=parseFloat((h=l.getAttribute("x1"))!=null?h:"0"),A=parseFloat((y=l.getAttribute("y1"))!=null?y:"0");if(p===m&&v===A)continue;return{element:l,points:[[p,v],[m,A]],shapeType:"polyline"}}case"polygon":case"polyline":{const p=(d=(x=l.getAttribute("points"))==null?void 0:x.split(" ").map(m=>m.split(",").map(parseFloat)))!=null?d:[];if(!p.length)continue;let v="polyline";return l.tagName.toLowerCase()==="polygon"&&(p.push(p[0]),v="polygon"),{element:l,points:p,shapeType:v}}case"rect":{const p=parseFloat((c=l.getAttribute("x"))!=null?c:"0"),v=parseFloat((w=l.getAttribute("y"))!=null?w:"0"),m=parseFloat((b=l.getAttribute("width"))!=null?b:"0"),A=parseFloat((g=l.getAttribute("height"))!=null?g:"0");if(!m||!A)continue;return{element:l,points:[[p,v],[p+m,v],[p+m,v+A],[p,v+A],[p,v]],shapeType:"rect"}}default:continue}return null}function gt(t){var a;const e=[];for(let r=0;r<t.length;r++){const o=(a=e[e.length-1])!=null?a:[0,0],n=t[r];switch(n[0]){case"M":case"L":e.push([n[1],n[2]]);continue;case"C":e.push(...yt({x:o[0],y:o[1]},{x:n[1],y:n[2]},{x:n[3],y:n[4]},{x:n[5],y:n[6]}).map(s=>[s.x,s.y]).slice(1));continue;case"Q":e.push(...ht({x:o[0],y:o[1]},{x:n[1],y:n[2]},{x:n[3],y:n[4]}).map(s=>[s.x,s.y]).slice(1));continue}}return e}function mt(t){const e={};if(t.hasAttribute("fill")?(e.fill=t.getAttribute("fill"),t.removeAttribute("fill")):t.style.fill&&(e.fill=t.style.fill),e.fill){const r=X.exec(e.fill);r&&(e.fillOpacity=parseFloat(r[4]),e.fill=`rgb(${r[1]}, ${r[2]}, ${r[3]})`)}if(t.hasAttribute("fill-opacity")?(e.fillOpacity=parseFloat(t.getAttribute("fill-opacity")),t.removeAttribute("fill-opacity")):t.style.fillOpacity&&(e.fillOpacity=parseFloat(t.style.fillOpacity)),t.hasAttribute("stroke")?(e.stroke=t.getAttribute("stroke"),t.removeAttribute("stroke")):t.style.stroke&&(e.stroke=t.style.stroke),e.stroke){const r=X.exec(e.stroke);r&&(e.strokeOpacity=parseFloat(r[4]),e.stroke=`rgb(${r[1]}, ${r[2]}, ${r[3]})`)}t.hasAttribute("stroke-opacity")?(e.strokeOpacity=parseFloat(t.getAttribute("stroke-opacity")),t.removeAttribute("stroke-opacity")):t.style.strokeOpacity&&(e.strokeOpacity=parseFloat(t.style.strokeOpacity)),t.hasAttribute("stroke-width")?(e.strokeWidth=t.getAttribute("stroke-width"),t.removeAttribute("stroke-width")):t.style.strokeWidth&&(e.strokeWidth=t.style.strokeWidth),t.hasAttribute("stroke-dasharray")?(e.strokeDasharray=t.getAttribute("stroke-dasharray"),t.removeAttribute("stroke-dasharray")):t.style.strokeDasharray&&(e.strokeDasharray=t.style.strokeDasharray);let a=t;for(;a.tagName.toLowerCase()!=="svg";)if(a=a.parentElement,a===null)throw new Error("Could not find root SVG element");return{svg:a.outerHTML,style:Object.keys(e).length>0?e:void 0}}function T(t,e={}){if(Array.isArray(t))return T(t[0]);if(typeof t=="string"){const[a,r]=t.split("#");return r?T({type:"SpecificResource",source:{id:a,type:"Unknown"},selector:{type:"FragmentSelector",value:r}}):{type:"SpecificResource",source:{id:a,type:e.typeMap&&e.typeMap[a]||"Unknown"},selector:null,selectors:[]}}if(t.type==="Choice"||t.type==="List"||t.type==="Composite"||t.type==="Independents")return T(t.items[0]);if(t.type==="SpecificResource"){t.source.type==="Canvas"&&t.source.partOf&&typeof t.source.partOf=="string"&&(t.source.partOf=[{id:t.source.partOf,type:"Manifest"}]);const{selector:a,selectors:r}=t.selector?B(t.selector,e):{selector:null,selectors:[]};return{type:"SpecificResource",source:t.source,selector:a,selectors:r}}if(t.id){t.type==="Canvas"&&t.partOf&&typeof t.partOf=="string"&&(t.partOf=[{id:t.partOf,type:"Manifest"}]);const[a,r]=t.id.split("#");return r?T({type:"SpecificResource",source:{...t,id:a},selector:{type:"FragmentSelector",value:r}}):{type:"SpecificResource",source:{...t,id:a},selector:null,selectors:[]}}return{type:"SpecificResource",source:t,selector:null,selectors:[]}}function I(t,e=!1){if(typeof t=="string"){if(t.startsWith("{"))try{const a=JSON.parse(t);return I(a)}catch{return[!1,{reason:"Invalid JSON"}]}return[!0]}if(Array.isArray(t)){for(const a of t){const[r,o]=I(a);if(!r&&o)return[r,o]}return[!0]}return t.type==="Annotation"?[!0]:e&&t.type==="Canvas"&&!t.partOf?[!1,{reason:"Canvas without partOf cannot be loaded"}]:[!0]}function At(t){return J(typeof t=="string"?t:JSON.stringify(t))}function G(t,e){if(t=t.trim(),t[0]==="{")return e?Promise.resolve(JSON.parse(t)):JSON.parse(t);if(t.startsWith("http")){if(!e)throw new Error("Cannot fetch remote fetch with async=false in parseContentState");return fetch(t).then(a=>a.json())}return G(Y(t),e)}function J(t){const e=encodeURIComponent(t);return(typeof btoa=="undefined"?Buffer.from(e,"utf-8").toString("base64"):btoa(e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function Y(t){const a=wt(t).replace(/-/g,"+").replace(/_/g,"/"),r=typeof atob=="undefined"?Buffer.from(a,"base64").toString("utf-8"):atob(a);return decodeURIComponent(r).trim()}function wt(t){const e=t.length%4;if(e===1)throw new Error("InvalidLengthError: Input base64url string is the wrong length to determine padding");return t+(e?"====".slice(0,4-e):"")}function Mt(t){if(!t)throw new Error("Content state is empty");Array.isArray(t)||(t=[t]);let e="vault://virtual-annotation/"+new Date().getTime();const a=[];for(const r of t){if(typeof r=="string")throw new Error("Content state is a [String] type and cannot be inferred");if(r.type==="Annotation"){if(e=r.id,Array.isArray(r.motivation))for(const n of r.motivation);if(Array.isArray(r.target))for(const n of r.target){const s=T(n);a.push(s)}else{const n=T(r.target);a.push(n)}continue}const o=T(r);a.push(o)}return{id:e,type:"Annotation",motivation:["contentState",...t.motivation||[]],target:a,extensions:{}}}exports.decodeContentState=Y;exports.encodeContentState=J;exports.normaliseContentState=Mt;exports.parseContentState=G;exports.serialiseContentState=At;exports.validateContentState=I;
//# sourceMappingURL=content-state.js.map
