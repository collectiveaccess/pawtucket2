"use strict";require("node:fs"),require("node:path"),require("node-domexception");var F=require("./index.node-43fdcacf.js");require("node:http"),require("node:https"),require("node:zlib"),require("node:stream"),require("node:buffer"),require("node:util"),require("node:url"),require("node:net");let f=0;const t={START_BOUNDARY:f++,HEADER_FIELD_START:f++,HEADER_FIELD:f++,HEADER_VALUE_START:f++,HEADER_VALUE:f++,HEADER_VALUE_ALMOST_DONE:f++,HEADERS_ALMOST_DONE:f++,PART_DATA_START:f++,PART_DATA:f++,END:f++};let k=1;const T={PART_BOUNDARY:k,LAST_BOUNDARY:k*=2},O=10,g=13,U=32,p=45,w=58,B=97,V=122,x=R=>R|32,_=()=>{};class Y{constructor(i){this.index=0,this.flags=0,this.onHeaderEnd=_,this.onHeaderField=_,this.onHeadersEnd=_,this.onHeaderValue=_,this.onPartBegin=_,this.onPartData=_,this.onPartEnd=_,this.boundaryChars={},i=`\r
--`+i;const n=new Uint8Array(i.length);for(let r=0;r<i.length;r++)n[r]=i.charCodeAt(r),this.boundaryChars[n[r]]=!0;this.boundary=n,this.lookbehind=new Uint8Array(this.boundary.length+8),this.state=t.START_BOUNDARY}write(i){let n=0;const r=i.length;let A=this.index,{lookbehind:l,boundary:E,boundaryChars:H,index:e,state:o,flags:d}=this;const b=this.boundary.length,m=b-1,N=i.length;let a,P;const h=c=>{this[c+"Mark"]=n},s=c=>{delete this[c+"Mark"]},D=(c,S,u,y)=>{(S===void 0||S!==u)&&this[c](y&&y.subarray(S,u))},L=(c,S)=>{const u=c+"Mark";u in this&&(S?(D(c,this[u],n,i),delete this[u]):(D(c,this[u],i.length,i),this[u]=0))};for(n=0;n<r;n++)switch(a=i[n],o){case t.START_BOUNDARY:if(e===E.length-2){if(a===p)d|=T.LAST_BOUNDARY;else if(a!==g)return;e++;break}else if(e-1===E.length-2){if(d&T.LAST_BOUNDARY&&a===p)o=t.END,d=0;else if(!(d&T.LAST_BOUNDARY)&&a===O)e=0,D("onPartBegin"),o=t.HEADER_FIELD_START;else return;break}a!==E[e+2]&&(e=-2),a===E[e+2]&&e++;break;case t.HEADER_FIELD_START:o=t.HEADER_FIELD,h("onHeaderField"),e=0;case t.HEADER_FIELD:if(a===g){s("onHeaderField"),o=t.HEADERS_ALMOST_DONE;break}if(e++,a===p)break;if(a===w){if(e===1)return;L("onHeaderField",!0),o=t.HEADER_VALUE_START;break}if(P=x(a),P<B||P>V)return;break;case t.HEADER_VALUE_START:if(a===U)break;h("onHeaderValue"),o=t.HEADER_VALUE;case t.HEADER_VALUE:a===g&&(L("onHeaderValue",!0),D("onHeaderEnd"),o=t.HEADER_VALUE_ALMOST_DONE);break;case t.HEADER_VALUE_ALMOST_DONE:if(a!==O)return;o=t.HEADER_FIELD_START;break;case t.HEADERS_ALMOST_DONE:if(a!==O)return;D("onHeadersEnd"),o=t.PART_DATA_START;break;case t.PART_DATA_START:o=t.PART_DATA,h("onPartData");case t.PART_DATA:if(A=e,e===0){for(n+=m;n<N&&!(i[n]in H);)n+=b;n-=m,a=i[n]}if(e<E.length)E[e]===a?(e===0&&L("onPartData",!0),e++):e=0;else if(e===E.length)e++,a===g?d|=T.PART_BOUNDARY:a===p?d|=T.LAST_BOUNDARY:e=0;else if(e-1===E.length)if(d&T.PART_BOUNDARY){if(e=0,a===O){d&=~T.PART_BOUNDARY,D("onPartEnd"),D("onPartBegin"),o=t.HEADER_FIELD_START;break}}else d&T.LAST_BOUNDARY&&a===p?(D("onPartEnd"),o=t.END,d=0):e=0;if(e>0)l[e-1]=a;else if(A>0){const c=new Uint8Array(l.buffer,l.byteOffset,l.byteLength);D("onPartData",0,A,c),A=0,h("onPartData"),n--}break;case t.END:break;default:throw new Error(`Unexpected state entered: ${o}`)}L("onHeaderField"),L("onHeaderValue"),L("onPartData"),this.index=e,this.state=o,this.flags=d}end(){if(this.state===t.HEADER_FIELD_START&&this.index===0||this.state===t.PART_DATA&&this.index===this.boundary.length)this.onPartEnd();else if(this.state!==t.END)throw new Error("MultipartParser.end(): stream ended unexpectedly")}}function q(R){const i=R.match(/\bfilename=("(.*?)"|([^()<>@,;:\\"/[\]?={}\s\t]+))($|;\s)/i);if(!i)return;const n=i[2]||i[3]||"";let r=n.slice(n.lastIndexOf("\\")+1);return r=r.replace(/%22/g,'"'),r=r.replace(/&#(\d{4});/g,(A,l)=>String.fromCharCode(l)),r}async function C(R,i){if(!/multipart/i.test(i))throw new TypeError("Failed to fetch");const n=i.match(/boundary=(?:"([^"]+)"|([^;]+))/i);if(!n)throw new TypeError("no or bad content-type header, no multipart boundary");const r=new Y(n[1]||n[2]);let A,l,E,H,e,o;const d=[],b=new F.FormData,m=s=>{E+=h.decode(s,{stream:!0})},N=s=>{d.push(s)},a=()=>{const s=new F.File(d,o,{type:e});b.append(H,s)},P=()=>{b.append(H,E)},h=new TextDecoder("utf-8");h.decode(),r.onPartBegin=function(){r.onPartData=m,r.onPartEnd=P,A="",l="",E="",H="",e="",o=null,d.length=0},r.onHeaderField=function(s){A+=h.decode(s,{stream:!0})},r.onHeaderValue=function(s){l+=h.decode(s,{stream:!0})},r.onHeaderEnd=function(){if(l+=h.decode(),A=A.toLowerCase(),A==="content-disposition"){const s=l.match(/\bname=("([^"]*)"|([^()<>@,;:\\"/[\]?={}\s\t]+))/i);s&&(H=s[2]||s[3]||""),o=q(l),o&&(r.onPartData=N,r.onPartEnd=a)}else A==="content-type"&&(e=l);l="",A=""};for await(const s of R)r.write(s);return r.end(),b}exports.toFormData=C;
