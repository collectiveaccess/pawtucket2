"use strict";var Je=(t,e,r)=>{if(!e.has(t))throw TypeError("Cannot "+r)};var m=(t,e,r)=>(Je(t,e,"read from private field"),r?r.call(t):e.get(t)),C=(t,e,r)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,r)},L=(t,e,r,i)=>(Je(t,e,"write to private field"),i?i.call(t,r):e.set(t,r),r);var P,X,D,de,j,q,ee,Zt,F,Kt,qt=require("node:http"),er=require("node:https"),tr=require("node:zlib"),v=require("node:stream"),I=require("node:buffer"),M=require("node:util"),rr=require("node:url"),ir=require("node:net");require("node:fs"),require("node:path"),require("node-domexception");function te(t){return t&&typeof t=="object"&&"default"in t?t:{default:t}}var V=te(qt),nr=te(er),U=te(tr),O=te(v);function B(t){return t.endsWith("info.json")?t:t.endsWith("/")?`${t}info.json`:`${t}/info.json`}const Ze="http://library.stanford.edu/iiif/image-api/compliance.html#level0",pe="http://library.stanford.edu/iiif/image-api/compliance.html#level1",ge="http://library.stanford.edu/iiif/image-api/compliance.html#level2",Ke="http://library.stanford.edu/iiif/image-api/conformance.html#level0",me="http://library.stanford.edu/iiif/image-api/conformance.html#level1",ye="http://library.stanford.edu/iiif/image-api/conformance.html#level2",Ye="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0",we="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1",Ie="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2",Xe="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0",_e="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1",Se="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2",qe="http://iiif.io/api/image/1/level0.json",et="http://iiif.io/api/image/1/profiles/level0.json",xe="http://iiif.io/api/image/1/level1.json",Ee="http://iiif.io/api/image/1/profiles/level1.json",Fe="http://iiif.io/api/image/1/level2.json",be="http://iiif.io/api/image/1/profiles/level2.json",tt="http://iiif.io/api/image/2/level0.json",rt="http://iiif.io/api/image/2/profiles/level0.json",ve="http://iiif.io/api/image/2/level1.json",Ae="http://iiif.io/api/image/2/profiles/level1.json",Le="http://iiif.io/api/image/2/level2.json",Oe="http://iiif.io/api/image/2/profiles/level2.json",it="level0",Te="level1",ze="level2",nt="http://iiif.io/api/image/2/level0",Re="http://iiif.io/api/image/2/level1",Me="http://iiif.io/api/image/2/level2",Pe=[Me,ge,ye,Ie,Se,Fe,be,Le,Oe,ze],Ce=[...Pe,Re,pe,me,we,_e,xe,Ee,ve,Ae,Te],Be=[nt,Re,Me,Ze,pe,ge,Ke,me,ye,Ye,we,Ie,Xe,_e,Se,qe,et,xe,Ee,Fe,be,tt,rt,ve,Ae,Le,Oe,it,Te,ze],sr=Be,st={extraFormats:["jpg"],extraQualities:["default"],extraFeatures:["sizeByWhListed"]},ot={extraFormats:["jpg"],extraQualities:["default"],extraFeatures:["baseUriRedirect","cors","jsonldMediaType","regionByPx","regionSquare","sizeByWhListed","sizeByH","sizeByW","sizeByWh"]},at={extraFormats:["jpg","png"],extraQualities:["default"],extraFeatures:["baseUriRedirect","cors","jsonldMediaType","regionByPct","regionByPx","regionSquare","rotationBy90s","sizeByWhListed","sizeByConfinedWh","sizeByH","sizeByPct","sizeByW","sizeByWh"]},$e=["baseUriRedirect","canonicalLinkHeader","cors","jsonldMediaType","mirroring","profileLinkHeader","regionByPct","regionByPx","regionSquare","rotationArbitrary","rotationBy90s","sizeByConfinedWh","sizeByH","sizeByPct","sizeByW","sizeByWh","sizeUpscaling","sizeByWhListed","sizeByDistortedWh","sizeByForcedWh"];function ft(t){return Pe.indexOf(t)!==-1?at:Ce.indexOf(t)!==-1?ot:st}function Ne(t){const e=t?Array.isArray(t.profile)?t.profile:[t.profile]:[],r={extraQualities:[],extraFormats:[],extraFeatures:[]};for(let i of e)if(typeof i=="string"&&(i=ft(i)),!!i){if(i.formats)for(const n of i.formats)r.extraFormats.indexOf(n)===-1&&r.extraFormats.push(n);if(i.qualities)for(const n of i.qualities)r.extraQualities.indexOf(n)===-1&&r.extraQualities.push(n);if(i.supports)for(const n of i.supports)r.extraFeatures.indexOf(n)===-1&&r.extraFeatures.push(n);if(i.maxHeight&&(r.maxHeight=i.maxHeight),i.maxWidth&&(r.maxWidth=i.maxWidth),i.maxArea&&(r.maxArea=i.maxArea),i.extraFormats)for(const n of i.extraFormats)r.extraFormats.indexOf(n)===-1&&r.extraFormats.push(n);if(i.extraQualities)for(const n of i.extraQualities)r.extraQualities.indexOf(n)===-1&&r.extraQualities.push(n);if(i.extraFeatures)for(const n of i.extraFeatures)r.extraFeatures.indexOf(n)===-1&&r.extraFeatures.push(n);i.maxHeight&&(r.maxHeight=i.maxHeight),i.maxWidth&&(r.maxWidth=i.maxWidth),i.maxArea&&(r.maxArea=i.maxArea)}if(t.extraFormats)for(const i of t.extraFormats)r.extraFormats.indexOf(i)===-1&&r.extraFormats.push(i);if(t.extraFeatures)for(const i of t.extraFeatures)r.extraFeatures.indexOf(i)===-1&&r.extraFeatures.push(i);if(t.extraQualities)for(const i of t.extraQualities)r.extraQualities.indexOf(i)===-1&&r.extraQualities.push(i);return r}function lt(t){try{if(t==="full")return{full:!0};if(t==="square")return{square:!0};const e=t.startsWith("pct:"),i=t.substr(e?4:0).split(",").map(n=>parseFloat(n));return{x:i[0],y:i[1],w:i[2],h:i[3],percent:e}}catch{throw new Error("Expected 'full', 'square' or 'x,y,w,h'. Found "+t)}}function ut(t){const e={upscaled:!1,max:!1,confined:!1};if(t[0]==="^"&&(e.upscaled=!0,t=t.slice(1)),t==="max"||t==="full")return e.max=!0,e.serialiseAsFull=t==="full",e;if(t[0]==="!"&&(e.confined=!0,t=t.slice(1)),t[0]==="p")return e.percentScale=parseFloat(t.slice(4)),e;const r=t.split(",").map(i=>i.trim());return r.length&&(r[0]!==""&&(e.width=parseInt(r[0],10)),r[1]!==""&&(e.height=parseInt(r[1],10))),e}function ct(t){const e={angle:0};if(t[0]==="!"&&(e.mirror=!0,t=t.substr(1)),e.angle=parseFloat(t)%360,Number.isNaN(e.angle))throw new Error(`Invalid rotation ${t}`);return e}function ht(t,e=""){const r=t.match(/^(([a-zA-Z]+):\/\/([^/]+))?((.*)+)/);if(!r)throw new Error(`Invalid or unknown input ${t}`);const i=r[2],n=r[3];let s=r[4];if(s[0]==="/"&&(s=s.substr(1)),e.length>0){if(e[0]==="/"&&(e=e.substr(1)),e!==s.substr(0,e.length))throw new Error(`Path does not start with prefix (path: ${s}, prefix: ${e})`);s=s.substr(e.length)}return{scheme:i,server:n,path:s,prefix:e}}function dt(t,e=""){const{path:r,scheme:i,server:n,prefix:s}=ht(t,e),o=r.split("/").reverse(),[a,u,l,c,...p]=o,d=p.reverse().filter(Boolean).join("/");if(o.length===1||a==="")return{type:"base",scheme:i,server:n,prefix:s,identifier:d};if(a==="info.json"){const[,...f]=o;return{type:"info",scheme:i,server:n,prefix:s,identifier:f.reverse().filter(Boolean).join("/")}}const g=a.split(".");return{type:"image",scheme:i,server:n,prefix:s,identifier:d,originalPath:r,region:lt(c),size:ut(l),rotation:ct(u),quality:g[0],format:g[1]}}function pt(t){const e=dt(B(t.id));if(e.type!=="info")throw new Error("Invalid service URL");const r=Ne(t);return{identifier:e.identifier,originalPath:"",server:e.server,prefix:e.prefix,scheme:e.scheme,type:"image",quality:r.extraQualities.indexOf("default")===-1?r.extraQualities[0]:"default",region:{full:!0},size:{max:!0,upscaled:!1,confined:!1},format:"jpg",rotation:{angle:0}}}function gt(t,e,r){const i=r.length,n=[];for(let s=0;s<i;s++){const a=r[s].width;n.push(t/a)}return n}function mt(t,e,r){const i=r.length,n=[];for(let s=0;s<i;s++){const o=r[s];n.push({width:Math.floor(t/o),height:Math.floor(e/o)})}return n}function h(t){if(t["@id"])return t["@id"];if(t.id)return t.id}function G(t){if(!t||!t.profile||!h(t))return!1;const e=Array.isArray(t.profile)?t.profile:[t.profile];for(const r of e)if(typeof r=="string"&&Be.indexOf(r)!==-1)return!0;return!1}function yt(t){if(!G(t))return!1;const e=Array.isArray(t.profile)?t.profile:[t.profile];for(const r of e)if(typeof r=="string"){if(Ce.indexOf(r)!==-1)return!0}else{const i=[...r.supports||[],...r.extraFeatures||[]];if(i.indexOf("regionByPx")!==-1&&(i.indexOf("sizeByW")!==-1||i.indexOf("sizeByWh")!==-1))return!0}return!1}function re(t,e){if(e&&e.profile){const r=e.profile;if(r){const i=Array.isArray(r)?r:[r];return i.includes(`level${t}`)||i.includes(`http://iiif.io/api/image/2/level${t}.json`)||i.includes(`http://iiif.io/api/image/1/level${t}.json`)||i.includes(`http://iiif.io/api/image/1/profiles/level${t}.json`)}}return!1}function ie(t){return G(t)?re(0,t)?0:re(1,t)?1:re(2,t)?2:null:null}function wt(t){if(!yt(t))return[];const e=[],r=Array.isArray(t.profile)?t.profile:[t.profile],i=r.length;for(let n=0;n<i;n++){const s=r[n];if(typeof s!="string"&&(s.maxHeight||s.maxWidth))return[{id:h(t),type:"variable",minWidth:0,minHeight:0,maxHeight:s.maxHeight||s.maxWidth,maxWidth:s.maxWidth||s.maxHeight,level:ie(t)}]}if(t.tiles){const n=t.tiles.length;for(let s=0;s<n;s++){const o=t.tiles[s];(o.height||o.width)&&e.push({id:h(t),type:"variable",minHeight:0,minWidth:0,maxHeight:o.height||o.width,maxWidth:o.width,level:ie(t)})}}return e}function We(t){const e=/^.*\/(full)\/(((\d+),(\d+)?)|max)\/(\d+)\/default\.(jpg|png|jpeg)$/,r=t.match(e);if(r){const i=r[1],n=parseInt(r[4],10),s=parseInt(r[5],10),o=r[7];if((i==="max"||i==="full")&&n&&s&&o)return{type:"fixed",id:t,height:s,width:n}}return{type:"unknown",id:t}}function It(t){if(t["@type"])return t["@type"];if(t.type)return t.type}function _t(t){if(typeof t=="string")return We(t);const e=It(t);if(e!=="Image"&&e!=="sc:Image")return null;const r=t,i=h(r);return i?i&&r.width&&r.height?{id:i,type:"fixed",width:r.width,height:r.height,unsafe:!0}:We(i):null}function St(t){return G(t)?(t&&t.sizes?t.sizes:[]).map(e=>({id:h(t),type:"fixed-service",height:e.height,width:e.width,level:ie(t)})):[]}function ke(t){const e=[],r=t.length;for(let i=0;i<r;i++){const n=St(t[i]);n.length&&e.push(...n);const s=wt(t[i]);s.length&&e.push(...s)}return e}function Ue(t){const e=t.service?Array.isArray(t.service)?t.service:[t.service]:[],r=e.length,i=[];for(let n=0;n<r;n++)G(e[n])&&i.push(e[n]);return i}function xt(t,e=!0,r){const i=[],n=_t(t);if(n===null)return i;const s=t;if(i.push(n),e&&s.width&&s.height){const o=[],a=Ue(s);for(const u of a){const l={id:h(u),width:s.width,height:s.height};if(r.canLoadSync(l)){const c=r.loadServiceSync(l);c&&(c.height||(c.height=s.height),c.width||(c.width=s.width),o.push(...ke([c])))}}if(o.length)return i.push(...o),i}return s.service&&i.push(...ke(s.service)),i}function Et({x:t=0,y:e=0,w:r,h:i,full:n,square:s,percent:o}){if(n)return"full";if(s)return"square";if(typeof r>"u"||typeof i>"u")throw new Error("RegionParameter: invalid region");const a=`${t},${e},${r},${i}`;return o?`pct:${a}`:a}function Ft({max:t,percentScale:e,upscaled:r,confined:i,width:n,height:s,serialiseAsFull:o}){const a=[];return r&&a.push("^"),t?(a.push(o?"full":"max"),a.join("")):(i&&a.push("!"),e&&a.push(`pct:${e}`),n&&a.push(`${n}`),a.push(","),s&&a.push(`${s}`),a.join(""))}function bt(t){return`${t.mirror?"!":""}${(t.angle||0)%360}`}var or=Object.defineProperty,ar=Object.defineProperties,fr=Object.getOwnPropertyDescriptors,vt=Object.getOwnPropertySymbols,lr=Object.prototype.hasOwnProperty,ur=Object.prototype.propertyIsEnumerable,At=(t,e,r)=>e in t?or(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Q=(t,e)=>{for(var r in e||(e={}))lr.call(e,r)&&At(t,r,e[r]);if(vt)for(var r of vt(e))ur.call(e,r)&&At(t,r,e[r]);return t},J=(t,e)=>ar(t,fr(e));function Lt(t,e){const r=t.prefix.startsWith("/")?t.prefix.substr(1):t.prefix,i=`${t.scheme}://${t.server}/${r?`${r}/`:""}${t.identifier}`;if(t.type==="base")return i;if(t.type==="info")return`${i}/info.json`;let{region:n,size:s,rotation:o,format:a,quality:u}=t;if(e){const l=e["@context"]?Array.isArray(e["@context"])?e["@context"]:[e["@context"]]:[],c=l.indexOf("http://iiif.io/api/image/2/context.json")!==-1,p=l.indexOf("http://iiif.io/api/image/3/context.json")!==-1;if((s.width===e.width&&!s.height||s.height===e.height&&!s.width||s.width===e.width&&s.height===e.height)&&(s=J(Q({},s),{max:!0})),c&&(s.max&&!s.serialiseAsFull&&(s=J(Q({},s),{serialiseAsFull:!0})),!s.max&&s.width&&s.height&&(s=J(Q({},s),{height:void 0}))),p&&(s.max&&s.serialiseAsFull&&(s=J(Q({},s),{serialiseAsFull:!1})),s.width&&!s.height&&e.width&&e.height)){const d=e.height/e.width;s=J(Q({},s),{height:Math.ceil(s.width*d)})}}return[i,Et(n),Ft(s),bt(o),`${u}.${a}`].filter(Boolean).join("/")}function ne(t,e,r){const i=pt({id:B(h(t)),profile:t.level===null||typeof t.level>"u"?"level0":`level${t.level}}`,type:"ImageService2"});if(i.type!=="image")throw new Error("Invalid service");return i.size.max=!1,i.size.width=e,i.size.height=r,{id:Lt(i),type:"fixed",width:e,height:r||t.height/(t.width||1)*e,unsafe:t.width>e}}function N(t){const e=t.replace(/(https?:\/\/)?(www.)?/i,"");return e.indexOf("/")!==-1?e.split("/")[0]:e}function cr(t){if(!t.width||!t.height)return null;if(t.tiles){const e=t.tiles.sort((i,n)=>Math.max(...n.scaleFactors)-Math.max(...i.scaleFactors)),r=e.length;for(let i=0;i<r;i++){const n=e[i],s=n.width;if(!s)continue;const o=n.scaleFactors.length,a=n.scaleFactors.sort();for(let u=0;u<o;u++){const l=a[u];if(t.width/l<=s&&t.height/l<=s)return{id:h(t),type:"fixed-service",width:t.width/l|0,height:t.height/l|0,level:ie(t)}}}}return null}function Ge(t,e){if(!G(t))return[!1,"Not a valid image service"];e.extraFeatures=e.extraFeatures?e.extraFeatures:[];const r=Ne(t);if(e.exactSize){let i=!1;if(t.sizes)for(const n of t.sizes)n.width&&n.width===e.exactSize.width&&($e.indexOf("sizeByW")!==-1||n.height&&n.height===e.exactSize.height)&&(i=!0),n.height&&n.height===e.exactSize.height&&($e.indexOf("sizeByH")!==-1||n.width&&n.width===e.exactSize.width)&&(i=!0);i||(e.maxWidth=Math.max(e.maxWidth||0,e.exactSize.width||0)||void 0,e.maxHeight=Math.max(e.maxHeight||0,e.exactSize.height||0)||void 0,e.maxArea=Math.max(e.maxArea||0,(e.exactSize.width&&e.exactSize.height?e.exactSize.width*e.exactSize.height:e.maxArea)||0)||void 0,!e.exactSize.height&&e.exactSize.width?e.extraFeatures.indexOf("sizeByW")===-1&&e.extraFeatures.push("sizeByW"):!e.exactSize.width&&e.exactSize.height&&e.extraFeatures.indexOf("sizeByH")===-1&&e.extraFeatures.push("sizeByH"))}if(e.maxArea&&r.maxArea&&e.maxArea>r.maxArea)return[!1,`Max area is ${r.maxArea}`];if(e.maxWidth&&r.maxWidth&&e.maxWidth>r.maxWidth)return[!1,`Max width is ${r.maxWidth}`];if(e.maxHeight&&r.maxHeight&&e.maxHeight>r.maxHeight)return[!1,`Max height is ${r.maxHeight}`];if(e.extraFeatures){const i=[];for(const n of e.extraFeatures)r.extraFeatures.indexOf(n)===-1&&i.push(n);if(i.length)return[!1,`Missing features: ${i.join(", ")}`]}if(e.extraFormats){const i=[];for(const n of e.extraFormats)r.extraFormats.indexOf(n)===-1&&i.push(n);if(i.length)return[!1,`Missing formats: ${i.join(", ")}`]}if(e.extraQualities){const i=[];for(const n of e.extraQualities)r.extraQualities.indexOf(n)===-1&&i.push(n);if(i.length)return[!1,`Missing qualities: ${i.join(", ")}`]}return[!0]}function hr(t,e){return Ge(t,{extraFormats:[e]})}function dr(t,e){if(e.type!=="image")return[!0];const r=[];e.rotation.mirror&&r.push("mirroring"),e.region.percent&&r.push("regionByPct"),e.region.square?r.push("regionSquare"):e.region.full||r.push("regionByPx"),e.rotation.angle&&(e.rotation.angle%90?r.push("rotationArbitrary"):r.push("rotationBy90s")),e.size.confined&&r.push("sizeByConfinedWh"),!e.size.width&&e.size.height&&r.push("sizeByH"),e.size.percentScale&&r.push("sizeByPct"),(t.sizes||[]).find(o=>o.width===e.size.width&&!e.size.height||o.height===e.size.height&&!e.size.width||o.height===e.size.height&&o.width===e.size.width)?r.push("sizeByWhListed"):(e.size.width&&!e.size.height&&r.push("sizeByW"),e.size.width&&e.size.height&&r.push("sizeByWh")),e.size.upscaled&&r.push("sizeUpscaling");const[n,s]=Ge(t,{extraFeatures:r,extraQualities:[e.quality],extraFormats:[e.format],exactSize:e.size});return n?[!0]:[!1,s]}function Ot(t,e,r){const i=t.width?t.width:t.maxWidth;return r.height<=t.maxHeight&&r.width<=t.maxWidth&&r.height>=t.minHeight&&r.width>=t.minWidth&&(!e||Math.abs(r.width-i)<Math.abs(e.width-i))}function Tt(t,e){const r=[],i=Object.assign({unsafeImageService:!1,atAnyCost:!0,fallback:!0,minHeight:64,minWidth:64,maxHeight:1/0,maxWidth:1/0,returnAllOptions:!1,preferFixedSize:!1,allowUnsafe:!1,explain:!1,height:0,width:0},t),n=(c,p=0)=>i.explain?r.push(new Array(p).fill(0).map(d=>"    ").join("")+c().trim()):void 0,s=[],o=[];let a=null;n(()=>`Using configuration: ${JSON.stringify(i,null,2)}`);const u=(c,p)=>{if(n(()=>"Swapping choice",3),Ot(i,p,c)){if(i.preferFixedSize&&c.unsafe){n(()=>`We found an image that was marked as unsafe, but it was the best size. (${c.id})`,4),o.push(c);return}i.returnAllOptions&&p&&o.push(p),n(()=>`We found a new image that was the best size. (${c.id})`,4),a=c}else i.returnAllOptions&&o.push(c)};n(()=>`The input shows we have ${e.length} list(s) of candidates to choose from.`);const l=e.length;for(let c=0;c<l;c++){const p=e[c]();n(()=>`Candidate group ${c}: ${JSON.stringify(p,null,2)}`,1);const d=p.length;n(()=>`Checking candidate list number ${c} and found ${d} potential ways of creating image(s)`,1);for(let g=0;g<d;g++){const f=p[g];if(n(()=>`-> Checking candidate ${g}`,1),f.type==="unknown"&&i.atAnyCost&&(n(()=>`We've found an unknown image type, adding this to the "last resort" list`,2),s.push(f)),f.type==="fixed"&&(f.unsafe?(n(()=>`We've found an unsafe fixed image type, adding this to the "last resort" list`,2),s.push(f)):(n(()=>"We've found a fixed size image, checking if it matches the request",2),u(f,a))),f.type==="fixed-service")if(i.unsafeImageService){n(()=>"Checking for an image from the tile source, without calculating the right height and width (unsafeImageService)",2);const _=ne(f,i.width,i.height);u(_,a)}else{n(()=>"Checking for an image from the tile source 3",2);const _=ne(f,f.width,f.height);u(_,a)}if(f.type==="variable"&&f.maxWidth){const _=ne({id:f.id,type:"fixed-service",width:f.maxWidth,height:f.maxWidth,level:null},f.maxWidth);u(_,a)}}if(a&&!i.returnAllOptions){if(a.unsafe||i.allowUnsafe)continue;n(()=>`We found a match in choice list number ${c}, no searching any more`);break}}return i.atAnyCost&&o.length===0?(n(()=>a?`We found an image! ${a.id} of type ${a.type}`:'We found no images, but "atAnyCost" is set, so returning that'),{best:a||s[0],fallback:s.slice(1),log:r}):i.returnAllOptions?(n(()=>"Returning all options that we have found"),{best:i.atAnyCost?a||o[0]||s[0]:a||o[0],fallback:[...o,...s],log:r}):(n(()=>"Returning the best image that we found, and a fallback"),{best:a||o[0]||null,fallback:a?o:o.slice(1),log:r})}var pr=Object.defineProperty,gr=Object.defineProperties,mr=Object.getOwnPropertyDescriptors,zt=Object.getOwnPropertySymbols,yr=Object.prototype.hasOwnProperty,wr=Object.prototype.propertyIsEnumerable,Rt=(t,e,r)=>e in t?pr(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,Ir=(t,e)=>{for(var r in e||(e={}))yr.call(e,r)&&Rt(t,r,e[r]);if(zt)for(var r of zt(e))wr.call(e,r)&&Rt(t,r,e[r]);return t},_r=(t,e)=>gr(t,mr(e));function Mt(t,e,r){const i=t>e?t:e,n=r.length,s=[];for(let o=0;o<n;o++){const a=r[o];let u=a.scaleFactors[0],l=i/u;const c=[u];for(;l>=a.width;)u=u*2,c.push(u),l=l/2;s.push(_r(Ir({},a),{scaleFactors:c}))}return s}function Pt(t,e){if(t.length!==e.length)return!1;if(t.length===0&&e.length===0)return!0;const r=t.length;let i=!0;for(let s=0;s<r;s++){const o=t[s],a=e[s];if(o.width!==a.width||o.height!==a.height){i=!1;break}}if(i)return!0;let n=0;for(let s=0;s<r;s++)for(let o=0;o<r;o++)if(t[s].width===e[o].width&&t[s].height===e[o].height){n++;break}return n===r}function Ct(t){return re(0,t)}class Bt{constructor(){this.config={verificationsRequired:1,approximateServices:!0,enableFetching:!0,disableThrottling:!1},this.fetchingCount=0,this.imageServices={},this.knownImageServers={}}setConfig(e){Object.assign(this.config,e)}sample(e,r,i=!0){const n=N(h(e)),s=B(h(e)),o=this.knownImageServers[n];return this.imageServices[s]=Object.assign(e,{real:!0}),!o&&e.tiles&&!Ct(e)?(this.knownImageServers[n]={verifications:0,malformed:!1,root:n,preLoaded:i,sampledId:h(e),verified:!1,server:null,result:{context:e["@context"]||[],sampledProfile:e.profile,resourceServiceRatio:r&&e.height?r.height/e.height:1,sampledSizes:e.sizes||[],sizeRatios:gt(e.width,e.height,e.sizes||[]),sampledTiles:e.tiles||[]}},!0):this.verify(e)}preLoad(e,r=!0){this.knownImageServers[e.root]=e,r&&(this.knownImageServers[e.root].malformed=!1,this.knownImageServers[e.root].verifications=this.config.verificationsRequired)}predict(e,r=!1,i=!1){const n=e==null?void 0:e.source,s=N(h(e)),o=this.knownImageServers[s];if(!o||!o.result||!((n==null?void 0:n.height)||e.height)||!((n==null?void 0:n.width)||e.width)||!i&&(o.malformed||o.verifications<this.config.verificationsRequired)||Ct(e.source))return null;const a=B(h(e));return this.imageServices[a]||(this.imageServices[a]={"@context":o.result.context,"@id":h(e),id:h(e),protocol:"http://iiif.io/api/image",tiles:(n==null?void 0:n.tiles)||Mt(e.width,e.height,o.result.sampledTiles),sizes:(n==null?void 0:n.sizes)||mt(Math.round(e.width/o.result.resourceServiceRatio),Math.round(e.height/o.result.resourceServiceRatio),o.result.sizeRatios),profile:(n==null?void 0:n.profile)||o.result.sampledProfile,height:(n==null?void 0:n.height)||e.height,width:(n==null?void 0:n.width)||e.width,real:!1}),this.imageServices[a]}async getThumbnailFromResource(e,r,i=!0,n=[]){const s=await this.getImageCandidates(e,i);return Tt(r,[()=>n,()=>s])}async getImageCandidates(e,r=!0){const i=e;if(r&&i.height&&i.width){const n=Ue(i);for(const s of n){const o={id:h(s),width:s.width?s.width:i.width,height:s.height?s.height:i.height,source:s};await this.loadService(o)}}return xt(e,r,this)}async verify(e){const r=this.predict(e,!1,!0),i=await this.fetchService(h(e));if(!r)return!1;const n=r.height===i.height&&r.width===i.width&&r["@context"]===i["@context"]&&Pt(r.sizes||[],i.sizes||[]);if(n){const s=N(h(e));this.knownImageServers[s].verifications+=1,this.knownImageServers[s].verifications>=this.config.verificationsRequired&&(this.knownImageServers[s].verified=!0)}return n}canLoadSync(e){const r=typeof e=="string"?e:h(e),i=B(r);if(this.imageServices[i])return!0;const n=this.knownImageServers[N(r)];return n&&!n.malformed&&n.verifications>=this.config.verificationsRequired}async markAsMalformed(e){return this.knownImageServers[N(h(e))].malformed=!0,this.loadService(e,!0)}async fetchService(e,r=!1){const i=B(e);if(this.imageServices[i]&&(!r||this.imageServices[i].real))return this.imageServices[i];if(!this.config.enableFetching)throw new Error("Fetching is not enabled");const n=await this.fetch(i).then(s=>s.json());return!n.id&&n["@id"]&&(n.id=n["@id"]),n.id!==e&&(n.id=e,n["@id"]&&(n["@id"]=e)),this.imageServices[i]=Object.assign(n,{real:!0}),this.imageServices[i]}async fetch(e,r){return fetch(e,r)}async loadService(e,r=!1){if(!this.config.disableThrottling){let s=!0;for(;s;)if(this.fetchingCount>=this.config.verificationsRequired)await new Promise(o=>setTimeout(o,500));else{s=!1;break}}const i=this.knownImageServers[N(h(e))];if(i&&!i.malformed&&!r){await i.result;const s=this.loadServiceSync(e);if(s)return s}this.fetchingCount++;const n=await this.fetchService(h(e),r);return this.fetchingCount--,n.real&&this.sample(n,e),n}loadServiceSync(e){const r=B(h(e));return this.imageServices[r]?this.imageServices[r]:this.predict(e)}}new Bt;function Sr(t){if(!/^data:/i.test(t))throw new TypeError('`uri` does not appear to be a Data URI (must begin with "data:")');t=t.replace(/\r?\n/g,"");const e=t.indexOf(",");if(e===-1||e<=4)throw new TypeError("malformed data: URI");const r=t.substring(5,e).split(";");let i="",n=!1;const s=r[0]||"text/plain";let o=s;for(let c=1;c<r.length;c++)r[c]==="base64"?n=!0:(o+=`;${r[c]}`,r[c].indexOf("charset=")===0&&(i=r[c].substring(8)));!r[0]&&!i.length&&(o+=";charset=US-ASCII",i="US-ASCII");const a=n?"base64":"ascii",u=unescape(t.substring(e+1)),l=Buffer.from(u,a);return l.type=s,l.typeFull=o,l.charset=i,l}const xr=65536;if(!globalThis.ReadableStream)try{const t=require("node:process"),{emitWarning:e}=t;try{t.emitWarning=()=>{},Object.assign(globalThis,require("node:stream/web")),t.emitWarning=e}catch(r){throw t.emitWarning=e,r}}catch{Object.assign(globalThis,require("web-streams-polyfill/dist/ponyfill.es2018.js"))}try{const{Blob:t}=require("buffer");t&&!t.prototype.stream&&(t.prototype.stream=function(r){let i=0;const n=this;return new ReadableStream({type:"bytes",async pull(s){const a=await n.slice(i,Math.min(n.size,i+xr)).arrayBuffer();i+=a.byteLength,s.enqueue(new Uint8Array(a)),i===n.size&&s.close()}})})}catch{}/*! fetch-blob. MIT License. Jimmy Wärting <https://jimmy.warting.se/opensource> */const $t=65536;async function*He(t,e=!0){for(const r of t)if("stream"in r)yield*r.stream();else if(ArrayBuffer.isView(r))if(e){let i=r.byteOffset;const n=r.byteOffset+r.byteLength;for(;i!==n;){const s=Math.min(n-i,$t),o=r.buffer.slice(i,i+s);i+=o.byteLength,yield new Uint8Array(o)}}else yield r;else{let i=0,n=r;for(;i!==n.size;){const o=await n.slice(i,Math.min(n.size,i+$t)).arrayBuffer();i+=o.byteLength,yield new Uint8Array(o)}}}const Nt=(j=class{constructor(e=[],r={}){C(this,P,[]);C(this,X,"");C(this,D,0);C(this,de,"transparent");if(typeof e!="object"||e===null)throw new TypeError("Failed to construct 'Blob': The provided value cannot be converted to a sequence.");if(typeof e[Symbol.iterator]!="function")throw new TypeError("Failed to construct 'Blob': The object must have a callable @@iterator property.");if(typeof r!="object"&&typeof r!="function")throw new TypeError("Failed to construct 'Blob': parameter 2 cannot convert to dictionary.");r===null&&(r={});const i=new TextEncoder;for(const s of e){let o;ArrayBuffer.isView(s)?o=new Uint8Array(s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength)):s instanceof ArrayBuffer?o=new Uint8Array(s.slice(0)):s instanceof j?o=s:o=i.encode(`${s}`),L(this,D,m(this,D)+(ArrayBuffer.isView(o)?o.byteLength:o.size)),m(this,P).push(o)}L(this,de,`${r.endings===void 0?"transparent":r.endings}`);const n=r.type===void 0?"":String(r.type);L(this,X,/^[\x20-\x7E]*$/.test(n)?n:"")}get size(){return m(this,D)}get type(){return m(this,X)}async text(){const e=new TextDecoder;let r="";for await(const i of He(m(this,P),!1))r+=e.decode(i,{stream:!0});return r+=e.decode(),r}async arrayBuffer(){const e=new Uint8Array(this.size);let r=0;for await(const i of He(m(this,P),!1))e.set(i,r),r+=i.length;return e.buffer}stream(){const e=He(m(this,P),!0);return new globalThis.ReadableStream({type:"bytes",async pull(r){const i=await e.next();i.done?r.close():r.enqueue(i.value)},async cancel(){await e.return()}})}slice(e=0,r=this.size,i=""){const{size:n}=this;let s=e<0?Math.max(n+e,0):Math.min(e,n),o=r<0?Math.max(n+r,0):Math.min(r,n);const a=Math.max(o-s,0),u=m(this,P),l=[];let c=0;for(const d of u){if(c>=a)break;const g=ArrayBuffer.isView(d)?d.byteLength:d.size;if(s&&g<=s)s-=g,o-=g;else{let f;ArrayBuffer.isView(d)?(f=d.subarray(s,Math.min(g,o)),c+=f.byteLength):(f=d.slice(s,Math.min(g,o)),c+=f.size),o-=g,l.push(f),s=0}}const p=new j([],{type:String(i).toLowerCase()});return L(p,D,a),L(p,P,l),p}get[Symbol.toStringTag](){return"Blob"}static[Symbol.hasInstance](e){return e&&typeof e=="object"&&typeof e.constructor=="function"&&(typeof e.stream=="function"||typeof e.arrayBuffer=="function")&&/^(Blob|File)$/.test(e[Symbol.toStringTag])}},P=new WeakMap,X=new WeakMap,D=new WeakMap,de=new WeakMap,j);Object.defineProperties(Nt.prototype,{size:{enumerable:!0},type:{enumerable:!0},slice:{enumerable:!0}});const Er=Nt;var se=Er;const Fr=(Zt=class extends se{constructor(e,r,i={}){if(arguments.length<2)throw new TypeError(`Failed to construct 'File': 2 arguments required, but only ${arguments.length} present.`);super(e,i);C(this,q,0);C(this,ee,"");i===null&&(i={});const n=i.lastModified===void 0?Date.now():Number(i.lastModified);Number.isNaN(n)||L(this,q,n),L(this,ee,String(r))}get name(){return m(this,ee)}get lastModified(){return m(this,q)}get[Symbol.toStringTag](){return"File"}static[Symbol.hasInstance](e){return!!e&&e instanceof se&&/^(File)$/.test(e[Symbol.toStringTag])}},q=new WeakMap,ee=new WeakMap,Zt),Wt=Fr;/*! formdata-polyfill. MIT License. Jimmy Wärting <https://jimmy.warting.se/opensource> */var{toStringTag:Z,iterator:br,hasInstance:vr}=Symbol,kt=Math.random,Ar="append,set,get,getAll,delete,keys,values,entries,forEach,constructor".split(","),Ut=(t,e,r)=>(t+="",/^(Blob|File)$/.test(e&&e[Z])?[(r=r!==void 0?r+"":e[Z]=="File"?e.name:"blob",t),e.name!==r||e[Z]=="blob"?new Wt([e],r,e):e]:[t,e+""]),De=(t,e)=>(e?t:t.replace(/\r?\n|\r/g,`\r
`)).replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22"),W=(t,e,r)=>{if(e.length<r)throw new TypeError(`Failed to execute '${t}' on 'FormData': ${r} arguments required, but only ${e.length} present.`)};const oe=(Kt=class{constructor(...e){C(this,F,[]);if(e.length)throw new TypeError("Failed to construct 'FormData': parameter 1 is not of type 'HTMLFormElement'.")}get[Z](){return"FormData"}[br](){return this.entries()}static[vr](e){return e&&typeof e=="object"&&e[Z]==="FormData"&&!Ar.some(r=>typeof e[r]!="function")}append(...e){W("append",arguments,2),m(this,F).push(Ut(...e))}delete(e){W("delete",arguments,1),e+="",L(this,F,m(this,F).filter(([r])=>r!==e))}get(e){W("get",arguments,1),e+="";for(var r=m(this,F),i=r.length,n=0;n<i;n++)if(r[n][0]===e)return r[n][1];return null}getAll(e,r){return W("getAll",arguments,1),r=[],e+="",m(this,F).forEach(i=>i[0]===e&&r.push(i[1])),r}has(e){return W("has",arguments,1),e+="",m(this,F).some(r=>r[0]===e)}forEach(e,r){W("forEach",arguments,1);for(var[i,n]of this)e.call(r,n,i,this)}set(...e){W("set",arguments,2);var r=[],i=!0;e=Ut(...e),m(this,F).forEach(n=>{n[0]===e[0]?i&&(i=!r.push(e)):r.push(n)}),i&&r.push(e),L(this,F,r)}*entries(){yield*m(this,F)}*keys(){for(var[e]of this)yield e}*values(){for(var[,e]of this)yield e}},F=new WeakMap,Kt);function Lr(t,e=se){var r=`${kt()}${kt()}`.replace(/\./g,"").slice(-28).padStart(32,"-"),i=[],n=`--${r}\r
Content-Disposition: form-data; name="`;return t.forEach((s,o)=>typeof s=="string"?i.push(n+De(o)+`"\r
\r
${s.replace(/\r(?!\n)|(?<!\r)\n/g,`\r
`)}\r
`):i.push(n+De(o)+`"; filename="${De(s.name,1)}"\r
Content-Type: ${s.type||"application/octet-stream"}\r
\r
`,s,`\r
`)),i.push(`--${r}--`),new e(i,{type:"multipart/form-data; boundary="+r})}class ae extends Error{constructor(e,r){super(e);Error.captureStackTrace(this,this.constructor),this.type=r}get name(){return this.constructor.name}get[Symbol.toStringTag](){return this.constructor.name}}class T extends ae{constructor(e,r,i){super(e,r);i&&(this.code=this.errno=i.code,this.erroredSysCall=i.syscall)}}const fe=Symbol.toStringTag,Gt=t=>typeof t=="object"&&typeof t.append=="function"&&typeof t.delete=="function"&&typeof t.get=="function"&&typeof t.getAll=="function"&&typeof t.has=="function"&&typeof t.set=="function"&&typeof t.sort=="function"&&t[fe]==="URLSearchParams",le=t=>t&&typeof t=="object"&&typeof t.arrayBuffer=="function"&&typeof t.type=="string"&&typeof t.stream=="function"&&typeof t.constructor=="function"&&/^(Blob|File)$/.test(t[fe]),Or=t=>typeof t=="object"&&(t[fe]==="AbortSignal"||t[fe]==="EventTarget"),Tr=(t,e)=>{const r=new URL(e).hostname,i=new URL(t).hostname;return r===i||r.endsWith(`.${i}`)},zr=M.promisify(O.default.pipeline),x=Symbol("Body internals");class K{constructor(e,{size:r=0}={}){let i=null;e===null?e=null:Gt(e)?e=I.Buffer.from(e.toString()):le(e)||I.Buffer.isBuffer(e)||(M.types.isAnyArrayBuffer(e)?e=I.Buffer.from(e):ArrayBuffer.isView(e)?e=I.Buffer.from(e.buffer,e.byteOffset,e.byteLength):e instanceof O.default||(e instanceof oe?(e=Lr(e),i=e.type.split("=")[1]):e=I.Buffer.from(String(e))));let n=e;I.Buffer.isBuffer(e)?n=O.default.Readable.from(e):le(e)&&(n=O.default.Readable.from(e.stream())),this[x]={body:e,stream:n,boundary:i,disturbed:!1,error:null},this.size=r,e instanceof O.default&&e.on("error",s=>{const o=s instanceof ae?s:new T(`Invalid response body while trying to fetch ${this.url}: ${s.message}`,"system",s);this[x].error=o})}get body(){return this[x].stream}get bodyUsed(){return this[x].disturbed}async arrayBuffer(){const{buffer:e,byteOffset:r,byteLength:i}=await ue(this);return e.slice(r,r+i)}async formData(){const e=this.headers.get("content-type");if(e.startsWith("application/x-www-form-urlencoded")){const i=new oe,n=new URLSearchParams(await this.text());for(const[s,o]of n)i.append(s,o);return i}const{toFormData:r}=await Promise.resolve().then(function(){return require("./multipart-parser-806c18e9.js")});return r(this.body,e)}async blob(){const e=this.headers&&this.headers.get("content-type")||this[x].body&&this[x].body.type||"",r=await this.arrayBuffer();return new se([r],{type:e})}async json(){const e=await ue(this);return JSON.parse(e.toString())}async text(){return(await ue(this)).toString()}buffer(){return ue(this)}}K.prototype.buffer=M.deprecate(K.prototype.buffer,"Please use 'response.arrayBuffer()' instead of 'response.buffer()'","node-fetch#buffer"),Object.defineProperties(K.prototype,{body:{enumerable:!0},bodyUsed:{enumerable:!0},arrayBuffer:{enumerable:!0},blob:{enumerable:!0},json:{enumerable:!0},text:{enumerable:!0},data:{get:M.deprecate(()=>{},"data doesn't exist, use json(), text(), arrayBuffer(), or body instead","https://github.com/node-fetch/node-fetch/issues/1000 (response)")}});async function ue(t){if(t[x].disturbed)throw new TypeError(`body used already for: ${t.url}`);if(t[x].disturbed=!0,t[x].error)throw t[x].error;const{body:e}=t;if(e===null||!(e instanceof O.default))return I.Buffer.alloc(0);const r=[];let i=0;try{for await(const n of e){if(t.size>0&&i+n.length>t.size){const s=new T(`content size at ${t.url} over limit: ${t.size}`,"max-size");throw e.destroy(s),s}i+=n.length,r.push(n)}}catch(n){throw n instanceof ae?n:new T(`Invalid response body while trying to fetch ${t.url}: ${n.message}`,"system",n)}if(e.readableEnded===!0||e._readableState.ended===!0)try{return r.every(n=>typeof n=="string")?I.Buffer.from(r.join("")):I.Buffer.concat(r,i)}catch(n){throw new T(`Could not create Buffer from response body for ${t.url}: ${n.message}`,"system",n)}else throw new T(`Premature close of server response while trying to fetch ${t.url}`)}const je=(t,e)=>{let r,i,{body:n}=t[x];if(t.bodyUsed)throw new Error("cannot clone body after it is used");return n instanceof O.default&&typeof n.getBoundary!="function"&&(r=new v.PassThrough({highWaterMark:e}),i=new v.PassThrough({highWaterMark:e}),n.pipe(r),n.pipe(i),t[x].stream=r,n=i),n},Rr=M.deprecate(t=>t.getBoundary(),"form-data doesn't follow the spec and requires special treatment. Use alternative package","https://github.com/node-fetch/node-fetch/issues/1167"),Ht=(t,e)=>t===null?null:typeof t=="string"?"text/plain;charset=UTF-8":Gt(t)?"application/x-www-form-urlencoded;charset=UTF-8":le(t)?t.type||null:I.Buffer.isBuffer(t)||M.types.isAnyArrayBuffer(t)||ArrayBuffer.isView(t)?null:t instanceof oe?`multipart/form-data; boundary=${e[x].boundary}`:t&&typeof t.getBoundary=="function"?`multipart/form-data;boundary=${Rr(t)}`:t instanceof O.default?null:"text/plain;charset=UTF-8",Mr=t=>{const{body:e}=t[x];return e===null?0:le(e)?e.size:I.Buffer.isBuffer(e)?e.length:e&&typeof e.getLengthSync=="function"&&e.hasKnownLength&&e.hasKnownLength()?e.getLengthSync():null},Pr=async(t,{body:e})=>{e===null?t.end():await zr(e,t)},ce=typeof V.default.validateHeaderName=="function"?V.default.validateHeaderName:t=>{if(!/^[\^`\-\w!#$%&'*+.|~]+$/.test(t)){const e=new TypeError(`Header name must be a valid HTTP token [${t}]`);throw Object.defineProperty(e,"code",{value:"ERR_INVALID_HTTP_TOKEN"}),e}},Ve=typeof V.default.validateHeaderValue=="function"?V.default.validateHeaderValue:(t,e)=>{if(/[^\t\u0020-\u007E\u0080-\u00FF]/.test(e)){const r=new TypeError(`Invalid character in header content ["${t}"]`);throw Object.defineProperty(r,"code",{value:"ERR_INVALID_CHAR"}),r}};class $ extends URLSearchParams{constructor(e){let r=[];if(e instanceof $){const i=e.raw();for(const[n,s]of Object.entries(i))r.push(...s.map(o=>[n,o]))}else if(e!=null)if(typeof e=="object"&&!M.types.isBoxedPrimitive(e)){const i=e[Symbol.iterator];if(i==null)r.push(...Object.entries(e));else{if(typeof i!="function")throw new TypeError("Header pairs must be iterable");r=[...e].map(n=>{if(typeof n!="object"||M.types.isBoxedPrimitive(n))throw new TypeError("Each header pair must be an iterable object");return[...n]}).map(n=>{if(n.length!==2)throw new TypeError("Each header pair must be a name/value tuple");return[...n]})}}else throw new TypeError("Failed to construct 'Headers': The provided value is not of type '(sequence<sequence<ByteString>> or record<ByteString, ByteString>)");r=r.length>0?r.map(([i,n])=>(ce(i),Ve(i,String(n)),[String(i).toLowerCase(),String(n)])):void 0;super(r);return new Proxy(this,{get(i,n,s){switch(n){case"append":case"set":return(o,a)=>(ce(o),Ve(o,String(a)),URLSearchParams.prototype[n].call(i,String(o).toLowerCase(),String(a)));case"delete":case"has":case"getAll":return o=>(ce(o),URLSearchParams.prototype[n].call(i,String(o).toLowerCase()));case"keys":return()=>(i.sort(),new Set(URLSearchParams.prototype.keys.call(i)).keys());default:return Reflect.get(i,n,s)}}})}get[Symbol.toStringTag](){return this.constructor.name}toString(){return Object.prototype.toString.call(this)}get(e){const r=this.getAll(e);if(r.length===0)return null;let i=r.join(", ");return/^content-encoding$/i.test(e)&&(i=i.toLowerCase()),i}forEach(e,r=void 0){for(const i of this.keys())Reflect.apply(e,r,[this.get(i),i,this])}*values(){for(const e of this.keys())yield this.get(e)}*entries(){for(const e of this.keys())yield[e,this.get(e)]}[Symbol.iterator](){return this.entries()}raw(){return[...this.keys()].reduce((e,r)=>(e[r]=this.getAll(r),e),{})}[Symbol.for("nodejs.util.inspect.custom")](){return[...this.keys()].reduce((e,r)=>{const i=this.getAll(r);return r==="host"?e[r]=i[0]:e[r]=i.length>1?i:i[0],e},{})}}Object.defineProperties($.prototype,["get","entries","forEach","values"].reduce((t,e)=>(t[e]={enumerable:!0},t),{}));function Cr(t=[]){return new $(t.reduce((e,r,i,n)=>(i%2===0&&e.push(n.slice(i,i+2)),e),[]).filter(([e,r])=>{try{return ce(e),Ve(e,String(r)),!0}catch{return!1}}))}const Br=new Set([301,302,303,307,308]),Dt=t=>Br.has(t),A=Symbol("Response internals");class b extends K{constructor(e=null,r={}){super(e,r);const i=r.status!=null?r.status:200,n=new $(r.headers);if(e!==null&&!n.has("Content-Type")){const s=Ht(e,this);s&&n.append("Content-Type",s)}this[A]={type:"default",url:r.url,status:i,statusText:r.statusText||"",headers:n,counter:r.counter,highWaterMark:r.highWaterMark}}get type(){return this[A].type}get url(){return this[A].url||""}get status(){return this[A].status}get ok(){return this[A].status>=200&&this[A].status<300}get redirected(){return this[A].counter>0}get statusText(){return this[A].statusText}get headers(){return this[A].headers}get highWaterMark(){return this[A].highWaterMark}clone(){return new b(je(this,this.highWaterMark),{type:this.type,url:this.url,status:this.status,statusText:this.statusText,headers:this.headers,ok:this.ok,redirected:this.redirected,size:this.size,highWaterMark:this.highWaterMark})}static redirect(e,r=302){if(!Dt(r))throw new RangeError('Failed to execute "redirect" on "response": Invalid status code');return new b(null,{headers:{location:new URL(e).toString()},status:r})}static error(){const e=new b(null,{status:0,statusText:""});return e[A].type="error",e}get[Symbol.toStringTag](){return"Response"}}Object.defineProperties(b.prototype,{type:{enumerable:!0},url:{enumerable:!0},status:{enumerable:!0},ok:{enumerable:!0},redirected:{enumerable:!0},statusText:{enumerable:!0},headers:{enumerable:!0},clone:{enumerable:!0}});const $r=t=>{if(t.search)return t.search;const e=t.href.length-1,r=t.hash||(t.href[e]==="#"?"#":"");return t.href[e-r.length]==="?"?"?":""};function jt(t,e=!1){return t==null||(t=new URL(t),/^(about|blob|data):$/.test(t.protocol))?"no-referrer":(t.username="",t.password="",t.hash="",e&&(t.pathname="",t.search=""),t)}const Vt=new Set(["","no-referrer","no-referrer-when-downgrade","same-origin","origin","strict-origin","origin-when-cross-origin","strict-origin-when-cross-origin","unsafe-url"]),Nr="strict-origin-when-cross-origin";function Wr(t){if(!Vt.has(t))throw new TypeError(`Invalid referrerPolicy: ${t}`);return t}function kr(t){if(/^(http|ws)s:$/.test(t.protocol))return!0;const e=t.host.replace(/(^\[)|(]$)/g,""),r=ir.isIP(e);return r===4&&/^127\./.test(e)||r===6&&/^(((0+:){7})|(::(0+:){0,6}))0*1$/.test(e)?!0:/^(.+\.)*localhost$/.test(t.host)?!1:t.protocol==="file:"}function H(t){return/^about:(blank|srcdoc)$/.test(t)||t.protocol==="data:"||/^(blob|filesystem):$/.test(t.protocol)?!0:kr(t)}function Ur(t,{referrerURLCallback:e,referrerOriginCallback:r}={}){if(t.referrer==="no-referrer"||t.referrerPolicy==="")return null;const i=t.referrerPolicy;if(t.referrer==="about:client")return"no-referrer";const n=t.referrer;let s=jt(n),o=jt(n,!0);s.toString().length>4096&&(s=o),e&&(s=e(s)),r&&(o=r(o));const a=new URL(t.url);switch(i){case"no-referrer":return"no-referrer";case"origin":return o;case"unsafe-url":return s;case"strict-origin":return H(s)&&!H(a)?"no-referrer":o.toString();case"strict-origin-when-cross-origin":return s.origin===a.origin?s:H(s)&&!H(a)?"no-referrer":o;case"same-origin":return s.origin===a.origin?s:"no-referrer";case"origin-when-cross-origin":return s.origin===a.origin?s:o;case"no-referrer-when-downgrade":return H(s)&&!H(a)?"no-referrer":s;default:throw new TypeError(`Invalid referrerPolicy: ${i}`)}}function Gr(t){const e=(t.get("referrer-policy")||"").split(/[,\s]+/);let r="";for(const i of e)i&&Vt.has(i)&&(r=i);return r}const y=Symbol("Request internals"),he=t=>typeof t=="object"&&typeof t[y]=="object",Hr=M.deprecate(()=>{},".data is not a valid RequestInit property, use .body instead","https://github.com/node-fetch/node-fetch/issues/1000 (request)");class Y extends K{constructor(e,r={}){let i;if(he(e)?i=new URL(e.url):(i=new URL(e),e={}),i.username!==""||i.password!=="")throw new TypeError(`${i} is an url with embedded credentails.`);let n=r.method||e.method||"GET";if(n=n.toUpperCase(),"data"in r&&Hr(),(r.body!=null||he(e)&&e.body!==null)&&(n==="GET"||n==="HEAD"))throw new TypeError("Request with GET/HEAD method cannot have body");const s=r.body?r.body:he(e)&&e.body!==null?je(e):null;super(s,{size:r.size||e.size||0});const o=new $(r.headers||e.headers||{});if(s!==null&&!o.has("Content-Type")){const l=Ht(s,this);l&&o.set("Content-Type",l)}let a=he(e)?e.signal:null;if("signal"in r&&(a=r.signal),a!=null&&!Or(a))throw new TypeError("Expected signal to be an instanceof AbortSignal or EventTarget");let u=r.referrer==null?e.referrer:r.referrer;if(u==="")u="no-referrer";else if(u){const l=new URL(u);u=/^about:(\/\/)?client$/.test(l)?"client":l}else u=void 0;this[y]={method:n,redirect:r.redirect||e.redirect||"follow",headers:o,parsedURL:i,signal:a,referrer:u},this.follow=r.follow===void 0?e.follow===void 0?20:e.follow:r.follow,this.compress=r.compress===void 0?e.compress===void 0?!0:e.compress:r.compress,this.counter=r.counter||e.counter||0,this.agent=r.agent||e.agent,this.highWaterMark=r.highWaterMark||e.highWaterMark||16384,this.insecureHTTPParser=r.insecureHTTPParser||e.insecureHTTPParser||!1,this.referrerPolicy=r.referrerPolicy||e.referrerPolicy||""}get method(){return this[y].method}get url(){return rr.format(this[y].parsedURL)}get headers(){return this[y].headers}get redirect(){return this[y].redirect}get signal(){return this[y].signal}get referrer(){if(this[y].referrer==="no-referrer")return"";if(this[y].referrer==="client")return"about:client";if(this[y].referrer)return this[y].referrer.toString()}get referrerPolicy(){return this[y].referrerPolicy}set referrerPolicy(e){this[y].referrerPolicy=Wr(e)}clone(){return new Y(this)}get[Symbol.toStringTag](){return"Request"}}Object.defineProperties(Y.prototype,{method:{enumerable:!0},url:{enumerable:!0},headers:{enumerable:!0},redirect:{enumerable:!0},clone:{enumerable:!0},signal:{enumerable:!0},referrer:{enumerable:!0},referrerPolicy:{enumerable:!0}});const Dr=t=>{const{parsedURL:e}=t[y],r=new $(t[y].headers);r.has("Accept")||r.set("Accept","*/*");let i=null;if(t.body===null&&/^(post|put)$/i.test(t.method)&&(i="0"),t.body!==null){const a=Mr(t);typeof a=="number"&&!Number.isNaN(a)&&(i=String(a))}i&&r.set("Content-Length",i),t.referrerPolicy===""&&(t.referrerPolicy=Nr),t.referrer&&t.referrer!=="no-referrer"?t[y].referrer=Ur(t):t[y].referrer="no-referrer",t[y].referrer instanceof URL&&r.set("Referer",t.referrer),r.has("User-Agent")||r.set("User-Agent","node-fetch"),t.compress&&!r.has("Accept-Encoding")&&r.set("Accept-Encoding","gzip,deflate,br");let{agent:n}=t;typeof n=="function"&&(n=n(e)),!r.has("Connection")&&!n&&r.set("Connection","close");const s=$r(e),o={path:e.pathname+s,method:t.method,headers:r[Symbol.for("nodejs.util.inspect.custom")](),insecureHTTPParser:t.insecureHTTPParser,agent:n};return{parsedURL:e,options:o}};class jr extends ae{constructor(e,r="aborted"){super(e,r)}}const Vr=new Set(["data:","http:","https:"]);async function Qt(t,e){return new Promise((r,i)=>{const n=new Y(t,e),{parsedURL:s,options:o}=Dr(n);if(!Vr.has(s.protocol))throw new TypeError(`node-fetch cannot load ${t}. URL scheme "${s.protocol.replace(/:$/,"")}" is not supported.`);if(s.protocol==="data:"){const f=Sr(n.url),_=new b(f,{headers:{"Content-Type":f.typeFull}});r(_);return}const a=(s.protocol==="https:"?nr.default:V.default).request,{signal:u}=n;let l=null;const c=()=>{const f=new jr("The operation was aborted.");i(f),n.body&&n.body instanceof O.default.Readable&&n.body.destroy(f),!(!l||!l.body)&&l.body.emit("error",f)};if(u&&u.aborted){c();return}const p=()=>{c(),g()},d=a(s.toString(),o);u&&u.addEventListener("abort",p);const g=()=>{d.abort(),u&&u.removeEventListener("abort",p)};d.on("error",f=>{i(new T(`request to ${n.url} failed, reason: ${f.message}`,"system",f)),g()}),Qr(d,f=>{l.body.destroy(f)}),process.version<"v14"&&d.on("socket",f=>{let _;f.prependListener("end",()=>{_=f._eventsCount}),f.prependListener("close",w=>{if(l&&_<f._eventsCount&&!w){const z=new Error("Premature close");z.code="ERR_STREAM_PREMATURE_CLOSE",l.body.emit("error",z)}})}),d.on("response",f=>{d.setTimeout(0);const _=Cr(f.rawHeaders);if(Dt(f.statusCode)){const S=_.get("Location");let R=null;try{R=S===null?null:new URL(S,n.url)}catch{if(n.redirect!=="manual"){i(new T(`uri requested responds with an invalid redirect URL: ${S}`,"invalid-redirect")),g();return}}switch(n.redirect){case"error":i(new T(`uri requested responds with a redirect, redirect mode is set to error: ${n.url}`,"no-redirect")),g();return;case"manual":break;case"follow":{if(R===null)break;if(n.counter>=n.follow){i(new T(`maximum redirect reached at: ${n.url}`,"max-redirect")),g();return}const E={headers:new $(n.headers),follow:n.follow,counter:n.counter+1,agent:n.agent,compress:n.compress,method:n.method,body:je(n),signal:n.signal,size:n.size,referrer:n.referrer,referrerPolicy:n.referrerPolicy};if(!Tr(n.url,R))for(const Xt of["authorization","www-authenticate","cookie","cookie2"])E.headers.delete(Xt);if(f.statusCode!==303&&n.body&&e.body instanceof O.default.Readable){i(new T("Cannot follow redirect with body being a readable stream","unsupported-redirect")),g();return}(f.statusCode===303||(f.statusCode===301||f.statusCode===302)&&n.method==="POST")&&(E.method="GET",E.body=void 0,E.headers.delete("content-length"));const Qe=Gr(_);Qe&&(E.referrerPolicy=Qe),r(Qt(new Y(R,E))),g();return}default:return i(new TypeError(`Redirect option '${n.redirect}' is not a valid value of RequestRedirect`))}}u&&f.once("end",()=>{u.removeEventListener("abort",p)});let w=v.pipeline(f,new v.PassThrough,S=>{S&&i(S)});process.version<"v12.10"&&f.on("aborted",p);const z={url:n.url,status:f.statusCode,statusText:f.statusMessage,headers:_,size:n.size,counter:n.counter,highWaterMark:n.highWaterMark},k=_.get("Content-Encoding");if(!n.compress||n.method==="HEAD"||k===null||f.statusCode===204||f.statusCode===304){l=new b(w,z),r(l);return}const Yt={flush:U.default.Z_SYNC_FLUSH,finishFlush:U.default.Z_SYNC_FLUSH};if(k==="gzip"||k==="x-gzip"){w=v.pipeline(w,U.default.createGunzip(Yt),S=>{S&&i(S)}),l=new b(w,z),r(l);return}if(k==="deflate"||k==="x-deflate"){const S=v.pipeline(f,new v.PassThrough,R=>{R&&i(R)});S.once("data",R=>{(R[0]&15)===8?w=v.pipeline(w,U.default.createInflate(),E=>{E&&i(E)}):w=v.pipeline(w,U.default.createInflateRaw(),E=>{E&&i(E)}),l=new b(w,z),r(l)}),S.once("end",()=>{l||(l=new b(w,z),r(l))});return}if(k==="br"){w=v.pipeline(w,U.default.createBrotliDecompress(),S=>{S&&i(S)}),l=new b(w,z),r(l);return}l=new b(w,z),r(l)}),Pr(d,n).catch(i)})}function Qr(t,e){const r=I.Buffer.from(`0\r
\r
`);let i=!1,n=!1,s;t.on("response",o=>{const{headers:a}=o;i=a["transfer-encoding"]==="chunked"&&!a["content-length"]}),t.on("socket",o=>{const a=()=>{if(i&&!n){const u=new Error("Premature close");u.code="ERR_STREAM_PREMATURE_CLOSE",e(u)}};o.prependListener("close",a),t.on("abort",()=>{o.removeListener("close",a)}),o.on("data",u=>{n=I.Buffer.compare(u.slice(-5),r)===0,!n&&s&&(n=I.Buffer.compare(s.slice(-3),r.slice(0,3))===0&&I.Buffer.compare(u.slice(-2),r.slice(3))===0),s=u})})}class Jt extends Bt{async fetch(e,r){return Qt(e,r)}}const Jr=new Jt;exports.File=Wt,exports.FormData=oe,exports.IIIF_1_IMAGE_LEVEL_0=qe,exports.IIIF_1_IMAGE_LEVEL_0_PROFILE=et,exports.IIIF_1_IMAGE_LEVEL_1=xe,exports.IIIF_1_IMAGE_LEVEL_1_PROFILE=Ee,exports.IIIF_1_IMAGE_LEVEL_2=Fe,exports.IIIF_1_IMAGE_LEVEL_2_PROFILE=be,exports.IIIF_2_IMAGE_LEVEL_0=tt,exports.IIIF_2_IMAGE_LEVEL_0_NO_JSON=nt,exports.IIIF_2_IMAGE_LEVEL_0_PROFILE=rt,exports.IIIF_2_IMAGE_LEVEL_1=ve,exports.IIIF_2_IMAGE_LEVEL_1_NO_JSON=Re,exports.IIIF_2_IMAGE_LEVEL_1_PROFILE=Ae,exports.IIIF_2_IMAGE_LEVEL_2=Le,exports.IIIF_2_IMAGE_LEVEL_2_NO_JSON=Me,exports.IIIF_2_IMAGE_LEVEL_2_PROFILE=Oe,exports.IIIF_3_IMAGE_LEVEL_0=it,exports.IIIF_3_IMAGE_LEVEL_1=Te,exports.IIIF_3_IMAGE_LEVEL_2=ze,exports.ImageServiceLoader=Jt,exports.STANFORD_IIIF_1_IMAGE_COMPLIANCE_0=Ye,exports.STANFORD_IIIF_1_IMAGE_COMPLIANCE_1=we,exports.STANFORD_IIIF_1_IMAGE_COMPLIANCE_2=Ie,exports.STANFORD_IIIF_1_IMAGE_CONFORMANCE_0=Xe,exports.STANFORD_IIIF_1_IMAGE_CONFORMANCE_1=_e,exports.STANFORD_IIIF_1_IMAGE_CONFORMANCE_2=Se,exports.STANFORD_IIIF_IMAGE_COMPLIANCE_0=Ze,exports.STANFORD_IIIF_IMAGE_COMPLIANCE_1=pe,exports.STANFORD_IIIF_IMAGE_COMPLIANCE_2=ge,exports.STANFORD_IIIF_IMAGE_CONFORMANCE_0=Ke,exports.STANFORD_IIIF_IMAGE_CONFORMANCE_1=me,exports.STANFORD_IIIF_IMAGE_CONFORMANCE_2=ye,exports.canonicalServiceUrl=B,exports.combineProfiles=Ne,exports.createImageServiceRequest=pt,exports.extraFeatures=$e,exports.extractFixedSizeScales=gt,exports.fixedSizesFromScales=mt,exports.getCustomSizeFromService=wt,exports.getFixedSizeFromImage=_t,exports.getFixedSizesFromService=St,exports.getId=h,exports.getImageCandidates=xt,exports.getImageCandidatesFromService=ke,exports.getImageFromTileSource=ne,exports.getImageServerFromId=N,exports.getImageServices=Ue,exports.getSmallestScaleFactorAsSingleImage=cr,exports.getType=It,exports.imageServiceLoader=Jr,exports.imageServiceProfiles=Be,exports.imageServiceRequestToString=Lt,exports.imageServiceSupportsFormat=hr,exports.imageServiceSupportsRequest=dr,exports.inferSizeFromUrl=We,exports.isBestMatch=Ot,exports.isImageService=G,exports.level0=st,exports.level0Support=sr,exports.level1=ot,exports.level1Support=Ce,exports.level2=at,exports.level2Support=Pe,exports.levelToProfile=ft,exports.parseImageServiceRequest=dt,exports.parseImageServiceUrl=ht,exports.parseRegionParameter=lt,exports.parseRotationParameter=ct,exports.parseSizeParameter=ut,exports.pickBestFromCandidates=Tt,exports.regionParameterToString=Et,exports.rotationParameterToString=bt,exports.sampledTilesToTiles=Mt,exports.sizeParameterToString=Ft,exports.sizesMatch=Pt,exports.supports=Ge,exports.supportsCustomSizes=yt;
