"use strict";var je=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var g=(r,e,t)=>(je(r,e,"read from private field"),t?t.call(r):e.get(r)),B=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},A=(r,e,t,i)=>(je(r,e,"write to private field"),i?i.call(r,t):e.set(r,t),t);var P,X,H,ce,D,q,ee,Qt,E,Jt,Yt=require("node:http"),Xt=require("node:https"),qt=require("node:zlib"),b=require("node:stream"),w=require("node:buffer"),M=require("node:util"),er=require("node:url"),tr=require("node:net");require("node:fs"),require("node:path"),require("node-domexception");function te(r){return r&&typeof r=="object"&&"default"in r?r:{default:r}}var V=te(Yt),rr=te(Xt),U=te(qt),L=te(b);function C(r){return r.endsWith("info.json")?r:r.endsWith("/")?`${r}info.json`:`${r}/info.json`}const Qe="http://library.stanford.edu/iiif/image-api/compliance.html#level0",he="http://library.stanford.edu/iiif/image-api/compliance.html#level1",de="http://library.stanford.edu/iiif/image-api/compliance.html#level2",Je="http://library.stanford.edu/iiif/image-api/conformance.html#level0",pe="http://library.stanford.edu/iiif/image-api/conformance.html#level1",ge="http://library.stanford.edu/iiif/image-api/conformance.html#level2",Ze="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0",me="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1",ye="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2",Ke="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0",we="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1",Ie="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2",Ye="http://iiif.io/api/image/1/level0.json",Xe="http://iiif.io/api/image/1/profiles/level0.json",_e="http://iiif.io/api/image/1/level1.json",Se="http://iiif.io/api/image/1/profiles/level1.json",xe="http://iiif.io/api/image/1/level2.json",Ee="http://iiif.io/api/image/1/profiles/level2.json",qe="http://iiif.io/api/image/2/level0.json",et="http://iiif.io/api/image/2/profiles/level0.json",Fe="http://iiif.io/api/image/2/level1.json",be="http://iiif.io/api/image/2/profiles/level1.json",ve="http://iiif.io/api/image/2/level2.json",Ae="http://iiif.io/api/image/2/profiles/level2.json",tt="level0",Le="level1",Oe="level2",rt="http://iiif.io/api/image/2/level0",Te="http://iiif.io/api/image/2/level1",ze="http://iiif.io/api/image/2/level2",Re=[ze,de,ge,ye,Ie,xe,Ee,ve,Ae,Oe],Me=[...Re,Te,he,pe,me,we,_e,Se,Fe,be,Le],Pe=[rt,Te,ze,Qe,he,de,Je,pe,ge,Ze,me,ye,Ke,we,Ie,Ye,Xe,_e,Se,xe,Ee,qe,et,Fe,be,ve,Ae,tt,Le,Oe],ir=Pe,it={extraFormats:["jpg"],extraQualities:["default"],extraFeatures:["sizeByWhListed"]},nt={extraFormats:["jpg"],extraQualities:["default"],extraFeatures:["baseUriRedirect","cors","jsonldMediaType","regionByPx","regionSquare","sizeByWhListed","sizeByH","sizeByW","sizeByWh"]},st={extraFormats:["jpg","png"],extraQualities:["default"],extraFeatures:["baseUriRedirect","cors","jsonldMediaType","regionByPct","regionByPx","regionSquare","rotationBy90s","sizeByWhListed","sizeByConfinedWh","sizeByH","sizeByPct","sizeByW","sizeByWh"]},Be=["baseUriRedirect","canonicalLinkHeader","cors","jsonldMediaType","mirroring","profileLinkHeader","regionByPct","regionByPx","regionSquare","rotationArbitrary","rotationBy90s","sizeByConfinedWh","sizeByH","sizeByPct","sizeByW","sizeByWh","sizeUpscaling","sizeByWhListed","sizeByDistortedWh","sizeByForcedWh"];function ot(r){return Re.indexOf(r)!==-1?st:Me.indexOf(r)!==-1?nt:it}function Ce(r){const e=r?Array.isArray(r.profile)?r.profile:[r.profile]:[],t={extraQualities:[],extraFormats:[],extraFeatures:[]};for(let i of e)if(typeof i=="string"&&(i=ot(i)),!!i){if(i.formats)for(const n of i.formats)t.extraFormats.indexOf(n)===-1&&t.extraFormats.push(n);if(i.qualities)for(const n of i.qualities)t.extraQualities.indexOf(n)===-1&&t.extraQualities.push(n);if(i.supports)for(const n of i.supports)t.extraFeatures.indexOf(n)===-1&&t.extraFeatures.push(n);if(i.maxHeight&&(t.maxHeight=i.maxHeight),i.maxWidth&&(t.maxWidth=i.maxWidth),i.maxArea&&(t.maxArea=i.maxArea),i.extraFormats)for(const n of i.extraFormats)t.extraFormats.indexOf(n)===-1&&t.extraFormats.push(n);if(i.extraQualities)for(const n of i.extraQualities)t.extraQualities.indexOf(n)===-1&&t.extraQualities.push(n);if(i.extraFeatures)for(const n of i.extraFeatures)t.extraFeatures.indexOf(n)===-1&&t.extraFeatures.push(n);i.maxHeight&&(t.maxHeight=i.maxHeight),i.maxWidth&&(t.maxWidth=i.maxWidth),i.maxArea&&(t.maxArea=i.maxArea)}if(r.extraFormats)for(const i of r.extraFormats)t.extraFormats.indexOf(i)===-1&&t.extraFormats.push(i);if(r.extraFeatures)for(const i of r.extraFeatures)t.extraFeatures.indexOf(i)===-1&&t.extraFeatures.push(i);if(r.extraQualities)for(const i of r.extraQualities)t.extraQualities.indexOf(i)===-1&&t.extraQualities.push(i);return t}function at(r){try{if(r==="full")return{full:!0};if(r==="square")return{square:!0};const e=r.startsWith("pct:"),i=r.substr(e?4:0).split(",").map(n=>parseFloat(n));return{x:i[0],y:i[1],w:i[2],h:i[3],percent:e}}catch{throw new Error("Expected 'full', 'square' or 'x,y,w,h'. Found "+r)}}function ft(r){const e={upscaled:!1,max:!1,confined:!1};if(r[0]==="^"&&(e.upscaled=!0,r=r.slice(1)),r==="max"||r==="full")return e.max=!0,e.serialiseAsFull=r==="full",e;if(r[0]==="!"&&(e.confined=!0,r=r.slice(1)),r[0]==="p")return e.percentScale=parseFloat(r.slice(4)),e;const t=r.split(",").map(i=>i.trim());return t.length&&(t[0]!==""&&(e.width=parseInt(t[0],10)),t[1]!==""&&(e.height=parseInt(t[1],10))),e}function lt(r){const e={angle:0};if(r[0]==="!"&&(e.mirror=!0,r=r.substr(1)),e.angle=parseFloat(r)%360,Number.isNaN(e.angle))throw new Error(`Invalid rotation ${r}`);return e}function ut(r,e=""){const t=r.match(/^(([a-zA-Z]+):\/\/([^/]+))?((.*)+)/);if(!t)throw new Error(`Invalid or unknown input ${r}`);const i=t[2],n=t[3];let s=t[4];if(s[0]==="/"&&(s=s.substr(1)),e.length>0){if(e[0]==="/"&&(e=e.substr(1)),e!==s.substr(0,e.length))throw new Error(`Path does not start with prefix (path: ${s}, prefix: ${e})`);s=s.substr(e.length)}return{scheme:i,server:n,path:s,prefix:e}}function ct(r,e=""){const{path:t,scheme:i,server:n,prefix:s}=ut(r,e),o=t.split("/").reverse(),[a,l,f,h,..._]=o,p=_.reverse().filter(Boolean).join("/");if(o.length===1||a==="")return{type:"base",scheme:i,server:n,prefix:s,identifier:p};if(a==="info.json"){const[,...u]=o;return{type:"info",scheme:i,server:n,prefix:s,identifier:u.reverse().filter(Boolean).join("/")}}const c=a.split(".");return{type:"image",scheme:i,server:n,prefix:s,identifier:p,originalPath:t,region:at(h),size:ft(f),rotation:lt(l),quality:c[0],format:c[1]}}function ht(r){const e=ct(C(r.id));if(e.type!=="info")throw new Error("Invalid service URL");const t=Ce(r);return{identifier:e.identifier,originalPath:"",server:e.server,prefix:e.prefix,scheme:e.scheme,type:"image",quality:t.extraQualities.indexOf("default")===-1?t.extraQualities[0]:"default",region:{full:!0},size:{max:!0,upscaled:!1,confined:!1},format:"jpg",rotation:{angle:0}}}function dt(r,e,t){const i=t.length,n=[];for(let s=0;s<i;s++){const a=t[s].width;n.push(r/a)}return n}function pt(r,e,t){const i=t.length,n=[];for(let s=0;s<i;s++){const o=t[s];n.push({width:Math.floor(r/o),height:Math.floor(e/o)})}return n}function d(r){if(r["@id"])return r["@id"];if(r.id)return r.id}function j(r){if(!r||!r.profile||!d(r))return!1;const e=Array.isArray(r.profile)?r.profile:[r.profile];for(const t of e)if(typeof t=="string"&&Pe.indexOf(t)!==-1)return!0;return!1}function gt(r){if(!j(r))return!1;const e=Array.isArray(r.profile)?r.profile:[r.profile];for(const t of e)if(typeof t=="string"){if(Me.indexOf(t)!==-1)return!0}else{const i=[...t.supports||[],...t.extraFeatures||[]];if(i.indexOf("regionByPx")!==-1&&(i.indexOf("sizeByW")!==-1||i.indexOf("sizeByWh")!==-1))return!0}return!1}function mt(r){if(!gt(r))return[];const e=[],t=Array.isArray(r.profile)?r.profile:[r.profile],i=t.length;for(let n=0;n<i;n++){const s=t[n];if(typeof s!="string"&&(s.maxHeight||s.maxWidth))return[{id:d(r),type:"variable",minWidth:0,minHeight:0,maxHeight:s.maxHeight||s.maxWidth,maxWidth:s.maxWidth||s.maxHeight}]}if(r.tiles){const n=r.tiles.length;for(let s=0;s<n;s++){const o=r.tiles[s];(o.height||o.width)&&e.push({id:d(r),type:"variable",minHeight:0,minWidth:0,maxHeight:o.height||o.width,maxWidth:o.width})}}return e}function Ne(r){const e=/^.*\/(full)\/(((\d+),(\d+)?)|max)\/(\d+)\/default\.(jpg|png|jpeg)$/,t=r.match(e);if(t){const i=t[1],n=parseInt(t[4],10),s=parseInt(t[5],10),o=t[7];if((i==="max"||i==="full")&&n&&s&&o)return{type:"fixed",id:r,height:s,width:n}}return{type:"unknown",id:r}}function yt(r){if(r["@type"])return r["@type"];if(r.type)return r.type}function wt(r){if(typeof r=="string")return Ne(r);const e=yt(r);if(e!=="Image"&&e!=="sc:Image")return null;const t=r,i=d(t);return i?i&&t.width&&t.height?{id:i,type:"fixed",width:t.width,height:t.height,unsafe:!0}:Ne(i):null}function It(r){return j(r)?(r&&r.sizes?r.sizes:[]).map(e=>({id:d(r),type:"fixed-service",height:e.height,width:e.width})):[]}function $e(r){const e=[],t=r.length;for(let i=0;i<t;i++){const n=It(r[i]);n.length&&e.push(...n);const s=mt(r[i]);s.length&&e.push(...s)}return e}function We(r){const e=r.service?Array.isArray(r.service)?r.service:[r.service]:[],t=e.length,i=[];for(let n=0;n<t;n++)j(e[n])&&i.push(e[n]);return i}function _t(r,e=!0,t){const i=[],n=wt(r);if(n===null)return i;const s=r;if(i.push(n),e&&s.width&&s.height){const o=[],a=We(s);for(const l of a){const f={id:d(l),width:s.width,height:s.height};if(t.canLoadSync(f)){const h=t.loadServiceSync(f);h&&(h.height||(h.height=s.height),h.width||(h.width=s.width),o.push(...$e([h])))}}if(o.length)return i.push(...o),i}return s.service&&i.push(...$e(s.service)),i}function St({x:r=0,y:e=0,w:t,h:i,full:n,square:s,percent:o}){if(n)return"full";if(s)return"square";if(typeof t>"u"||typeof i>"u")throw new Error("RegionParameter: invalid region");const a=`${r},${e},${t},${i}`;return o?`pct:${a}`:a}function xt({max:r,percentScale:e,upscaled:t,confined:i,width:n,height:s,serialiseAsFull:o}){const a=[];return t&&a.push("^"),r?(a.push(o?"full":"max"),a.join("")):(i&&a.push("!"),e&&a.push(`pct:${e}`),n&&a.push(`${n}`),a.push(","),s&&a.push(`${s}`),a.join(""))}function Et(r){return`${r.mirror?"!":""}${(r.angle||0)%360}`}var nr=Object.defineProperty,sr=Object.defineProperties,or=Object.getOwnPropertyDescriptors,Ft=Object.getOwnPropertySymbols,ar=Object.prototype.hasOwnProperty,fr=Object.prototype.propertyIsEnumerable,bt=(r,e,t)=>e in r?nr(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,Q=(r,e)=>{for(var t in e||(e={}))ar.call(e,t)&&bt(r,t,e[t]);if(Ft)for(var t of Ft(e))fr.call(e,t)&&bt(r,t,e[t]);return r},J=(r,e)=>sr(r,or(e));function vt(r,e){const t=r.prefix.startsWith("/")?r.prefix.substr(1):r.prefix,i=`${r.scheme}://${r.server}/${t?`${t}/`:""}${r.identifier}`;if(r.type==="base")return i;if(r.type==="info")return`${i}/info.json`;let{region:n,size:s,rotation:o,format:a,quality:l}=r;if(e){const f=e["@context"]?Array.isArray(e["@context"])?e["@context"]:[e["@context"]]:[],h=f.indexOf("http://iiif.io/api/image/2/context.json")!==-1,_=f.indexOf("http://iiif.io/api/image/3/context.json")!==-1;if((s.width===e.width&&!s.height||s.height===e.height&&!s.width||s.width===e.width&&s.height===e.height)&&(s=J(Q({},s),{max:!0})),h&&(s.max&&!s.serialiseAsFull&&(s=J(Q({},s),{serialiseAsFull:!0})),!s.max&&s.width&&s.height&&(s=J(Q({},s),{height:void 0}))),_&&(s.max&&s.serialiseAsFull&&(s=J(Q({},s),{serialiseAsFull:!1})),s.width&&!s.height&&e.width&&e.height)){const p=e.height/e.width;s=J(Q({},s),{height:Math.ceil(s.width*p)})}}return[i,St(n),xt(s),Et(o),`${l}.${a}`].filter(Boolean).join("/")}function re(r,e,t){const i=ht({id:C(d(r)),profile:"level2",type:"ImageService2"});if(i.type!=="image")throw new Error("Invalid service");return i.size.max=!1,i.size.width=e,i.size.height=t,{id:vt(i),type:"fixed",width:e,height:t||r.height/(r.width||1)*e,unsafe:r.width>e}}function $(r){const e=r.replace(/(https?:\/\/)?(www.)?/i,"");return e.indexOf("/")!==-1?e.split("/")[0]:e}function lr(r){if(!r.width||!r.height)return null;if(r.tiles){const e=r.tiles.sort((i,n)=>Math.max(...n.scaleFactors)-Math.max(...i.scaleFactors)),t=e.length;for(let i=0;i<t;i++){const n=e[i],s=n.width;if(!s)continue;const o=n.scaleFactors.length,a=n.scaleFactors.sort();for(let l=0;l<o;l++){const f=a[l];if(r.width/f<=s&&r.height/f<=s)return{id:d(r),type:"fixed-service",width:r.width/f|0,height:r.height/f|0}}}}return null}function ke(r,e){if(!j(r))return[!1,"Not a valid image service"];e.extraFeatures=e.extraFeatures?e.extraFeatures:[];const t=Ce(r);if(e.exactSize){let i=!1;if(r.sizes)for(const n of r.sizes)n.width&&n.width===e.exactSize.width&&(Be.indexOf("sizeByW")!==-1||n.height&&n.height===e.exactSize.height)&&(i=!0),n.height&&n.height===e.exactSize.height&&(Be.indexOf("sizeByH")!==-1||n.width&&n.width===e.exactSize.width)&&(i=!0);i||(e.maxWidth=Math.max(e.maxWidth||0,e.exactSize.width||0)||void 0,e.maxHeight=Math.max(e.maxHeight||0,e.exactSize.height||0)||void 0,e.maxArea=Math.max(e.maxArea||0,(e.exactSize.width&&e.exactSize.height?e.exactSize.width*e.exactSize.height:e.maxArea)||0)||void 0,!e.exactSize.height&&e.exactSize.width?e.extraFeatures.indexOf("sizeByW")===-1&&e.extraFeatures.push("sizeByW"):!e.exactSize.width&&e.exactSize.height&&e.extraFeatures.indexOf("sizeByH")===-1&&e.extraFeatures.push("sizeByH"))}if(e.maxArea&&t.maxArea&&e.maxArea>t.maxArea)return[!1,`Max area is ${t.maxArea}`];if(e.maxWidth&&t.maxWidth&&e.maxWidth>t.maxWidth)return[!1,`Max width is ${t.maxWidth}`];if(e.maxHeight&&t.maxHeight&&e.maxHeight>t.maxHeight)return[!1,`Max height is ${t.maxHeight}`];if(e.extraFeatures){const i=[];for(const n of e.extraFeatures)t.extraFeatures.indexOf(n)===-1&&i.push(n);if(i.length)return[!1,`Missing features: ${i.join(", ")}`]}if(e.extraFormats){const i=[];for(const n of e.extraFormats)t.extraFormats.indexOf(n)===-1&&i.push(n);if(i.length)return[!1,`Missing formats: ${i.join(", ")}`]}if(e.extraQualities){const i=[];for(const n of e.extraQualities)t.extraQualities.indexOf(n)===-1&&i.push(n);if(i.length)return[!1,`Missing qualities: ${i.join(", ")}`]}return[!0]}function ur(r,e){return ke(r,{extraFormats:[e]})}function cr(r,e){if(e.type!=="image")return[!0];const t=[];e.rotation.mirror&&t.push("mirroring"),e.region.percent&&t.push("regionByPct"),e.region.square?t.push("regionSquare"):e.region.full||t.push("regionByPx"),e.rotation.angle&&(e.rotation.angle%90?t.push("rotationArbitrary"):t.push("rotationBy90s")),e.size.confined&&t.push("sizeByConfinedWh"),!e.size.width&&e.size.height&&t.push("sizeByH"),e.size.percentScale&&t.push("sizeByPct"),(r.sizes||[]).find(o=>o.width===e.size.width&&!e.size.height||o.height===e.size.height&&!e.size.width||o.height===e.size.height&&o.width===e.size.width)?t.push("sizeByWhListed"):(e.size.width&&!e.size.height&&t.push("sizeByW"),e.size.width&&e.size.height&&t.push("sizeByWh")),e.size.upscaled&&t.push("sizeUpscaling");const[n,s]=ke(r,{extraFeatures:t,extraQualities:[e.quality],extraFormats:[e.format],exactSize:e.size});return n?[!0]:[!1,s]}function At(r,e,t){const i=r.width?r.width:r.maxWidth;return t.height<=r.maxHeight&&t.width<=r.maxWidth&&t.height>=r.minHeight&&t.width>=r.minWidth&&(!e||Math.abs(t.width-i)<Math.abs(e.width-i))}function Lt(r,e){const t=[],i=Object.assign({unsafeImageService:!1,atAnyCost:!0,fallback:!0,minHeight:64,minWidth:64,maxHeight:1/0,maxWidth:1/0,returnAllOptions:!1,preferFixedSize:!1,allowUnsafe:!1,explain:!1,height:0,width:0},r),n=[],s=[];let o=null;const a=(f,h)=>{if(At(i,h,f)){if(i.preferFixedSize&&f.unsafe){s.push(f);return}i.returnAllOptions&&h&&s.push(h),o=f}else i.returnAllOptions&&s.push(f)},l=e.length;for(let f=0;f<l;f++){const h=e[f](),_=h.length;for(let p=0;p<_;p++){const c=h[p];if(c.type==="unknown"&&i.atAnyCost&&n.push(c),c.type==="fixed"&&(c.unsafe?n.push(c):a(c,o)),c.type==="fixed-service")if(i.unsafeImageService){const u=re(c,i.width,i.height);a(u,o)}else{const u=re(c,c.width,c.height);a(u,o)}if(c.type==="variable"&&c.maxWidth){const u=re({id:c.id,type:"fixed-service",width:c.maxWidth,height:c.maxWidth},c.maxWidth);a(u,o)}}if(o&&!i.returnAllOptions){if(o.unsafe||i.allowUnsafe)continue;break}}return i.atAnyCost&&s.length===0?{best:o||n[0],fallback:n.slice(1),log:t}:i.returnAllOptions?{best:i.atAnyCost?o||s[0]||n[0]:o||s[0],fallback:[...s,...n],log:t}:{best:o||s[0]||null,fallback:o?s:s.slice(1),log:t}}var hr=Object.defineProperty,dr=Object.defineProperties,pr=Object.getOwnPropertyDescriptors,Ot=Object.getOwnPropertySymbols,gr=Object.prototype.hasOwnProperty,mr=Object.prototype.propertyIsEnumerable,Tt=(r,e,t)=>e in r?hr(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,yr=(r,e)=>{for(var t in e||(e={}))gr.call(e,t)&&Tt(r,t,e[t]);if(Ot)for(var t of Ot(e))mr.call(e,t)&&Tt(r,t,e[t]);return r},wr=(r,e)=>dr(r,pr(e));function zt(r,e,t){const i=r>e?r:e,n=t.length,s=[];for(let o=0;o<n;o++){const a=t[o];let l=a.scaleFactors[0],f=i/l;const h=[l];for(;f>=a.width;)l=l*2,h.push(l),f=f/2;s.push(wr(yr({},a),{scaleFactors:h}))}return s}function Rt(r,e){if(r.length!==e.length)return!1;if(r.length===0&&e.length===0)return!0;const t=r.length;let i=!0;for(let s=0;s<t;s++){const o=r[s],a=e[s];if(o.width!==a.width||o.height!==a.height){i=!1;break}}if(i)return!0;let n=0;for(let s=0;s<t;s++)for(let o=0;o<t;o++)if(r[s].width===e[o].width&&r[s].height===e[o].height){n++;break}return n===t}function Mt(r){if(r&&r.profile){const e=r.profile;if(e){const t=Array.isArray(e)?e:[e];return t.includes("level0")||t.includes("http://iiif.io/api/image/2/level0.json")||t.includes("http://iiif.io/api/image/1/level0.json")||t.includes("http://iiif.io/api/image/1/profiles/level0.json")}}return!1}class Pt{constructor(){this.config={verificationsRequired:1,approximateServices:!0,enableFetching:!0,disableThrottling:!1},this.fetchingCount=0,this.imageServices={},this.knownImageServers={}}setConfig(e){Object.assign(this.config,e)}sample(e,t,i=!0){const n=$(d(e)),s=C(d(e)),o=this.knownImageServers[n];return this.imageServices[s]=Object.assign(e,{real:!0}),!o&&e.tiles&&!Mt(e)?(this.knownImageServers[n]={verifications:0,malformed:!1,root:n,preLoaded:i,sampledId:d(e),verified:!1,server:null,result:{context:e["@context"]||[],sampledProfile:e.profile,resourceServiceRatio:t&&e.height?t.height/e.height:1,sampledSizes:e.sizes||[],sizeRatios:dt(e.width,e.height,e.sizes||[]),sampledTiles:e.tiles||[]}},!0):this.verify(e)}preLoad(e,t=!0){this.knownImageServers[e.root]=e,t&&(this.knownImageServers[e.root].malformed=!1,this.knownImageServers[e.root].verifications=this.config.verificationsRequired)}predict(e,t=!1,i=!1){const n=e==null?void 0:e.source,s=$(d(e)),o=this.knownImageServers[s];if(!o||!o.result||!i&&(o.malformed||o.verifications<this.config.verificationsRequired)||Mt(e.source))return null;const a=C(d(e));return this.imageServices[a]||(this.imageServices[a]={"@context":o.result.context,"@id":d(e),id:d(e),protocol:"http://iiif.io/api/image",tiles:(n==null?void 0:n.tiles)||zt(e.width,e.height,o.result.sampledTiles),sizes:(n==null?void 0:n.sizes)||pt(Math.round(e.width/o.result.resourceServiceRatio),Math.round(e.height/o.result.resourceServiceRatio),o.result.sizeRatios),profile:(n==null?void 0:n.profile)||o.result.sampledProfile,height:(n==null?void 0:n.height)||e.height,width:(n==null?void 0:n.width)||e.width,real:!1}),this.imageServices[a]}async getThumbnailFromResource(e,t,i=!0,n=[]){const s=await this.getImageCandidates(e,i);return Lt(t,[()=>n,()=>s])}async getImageCandidates(e,t=!0){const i=e;if(t&&i.height&&i.width){const n=We(i);for(const s of n){const o={id:d(s),width:s.width?s.width:i.width,height:s.height?s.height:i.height,source:s};await this.loadService(o)}}return _t(e,t,this)}async verify(e){const t=this.predict(e,!1,!0),i=await this.fetchService(d(e));if(!t)return!1;const n=t.height===i.height&&t.width===i.width&&t["@context"]===i["@context"]&&Rt(t.sizes||[],i.sizes||[]);if(n){const s=$(d(e));this.knownImageServers[s].verifications+=1,this.knownImageServers[s].verifications>=this.config.verificationsRequired&&(this.knownImageServers[s].verified=!0)}return n}canLoadSync(e){const t=typeof e=="string"?e:d(e),i=C(t);if(this.imageServices[i])return!0;const n=this.knownImageServers[$(t)];return n&&!n.malformed&&n.verifications>=this.config.verificationsRequired}async markAsMalformed(e){return this.knownImageServers[$(d(e))].malformed=!0,this.loadService(e,!0)}async fetchService(e,t=!1){const i=C(e);if(this.imageServices[i]&&(!t||this.imageServices[i].real))return this.imageServices[i];if(!this.config.enableFetching)throw new Error("Fetching is not enabled");const n=await this.fetch(i).then(s=>s.json());return!n.id&&n["@id"]&&(n.id=n["@id"]),n.id!==e&&(n.id=e,n["@id"]&&(n["@id"]=e)),this.imageServices[i]=Object.assign(n,{real:!0}),this.imageServices[i]}async fetch(e,t){return fetch(e,t)}async loadService(e,t=!1){if(!this.config.disableThrottling){let s=!0;for(;s;)if(this.fetchingCount>=this.config.verificationsRequired)await new Promise(o=>setTimeout(o,500));else{s=!1;break}}const i=this.knownImageServers[$(d(e))];if(i&&!i.malformed&&!t){await i.result;const s=this.loadServiceSync(e);if(s)return s}this.fetchingCount++;const n=await this.fetchService(d(e),t);return this.fetchingCount--,n.real&&this.sample(n,e),n}loadServiceSync(e){const t=C(d(e));return this.imageServices[t]?this.imageServices[t]:this.predict(e)}}new Pt;function Ir(r){if(!/^data:/i.test(r))throw new TypeError('`uri` does not appear to be a Data URI (must begin with "data:")');r=r.replace(/\r?\n/g,"");const e=r.indexOf(",");if(e===-1||e<=4)throw new TypeError("malformed data: URI");const t=r.substring(5,e).split(";");let i="",n=!1;const s=t[0]||"text/plain";let o=s;for(let h=1;h<t.length;h++)t[h]==="base64"?n=!0:(o+=`;${t[h]}`,t[h].indexOf("charset=")===0&&(i=t[h].substring(8)));!t[0]&&!i.length&&(o+=";charset=US-ASCII",i="US-ASCII");const a=n?"base64":"ascii",l=unescape(r.substring(e+1)),f=Buffer.from(l,a);return f.type=s,f.typeFull=o,f.charset=i,f}const _r=65536;if(!globalThis.ReadableStream)try{const r=require("node:process"),{emitWarning:e}=r;try{r.emitWarning=()=>{},Object.assign(globalThis,require("node:stream/web")),r.emitWarning=e}catch(t){throw r.emitWarning=e,t}}catch{Object.assign(globalThis,require("web-streams-polyfill/dist/ponyfill.es2018.js"))}try{const{Blob:r}=require("buffer");r&&!r.prototype.stream&&(r.prototype.stream=function(t){let i=0;const n=this;return new ReadableStream({type:"bytes",async pull(s){const a=await n.slice(i,Math.min(n.size,i+_r)).arrayBuffer();i+=a.byteLength,s.enqueue(new Uint8Array(a)),i===n.size&&s.close()}})})}catch{}/*! fetch-blob. MIT License. Jimmy Wärting <https://jimmy.warting.se/opensource> */const Bt=65536;async function*Ue(r,e=!0){for(const t of r)if("stream"in t)yield*t.stream();else if(ArrayBuffer.isView(t))if(e){let i=t.byteOffset;const n=t.byteOffset+t.byteLength;for(;i!==n;){const s=Math.min(n-i,Bt),o=t.buffer.slice(i,i+s);i+=o.byteLength,yield new Uint8Array(o)}}else yield t;else{let i=0,n=t;for(;i!==n.size;){const o=await n.slice(i,Math.min(n.size,i+Bt)).arrayBuffer();i+=o.byteLength,yield new Uint8Array(o)}}}const Ct=(D=class{constructor(e=[],t={}){B(this,P,[]);B(this,X,"");B(this,H,0);B(this,ce,"transparent");if(typeof e!="object"||e===null)throw new TypeError("Failed to construct 'Blob': The provided value cannot be converted to a sequence.");if(typeof e[Symbol.iterator]!="function")throw new TypeError("Failed to construct 'Blob': The object must have a callable @@iterator property.");if(typeof t!="object"&&typeof t!="function")throw new TypeError("Failed to construct 'Blob': parameter 2 cannot convert to dictionary.");t===null&&(t={});const i=new TextEncoder;for(const s of e){let o;ArrayBuffer.isView(s)?o=new Uint8Array(s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength)):s instanceof ArrayBuffer?o=new Uint8Array(s.slice(0)):s instanceof D?o=s:o=i.encode(`${s}`),A(this,H,g(this,H)+(ArrayBuffer.isView(o)?o.byteLength:o.size)),g(this,P).push(o)}A(this,ce,`${t.endings===void 0?"transparent":t.endings}`);const n=t.type===void 0?"":String(t.type);A(this,X,/^[\x20-\x7E]*$/.test(n)?n:"")}get size(){return g(this,H)}get type(){return g(this,X)}async text(){const e=new TextDecoder;let t="";for await(const i of Ue(g(this,P),!1))t+=e.decode(i,{stream:!0});return t+=e.decode(),t}async arrayBuffer(){const e=new Uint8Array(this.size);let t=0;for await(const i of Ue(g(this,P),!1))e.set(i,t),t+=i.length;return e.buffer}stream(){const e=Ue(g(this,P),!0);return new globalThis.ReadableStream({type:"bytes",async pull(t){const i=await e.next();i.done?t.close():t.enqueue(i.value)},async cancel(){await e.return()}})}slice(e=0,t=this.size,i=""){const{size:n}=this;let s=e<0?Math.max(n+e,0):Math.min(e,n),o=t<0?Math.max(n+t,0):Math.min(t,n);const a=Math.max(o-s,0),l=g(this,P),f=[];let h=0;for(const p of l){if(h>=a)break;const c=ArrayBuffer.isView(p)?p.byteLength:p.size;if(s&&c<=s)s-=c,o-=c;else{let u;ArrayBuffer.isView(p)?(u=p.subarray(s,Math.min(c,o)),h+=u.byteLength):(u=p.slice(s,Math.min(c,o)),h+=u.size),o-=c,f.push(u),s=0}}const _=new D([],{type:String(i).toLowerCase()});return A(_,H,a),A(_,P,f),_}get[Symbol.toStringTag](){return"Blob"}static[Symbol.hasInstance](e){return e&&typeof e=="object"&&typeof e.constructor=="function"&&(typeof e.stream=="function"||typeof e.arrayBuffer=="function")&&/^(Blob|File)$/.test(e[Symbol.toStringTag])}},P=new WeakMap,X=new WeakMap,H=new WeakMap,ce=new WeakMap,D);Object.defineProperties(Ct.prototype,{size:{enumerable:!0},type:{enumerable:!0},slice:{enumerable:!0}});const Sr=Ct;var ie=Sr;const xr=(Qt=class extends ie{constructor(e,t,i={}){if(arguments.length<2)throw new TypeError(`Failed to construct 'File': 2 arguments required, but only ${arguments.length} present.`);super(e,i);B(this,q,0);B(this,ee,"");i===null&&(i={});const n=i.lastModified===void 0?Date.now():Number(i.lastModified);Number.isNaN(n)||A(this,q,n),A(this,ee,String(t))}get name(){return g(this,ee)}get lastModified(){return g(this,q)}get[Symbol.toStringTag](){return"File"}static[Symbol.hasInstance](e){return!!e&&e instanceof ie&&/^(File)$/.test(e[Symbol.toStringTag])}},q=new WeakMap,ee=new WeakMap,Qt),Nt=xr;/*! formdata-polyfill. MIT License. Jimmy Wärting <https://jimmy.warting.se/opensource> */var{toStringTag:Z,iterator:Er,hasInstance:Fr}=Symbol,$t=Math.random,br="append,set,get,getAll,delete,keys,values,entries,forEach,constructor".split(","),Wt=(r,e,t)=>(r+="",/^(Blob|File)$/.test(e&&e[Z])?[(t=t!==void 0?t+"":e[Z]=="File"?e.name:"blob",r),e.name!==t||e[Z]=="blob"?new Nt([e],t,e):e]:[r,e+""]),Ge=(r,e)=>(e?r:r.replace(/\r?\n|\r/g,`\r
`)).replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22"),W=(r,e,t)=>{if(e.length<t)throw new TypeError(`Failed to execute '${r}' on 'FormData': ${t} arguments required, but only ${e.length} present.`)};const ne=(Jt=class{constructor(...e){B(this,E,[]);if(e.length)throw new TypeError("Failed to construct 'FormData': parameter 1 is not of type 'HTMLFormElement'.")}get[Z](){return"FormData"}[Er](){return this.entries()}static[Fr](e){return e&&typeof e=="object"&&e[Z]==="FormData"&&!br.some(t=>typeof e[t]!="function")}append(...e){W("append",arguments,2),g(this,E).push(Wt(...e))}delete(e){W("delete",arguments,1),e+="",A(this,E,g(this,E).filter(([t])=>t!==e))}get(e){W("get",arguments,1),e+="";for(var t=g(this,E),i=t.length,n=0;n<i;n++)if(t[n][0]===e)return t[n][1];return null}getAll(e,t){return W("getAll",arguments,1),t=[],e+="",g(this,E).forEach(i=>i[0]===e&&t.push(i[1])),t}has(e){return W("has",arguments,1),e+="",g(this,E).some(t=>t[0]===e)}forEach(e,t){W("forEach",arguments,1);for(var[i,n]of this)e.call(t,n,i,this)}set(...e){W("set",arguments,2);var t=[],i=!0;e=Wt(...e),g(this,E).forEach(n=>{n[0]===e[0]?i&&(i=!t.push(e)):t.push(n)}),i&&t.push(e),A(this,E,t)}*entries(){yield*g(this,E)}*keys(){for(var[e]of this)yield e}*values(){for(var[,e]of this)yield e}},E=new WeakMap,Jt);function vr(r,e=ie){var t=`${$t()}${$t()}`.replace(/\./g,"").slice(-28).padStart(32,"-"),i=[],n=`--${t}\r
Content-Disposition: form-data; name="`;return r.forEach((s,o)=>typeof s=="string"?i.push(n+Ge(o)+`"\r
\r
${s.replace(/\r(?!\n)|(?<!\r)\n/g,`\r
`)}\r
`):i.push(n+Ge(o)+`"; filename="${Ge(s.name,1)}"\r
Content-Type: ${s.type||"application/octet-stream"}\r
\r
`,s,`\r
`)),i.push(`--${t}--`),new e(i,{type:"multipart/form-data; boundary="+t})}class se extends Error{constructor(e,t){super(e);Error.captureStackTrace(this,this.constructor),this.type=t}get name(){return this.constructor.name}get[Symbol.toStringTag](){return this.constructor.name}}class O extends se{constructor(e,t,i){super(e,t);i&&(this.code=this.errno=i.code,this.erroredSysCall=i.syscall)}}const oe=Symbol.toStringTag,kt=r=>typeof r=="object"&&typeof r.append=="function"&&typeof r.delete=="function"&&typeof r.get=="function"&&typeof r.getAll=="function"&&typeof r.has=="function"&&typeof r.set=="function"&&typeof r.sort=="function"&&r[oe]==="URLSearchParams",ae=r=>r&&typeof r=="object"&&typeof r.arrayBuffer=="function"&&typeof r.type=="string"&&typeof r.stream=="function"&&typeof r.constructor=="function"&&/^(Blob|File)$/.test(r[oe]),Ar=r=>typeof r=="object"&&(r[oe]==="AbortSignal"||r[oe]==="EventTarget"),Lr=(r,e)=>{const t=new URL(e).hostname,i=new URL(r).hostname;return t===i||t.endsWith(`.${i}`)},Or=M.promisify(L.default.pipeline),S=Symbol("Body internals");class K{constructor(e,{size:t=0}={}){let i=null;e===null?e=null:kt(e)?e=w.Buffer.from(e.toString()):ae(e)||w.Buffer.isBuffer(e)||(M.types.isAnyArrayBuffer(e)?e=w.Buffer.from(e):ArrayBuffer.isView(e)?e=w.Buffer.from(e.buffer,e.byteOffset,e.byteLength):e instanceof L.default||(e instanceof ne?(e=vr(e),i=e.type.split("=")[1]):e=w.Buffer.from(String(e))));let n=e;w.Buffer.isBuffer(e)?n=L.default.Readable.from(e):ae(e)&&(n=L.default.Readable.from(e.stream())),this[S]={body:e,stream:n,boundary:i,disturbed:!1,error:null},this.size=t,e instanceof L.default&&e.on("error",s=>{const o=s instanceof se?s:new O(`Invalid response body while trying to fetch ${this.url}: ${s.message}`,"system",s);this[S].error=o})}get body(){return this[S].stream}get bodyUsed(){return this[S].disturbed}async arrayBuffer(){const{buffer:e,byteOffset:t,byteLength:i}=await fe(this);return e.slice(t,t+i)}async formData(){const e=this.headers.get("content-type");if(e.startsWith("application/x-www-form-urlencoded")){const i=new ne,n=new URLSearchParams(await this.text());for(const[s,o]of n)i.append(s,o);return i}const{toFormData:t}=await Promise.resolve().then(function(){return require("./multipart-parser-5a0f7292.js")});return t(this.body,e)}async blob(){const e=this.headers&&this.headers.get("content-type")||this[S].body&&this[S].body.type||"",t=await this.arrayBuffer();return new ie([t],{type:e})}async json(){const e=await fe(this);return JSON.parse(e.toString())}async text(){return(await fe(this)).toString()}buffer(){return fe(this)}}K.prototype.buffer=M.deprecate(K.prototype.buffer,"Please use 'response.arrayBuffer()' instead of 'response.buffer()'","node-fetch#buffer"),Object.defineProperties(K.prototype,{body:{enumerable:!0},bodyUsed:{enumerable:!0},arrayBuffer:{enumerable:!0},blob:{enumerable:!0},json:{enumerable:!0},text:{enumerable:!0},data:{get:M.deprecate(()=>{},"data doesn't exist, use json(), text(), arrayBuffer(), or body instead","https://github.com/node-fetch/node-fetch/issues/1000 (response)")}});async function fe(r){if(r[S].disturbed)throw new TypeError(`body used already for: ${r.url}`);if(r[S].disturbed=!0,r[S].error)throw r[S].error;const{body:e}=r;if(e===null||!(e instanceof L.default))return w.Buffer.alloc(0);const t=[];let i=0;try{for await(const n of e){if(r.size>0&&i+n.length>r.size){const s=new O(`content size at ${r.url} over limit: ${r.size}`,"max-size");throw e.destroy(s),s}i+=n.length,t.push(n)}}catch(n){throw n instanceof se?n:new O(`Invalid response body while trying to fetch ${r.url}: ${n.message}`,"system",n)}if(e.readableEnded===!0||e._readableState.ended===!0)try{return t.every(n=>typeof n=="string")?w.Buffer.from(t.join("")):w.Buffer.concat(t,i)}catch(n){throw new O(`Could not create Buffer from response body for ${r.url}: ${n.message}`,"system",n)}else throw new O(`Premature close of server response while trying to fetch ${r.url}`)}const He=(r,e)=>{let t,i,{body:n}=r[S];if(r.bodyUsed)throw new Error("cannot clone body after it is used");return n instanceof L.default&&typeof n.getBoundary!="function"&&(t=new b.PassThrough({highWaterMark:e}),i=new b.PassThrough({highWaterMark:e}),n.pipe(t),n.pipe(i),r[S].stream=t,n=i),n},Tr=M.deprecate(r=>r.getBoundary(),"form-data doesn't follow the spec and requires special treatment. Use alternative package","https://github.com/node-fetch/node-fetch/issues/1167"),Ut=(r,e)=>r===null?null:typeof r=="string"?"text/plain;charset=UTF-8":kt(r)?"application/x-www-form-urlencoded;charset=UTF-8":ae(r)?r.type||null:w.Buffer.isBuffer(r)||M.types.isAnyArrayBuffer(r)||ArrayBuffer.isView(r)?null:r instanceof ne?`multipart/form-data; boundary=${e[S].boundary}`:r&&typeof r.getBoundary=="function"?`multipart/form-data;boundary=${Tr(r)}`:r instanceof L.default?null:"text/plain;charset=UTF-8",zr=r=>{const{body:e}=r[S];return e===null?0:ae(e)?e.size:w.Buffer.isBuffer(e)?e.length:e&&typeof e.getLengthSync=="function"&&e.hasKnownLength&&e.hasKnownLength()?e.getLengthSync():null},Rr=async(r,{body:e})=>{e===null?r.end():await Or(e,r)},le=typeof V.default.validateHeaderName=="function"?V.default.validateHeaderName:r=>{if(!/^[\^`\-\w!#$%&'*+.|~]+$/.test(r)){const e=new TypeError(`Header name must be a valid HTTP token [${r}]`);throw Object.defineProperty(e,"code",{value:"ERR_INVALID_HTTP_TOKEN"}),e}},De=typeof V.default.validateHeaderValue=="function"?V.default.validateHeaderValue:(r,e)=>{if(/[^\t\u0020-\u007E\u0080-\u00FF]/.test(e)){const t=new TypeError(`Invalid character in header content ["${r}"]`);throw Object.defineProperty(t,"code",{value:"ERR_INVALID_CHAR"}),t}};class N extends URLSearchParams{constructor(e){let t=[];if(e instanceof N){const i=e.raw();for(const[n,s]of Object.entries(i))t.push(...s.map(o=>[n,o]))}else if(e!=null)if(typeof e=="object"&&!M.types.isBoxedPrimitive(e)){const i=e[Symbol.iterator];if(i==null)t.push(...Object.entries(e));else{if(typeof i!="function")throw new TypeError("Header pairs must be iterable");t=[...e].map(n=>{if(typeof n!="object"||M.types.isBoxedPrimitive(n))throw new TypeError("Each header pair must be an iterable object");return[...n]}).map(n=>{if(n.length!==2)throw new TypeError("Each header pair must be a name/value tuple");return[...n]})}}else throw new TypeError("Failed to construct 'Headers': The provided value is not of type '(sequence<sequence<ByteString>> or record<ByteString, ByteString>)");t=t.length>0?t.map(([i,n])=>(le(i),De(i,String(n)),[String(i).toLowerCase(),String(n)])):void 0;super(t);return new Proxy(this,{get(i,n,s){switch(n){case"append":case"set":return(o,a)=>(le(o),De(o,String(a)),URLSearchParams.prototype[n].call(i,String(o).toLowerCase(),String(a)));case"delete":case"has":case"getAll":return o=>(le(o),URLSearchParams.prototype[n].call(i,String(o).toLowerCase()));case"keys":return()=>(i.sort(),new Set(URLSearchParams.prototype.keys.call(i)).keys());default:return Reflect.get(i,n,s)}}})}get[Symbol.toStringTag](){return this.constructor.name}toString(){return Object.prototype.toString.call(this)}get(e){const t=this.getAll(e);if(t.length===0)return null;let i=t.join(", ");return/^content-encoding$/i.test(e)&&(i=i.toLowerCase()),i}forEach(e,t=void 0){for(const i of this.keys())Reflect.apply(e,t,[this.get(i),i,this])}*values(){for(const e of this.keys())yield this.get(e)}*entries(){for(const e of this.keys())yield[e,this.get(e)]}[Symbol.iterator](){return this.entries()}raw(){return[...this.keys()].reduce((e,t)=>(e[t]=this.getAll(t),e),{})}[Symbol.for("nodejs.util.inspect.custom")](){return[...this.keys()].reduce((e,t)=>{const i=this.getAll(t);return t==="host"?e[t]=i[0]:e[t]=i.length>1?i:i[0],e},{})}}Object.defineProperties(N.prototype,["get","entries","forEach","values"].reduce((r,e)=>(r[e]={enumerable:!0},r),{}));function Mr(r=[]){return new N(r.reduce((e,t,i,n)=>(i%2===0&&e.push(n.slice(i,i+2)),e),[]).filter(([e,t])=>{try{return le(e),De(e,String(t)),!0}catch{return!1}}))}const Pr=new Set([301,302,303,307,308]),Gt=r=>Pr.has(r),v=Symbol("Response internals");class F extends K{constructor(e=null,t={}){super(e,t);const i=t.status!=null?t.status:200,n=new N(t.headers);if(e!==null&&!n.has("Content-Type")){const s=Ut(e,this);s&&n.append("Content-Type",s)}this[v]={type:"default",url:t.url,status:i,statusText:t.statusText||"",headers:n,counter:t.counter,highWaterMark:t.highWaterMark}}get type(){return this[v].type}get url(){return this[v].url||""}get status(){return this[v].status}get ok(){return this[v].status>=200&&this[v].status<300}get redirected(){return this[v].counter>0}get statusText(){return this[v].statusText}get headers(){return this[v].headers}get highWaterMark(){return this[v].highWaterMark}clone(){return new F(He(this,this.highWaterMark),{type:this.type,url:this.url,status:this.status,statusText:this.statusText,headers:this.headers,ok:this.ok,redirected:this.redirected,size:this.size,highWaterMark:this.highWaterMark})}static redirect(e,t=302){if(!Gt(t))throw new RangeError('Failed to execute "redirect" on "response": Invalid status code');return new F(null,{headers:{location:new URL(e).toString()},status:t})}static error(){const e=new F(null,{status:0,statusText:""});return e[v].type="error",e}get[Symbol.toStringTag](){return"Response"}}Object.defineProperties(F.prototype,{type:{enumerable:!0},url:{enumerable:!0},status:{enumerable:!0},ok:{enumerable:!0},redirected:{enumerable:!0},statusText:{enumerable:!0},headers:{enumerable:!0},clone:{enumerable:!0}});const Br=r=>{if(r.search)return r.search;const e=r.href.length-1,t=r.hash||(r.href[e]==="#"?"#":"");return r.href[e-t.length]==="?"?"?":""};function Ht(r,e=!1){return r==null||(r=new URL(r),/^(about|blob|data):$/.test(r.protocol))?"no-referrer":(r.username="",r.password="",r.hash="",e&&(r.pathname="",r.search=""),r)}const Dt=new Set(["","no-referrer","no-referrer-when-downgrade","same-origin","origin","strict-origin","origin-when-cross-origin","strict-origin-when-cross-origin","unsafe-url"]),Cr="strict-origin-when-cross-origin";function Nr(r){if(!Dt.has(r))throw new TypeError(`Invalid referrerPolicy: ${r}`);return r}function $r(r){if(/^(http|ws)s:$/.test(r.protocol))return!0;const e=r.host.replace(/(^\[)|(]$)/g,""),t=tr.isIP(e);return t===4&&/^127\./.test(e)||t===6&&/^(((0+:){7})|(::(0+:){0,6}))0*1$/.test(e)?!0:/^(.+\.)*localhost$/.test(r.host)?!1:r.protocol==="file:"}function G(r){return/^about:(blank|srcdoc)$/.test(r)||r.protocol==="data:"||/^(blob|filesystem):$/.test(r.protocol)?!0:$r(r)}function Wr(r,{referrerURLCallback:e,referrerOriginCallback:t}={}){if(r.referrer==="no-referrer"||r.referrerPolicy==="")return null;const i=r.referrerPolicy;if(r.referrer==="about:client")return"no-referrer";const n=r.referrer;let s=Ht(n),o=Ht(n,!0);s.toString().length>4096&&(s=o),e&&(s=e(s)),t&&(o=t(o));const a=new URL(r.url);switch(i){case"no-referrer":return"no-referrer";case"origin":return o;case"unsafe-url":return s;case"strict-origin":return G(s)&&!G(a)?"no-referrer":o.toString();case"strict-origin-when-cross-origin":return s.origin===a.origin?s:G(s)&&!G(a)?"no-referrer":o;case"same-origin":return s.origin===a.origin?s:"no-referrer";case"origin-when-cross-origin":return s.origin===a.origin?s:o;case"no-referrer-when-downgrade":return G(s)&&!G(a)?"no-referrer":s;default:throw new TypeError(`Invalid referrerPolicy: ${i}`)}}function kr(r){const e=(r.get("referrer-policy")||"").split(/[,\s]+/);let t="";for(const i of e)i&&Dt.has(i)&&(t=i);return t}const m=Symbol("Request internals"),ue=r=>typeof r=="object"&&typeof r[m]=="object",Ur=M.deprecate(()=>{},".data is not a valid RequestInit property, use .body instead","https://github.com/node-fetch/node-fetch/issues/1000 (request)");class Y extends K{constructor(e,t={}){let i;if(ue(e)?i=new URL(e.url):(i=new URL(e),e={}),i.username!==""||i.password!=="")throw new TypeError(`${i} is an url with embedded credentails.`);let n=t.method||e.method||"GET";if(n=n.toUpperCase(),"data"in t&&Ur(),(t.body!=null||ue(e)&&e.body!==null)&&(n==="GET"||n==="HEAD"))throw new TypeError("Request with GET/HEAD method cannot have body");const s=t.body?t.body:ue(e)&&e.body!==null?He(e):null;super(s,{size:t.size||e.size||0});const o=new N(t.headers||e.headers||{});if(s!==null&&!o.has("Content-Type")){const f=Ut(s,this);f&&o.set("Content-Type",f)}let a=ue(e)?e.signal:null;if("signal"in t&&(a=t.signal),a!=null&&!Ar(a))throw new TypeError("Expected signal to be an instanceof AbortSignal or EventTarget");let l=t.referrer==null?e.referrer:t.referrer;if(l==="")l="no-referrer";else if(l){const f=new URL(l);l=/^about:(\/\/)?client$/.test(f)?"client":f}else l=void 0;this[m]={method:n,redirect:t.redirect||e.redirect||"follow",headers:o,parsedURL:i,signal:a,referrer:l},this.follow=t.follow===void 0?e.follow===void 0?20:e.follow:t.follow,this.compress=t.compress===void 0?e.compress===void 0?!0:e.compress:t.compress,this.counter=t.counter||e.counter||0,this.agent=t.agent||e.agent,this.highWaterMark=t.highWaterMark||e.highWaterMark||16384,this.insecureHTTPParser=t.insecureHTTPParser||e.insecureHTTPParser||!1,this.referrerPolicy=t.referrerPolicy||e.referrerPolicy||""}get method(){return this[m].method}get url(){return er.format(this[m].parsedURL)}get headers(){return this[m].headers}get redirect(){return this[m].redirect}get signal(){return this[m].signal}get referrer(){if(this[m].referrer==="no-referrer")return"";if(this[m].referrer==="client")return"about:client";if(this[m].referrer)return this[m].referrer.toString()}get referrerPolicy(){return this[m].referrerPolicy}set referrerPolicy(e){this[m].referrerPolicy=Nr(e)}clone(){return new Y(this)}get[Symbol.toStringTag](){return"Request"}}Object.defineProperties(Y.prototype,{method:{enumerable:!0},url:{enumerable:!0},headers:{enumerable:!0},redirect:{enumerable:!0},clone:{enumerable:!0},signal:{enumerable:!0},referrer:{enumerable:!0},referrerPolicy:{enumerable:!0}});const Gr=r=>{const{parsedURL:e}=r[m],t=new N(r[m].headers);t.has("Accept")||t.set("Accept","*/*");let i=null;if(r.body===null&&/^(post|put)$/i.test(r.method)&&(i="0"),r.body!==null){const a=zr(r);typeof a=="number"&&!Number.isNaN(a)&&(i=String(a))}i&&t.set("Content-Length",i),r.referrerPolicy===""&&(r.referrerPolicy=Cr),r.referrer&&r.referrer!=="no-referrer"?r[m].referrer=Wr(r):r[m].referrer="no-referrer",r[m].referrer instanceof URL&&t.set("Referer",r.referrer),t.has("User-Agent")||t.set("User-Agent","node-fetch"),r.compress&&!t.has("Accept-Encoding")&&t.set("Accept-Encoding","gzip,deflate,br");let{agent:n}=r;typeof n=="function"&&(n=n(e)),!t.has("Connection")&&!n&&t.set("Connection","close");const s=Br(e),o={path:e.pathname+s,method:r.method,headers:t[Symbol.for("nodejs.util.inspect.custom")](),insecureHTTPParser:r.insecureHTTPParser,agent:n};return{parsedURL:e,options:o}};class Hr extends se{constructor(e,t="aborted"){super(e,t)}}const Dr=new Set(["data:","http:","https:"]);async function Vt(r,e){return new Promise((t,i)=>{const n=new Y(r,e),{parsedURL:s,options:o}=Gr(n);if(!Dr.has(s.protocol))throw new TypeError(`node-fetch cannot load ${r}. URL scheme "${s.protocol.replace(/:$/,"")}" is not supported.`);if(s.protocol==="data:"){const u=Ir(n.url),T=new F(u,{headers:{"Content-Type":u.typeFull}});t(T);return}const a=(s.protocol==="https:"?rr.default:V.default).request,{signal:l}=n;let f=null;const h=()=>{const u=new Hr("The operation was aborted.");i(u),n.body&&n.body instanceof L.default.Readable&&n.body.destroy(u),!(!f||!f.body)&&f.body.emit("error",u)};if(l&&l.aborted){h();return}const _=()=>{h(),c()},p=a(s.toString(),o);l&&l.addEventListener("abort",_);const c=()=>{p.abort(),l&&l.removeEventListener("abort",_)};p.on("error",u=>{i(new O(`request to ${n.url} failed, reason: ${u.message}`,"system",u)),c()}),Vr(p,u=>{f.body.destroy(u)}),process.version<"v14"&&p.on("socket",u=>{let T;u.prependListener("end",()=>{T=u._eventsCount}),u.prependListener("close",y=>{if(f&&T<u._eventsCount&&!y){const z=new Error("Premature close");z.code="ERR_STREAM_PREMATURE_CLOSE",f.body.emit("error",z)}})}),p.on("response",u=>{p.setTimeout(0);const T=Mr(u.rawHeaders);if(Gt(u.statusCode)){const I=T.get("Location");let R=null;try{R=I===null?null:new URL(I,n.url)}catch{if(n.redirect!=="manual"){i(new O(`uri requested responds with an invalid redirect URL: ${I}`,"invalid-redirect")),c();return}}switch(n.redirect){case"error":i(new O(`uri requested responds with a redirect, redirect mode is set to error: ${n.url}`,"no-redirect")),c();return;case"manual":break;case"follow":{if(R===null)break;if(n.counter>=n.follow){i(new O(`maximum redirect reached at: ${n.url}`,"max-redirect")),c();return}const x={headers:new N(n.headers),follow:n.follow,counter:n.counter+1,agent:n.agent,compress:n.compress,method:n.method,body:He(n),signal:n.signal,size:n.size,referrer:n.referrer,referrerPolicy:n.referrerPolicy};if(!Lr(n.url,R))for(const Kt of["authorization","www-authenticate","cookie","cookie2"])x.headers.delete(Kt);if(u.statusCode!==303&&n.body&&e.body instanceof L.default.Readable){i(new O("Cannot follow redirect with body being a readable stream","unsupported-redirect")),c();return}(u.statusCode===303||(u.statusCode===301||u.statusCode===302)&&n.method==="POST")&&(x.method="GET",x.body=void 0,x.headers.delete("content-length"));const Ve=kr(T);Ve&&(x.referrerPolicy=Ve),t(Vt(new Y(R,x))),c();return}default:return i(new TypeError(`Redirect option '${n.redirect}' is not a valid value of RequestRedirect`))}}l&&u.once("end",()=>{l.removeEventListener("abort",_)});let y=b.pipeline(u,new b.PassThrough,I=>{I&&i(I)});process.version<"v12.10"&&u.on("aborted",_);const z={url:n.url,status:u.statusCode,statusText:u.statusMessage,headers:T,size:n.size,counter:n.counter,highWaterMark:n.highWaterMark},k=T.get("Content-Encoding");if(!n.compress||n.method==="HEAD"||k===null||u.statusCode===204||u.statusCode===304){f=new F(y,z),t(f);return}const Zt={flush:U.default.Z_SYNC_FLUSH,finishFlush:U.default.Z_SYNC_FLUSH};if(k==="gzip"||k==="x-gzip"){y=b.pipeline(y,U.default.createGunzip(Zt),I=>{I&&i(I)}),f=new F(y,z),t(f);return}if(k==="deflate"||k==="x-deflate"){const I=b.pipeline(u,new b.PassThrough,R=>{R&&i(R)});I.once("data",R=>{(R[0]&15)===8?y=b.pipeline(y,U.default.createInflate(),x=>{x&&i(x)}):y=b.pipeline(y,U.default.createInflateRaw(),x=>{x&&i(x)}),f=new F(y,z),t(f)}),I.once("end",()=>{f||(f=new F(y,z),t(f))});return}if(k==="br"){y=b.pipeline(y,U.default.createBrotliDecompress(),I=>{I&&i(I)}),f=new F(y,z),t(f);return}f=new F(y,z),t(f)}),Rr(p,n).catch(i)})}function Vr(r,e){const t=w.Buffer.from(`0\r
\r
`);let i=!1,n=!1,s;r.on("response",o=>{const{headers:a}=o;i=a["transfer-encoding"]==="chunked"&&!a["content-length"]}),r.on("socket",o=>{const a=()=>{if(i&&!n){const l=new Error("Premature close");l.code="ERR_STREAM_PREMATURE_CLOSE",e(l)}};o.prependListener("close",a),r.on("abort",()=>{o.removeListener("close",a)}),o.on("data",l=>{n=w.Buffer.compare(l.slice(-5),t)===0,!n&&s&&(n=w.Buffer.compare(s.slice(-3),t.slice(0,3))===0&&w.Buffer.compare(l.slice(-2),t.slice(3))===0),s=l})})}class jt extends Pt{async fetch(e,t){return Vt(e,t)}}const jr=new jt;exports.File=Nt,exports.FormData=ne,exports.IIIF_1_IMAGE_LEVEL_0=Ye,exports.IIIF_1_IMAGE_LEVEL_0_PROFILE=Xe,exports.IIIF_1_IMAGE_LEVEL_1=_e,exports.IIIF_1_IMAGE_LEVEL_1_PROFILE=Se,exports.IIIF_1_IMAGE_LEVEL_2=xe,exports.IIIF_1_IMAGE_LEVEL_2_PROFILE=Ee,exports.IIIF_2_IMAGE_LEVEL_0=qe,exports.IIIF_2_IMAGE_LEVEL_0_NO_JSON=rt,exports.IIIF_2_IMAGE_LEVEL_0_PROFILE=et,exports.IIIF_2_IMAGE_LEVEL_1=Fe,exports.IIIF_2_IMAGE_LEVEL_1_NO_JSON=Te,exports.IIIF_2_IMAGE_LEVEL_1_PROFILE=be,exports.IIIF_2_IMAGE_LEVEL_2=ve,exports.IIIF_2_IMAGE_LEVEL_2_NO_JSON=ze,exports.IIIF_2_IMAGE_LEVEL_2_PROFILE=Ae,exports.IIIF_3_IMAGE_LEVEL_0=tt,exports.IIIF_3_IMAGE_LEVEL_1=Le,exports.IIIF_3_IMAGE_LEVEL_2=Oe,exports.ImageServiceLoader=jt,exports.STANFORD_IIIF_1_IMAGE_COMPLIANCE_0=Ze,exports.STANFORD_IIIF_1_IMAGE_COMPLIANCE_1=me,exports.STANFORD_IIIF_1_IMAGE_COMPLIANCE_2=ye,exports.STANFORD_IIIF_1_IMAGE_CONFORMANCE_0=Ke,exports.STANFORD_IIIF_1_IMAGE_CONFORMANCE_1=we,exports.STANFORD_IIIF_1_IMAGE_CONFORMANCE_2=Ie,exports.STANFORD_IIIF_IMAGE_COMPLIANCE_0=Qe,exports.STANFORD_IIIF_IMAGE_COMPLIANCE_1=he,exports.STANFORD_IIIF_IMAGE_COMPLIANCE_2=de,exports.STANFORD_IIIF_IMAGE_CONFORMANCE_0=Je,exports.STANFORD_IIIF_IMAGE_CONFORMANCE_1=pe,exports.STANFORD_IIIF_IMAGE_CONFORMANCE_2=ge,exports.canonicalServiceUrl=C,exports.combineProfiles=Ce,exports.createImageServiceRequest=ht,exports.extraFeatures=Be,exports.extractFixedSizeScales=dt,exports.fixedSizesFromScales=pt,exports.getCustomSizeFromService=mt,exports.getFixedSizeFromImage=wt,exports.getFixedSizesFromService=It,exports.getId=d,exports.getImageCandidates=_t,exports.getImageCandidatesFromService=$e,exports.getImageFromTileSource=re,exports.getImageServerFromId=$,exports.getImageServices=We,exports.getSmallestScaleFactorAsSingleImage=lr,exports.getType=yt,exports.imageServiceLoader=jr,exports.imageServiceProfiles=Pe,exports.imageServiceRequestToString=vt,exports.imageServiceSupportsFormat=ur,exports.imageServiceSupportsRequest=cr,exports.inferSizeFromUrl=Ne,exports.isBestMatch=At,exports.isImageService=j,exports.level0=it,exports.level0Support=ir,exports.level1=nt,exports.level1Support=Me,exports.level2=st,exports.level2Support=Re,exports.levelToProfile=ot,exports.parseImageServiceRequest=ct,exports.parseImageServiceUrl=ut,exports.parseRegionParameter=at,exports.parseRotationParameter=lt,exports.parseSizeParameter=ft,exports.pickBestFromCandidates=Lt,exports.regionParameterToString=St,exports.rotationParameterToString=Et,exports.sampledTilesToTiles=zt,exports.sizeParameterToString=xt,exports.sizesMatch=Rt,exports.supports=ke,exports.supportsCustomSizes=gt;
