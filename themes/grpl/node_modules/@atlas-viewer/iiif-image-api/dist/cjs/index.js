"use strict";Object.defineProperty(exports,"__esModule",{value:!0});function m(i){return i.endsWith("info.json")?i:i.endsWith("/")?`${i}info.json`:`${i}/info.json`}const te="http://library.stanford.edu/iiif/image-api/compliance.html#level0",A="http://library.stanford.edu/iiif/image-api/compliance.html#level1",O="http://library.stanford.edu/iiif/image-api/compliance.html#level2",re="http://library.stanford.edu/iiif/image-api/conformance.html#level0",L="http://library.stanford.edu/iiif/image-api/conformance.html#level1",z="http://library.stanford.edu/iiif/image-api/conformance.html#level2",ne="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0",M="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1",C="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2",se="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0",N="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1",b="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2",ae="http://iiif.io/api/image/1/level0.json",oe="http://iiif.io/api/image/1/profiles/level0.json",R="http://iiif.io/api/image/1/level1.json",P="http://iiif.io/api/image/1/profiles/level1.json",W="http://iiif.io/api/image/1/level2.json",G="http://iiif.io/api/image/1/profiles/level2.json",le="http://iiif.io/api/image/2/level0.json",fe="http://iiif.io/api/image/2/profiles/level0.json",j="http://iiif.io/api/image/2/level1.json",$="http://iiif.io/api/image/2/profiles/level1.json",T="http://iiif.io/api/image/2/level2.json",B="http://iiif.io/api/image/2/profiles/level2.json",he="level0",V="level1",H="level2",ue="http://iiif.io/api/image/2/level0",k="http://iiif.io/api/image/2/level1",D="http://iiif.io/api/image/2/level2",Q=[D,O,z,C,b,W,G,T,B,H],U=[...Q,k,A,L,M,N,R,P,j,$,V],J=[ue,k,D,te,A,O,re,L,z,ne,M,C,se,N,b,ae,oe,R,P,W,G,le,fe,j,$,T,B,he,V,H],ke=J,ce={extraFormats:["jpg"],extraQualities:["default"],extraFeatures:["sizeByWhListed"]},de={extraFormats:["jpg"],extraQualities:["default"],extraFeatures:["baseUriRedirect","cors","jsonldMediaType","regionByPx","regionSquare","sizeByWhListed","sizeByH","sizeByW","sizeByWh"]},ge={extraFormats:["jpg","png"],extraQualities:["default"],extraFeatures:["baseUriRedirect","cors","jsonldMediaType","regionByPct","regionByPx","regionSquare","rotationBy90s","sizeByWhListed","sizeByConfinedWh","sizeByH","sizeByPct","sizeByW","sizeByWh"]},Z=["baseUriRedirect","canonicalLinkHeader","cors","jsonldMediaType","mirroring","profileLinkHeader","regionByPct","regionByPx","regionSquare","rotationArbitrary","rotationBy90s","sizeByConfinedWh","sizeByH","sizeByPct","sizeByW","sizeByWh","sizeUpscaling","sizeByWhListed","sizeByDistortedWh","sizeByForcedWh"];function me(i){return Q.indexOf(i)!==-1?ge:U.indexOf(i)!==-1?de:ce}function K(i){const e=i?Array.isArray(i.profile)?i.profile:[i.profile]:[],t={extraQualities:[],extraFormats:[],extraFeatures:[]};for(let r of e)if(typeof r=="string"&&(r=me(r)),!!r){if(r.formats)for(const n of r.formats)t.extraFormats.indexOf(n)===-1&&t.extraFormats.push(n);if(r.qualities)for(const n of r.qualities)t.extraQualities.indexOf(n)===-1&&t.extraQualities.push(n);if(r.supports)for(const n of r.supports)t.extraFeatures.indexOf(n)===-1&&t.extraFeatures.push(n);if(r.maxHeight&&(t.maxHeight=r.maxHeight),r.maxWidth&&(t.maxWidth=r.maxWidth),r.maxArea&&(t.maxArea=r.maxArea),r.extraFormats)for(const n of r.extraFormats)t.extraFormats.indexOf(n)===-1&&t.extraFormats.push(n);if(r.extraQualities)for(const n of r.extraQualities)t.extraQualities.indexOf(n)===-1&&t.extraQualities.push(n);if(r.extraFeatures)for(const n of r.extraFeatures)t.extraFeatures.indexOf(n)===-1&&t.extraFeatures.push(n);r.maxHeight&&(t.maxHeight=r.maxHeight),r.maxWidth&&(t.maxWidth=r.maxWidth),r.maxArea&&(t.maxArea=r.maxArea)}if(i.extraFormats)for(const r of i.extraFormats)t.extraFormats.indexOf(r)===-1&&t.extraFormats.push(r);if(i.extraFeatures)for(const r of i.extraFeatures)t.extraFeatures.indexOf(r)===-1&&t.extraFeatures.push(r);if(i.extraQualities)for(const r of i.extraQualities)t.extraQualities.indexOf(r)===-1&&t.extraQualities.push(r);return t}function pe(i){try{if(i==="full")return{full:!0};if(i==="square")return{square:!0};const e=i.startsWith("pct:"),r=i.substr(e?4:0).split(",").map(n=>parseFloat(n));return{x:r[0],y:r[1],w:r[2],h:r[3],percent:e}}catch{throw new Error("Expected 'full', 'square' or 'x,y,w,h'. Found "+i)}}function Ie(i){const e={upscaled:!1,max:!1,confined:!1};if(i[0]==="^"&&(e.upscaled=!0,i=i.slice(1)),i==="max"||i==="full")return e.max=!0,e.serialiseAsFull=i==="full",e;if(i[0]==="!"&&(e.confined=!0,i=i.slice(1)),i[0]==="p")return e.percentScale=parseFloat(i.slice(4)),e;const t=i.split(",").map(r=>r.trim());return t.length&&(t[0]!==""&&(e.width=parseInt(t[0],10)),t[1]!==""?(e.height=parseInt(t[1],10),e.version=2):e.version=3),e}function _e(i){const e={angle:0};if(i[0]==="!"&&(e.mirror=!0,i=i.substr(1)),e.angle=parseFloat(i)%360,Number.isNaN(e.angle))throw new Error(`Invalid rotation ${i}`);return e}function xe(i,e=""){const t=i.match(/^(([a-zA-Z]+):\/\/([^/]+))?((.*)+)/);if(!t)throw new Error(`Invalid or unknown input ${i}`);const r=t[2],n=t[3];let s=t[4];if(s[0]==="/"&&(s=s.substr(1)),e.length>0){if(e[0]==="/"&&(e=e.substr(1)),e!==s.substr(0,e.length))throw new Error(`Path does not start with prefix (path: ${s}, prefix: ${e})`);s=s.substr(e.length)}return{scheme:r,server:n,path:s,prefix:e}}function Fe(i,e=""){const{path:t,scheme:r,server:n,prefix:s}=xe(i,e),a=t.split("/").reverse(),[o,l,u,f,...d]=a,g=d.reverse().filter(Boolean).join("/");if(a.length===1||o==="")return{type:"base",scheme:r,server:n,prefix:s,identifier:g};if(o==="info.json"){const[,...c]=a;return{type:"info",scheme:r,server:n,prefix:s,identifier:c.reverse().filter(Boolean).join("/")}}const p=o.split(".");return{type:"image",scheme:r,server:n,prefix:s,identifier:g,originalPath:t,region:pe(f),size:Ie(u),rotation:_e(l),quality:p[0],format:p[1]}}function Se(i){const e=Fe(m(i.id));if(e.type!=="info")throw new Error("Invalid service URL");const t=K(i);return{identifier:e.identifier,originalPath:"",server:e.server,prefix:e.prefix,scheme:e.scheme,type:"image",quality:t.extraQualities.indexOf("default")===-1?t.extraQualities[0]:"default",region:{full:!0},size:{max:!0,upscaled:!1,confined:!1},format:"jpg",rotation:{angle:0}}}function Ee(i,e,t){const r=t.length,n=[];for(let s=0;s<r;s++){const o=t[s].width;n.push(i/o)}return n}function ye(i,e,t){const r=t.length,n=[];for(let s=0;s<r;s++){const a=t[s];n.push({width:Math.floor(i/a),height:Math.floor(e/a)})}return n}function h(i){if(i["@id"])return i["@id"];if(i.id)return i.id}function S(i){if(!i||!i.profile||!h(i))return!1;const e=Array.isArray(i.profile)?i.profile:[i.profile];for(const t of e)if(typeof t=="string"&&J.indexOf(t)!==-1)return!0;return!1}function ve(i){if(!S(i))return!1;const e=Array.isArray(i.profile)?i.profile:[i.profile];for(const t of e)if(typeof t=="string"){if(U.indexOf(t)!==-1)return!0}else{const r=[...t.supports||[],...t.extraFeatures||[]];if(r.indexOf("regionByPx")!==-1&&(r.indexOf("sizeByW")!==-1||r.indexOf("sizeByWh")!==-1))return!0}return!1}function y(i,e){if(e&&e.profile){const t=e.profile;if(t){const r=Array.isArray(t)?t:[t];return r.includes(`level${i}`)||r.includes(`http://iiif.io/api/image/2/level${i}.json`)||r.includes(`http://iiif.io/api/image/1/level${i}.json`)||r.includes(`http://iiif.io/api/image/1/profiles/level${i}.json`)}}return!1}function v(i){return S(i)?y(0,i)?0:y(1,i)?1:y(2,i)?2:null:null}function X(i){return(i["@context"]?Array.isArray(i["@context"])?i["@context"]:[i["@context"]]:[]).indexOf("http://iiif.io/api/image/3/context.json")!==-1}function we(i){if(!ve(i))return[];const e=[],t=Array.isArray(i.profile)?i.profile:[i.profile],r=t.length;for(let n=0;n<r;n++){const s=t[n];if(typeof s!="string"&&(s.maxHeight||s.maxWidth))return[{id:h(i),type:"variable",minWidth:0,minHeight:0,maxHeight:s.maxHeight||s.maxWidth,maxWidth:s.maxWidth||s.maxHeight,level:v(i),version:i["@context"]==="http://iiif.io/api/image/3/context.json"?3:2}]}if(i.tiles){const n=i.tiles.length;for(let s=0;s<n;s++){const a=i.tiles[s];(a.height||a.width)&&e.push({id:h(i),type:"variable",minHeight:0,minWidth:0,maxHeight:a.height||a.width,maxWidth:a.width,level:v(i),version:X(i)?3:2})}}return e}function Y(i){const e=/^.*\/(full)\/(((\d+),(\d+)?)|max)\/(\d+)\/default\.(jpg|png|jpeg)$/,t=i.match(e);if(t){const r=t[1],n=parseInt(t[4],10),s=parseInt(t[5],10),a=t[7];if((r==="max"||r==="full")&&n&&s&&a)return{type:"fixed",id:i,height:s,width:n}}return{type:"unknown",id:i}}function Ae(i){if(i["@type"])return i["@type"];if(i.type)return i.type}function Oe(i){if(typeof i=="string")return Y(i);const e=Ae(i);if(e!=="Image"&&e!=="sc:Image")return null;const t=i,r=h(t);return r?r&&t.width&&t.height?{id:r,type:"fixed",width:t.width,height:t.height,unsafe:!0}:Y(r):null}function Le(i){return S(i)?(i&&i.sizes?i.sizes:[]).map(e=>({id:h(i),type:"fixed-service",height:e.height,width:e.width,level:v(i),version:X(i)?3:2})):[]}function q(i){const e=[],t=i.length;for(let r=0;r<t;r++){const n=Le(i[r]);n.length&&e.push(...n);const s=we(i[r]);s.length&&e.push(...s)}return e}function ee(i){const e=i.service?Array.isArray(i.service)?i.service:[i.service]:[],t=e.length,r=[];for(let n=0;n<t;n++)S(e[n])&&r.push(e[n]);return r}function ze(i,e=!0,t){const r=[],n=Oe(i);if(n===null)return r;const s=i;if(r.push(n),e&&s.width&&s.height){const a=[],o=ee(s);for(const l of o){const u={id:h(l),width:s.width,height:s.height};if(t.canLoadSync(u)){const f=t.loadServiceSync(u);f&&(f.height||(f.height=s.height),f.width||(f.width=s.width),a.push(...q([f])))}}if(a.length)return r.push(...a),r}return s.service&&r.push(...q(s.service)),r}function Me({x:i=0,y:e=0,w:t,h:r,full:n,square:s,percent:a}){if(n)return"full";if(s)return"square";if(typeof t>"u"||typeof r>"u")throw new Error("RegionParameter: invalid region");const o=`${i},${e},${t},${r}`;return a?`pct:${o}`:o}function Ce({max:i,percentScale:e,upscaled:t,confined:r,width:n,height:s,serialiseAsFull:a,version:o}){const l=[];return t&&l.push("^"),i?(l.push(a?"full":"max"),l.join("")):(r&&l.push("!"),e&&l.push(`pct:${e}`),n&&l.push(`${n}`),l.push(","),s&&o===3&&l.push(`${s}`),l.join(""))}function Ne(i){return`${i.mirror?"!":""}${(i.angle||0)%360}`}var De=Object.defineProperty,Qe=Object.defineProperties,Ue=Object.getOwnPropertyDescriptors,be=Object.getOwnPropertySymbols,Je=Object.prototype.hasOwnProperty,Ze=Object.prototype.propertyIsEnumerable,Re=(i,e,t)=>e in i?De(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,I=(i,e)=>{for(var t in e||(e={}))Je.call(e,t)&&Re(i,t,e[t]);if(be)for(var t of be(e))Ze.call(e,t)&&Re(i,t,e[t]);return i},_=(i,e)=>Qe(i,Ue(e));function Pe(i,e){const t=i.prefix.startsWith("/")?i.prefix.substr(1):i.prefix,r=`${i.scheme}://${i.server}/${t?`${t}/`:""}${i.identifier}`;if(i.type==="base")return r;if(i.type==="info")return`${r}/info.json`;let{size:n}=i;const{region:s,rotation:a,format:o,quality:l}=i;if(e){const u=e["@context"]?Array.isArray(e["@context"])?e["@context"]:[e["@context"]]:[],f=u.indexOf("http://iiif.io/api/image/2/context.json")!==-1,d=u.indexOf("http://iiif.io/api/image/3/context.json")!==-1;if((n.width===e.width&&!n.height||n.height===e.height&&!n.width||n.width===e.width&&n.height===e.height)&&(n=_(I({},n),{max:!0})),f&&(n.max&&!n.serialiseAsFull&&(n=_(I({},n),{serialiseAsFull:!0})),!n.max&&n.width&&n.height&&(n=_(I({},n),{height:void 0})),n=_(I({},n),{version:2})),d){if(n.max&&n.serialiseAsFull&&(n=_(I({},n),{serialiseAsFull:!1})),n.width&&!n.height&&e.width&&e.height){const g=e.height/e.width;n=_(I({},n),{height:Math.ceil(n.width*g)})}n=_(I({},n),{version:3})}}return[r,Me(s),Ce(n),Ne(a),`${l}.${o}`].filter(Boolean).join("/")}function w(i,e,t){const r=Se({"@context":i.version===3?"http://iiif.io/api/image/3/context.json":"http://iiif.io/api/image/2/context.json",id:m(h(i)),profile:i.level===null||typeof i.level>"u"?"level0":`level${i.level}}`,type:i.version===3?"ImageService3":"ImageService2"});if(r.type!=="image")throw new Error("Invalid service");return r.size.max=!1,r.size.width=e,r.size.height=t,{id:Pe(r),type:"fixed",width:e,height:t||i.height/(i.width||1)*e,unsafe:i.width>e}}function x(i){const e=i.replace(/(https?:\/\/)?(www.)?/i,"");return e.indexOf("/")!==-1?e.split("/")[0]:e}function Ke(i){if(!i.width||!i.height)return null;if(i.tiles){const e=i.tiles.sort((r,n)=>Math.max(...n.scaleFactors)-Math.max(...r.scaleFactors)),t=e.length;for(let r=0;r<t;r++){const n=e[r],s=n.width;if(!s)continue;const a=n.scaleFactors.length,o=n.scaleFactors.sort();for(let l=0;l<a;l++){const u=o[l];if(i.width/u<=s&&i.height/u<=s)return{id:h(i),type:"fixed-service",width:i.width/u|0,height:i.height/u|0,level:v(i),version:X(i)?3:2}}}}return null}function ie(i,e){if(!S(i))return[!1,"Not a valid image service"];e.extraFeatures=e.extraFeatures?e.extraFeatures:[];const t=K(i);if(e.exactSize){let r=!1;if(i.sizes)for(const n of i.sizes)n.width&&n.width===e.exactSize.width&&(Z.indexOf("sizeByW")!==-1||n.height&&n.height===e.exactSize.height)&&(r=!0),n.height&&n.height===e.exactSize.height&&(Z.indexOf("sizeByH")!==-1||n.width&&n.width===e.exactSize.width)&&(r=!0);r||(e.maxWidth=Math.max(e.maxWidth||0,e.exactSize.width||0)||void 0,e.maxHeight=Math.max(e.maxHeight||0,e.exactSize.height||0)||void 0,e.maxArea=Math.max(e.maxArea||0,(e.exactSize.width&&e.exactSize.height?e.exactSize.width*e.exactSize.height:e.maxArea)||0)||void 0,!e.exactSize.height&&e.exactSize.width?e.extraFeatures.indexOf("sizeByW")===-1&&e.extraFeatures.push("sizeByW"):!e.exactSize.width&&e.exactSize.height&&e.extraFeatures.indexOf("sizeByH")===-1&&e.extraFeatures.push("sizeByH"))}if(e.maxArea&&t.maxArea&&e.maxArea>t.maxArea)return[!1,`Max area is ${t.maxArea}`];if(e.maxWidth&&t.maxWidth&&e.maxWidth>t.maxWidth)return[!1,`Max width is ${t.maxWidth}`];if(e.maxHeight&&t.maxHeight&&e.maxHeight>t.maxHeight)return[!1,`Max height is ${t.maxHeight}`];if(e.extraFeatures){const r=[];for(const n of e.extraFeatures)t.extraFeatures.indexOf(n)===-1&&r.push(n);if(r.length)return[!1,`Missing features: ${r.join(", ")}`]}if(e.extraFormats){const r=[];for(const n of e.extraFormats)t.extraFormats.indexOf(n)===-1&&r.push(n);if(r.length)return[!1,`Missing formats: ${r.join(", ")}`]}if(e.extraQualities){const r=[];for(const n of e.extraQualities)t.extraQualities.indexOf(n)===-1&&r.push(n);if(r.length)return[!1,`Missing qualities: ${r.join(", ")}`]}return[!0]}function Xe(i,e){return ie(i,{extraFormats:[e]})}function Ye(i,e){if(e.type!=="image")return[!0];const t=[];e.rotation.mirror&&t.push("mirroring"),e.region.percent&&t.push("regionByPct"),e.region.square?t.push("regionSquare"):e.region.full||t.push("regionByPx"),e.rotation.angle&&(e.rotation.angle%90?t.push("rotationArbitrary"):t.push("rotationBy90s")),e.size.confined&&t.push("sizeByConfinedWh"),!e.size.width&&e.size.height&&t.push("sizeByH"),e.size.percentScale&&t.push("sizeByPct"),(i.sizes||[]).find(a=>a.width===e.size.width&&!e.size.height||a.height===e.size.height&&!e.size.width||a.height===e.size.height&&a.width===e.size.width)?t.push("sizeByWhListed"):(e.size.width&&!e.size.height&&t.push("sizeByW"),e.size.width&&e.size.height&&t.push("sizeByWh")),e.size.upscaled&&t.push("sizeUpscaling");const[n,s]=ie(i,{extraFeatures:t,extraQualities:[e.quality],extraFormats:[e.format],exactSize:e.size});return n?[!0]:[!1,s]}function We(i,e,t){const r=i.width?i.width:i.maxWidth;return t.height<=i.maxHeight&&t.width<=i.maxWidth&&t.height>=i.minHeight&&t.width>=i.minWidth&&(!e||Math.abs(t.width-r)<Math.abs(e.width-r))}function Ge(i,e){const t=[],r=Object.assign({unsafeImageService:!1,atAnyCost:!0,fallback:!0,minHeight:64,minWidth:64,maxHeight:1/0,maxWidth:1/0,returnAllOptions:!1,preferFixedSize:!1,allowUnsafe:!1,explain:!1,height:0,width:0},i),n=(f,d=0)=>r.explain?t.push(new Array(d).fill(0).map(g=>"    ").join("")+f().trim()):void 0,s=[],a=[];let o=null;n(()=>`Using configuration: ${JSON.stringify(r,null,2)}`);const l=(f,d)=>{if(n(()=>"Swapping choice",3),We(r,d,f)){if(r.preferFixedSize&&f.unsafe){n(()=>`We found an image that was marked as unsafe, but it was the best size. (${f.id})`,4),a.push(f);return}r.returnAllOptions&&d&&a.push(d),n(()=>`We found a new image that was the best size. (${f.id})`,4),o=f}else r.returnAllOptions&&a.push(f)};n(()=>`The input shows we have ${e.length} list(s) of candidates to choose from.`);const u=e.length;for(let f=0;f<u;f++){const d=e[f]();n(()=>`Candidate group ${f}: ${JSON.stringify(d,null,2)}`,1);const g=d.length;n(()=>`Checking candidate list number ${f} and found ${g} potential ways of creating image(s)`,1);for(let p=0;p<g;p++){const c=d[p];if(n(()=>`-> Checking candidate ${p}`,1),c.type==="unknown"&&r.atAnyCost&&(n(()=>`We've found an unknown image type, adding this to the "last resort" list`,2),s.push(c)),c.type==="fixed"&&(c.unsafe?(n(()=>`We've found an unsafe fixed image type, adding this to the "last resort" list`,2),s.push(c)):(n(()=>"We've found a fixed size image, checking if it matches the request",2),l(c,o))),c.type==="fixed-service")if(r.unsafeImageService){n(()=>"Checking for an image from the tile source, without calculating the right height and width (unsafeImageService)",2);const E=w(c,r.width,r.height);l(E,o)}else{n(()=>"Checking for an image from the tile source 3",2);const E=w(c,c.width,c.height);l(E,o)}if(c.type==="variable"&&c.maxWidth){const E=w({id:c.id,type:"fixed-service",width:c.maxWidth,height:c.maxWidth,level:c.level,version:c.version},c.maxWidth);l(E,o)}}if(o&&!r.returnAllOptions){if(o.unsafe||r.allowUnsafe)continue;n(()=>`We found a match in choice list number ${f}, no searching any more`);break}}return r.atAnyCost&&a.length===0?(n(()=>o?`We found an image! ${o.id} of type ${o.type}`:'We found no images, but "atAnyCost" is set, so returning that'),{best:o||s[0],fallback:s.slice(1),log:t}):r.returnAllOptions?(n(()=>"Returning all options that we have found"),{best:r.atAnyCost?o||a[0]||s[0]:o||a[0],fallback:[...a,...s],log:t}):(n(()=>"Returning the best image that we found, and a fallback"),{best:o||a[0]||null,fallback:o?a:a.slice(1),log:t})}var qe=Object.defineProperty,ei=Object.defineProperties,ii=Object.getOwnPropertyDescriptors,je=Object.getOwnPropertySymbols,ti=Object.prototype.hasOwnProperty,ri=Object.prototype.propertyIsEnumerable,$e=(i,e,t)=>e in i?qe(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,ni=(i,e)=>{for(var t in e||(e={}))ti.call(e,t)&&$e(i,t,e[t]);if(je)for(var t of je(e))ri.call(e,t)&&$e(i,t,e[t]);return i},si=(i,e)=>ei(i,ii(e));function Te(i,e,t){const r=i>e?i:e,n=t.length,s=[];for(let a=0;a<n;a++){const o=t[a];let l=o.scaleFactors[0],u=r/l;const f=[l];for(;u>=o.width;)l=l*2,f.push(l),u=u/2;s.push(si(ni({},o),{scaleFactors:f}))}return s}function Be(i,e){if(i.length!==e.length)return!1;if(i.length===0&&e.length===0)return!0;const t=i.length;let r=!0;for(let s=0;s<t;s++){const a=i[s],o=e[s];if(a.width!==o.width||a.height!==o.height){r=!1;break}}if(r)return!0;let n=0;for(let s=0;s<t;s++)for(let a=0;a<t;a++)if(i[s].width===e[a].width&&i[s].height===e[a].height){n++;break}return n===t}function Ve(i){return y(0,i)}var F=(i,e,t)=>new Promise((r,n)=>{var s=l=>{try{o(t.next(l))}catch(u){n(u)}},a=l=>{try{o(t.throw(l))}catch(u){n(u)}},o=l=>l.done?r(l.value):Promise.resolve(l.value).then(s,a);o((t=t.apply(i,e)).next())});class He{constructor(){this.config={verificationsRequired:1,approximateServices:!0,enableFetching:!0,disableThrottling:!1},this.fetchingCount=0,this.imageServices={},this.knownImageServers={}}setConfig(e){Object.assign(this.config,e)}sample(e,t,r=!0){const n=x(h(e)),s=m(h(e)),a=this.knownImageServers[n];return this.imageServices[s]=Object.assign(e,{real:!0}),!a&&e.tiles&&!Ve(e)?(this.knownImageServers[n]={verifications:0,malformed:!1,root:n,preLoaded:r,sampledId:h(e),verified:!1,server:null,result:{context:e["@context"]||[],sampledProfile:e.profile,resourceServiceRatio:t&&e.height?t.height/e.height:1,sampledSizes:e.sizes||[],sizeRatios:Ee(e.width,e.height,e.sizes||[]),sampledTiles:e.tiles||[]}},!0):this.verify(e)}preLoad(e,t=!0){this.knownImageServers[e.root]=e,t&&(this.knownImageServers[e.root].malformed=!1,this.knownImageServers[e.root].verifications=this.config.verificationsRequired)}predict(e,t=!1,r=!1){const n=e==null?void 0:e.source,s=x(h(e)),a=this.knownImageServers[s];if(!a||!a.result||!((n==null?void 0:n.height)||e.height)||!((n==null?void 0:n.width)||e.width)||!r&&(a.malformed||a.verifications<this.config.verificationsRequired)||Ve(e.source))return null;const o=m(h(e));return this.imageServices[o]||(this.imageServices[o]={"@context":a.result.context,"@id":h(e),id:h(e),protocol:"http://iiif.io/api/image",tiles:(n==null?void 0:n.tiles)||Te(e.width,e.height,a.result.sampledTiles),sizes:(n==null?void 0:n.sizes)||ye(Math.round(e.width/a.result.resourceServiceRatio),Math.round(e.height/a.result.resourceServiceRatio),a.result.sizeRatios),profile:(n==null?void 0:n.profile)||a.result.sampledProfile,height:(n==null?void 0:n.height)||e.height,width:(n==null?void 0:n.width)||e.width,real:!1}),this.imageServices[o]}getThumbnailFromResource(e,t){return F(this,arguments,function*(r,n,s=!0,a=[]){const o=r?yield this.getImageCandidates(r,s):[];return Ge(n,[()=>a,()=>o])})}getImageCandidates(e,t=!0){return F(this,null,function*(){const r=e;if(t&&r.height&&r.width){const n=ee(r);for(const s of n){const a={id:h(s),width:s.width?s.width:r.width,height:s.height?s.height:r.height,source:s};yield this.loadService(a)}}return ze(e,t,this)})}verify(e){return F(this,null,function*(){const t=this.predict(e,!1,!0),r=yield this.fetchService(h(e));if(!t)return!1;const n=t.height===r.height&&t.width===r.width&&t["@context"]===r["@context"]&&Be(t.sizes||[],r.sizes||[]);if(n){const s=x(h(e));this.knownImageServers[s].verifications+=1,this.knownImageServers[s].verifications>=this.config.verificationsRequired&&(this.knownImageServers[s].verified=!0)}return n})}canLoadSync(e){const t=typeof e=="string"?e:h(e),r=m(t);if(this.imageServices[r])return!0;const n=this.knownImageServers[x(t)];return n&&!n.malformed&&n.verifications>=this.config.verificationsRequired}markAsMalformed(e){return F(this,null,function*(){return this.knownImageServers[x(h(e))].malformed=!0,this.loadService(e,!0)})}fetchService(e,t=!1){return F(this,null,function*(){const r=m(e);if(this.imageServices[r]&&(!t||this.imageServices[r].real))return this.imageServices[r];if(!this.config.enableFetching)throw new Error("Fetching is not enabled");const n=yield this.fetch(r).then(s=>s.json());return!n.id&&n["@id"]&&(n.id=n["@id"]),n.id!==e&&(n.id=e,n["@id"]&&(n["@id"]=e)),this.imageServices[r]=Object.assign(n,{real:!0}),this.imageServices[r]})}fetch(e,t){return F(this,null,function*(){return fetch(e,t)})}loadService(e,t=!1){return F(this,null,function*(){if(!this.config.disableThrottling){let s=!0;for(;s;)if(this.fetchingCount>=this.config.verificationsRequired)yield new Promise(a=>setTimeout(a,500));else{s=!1;break}}const r=this.knownImageServers[x(h(e))];if(r&&!r.malformed&&!t){yield r.result;const s=this.loadServiceSync(e);if(s)return s}this.fetchingCount++;const n=yield this.fetchService(h(e),t);return this.fetchingCount--,n.real&&this.sample(n,e),n})}loadServiceSync(e){const t=m(h(e));return this.imageServices[t]?this.imageServices[t]:this.predict(e)}}const ai=new He;exports.IIIF_1_IMAGE_LEVEL_0=ae,exports.IIIF_1_IMAGE_LEVEL_0_PROFILE=oe,exports.IIIF_1_IMAGE_LEVEL_1=R,exports.IIIF_1_IMAGE_LEVEL_1_PROFILE=P,exports.IIIF_1_IMAGE_LEVEL_2=W,exports.IIIF_1_IMAGE_LEVEL_2_PROFILE=G,exports.IIIF_2_IMAGE_LEVEL_0=le,exports.IIIF_2_IMAGE_LEVEL_0_NO_JSON=ue,exports.IIIF_2_IMAGE_LEVEL_0_PROFILE=fe,exports.IIIF_2_IMAGE_LEVEL_1=j,exports.IIIF_2_IMAGE_LEVEL_1_NO_JSON=k,exports.IIIF_2_IMAGE_LEVEL_1_PROFILE=$,exports.IIIF_2_IMAGE_LEVEL_2=T,exports.IIIF_2_IMAGE_LEVEL_2_NO_JSON=D,exports.IIIF_2_IMAGE_LEVEL_2_PROFILE=B,exports.IIIF_3_IMAGE_LEVEL_0=he,exports.IIIF_3_IMAGE_LEVEL_1=V,exports.IIIF_3_IMAGE_LEVEL_2=H,exports.ImageServiceLoader=He,exports.STANFORD_IIIF_1_IMAGE_COMPLIANCE_0=ne,exports.STANFORD_IIIF_1_IMAGE_COMPLIANCE_1=M,exports.STANFORD_IIIF_1_IMAGE_COMPLIANCE_2=C,exports.STANFORD_IIIF_1_IMAGE_CONFORMANCE_0=se,exports.STANFORD_IIIF_1_IMAGE_CONFORMANCE_1=N,exports.STANFORD_IIIF_1_IMAGE_CONFORMANCE_2=b,exports.STANFORD_IIIF_IMAGE_COMPLIANCE_0=te,exports.STANFORD_IIIF_IMAGE_COMPLIANCE_1=A,exports.STANFORD_IIIF_IMAGE_COMPLIANCE_2=O,exports.STANFORD_IIIF_IMAGE_CONFORMANCE_0=re,exports.STANFORD_IIIF_IMAGE_CONFORMANCE_1=L,exports.STANFORD_IIIF_IMAGE_CONFORMANCE_2=z,exports.canonicalServiceUrl=m,exports.combineProfiles=K,exports.createImageServiceRequest=Se,exports.extraFeatures=Z,exports.extractFixedSizeScales=Ee,exports.fixedSizesFromScales=ye,exports.getCustomSizeFromService=we,exports.getFixedSizeFromImage=Oe,exports.getFixedSizesFromService=Le,exports.getId=h,exports.getImageCandidates=ze,exports.getImageCandidatesFromService=q,exports.getImageFromTileSource=w,exports.getImageServerFromId=x,exports.getImageServices=ee,exports.getSmallestScaleFactorAsSingleImage=Ke,exports.getType=Ae,exports.imageServiceLoader=ai,exports.imageServiceProfiles=J,exports.imageServiceRequestToString=Pe,exports.imageServiceSupportsFormat=Xe,exports.imageServiceSupportsRequest=Ye,exports.inferSizeFromUrl=Y,exports.isBestMatch=We,exports.isImageService=S,exports.level0=ce,exports.level0Support=ke,exports.level1=de,exports.level1Support=U,exports.level2=ge,exports.level2Support=Q,exports.levelToProfile=me,exports.parseImageServiceRequest=Fe,exports.parseImageServiceUrl=xe,exports.parseRegionParameter=pe,exports.parseRotationParameter=_e,exports.parseSizeParameter=Ie,exports.pickBestFromCandidates=Ge,exports.regionParameterToString=Me,exports.rotationParameterToString=Ne,exports.sampledTilesToTiles=Te,exports.sizeParameterToString=Ce,exports.sizesMatch=Be,exports.supports=ie,exports.supportsCustomSizes=ve;
