{"version":3,"file":"index.mjs","sources":["../../../src/presentation-2/traverse.ts","../../../src/shared/image-api-profiles.ts","../../../src/shared/ensure-array.ts","../../../src/presentation-2/upgrader.ts"],"sourcesContent":["import {\n  Annotation,\n  AnnotationList,\n  Canvas,\n  ChoiceEmbeddedContent,\n  Collection,\n  CommonContentResource,\n  ContentResource,\n  DescriptiveProperties,\n  Layer,\n  LinkingProperties,\n  Manifest,\n  OneOrMany,\n  Range,\n  RightsProperties,\n  Sequence,\n  Service,\n  TraversableEntityTypes,\n  Traversal,\n  TraversalMap,\n} from '@iiif/presentation-2';\n\nexport const types: TraversableEntityTypes[] = [\n  'sc:Collection',\n  'sc:Manifest',\n  'sc:Canvas',\n  'sc:AnnotationList',\n  'oa:Annotation',\n  'sc:Range',\n  'sc:Layer',\n  'sc:Sequence',\n  'oa:Choice',\n  // Opaque.\n  'Service',\n  'ContentResource',\n];\n\nexport type TraverseOptions = {\n  convertPropsToArray: boolean;\n  mergeMemberProperties: boolean;\n  allowUndefinedReturn: boolean;\n};\n\nexport function identifyResource(resource: any): TraversableEntityTypes {\n  if (typeof resource === 'undefined' || resource === null) {\n    throw new Error('Null or undefined is not a valid entity.');\n  }\n  if (Array.isArray(resource)) {\n    throw new Error('Array is not a valid entity');\n  }\n  if (typeof resource !== 'object') {\n    throw new Error(`${typeof resource} is not a valid entity`);\n  }\n\n  if (typeof resource['@type'] === 'string') {\n    const hasType = types.indexOf(resource['@type'] as any);\n    if (hasType !== -1) {\n      return types[hasType];\n    }\n  }\n\n  if (resource.profile) {\n    return 'Service';\n  }\n\n  if (resource.format) {\n    return 'ContentResource';\n  }\n\n  // Big o'l fallback.\n  if (resource['@type']) {\n    return 'ContentResource';\n  }\n\n  throw new Error('Resource type is not known');\n}\n\nexport class Traverse<\n  T extends {\n    Collection: any;\n    Manifest: any;\n    Canvas: any;\n    AnnotationList: any;\n    Sequence: any;\n    Annotation: any;\n    ContentResource: any;\n    Choice: any;\n    Range: any;\n    Service: any;\n    Layer: any;\n  } = {\n    Collection: Collection;\n    Manifest: Manifest;\n    Canvas: Canvas;\n    AnnotationList: AnnotationList;\n    Sequence: Sequence;\n    Annotation: Annotation;\n    ContentResource: CommonContentResource;\n    Choice: ChoiceEmbeddedContent;\n    Range: Range;\n    Service: Service;\n    Layer: Layer;\n  }\n> {\n  private traversals: Required<TraversalMap>;\n  private options: TraverseOptions;\n\n  constructor(traversals: Partial<TraversalMap>, options: Partial<TraverseOptions> = {}) {\n    this.traversals = {\n      collection: [],\n      manifest: [],\n      canvas: [],\n      annotationList: [],\n      sequence: [],\n      annotation: [],\n      contentResource: [],\n      choice: [],\n      range: [],\n      service: [],\n      layer: [],\n      ...traversals,\n    };\n    this.options = {\n      convertPropsToArray: true,\n      mergeMemberProperties: true,\n      allowUndefinedReturn: false,\n      ...options,\n    };\n  }\n\n  static all(traversal: (resource: any) => any) {\n    return new Traverse({\n      collection: [traversal],\n      manifest: [traversal],\n      canvas: [traversal],\n      annotationList: [traversal],\n      sequence: [traversal],\n      annotation: [traversal],\n      contentResource: [traversal],\n      choice: [traversal],\n      range: [traversal],\n      service: [traversal],\n      layer: [traversal],\n    });\n  }\n\n  traverseCollection(collection: Collection): T['Collection'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseCollectionItems(collection))),\n      this.traversals.collection\n    );\n  }\n\n  traverseCollectionItems(collection: Collection): Collection {\n    if (this.options.mergeMemberProperties) {\n      const members = [\n        ...(collection.manifests || []).map((manifest) => {\n          if (typeof manifest === 'string') {\n            return { '@id': manifest, '@type': 'sc:Manifest' };\n          }\n          return manifest;\n        }),\n        ...(collection.collections || []).map((subCollection) => {\n          if (typeof subCollection === 'string') {\n            return { '@id': subCollection, '@type': 'sc:Collection' };\n          }\n          return subCollection;\n        }),\n        ...(collection.members || []),\n      ];\n\n      delete collection.collections;\n      delete collection.manifests;\n      collection.members = members;\n    }\n\n    if (collection.manifests) {\n      collection.manifests = collection.manifests.map((manifest) =>\n        this.traverseManifest(\n          typeof manifest === 'string'\n            ? ({ '@id': manifest, '@type': 'sc:Manifest' } as Manifest)\n            : (manifest as Manifest)\n        )\n      );\n    }\n\n    if (collection.collections) {\n      collection.collections = collection.collections.map((subCollection) =>\n        this.traverseCollection(\n          typeof subCollection === 'string'\n            ? ({ '@id': subCollection, '@type': 'sc:Collection' } as Collection)\n            : (subCollection as Collection)\n        )\n      );\n    }\n\n    if (collection.members) {\n      collection.members = collection.members.map((member) => {\n        if (typeof member === 'string') {\n          return member;\n        }\n        return this.traverseUnknown(member);\n      });\n    }\n\n    return collection;\n  }\n\n  traverseManifest(manifest: Manifest): T['Manifest'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(manifest))),\n      this.traversals.manifest\n    );\n  }\n\n  traverseManifestItems(manifest: Manifest): Manifest {\n    if (manifest.sequences) {\n      manifest.sequences = manifest.sequences.map((sequence) => this.traverseSequence(sequence));\n    }\n    if (manifest.structures) {\n      manifest.structures = manifest.structures.map((structure) => this.traverseRange(structure));\n    }\n    return manifest;\n  }\n\n  traverseSequence(sequence: Sequence): T['Sequence'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseSequenceItems(sequence))),\n      this.traversals.sequence\n    );\n  }\n\n  traverseSequenceItems(sequence: Sequence): Sequence {\n    if (sequence.canvases) {\n      sequence.canvases = sequence.canvases.map((canvas) => this.traverseCanvas(canvas));\n    }\n    return sequence;\n  }\n\n  traverseCanvas(canvas: Canvas): T['Canvas'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(canvas))),\n      this.traversals.canvas\n    );\n  }\n\n  traverseCanvasItems(canvas: Canvas): Canvas {\n    if (canvas.images) {\n      canvas.images = canvas.images.map((image) => this.traverseAnnotation(image));\n    }\n    if (canvas.otherContent) {\n      canvas.otherContent = canvas.otherContent.map((annotationList) => this.traverseAnnotationList(annotationList));\n    }\n    return canvas;\n  }\n\n  traverseRange(range: Range): T['Range'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseRangeItems(range))),\n      this.traversals.range\n    );\n  }\n\n  traverseRangeItems(range: Range): Range {\n    if (this.options.mergeMemberProperties) {\n      const members = [\n        ...(range.ranges || []).map((innerRange: any) => {\n          if (typeof innerRange === 'string') {\n            return { '@id': innerRange, '@type': 'sc:Range' };\n          }\n          return innerRange;\n        }),\n        ...(range.canvases || []).map((canvas: any) => {\n          if (typeof canvas === 'string') {\n            return { '@id': canvas, '@type': 'sc:Canvas' };\n          }\n          return canvas;\n        }),\n        ...(range.members || []),\n      ];\n\n      delete range.ranges;\n      delete range.canvases;\n      range.members = members.length ? members.map((member) => this.traverseUnknown(member)) : undefined;\n    }\n    return range;\n  }\n\n  traverseAnnotationList(annotationList: AnnotationList): T['AnnotationList'] {\n    const list =\n      typeof annotationList === 'string'\n        ? ({ '@id': annotationList, '@type': 'sc:AnnotationList' } as any)\n        : annotationList;\n\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseAnnotationListItems(list)),\n      this.traversals.annotationList\n    );\n  }\n\n  traverseAnnotationListItems(annotationList: AnnotationList): AnnotationList {\n    if (annotationList.resources) {\n      annotationList.resources = annotationList.resources.map((annotation) => this.traverseAnnotation(annotation));\n    }\n\n    return annotationList;\n  }\n\n  traverseAnnotation(annotation: Annotation): T['Annotation'] {\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationItems(annotation))),\n      this.traversals.annotation\n    );\n  }\n\n  traverseAnnotationItems(annotation: Annotation): Annotation {\n    if (annotation.resource) {\n      if (Array.isArray(annotation.resource)) {\n        annotation.resource = annotation.resource.map((res) =>\n          this.traverseContentResource(res as CommonContentResource)\n        );\n      } else {\n        annotation.resource = this.traverseContentResource(annotation.resource as CommonContentResource);\n      }\n    }\n\n    if (annotation.on) {\n      // selector - just traverse the annotations.\n      // annotation.on = this.traverseSelector(annotation.on);\n    }\n\n    return annotation;\n  }\n\n  traverseLayer(layer: Layer): T['Layer'] {\n    return this.traverseType(this.traverseLinking(this.traverseLayerItems(layer)), this.traversals.layer);\n  }\n\n  traverseLayerItems(layer: Layer): Layer {\n    if (layer.otherContent) {\n      layer.otherContent = layer.otherContent.map((annotationList) => this.traverseAnnotationList(annotationList));\n    }\n    return layer;\n  }\n\n  traverseChoice(choice: ChoiceEmbeddedContent): T['Choice'] {\n    return this.traverseType(this.traverseChoiceItems(choice), this.traversals.choice);\n  }\n\n  traverseChoiceItems(choice: ChoiceEmbeddedContent) {\n    if (choice.default && choice.default !== 'rdf:nil') {\n      choice.default = this.traverseContentResource(choice.default);\n    }\n    if (choice.item && choice.item !== 'rdf:nil') {\n      choice.item = choice.item.map((item) => this.traverseContentResource(item));\n    }\n\n    return choice;\n  }\n\n  traverseService(service: Service): T['Service'] {\n    return this.traverseType(this.traverseLinking(service as any), this.traversals.service);\n  }\n\n  traverseContentResource(contentResource: CommonContentResource): T['ContentResource'] {\n    if (contentResource['@type'] === 'oa:Choice') {\n      return this.traverseChoice(contentResource as any);\n    }\n\n    return this.traverseType(\n      this.traverseDescriptive(this.traverseLinking(contentResource as any)),\n      this.traversals.contentResource\n    );\n  }\n\n  traverseUnknown(item: any) {\n    if (!item['@type'] || typeof item === 'string') {\n      // Unknown item.\n      return item;\n    }\n    switch (identifyResource(item)) {\n      case 'sc:Collection':\n        return this.traverseCollection(item);\n      case 'sc:Manifest':\n        return this.traverseManifest(item);\n      case 'sc:Canvas':\n        return this.traverseCanvas(item);\n      case 'sc:Sequence':\n        return this.traverseSequence(item);\n      case 'sc:Range':\n        return this.traverseRange(item);\n      case 'oa:Annotation':\n        return this.traverseAnnotation(item);\n      case 'sc:AnnotationList':\n        return this.traverseAnnotationList(item);\n      case 'sc:Layer':\n        return this.traverseLayer(item);\n      case 'Service':\n        return this.traverseService(item);\n      case 'oa:Choice':\n        return this.traverseChoice(item);\n      case 'ContentResource':\n        return this.traverseContentResource(item);\n    }\n\n    if (item.profile) {\n      return this.traverseService(item);\n    }\n\n    return item;\n  }\n\n  traverseImageResource(contentResource: OneOrMany<string | ContentResource>) {\n    const wasArray = Array.isArray(contentResource);\n    const resourceList = Array.isArray(contentResource) ? contentResource : [contentResource];\n    const newResourceList: any[] = [];\n\n    for (const singleResource of resourceList) {\n      if (typeof singleResource === 'string') {\n        newResourceList.push(\n          this.traverseContentResource({\n            '@id': singleResource,\n            '@type': 'dctypes:Image',\n          })\n        );\n      } else {\n        newResourceList.push(this.traverseContentResource(singleResource as any));\n      }\n    }\n\n    if (!wasArray && !this.options.convertPropsToArray) {\n      return newResourceList[0];\n    }\n\n    return newResourceList;\n  }\n\n  traverseDescriptive<T extends Partial<DescriptiveProperties & RightsProperties>>(resource: T) {\n    if (resource.thumbnail) {\n      resource.thumbnail = this.traverseImageResource(resource.thumbnail);\n    }\n\n    if (resource.logo) {\n      resource.logo = this.traverseImageResource(resource.logo);\n    }\n\n    return resource;\n  }\n\n  traverseOneOrMoreServices(allServices: OneOrMany<any>) {\n    const wasArray = Array.isArray(allServices);\n    const services = Array.isArray(allServices) ? allServices : [allServices];\n    const newServices = [];\n    for (const service of services) {\n      newServices.push(this.traverseService(service));\n    }\n\n    if (!wasArray && !this.options.convertPropsToArray) {\n      return newServices[0];\n    }\n\n    return newServices;\n  }\n\n  traverseLinking<T extends Partial<LinkingProperties>>(resource: T) {\n    if (resource.related) {\n      resource.related = this.traverseOneOrManyType(resource.related, this.traversals.contentResource);\n    }\n    if (resource.rendering) {\n      resource.rendering = this.traverseOneOrManyType(resource.rendering, this.traversals.contentResource);\n    }\n    if (resource.service) {\n      resource.service = this.traverseOneOrMoreServices(resource.service);\n    }\n    if (resource.seeAlso) {\n      resource.seeAlso = this.traverseOneOrManyType(resource.seeAlso, this.traversals.contentResource);\n    }\n    if (resource.within) {\n      if (typeof resource.within === 'string') {\n        // I don't know. skip?\n      } else {\n        resource.within = this.traverseOneOrManyType(\n          resource.within as CommonContentResource,\n          this.traversals.contentResource\n        );\n      }\n    }\n    if (resource.startCanvas) {\n      if (typeof resource.startCanvas === 'string') {\n        resource.startCanvas = this.traverseType(\n          { '@id': resource.startCanvas, '@type': 'sc:Canvas' } as Canvas,\n          this.traversals.canvas\n        );\n      } else if (resource.startCanvas) {\n        this.traverseType(resource.startCanvas as any, this.traversals.canvas);\n      }\n    }\n    if (resource.contentLayer) {\n      if (typeof resource.contentLayer === 'string') {\n        resource.contentLayer = this.traverseLayer({\n          '@id': resource.contentLayer,\n          '@type': 'sc:Layer',\n        });\n      } else {\n        resource.contentLayer = this.traverseLayer(resource.contentLayer);\n      }\n    }\n    return resource;\n  }\n\n  traverseOneOrManyType<T, Return = T>(object: T | T[], traversals: Array<Traversal<T>>): Return {\n    if (!Array.isArray(object)) {\n      if (this.options.convertPropsToArray) {\n        object = [object] as T[];\n      } else {\n        return this.traverseType(object, traversals);\n      }\n    }\n    return object.map((singleObj) => this.traverseType(singleObj, traversals)) as any;\n  }\n\n  traverseType<T, Return = T>(object: T, traversals: Array<Traversal<T>>): Return {\n    return traversals.reduce((acc: T, traversal: Traversal<T>): T => {\n      const returnValue = traversal(acc);\n      if (typeof returnValue === 'undefined' && !this.options.allowUndefinedReturn) {\n        return acc;\n      }\n      return returnValue;\n    }, object) as any;\n  }\n}\n","export const STANFORD_IIIF_IMAGE_COMPLIANCE_0 = 'http://library.stanford.edu/iiif/image-api/compliance.html#level0';\nexport const STANFORD_IIIF_IMAGE_COMPLIANCE_1 = 'http://library.stanford.edu/iiif/image-api/compliance.html#level1';\nexport const STANFORD_IIIF_IMAGE_COMPLIANCE_2 = 'http://library.stanford.edu/iiif/image-api/compliance.html#level2';\nexport const STANFORD_IIIF_IMAGE_CONFORMANCE_0 = 'http://library.stanford.edu/iiif/image-api/conformance.html#level0';\nexport const STANFORD_IIIF_IMAGE_CONFORMANCE_1 = 'http://library.stanford.edu/iiif/image-api/conformance.html#level1';\nexport const STANFORD_IIIF_IMAGE_CONFORMANCE_2 = 'http://library.stanford.edu/iiif/image-api/conformance.html#level2';\nexport const STANFORD_IIIF_1_IMAGE_COMPLIANCE_0 =\n  'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0';\nexport const STANFORD_IIIF_1_IMAGE_COMPLIANCE_1 =\n  'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1';\nexport const STANFORD_IIIF_1_IMAGE_COMPLIANCE_2 =\n  'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2';\nexport const STANFORD_IIIF_1_IMAGE_CONFORMANCE_0 =\n  'http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0';\nexport const STANFORD_IIIF_1_IMAGE_CONFORMANCE_1 =\n  'http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1';\nexport const STANFORD_IIIF_1_IMAGE_CONFORMANCE_2 =\n  'http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2';\nexport const IIIF_1_IMAGE_LEVEL_0 = 'http://iiif.io/api/image/1/level0.json';\nexport const IIIF_1_IMAGE_LEVEL_0_PROFILE = 'http://iiif.io/api/image/1/profiles/level0.json';\nexport const IIIF_1_IMAGE_LEVEL_1 = 'http://iiif.io/api/image/1/level1.json';\nexport const IIIF_1_IMAGE_LEVEL_1_PROFILE = 'http://iiif.io/api/image/1/profiles/level1.json';\nexport const IIIF_1_IMAGE_LEVEL_2 = 'http://iiif.io/api/image/1/level2.json';\nexport const IIIF_1_IMAGE_LEVEL_2_PROFILE = 'http://iiif.io/api/image/1/profiles/level2.json';\nexport const IIIF_2_IMAGE_LEVEL_0 = 'http://iiif.io/api/image/2/level0.json';\nexport const IIIF_2_IMAGE_LEVEL_0_PROFILE = 'http://iiif.io/api/image/2/profiles/level0.json';\nexport const IIIF_2_IMAGE_LEVEL_1 = 'http://iiif.io/api/image/2/level1.json';\nexport const IIIF_2_IMAGE_LEVEL_1_PROFILE = 'http://iiif.io/api/image/2/profiles/level1.json';\nexport const IIIF_2_IMAGE_LEVEL_2 = 'http://iiif.io/api/image/2/level2.json';\nexport const IIIF_2_IMAGE_LEVEL_2_PROFILE = 'http://iiif.io/api/image/2/profiles/level2.json';\nexport const IIIF_3_IMAGE_LEVEL_0 = 'level0';\nexport const IIIF_3_IMAGE_LEVEL_1 = 'level1';\nexport const IIIF_3_IMAGE_LEVEL_2 = 'level2';\n\n// Non-standard\nexport const IIIF_2_IMAGE_LEVEL_0_NO_JSON = 'http://iiif.io/api/image/2/level0';\nexport const IIIF_2_IMAGE_LEVEL_1_NO_JSON = 'http://iiif.io/api/image/2/level1';\nexport const IIIF_2_IMAGE_LEVEL_2_NO_JSON = 'http://iiif.io/api/image/2/level2';\n\nexport const level1Support = [\n  IIIF_2_IMAGE_LEVEL_1_NO_JSON,\n  IIIF_2_IMAGE_LEVEL_2_NO_JSON,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_2,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_2,\n  IIIF_1_IMAGE_LEVEL_1,\n  IIIF_1_IMAGE_LEVEL_1_PROFILE,\n  IIIF_1_IMAGE_LEVEL_2,\n  IIIF_1_IMAGE_LEVEL_2_PROFILE,\n  IIIF_2_IMAGE_LEVEL_1,\n  IIIF_2_IMAGE_LEVEL_1_PROFILE,\n  IIIF_2_IMAGE_LEVEL_2,\n  IIIF_2_IMAGE_LEVEL_2_PROFILE,\n  IIIF_3_IMAGE_LEVEL_1,\n  IIIF_3_IMAGE_LEVEL_2,\n];\n\nexport const imageServiceProfiles = [\n  IIIF_2_IMAGE_LEVEL_0_NO_JSON,\n  IIIF_2_IMAGE_LEVEL_1_NO_JSON,\n  IIIF_2_IMAGE_LEVEL_2_NO_JSON,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_0,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_0,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_IMAGE_CONFORMANCE_2,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_0,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_1,\n  STANFORD_IIIF_1_IMAGE_COMPLIANCE_2,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_0,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_1,\n  STANFORD_IIIF_1_IMAGE_CONFORMANCE_2,\n  IIIF_1_IMAGE_LEVEL_0,\n  IIIF_1_IMAGE_LEVEL_0_PROFILE,\n  IIIF_1_IMAGE_LEVEL_1,\n  IIIF_1_IMAGE_LEVEL_1_PROFILE,\n  IIIF_1_IMAGE_LEVEL_2,\n  IIIF_1_IMAGE_LEVEL_2_PROFILE,\n  IIIF_2_IMAGE_LEVEL_0,\n  IIIF_2_IMAGE_LEVEL_0_PROFILE,\n  IIIF_2_IMAGE_LEVEL_1,\n  IIIF_2_IMAGE_LEVEL_1_PROFILE,\n  IIIF_2_IMAGE_LEVEL_2,\n  IIIF_2_IMAGE_LEVEL_2_PROFILE,\n  IIIF_3_IMAGE_LEVEL_0,\n  IIIF_3_IMAGE_LEVEL_1,\n  IIIF_3_IMAGE_LEVEL_2,\n];\n","export function ensureArray<T>(maybeArray: T | T[]): T[] {\n  if (Array.isArray(maybeArray)) {\n    return maybeArray;\n  }\n  return [maybeArray];\n}\n","import * as Presentation3 from '@iiif/presentation-3';\nimport * as Presentation2 from '@iiif/presentation-2';\nimport { imageServiceProfiles, level1Support } from '../shared/image-api-profiles';\nimport { Traverse } from './traverse';\nimport { ensureArray } from '../shared/ensure-array';\n\nconst configuration = {\n  attributionLabel: 'Attribution',\n  lang: 'none',\n  providerId: 'http://example.org/provider',\n  providerName: 'Unknown',\n};\n\nexport function convertLanguageMapping(\n  inputLangProperty?: Presentation2.OneOrMany<Presentation2.LanguageProperty>,\n  defaultLang = 'none'\n): Presentation3.InternationalString {\n  if (!inputLangProperty) {\n    return {};\n  }\n\n  const arrayOfValues = Array.isArray(inputLangProperty) ? inputLangProperty : [inputLangProperty];\n\n  const languageMap: Presentation3.InternationalString = {};\n\n  for (const language of arrayOfValues) {\n    // For strings \"label\": [\"a value\"]\n    if (typeof language === 'string') {\n      languageMap[defaultLang] = languageMap[defaultLang] ? languageMap[defaultLang] : [];\n      (languageMap[defaultLang] as string[]).push(language || '');\n      continue;\n    }\n\n    // For maps without a language\n    if (!language['@language']) {\n      languageMap[defaultLang] = languageMap[defaultLang] ? languageMap[defaultLang] : [];\n      (languageMap[defaultLang] as string[]).push(language['@value'] || '');\n      continue;\n    }\n\n    // Default case with language.\n    const lang = language['@language'];\n    languageMap[lang] = languageMap[lang] ? languageMap[lang] : [];\n    (languageMap[lang] as string[]).push(language['@value'] || '');\n  }\n  return languageMap;\n}\n\nexport function getProfile(profile: any | any[]): string | undefined {\n  if (Array.isArray(profile)) {\n    return getProfile(profile.find((s) => typeof s === 'string'));\n  }\n\n  if (imageServiceProfiles.indexOf(profile) !== -1) {\n    return 'level2';\n  }\n\n  if (level1Support.indexOf(profile) !== -1) {\n    return 'level1';\n  }\n\n  if (typeof profile !== 'string') {\n    return undefined;\n  }\n\n  return profile;\n}\n\nexport function getTypeFromContext(inputContexts: string | string[]): string | undefined {\n  const contexts: string[] = Array.isArray(inputContexts) ? inputContexts : [inputContexts];\n\n  for (const context of contexts) {\n    switch (context) {\n      case 'http://iiif.io/api/image/2/context.json':\n      case 'http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2':\n        return 'ImageService2';\n      case 'http://iiif.io/api/image/1/context.json':\n      case 'http://library.stanford.edu/iiif/image-api/1.1/context.json':\n        return 'ImageService1';\n      case 'http://iiif.io/api/annex/openannotation/context.json':\n        return 'ImageApiSelector';\n    }\n  }\n\n  return undefined;\n}\n\nfunction getTypeFromProfile(inputProfile: string): string | undefined {\n  switch (inputProfile) {\n    case 'http://iiif.io/api/image/2/level0.json':\n    case 'http://iiif.io/api/image/2/level1.json':\n    case 'http://iiif.io/api/image/2/level2.json':\n      return 'ImageService2';\n\n    case 'http://iiif.io/api/auth/1/kiosk':\n    case 'http://iiif.io/api/auth/1/login':\n    case 'http://iiif.io/api/auth/1/clickthrough':\n    case 'http://iiif.io/api/auth/1/external':\n    case 'http://iiif.io/api/auth/0/kiosk':\n    case 'http://iiif.io/api/auth/0/login':\n    case 'http://iiif.io/api/auth/0/clickthrough':\n    case 'http://iiif.io/api/auth/0/external':\n      return 'AuthCookieService1';\n\n    case 'http://iiif.io/api/auth/1/token':\n    case 'http://iiif.io/api/auth/0/token':\n      return 'AuthTokenService1';\n    case 'http://iiif.io/api/auth/1/logout':\n    case 'http://iiif.io/api/auth/0/logout':\n      return 'AuthLogoutService1';\n\n    case 'http://iiif.io/api/search/1/search':\n    case 'http://iiif.io/api/search/0/search':\n      return 'SearchService1';\n    case 'http://iiif.io/api/search/1/autocomplete':\n    case 'http://iiif.io/api/search/0/autocomplete':\n      return 'AutoCompleteService1';\n  }\n\n  return undefined;\n}\n\nfunction removePrefix(str: string) {\n  for (const prefix of ['sc', 'oa', 'dcterms', 'dctypes', 'iiif']) {\n    if (str.startsWith(`${prefix}:`)) {\n      return str.slice(prefix.length + 1);\n    }\n  }\n\n  return str;\n}\n\nconst knownTypes = ['Collection', 'Manifest', 'Annotation', 'AnnotationPage', 'Range', 'Service'];\n\nfunction getNewType(resource: any): string {\n  const id = resource['@id'] || resource.id;\n  let oldType: string | string[] = resource['@type'] || resource.type;\n  const profile: any = resource.profile || undefined;\n  const context: any = resource['@context'] || undefined;\n\n  if (profile) {\n    const possibleType = getTypeFromProfile(profile);\n    if (possibleType) {\n      return possibleType;\n    }\n  }\n\n  if (context) {\n    const possibleType = getTypeFromContext(context);\n    if (possibleType) {\n      return possibleType;\n    }\n  }\n\n  if (oldType) {\n    if (Array.isArray(oldType)) {\n      if (oldType.indexOf('oa:CssStylesheet') !== -1) {\n        return 'CssStylesheet';\n      }\n      if (oldType.indexOf('cnt:ContentAsText') !== -1) {\n        return 'TextualBody';\n      }\n      // Nothing we can do?\n      oldType = oldType[0];\n    }\n\n    for (const prefix of ['sc', 'oa', 'dcterms', 'dctypes', 'iiif']) {\n      if (oldType.startsWith(`${prefix}:`)) {\n        oldType = oldType.slice(prefix.length + 1);\n        break;\n      }\n    }\n\n    switch (oldType) {\n      case 'Layer':\n        return 'AnnotationCollection';\n      case 'AnnotationList':\n        return 'AnnotationPage';\n      case 'cnt:ContentAsText':\n        return 'TextualBody';\n      // @todo There are definitely some missing annotation types here.\n    }\n  }\n\n  if (oldType && knownTypes.indexOf(oldType) !== -1) {\n    return oldType;\n  }\n\n  if (resource.format) {\n    if (resource.format.startsWith('image/')) {\n      return 'Image';\n    }\n    if (resource.format.startsWith('text/')) {\n      return 'Text';\n    }\n    if (resource.format === 'application/pdf') {\n      return 'Text';\n    }\n    if (resource.format.startsWith('application/')) {\n      return 'Dataset';\n    }\n  }\n\n  if (id && (id.endsWith('.jpg') || id.endsWith('.png') || id.endsWith('.jpeg'))) {\n    return 'Image';\n  }\n\n  if (!oldType) {\n    return 'unknown';\n  }\n\n  // Again, nothing we can do.\n  return oldType as string;\n}\n\nconst licenseRegex = /http(s)?:\\/\\/(creativecommons.org|rightsstatements.org)[^\"'\\\\<\\n]+/gm;\n\nfunction extractLicense(license: string) {\n  const matches = license.match(licenseRegex);\n  if (matches) {\n    return matches[0];\n  }\n\n  return license;\n}\n\nasync function getContentTypeOfRemoteResource(resourceId: string): Promise<string | undefined> {\n  try {\n    const response = await fetch(resourceId, { method: 'HEAD' });\n    const headers = response.headers;\n\n    return headers.get('content-type') || undefined;\n  } catch (e) {\n    // do nothing.\n  }\n\n  return undefined;\n}\n\nfunction fixLicense(\n  license: Presentation2.RightsProperties['license'],\n  licenseLabel = 'Rights/License',\n  lang = 'none'\n): [Presentation3.DescriptiveProperties['rights'], Presentation3.DescriptiveProperties['metadata']] {\n  let rights: Presentation3.DescriptiveProperties['rights'] = null;\n  const metadata: Presentation3.DescriptiveProperties['metadata'] = [];\n\n  const licenseList = Array.isArray(license) ? license : [license];\n\n  for (const rawLicense of licenseList) {\n    const singleLicense = rawLicense ? extractLicense(rawLicense) : undefined;\n\n    if (\n      singleLicense &&\n      (singleLicense.indexOf('creativecommons.org') !== -1 || singleLicense.indexOf('rightsstatements.org') !== -1)\n    ) {\n      if (singleLicense.startsWith('https://')) {\n        rights = `http://${singleLicense.slice(8)}`;\n      } else {\n        rights = singleLicense;\n      }\n      continue;\n    }\n    if (singleLicense) {\n      metadata.push({\n        label: { [lang]: [licenseLabel] },\n        value: { [lang]: [singleLicense] },\n      });\n    }\n  }\n\n  return [rights, metadata];\n}\n\nconst removeContexts = [\n  'http://iiif.io/api/presentation/2/context.json',\n  'http://iiif.io/api/image/2/context.json',\n  'http://iiif.io/api/image/1/context.json',\n  'http://library.stanford.edu/iiif/image-api/1.1/context.json',\n  'http://iiif.io/api/search/1/context.json',\n  'http://iiif.io/api/search/0/context.json',\n  'http://iiif.io/api/auth/1/context.json',\n  'http://iiif.io/api/auth/0/context.json',\n  'http://iiif.io/api/annex/openannotation/context.json',\n];\n\nfunction fixContext(inputContext: string | string[] | undefined): string | string[] | undefined {\n  if (inputContext) {\n    const contexts = Array.isArray(inputContext) ? inputContext : [inputContext];\n\n    const newContexts = [];\n    for (const context of contexts) {\n      if (context === 'http://iiif.io/api/presentation/2/context.json') {\n        newContexts.push('http://iiif.io/api/presentation/3/context.json');\n      }\n      if (removeContexts.indexOf(context) !== -1) {\n        continue;\n      }\n      newContexts.push(context);\n    }\n\n    if (contexts.length) {\n      return newContexts.length === 1 ? newContexts[0] : newContexts;\n    }\n  }\n\n  return undefined;\n}\n\nfunction convertMetadata(\n  metadata: Presentation2.DescriptiveProperties['metadata']\n): Presentation3.DescriptiveProperties['metadata'] {\n  if (!metadata) {\n    return [];\n  }\n\n  return metadata.map((item): Presentation3.MetadataItem => {\n    return {\n      label: convertLanguageMapping(item.label),\n      value: convertLanguageMapping(item.value),\n    };\n  });\n}\n\nfunction removeUndefinedProperties(obj: any) {\n  for (const prop in obj) {\n    if (typeof obj[prop] === 'undefined' || obj[prop] === null) {\n      delete obj[prop];\n    }\n  }\n  return obj;\n}\n\nlet mintedIdCounter = 0;\n\nfunction mintNewIdFromResource(\n  resource: Presentation3.SomeRequired<Presentation2.TechnicalProperties, '@type'>,\n  subresource?: string\n) {\n  const origId = encodeURI((resource as { id?: string }).id || resource['@id'] || '').trim();\n\n  if (origId && subresource) {\n    return `${origId}/${subresource}`;\n  }\n\n  if (origId) {\n    return origId;\n  }\n\n  mintedIdCounter++;\n\n  // @todo.\n  return `http://example.org/${resource['@type']}${subresource ? `/${subresource}` : ''}/${mintedIdCounter}`;\n}\n\n// @todo this was removed due to identifiers not being able to be used externally after upgrading.\nfunction resolveDecodedURI(uri: string) {\n  return encodeURI(decodeURIComponent(uri)).trim();\n}\n\nfunction technicalProperties<T extends Partial<Presentation3.TechnicalProperties>>(\n  resource: Presentation3.SomeRequired<Presentation2.TechnicalProperties, '@type'> & {\n    motivation?: string | string[] | null;\n    format?: string;\n    profile?: any;\n    '@context'?: string | string[] | undefined;\n  }\n) {\n  const allBehaviours = [...(resource.behavior || [])];\n\n  if (resource.viewingHint) {\n    allBehaviours.push(resource.viewingHint);\n  }\n\n  let motivation: string | string[] | undefined;\n  if (Array.isArray(resource.motivation)) {\n    motivation = resource.motivation.map(removePrefix);\n  } else if (resource.motivation) {\n    motivation = removePrefix(resource.motivation);\n  }\n\n  return {\n    '@context': resource['@context'] ? fixContext(resource['@context']) : undefined,\n    id: (resource['@id'] || mintNewIdFromResource(resource)).trim(),\n    type: getNewType(resource) as any,\n    behavior: allBehaviours.length ? allBehaviours : undefined,\n    // format: This will be an optional async post-process step.\n    height: resource.height ? resource.height : undefined,\n    width: resource.width ? resource.width : undefined,\n    motivation,\n    viewingDirection: resource.viewingDirection,\n    profile: resource.profile,\n    format: resource.format ? resource.format : undefined,\n    duration: undefined,\n    timeMode: undefined,\n  } as any;\n}\n\nfunction descriptiveProperties<T extends Partial<Presentation3.DescriptiveProperties>>(\n  resource: Presentation2.DescriptiveProperties &\n    Presentation2.RightsProperties &\n    Partial<Presentation2.TechnicalProperties>\n): T {\n  const [rights, extraMetadata] = fixLicense(resource.license);\n  const allMetadata = [...(resource.metadata ? convertMetadata(resource.metadata) : []), ...extraMetadata];\n\n  return {\n    rights,\n    metadata: allMetadata.length ? allMetadata : undefined,\n    label: resource.label ? convertLanguageMapping(resource.label) : undefined,\n    requiredStatement: resource.attribution\n      ? {\n          label: convertLanguageMapping(configuration.attributionLabel),\n          value: convertLanguageMapping(resource.attribution),\n        }\n      : undefined,\n    navDate: resource.navDate,\n    summary: resource.description ? convertLanguageMapping(resource.description) : undefined,\n    thumbnail: resource.thumbnail as any,\n  } as T;\n}\n\nfunction parseWithin(resource: Presentation2.AbstractResource): undefined | Presentation3.LinkingProperties['partOf'] {\n  if (!resource.within) {\n    return undefined;\n  }\n\n  const withinProperties = Array.isArray(resource.within) ? resource.within : [resource.within];\n  const returnPartOf: Presentation3.LinkingProperties['partOf'] = [];\n\n  for (const within of withinProperties) {\n    if (typeof within === 'string') {\n      if (within) {\n        switch (resource['@type']) {\n          case 'sc:Manifest':\n            returnPartOf.push({ id: within, type: 'Collection' });\n            break;\n          // @todo are there more cases?\n        }\n      }\n    } else if ((within as any)['@id']) {\n      returnPartOf.push({\n        id: (within as any)['@id'], // as any since content resources don't require an `@id`\n        type: getNewType(within) as any,\n      });\n    } else {\n      // Content resource.\n    }\n  }\n\n  return returnPartOf.length ? returnPartOf : undefined;\n}\n\nfunction linkingProperties(resource: Presentation2.LinkingProperties & Presentation2.RightsProperties) {\n  // @todo related links to metadata.\n\n  const related = resource.related ? (Array.isArray(resource.related) ? resource.related : [resource.related]) : [];\n  const layer = resource.contentLayer as Presentation2.Layer;\n\n  return {\n    provider:\n      resource.logo || related.length\n        ? [\n            {\n              id: configuration.providerId,\n              type: 'Agent' as const,\n              homepage: related.length ? [related[0] as any] : undefined,\n              logo: resource.logo ? (Array.isArray(resource.logo) ? resource.logo : [resource.logo]) : undefined,\n              label: convertLanguageMapping(configuration.providerName),\n            },\n          ]\n        : undefined,\n    partOf: parseWithin(resource),\n    rendering: resource.rendering,\n    seeAlso: resource.seeAlso,\n    start: resource.startCanvas as any,\n    service: resource.service ? ensureArray(resource.service as any) : undefined,\n    supplementary: layer ? [layer as any] : undefined,\n  };\n}\n\n// FIXME: Is this function really needed?\nfunction embeddedContentProperties(resource: Presentation2.CharsEmbeddedContent) {\n  return {\n    chars: resource.chars,\n    format: resource.format ? resource.format : undefined,\n    language: resource.language,\n  };\n}\n\nfunction upgradeCollection(collection: Presentation2.Collection): Presentation3.Collection {\n  return removeUndefinedProperties({\n    ...technicalProperties(collection),\n    ...descriptiveProperties<Presentation3.SomeRequired<Presentation3.CollectionDescriptive, 'label'>>(collection),\n    ...linkingProperties(collection),\n    items: collection.members as any,\n  });\n}\n\nfunction flattenArray<T>(array: T[][]): T[] {\n  const returnArr: T[] = [];\n  for (const arr of array || []) {\n    returnArr.push(...arr);\n  }\n  return returnArr;\n}\n\nfunction upgradeManifest(manifest: Presentation2.Manifest): Presentation3.Manifest {\n  const allCanvases = [];\n  const behavior = [];\n  for (const sequence of manifest.sequences || []) {\n    if (sequence.canvases.length) {\n      allCanvases.push(...sequence.canvases);\n    }\n    if (sequence.behavior) {\n      behavior.push(...sequence.behavior);\n    }\n  }\n\n  // This comes from the sequence.\n  const technical = technicalProperties(manifest);\n  if (behavior.length) {\n    if (technical.behavior) {\n      technical.behavior.push(...behavior);\n    } else {\n      technical.behavior = behavior;\n    }\n  }\n\n  return removeUndefinedProperties({\n    ...technical,\n    ...descriptiveProperties(manifest),\n    ...linkingProperties(manifest),\n    items: allCanvases,\n    structures: manifest.structures as any,\n  });\n}\n\nfunction upgradeCanvas(canvas: Presentation2.Canvas): Presentation3.Canvas {\n  return removeUndefinedProperties({\n    ...technicalProperties(canvas),\n    ...descriptiveProperties(canvas),\n    ...linkingProperties(canvas),\n    annotations: canvas.otherContent && canvas.otherContent.length ? (canvas.otherContent as any[]) : undefined,\n    items:\n      canvas.images && canvas.images.length\n        ? [\n            {\n              id: mintNewIdFromResource(canvas, 'annotation-page'),\n              type: 'AnnotationPage',\n              items: canvas.images as any,\n            },\n          ]\n        : undefined,\n  });\n}\n\nfunction upgradeAnnotationList(annotationPage: Presentation2.AnnotationList): Presentation3.AnnotationPage {\n  return removeUndefinedProperties({\n    ...(technicalProperties(annotationPage) as any),\n    ...(descriptiveProperties(annotationPage) as any),\n    ...(linkingProperties(annotationPage) as any),\n    items: annotationPage.resources && annotationPage.resources.length ? (annotationPage.resources as any) : undefined,\n  });\n}\n\nfunction upgradeSequence(sequence: Presentation2.Sequence): {\n  canvases: Presentation3.Canvas[];\n  behavior?: string[];\n} {\n  /*\n    rng = {\"id\": s.get('@id', self.mint_uri()), \"type\": \"Range\"}\n    rng['behavior'] = ['sequence']\n    rng['items'] = []\n    for c in s['canvases']:\n      if type(c) == dict:\n        rng['items'].append({\"id\": c['@id'], \"type\": \"Canvas\"})\n      elif type(c) in STR_TYPES:\n        rng['items'].append({\"id\": c, \"type\": \"Canvas\"})\n    # Copy other properties and hand off to _generic\n    del s['canvases']\n    for k in s.keys():\n      if not k in ['@id', '@type']:\n        rng[k] = s[k]\n    self.process_generic(rng)\n    what['_structures'].append(rng)\n   */\n\n  if (!sequence.canvases || sequence.canvases.length === 0) {\n    return {\n      canvases: [],\n      behavior: [],\n    };\n  }\n\n  // @todo possibly return some ranges too.\n  return {\n    canvases: sequence.canvases as any[],\n    behavior: sequence.viewingHint ? [sequence.viewingHint] : [],\n  };\n}\n\nfunction upgradeAnnotation(annotation: Presentation2.Annotation): Presentation3.Annotation {\n  function upgradeTarget(target: typeof annotation.on): Presentation3.AnnotationTarget {\n    if (Array.isArray(target)) {\n      if (target.length > 1) {\n        return { type: 'List', items: target.map(upgradeTarget) as Presentation3.Target[] };\n      }\n      target = target[0];\n    }\n    if (typeof target === 'string') {\n      return encodeURI(target).trim();\n    } else if ('@type' in target) {\n      let source: string | Presentation3.Reference<'Canvas'> | Presentation3.Reference<'Image'>;\n      if (typeof target.full === 'string') {\n        source = target.full;\n      } else if (target.full['@type'] === 'dctypes:Image') {\n        source = { id: target.full['@id'], type: 'Image' };\n      } else if (target.full['@type'] === 'sc:Canvas') {\n        source = { id: target.full['@id'], type: 'Canvas' };\n      } else {\n        throw new Error(`Unsupported source type on annotation: ${target.full['@type']}`);\n      }\n      return {\n        type: 'SpecificResource',\n        source,\n        selector: upgradeSelector(target.selector),\n      };\n    } else {\n      return encodeURI(target['@id']).trim();\n    }\n  }\n  return removeUndefinedProperties({\n    ...(technicalProperties(annotation) as any),\n    ...(descriptiveProperties(annotation) as any),\n    ...(linkingProperties(annotation) as any),\n    target: upgradeTarget(annotation.on),\n    body: Array.isArray(annotation.resource)\n      ? annotation.resource.map(upgradeContentResource)\n      : upgradeContentResource(annotation.resource),\n    // @todo stylesheet upgrade.\n  });\n}\n\nfunction upgradeContentResource(inputContentResource: Presentation2.ContentResource): Presentation3.ContentResource {\n  const contentResource = inputContentResource as Presentation2.CommonContentResource;\n  // @todo there might be some field dropped here.\n  return removeUndefinedProperties({\n    ...(technicalProperties(contentResource) as any),\n    ...(descriptiveProperties(contentResource) as any),\n    ...(linkingProperties(contentResource as any) as any),\n    ...(embeddedContentProperties(contentResource as any) as any),\n  });\n}\n\nfunction upgradeChoice(choice: Presentation2.ChoiceEmbeddedContent): Presentation3.ChoiceBody {\n  const items = [];\n\n  if (choice.default && choice.default !== 'rdf:nil') {\n    items.push(choice.default);\n  }\n\n  if (choice.item && choice.item !== 'rdf:nil') {\n    items.push(...choice.item);\n  }\n\n  return {\n    ...technicalProperties(choice),\n    ...descriptiveProperties(choice),\n    items: items as any,\n  };\n}\n\nfunction upgradeRange(range: Presentation2.Range): Presentation3.Range {\n  // range.members;\n  // range.canvases;\n  // Range.\n  // At the moment a range only references other ranges by id.\n  // So we need to first get\n  return removeUndefinedProperties({\n    ...technicalProperties(range),\n    ...descriptiveProperties(range),\n    ...linkingProperties(range),\n    items: range.members as any,\n  } as Presentation3.Range);\n}\n\nfunction upgradeService(service: Presentation2.Service): Presentation3.Service {\n  const { '@id': id, '@type': type, '@context': context, profile, ...additionalProps } = service as any;\n\n  const newService: any = {};\n\n  if (id) {\n    newService['@id'] = id;\n  }\n\n  newService['@type'] = getNewType(service);\n\n  if (newService['@type'] === 'unknown') {\n    // @todo handle case where there might be multiple contexts.\n    if (context && context.length) {\n      newService['@context'] = context;\n    }\n    newService['@type'] = 'Service'; // optional on services.\n  }\n\n  if (profile) {\n    newService.profile = getProfile(profile);\n  }\n\n  return removeUndefinedProperties({\n    ...newService,\n    ...additionalProps,\n  });\n}\n\nfunction upgradeLayer(layer: Presentation2.Layer): Presentation3.AnnotationCollection {\n  return removeUndefinedProperties({\n    ...technicalProperties(layer),\n    ...descriptiveProperties(layer),\n    ...linkingProperties(layer),\n  });\n}\n\nexport const presentation2to3 = new Traverse<{\n  Collection: Presentation3.Collection;\n  Manifest: Presentation3.Manifest;\n  Canvas: Presentation3.Canvas;\n  AnnotationList: Presentation3.AnnotationPage;\n  Sequence: Presentation3.Canvas[];\n  Annotation: Presentation3.Annotation;\n  ContentResource: Presentation3.ContentResource;\n  Choice: Presentation3.ChoiceBody;\n  Range: Presentation3.Range;\n  Service: Presentation3.Service;\n  Layer: Presentation3.AnnotationCollection;\n}>({\n  collection: [upgradeCollection],\n  manifest: [upgradeManifest],\n  canvas: [upgradeCanvas],\n  annotationList: [upgradeAnnotationList],\n  sequence: [upgradeSequence],\n  annotation: [upgradeAnnotation],\n  contentResource: [upgradeContentResource],\n  choice: [upgradeChoice],\n  range: [upgradeRange],\n  service: [upgradeService],\n  layer: [upgradeLayer],\n});\n\nexport function convertPresentation2(entity: any): Presentation3.Manifest | Presentation3.Collection {\n  if (\n    (entity &&\n      entity['@context'] &&\n      (entity['@context'] === 'http://iiif.io/api/presentation/2/context.json' ||\n        entity['@context'].indexOf('http://iiif.io/api/presentation/2/context.json') !== -1 ||\n        // Yale context.\n        entity['@context'] === 'http://www.shared-canvas.org/ns/context.json')) ||\n    entity['@context'] === 'http://iiif.io/api/image/2/context.json'\n  ) {\n    return presentation2to3.traverseUnknown(entity);\n  }\n  return entity;\n}\n\nfunction upgradeSelector(\n  selector: Presentation2.ContentResourceSelector\n): Presentation3.Selector | Presentation3.Selector[] {\n  const isSvgSelector =\n    ((Array.isArray(selector['@type']) && selector['@type'].includes('oa:SvgSelector')) ||\n      selector['@type'] == 'oa:SvgSelector') &&\n    ('chars' in selector || 'value' in selector);\n  if (isSvgSelector) {\n    return {\n      type: 'SvgSelector',\n      value: 'chars' in selector ? selector.chars : selector.value,\n    };\n  }\n  if (selector['@type'] === 'oa:FragmentSelector') {\n    return {\n      type: 'FragmentSelector',\n      value: selector.value,\n    };\n  }\n  if (selector['@type'] === 'oa:Choice') {\n    return [\n      upgradeSelector(selector.default) as Presentation3.Selector,\n      ...((Array.isArray(selector.item) ? selector.item : [selector.item]).map(\n        upgradeSelector\n      ) as Presentation3.Selector[]),\n    ];\n  }\n  if (selector['@type'] == 'iiif:ImageApiSelector') {\n    return {\n      type: 'ImageApiSelector',\n      region: 'region' in selector ? selector.region : undefined,\n      rotation: 'rotation' in selector ? selector.rotation : undefined,\n    };\n  }\n  throw new Error(`Unsupported selector type: ${selector['@type']}`);\n}\n"],"names":[],"mappings":";;;;;;AAsBO,MAAM,QAAkC;AAAA,EAC7C;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EAEA;AAAA,EACA;AACF;AAQO,SAAS,iBAAiB,UAAuC;AACtE,MAAI,OAAO,aAAa,eAAe,aAAa,MAAM;AAClD,UAAA,IAAI,MAAM,0CAA0C;AAAA,EAC5D;AACI,MAAA,MAAM,QAAQ,QAAQ,GAAG;AACrB,UAAA,IAAI,MAAM,6BAA6B;AAAA,EAC/C;AACI,MAAA,OAAO,aAAa,UAAU;AAChC,UAAM,IAAI,MAAM,GAAG,OAAO,gCAAgC;AAAA,EAC5D;AAEI,MAAA,OAAO,SAAS,aAAa,UAAU;AACzC,UAAM,UAAU,MAAM,QAAQ,SAAS,QAAe;AACtD,QAAI,YAAY,IAAI;AAClB,aAAO,MAAM;AAAA,IACf;AAAA,EACF;AAEA,MAAI,SAAS,SAAS;AACb,WAAA;AAAA,EACT;AAEA,MAAI,SAAS,QAAQ;AACZ,WAAA;AAAA,EACT;AAGA,MAAI,SAAS,UAAU;AACd,WAAA;AAAA,EACT;AAEM,QAAA,IAAI,MAAM,4BAA4B;AAC9C;AAEO,MAAM,SA0BX;AAAA,EAIA,YAAY,YAAmC,UAAoC,IAAI;AAH/E;AACA;AAGN,SAAK,aAAa;AAAA,MAChB,YAAY,CAAC;AAAA,MACb,UAAU,CAAC;AAAA,MACX,QAAQ,CAAC;AAAA,MACT,gBAAgB,CAAC;AAAA,MACjB,UAAU,CAAC;AAAA,MACX,YAAY,CAAC;AAAA,MACb,iBAAiB,CAAC;AAAA,MAClB,QAAQ,CAAC;AAAA,MACT,OAAO,CAAC;AAAA,MACR,SAAS,CAAC;AAAA,MACV,OAAO,CAAC;AAAA,MACR,GAAG;AAAA,IAAA;AAEL,SAAK,UAAU;AAAA,MACb,qBAAqB;AAAA,MACrB,uBAAuB;AAAA,MACvB,sBAAsB;AAAA,MACtB,GAAG;AAAA,IAAA;AAAA,EAEP;AAAA,EAEA,OAAO,IAAI,WAAmC;AAC5C,WAAO,IAAI,SAAS;AAAA,MAClB,YAAY,CAAC,SAAS;AAAA,MACtB,UAAU,CAAC,SAAS;AAAA,MACpB,QAAQ,CAAC,SAAS;AAAA,MAClB,gBAAgB,CAAC,SAAS;AAAA,MAC1B,UAAU,CAAC,SAAS;AAAA,MACpB,YAAY,CAAC,SAAS;AAAA,MACtB,iBAAiB,CAAC,SAAS;AAAA,MAC3B,QAAQ,CAAC,SAAS;AAAA,MAClB,OAAO,CAAC,SAAS;AAAA,MACjB,SAAS,CAAC,SAAS;AAAA,MACnB,OAAO,CAAC,SAAS;AAAA,IAAA,CAClB;AAAA,EACH;AAAA,EAEA,mBAAmB,YAAyC;AAC1D,WAAO,KAAK;AAAA,MACV,KAAK,oBAAoB,KAAK,gBAAgB,KAAK,wBAAwB,UAAU,CAAC,CAAC;AAAA,MACvF,KAAK,WAAW;AAAA,IAAA;AAAA,EAEpB;AAAA,EAEA,wBAAwB,YAAoC;AACtD,QAAA,KAAK,QAAQ,uBAAuB;AACtC,YAAM,UAAU;AAAA,QACd,IAAI,WAAW,aAAa,CAAI,GAAA,IAAI,CAAC,aAAa;AAC5C,cAAA,OAAO,aAAa,UAAU;AAChC,mBAAO,EAAE,OAAO,UAAU,SAAS,cAAc;AAAA,UACnD;AACO,iBAAA;AAAA,QAAA,CACR;AAAA,QACD,IAAI,WAAW,eAAe,CAAI,GAAA,IAAI,CAAC,kBAAkB;AACnD,cAAA,OAAO,kBAAkB,UAAU;AACrC,mBAAO,EAAE,OAAO,eAAe,SAAS,gBAAgB;AAAA,UAC1D;AACO,iBAAA;AAAA,QAAA,CACR;AAAA,QACD,GAAI,WAAW,WAAW,CAAC;AAAA,MAAA;AAG7B,aAAO,WAAW;AAClB,aAAO,WAAW;AAClB,iBAAW,UAAU;AAAA,IACvB;AAEA,QAAI,WAAW,WAAW;AACb,iBAAA,YAAY,WAAW,UAAU;AAAA,QAAI,CAAC,aAC/C,KAAK;AAAA,UACH,OAAO,aAAa,WACf,EAAE,OAAO,UAAU,SAAS,kBAC5B;AAAA,QACP;AAAA,MAAA;AAAA,IAEJ;AAEA,QAAI,WAAW,aAAa;AACf,iBAAA,cAAc,WAAW,YAAY;AAAA,QAAI,CAAC,kBACnD,KAAK;AAAA,UACH,OAAO,kBAAkB,WACpB,EAAE,OAAO,eAAe,SAAS,oBACjC;AAAA,QACP;AAAA,MAAA;AAAA,IAEJ;AAEA,QAAI,WAAW,SAAS;AACtB,iBAAW,UAAU,WAAW,QAAQ,IAAI,CAAC,WAAW;AAClD,YAAA,OAAO,WAAW,UAAU;AACvB,iBAAA;AAAA,QACT;AACO,eAAA,KAAK,gBAAgB,MAAM;AAAA,MAAA,CACnC;AAAA,IACH;AAEO,WAAA;AAAA,EACT;AAAA,EAEA,iBAAiB,UAAmC;AAClD,WAAO,KAAK;AAAA,MACV,KAAK,oBAAoB,KAAK,gBAAgB,KAAK,sBAAsB,QAAQ,CAAC,CAAC;AAAA,MACnF,KAAK,WAAW;AAAA,IAAA;AAAA,EAEpB;AAAA,EAEA,sBAAsB,UAA8B;AAClD,QAAI,SAAS,WAAW;AACb,eAAA,YAAY,SAAS,UAAU,IAAI,CAAC,aAAa,KAAK,iBAAiB,QAAQ,CAAC;AAAA,IAC3F;AACA,QAAI,SAAS,YAAY;AACd,eAAA,aAAa,SAAS,WAAW,IAAI,CAAC,cAAc,KAAK,cAAc,SAAS,CAAC;AAAA,IAC5F;AACO,WAAA;AAAA,EACT;AAAA,EAEA,iBAAiB,UAAmC;AAClD,WAAO,KAAK;AAAA,MACV,KAAK,oBAAoB,KAAK,gBAAgB,KAAK,sBAAsB,QAAQ,CAAC,CAAC;AAAA,MACnF,KAAK,WAAW;AAAA,IAAA;AAAA,EAEpB;AAAA,EAEA,sBAAsB,UAA8B;AAClD,QAAI,SAAS,UAAU;AACZ,eAAA,WAAW,SAAS,SAAS,IAAI,CAAC,WAAW,KAAK,eAAe,MAAM,CAAC;AAAA,IACnF;AACO,WAAA;AAAA,EACT;AAAA,EAEA,eAAe,QAA6B;AAC1C,WAAO,KAAK;AAAA,MACV,KAAK,oBAAoB,KAAK,gBAAgB,KAAK,oBAAoB,MAAM,CAAC,CAAC;AAAA,MAC/E,KAAK,WAAW;AAAA,IAAA;AAAA,EAEpB;AAAA,EAEA,oBAAoB,QAAwB;AAC1C,QAAI,OAAO,QAAQ;AACV,aAAA,SAAS,OAAO,OAAO,IAAI,CAAC,UAAU,KAAK,mBAAmB,KAAK,CAAC;AAAA,IAC7E;AACA,QAAI,OAAO,cAAc;AAChB,aAAA,eAAe,OAAO,aAAa,IAAI,CAAC,mBAAmB,KAAK,uBAAuB,cAAc,CAAC;AAAA,IAC/G;AACO,WAAA;AAAA,EACT;AAAA,EAEA,cAAc,OAA0B;AACtC,WAAO,KAAK;AAAA,MACV,KAAK,oBAAoB,KAAK,gBAAgB,KAAK,mBAAmB,KAAK,CAAC,CAAC;AAAA,MAC7E,KAAK,WAAW;AAAA,IAAA;AAAA,EAEpB;AAAA,EAEA,mBAAmB,OAAqB;AAClC,QAAA,KAAK,QAAQ,uBAAuB;AACtC,YAAM,UAAU;AAAA,QACd,IAAI,MAAM,UAAU,CAAI,GAAA,IAAI,CAAC,eAAoB;AAC3C,cAAA,OAAO,eAAe,UAAU;AAClC,mBAAO,EAAE,OAAO,YAAY,SAAS,WAAW;AAAA,UAClD;AACO,iBAAA;AAAA,QAAA,CACR;AAAA,QACD,IAAI,MAAM,YAAY,CAAI,GAAA,IAAI,CAAC,WAAgB;AACzC,cAAA,OAAO,WAAW,UAAU;AAC9B,mBAAO,EAAE,OAAO,QAAQ,SAAS,YAAY;AAAA,UAC/C;AACO,iBAAA;AAAA,QAAA,CACR;AAAA,QACD,GAAI,MAAM,WAAW,CAAC;AAAA,MAAA;AAGxB,aAAO,MAAM;AACb,aAAO,MAAM;AACP,YAAA,UAAU,QAAQ,SAAS,QAAQ,IAAI,CAAC,WAAW,KAAK,gBAAgB,MAAM,CAAC,IAAI;AAAA,IAC3F;AACO,WAAA;AAAA,EACT;AAAA,EAEA,uBAAuB,gBAAqD;AACpE,UAAA,OACJ,OAAO,mBAAmB,WACrB,EAAE,OAAO,gBAAgB,SAAS,oBACnC,IAAA;AAEN,WAAO,KAAK;AAAA,MACV,KAAK,oBAAoB,KAAK,4BAA4B,IAAI,CAAC;AAAA,MAC/D,KAAK,WAAW;AAAA,IAAA;AAAA,EAEpB;AAAA,EAEA,4BAA4B,gBAAgD;AAC1E,QAAI,eAAe,WAAW;AACb,qBAAA,YAAY,eAAe,UAAU,IAAI,CAAC,eAAe,KAAK,mBAAmB,UAAU,CAAC;AAAA,IAC7G;AAEO,WAAA;AAAA,EACT;AAAA,EAEA,mBAAmB,YAAyC;AAC1D,WAAO,KAAK;AAAA,MACV,KAAK,oBAAoB,KAAK,gBAAgB,KAAK,wBAAwB,UAAU,CAAC,CAAC;AAAA,MACvF,KAAK,WAAW;AAAA,IAAA;AAAA,EAEpB;AAAA,EAEA,wBAAwB,YAAoC;AAC1D,QAAI,WAAW,UAAU;AACvB,UAAI,MAAM,QAAQ,WAAW,QAAQ,GAAG;AAC3B,mBAAA,WAAW,WAAW,SAAS;AAAA,UAAI,CAAC,QAC7C,KAAK,wBAAwB,GAA4B;AAAA,QAAA;AAAA,MAC3D,OACK;AACL,mBAAW,WAAW,KAAK,wBAAwB,WAAW,QAAiC;AAAA,MACjG;AAAA,IACF;AAEA,QAAI,WAAW;AAAI;AAKZ,WAAA;AAAA,EACT;AAAA,EAEA,cAAc,OAA0B;AAC/B,WAAA,KAAK,aAAa,KAAK,gBAAgB,KAAK,mBAAmB,KAAK,CAAC,GAAG,KAAK,WAAW,KAAK;AAAA,EACtG;AAAA,EAEA,mBAAmB,OAAqB;AACtC,QAAI,MAAM,cAAc;AAChB,YAAA,eAAe,MAAM,aAAa,IAAI,CAAC,mBAAmB,KAAK,uBAAuB,cAAc,CAAC;AAAA,IAC7G;AACO,WAAA;AAAA,EACT;AAAA,EAEA,eAAe,QAA4C;AAClD,WAAA,KAAK,aAAa,KAAK,oBAAoB,MAAM,GAAG,KAAK,WAAW,MAAM;AAAA,EACnF;AAAA,EAEA,oBAAoB,QAA+B;AACjD,QAAI,OAAO,WAAW,OAAO,YAAY,WAAW;AAClD,aAAO,UAAU,KAAK,wBAAwB,OAAO,OAAO;AAAA,IAC9D;AACA,QAAI,OAAO,QAAQ,OAAO,SAAS,WAAW;AACrC,aAAA,OAAO,OAAO,KAAK,IAAI,CAAC,SAAS,KAAK,wBAAwB,IAAI,CAAC;AAAA,IAC5E;AAEO,WAAA;AAAA,EACT;AAAA,EAEA,gBAAgB,SAAgC;AACvC,WAAA,KAAK,aAAa,KAAK,gBAAgB,OAAc,GAAG,KAAK,WAAW,OAAO;AAAA,EACxF;AAAA,EAEA,wBAAwB,iBAA8D;AAChF,QAAA,gBAAgB,aAAa,aAAa;AACrC,aAAA,KAAK,eAAe,eAAsB;AAAA,IACnD;AAEA,WAAO,KAAK;AAAA,MACV,KAAK,oBAAoB,KAAK,gBAAgB,eAAsB,CAAC;AAAA,MACrE,KAAK,WAAW;AAAA,IAAA;AAAA,EAEpB;AAAA,EAEA,gBAAgB,MAAW;AACzB,QAAI,CAAC,KAAK,YAAY,OAAO,SAAS,UAAU;AAEvC,aAAA;AAAA,IACT;AACQ,YAAA,iBAAiB,IAAI,GAAG;AAAA,MAC9B,KAAK;AACI,eAAA,KAAK,mBAAmB,IAAI;AAAA,MACrC,KAAK;AACI,eAAA,KAAK,iBAAiB,IAAI;AAAA,MACnC,KAAK;AACI,eAAA,KAAK,eAAe,IAAI;AAAA,MACjC,KAAK;AACI,eAAA,KAAK,iBAAiB,IAAI;AAAA,MACnC,KAAK;AACI,eAAA,KAAK,cAAc,IAAI;AAAA,MAChC,KAAK;AACI,eAAA,KAAK,mBAAmB,IAAI;AAAA,MACrC,KAAK;AACI,eAAA,KAAK,uBAAuB,IAAI;AAAA,MACzC,KAAK;AACI,eAAA,KAAK,cAAc,IAAI;AAAA,MAChC,KAAK;AACI,eAAA,KAAK,gBAAgB,IAAI;AAAA,MAClC,KAAK;AACI,eAAA,KAAK,eAAe,IAAI;AAAA,MACjC,KAAK;AACI,eAAA,KAAK,wBAAwB,IAAI;AAAA,IAC5C;AAEA,QAAI,KAAK,SAAS;AACT,aAAA,KAAK,gBAAgB,IAAI;AAAA,IAClC;AAEO,WAAA;AAAA,EACT;AAAA,EAEA,sBAAsB,iBAAsD;AACpE,UAAA,WAAW,MAAM,QAAQ,eAAe;AAC9C,UAAM,eAAe,MAAM,QAAQ,eAAe,IAAI,kBAAkB,CAAC,eAAe;AACxF,UAAM,kBAAyB,CAAA;AAE/B,eAAW,kBAAkB,cAAc;AACrC,UAAA,OAAO,mBAAmB,UAAU;AACtB,wBAAA;AAAA,UACd,KAAK,wBAAwB;AAAA,YAC3B,OAAO;AAAA,YACP,SAAS;AAAA,UAAA,CACV;AAAA,QAAA;AAAA,MACH,OACK;AACL,wBAAgB,KAAK,KAAK,wBAAwB,cAAqB,CAAC;AAAA,MAC1E;AAAA,IACF;AAEA,QAAI,CAAC,YAAY,CAAC,KAAK,QAAQ,qBAAqB;AAClD,aAAO,gBAAgB;AAAA,IACzB;AAEO,WAAA;AAAA,EACT;AAAA,EAEA,oBAAiF,UAAa;AAC5F,QAAI,SAAS,WAAW;AACtB,eAAS,YAAY,KAAK,sBAAsB,SAAS,SAAS;AAAA,IACpE;AAEA,QAAI,SAAS,MAAM;AACjB,eAAS,OAAO,KAAK,sBAAsB,SAAS,IAAI;AAAA,IAC1D;AAEO,WAAA;AAAA,EACT;AAAA,EAEA,0BAA0B,aAA6B;AAC/C,UAAA,WAAW,MAAM,QAAQ,WAAW;AAC1C,UAAM,WAAW,MAAM,QAAQ,WAAW,IAAI,cAAc,CAAC,WAAW;AACxE,UAAM,cAAc,CAAA;AACpB,eAAW,WAAW,UAAU;AAC9B,kBAAY,KAAK,KAAK,gBAAgB,OAAO,CAAC;AAAA,IAChD;AAEA,QAAI,CAAC,YAAY,CAAC,KAAK,QAAQ,qBAAqB;AAClD,aAAO,YAAY;AAAA,IACrB;AAEO,WAAA;AAAA,EACT;AAAA,EAEA,gBAAsD,UAAa;AACjE,QAAI,SAAS,SAAS;AACpB,eAAS,UAAU,KAAK,sBAAsB,SAAS,SAAS,KAAK,WAAW,eAAe;AAAA,IACjG;AACA,QAAI,SAAS,WAAW;AACtB,eAAS,YAAY,KAAK,sBAAsB,SAAS,WAAW,KAAK,WAAW,eAAe;AAAA,IACrG;AACA,QAAI,SAAS,SAAS;AACpB,eAAS,UAAU,KAAK,0BAA0B,SAAS,OAAO;AAAA,IACpE;AACA,QAAI,SAAS,SAAS;AACpB,eAAS,UAAU,KAAK,sBAAsB,SAAS,SAAS,KAAK,WAAW,eAAe;AAAA,IACjG;AACA,QAAI,SAAS,QAAQ;AACf,UAAA,OAAO,SAAS,WAAW;AAAU;AAAA,WAElC;AACL,iBAAS,SAAS,KAAK;AAAA,UACrB,SAAS;AAAA,UACT,KAAK,WAAW;AAAA,QAAA;AAAA,MAEpB;AAAA,IACF;AACA,QAAI,SAAS,aAAa;AACpB,UAAA,OAAO,SAAS,gBAAgB,UAAU;AAC5C,iBAAS,cAAc,KAAK;AAAA,UAC1B,EAAE,OAAO,SAAS,aAAa,SAAS,YAAY;AAAA,UACpD,KAAK,WAAW;AAAA,QAAA;AAAA,MAClB,WACS,SAAS,aAAa;AAC/B,aAAK,aAAa,SAAS,aAAoB,KAAK,WAAW,MAAM;AAAA,MACvE;AAAA,IACF;AACA,QAAI,SAAS,cAAc;AACrB,UAAA,OAAO,SAAS,iBAAiB,UAAU;AACpC,iBAAA,eAAe,KAAK,cAAc;AAAA,UACzC,OAAO,SAAS;AAAA,UAChB,SAAS;AAAA,QAAA,CACV;AAAA,MAAA,OACI;AACL,iBAAS,eAAe,KAAK,cAAc,SAAS,YAAY;AAAA,MAClE;AAAA,IACF;AACO,WAAA;AAAA,EACT;AAAA,EAEA,sBAAqC,QAAiB,YAAyC;AAC7F,QAAI,CAAC,MAAM,QAAQ,MAAM,GAAG;AACtB,UAAA,KAAK,QAAQ,qBAAqB;AACpC,iBAAS,CAAC,MAAM;AAAA,MAAA,OACX;AACE,eAAA,KAAK,aAAa,QAAQ,UAAU;AAAA,MAC7C;AAAA,IACF;AACO,WAAA,OAAO,IAAI,CAAC,cAAc,KAAK,aAAa,WAAW,UAAU,CAAC;AAAA,EAC3E;AAAA,EAEA,aAA4B,QAAW,YAAyC;AAC9E,WAAO,WAAW,OAAO,CAAC,KAAQ,cAA+B;AACzD,YAAA,cAAc,UAAU,GAAG;AACjC,UAAI,OAAO,gBAAgB,eAAe,CAAC,KAAK,QAAQ,sBAAsB;AACrE,eAAA;AAAA,MACT;AACO,aAAA;AAAA,OACN,MAAM;AAAA,EACX;AACF;AClhBO,MAAM,mCAAmC;AACzC,MAAM,mCAAmC;AACzC,MAAM,mCAAmC;AACzC,MAAM,oCAAoC;AAC1C,MAAM,oCAAoC;AAC1C,MAAM,oCAAoC;AAC1C,MAAM,qCACX;AACK,MAAM,qCACX;AACK,MAAM,qCACX;AACK,MAAM,sCACX;AACK,MAAM,sCACX;AACK,MAAM,sCACX;AACK,MAAM,uBAAuB;AAC7B,MAAM,+BAA+B;AACrC,MAAM,uBAAuB;AAC7B,MAAM,+BAA+B;AACrC,MAAM,uBAAuB;AAC7B,MAAM,+BAA+B;AACrC,MAAM,uBAAuB;AAC7B,MAAM,+BAA+B;AACrC,MAAM,uBAAuB;AAC7B,MAAM,+BAA+B;AACrC,MAAM,uBAAuB;AAC7B,MAAM,+BAA+B;AACrC,MAAM,uBAAuB;AAC7B,MAAM,uBAAuB;AAC7B,MAAM,uBAAuB;AAG7B,MAAM,+BAA+B;AACrC,MAAM,+BAA+B;AACrC,MAAM,+BAA+B;AAErC,MAAM,gBAAgB;AAAA,EAC3B;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAEO,MAAM,uBAAuB;AAAA,EAClC;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AC7FO,SAAS,YAAe,YAA0B;AACnD,MAAA,MAAM,QAAQ,UAAU,GAAG;AACtB,WAAA;AAAA,EACT;AACA,SAAO,CAAC,UAAU;AACpB;ACCA,MAAM,gBAAgB;AAAA,EACpB,kBAAkB;AAAA,EAClB,MAAM;AAAA,EACN,YAAY;AAAA,EACZ,cAAc;AAChB;AAEgB,SAAA,uBACd,mBACA,cAAc,QACqB;AACnC,MAAI,CAAC,mBAAmB;AACtB,WAAO;EACT;AAEA,QAAM,gBAAgB,MAAM,QAAQ,iBAAiB,IAAI,oBAAoB,CAAC,iBAAiB;AAE/F,QAAM,cAAiD,CAAA;AAEvD,aAAW,YAAY,eAAe;AAEhC,QAAA,OAAO,aAAa,UAAU;AAChC,kBAAY,eAAe,YAAY,eAAe,YAAY,eAAe;AAChF,kBAAY,aAA0B,KAAK,YAAY,EAAE;AAC1D;AAAA,IACF;AAGI,QAAA,CAAC,SAAS,cAAc;AAC1B,kBAAY,eAAe,YAAY,eAAe,YAAY,eAAe;AAChF,kBAAY,aAA0B,KAAK,SAAS,aAAa,EAAE;AACpE;AAAA,IACF;AAGA,UAAM,OAAO,SAAS;AACtB,gBAAY,QAAQ,YAAY,QAAQ,YAAY,QAAQ;AAC3D,gBAAY,MAAmB,KAAK,SAAS,aAAa,EAAE;AAAA,EAC/D;AACO,SAAA;AACT;AAEO,SAAS,WAAW,SAA0C;AAC/D,MAAA,MAAM,QAAQ,OAAO,GAAG;AACnB,WAAA,WAAW,QAAQ,KAAK,CAAC,MAAM,OAAO,MAAM,QAAQ,CAAC;AAAA,EAC9D;AAEA,MAAI,qBAAqB,QAAQ,OAAO,MAAM,IAAI;AACzC,WAAA;AAAA,EACT;AAEA,MAAI,cAAc,QAAQ,OAAO,MAAM,IAAI;AAClC,WAAA;AAAA,EACT;AAEI,MAAA,OAAO,YAAY,UAAU;AACxB,WAAA;AAAA,EACT;AAEO,SAAA;AACT;AAEO,SAAS,mBAAmB,eAAsD;AACvF,QAAM,WAAqB,MAAM,QAAQ,aAAa,IAAI,gBAAgB,CAAC,aAAa;AAExF,aAAW,WAAW,UAAU;AAC9B,YAAQ,SAAS;AAAA,MACf,KAAK;AAAA,MACL,KAAK;AACI,eAAA;AAAA,MACT,KAAK;AAAA,MACL,KAAK;AACI,eAAA;AAAA,MACT,KAAK;AACI,eAAA;AAAA,IACX;AAAA,EACF;AAEO,SAAA;AACT;AAEA,SAAS,mBAAmB,cAA0C;AACpE,UAAQ,cAAc;AAAA,IACpB,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AACI,aAAA;AAAA,IAET,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AAAA,IACL,KAAK;AACI,aAAA;AAAA,IAET,KAAK;AAAA,IACL,KAAK;AACI,aAAA;AAAA,IACT,KAAK;AAAA,IACL,KAAK;AACI,aAAA;AAAA,IAET,KAAK;AAAA,IACL,KAAK;AACI,aAAA;AAAA,IACT,KAAK;AAAA,IACL,KAAK;AACI,aAAA;AAAA,EACX;AAEO,SAAA;AACT;AAEA,SAAS,aAAa,KAAa;AACjC,aAAW,UAAU,CAAC,MAAM,MAAM,WAAW,WAAW,MAAM,GAAG;AAC/D,QAAI,IAAI,WAAW,GAAG,SAAS,GAAG;AAChC,aAAO,IAAI,MAAM,OAAO,SAAS,CAAC;AAAA,IACpC;AAAA,EACF;AAEO,SAAA;AACT;AAEA,MAAM,aAAa,CAAC,cAAc,YAAY,cAAc,kBAAkB,SAAS,SAAS;AAEhG,SAAS,WAAW,UAAuB;AACnC,QAAA,KAAK,SAAS,UAAU,SAAS;AACnC,MAAA,UAA6B,SAAS,YAAY,SAAS;AACzD,QAAA,UAAe,SAAS,WAAW;AACnC,QAAA,UAAe,SAAS,eAAe;AAE7C,MAAI,SAAS;AACL,UAAA,eAAe,mBAAmB,OAAO;AAC/C,QAAI,cAAc;AACT,aAAA;AAAA,IACT;AAAA,EACF;AAEA,MAAI,SAAS;AACL,UAAA,eAAe,mBAAmB,OAAO;AAC/C,QAAI,cAAc;AACT,aAAA;AAAA,IACT;AAAA,EACF;AAEA,MAAI,SAAS;AACP,QAAA,MAAM,QAAQ,OAAO,GAAG;AAC1B,UAAI,QAAQ,QAAQ,kBAAkB,MAAM,IAAI;AACvC,eAAA;AAAA,MACT;AACA,UAAI,QAAQ,QAAQ,mBAAmB,MAAM,IAAI;AACxC,eAAA;AAAA,MACT;AAEA,gBAAU,QAAQ;AAAA,IACpB;AAEA,eAAW,UAAU,CAAC,MAAM,MAAM,WAAW,WAAW,MAAM,GAAG;AAC/D,UAAI,QAAQ,WAAW,GAAG,SAAS,GAAG;AACpC,kBAAU,QAAQ,MAAM,OAAO,SAAS,CAAC;AACzC;AAAA,MACF;AAAA,IACF;AAEA,YAAQ,SAAS;AAAA,MACf,KAAK;AACI,eAAA;AAAA,MACT,KAAK;AACI,eAAA;AAAA,MACT,KAAK;AACI,eAAA;AAAA,IAEX;AAAA,EACF;AAEA,MAAI,WAAW,WAAW,QAAQ,OAAO,MAAM,IAAI;AAC1C,WAAA;AAAA,EACT;AAEA,MAAI,SAAS,QAAQ;AACnB,QAAI,SAAS,OAAO,WAAW,QAAQ,GAAG;AACjC,aAAA;AAAA,IACT;AACA,QAAI,SAAS,OAAO,WAAW,OAAO,GAAG;AAChC,aAAA;AAAA,IACT;AACI,QAAA,SAAS,WAAW,mBAAmB;AAClC,aAAA;AAAA,IACT;AACA,QAAI,SAAS,OAAO,WAAW,cAAc,GAAG;AACvC,aAAA;AAAA,IACT;AAAA,EACF;AAEA,MAAI,OAAO,GAAG,SAAS,MAAM,KAAK,GAAG,SAAS,MAAM,KAAK,GAAG,SAAS,OAAO,IAAI;AACvE,WAAA;AAAA,EACT;AAEA,MAAI,CAAC,SAAS;AACL,WAAA;AAAA,EACT;AAGO,SAAA;AACT;AAEA,MAAM,eAAe;AAErB,SAAS,eAAe,SAAiB;AACjC,QAAA,UAAU,QAAQ,MAAM,YAAY;AAC1C,MAAI,SAAS;AACX,WAAO,QAAQ;AAAA,EACjB;AAEO,SAAA;AACT;AAeA,SAAS,WACP,SACA,eAAe,kBACf,OAAO,QAC2F;AAClG,MAAI,SAAwD;AAC5D,QAAM,WAA4D,CAAA;AAElE,QAAM,cAAc,MAAM,QAAQ,OAAO,IAAI,UAAU,CAAC,OAAO;AAE/D,aAAW,cAAc,aAAa;AACpC,UAAM,gBAAgB,aAAa,eAAe,UAAU,IAAI;AAG9D,QAAA,kBACC,cAAc,QAAQ,qBAAqB,MAAM,MAAM,cAAc,QAAQ,sBAAsB,MAAM,KAC1G;AACI,UAAA,cAAc,WAAW,UAAU,GAAG;AAC/B,iBAAA,UAAU,cAAc,MAAM,CAAC;AAAA,MAAA,OACnC;AACI,iBAAA;AAAA,MACX;AACA;AAAA,IACF;AACA,QAAI,eAAe;AACjB,eAAS,KAAK;AAAA,QACZ,OAAO,EAAE,CAAC,OAAO,CAAC,YAAY,EAAE;AAAA,QAChC,OAAO,EAAE,CAAC,OAAO,CAAC,aAAa,EAAE;AAAA,MAAA,CAClC;AAAA,IACH;AAAA,EACF;AAEO,SAAA,CAAC,QAAQ,QAAQ;AAC1B;AAEA,MAAM,iBAAiB;AAAA,EACrB;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAEA,SAAS,WAAW,cAA4E;AAC9F,MAAI,cAAc;AAChB,UAAM,WAAW,MAAM,QAAQ,YAAY,IAAI,eAAe,CAAC,YAAY;AAE3E,UAAM,cAAc,CAAA;AACpB,eAAW,WAAW,UAAU;AAC9B,UAAI,YAAY,kDAAkD;AAChE,oBAAY,KAAK,gDAAgD;AAAA,MACnE;AACA,UAAI,eAAe,QAAQ,OAAO,MAAM,IAAI;AAC1C;AAAA,MACF;AACA,kBAAY,KAAK,OAAO;AAAA,IAC1B;AAEA,QAAI,SAAS,QAAQ;AACnB,aAAO,YAAY,WAAW,IAAI,YAAY,KAAK;AAAA,IACrD;AAAA,EACF;AAEO,SAAA;AACT;AAEA,SAAS,gBACP,UACiD;AACjD,MAAI,CAAC,UAAU;AACb,WAAO;EACT;AAEO,SAAA,SAAS,IAAI,CAAC,SAAqC;AACjD,WAAA;AAAA,MACL,OAAO,uBAAuB,KAAK,KAAK;AAAA,MACxC,OAAO,uBAAuB,KAAK,KAAK;AAAA,IAAA;AAAA,EAC1C,CACD;AACH;AAEA,SAAS,0BAA0B,KAAU;AAC3C,aAAW,QAAQ,KAAK;AACtB,QAAI,OAAO,IAAI,UAAU,eAAe,IAAI,UAAU,MAAM;AAC1D,aAAO,IAAI;AAAA,IACb;AAAA,EACF;AACO,SAAA;AACT;AAEA,IAAI,kBAAkB;AAEtB,SAAS,sBACP,UACA,aACA;AACM,QAAA,SAAS,UAAW,SAA6B,MAAM,SAAS,UAAU,EAAE,EAAE;AAEpF,MAAI,UAAU,aAAa;AACzB,WAAO,GAAG,UAAU;AAAA,EACtB;AAEA,MAAI,QAAQ;AACH,WAAA;AAAA,EACT;AAEA;AAGA,SAAO,sBAAsB,SAAS,WAAW,cAAc,IAAI,gBAAgB,MAAM;AAC3F;AAOA,SAAS,oBACP,UAMA;AACA,QAAM,gBAAgB,CAAC,GAAI,SAAS,YAAY,CAAG,CAAA;AAEnD,MAAI,SAAS,aAAa;AACV,kBAAA,KAAK,SAAS,WAAW;AAAA,EACzC;AAEI,MAAA;AACJ,MAAI,MAAM,QAAQ,SAAS,UAAU,GAAG;AACzB,iBAAA,SAAS,WAAW,IAAI,YAAY;AAAA,EAAA,WACxC,SAAS,YAAY;AACjB,iBAAA,aAAa,SAAS,UAAU;AAAA,EAC/C;AAEO,SAAA;AAAA,IACL,YAAY,SAAS,cAAc,WAAW,SAAS,WAAW,IAAI;AAAA,IACtE,KAAK,SAAS,UAAU,sBAAsB,QAAQ,GAAG,KAAK;AAAA,IAC9D,MAAM,WAAW,QAAQ;AAAA,IACzB,UAAU,cAAc,SAAS,gBAAgB;AAAA,IAEjD,QAAQ,SAAS,SAAS,SAAS,SAAS;AAAA,IAC5C,OAAO,SAAS,QAAQ,SAAS,QAAQ;AAAA,IACzC;AAAA,IACA,kBAAkB,SAAS;AAAA,IAC3B,SAAS,SAAS;AAAA,IAClB,QAAQ,SAAS,SAAS,SAAS,SAAS;AAAA,IAC5C,UAAU;AAAA,IACV,UAAU;AAAA,EAAA;AAEd;AAEA,SAAS,sBACP,UAGG;AACH,QAAM,CAAC,QAAQ,aAAa,IAAI,WAAW,SAAS,OAAO;AAC3D,QAAM,cAAc,CAAC,GAAI,SAAS,WAAW,gBAAgB,SAAS,QAAQ,IAAI,IAAK,GAAG,aAAa;AAEhG,SAAA;AAAA,IACL;AAAA,IACA,UAAU,YAAY,SAAS,cAAc;AAAA,IAC7C,OAAO,SAAS,QAAQ,uBAAuB,SAAS,KAAK,IAAI;AAAA,IACjE,mBAAmB,SAAS,cACxB;AAAA,MACE,OAAO,uBAAuB,cAAc,gBAAgB;AAAA,MAC5D,OAAO,uBAAuB,SAAS,WAAW;AAAA,IAEpD,IAAA;AAAA,IACJ,SAAS,SAAS;AAAA,IAClB,SAAS,SAAS,cAAc,uBAAuB,SAAS,WAAW,IAAI;AAAA,IAC/E,WAAW,SAAS;AAAA,EAAA;AAExB;AAEA,SAAS,YAAY,UAAiG;AAChH,MAAA,CAAC,SAAS,QAAQ;AACb,WAAA;AAAA,EACT;AAEM,QAAA,mBAAmB,MAAM,QAAQ,SAAS,MAAM,IAAI,SAAS,SAAS,CAAC,SAAS,MAAM;AAC5F,QAAM,eAA0D,CAAA;AAEhE,aAAW,UAAU,kBAAkB;AACjC,QAAA,OAAO,WAAW,UAAU;AAC9B,UAAI,QAAQ;AACV,gBAAQ,SAAS,UAAU;AAAA,UACzB,KAAK;AACH,yBAAa,KAAK,EAAE,IAAI,QAAQ,MAAM,cAAc;AACpD;AAAA,QAEJ;AAAA,MACF;AAAA,IAAA,WACU,OAAe,QAAQ;AACjC,mBAAa,KAAK;AAAA,QAChB,IAAK,OAAe;AAAA,QACpB,MAAM,WAAW,MAAM;AAAA,MAAA,CACxB;AAAA,IAAA;AACI;AAAA,EAGT;AAEO,SAAA,aAAa,SAAS,eAAe;AAC9C;AAEA,SAAS,kBAAkB,UAA4E;AAGrG,QAAM,UAAU,SAAS,UAAW,MAAM,QAAQ,SAAS,OAAO,IAAI,SAAS,UAAU,CAAC,SAAS,OAAO,IAAK,CAAA;AAC/G,QAAM,QAAQ,SAAS;AAEhB,SAAA;AAAA,IACL,UACE,SAAS,QAAQ,QAAQ,SACrB;AAAA,MACE;AAAA,QACE,IAAI,cAAc;AAAA,QAClB,MAAM;AAAA,QACN,UAAU,QAAQ,SAAS,CAAC,QAAQ,EAAS,IAAI;AAAA,QACjD,MAAM,SAAS,OAAQ,MAAM,QAAQ,SAAS,IAAI,IAAI,SAAS,OAAO,CAAC,SAAS,IAAI,IAAK;AAAA,QACzF,OAAO,uBAAuB,cAAc,YAAY;AAAA,MAC1D;AAAA,IAEF,IAAA;AAAA,IACN,QAAQ,YAAY,QAAQ;AAAA,IAC5B,WAAW,SAAS;AAAA,IACpB,SAAS,SAAS;AAAA,IAClB,OAAO,SAAS;AAAA,IAChB,SAAS,SAAS,UAAU,YAAY,SAAS,OAAc,IAAI;AAAA,IACnE,eAAe,QAAQ,CAAC,KAAY,IAAI;AAAA,EAAA;AAE5C;AAGA,SAAS,0BAA0B,UAA8C;AACxE,SAAA;AAAA,IACL,OAAO,SAAS;AAAA,IAChB,QAAQ,SAAS,SAAS,SAAS,SAAS;AAAA,IAC5C,UAAU,SAAS;AAAA,EAAA;AAEvB;AAEA,SAAS,kBAAkB,YAAgE;AACzF,SAAO,0BAA0B;AAAA,IAC/B,GAAG,oBAAoB,UAAU;AAAA,IACjC,GAAG,sBAAgG,UAAU;AAAA,IAC7G,GAAG,kBAAkB,UAAU;AAAA,IAC/B,OAAO,WAAW;AAAA,EAAA,CACnB;AACH;AAUA,SAAS,gBAAgB,UAA0D;AACjF,QAAM,cAAc,CAAA;AACpB,QAAM,WAAW,CAAA;AACjB,aAAW,YAAY,SAAS,aAAa,CAAA,GAAI;AAC3C,QAAA,SAAS,SAAS,QAAQ;AAChB,kBAAA,KAAK,GAAG,SAAS,QAAQ;AAAA,IACvC;AACA,QAAI,SAAS,UAAU;AACZ,eAAA,KAAK,GAAG,SAAS,QAAQ;AAAA,IACpC;AAAA,EACF;AAGM,QAAA,YAAY,oBAAoB,QAAQ;AAC9C,MAAI,SAAS,QAAQ;AACnB,QAAI,UAAU,UAAU;AACZ,gBAAA,SAAS,KAAK,GAAG,QAAQ;AAAA,IAAA,OAC9B;AACL,gBAAU,WAAW;AAAA,IACvB;AAAA,EACF;AAEA,SAAO,0BAA0B;AAAA,IAC/B,GAAG;AAAA,IACH,GAAG,sBAAsB,QAAQ;AAAA,IACjC,GAAG,kBAAkB,QAAQ;AAAA,IAC7B,OAAO;AAAA,IACP,YAAY,SAAS;AAAA,EAAA,CACtB;AACH;AAEA,SAAS,cAAc,QAAoD;AACzE,SAAO,0BAA0B;AAAA,IAC/B,GAAG,oBAAoB,MAAM;AAAA,IAC7B,GAAG,sBAAsB,MAAM;AAAA,IAC/B,GAAG,kBAAkB,MAAM;AAAA,IAC3B,aAAa,OAAO,gBAAgB,OAAO,aAAa,SAAU,OAAO,eAAyB;AAAA,IAClG,OACE,OAAO,UAAU,OAAO,OAAO,SAC3B;AAAA,MACE;AAAA,QACE,IAAI,sBAAsB,QAAQ,iBAAiB;AAAA,QACnD,MAAM;AAAA,QACN,OAAO,OAAO;AAAA,MAChB;AAAA,IAEF,IAAA;AAAA,EAAA,CACP;AACH;AAEA,SAAS,sBAAsB,gBAA4E;AACzG,SAAO,0BAA0B;AAAA,IAC/B,GAAI,oBAAoB,cAAc;AAAA,IACtC,GAAI,sBAAsB,cAAc;AAAA,IACxC,GAAI,kBAAkB,cAAc;AAAA,IACpC,OAAO,eAAe,aAAa,eAAe,UAAU,SAAU,eAAe,YAAoB;AAAA,EAAA,CAC1G;AACH;AAEA,SAAS,gBAAgB,UAGvB;AAmBA,MAAI,CAAC,SAAS,YAAY,SAAS,SAAS,WAAW,GAAG;AACjD,WAAA;AAAA,MACL,UAAU,CAAC;AAAA,MACX,UAAU,CAAC;AAAA,IAAA;AAAA,EAEf;AAGO,SAAA;AAAA,IACL,UAAU,SAAS;AAAA,IACnB,UAAU,SAAS,cAAc,CAAC,SAAS,WAAW,IAAI,CAAC;AAAA,EAAA;AAE/D;AAEA,SAAS,kBAAkB,YAAgE;AACzF,WAAS,cAAc,QAA8D;AAC/E,QAAA,MAAM,QAAQ,MAAM,GAAG;AACrB,UAAA,OAAO,SAAS,GAAG;AACrB,eAAO,EAAE,MAAM,QAAQ,OAAO,OAAO,IAAI,aAAa;MACxD;AACA,eAAS,OAAO;AAAA,IAClB;AACI,QAAA,OAAO,WAAW,UAAU;AACvB,aAAA,UAAU,MAAM,EAAE;IAAK,WACrB,WAAW,QAAQ;AACxB,UAAA;AACA,UAAA,OAAO,OAAO,SAAS,UAAU;AACnC,iBAAS,OAAO;AAAA,MACP,WAAA,OAAO,KAAK,aAAa,iBAAiB;AACnD,iBAAS,EAAE,IAAI,OAAO,KAAK,QAAQ,MAAM;MAChC,WAAA,OAAO,KAAK,aAAa,aAAa;AAC/C,iBAAS,EAAE,IAAI,OAAO,KAAK,QAAQ,MAAM;MAAS,OAC7C;AACL,cAAM,IAAI,MAAM,0CAA0C,OAAO,KAAK,UAAU;AAAA,MAClF;AACO,aAAA;AAAA,QACL,MAAM;AAAA,QACN;AAAA,QACA,UAAU,gBAAgB,OAAO,QAAQ;AAAA,MAAA;AAAA,IAC3C,OACK;AACL,aAAO,UAAU,OAAO,MAAM,EAAE,KAAK;AAAA,IACvC;AAAA,EACF;AACA,SAAO,0BAA0B;AAAA,IAC/B,GAAI,oBAAoB,UAAU;AAAA,IAClC,GAAI,sBAAsB,UAAU;AAAA,IACpC,GAAI,kBAAkB,UAAU;AAAA,IAChC,QAAQ,cAAc,WAAW,EAAE;AAAA,IACnC,MAAM,MAAM,QAAQ,WAAW,QAAQ,IACnC,WAAW,SAAS,IAAI,sBAAsB,IAC9C,uBAAuB,WAAW,QAAQ;AAAA,EAAA,CAE/C;AACH;AAEA,SAAS,uBAAuB,sBAAoF;AAClH,QAAM,kBAAkB;AAExB,SAAO,0BAA0B;AAAA,IAC/B,GAAI,oBAAoB,eAAe;AAAA,IACvC,GAAI,sBAAsB,eAAe;AAAA,IACzC,GAAI,kBAAkB,eAAsB;AAAA,IAC5C,GAAI,0BAA0B,eAAsB;AAAA,EAAA,CACrD;AACH;AAEA,SAAS,cAAc,QAAuE;AAC5F,QAAM,QAAQ,CAAA;AAEd,MAAI,OAAO,WAAW,OAAO,YAAY,WAAW;AAC5C,UAAA,KAAK,OAAO,OAAO;AAAA,EAC3B;AAEA,MAAI,OAAO,QAAQ,OAAO,SAAS,WAAW;AACtC,UAAA,KAAK,GAAG,OAAO,IAAI;AAAA,EAC3B;AAEO,SAAA;AAAA,IACL,GAAG,oBAAoB,MAAM;AAAA,IAC7B,GAAG,sBAAsB,MAAM;AAAA,IAC/B;AAAA,EAAA;AAEJ;AAEA,SAAS,aAAa,OAAiD;AAMrE,SAAO,0BAA0B;AAAA,IAC/B,GAAG,oBAAoB,KAAK;AAAA,IAC5B,GAAG,sBAAsB,KAAK;AAAA,IAC9B,GAAG,kBAAkB,KAAK;AAAA,IAC1B,OAAO,MAAM;AAAA,EAAA,CACS;AAC1B;AAEA,SAAS,eAAe,SAAuD;AACvE,QAAA,EAAE,OAAO,IAAI,SAAS,MAAM,YAAY,SAAS,YAAY,gBAAA,IAAoB;AAEvF,QAAM,aAAkB,CAAA;AAExB,MAAI,IAAI;AACN,eAAW,SAAS;AAAA,EACtB;AAEW,aAAA,WAAW,WAAW,OAAO;AAEpC,MAAA,WAAW,aAAa,WAAW;AAEjC,QAAA,WAAW,QAAQ,QAAQ;AAC7B,iBAAW,cAAc;AAAA,IAC3B;AACA,eAAW,WAAW;AAAA,EACxB;AAEA,MAAI,SAAS;AACA,eAAA,UAAU,WAAW,OAAO;AAAA,EACzC;AAEA,SAAO,0BAA0B;AAAA,IAC/B,GAAG;AAAA,IACH,GAAG;AAAA,EAAA,CACJ;AACH;AAEA,SAAS,aAAa,OAAgE;AACpF,SAAO,0BAA0B;AAAA,IAC/B,GAAG,oBAAoB,KAAK;AAAA,IAC5B,GAAG,sBAAsB,KAAK;AAAA,IAC9B,GAAG,kBAAkB,KAAK;AAAA,EAAA,CAC3B;AACH;AAEa,MAAA,mBAAmB,IAAI,SAYjC;AAAA,EACD,YAAY,CAAC,iBAAiB;AAAA,EAC9B,UAAU,CAAC,eAAe;AAAA,EAC1B,QAAQ,CAAC,aAAa;AAAA,EACtB,gBAAgB,CAAC,qBAAqB;AAAA,EACtC,UAAU,CAAC,eAAe;AAAA,EAC1B,YAAY,CAAC,iBAAiB;AAAA,EAC9B,iBAAiB,CAAC,sBAAsB;AAAA,EACxC,QAAQ,CAAC,aAAa;AAAA,EACtB,OAAO,CAAC,YAAY;AAAA,EACpB,SAAS,CAAC,cAAc;AAAA,EACxB,OAAO,CAAC,YAAY;AACtB,CAAC;AAEM,SAAS,qBAAqB,QAAgE;AACnG,MACG,UACC,OAAO,gBACN,OAAO,gBAAgB,oDACtB,OAAO,YAAY,QAAQ,gDAAgD,MAAM,MAEjF,OAAO,gBAAgB,mDAC3B,OAAO,gBAAgB,2CACvB;AACO,WAAA,iBAAiB,gBAAgB,MAAM;AAAA,EAChD;AACO,SAAA;AACT;AAEA,SAAS,gBACP,UACmD;AACnD,QAAM,iBACF,MAAM,QAAQ,SAAS,QAAQ,KAAK,SAAS,SAAS,SAAS,gBAAgB,KAC/E,SAAS,YAAY,sBACtB,WAAW,YAAY,WAAW;AACrC,MAAI,eAAe;AACV,WAAA;AAAA,MACL,MAAM;AAAA,MACN,OAAO,WAAW,WAAW,SAAS,QAAQ,SAAS;AAAA,IAAA;AAAA,EAE3D;AACI,MAAA,SAAS,aAAa,uBAAuB;AACxC,WAAA;AAAA,MACL,MAAM;AAAA,MACN,OAAO,SAAS;AAAA,IAAA;AAAA,EAEpB;AACI,MAAA,SAAS,aAAa,aAAa;AAC9B,WAAA;AAAA,MACL,gBAAgB,SAAS,OAAO;AAAA,MAChC,IAAK,MAAM,QAAQ,SAAS,IAAI,IAAI,SAAS,OAAO,CAAC,SAAS,IAAI,GAAG;AAAA,QACnE;AAAA,MACF;AAAA,IAAA;AAAA,EAEJ;AACI,MAAA,SAAS,YAAY,yBAAyB;AACzC,WAAA;AAAA,MACL,MAAM;AAAA,MACN,QAAQ,YAAY,WAAW,SAAS,SAAS;AAAA,MACjD,UAAU,cAAc,WAAW,SAAS,WAAW;AAAA,IAAA;AAAA,EAE3D;AACA,QAAM,IAAI,MAAM,8BAA8B,SAAS,UAAU;AACnE;"}