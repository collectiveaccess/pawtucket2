"use strict";var e=Object.defineProperty,t=(t,i,r)=>(((t,i,r)=>{i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[i]=r})(t,"symbol"!=typeof i?i+"":i,r),r);Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const i=["sc:Collection","sc:Manifest","sc:Canvas","sc:AnnotationList","oa:Annotation","sc:Range","sc:Layer","sc:Sequence","oa:Choice","Service","ContentResource"];function r(e){if(null==e)throw new Error("Null or undefined is not a valid entity.");if(Array.isArray(e))throw new Error("Array is not a valid entity");if("object"!=typeof e)throw new Error(typeof e+" is not a valid entity");if("string"==typeof e["@type"]){const t=i.indexOf(e["@type"]);if(-1!==t)return i[t]}if(e.profile)return"Service";if(e.format)return"ContentResource";if(e["@type"])return"ContentResource";throw new Error("Resource type is not known")}class n{constructor(e,i={}){t(this,"traversals"),t(this,"options"),this.traversals={collection:[],manifest:[],canvas:[],annotationList:[],sequence:[],annotation:[],contentResource:[],choice:[],range:[],service:[],layer:[],...e},this.options={convertPropsToArray:!0,mergeMemberProperties:!0,allowUndefinedReturn:!1,...i}}static all(e){return new n({collection:[e],manifest:[e],canvas:[e],annotationList:[e],sequence:[e],annotation:[e],contentResource:[e],choice:[e],range:[e],service:[e],layer:[e]})}traverseCollection(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCollectionItems(e))),this.traversals.collection)}traverseCollectionItems(e){if(this.options.mergeMemberProperties){const t=[...(e.manifests||[]).map((e=>"string"==typeof e?{"@id":e,"@type":"sc:Manifest"}:e)),...(e.collections||[]).map((e=>"string"==typeof e?{"@id":e,"@type":"sc:Collection"}:e)),...e.members||[]];delete e.collections,delete e.manifests,e.members=t}return e.manifests&&(e.manifests=e.manifests.map((e=>this.traverseManifest("string"==typeof e?{"@id":e,"@type":"sc:Manifest"}:e)))),e.collections&&(e.collections=e.collections.map((e=>this.traverseCollection("string"==typeof e?{"@id":e,"@type":"sc:Collection"}:e)))),e.members&&(e.members=e.members.map((e=>"string"==typeof e?e:this.traverseUnknown(e)))),e}traverseManifest(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(e))),this.traversals.manifest)}traverseManifestItems(e){return e.sequences&&(e.sequences=e.sequences.map((e=>this.traverseSequence(e)))),e.structures&&(e.structures=e.structures.map((e=>this.traverseRange(e)))),e}traverseSequence(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseSequenceItems(e))),this.traversals.sequence)}traverseSequenceItems(e){return e.canvases&&(e.canvases=e.canvases.map((e=>this.traverseCanvas(e)))),e}traverseCanvas(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(e))),this.traversals.canvas)}traverseCanvasItems(e){return e.images&&(e.images=e.images.map((e=>this.traverseAnnotation(e)))),e.otherContent&&(e.otherContent=e.otherContent.map((e=>this.traverseAnnotationList(e)))),e}traverseRange(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseRangeItems(e))),this.traversals.range)}traverseRangeItems(e){if(this.options.mergeMemberProperties){const t=[...(e.ranges||[]).map((e=>"string"==typeof e?{"@id":e,"@type":"sc:Range"}:e)),...(e.canvases||[]).map((e=>"string"==typeof e?{"@id":e,"@type":"sc:Canvas"}:e)),...e.members||[]];delete e.ranges,delete e.canvases,e.members=t.length?t.map((e=>this.traverseUnknown(e))):void 0}return e}traverseAnnotationList(e){const t="string"==typeof e?{"@id":e,"@type":"sc:AnnotationList"}:e;return this.traverseType(this.traverseDescriptive(this.traverseAnnotationListItems(t)),this.traversals.annotationList)}traverseAnnotationListItems(e){return e.resources&&(e.resources=e.resources.map((e=>this.traverseAnnotation(e)))),e}traverseAnnotation(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationItems(e))),this.traversals.annotation)}traverseAnnotationItems(e){return e.resource&&(Array.isArray(e.resource)?e.resource=e.resource.map((e=>this.traverseContentResource(e))):e.resource=this.traverseContentResource(e.resource)),e.on,e}traverseLayer(e){return this.traverseType(this.traverseLinking(this.traverseLayerItems(e)),this.traversals.layer)}traverseLayerItems(e){return e.otherContent&&(e.otherContent=e.otherContent.map((e=>this.traverseAnnotationList(e)))),e}traverseChoice(e){return this.traverseType(this.traverseChoiceItems(e),this.traversals.choice)}traverseChoiceItems(e){return e.default&&"rdf:nil"!==e.default&&(e.default=this.traverseContentResource(e.default)),e.item&&"rdf:nil"!==e.item&&(e.item=e.item.map((e=>this.traverseContentResource(e)))),e}traverseService(e){return this.traverseType(this.traverseLinking(e),this.traversals.service)}traverseContentResource(e){return"oa:Choice"===e["@type"]?this.traverseChoice(e):this.traverseType(this.traverseDescriptive(this.traverseLinking(e)),this.traversals.contentResource)}traverseUnknown(e){if(!e["@type"]||"string"==typeof e)return e;switch(r(e)){case"sc:Collection":return this.traverseCollection(e);case"sc:Manifest":return this.traverseManifest(e);case"sc:Canvas":return this.traverseCanvas(e);case"sc:Sequence":return this.traverseSequence(e);case"sc:Range":return this.traverseRange(e);case"oa:Annotation":return this.traverseAnnotation(e);case"sc:AnnotationList":return this.traverseAnnotationList(e);case"sc:Layer":return this.traverseLayer(e);case"Service":return this.traverseService(e);case"oa:Choice":return this.traverseChoice(e);case"ContentResource":return this.traverseContentResource(e)}return e.profile?this.traverseService(e):e}traverseImageResource(e){const t=Array.isArray(e),i=Array.isArray(e)?e:[e],r=[];for(const n of i)"string"==typeof n?r.push(this.traverseContentResource({"@id":n,"@type":"dctypes:Image"})):r.push(this.traverseContentResource(n));return t||this.options.convertPropsToArray?r:r[0]}traverseDescriptive(e){return e.thumbnail&&(e.thumbnail=this.traverseImageResource(e.thumbnail)),e.logo&&(e.logo=this.traverseImageResource(e.logo)),e}traverseOneOrMoreServices(e){const t=Array.isArray(e),i=Array.isArray(e)?e:[e],r=[];for(const n of i)r.push(this.traverseService(n));return t||this.options.convertPropsToArray?r:r[0]}traverseLinking(e){return e.related&&(e.related=this.traverseOneOrManyType(e.related,this.traversals.contentResource)),e.rendering&&(e.rendering=this.traverseOneOrManyType(e.rendering,this.traversals.contentResource)),e.service&&(e.service=this.traverseOneOrMoreServices(e.service)),e.seeAlso&&(e.seeAlso=this.traverseOneOrManyType(e.seeAlso,this.traversals.contentResource)),e.within&&("string"==typeof e.within||(e.within=this.traverseOneOrManyType(e.within,this.traversals.contentResource))),e.startCanvas&&("string"==typeof e.startCanvas?e.startCanvas=this.traverseType({"@id":e.startCanvas,"@type":"sc:Canvas"},this.traversals.canvas):e.startCanvas&&this.traverseType(e.startCanvas,this.traversals.canvas)),e.contentLayer&&("string"==typeof e.contentLayer?e.contentLayer=this.traverseLayer({"@id":e.contentLayer,"@type":"sc:Layer"}):e.contentLayer=this.traverseLayer(e.contentLayer)),e}traverseOneOrManyType(e,t){if(!Array.isArray(e)){if(!this.options.convertPropsToArray)return this.traverseType(e,t);e=[e]}return e.map((e=>this.traverseType(e,t)))}traverseType(e,t){return t.reduce(((e,t)=>{const i=t(e);return void 0!==i||this.options.allowUndefinedReturn?i:e}),e)}}const a=["http://iiif.io/api/image/2/level1","http://iiif.io/api/image/2/level2","http://library.stanford.edu/iiif/image-api/compliance.html#level1","http://library.stanford.edu/iiif/image-api/compliance.html#level2","http://library.stanford.edu/iiif/image-api/conformance.html#level1","http://library.stanford.edu/iiif/image-api/conformance.html#level2","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2","http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1","http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2","http://iiif.io/api/image/1/level1.json","http://iiif.io/api/image/1/profiles/level1.json","http://iiif.io/api/image/1/level2.json","http://iiif.io/api/image/1/profiles/level2.json","http://iiif.io/api/image/2/level1.json","http://iiif.io/api/image/2/profiles/level1.json","http://iiif.io/api/image/2/level2.json","http://iiif.io/api/image/2/profiles/level2.json","level1","level2"],s=["http://iiif.io/api/image/2/level0","http://iiif.io/api/image/2/level1","http://iiif.io/api/image/2/level2","http://library.stanford.edu/iiif/image-api/compliance.html#level0","http://library.stanford.edu/iiif/image-api/compliance.html#level1","http://library.stanford.edu/iiif/image-api/compliance.html#level2","http://library.stanford.edu/iiif/image-api/conformance.html#level0","http://library.stanford.edu/iiif/image-api/conformance.html#level1","http://library.stanford.edu/iiif/image-api/conformance.html#level2","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1","http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2","http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0","http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1","http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2","http://iiif.io/api/image/1/level0.json","http://iiif.io/api/image/1/profiles/level0.json","http://iiif.io/api/image/1/level1.json","http://iiif.io/api/image/1/profiles/level1.json","http://iiif.io/api/image/1/level2.json","http://iiif.io/api/image/1/profiles/level2.json","http://iiif.io/api/image/2/level0.json","http://iiif.io/api/image/2/profiles/level0.json","http://iiif.io/api/image/2/level1.json","http://iiif.io/api/image/2/profiles/level1.json","http://iiif.io/api/image/2/level2.json","http://iiif.io/api/image/2/profiles/level2.json","level0","level1","level2"];const o="Attribution",c="http://example.org/provider",l="Unknown";function p(e,t="none"){if(!e)return{};const i=Array.isArray(e)?e:[e],r={};for(const n of i){if("string"==typeof n){r[t]=r[t]?r[t]:[],r[t].push(n||"");continue}if(!n["@language"]){r[t]=r[t]?r[t]:[],r[t].push(n["@value"]||"");continue}const e=n["@language"];r[e]=r[e]?r[e]:[],r[e].push(n["@value"]||"")}return r}function h(e){return Array.isArray(e)?h(e.find((e=>"string"==typeof e))):-1!==s.indexOf(e)?"level2":-1!==a.indexOf(e)?"level1":"string"==typeof e?e:void 0}function v(e){const t=Array.isArray(e)?e:[e];for(const i of t)switch(i){case"http://iiif.io/api/image/2/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2":return"ImageService2";case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":return"ImageService1";case"http://iiif.io/api/annex/openannotation/context.json":return"ImageApiSelector"}}function u(e){for(const t of["sc","oa","dcterms","dctypes","iiif"])if(e.startsWith(`${t}:`))return e.slice(t.length+1);return e}const f=["Collection","Manifest","Annotation","AnnotationPage","Range","Service"];function m(e){const t=e["@id"]||e.id;let i=e["@type"]||e.type;const r=e.profile||void 0,n=e["@context"]||void 0;if(r){const e=function(e){switch(e){case"http://iiif.io/api/image/2/level0.json":case"http://iiif.io/api/image/2/level1.json":case"http://iiif.io/api/image/2/level2.json":return"ImageService2";case"http://iiif.io/api/auth/1/kiosk":case"http://iiif.io/api/auth/1/login":case"http://iiif.io/api/auth/1/clickthrough":case"http://iiif.io/api/auth/1/external":case"http://iiif.io/api/auth/0/kiosk":case"http://iiif.io/api/auth/0/login":case"http://iiif.io/api/auth/0/clickthrough":case"http://iiif.io/api/auth/0/external":return"AuthCookieService1";case"http://iiif.io/api/auth/1/token":case"http://iiif.io/api/auth/0/token":return"AuthTokenService1";case"http://iiif.io/api/auth/1/logout":case"http://iiif.io/api/auth/0/logout":return"AuthLogoutService1";case"http://iiif.io/api/search/1/search":case"http://iiif.io/api/search/0/search":return"SearchService1";case"http://iiif.io/api/search/1/autocomplete":case"http://iiif.io/api/search/0/autocomplete":return"AutoCompleteService1"}}(r);if(e)return e}if(n){const e=v(n);if(e)return e}if(i){if(Array.isArray(i)){if(-1!==i.indexOf("oa:CssStylesheet"))return"CssStylesheet";if(-1!==i.indexOf("cnt:ContentAsText"))return"TextualBody";i=i[0]}for(const e of["sc","oa","dcterms","dctypes","iiif"])if(i.startsWith(`${e}:`)){i=i.slice(e.length+1);break}switch(i){case"Layer":return"AnnotationCollection";case"AnnotationList":return"AnnotationPage";case"cnt:ContentAsText":return"TextualBody"}}if(i&&-1!==f.indexOf(i))return i;if(e.format){if(e.format.startsWith("image/"))return"Image";if(e.format.startsWith("text/"))return"Text";if("application/pdf"===e.format)return"Text";if(e.format.startsWith("application/"))return"Dataset"}return t&&(t.endsWith(".jpg")||t.endsWith(".png")||t.endsWith(".jpeg"))?"Image":i||"unknown"}const g=/http(s)?:\/\/(creativecommons.org|rightsstatements.org)[^"'\\<\n]+/gm;function y(e){const t=e.match(g);return t?t[0]:e}const d=["http://iiif.io/api/presentation/2/context.json","http://iiif.io/api/image/2/context.json","http://iiif.io/api/image/1/context.json","http://library.stanford.edu/iiif/image-api/1.1/context.json","http://iiif.io/api/search/1/context.json","http://iiif.io/api/search/0/context.json","http://iiif.io/api/auth/1/context.json","http://iiif.io/api/auth/0/context.json","http://iiif.io/api/annex/openannotation/context.json"];function A(e){if(e){const t=Array.isArray(e)?e:[e],i=[];for(const e of t)"http://iiif.io/api/presentation/2/context.json"===e&&i.push("http://iiif.io/api/presentation/3/context.json"),-1===d.indexOf(e)&&i.push(e);if(t.length)return 1===i.length?i[0]:i}}function b(e){for(const t in e)void 0!==e[t]&&null!==e[t]||delete e[t];return e}let C=0;function x(e,t){const i=encodeURI(e.id||e["@id"]||"").trim();return i&&t?`${i}/${t}`:i||(C++,`http://example.org/${e["@type"]}${t?`/${t}`:""}/${C}`)}function w(e){const t=[...e.behavior||[]];let i;return e.viewingHint&&t.push(e.viewingHint),Array.isArray(e.motivation)?i=e.motivation.map(u):e.motivation&&(i=u(e.motivation)),{"@context":e["@context"]?A(e["@context"]):void 0,id:(e["@id"]||x(e)).trim(),type:m(e),behavior:t.length?t:void 0,height:e.height?e.height:void 0,width:e.width?e.width:void 0,motivation:i,viewingDirection:e.viewingDirection,profile:e.profile,format:e.format?e.format:void 0,duration:void 0,timeMode:void 0}}function j(e){const[t,i]=function(e,t="Rights/License",i="none"){let r=null;const n=[],a=Array.isArray(e)?e:[e];for(const s of a){const e=s?y(s):void 0;!e||-1===e.indexOf("creativecommons.org")&&-1===e.indexOf("rightsstatements.org")?e&&n.push({label:{[i]:[t]},value:{[i]:[e]}}):r=e.startsWith("https://")?`http://${e.slice(8)}`:e}return[r,n]}(e.license),r=[...e.metadata?(n=e.metadata,n?n.map((e=>({label:p(e.label),value:p(e.value)}))):[]):[],...i];var n;return{rights:t,metadata:r.length?r:void 0,label:e.label?p(e.label):void 0,requiredStatement:e.attribution?{label:p(o),value:p(e.attribution)}:void 0,navDate:e.navDate,summary:e.description?p(e.description):void 0,thumbnail:e.thumbnail}}function L(e){if(!e.within)return;const t=Array.isArray(e.within)?e.within:[e.within],i=[];for(const r of t)if("string"==typeof r){if(r&&"sc:Manifest"===e["@type"])i.push({id:r,type:"Collection"})}else r["@id"]&&i.push({id:r["@id"],type:m(r)});return i.length?i:void 0}function S(e){const t=e.related?Array.isArray(e.related)?e.related:[e.related]:[],i=e.contentLayer;return{provider:e.logo||t.length?[{id:c,type:"Agent",homepage:t.length?[t[0]]:void 0,logo:e.logo?Array.isArray(e.logo)?e.logo:[e.logo]:void 0,label:p(l)}]:void 0,partOf:L(e),rendering:e.rendering,seeAlso:e.seeAlso,start:e.startCanvas,service:e.service?(r=e.service,Array.isArray(r)?r:[r]):void 0,supplementary:i?[i]:void 0};var r}function R(e){const t=e;return b({...w(t),...j(t),...S(t),...(i=t,{chars:i.chars,format:i.format?i.format:void 0,language:i.language})});var i}const I=new n({collection:[function(e){return b({...w(e),...j(e),...S(e),items:e.members})}],manifest:[function(e){const t=[],i=[];for(const n of e.sequences||[])n.canvases.length&&t.push(...n.canvases),n.behavior&&i.push(...n.behavior);const r=w(e);return i.length&&(r.behavior?r.behavior.push(...i):r.behavior=i),b({...r,...j(e),...S(e),items:t,structures:e.structures})}],canvas:[function(e){return b({...w(e),...j(e),...S(e),annotations:e.otherContent&&e.otherContent.length?e.otherContent:void 0,items:e.images&&e.images.length?[{id:x(e,"annotation-page"),type:"AnnotationPage",items:e.images}]:void 0})}],annotationList:[function(e){return b({...w(e),...j(e),...S(e),items:e.resources&&e.resources.length?e.resources:void 0})}],sequence:[function(e){return e.canvases&&0!==e.canvases.length?{canvases:e.canvases,behavior:e.viewingHint?[e.viewingHint]:[]}:{canvases:[],behavior:[]}}],annotation:[function(e){return b({...w(e),...j(e),...S(e),target:function e(t){if(Array.isArray(t)){if(t.length>1)return{type:"List",items:t.map(e)};t=t[0]}if("string"==typeof t)return encodeURI(t).trim();if("@type"in t){let e;if("string"==typeof t.full)e=t.full;else if("dctypes:Image"===t.full["@type"])e={id:t.full["@id"],type:"Image"};else{if("sc:Canvas"!==t.full["@type"])throw new Error(`Unsupported source type on annotation: ${t.full["@type"]}`);e={id:t.full["@id"],type:"Canvas"}}return{type:"SpecificResource",source:e,selector:T(t.selector)}}return encodeURI(t["@id"]).trim()}(e.on),body:Array.isArray(e.resource)?e.resource.map(R):R(e.resource)})}],contentResource:[R],choice:[function(e){const t=[];return e.default&&"rdf:nil"!==e.default&&t.push(e.default),e.item&&"rdf:nil"!==e.item&&t.push(...e.item),{...w(e),...j(e),items:t}}],range:[function(e){return b({...w(e),...j(e),...S(e),items:e.members})}],service:[function(e){const{"@id":t,"@type":i,"@context":r,profile:n,...a}=e,s={};return t&&(s["@id"]=t),s["@type"]=m(e),"unknown"===s["@type"]&&(r&&r.length&&(s["@context"]=r),s["@type"]="Service"),n&&(s.profile=h(n)),b({...s,...a})}],layer:[function(e){return b({...w(e),...j(e),...S(e)})}]});function T(e){if((Array.isArray(e["@type"])&&e["@type"].includes("oa:SvgSelector")||"oa:SvgSelector"==e["@type"])&&("chars"in e||"value"in e))return{type:"SvgSelector",value:"chars"in e?e.chars:e.value};if("oa:FragmentSelector"===e["@type"])return{type:"FragmentSelector",value:e.value};if("oa:Choice"===e["@type"])return[T(e.default),...(Array.isArray(e.item)?e.item:[e.item]).map(T)];if("iiif:ImageApiSelector"==e["@type"])return{type:"ImageApiSelector",region:"region"in e?e.region:void 0,rotation:"rotation"in e?e.rotation:void 0};throw new Error(`Unsupported selector type: ${e["@type"]}`)}exports.Traverse=n,exports.convertLanguageMapping=p,exports.convertPresentation2=function(e){return e&&e["@context"]&&("http://iiif.io/api/presentation/2/context.json"===e["@context"]||-1!==e["@context"].indexOf("http://iiif.io/api/presentation/2/context.json")||"http://www.shared-canvas.org/ns/context.json"===e["@context"])||"http://iiif.io/api/image/2/context.json"===e["@context"]?I.traverseUnknown(e):e},exports.getProfile=h,exports.getTypeFromContext=v,exports.identifyResource=r,exports.presentation2to3=I,exports.types=i;
//# sourceMappingURL=index.js.map
