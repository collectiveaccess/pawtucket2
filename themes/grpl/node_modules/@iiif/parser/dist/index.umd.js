var __defProp=Object.defineProperty,__defNormalProp=(e,t,i)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,__publicField=(e,t,i)=>(__defNormalProp(e,"symbol"!=typeof t?t+"":t,i),i);!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).IIIFParser=t()}(this,(function(){"use strict";const e=["sc:Collection","sc:Manifest","sc:Canvas","sc:AnnotationList","oa:Annotation","sc:Range","sc:Layer","sc:Sequence","oa:Choice","Service","ContentResource"];function t(t){if(null==t)throw new Error("Null or undefined is not a valid entity.");if(Array.isArray(t))throw new Error("Array is not a valid entity");if("object"!=typeof t)throw new Error(typeof t+" is not a valid entity");if("string"==typeof t["@type"]){const i=e.indexOf(t["@type"]);if(-1!==i)return e[i]}if(t.profile)return"Service";if(t.format)return"ContentResource";if(t["@type"])return"ContentResource";throw new Error("Resource type is not known")}class i{constructor(e,t={}){__publicField(this,"traversals"),__publicField(this,"options"),this.traversals={collection:[],manifest:[],canvas:[],annotationList:[],sequence:[],annotation:[],contentResource:[],choice:[],range:[],service:[],layer:[],...e},this.options={convertPropsToArray:!0,mergeMemberProperties:!0,allowUndefinedReturn:!1,...t}}static all(e){return new i({collection:[e],manifest:[e],canvas:[e],annotationList:[e],sequence:[e],annotation:[e],contentResource:[e],choice:[e],range:[e],service:[e],layer:[e]})}traverseCollection(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCollectionItems(e))),this.traversals.collection)}traverseCollectionItems(e){if(this.options.mergeMemberProperties){const t=[...(e.manifests||[]).map((e=>"string"==typeof e?{"@id":e,"@type":"sc:Manifest"}:e)),...(e.collections||[]).map((e=>"string"==typeof e?{"@id":e,"@type":"sc:Collection"}:e)),...e.members||[]];delete e.collections,delete e.manifests,e.members=t}return e.manifests&&(e.manifests=e.manifests.map((e=>this.traverseManifest("string"==typeof e?{"@id":e,"@type":"sc:Manifest"}:e)))),e.collections&&(e.collections=e.collections.map((e=>this.traverseCollection("string"==typeof e?{"@id":e,"@type":"sc:Collection"}:e)))),e.members&&(e.members=e.members.map((e=>"string"==typeof e?e:this.traverseUnknown(e)))),e}traverseManifest(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(e))),this.traversals.manifest)}traverseManifestItems(e){return e.sequences&&(e.sequences=e.sequences.map((e=>this.traverseSequence(e)))),e.structures&&(e.structures=e.structures.map((e=>this.traverseRange(e)))),e}traverseSequence(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseSequenceItems(e))),this.traversals.sequence)}traverseSequenceItems(e){return e.canvases&&(e.canvases=e.canvases.map((e=>this.traverseCanvas(e)))),e}traverseCanvas(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(e))),this.traversals.canvas)}traverseCanvasItems(e){return e.images&&(e.images=e.images.map((e=>this.traverseAnnotation(e)))),e.otherContent&&(e.otherContent=e.otherContent.map((e=>this.traverseAnnotationList(e)))),e}traverseRange(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseRangeItems(e))),this.traversals.range)}traverseRangeItems(e){if(this.options.mergeMemberProperties){const t=[...(e.ranges||[]).map((e=>"string"==typeof e?{"@id":e,"@type":"sc:Range"}:e)),...(e.canvases||[]).map((e=>"string"==typeof e?{"@id":e,"@type":"sc:Canvas"}:e)),...e.members||[]];delete e.ranges,delete e.canvases,e.members=t.length?t.map((e=>this.traverseUnknown(e))):void 0}return e}traverseAnnotationList(e){const t="string"==typeof e?{"@id":e,"@type":"sc:AnnotationList"}:e;return this.traverseType(this.traverseDescriptive(this.traverseAnnotationListItems(t)),this.traversals.annotationList)}traverseAnnotationListItems(e){return e.resources&&(e.resources=e.resources.map((e=>this.traverseAnnotation(e)))),e}traverseAnnotation(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationItems(e))),this.traversals.annotation)}traverseAnnotationItems(e){return e.resource&&(Array.isArray(e.resource)?e.resource=e.resource.map((e=>this.traverseContentResource(e))):e.resource=this.traverseContentResource(e.resource)),e.on,e}traverseLayer(e){return this.traverseType(this.traverseLinking(this.traverseLayerItems(e)),this.traversals.layer)}traverseLayerItems(e){return e.otherContent&&(e.otherContent=e.otherContent.map((e=>this.traverseAnnotationList(e)))),e}traverseChoice(e){return this.traverseType(this.traverseChoiceItems(e),this.traversals.choice)}traverseChoiceItems(e){return e.default&&"rdf:nil"!==e.default&&(e.default=this.traverseContentResource(e.default)),e.item&&"rdf:nil"!==e.item&&(e.item=e.item.map((e=>this.traverseContentResource(e)))),e}traverseService(e){return this.traverseType(this.traverseLinking(e),this.traversals.service)}traverseContentResource(e){return"oa:Choice"===e["@type"]?this.traverseChoice(e):this.traverseType(this.traverseDescriptive(this.traverseLinking(e)),this.traversals.contentResource)}traverseUnknown(e){if(!e["@type"]||"string"==typeof e)return e;switch(t(e)){case"sc:Collection":return this.traverseCollection(e);case"sc:Manifest":return this.traverseManifest(e);case"sc:Canvas":return this.traverseCanvas(e);case"sc:Sequence":return this.traverseSequence(e);case"sc:Range":return this.traverseRange(e);case"oa:Annotation":return this.traverseAnnotation(e);case"sc:AnnotationList":return this.traverseAnnotationList(e);case"sc:Layer":return this.traverseLayer(e);case"Service":return this.traverseService(e);case"oa:Choice":return this.traverseChoice(e);case"ContentResource":return this.traverseContentResource(e)}return e.profile?this.traverseService(e):e}traverseImageResource(e){const t=Array.isArray(e),i=Array.isArray(e)?e:[e],n=[];for(const r of i)"string"==typeof r?n.push(this.traverseContentResource({"@id":r,"@type":"dctypes:Image"})):n.push(this.traverseContentResource(r));return t||this.options.convertPropsToArray?n:n[0]}traverseDescriptive(e){return e.thumbnail&&(e.thumbnail=this.traverseImageResource(e.thumbnail)),e.logo&&(e.logo=this.traverseImageResource(e.logo)),e}traverseOneOrMoreServices(e){const t=Array.isArray(e),i=Array.isArray(e)?e:[e],n=[];for(const r of i)n.push(this.traverseService(r));return t||this.options.convertPropsToArray?n:n[0]}traverseLinking(e){return e.related&&(e.related=this.traverseOneOrManyType(e.related,this.traversals.contentResource)),e.rendering&&(e.rendering=this.traverseOneOrManyType(e.rendering,this.traversals.contentResource)),e.service&&(e.service=this.traverseOneOrMoreServices(e.service)),e.seeAlso&&(e.seeAlso=this.traverseOneOrManyType(e.seeAlso,this.traversals.contentResource)),e.within&&("string"==typeof e.within||(e.within=this.traverseOneOrManyType(e.within,this.traversals.contentResource))),e.startCanvas&&("string"==typeof e.startCanvas?e.startCanvas=this.traverseType({"@id":e.startCanvas,"@type":"sc:Canvas"},this.traversals.canvas):e.startCanvas&&this.traverseType(e.startCanvas,this.traversals.canvas)),e.contentLayer&&("string"==typeof e.contentLayer?e.contentLayer=this.traverseLayer({"@id":e.contentLayer,"@type":"sc:Layer"}):e.contentLayer=this.traverseLayer(e.contentLayer)),e}traverseOneOrManyType(e,t){if(!Array.isArray(e)){if(!this.options.convertPropsToArray)return this.traverseType(e,t);e=[e]}return e.map((e=>this.traverseType(e,t)))}traverseType(e,t){return t.reduce(((e,t)=>{const i=t(e);return void 0!==i||this.options.allowUndefinedReturn?i:e}),e)}}const n="http://library.stanford.edu/iiif/image-api/compliance.html#level1",r="http://library.stanford.edu/iiif/image-api/compliance.html#level2",a="http://library.stanford.edu/iiif/image-api/conformance.html#level1",s="http://library.stanford.edu/iiif/image-api/conformance.html#level2",o="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1",l="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2",c="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1",u="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2",v="http://iiif.io/api/image/1/level1.json",p="http://iiif.io/api/image/1/profiles/level1.json",h="http://iiif.io/api/image/1/level2.json",f="http://iiif.io/api/image/1/profiles/level2.json",y="http://iiif.io/api/image/2/level1.json",d="http://iiif.io/api/image/2/profiles/level1.json",m="http://iiif.io/api/image/2/level2.json",g="http://iiif.io/api/image/2/profiles/level2.json",A="level1",C="level2",b="http://iiif.io/api/image/2/level1",w="http://iiif.io/api/image/2/level2",R=[b,w,n,r,a,s,o,l,c,u,v,p,h,f,y,d,m,g,A,C],S=["http://iiif.io/api/image/2/level0",b,w,"http://library.stanford.edu/iiif/image-api/compliance.html#level0",n,r,"http://library.stanford.edu/iiif/image-api/conformance.html#level0",a,s,"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0",o,l,"http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0",c,u,"http://iiif.io/api/image/1/level0.json","http://iiif.io/api/image/1/profiles/level0.json",v,p,h,f,"http://iiif.io/api/image/2/level0.json","http://iiif.io/api/image/2/profiles/level0.json",y,d,m,g,"level0",A,C];function T(e){return Array.isArray(e)?e:[e]}const x="Attribution",j="http://example.org/provider",L="Unknown";function P(e,t="none"){if(!e)return{};const i=Array.isArray(e)?e:[e],n={};for(const r of i){if("string"==typeof r){n[t]=n[t]?n[t]:[],n[t].push(r||"");continue}if(!r["@language"]){n[t]=n[t]?n[t]:[],n[t].push(r["@value"]||"");continue}const e=r["@language"];n[e]=n[e]?n[e]:[],n[e].push(r["@value"]||"")}return n}function I(e){return Array.isArray(e)?I(e.find((e=>"string"==typeof e))):-1!==S.indexOf(e)?"level2":-1!==R.indexOf(e)?"level1":"string"==typeof e?e:void 0}function M(e){const t=Array.isArray(e)?e:[e];for(const i of t)switch(i){case"http://iiif.io/api/image/2/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2":return"ImageService2";case"http://iiif.io/api/image/1/context.json":case"http://library.stanford.edu/iiif/image-api/1.1/context.json":return"ImageService1";case"http://iiif.io/api/annex/openannotation/context.json":return"ImageApiSelector"}}function O(e){for(const t of["sc","oa","dcterms","dctypes","iiif"])if(e.startsWith(`${t}:`))return e.slice(t.length+1);return e}const k=["Collection","Manifest","Annotation","AnnotationPage","Range","Service"];function D(e){const t=e["@id"]||e.id;let i=e["@type"]||e.type;const n=e.profile||void 0,r=e["@context"]||void 0;if(n){const e=function(e){switch(e){case"http://iiif.io/api/image/2/level0.json":case"http://iiif.io/api/image/2/level1.json":case"http://iiif.io/api/image/2/level2.json":return"ImageService2";case"http://iiif.io/api/auth/1/kiosk":case"http://iiif.io/api/auth/1/login":case"http://iiif.io/api/auth/1/clickthrough":case"http://iiif.io/api/auth/1/external":case"http://iiif.io/api/auth/0/kiosk":case"http://iiif.io/api/auth/0/login":case"http://iiif.io/api/auth/0/clickthrough":case"http://iiif.io/api/auth/0/external":return"AuthCookieService1";case"http://iiif.io/api/auth/1/token":case"http://iiif.io/api/auth/0/token":return"AuthTokenService1";case"http://iiif.io/api/auth/1/logout":case"http://iiif.io/api/auth/0/logout":return"AuthLogoutService1";case"http://iiif.io/api/search/1/search":case"http://iiif.io/api/search/0/search":return"SearchService1";case"http://iiif.io/api/search/1/autocomplete":case"http://iiif.io/api/search/0/autocomplete":return"AutoCompleteService1"}}(n);if(e)return e}if(r){const e=M(r);if(e)return e}if(i){if(Array.isArray(i)){if(-1!==i.indexOf("oa:CssStylesheet"))return"CssStylesheet";if(-1!==i.indexOf("cnt:ContentAsText"))return"TextualBody";i=i[0]}for(const e of["sc","oa","dcterms","dctypes","iiif"])if(i.startsWith(`${e}:`)){i=i.slice(e.length+1);break}switch(i){case"Layer":return"AnnotationCollection";case"AnnotationList":return"AnnotationPage";case"cnt:ContentAsText":return"TextualBody"}}if(i&&-1!==k.indexOf(i))return i;if(e.format){if(e.format.startsWith("image/"))return"Image";if(e.format.startsWith("text/"))return"Text";if("application/pdf"===e.format)return"Text";if(e.format.startsWith("application/"))return"Dataset"}return t&&(t.endsWith(".jpg")||t.endsWith(".png")||t.endsWith(".jpeg"))?"Image":i||"unknown"}const _=/http(s)?:\/\/(creativecommons.org|rightsstatements.org)[^"'\\<\n]+/gm;function q(e){const t=e.match(_);return t?t[0]:e}const U=["http://iiif.io/api/presentation/2/context.json","http://iiif.io/api/image/2/context.json","http://iiif.io/api/image/1/context.json","http://library.stanford.edu/iiif/image-api/1.1/context.json","http://iiif.io/api/search/1/context.json","http://iiif.io/api/search/0/context.json","http://iiif.io/api/auth/1/context.json","http://iiif.io/api/auth/0/context.json","http://iiif.io/api/annex/openannotation/context.json"];function E(e){if(e){const t=Array.isArray(e)?e:[e],i=[];for(const e of t)"http://iiif.io/api/presentation/2/context.json"===e&&i.push("http://iiif.io/api/presentation/3/context.json"),-1===U.indexOf(e)&&i.push(e);if(t.length)return 1===i.length?i[0]:i}}function $(e){for(const t in e)void 0!==e[t]&&null!==e[t]||delete e[t];return e}let W=0;function F(e,t){const i=encodeURI(e.id||e["@id"]||"").trim();return i&&t?`${i}/${t}`:i||(W++,`http://example.org/${e["@type"]}${t?`/${t}`:""}/${W}`)}function z(e){const t=[...e.behavior||[]];let i;return e.viewingHint&&t.push(e.viewingHint),Array.isArray(e.motivation)?i=e.motivation.map(O):e.motivation&&(i=O(e.motivation)),{"@context":e["@context"]?E(e["@context"]):void 0,id:(e["@id"]||F(e)).trim(),type:D(e),behavior:t.length?t:void 0,height:e.height?e.height:void 0,width:e.width?e.width:void 0,motivation:i,viewingDirection:e.viewingDirection,profile:e.profile,format:e.format?e.format:void 0,duration:void 0,timeMode:void 0}}function N(e){const[t,i]=function(e,t="Rights/License",i="none"){let n=null;const r=[],a=Array.isArray(e)?e:[e];for(const s of a){const e=s?q(s):void 0;!e||-1===e.indexOf("creativecommons.org")&&-1===e.indexOf("rightsstatements.org")?e&&r.push({label:{[i]:[t]},value:{[i]:[e]}}):n=e.startsWith("https://")?`http://${e.slice(8)}`:e}return[n,r]}(e.license),n=[...e.metadata?(r=e.metadata,r?r.map((e=>({label:P(e.label),value:P(e.value)}))):[]):[],...i];var r;return{rights:t,metadata:n.length?n:void 0,label:e.label?P(e.label):void 0,requiredStatement:e.attribution?{label:P(x),value:P(e.attribution)}:void 0,navDate:e.navDate,summary:e.description?P(e.description):void 0,thumbnail:e.thumbnail}}function B(e){if(!e.within)return;const t=Array.isArray(e.within)?e.within:[e.within],i=[];for(const n of t)if("string"==typeof n){if(n&&"sc:Manifest"===e["@type"])i.push({id:n,type:"Collection"})}else n["@id"]&&i.push({id:n["@id"],type:D(n)});return i.length?i:void 0}function H(e){const t=e.related?Array.isArray(e.related)?e.related:[e.related]:[],i=e.contentLayer;return{provider:e.logo||t.length?[{id:j,type:"Agent",homepage:t.length?[t[0]]:void 0,logo:e.logo?Array.isArray(e.logo)?e.logo:[e.logo]:void 0,label:P(L)}]:void 0,partOf:B(e),rendering:e.rendering,seeAlso:e.seeAlso,start:e.startCanvas,service:e.service?T(e.service):void 0,supplementary:i?[i]:void 0}}function J(e){const t=e;return $({...z(t),...N(t),...H(t),...(i=t,{chars:i.chars,format:i.format?i.format:void 0,language:i.language})});var i}const V=new i({collection:[function(e){return $({...z(e),...N(e),...H(e),items:e.members})}],manifest:[function(e){const t=[],i=[];for(const r of e.sequences||[])r.canvases.length&&t.push(...r.canvases),r.behavior&&i.push(...r.behavior);const n=z(e);return i.length&&(n.behavior?n.behavior.push(...i):n.behavior=i),$({...n,...N(e),...H(e),items:t,structures:e.structures})}],canvas:[function(e){return $({...z(e),...N(e),...H(e),annotations:e.otherContent&&e.otherContent.length?e.otherContent:void 0,items:e.images&&e.images.length?[{id:F(e,"annotation-page"),type:"AnnotationPage",items:e.images}]:void 0})}],annotationList:[function(e){return $({...z(e),...N(e),...H(e),items:e.resources&&e.resources.length?e.resources:void 0})}],sequence:[function(e){return e.canvases&&0!==e.canvases.length?{canvases:e.canvases,behavior:e.viewingHint?[e.viewingHint]:[]}:{canvases:[],behavior:[]}}],annotation:[function(e){return $({...z(e),...N(e),...H(e),target:function e(t){if(Array.isArray(t)){if(t.length>1)return{type:"List",items:t.map(e)};t=t[0]}if("string"==typeof t)return encodeURI(t).trim();if("@type"in t){let e;if("string"==typeof t.full)e=t.full;else if("dctypes:Image"===t.full["@type"])e={id:t.full["@id"],type:"Image"};else{if("sc:Canvas"!==t.full["@type"])throw new Error(`Unsupported source type on annotation: ${t.full["@type"]}`);e={id:t.full["@id"],type:"Canvas"}}return{type:"SpecificResource",source:e,selector:G(t.selector)}}return encodeURI(t["@id"]).trim()}(e.on),body:Array.isArray(e.resource)?e.resource.map(J):J(e.resource)})}],contentResource:[J],choice:[function(e){const t=[];return e.default&&"rdf:nil"!==e.default&&t.push(e.default),e.item&&"rdf:nil"!==e.item&&t.push(...e.item),{...z(e),...N(e),items:t}}],range:[function(e){return $({...z(e),...N(e),...H(e),items:e.members})}],service:[function(e){const{"@id":t,"@type":i,"@context":n,profile:r,...a}=e,s={};return t&&(s["@id"]=t),s["@type"]=D(e),"unknown"===s["@type"]&&(n&&n.length&&(s["@context"]=n),s["@type"]="Service"),r&&(s.profile=I(r)),$({...s,...a})}],layer:[function(e){return $({...z(e),...N(e),...H(e)})}]});function Y(e){return e&&e["@context"]&&("http://iiif.io/api/presentation/2/context.json"===e["@context"]||-1!==e["@context"].indexOf("http://iiif.io/api/presentation/2/context.json")||"http://www.shared-canvas.org/ns/context.json"===e["@context"])||"http://iiif.io/api/image/2/context.json"===e["@context"]?V.traverseUnknown(e):e}function G(e){if((Array.isArray(e["@type"])&&e["@type"].includes("oa:SvgSelector")||"oa:SvgSelector"==e["@type"])&&("chars"in e||"value"in e))return{type:"SvgSelector",value:"chars"in e?e.chars:e.value};if("oa:FragmentSelector"===e["@type"])return{type:"FragmentSelector",value:e.value};if("oa:Choice"===e["@type"])return[G(e.default),...(Array.isArray(e.item)?e.item:[e.item]).map(G)];if("iiif:ImageApiSelector"==e["@type"])return{type:"ImageApiSelector",region:"region"in e?e.region:void 0,rotation:"rotation"in e?e.rotation:void 0};throw new Error(`Unsupported selector type: ${e["@type"]}`)}const K=Object.freeze(Object.defineProperty({__proto__:null,types:e,identifyResource:t,Traverse:i,convertLanguageMapping:P,getProfile:I,getTypeFromContext:M,presentation2to3:V,convertPresentation2:Y},Symbol.toStringTag,{value:"Module"})),Q=[];Object.freeze(Q);const X={id:"https://iiif-parser/annotation",type:"Annotation",behavior:Q,label:null,thumbnail:Q,summary:null,requiredStatement:null,metadata:Q,seeAlso:Q,homepage:Q,logo:Q,rendering:Q,service:Q,accessibility:Q,audience:Q,body:Q,bodyValue:null,canonical:null,created:null,creator:Q,generated:null,generator:Q,modified:null,motivation:Q,rights:Q,stylesheet:null,target:Q,timeMode:void 0,via:Q,partOf:Q},Z={id:"https://iiif-parser/annotation-page",type:"AnnotationPage",behavior:Q,motivation:null,label:null,thumbnail:Q,summary:null,requiredStatement:null,metadata:Q,rights:null,provider:Q,items:Q,seeAlso:Q,homepage:Q,logo:Q,rendering:Q,service:Q},ee={id:"https://iiif-parser/empty-canvas",type:"Canvas",label:null,behavior:Q,motivation:null,thumbnail:Q,posterCanvas:null,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:Q,rights:null,navDate:null,provider:Q,items:Q,annotations:Q,seeAlso:Q,homepage:Q,logo:Q,partOf:Q,rendering:Q,service:Q,duration:0,height:0,width:0},te={id:"https://iiif-parser/empty-collection",type:"Collection",label:null,viewingDirection:"left-to-right",behavior:Q,motivation:null,thumbnail:Q,posterCanvas:null,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:Q,rights:null,navDate:null,provider:Q,items:Q,annotations:Q,seeAlso:Q,homepage:Q,logo:Q,partOf:Q,rendering:Q,service:Q,services:Q},ie={id:"https://iiif-parser/empty-manifest",type:"Manifest",annotations:Q,behavior:Q,homepage:Q,items:Q,label:null,logo:Q,metadata:Q,motivation:null,navDate:null,provider:Q,partOf:Q,posterCanvas:null,accompanyingCanvas:null,placeholderCanvas:null,rendering:Q,requiredStatement:null,rights:null,seeAlso:Q,service:Q,services:Q,start:null,structures:Q,summary:null,thumbnail:Q,viewingDirection:"left-to-right"},ne={id:"https://iiif-parser/empty-canvas",type:"Range",label:null,behavior:Q,motivation:null,thumbnail:Q,posterCanvas:null,accompanyingCanvas:null,placeholderCanvas:null,summary:null,requiredStatement:null,metadata:Q,rights:null,navDate:null,provider:Q,items:Q,annotations:Q,seeAlso:Q,homepage:Q,logo:Q,partOf:Q,rendering:Q,service:Q,start:null,supplementary:null,viewingDirection:"left-to-right"},re={id:"https://iiif-parser/empty-agent",type:"Agent",label:{},logo:Q,seeAlso:Q,homepage:Q},ae=["Collection","Manifest","Canvas","AnnotationPage","AnnotationCollection","Annotation","ContentResource","Range","Service","Selector","Agent"];function se(e){if(null==e)throw new Error("Null or undefined is not a valid entity.");if(Array.isArray(e))throw new Error("Array is not a valid entity");if("object"!=typeof e)throw new Error(typeof e+" is not a valid entity");if("string"==typeof e.type){const t=ae.indexOf(e.type);if(-1!==t)return ae[t]}if(e.profile)return"Service";throw new Error("Resource type is not known")}class oe{constructor(e,t={}){__publicField(this,"traversals"),__publicField(this,"options"),this.traversals={collection:[],manifest:[],canvas:[],annotationCollection:[],annotationPage:[],annotation:[],contentResource:[],choice:[],range:[],service:[],agent:[],...e},this.options={allowUndefinedReturn:!1,...t}}static all(e){return new oe({collection:[e],manifest:[e],canvas:[e],annotationCollection:[e],annotationPage:[e],annotation:[e],contentResource:[e],choice:[e],range:[e],service:[e]})}traverseDescriptive(e){return e.thumbnail&&(e.thumbnail=e.thumbnail.map((e=>this.traverseType(e,this.traversals.contentResource)))),e.provider&&(e.provider=e.provider.map((e=>this.traverseAgent(e)))),e}traverseLinking(e){return e.seeAlso&&(e.seeAlso=e.seeAlso.map((e=>this.traverseType(e,this.traversals.contentResource)))),e.service&&(e.service=T(e.service).map((e=>this.traverseType(e,this.traversals.service)))),e.services&&(e.services=e.services.map((e=>this.traverseType(e,this.traversals.service)))),e.logo&&(e.logo=e.logo.map((e=>this.traverseType(e,this.traversals.contentResource)))),e.homepage&&(e.homepage=e.homepage.map((e=>this.traverseType(e,this.traversals.contentResource)))),e.partOf&&(e.partOf=e.partOf.map((e=>"string"!=typeof e&&e.type?"Canvas"===e.type?this.traverseType(e,this.traversals.canvas):"AnnotationCollection"===e.type?this.traverseType(e,this.traversals.annotationCollection):"Collection"===e.type?this.traverseType(e,this.traversals.collection):this.traverseType(e,this.traversals.contentResource):this.traverseType(e,this.traversals.contentResource)))),e.start&&(e.start=e.start?this.traverseType(e.start,this.traversals.canvas):null),e.rendering&&(e.rendering=e.rendering.map((e=>this.traverseType(e,this.traversals.contentResource)))),e.supplementary&&(e.supplementary=e.supplementary.map((e=>this.traverseType(e,this.traversals.contentResource)))),e}traverseCollectionItems(e){return e.items&&e.items.map((e=>"Collection"===e.type?this.traverseCollection(e):this.traverseManifest(e))),e}traverseCollection(e){return this.traverseType(this.traverseDescriptive(this.traverseInlineAnnotationPages(this.traverseLinking(this.traversePosterCanvas(this.traverseCollectionItems(e))))),this.traversals.collection)}traverseManifestItems(e){return e.items&&(e.items=e.items.map((e=>this.traverseCanvas(e)))),e}traverseManifestStructures(e){return e.structures&&(e.structures=e.structures.map((e=>this.traverseRange(e)))),e}traverseManifest(e){return this.traverseType(this.traverseInlineAnnotationPages(this.traverseManifestStructures(this.traversePosterCanvas(this.traverseDescriptive(this.traverseLinking(this.traverseManifestItems(e)))))),this.traversals.manifest)}traverseCanvasItems(e){return e.items=(e.items||[]).map((e=>this.traverseAnnotationPage(e))),e}traverseInlineAnnotationPages(e){return"string"!=typeof e&&e?(e.annotations&&(e.annotations=e.annotations.map((e=>this.traverseAnnotationPage(e)))),e):e}traverseCanvas(e){return this.traverseType(this.traverseInlineAnnotationPages(this.traversePosterCanvas(this.traverseDescriptive(this.traverseLinking(this.traverseCanvasItems(e))))),this.traversals.canvas)}traverseAnnotationPageItems(e){return e.items&&(e.items=e.items.map((e=>this.traverseAnnotation(e)))),e}traverseAnnotationPage(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(this.traverseAnnotationPageItems(e))),this.traversals.annotationPage)}traverseAnnotationBody(e){return Array.isArray(e.body)?e.body=e.body.map((e=>this.traverseContentResource(e))):e.body&&(e.body=this.traverseContentResource(e.body)),e}traversePosterCanvas(e){return e.posterCanvas&&(e.posterCanvas=this.traverseCanvas(e.posterCanvas)),e.placeholderCanvas&&(e.placeholderCanvas=this.traverseCanvas(e.placeholderCanvas)),e.accompanyingCanvas&&(e.accompanyingCanvas=this.traverseCanvas(e.accompanyingCanvas)),e}traverseAnnotation(e){return this.traverseType(this.traverseLinking(this.traverseAnnotationBody(e)),this.traversals.annotation)}traverseContentResourceLinking(e){return"string"!=typeof e&&e?(e&&e.service&&(e.service=T(e.service||[]).map((e=>this.traverseType(e,this.traversals.service)))),e):e}traverseContentResource(e){return"Choice"===e.type&&(e.items=e.items.map((e=>this.traverseContentResource(e)))),this.traverseType(this.traverseInlineAnnotationPages(this.traverseContentResourceLinking(e)),this.traversals.contentResource)}traverseRangeRanges(e){return e.items&&(e.items=e.items.map((e=>"string"==typeof e?this.traverseCanvas({id:e,type:"Canvas"}):"Manifest"===e.type?this.traverseManifest(e):this.traverseRange(e)))),e}traverseRange(e){return this.traverseType(this.traversePosterCanvas(this.traverseDescriptive(this.traverseLinking(this.traverseRangeRanges(e)))),this.traversals.range)}traverseAgent(e){return this.traverseType(this.traverseDescriptive(this.traverseLinking(e)),this.traversals.agent)}traverseType(e,t){return t.reduce(((e,t)=>{const i=t(e);return void 0!==i||this.options.allowUndefinedReturn?i:e}),e)}traverseService(e){return this.traverseType(e,this.traversals.service)}traverseUnknown(e){const t=se(e);switch(t){case"Collection":return this.traverseCollection(e);case"Manifest":return this.traverseManifest(e);case"Canvas":return this.traverseCanvas(e);case"AnnotationPage":return this.traverseAnnotationPage(e);case"Annotation":return this.traverseAnnotation(e);case"ContentResource":return this.traverseContentResource(e);case"Range":return this.traverseRange(e);case"Service":return this.traverseService(e);case"Agent":return this.traverseAgent(e);default:throw new Error(`Unknown or unsupported resource type of ${t}`)}}}function le(){return{Collection:{},Manifest:{},Canvas:{},AnnotationPage:{},AnnotationCollection:{},Annotation:{},ContentResource:{},Range:{},Service:{},Selector:{},Agent:{}}}function ce(e,t){if("string"==typeof e)return{id:e,type:t};if(!e.id)throw new Error(`Invalid resource does not have an ID (${t})`);return e}function ue(e,t){if(!t)return e;if(Array.isArray(e)){if(!Array.isArray(t))throw new Error("Cannot merge array with non-array");const i=[...e];for(const n of t)if(null!=n)if(Array.isArray(n))i.push(n);else if("object"==typeof n&&n.id&&n.type){const e=i.findIndex((e=>e.id===n.id&&e.type===n.type));e>=0&&(i[e]=ue(i[e],n))}else-1===e.indexOf(n)&&i.push(n);return i}if("object"==typeof e){if(Array.isArray(t)||"object"!=typeof t)throw new Error("Cannot merge object with non-object");const i={...e};for(const[e,n]of Object.entries(t)){const t=i[e];i[e]=t!==Q&&t?ue(t,n):n}return i}return e||t}function ve(e,t){if("string"==typeof e)return e;if(t.id!==e.id||t.type!==e.type)throw new Error("Can only merge entities with identical identifiers and type!");return ue({...e},t)}function pe(e){const t=JSON.stringify(e);let i=5381,n=t.length;for(;n;)i=33*i^t.charCodeAt(--n);const r=(i>>>0).toString(16);return r.length%2?"0"+r:r}function he(e){return t=>"string"==typeof t?{id:t,type:e}:t.id?t.type?t:{type:e,...t}:{id:`vault://${pe(t)}`,type:e,...t}}function fe(e){return t=>({...e,...t})}function ye(e){return Array.isArray(e)?e:[e]}function de(e){return e.body&&(e.body=ye(e.body)),e.seeAlso&&(e.seeAlso=ye(e.seeAlso)),e.body&&(e.body=ye(e.body)),e.audience&&(e.audience=ye(e.audience)),e.accessibility&&(e.accessibility=ye(e.accessibility)),e.motivation&&(e.motivation=ye(e.motivation)),e}const me="__$UNSET$__",ge="__$UNWRAP$__";function Ae(e){const t={};for(const[i,n]of e){if(i===ge&&n!==me)return n;n!==me&&null!=n&&(t[i]=n)}return t}function Ce(e){if(!e)return;const t=Object.keys(e);if(0!==t.length){if(1===t.length){const i=t[0];if(!i)return"";const n=(e[i]||[]).join("");return"@none"===i||"none"===i||"en"===i?n:{"@language":i,"@value":n}}return t.map((t=>({"@language":t,"@value":(e[t]||[]).join("")})))}}function be(e){return Array.isArray(e)?e.map((e=>be(e))):"string"==typeof e?e:e.type&&"Canvas"===e.type?e.id:e}function we(e,t=!1){if(e)return e.length>1&&!t?e:e[0]||void 0}function Re(e){if(e){if("string"==typeof e)return{"@id":e};if("@id"in e){const t={...e};return delete t["@type"],t}return{"@context":"http://iiif.io/api/image/2/context.json","@id":e.id,profile:`http://iiif.io/api/image/2/profiles/${e.profile}.json`}}}function Se(e,t){return[["@id",e.id],["@type",t],["format",e.format],["height",e.height],["width",e.width],["viewingDirection","left-to-right"!==e.viewingDirection?e.viewingDirection:void 0]]}function*Te(e){const t=e.provider?yield e.provider[0]:void 0;return[["label",Ce(e.label)],["metadata",e.metadata&&e.metadata.length?e.metadata.map((e=>({label:Ce(e.label)||"",value:Ce(e.value)||""}))):void 0],["description",Ce(e.summary)],["thumbnail",we(yield e.thumbnail)],["navDate",e.navDate],["logo",t?we(t.logo):void 0],["homepage",t?t.homepage:void 0],["attribution",e.requiredStatement?Ce(e.requiredStatement.value):void 0]]}function*xe(e){return[["seeAlso",we(yield e.seeAlso)],["service",we((e.service||[]).map(Re))],["rendering",we(yield e.rendering)],["startCanvas",e.start?e.start.id:void 0]]}const je={Manifest:function*(e){return[...Se(e,"sc:Manifest"),...yield*Te(e),...yield*xe(e),["sequences",[{"@id":`${e.id}/sequence0`,"@type":"sc:Sequence",canvases:yield e.items}]],["structures",yield e.structures]]},Canvas:function*(e){const t=(yield e.items)[0];return[...Se(e,"sc:Canvas"),...yield*Te(e),...yield*xe(e),["images",t?[t.resources]:void 0],["annotations",e.annotations&&e.annotations.length?we(yield e.annotations):void 0]]},AnnotationPage:function*(e){return[...Se(e,"sc:AnnotationList"),...yield*Te(e),["resources",e.items&&e.items.length?we(yield e.items):void 0]]},Annotation:function*(e){return[["@id",e.id],["@type","oa:Annotation"],["motivation","sc:painting"],["on",be(e.target)],["resource",we(yield e.body,!0)]]},ContentResource:function*(e){return"Image"===e.type?[...Se(e,"dctypes:Image"),...yield*Te(e),...yield*xe(e)]:[...Se(e,void 0),...yield*Te(e)]},AnnotationCollection:function*(e){return[["@id",e.id],["@type","sc:Layer"],["label",Ce(e.label)]]},Collection:function*(e){return[...Se(e,"sc:Collection"),...yield*Te(e),...yield*xe(e),["members",yield*e.items]]},Range:function*(e){const t=[],i=[];if(e.items)for(const n of e.items){const r=yield n;t.push({"@id":n.id,"@type":n.type,label:r?r.label:void 0,within:e.id}),"Canvas"===n.type&&i.push(n.id)}return[...Se(e,"sc:Range"),...yield*Te(e),...yield*xe(e),["canvases",i.length===t.length?i:void 0],["members",i.length!==t.length?t:void 0]]}};function Le(e){var t;return[["id",(null==(t=e.id)?void 0:t.startsWith("vault://"))?void 0:e.id],["type",e.type],["format",e.format],["profile",e.profile],["height",e.height],["width",e.width],["duration",e.duration||void 0],["viewingDirection","left-to-right"!==e.viewingDirection?e.viewingDirection:void 0],["behavior",e.behavior&&e.behavior.length?e.behavior:void 0],["timeMode",e.timeMode],["motivation",Array.isArray(e.motivation)?e.motivation[0]:e.motivation]]}function Pe(e){if(e&&0!==e.length)return e}function Ie(e){if(e&&e.type&&"ImageService2"===e.type){const{id:t,type:i,profile:n,...r}=e,a="string"==typeof n?n:Array.isArray(n)?n.find((e=>"string"==typeof e)):"";return{"@id":t,"@type":i,profile:a?a.startsWith("http")?a:`http://iiif.io/api/image/2/${a}.json`:"http://iiif.io/api/image/2/level0.json",...r}}return e}function Me(e){if(e&&0!==e.length)return e.map(Ie)}function*Oe(e){return[["label",e.label],["metadata",Pe(e.metadata)],["summary",e.summary],["requiredStatement",e.requiredStatement],["rights",e.rights],["navDate",e.navDate],["language",e.language],["thumbnail",Pe(yield e.thumbnail)],["placeholderCanvas",yield e.placeholderCanvas],["accompanyingCanvas",yield e.accompanyingCanvas],["provider",Pe(yield e.provider)]]}function*ke(e){return[["seeAlso",Pe(yield e.seeAlso)],["service",Me(e.service)],["services",Me(e.services)],["rendering",Pe(yield e.rendering)],["supplementary",Pe(yield e.supplementary)],["homepage",Pe(yield e.homepage)],["logo",Pe(yield e.logo)],["partOf",Pe(yield e.partOf)],["start",e.start]]}const De={Manifest:function*(e,t,{isTopLevel:i}){return i?[["@context","http://iiif.io/api/presentation/3/context.json"],...Le(e),...yield*Oe(e),...yield*ke(e),["items",yield e.items],["structures",Pe(yield e.structures)],["annotations",Pe(yield e.annotations)]]:[...Le(e),...yield*Oe(e)]},Canvas:function*(e){return[...Le(e),...yield*Oe(e),...yield*ke(e),["items",yield e.items],["annotations",Pe(yield e.annotations)]]},Agent:function*(e){return[["id",e.id],["type","Agent"],["label",e.label],...yield*ke(e)]},AnnotationPage:function*(e){return[...Object.entries(e).map((([e,t])=>[e,Array.isArray(t)?Pe(t):t])).filter((([e,t])=>"items"!==e)),...yield*ke(e),["items",yield e.items]]},Service:function*(e){return[[ge,Ie(e)]]},Annotation:function*(e){const t=Object.entries(e).map((([e,t])=>"motivation"===e?[e,Array.isArray(t)?t[0]:t]:[e,Array.isArray(t)?Pe(t):t])).filter((([e])=>"body"!==e)),i=yield e.body;return[...t,["body",1===i.length?i[0]:i]]},ContentResource:function*(e){return[...Le(e),...yield*Oe(e),...yield*ke(e),["annotations",Pe(yield e.annotations)],["items",Pe(yield e.items)]]},AnnotationCollection:function*(e){return[["id",e.id],["type","AnnotationCollection"],["label",e.label]]},Collection:function*(e,t,{isTopLevel:i}){return i?[["@context","http://iiif.io/api/presentation/3/context.json"],...Le(e),...yield*Oe(e),...yield*ke(e),["items",Pe(yield e.items)]]:[...Le(e),...yield*Oe(e)]},Range:function*(e){const t=[];for(const i of e.items)"Range"===i.type?t.push(yield i):t.push(i);return[...Le(e),...yield*Oe(e),...yield*ke(e),["items",t],["annotations",Pe(yield e.annotations)]]}};return{Presentation2:K,Presentation3:Object.freeze(Object.defineProperty({__proto__:null,EMPTY:Q,emptyAnnotation:X,emptyAnnotationPage:Z,emptyCanvas:ee,emptyCollection:te,emptyManifest:ie,emptyRange:ne,emptyAgent:re,defaultEntities:{Collection:{},Manifest:{},Canvas:{},AnnotationPage:{},AnnotationCollection:{},Annotation:{},ContentResource:{},Range:{},Service:{},Selector:{},Agent:{}},getDefaultEntities:le,mergeEntities:ve,normalize:function(e){const t=Y(e),i={Collection:{},Manifest:{},Canvas:{},AnnotationPage:{},AnnotationCollection:{},Annotation:{},ContentResource:{},Range:{},Service:{},Selector:{},Agent:{}},n={},r=function(e){return(t,i)=>{const n=e[t]?e[t]:{};return e=>{const r=ce(e,i||t);return r&&r.id&&t?(n[r.id]=n[r.id]?ve(n[r.id],r):Object.assign({},r),{id:r.id,type:"ContentResource"===t?t:r.type}):r}}}(i),a=function(e){return(t,i)=>n=>{const{id:r,type:a}=ce(n,i||t);if(void 0===r)throw new Error("Found invalid entity without an ID.");return e[r]="ContentResource"===t?t:a,n}}(n);return{entities:i,resource:new oe({collection:[fe(te),a("Collection"),r("Collection")],manifest:[fe(ie),a("Manifest"),r("Manifest")],canvas:[fe(ee),a("Canvas"),r("Canvas")],annotationPage:[he("AnnotationPage"),fe(Z),a("AnnotationPage"),r("AnnotationPage")],annotation:[he("Annotation"),de,a("Annotation"),r("Annotation")],contentResource:[he("ContentResource"),a("ContentResource"),r("ContentResource")],range:[fe(ne),a("Range","Canvas"),r("Range","Canvas")],agent:[fe(re),a("Agent"),r("Agent")]}).traverseUnknown(t),mapping:n}},types:ae,identifyResource:se,Traverse:oe,UNSET:me,UNWRAP:ge,serializedFieldsToObject:Ae,serialize:function(e,t,i){if(!t.type||!t.id)throw new Error("Unknown entity");if(!i[t.type])throw new Error(`Serializer not found for ${t.type}`);return function n(r){const a=i[r.type];if(!a)return me;const s=function(e,t){const i=e.requests[t],n=e.mapping[t];if(n&&(!i||!i.resourceUri||e.entities[n][i.resourceUri]))return e.entities[n][i?i.resourceUri:t]}(e,r.id)||(r.id&&r.type?r:null);if(!s)return me;const o=a(s,e,{isTopLevel:t.id===r.id});let l=o.next();for(;!l.done;){const e=l.value;let t=me;if(e)if(Array.isArray(e)){const i=[];for(const t of e)i.push(n(t));t=i}else t=n(e);l=o.next(t)}return l.value===me?me:Ae(l.value)}(t)},languageString2to3:Ce,serializeConfigPresentation2:je,serializeConfigPresentation3:De},Symbol.toStringTag,{value:"Module"}))}}));
//# sourceMappingURL=index.umd.js.map
