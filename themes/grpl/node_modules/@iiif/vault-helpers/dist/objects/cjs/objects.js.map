{"version":3,"file":"objects.js","sources":["../../../src/objects.ts"],"sourcesContent":["import { Vault } from '@iiif/vault';\nimport { Manifest, Reference } from '@iiif/presentation-3';\n\nfunction defineProperty(name: string, prototype: any, vault: Vault) {\n  prototype[DEFINED] = prototype[DEFINED] || [];\n  prototype[DEFINED].push(name);\n\n  Object.defineProperty(prototype, name, {\n    get(): any {\n      if (typeof prototype[REFS][name] === 'undefined') {\n        return undefined;\n      }\n\n      const ref = prototype[REFS][name];\n      if (!ref) {\n        return ref;\n      }\n\n      return wrapObject(vault.get(prototype[REFS][name]), vault);\n    },\n    set(items: any) {\n      const existing = prototype[REFS][name];\n      if (existing !== items) {\n        this[REFS][name] = items;\n\n        // This was a hack, but a much more clever implementation here could make very flexible editing.\n        // For example - manifest.label = \"Something\" -> manifest.label = {none: \"something\"}; etc.\n        // Although this might be better in a different library completely.\n        // if (this[REACTIVE]) {\n        //   vault.modifyEntityField({ id: prototype.id, type: prototype.type }, name, unwrapObject(items));\n        // }\n      }\n    },\n  });\n}\n\nconst REFS = Symbol.for('_refs_');\nconst REACTIVE = Symbol.for('_reactive_');\nconst DEFINED = Symbol.for('_defined_');\n\nfunction createPrototype(vault: Vault, reactive = false) {\n  const prototype = {\n    id: null,\n    [DEFINED]: [] as any[],\n    [REFS]: {},\n    [REACTIVE]: null as null | (() => void),\n\n    is(refOrObject: any) {\n      if (typeof refOrObject === 'string') {\n        return this.id === refOrObject;\n      }\n\n      if (refOrObject.id) {\n        return refOrObject.id === this.id;\n      }\n\n      return false;\n    },\n\n    reactive() {\n      if (this[REACTIVE]) {\n        return;\n      }\n\n      this[REACTIVE] = this.subscribe(() => this.refresh(), true);\n\n      return () => {\n        this.unreactive();\n      };\n    },\n\n    refresh() {\n      if (this.id) {\n        const fresh = this.unwrap();\n        for (const key of Object.keys(fresh || {})) {\n          if (this[DEFINED].includes(key)) {\n            (this as any)[REFS][key] = fresh[key as any];\n          } else {\n            (this as any)[key] = fresh[key as any];\n          }\n        }\n      }\n    },\n\n    unreactive() {\n      if (this[REACTIVE]) {\n        this[REACTIVE]();\n        this[REACTIVE] = null;\n      }\n    },\n\n    unwrap() {\n      if (!this.id) {\n        throw new Error('Invalid object');\n      }\n      return vault.get(this.id);\n    },\n\n    toPresentation3() {\n      return vault.toPresentation3(this.unwrap() as any);\n    },\n\n    toPresentation2() {\n      return vault.toPresentation2(this.unwrap() as any);\n    },\n\n    toJSON() {\n      const that = this as any;\n      return {\n        ...that,\n        items: that.items,\n        annotations: that.annotations,\n        structures: that.structures,\n        seeAlso: that.seeAlso,\n        service: that.service,\n        services: that.services,\n        rendering: that.rendering,\n        partOf: that.partOf,\n        start: that.start,\n        supplementary: that.supplementary,\n        homepage: that.homepage,\n        thumbnail: that.thumbnail,\n        placeholderCanvas: that.placeholderCanvas,\n        accompanyingCanvas: that.accompanyingCanvas,\n        provider: that.provider,\n      };\n    },\n    subscribe(subscription: (object: any, vault: Vault) => void, skipInitial = true) {\n      return vault.subscribe(\n        () => {\n          return this.id ? vault.get(this.id) : null;\n        },\n        subscription,\n        skipInitial\n      );\n    },\n  };\n\n  // Structural\n  defineProperty('items', prototype, vault);\n  defineProperty('annotations', prototype, vault);\n  defineProperty('structures', prototype, vault);\n\n  // Linking\n  defineProperty('seeAlso', prototype, vault);\n  defineProperty('service', prototype, vault);\n  defineProperty('services', prototype, vault);\n  defineProperty('rendering', prototype, vault);\n  defineProperty('partOf', prototype, vault);\n  defineProperty('start', prototype, vault);\n  defineProperty('supplementary', prototype, vault);\n  defineProperty('homepage', prototype, vault);\n\n  // Descriptive\n  defineProperty('thumbnail', prototype, vault);\n  defineProperty('placeholderCanvas', prototype, vault);\n  defineProperty('accompanyingCanvas', prototype, vault);\n  defineProperty('provider', prototype, vault);\n\n  // Annotation\n  defineProperty('body', prototype, vault);\n  defineProperty('logo', prototype, vault);\n\n  return prototype;\n}\n\nexport function unwrapObject(object: any): any {\n  if (Array.isArray(object)) {\n    return object.map((o) => unwrapObject(o)) as any;\n  }\n\n  if (!object || !object.type) {\n    return object;\n  }\n\n  return { id: object.id, type: object.type };\n}\n\nexport function wrapObject(object: any, vault: Vault, reactive = false): any {\n  if (Array.isArray(object)) {\n    return object.map((o) => wrapObject(o, vault, reactive));\n  }\n\n  if (!object || !object.type || !object.id) {\n    return object;\n  }\n\n  const prototype = createPrototype(vault, reactive);\n  const newObject = Object.create(prototype);\n\n  const wrapped =  Object.assign(newObject, object) as any;\n\n  if (reactive) {\n    wrapped.reactive();\n  }\n\n  return wrapped;\n}\n\nexport function createObjectsHelper(vault: Vault) {\n  return {\n    get(id: string | Reference | string[] | Reference[], reactive = false) {\n      return wrapObject(vault.get(id as any), vault, reactive);\n    },\n    async load(id: string | Reference<any>, json?: any): Promise<Manifest> {\n      return wrapObject(await vault.load(id, json), vault);\n    },\n    async loadManifest(id: string | Reference<any>, json?: any): Promise<Manifest> {\n      return wrapObject(await vault.loadManifest(id, json), vault);\n    },\n    async loadCollection(id: string | Reference<any>, json?: any) {\n      return wrapObject(await vault.loadCollection(id, json), vault);\n    },\n    wrapObject<T>(objectType: Reference<T>) {\n      return wrapObject(vault.get(objectType, { skipSelfReturn: false }), vault);\n    },\n    isWrapped(object: any) {\n      return !!object[DEFINED];\n    },\n  };\n}\n"],"names":["defineProperty","name","prototype","vault","DEFINED","REFS","ref","wrapObject","items","REACTIVE","createPrototype","reactive","refOrObject","fresh","key","that","subscription","skipInitial","unwrapObject","object","o","newObject","wrapped","createObjectsHelper","id","json","objectType"],"mappings":"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"}