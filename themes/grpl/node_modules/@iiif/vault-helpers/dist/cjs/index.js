"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const U={},I={get(e){return e},setMetaValue([e,t,r],i){const n=I.getResourceMeta(e,t),s=n?n[r]:void 0,o=typeof i=="function"?i(s):i;U[e]={...U[e]||{},[t]:{...(U[e]||{})[t]||{},[r]:o}}},getResourceMeta:(e,t)=>{const r=U[e];if(!!r)return t?r[t]:r}};function ft(e=I){return{addEventListener(t,r,i,n){if(!!t)return e.setMetaValue([t.id,"eventManager",r],s=>{const o=s||[];for(const a of o)if(a.callback===i)return o;return[...o,{callback:i,scope:n}]}),i},removeEventListener(t,r,i){!t||e.setMetaValue([t.id,"eventManager",r],n=>(n||[]).filter(s=>s.callback!==i))},getListenersAsProps(t,r){const i=typeof t=="string"?{id:t}:t;if(!i||!i.id)return{};const n=e.getResourceMeta(i.id,"eventManager"),s={};if(n&&i)for(const o of Object.keys(n))s[o]=a=>{const c=e.get(i);for(const{callback:u,scope:f}of n[o]||[])(!f||r&&f.indexOf(r)!==-1)&&u(a,c)};return s}}}function ut(e=I){return{applyStyles(t,r,i){const n=typeof t=="string"?t:t.id;return e.setMetaValue([n,"styles",r],i)},getAppliedStyles(t){const r=typeof t=="string"?t:t.id;return e.getResourceMeta(r,"styles")}}}function P(e){return e.endsWith("info.json")?e:e.endsWith("/")?`${e}info.json`:`${e}/info.json`}const ht="http://library.stanford.edu/iiif/image-api/compliance.html#level0",be="http://library.stanford.edu/iiif/image-api/compliance.html#level1",we="http://library.stanford.edu/iiif/image-api/compliance.html#level2",pt="http://library.stanford.edu/iiif/image-api/conformance.html#level0",Se="http://library.stanford.edu/iiif/image-api/conformance.html#level1",Ae="http://library.stanford.edu/iiif/image-api/conformance.html#level2",dt="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0",Fe="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1",Me="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2",gt="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0",Ce="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1",Oe="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2",yt="http://iiif.io/api/image/1/level0.json",mt="http://iiif.io/api/image/1/profiles/level0.json",ke="http://iiif.io/api/image/1/level1.json",Re="http://iiif.io/api/image/1/profiles/level1.json",Ie="http://iiif.io/api/image/1/level2.json",je="http://iiif.io/api/image/1/profiles/level2.json",vt="http://iiif.io/api/image/2/level0.json",xt="http://iiif.io/api/image/2/profiles/level0.json",Te="http://iiif.io/api/image/2/level1.json",ze="http://iiif.io/api/image/2/profiles/level1.json",$e="http://iiif.io/api/image/2/level2.json",We="http://iiif.io/api/image/2/profiles/level2.json",bt="level0",Be="level1",Pe="level2",wt="http://iiif.io/api/image/2/level0",qe="http://iiif.io/api/image/2/level1",He="http://iiif.io/api/image/2/level2",Le=[He,we,Ae,Me,Oe,Ie,je,$e,We,Pe],_e=[...Le,qe,be,Se,Fe,Ce,ke,Re,Te,ze,Be],St=[wt,qe,He,ht,be,we,pt,Se,Ae,dt,Fe,Me,gt,Ce,Oe,yt,mt,ke,Re,Ie,je,vt,xt,Te,ze,$e,We,bt,Be,Pe],At={extraFormats:["jpg"],extraQualities:["default"],extraFeatures:["sizeByWhListed"]},Ft={extraFormats:["jpg"],extraQualities:["default"],extraFeatures:["baseUriRedirect","cors","jsonldMediaType","regionByPx","regionSquare","sizeByWhListed","sizeByH","sizeByW","sizeByWh"]},Mt={extraFormats:["jpg","png"],extraQualities:["default"],extraFeatures:["baseUriRedirect","cors","jsonldMediaType","regionByPct","regionByPx","regionSquare","rotationBy90s","sizeByWhListed","sizeByConfinedWh","sizeByH","sizeByPct","sizeByW","sizeByWh"]};function Ct(e){return Le.indexOf(e)!==-1?Mt:_e.indexOf(e)!==-1?Ft:At}function Ot(e){const t=e?Array.isArray(e.profile)?e.profile:[e.profile]:[],r={extraQualities:[],extraFormats:[],extraFeatures:[]};for(let i of t)if(typeof i=="string"&&(i=Ct(i)),!!i){if(i.formats)for(const n of i.formats)r.extraFormats.indexOf(n)===-1&&r.extraFormats.push(n);if(i.qualities)for(const n of i.qualities)r.extraQualities.indexOf(n)===-1&&r.extraQualities.push(n);if(i.supports)for(const n of i.supports)r.extraFeatures.indexOf(n)===-1&&r.extraFeatures.push(n);if(i.maxHeight&&(r.maxHeight=i.maxHeight),i.maxWidth&&(r.maxWidth=i.maxWidth),i.maxArea&&(r.maxArea=i.maxArea),i.extraFormats)for(const n of i.extraFormats)r.extraFormats.indexOf(n)===-1&&r.extraFormats.push(n);if(i.extraQualities)for(const n of i.extraQualities)r.extraQualities.indexOf(n)===-1&&r.extraQualities.push(n);if(i.extraFeatures)for(const n of i.extraFeatures)r.extraFeatures.indexOf(n)===-1&&r.extraFeatures.push(n);i.maxHeight&&(r.maxHeight=i.maxHeight),i.maxWidth&&(r.maxWidth=i.maxWidth),i.maxArea&&(r.maxArea=i.maxArea)}if(e.extraFormats)for(const i of e.extraFormats)r.extraFormats.indexOf(i)===-1&&r.extraFormats.push(i);if(e.extraFeatures)for(const i of e.extraFeatures)r.extraFeatures.indexOf(i)===-1&&r.extraFeatures.push(i);if(e.extraQualities)for(const i of e.extraQualities)r.extraQualities.indexOf(i)===-1&&r.extraQualities.push(i);return r}function kt(e){try{if(e==="full")return{full:!0};if(e==="square")return{square:!0};const t=e.startsWith("pct:"),r=e.substr(t?4:0).split(",").map(i=>parseFloat(i));return{x:r[0],y:r[1],w:r[2],h:r[3],percent:t}}catch{throw new Error("Expected 'full', 'square' or 'x,y,w,h'. Found "+e)}}function Rt(e){const t={upscaled:!1,max:!1,confined:!1};if(e[0]==="^"&&(t.upscaled=!0,e=e.slice(1)),e==="max"||e==="full")return t.max=!0,t.serialiseAsFull=e==="full",t;if(e[0]==="!"&&(t.confined=!0,e=e.slice(1)),e[0]==="p")return t.percentScale=parseFloat(e.slice(4)),t;const r=e.split(",").map(i=>i.trim());return r.length&&(r[0]!==""&&(t.width=parseInt(r[0],10)),r[1]!==""?(t.height=parseInt(r[1],10),t.version=2):t.version=3),t}function It(e){const t={angle:0};if(e[0]==="!"&&(t.mirror=!0,e=e.substr(1)),t.angle=parseFloat(e)%360,Number.isNaN(t.angle))throw new Error(`Invalid rotation ${e}`);return t}function jt(e,t=""){const r=e.match(/^(([a-zA-Z]+):\/\/([^/]+))?((.*)+)/);if(!r)throw new Error(`Invalid or unknown input ${e}`);const i=r[2],n=r[3];let s=r[4];if(s[0]==="/"&&(s=s.substr(1)),t.length>0){if(t[0]==="/"&&(t=t.substr(1)),t!==s.substr(0,t.length))throw new Error(`Path does not start with prefix (path: ${s}, prefix: ${t})`);s=s.substr(t.length)}return{scheme:i,server:n,path:s,prefix:t}}function Tt(e,t=""){const{path:r,scheme:i,server:n,prefix:s}=jt(e,t),o=r.split("/").reverse(),[a,c,u,f,...p]=o,h=p.reverse().filter(Boolean).join("/");if(o.length===1||a==="")return{type:"base",scheme:i,server:n,prefix:s,identifier:h};if(a==="info.json"){const[,...l]=o;return{type:"info",scheme:i,server:n,prefix:s,identifier:l.reverse().filter(Boolean).join("/")}}const g=a.split(".");return{type:"image",scheme:i,server:n,prefix:s,identifier:h,originalPath:r,region:kt(f),size:Rt(u),rotation:It(c),quality:g[0],format:g[1]}}function zt(e){const t=Tt(P(e.id));if(t.type!=="info")throw new Error("Invalid service URL");const r=Ot(e);return{identifier:t.identifier,originalPath:"",server:t.server,prefix:t.prefix,scheme:t.scheme,type:"image",quality:r.extraQualities.indexOf("default")===-1?r.extraQualities[0]:"default",region:{full:!0},size:{max:!0,upscaled:!1,confined:!1},format:"jpg",rotation:{angle:0}}}function $t(e,t,r){const i=r.length,n=[];for(let s=0;s<i;s++){const o=r[s].width;n.push(e/o)}return n}function Wt(e,t,r){const i=r.length,n=[];for(let s=0;s<i;s++){const o=r[s];n.push({width:Math.floor(e/o),height:Math.floor(t/o)})}return n}function A(e){if(e["@id"])return e["@id"];if(e.id)return e.id}function J(e){if(!e||!e.profile||!A(e))return!1;const t=Array.isArray(e.profile)?e.profile:[e.profile];for(const r of t)if(typeof r=="string"&&St.indexOf(r)!==-1)return!0;return!1}function Bt(e){if(!J(e))return!1;const t=Array.isArray(e.profile)?e.profile:[e.profile];for(const r of t)if(typeof r=="string"){if(_e.indexOf(r)!==-1)return!0}else{const i=[...r.supports||[],...r.extraFeatures||[]];if(i.indexOf("regionByPx")!==-1&&(i.indexOf("sizeByW")!==-1||i.indexOf("sizeByWh")!==-1))return!0}return!1}function D(e,t){if(t&&t.profile){const r=t.profile;if(r){const i=Array.isArray(r)?r:[r];return i.includes(`level${e}`)||i.includes(`http://iiif.io/api/image/2/level${e}.json`)||i.includes(`http://iiif.io/api/image/1/level${e}.json`)||i.includes(`http://iiif.io/api/image/1/profiles/level${e}.json`)}}return!1}function te(e){return J(e)?D(0,e)?0:D(1,e)?1:D(2,e)?2:null:null}function Qe(e){return(e["@context"]?Array.isArray(e["@context"])?e["@context"]:[e["@context"]]:[]).indexOf("http://iiif.io/api/image/3/context.json")!==-1}function Pt(e){if(!Bt(e))return[];const t=[],r=Array.isArray(e.profile)?e.profile:[e.profile],i=r.length;for(let n=0;n<i;n++){const s=r[n];if(typeof s!="string"&&(s.maxHeight||s.maxWidth))return[{id:A(e),type:"variable",minWidth:0,minHeight:0,maxHeight:s.maxHeight||s.maxWidth,maxWidth:s.maxWidth||s.maxHeight,level:te(e),version:e["@context"]==="http://iiif.io/api/image/3/context.json"?3:2}]}if(e.tiles){const n=e.tiles.length;for(let s=0;s<n;s++){const o=e.tiles[s];(o.height||o.width)&&t.push({id:A(e),type:"variable",minHeight:0,minWidth:0,maxHeight:o.height||o.width,maxWidth:o.width,level:te(e),version:Qe(e)?3:2})}}return t}function ue(e){const t=/^.*\/(full)\/(((\d+),(\d+)?)|max)\/(\d+)\/default\.(jpg|png|jpeg)$/,r=e.match(t);if(r){const i=r[1],n=parseInt(r[4],10),s=parseInt(r[5],10),o=r[7];if((i==="max"||i==="full")&&n&&s&&o)return{type:"fixed",id:e,height:s,width:n}}return{type:"unknown",id:e}}function qt(e){if(e["@type"])return e["@type"];if(e.type)return e.type}function ie(e){if(typeof e=="string")return ue(e);const t=qt(e);if(t!=="Image"&&t!=="sc:Image")return null;const r=e,i=A(r);return i?i&&r.width&&r.height?{id:i,type:"fixed",width:r.width,height:r.height,unsafe:!0}:ue(i):null}function Ht(e){return J(e)?(e&&e.sizes?e.sizes:[]).map(t=>({id:A(e),type:"fixed-service",height:t.height,width:t.width,level:te(e),version:Qe(e)?3:2})):[]}function he(e){const t=[],r=e.length;for(let i=0;i<r;i++){const n=Ht(e[i]);n.length&&t.push(...n);const s=Pt(e[i]);s.length&&t.push(...s)}return t}function Ve(e){const t=e.service?Array.isArray(e.service)?e.service:[e.service]:[],r=t.length,i=[];for(let n=0;n<r;n++)J(t[n])&&i.push(t[n]);return i}function Lt(e,t=!0,r){const i=[],n=ie(e);if(n===null)return i;const s=e;if(i.push(n),t&&s.width&&s.height){const o=[],a=Ve(s);for(const c of a){const u={id:A(c),width:s.width,height:s.height};if(r.canLoadSync(u)){const f=r.loadServiceSync(u);f&&(f.height||(f.height=s.height),f.width||(f.width=s.width),o.push(...he([f])))}}if(o.length)return i.push(...o),i}return s.service&&i.push(...he(s.service)),i}function _t({x:e=0,y:t=0,w:r,h:i,full:n,square:s,percent:o}){if(n)return"full";if(s)return"square";if(typeof r>"u"||typeof i>"u")throw new Error("RegionParameter: invalid region");const a=`${e},${t},${r},${i}`;return o?`pct:${a}`:a}function Qt({max:e,percentScale:t,upscaled:r,confined:i,width:n,height:s,serialiseAsFull:o,version:a}){const c=[];return r&&c.push("^"),e?(c.push(o?"full":"max"),c.join("")):(i&&c.push("!"),t&&c.push(`pct:${t}`),n&&c.push(`${n}`),c.push(","),s&&a===3&&c.push(`${s}`),c.join(""))}function Vt(e){return`${e.mirror?"!":""}${(e.angle||0)%360}`}var Nt=Object.defineProperty,Et=Object.defineProperties,Ut=Object.getOwnPropertyDescriptors,pe=Object.getOwnPropertySymbols,Dt=Object.prototype.hasOwnProperty,Jt=Object.prototype.propertyIsEnumerable,de=(e,t,r)=>t in e?Nt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,$=(e,t)=>{for(var r in t||(t={}))Dt.call(t,r)&&de(e,r,t[r]);if(pe)for(var r of pe(t))Jt.call(t,r)&&de(e,r,t[r]);return e},W=(e,t)=>Et(e,Ut(t));function Xt(e,t){const r=e.prefix.startsWith("/")?e.prefix.substr(1):e.prefix,i=`${e.scheme}://${e.server}/${r?`${r}/`:""}${e.identifier}`;if(e.type==="base")return i;if(e.type==="info")return`${i}/info.json`;let{size:n}=e;const{region:s,rotation:o,format:a,quality:c}=e;if(t){const u=t["@context"]?Array.isArray(t["@context"])?t["@context"]:[t["@context"]]:[],f=u.indexOf("http://iiif.io/api/image/2/context.json")!==-1,p=u.indexOf("http://iiif.io/api/image/3/context.json")!==-1;if((n.width===t.width&&!n.height||n.height===t.height&&!n.width||n.width===t.width&&n.height===t.height)&&(n=W($({},n),{max:!0})),f&&(n.max&&!n.serialiseAsFull&&(n=W($({},n),{serialiseAsFull:!0})),!n.max&&n.width&&n.height&&(n=W($({},n),{height:void 0})),n=W($({},n),{version:2})),p){if(n.max&&n.serialiseAsFull&&(n=W($({},n),{serialiseAsFull:!1})),n.width&&!n.height&&t.width&&t.height){const h=t.height/t.width;n=W($({},n),{height:Math.ceil(n.width*h)})}n=W($({},n),{version:3})}}return[i,_t(s),Qt(n),Vt(o),`${c}.${a}`].filter(Boolean).join("/")}function Z(e,t,r){const i=zt({"@context":e.version===3?"http://iiif.io/api/image/3/context.json":"http://iiif.io/api/image/2/context.json",id:P(A(e)),profile:e.level===null||typeof e.level>"u"?"level0":`level${e.level}}`,type:e.version===3?"ImageService3":"ImageService2"});if(i.type!=="image")throw new Error("Invalid service");return i.size.max=!1,i.size.width=t,i.size.height=r,{id:Xt(i),type:"fixed",width:t,height:r||e.height/(e.width||1)*t,unsafe:e.width>t}}function H(e){const t=e.replace(/(https?:\/\/)?(www.)?/i,"");return t.indexOf("/")!==-1?t.split("/")[0]:t}function Gt(e,t,r){const i=e.width?e.width:e.maxWidth;return r.height<=e.maxHeight&&r.width<=e.maxWidth&&r.height>=e.minHeight&&r.width>=e.minWidth&&(!t||Math.abs(r.width-i)<Math.abs(t.width-i))}function Yt(e,t){const r=[],i=Object.assign({unsafeImageService:!1,atAnyCost:!0,fallback:!0,minHeight:64,minWidth:64,maxHeight:1/0,maxWidth:1/0,returnAllOptions:!1,preferFixedSize:!1,allowUnsafe:!1,explain:!1,height:0,width:0},e),n=(f,p=0)=>i.explain?r.push(new Array(p).fill(0).map(h=>"    ").join("")+f().trim()):void 0,s=[],o=[];let a=null;n(()=>`Using configuration: ${JSON.stringify(i,null,2)}`);const c=(f,p)=>{if(n(()=>"Swapping choice",3),Gt(i,p,f)){if(i.preferFixedSize&&f.unsafe){n(()=>`We found an image that was marked as unsafe, but it was the best size. (${f.id})`,4),o.push(f);return}i.returnAllOptions&&p&&o.push(p),n(()=>`We found a new image that was the best size. (${f.id})`,4),a=f}else i.returnAllOptions&&o.push(f)};n(()=>`The input shows we have ${t.length} list(s) of candidates to choose from.`);const u=t.length;for(let f=0;f<u;f++){const p=t[f]();n(()=>`Candidate group ${f}: ${JSON.stringify(p,null,2)}`,1);const h=p.length;n(()=>`Checking candidate list number ${f} and found ${h} potential ways of creating image(s)`,1);for(let g=0;g<h;g++){const l=p[g];if(n(()=>`-> Checking candidate ${g}`,1),l.type==="unknown"&&i.atAnyCost&&(n(()=>`We've found an unknown image type, adding this to the "last resort" list`,2),s.push(l)),l.type==="fixed"&&(l.unsafe?(n(()=>`We've found an unsafe fixed image type, adding this to the "last resort" list`,2),s.push(l)):(n(()=>"We've found a fixed size image, checking if it matches the request",2),c(l,a))),l.type==="fixed-service")if(i.unsafeImageService){n(()=>"Checking for an image from the tile source, without calculating the right height and width (unsafeImageService)",2);const m=Z(l,i.width,i.height);c(m,a)}else{n(()=>"Checking for an image from the tile source 3",2);const m=Z(l,l.width,l.height);c(m,a)}if(l.type==="variable"&&l.maxWidth){const m=Z({id:l.id,type:"fixed-service",width:l.maxWidth,height:l.maxWidth,level:l.level,version:l.version},l.maxWidth);c(m,a)}}if(a&&!i.returnAllOptions){if(a.unsafe||i.allowUnsafe)continue;n(()=>`We found a match in choice list number ${f}, no searching any more`);break}}return i.atAnyCost&&o.length===0?(n(()=>a?`We found an image! ${a.id} of type ${a.type}`:'We found no images, but "atAnyCost" is set, so returning that'),{best:a||s[0],fallback:s.slice(1),log:r}):i.returnAllOptions?(n(()=>"Returning all options that we have found"),{best:i.atAnyCost?a||o[0]||s[0]:a||o[0],fallback:[...o,...s],log:r}):(n(()=>"Returning the best image that we found, and a fallback"),{best:a||o[0]||null,fallback:a?o:o.slice(1),log:r})}var Zt=Object.defineProperty,Kt=Object.defineProperties,ei=Object.getOwnPropertyDescriptors,ge=Object.getOwnPropertySymbols,ti=Object.prototype.hasOwnProperty,ii=Object.prototype.propertyIsEnumerable,ye=(e,t,r)=>t in e?Zt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,ri=(e,t)=>{for(var r in t||(t={}))ti.call(t,r)&&ye(e,r,t[r]);if(ge)for(var r of ge(t))ii.call(t,r)&&ye(e,r,t[r]);return e},ni=(e,t)=>Kt(e,ei(t));function si(e,t,r){const i=e>t?e:t,n=r.length,s=[];for(let o=0;o<n;o++){const a=r[o];let c=a.scaleFactors[0],u=i/c;const f=[c];for(;u>=a.width;)c=c*2,f.push(c),u=u/2;s.push(ni(ri({},a),{scaleFactors:f}))}return s}function oi(e,t){if(e.length!==t.length)return!1;if(e.length===0&&t.length===0)return!0;const r=e.length;let i=!0;for(let s=0;s<r;s++){const o=e[s],a=t[s];if(o.width!==a.width||o.height!==a.height){i=!1;break}}if(i)return!0;let n=0;for(let s=0;s<r;s++)for(let o=0;o<r;o++)if(e[s].width===t[o].width&&e[s].height===t[o].height){n++;break}return n===r}function me(e){return D(0,e)}var B=(e,t,r)=>new Promise((i,n)=>{var s=c=>{try{a(r.next(c))}catch(u){n(u)}},o=c=>{try{a(r.throw(c))}catch(u){n(u)}},a=c=>c.done?i(c.value):Promise.resolve(c.value).then(s,o);a((r=r.apply(e,t)).next())});class Ne{constructor(){this.config={verificationsRequired:1,approximateServices:!0,enableFetching:!0,disableThrottling:!1},this.fetchingCount=0,this.imageServices={},this.knownImageServers={}}setConfig(t){Object.assign(this.config,t)}sample(t,r,i=!0){const n=H(A(t)),s=P(A(t)),o=this.knownImageServers[n];return this.imageServices[s]=Object.assign(t,{real:!0}),!o&&t.tiles&&!me(t)?(this.knownImageServers[n]={verifications:0,malformed:!1,root:n,preLoaded:i,sampledId:A(t),verified:!1,server:null,result:{context:t["@context"]||[],sampledProfile:t.profile,resourceServiceRatio:r&&t.height?r.height/t.height:1,sampledSizes:t.sizes||[],sizeRatios:$t(t.width,t.height,t.sizes||[]),sampledTiles:t.tiles||[]}},!0):this.verify(t)}preLoad(t,r=!0){this.knownImageServers[t.root]=t,r&&(this.knownImageServers[t.root].malformed=!1,this.knownImageServers[t.root].verifications=this.config.verificationsRequired)}predict(t,r=!1,i=!1){const n=t==null?void 0:t.source,s=H(A(t)),o=this.knownImageServers[s];if(!o||!o.result||!((n==null?void 0:n.height)||t.height)||!((n==null?void 0:n.width)||t.width)||!i&&(o.malformed||o.verifications<this.config.verificationsRequired)||me(t.source))return null;const a=P(A(t));return this.imageServices[a]||(this.imageServices[a]={"@context":o.result.context,"@id":A(t),id:A(t),protocol:"http://iiif.io/api/image",tiles:(n==null?void 0:n.tiles)||si(t.width,t.height,o.result.sampledTiles),sizes:(n==null?void 0:n.sizes)||Wt(Math.round(t.width/o.result.resourceServiceRatio),Math.round(t.height/o.result.resourceServiceRatio),o.result.sizeRatios),profile:(n==null?void 0:n.profile)||o.result.sampledProfile,height:(n==null?void 0:n.height)||t.height,width:(n==null?void 0:n.width)||t.width,real:!1}),this.imageServices[a]}getThumbnailFromResource(t,r){return B(this,arguments,function*(i,n,s=!0,o=[]){const a=i?yield this.getImageCandidates(i,s):[];return Yt(n,[()=>o,()=>a])})}getImageCandidates(t,r=!0){return B(this,null,function*(){const i=t;if(r&&i.height&&i.width){const n=Ve(i);for(const s of n){const o={id:A(s),width:s.width?s.width:i.width,height:s.height?s.height:i.height,source:s};yield this.loadService(o)}}return Lt(t,r,this)})}verify(t){return B(this,null,function*(){const r=this.predict(t,!1,!0),i=yield this.fetchService(A(t));if(!r)return!1;const n=r.height===i.height&&r.width===i.width&&r["@context"]===i["@context"]&&oi(r.sizes||[],i.sizes||[]);if(n){const s=H(A(t));this.knownImageServers[s].verifications+=1,this.knownImageServers[s].verifications>=this.config.verificationsRequired&&(this.knownImageServers[s].verified=!0)}return n})}canLoadSync(t){const r=typeof t=="string"?t:A(t),i=P(r);if(this.imageServices[i])return!0;const n=this.knownImageServers[H(r)];return n&&!n.malformed&&n.verifications>=this.config.verificationsRequired}markAsMalformed(t){return B(this,null,function*(){return this.knownImageServers[H(A(t))].malformed=!0,this.loadService(t,!0)})}fetchService(t,r=!1){return B(this,null,function*(){const i=P(t);if(this.imageServices[i]&&(!r||this.imageServices[i].real))return this.imageServices[i];if(!this.config.enableFetching)throw new Error("Fetching is not enabled");const n=yield this.fetch(i).then(s=>s.json());return!n.id&&n["@id"]&&(n.id=n["@id"]),n.id!==t&&(n.id=t,n["@id"]&&(n["@id"]=t)),this.imageServices[i]=Object.assign(n,{real:!0}),this.imageServices[i]})}fetch(t,r){return B(this,null,function*(){return fetch(t,r)})}loadService(t,r=!1){return B(this,null,function*(){if(!this.config.disableThrottling){let s=!0;for(;s;)if(this.fetchingCount>=this.config.verificationsRequired)yield new Promise(o=>setTimeout(o,500));else{s=!1;break}}const i=this.knownImageServers[H(A(t))];if(i&&!i.malformed&&!r){yield i.result;const s=this.loadServiceSync(t);if(s)return s}this.fetchingCount++;const n=yield this.fetchService(A(t),r);return this.fetchingCount--,n.real&&this.sample(n,t),n})}loadServiceSync(t){const r=P(A(t));return this.imageServices[r]?this.imageServices[r]:this.predict(t)}}new Ne;function ai(e=I,t={}){const r=t.imageServiceLoader||new Ne;async function i(n,s,o,a=[],c){const u=()=>r.getThumbnailFromResource(void 0,s,o,a);if(!n)return await r.getThumbnailFromResource(void 0,s,o,a);if(typeof n=="string"){const h=ie(n);return h&&a.push(h),await r.getThumbnailFromResource(void 0,s,o,a)}const f=e.get(n,{skipSelfReturn:!1});if(typeof f=="string")return{best:ie(f),fallback:[],log:[]};if(!f)return await u();switch(await(async h=>{if(h&&h.thumbnail&&h.thumbnail.length){const g=e.get(h.thumbnail[0]),l=await r.getImageCandidates(g,o);l&&l.length&&a.push(...l)}})(f),f.type){case"Annotation":{const h=Array.isArray(f.body)?f.body:[f.body],g=e.get(h[0]);return c&&!g.width&&(g.width=c.width,g.height=c.height),await r.getThumbnailFromResource(g,s,o,a)}case"Canvas":{const h=f;return i(h.items[0],s,o,a,{width:h.width,height:h.height})}case"AnnotationPage":return i(f.items[0],s,o,a,c);case"Choice":{const h=f;return!h.items||h.items[0]?await u():i(h.items[0],s,o,a,c)}case"Collection":{const g=f.items[0];return g?i(g,s,o,a,c):await u()}case"Manifest":{const g=f.items[0];return g?i(g,s,o,a,c):await u()}case"SpecificResource":case"Image":case"Dataset":case"Sound":case"Text":case"TextualBody":case"Video":return c&&!f.width&&(f.width=c.width,f.height=c.height),r.getThumbnailFromResource(f,s,o,a);case"Service":case"Range":case"AnnotationCollection":case"CanvasReference":case"ContentResource":return await u()}return await u()}return{getBestThumbnailAtSize:i}}function Ee(e,t,r=[],i=!1){if(!e||!t||t.length===0)return;if(t.length===1)return t[0];if(t.indexOf(e)!==-1)return e;const n=e.indexOf("-")!==-1?e.slice(0,e.indexOf("-")):null;if(n&&t.indexOf(n)!==-1)return n;for(const s of r)if(t.indexOf(s)!==-1)return s;if(!i){const o=t.map(a=>a.indexOf("-")!==-1?a.slice(0,a.indexOf("-")):null).indexOf(e);if(o!==-1)return t[o];for(const a of r){const c=a.indexOf("-")!==-1?a.slice(0,a.indexOf("-")):null,u=c?t.indexOf(c):-1;if(u!==-1)return t[u]}}return t.indexOf("none")!==-1?"none":t.indexOf("@none")!==-1?"@none":t[0]}function Ue(e,t,r={}){const{strictFallback:i=!1,defaultText:n="",separator:s=`
`,fallbackLanguages:o=[],closest:a}=r,c=Object.keys(e||{}),u=a?t:Ee(t,c,o,i);if(!e)return n;if(typeof e=="string")return e;const f=u?e[u]:void 0;return f?typeof f=="string"?f:f.join(s):""}function ci(e,t={}){return Ue(e,typeof navigator!="undefined"?navigator.language:void 0,t)}var li=function(){function e(t,r){var i=[],n=!0,s=!1,o=void 0;try{for(var a=t[Symbol.iterator](),c;!(n=(c=a.next()).done)&&(i.push(c.value),!(r&&i.length===r));n=!0);}catch(u){s=!0,o=u}finally{try{!n&&a.return&&a.return()}finally{if(s)throw o}}return i}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),V=Math.PI*2,K=function(t,r,i,n,s,o,a){var c=t.x,u=t.y;c*=r,u*=i;var f=n*c-s*u,p=s*c+n*u;return{x:f+o,y:p+a}},fi=function(t,r){var i=r===1.5707963267948966?.551915024494:r===-1.5707963267948966?-.551915024494:1.3333333333333333*Math.tan(r/4),n=Math.cos(t),s=Math.sin(t),o=Math.cos(t+r),a=Math.sin(t+r);return[{x:n-s*i,y:s+n*i},{x:o+a*i,y:a-o*i},{x:o,y:a}]},ve=function(t,r,i,n){var s=t*n-r*i<0?-1:1,o=t*i+r*n;return o>1&&(o=1),o<-1&&(o=-1),s*Math.acos(o)},ui=function(t,r,i,n,s,o,a,c,u,f,p,h){var g=Math.pow(s,2),l=Math.pow(o,2),m=Math.pow(p,2),v=Math.pow(h,2),x=g*l-g*v-l*m;x<0&&(x=0),x/=g*v+l*m,x=Math.sqrt(x)*(a===c?-1:1);var d=x*s/o*h,y=x*-o/s*p,b=f*d-u*y+(t+i)/2,w=u*d+f*y+(r+n)/2,S=(p-d)/s,M=(h-y)/o,C=(-p-d)/s,O=(-h-y)/o,z=ve(1,0,S,M),R=ve(S,M,C,O);return c===0&&R>0&&(R-=V),c===1&&R<0&&(R+=V),[b,w,z,R]},hi=function(t){var r=t.px,i=t.py,n=t.cx,s=t.cy,o=t.rx,a=t.ry,c=t.xAxisRotation,u=c===void 0?0:c,f=t.largeArcFlag,p=f===void 0?0:f,h=t.sweepFlag,g=h===void 0?0:h,l=[];if(o===0||a===0)return[];var m=Math.sin(u*V/360),v=Math.cos(u*V/360),x=v*(r-n)/2+m*(i-s)/2,d=-m*(r-n)/2+v*(i-s)/2;if(x===0&&d===0)return[];o=Math.abs(o),a=Math.abs(a);var y=Math.pow(x,2)/Math.pow(o,2)+Math.pow(d,2)/Math.pow(a,2);y>1&&(o*=Math.sqrt(y),a*=Math.sqrt(y));var b=ui(r,i,n,s,o,a,p,g,m,v,x,d),w=li(b,4),S=w[0],M=w[1],C=w[2],O=w[3],z=Math.abs(O)/(V/4);Math.abs(1-z)<1e-7&&(z=1);var R=Math.max(Math.ceil(z),1);O/=R;for(var ae=0;ae<R;ae++)l.push(fi(C,O)),C+=O;return l.map(function(Y){var ce=K(Y[0],o,a,v,m,S,M),nt=ce.x,st=ce.y,le=K(Y[1],o,a,v,m,S,M),ot=le.x,at=le.y,fe=K(Y[2],o,a,v,m,S,M),ct=fe.x,lt=fe.y;return{x1:nt,y1:st,x2:ot,y2:at,x:ct,y:lt}})},pi=gi,ee={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0},di=/([astvzqmhlc])([^astvzqmhlc]*)/ig;function gi(e){var t=[];return e.replace(di,function(r,i,n){var s=i.toLowerCase();for(n=mi(n),s=="m"&&n.length>2&&(t.push([i].concat(n.splice(0,2))),s="l",i=i=="m"?"l":"L");;){if(n.length==ee[s])return n.unshift(i),t.push(n);if(n.length<ee[s])throw new Error("malformed path data");t.push([i].concat(n.splice(0,ee[s])))}}),t}var yi=/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/ig;function mi(e){var t=e.match(yi);return t?t.map(Number):[]}var vi=xi;function xi(e){var t=0,r=0,i=0,n=0;return e.map(function(s){s=s.slice();var o=s[0],a=o.toUpperCase();if(o!=a)switch(s[0]=a,o){case"a":s[6]+=i,s[7]+=n;break;case"v":s[1]+=n;break;case"h":s[1]+=i;break;default:for(var c=1;c<s.length;)s[c++]+=i,s[c++]+=n}switch(a){case"Z":i=t,n=r;break;case"H":i=s[1];break;case"V":n=s[1];break;case"M":i=t=s[1],n=r=s[2];break;default:i=s[s.length-2],n=s[s.length-1]}return s})}function bi(e){const t=pi(e),r=vi(t);let i,n=0,s=0,o=0,a=0,c,u,f=0,p=0;const h=[];for(let g=0;g<r.length;g++){let l=r[g];const m=l[0];switch(m){case"M":n=l[1],s=l[2];break;case"H":l=["L",l[1],s];break;case"V":l=["L",n,l[1]];break;case"S":{let v=f,x=p;(i==="C"||i=="S")&&(v+=v-o,x+=x-a),l=["C",v,x,l[1],l[2],l[3],l[4]]}break;case"T":i==="Q"||i=="T"?(c=f*2-c,u=p*2-u):(c=f,u=p),l=["Q",c,u,l[1],l[2]];break;case"Q":c=l[1],u=l[2];break;case"A":{const v=hi({px:f,py:p,cx:l[6],cy:l[7],rx:l[1],ry:l[2],xAxisRotation:l[3],largeArcFlag:l[4],sweepFlag:l[5]});if(!v.length)continue;for(const[x,d]of v.entries())l=["C",d.x1,d.y1,d.x2,d.y2,d.x,d.y],x<v.length-1&&h.push(l);l=l}break;case"Z":l=["L",n,s];break}i=m,f=l[l.length-2],p=l[l.length-1],["C","Q","A"].indexOf(m)>-1?(o=l[l.length-4],a=l[l.length-3]):(o=f,a=p),h.push(l)}return h}/** Code to "flatten" quadratic and cubic Bézier curves to polylines.
 *
 * All code in this module is based on JavaScript code by Raph Levien, published on his blog at
 * https://raphlinus.github.io/.
 * I merely changed the structure a bit, removed some unneeded parts and added some comments and type hints.
 *
 * Flattening of quadratic Bézier curves:
 * - Article: https://raphlinus.github.io/graphics/curves/2019/12/23/flatten-quadbez.html
 * - Code: https://github.com/raphlinus/raphlinus.github.io/blob/master/_posts/2019-12-23-flatten-quadbez.md?plain=1#L73-L212
 *
 * Flattening of cubic Bézier curves: https://levien.com/tmp/flatten.html
 *
 * Note that the code in this module has a different license than the rest of the package,
 * due to the inclusion of Apache-licensed third party code.
 *
 * @license
 * Copyright 2022 Johannes Baiter <johannes.baiter@gmail.com>
 * Copyright 2019, 2022 Raph Levien <raph.levien@gmail.com>
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function wi(e,t,r,i=1){return new De(e,t,r).subdivide(i)}function Si(e,t,r,i,n=1){return new ne(new Float64Array([e.x,e.y,t.x,t.y,r.x,r.y,i.x,i.y])).subdivide(n)}function Ai(e){return e.x*e.x+e.y*e.y}function N(e){return e/(1-.67+Math.pow(Math.pow(.67,4)+.25*e*e,.25))}function _(e){return e*(1-.39+Math.sqrt(.39*.39+.25*e*e))}class De{constructor(t,r,i){this.start=t,this.control=r,this.end=i}eval(t){const r=1-t;return{x:this.start.x*r*r+2*this.control.x*r*t+this.end.x*t*t,y:this.start.y*r*r+2*this.control.y*r*t+this.end.y*t*t}}mapToBasic(){const{x:t,y:r}=this.start,{x:i,y:n}=this.control,{x:s,y:o}=this.end,a=2*i-t-s,c=2*n-r-o,u=(i-t)*a+(n-r)*c,f=(s-i)*a+(o-n)*c,p=(s-t)*c-(o-r)*a,h=u/p,g=f/p,l=Math.abs(p)/(Math.hypot(a,c)*Math.abs(g-h));return{x0:t,x2:s,scale:l,cross:p}}subdivide(t){const r=this.mapToBasic(),i=N(r.x0),n=N(r.x2),s=.5*Math.abs(n-i)*Math.sqrt(r.scale/t),o=Math.ceil(s),a=_(i),c=_(n),u=[0];for(let f=1;f<o;f++){const h=(_(i+(n-i)*f/o)-a)/(c-a);u.push(h)}return u.push(1),u.map(f=>this.eval(f))}}class ne{constructor(t){this.c=t}weightsum(t,r,i,n){const s=t*this.c[0]+r*this.c[2]+i*this.c[4]+n*this.c[6],o=t*this.c[1]+r*this.c[3]+i*this.c[5]+n*this.c[7];return{x:s,y:o}}eval(t){const r=1-t,i=r*r*r,n=3*r*r*t,s=3*r*t*t,o=t*t*t;return this.weightsum(i,n,s,o)}deriv(t){const r=1-t,i=-3*r*r,n=3*t*t,s=-6*t*r-i,o=6*t*r-n;return this.weightsum(i,s,o,n)}midpoint_quadbez(){const t=this.weightsum(-.25,.75,.75,-.25);return new De({x:this.c[0],y:this.c[1]},t,{x:this.c[6],y:this.c[7]})}subsegment(t,r){const i=new Float64Array(8),n=this.eval(t),s=this.eval(r);i[0]=n.x,i[1]=n.y;const o=(r-t)/3,a=this.deriv(t);i[2]=n.x+o*a.x,i[3]=n.y+o*a.y;const c=this.deriv(r);return i[4]=s.x-o*c.x,i[5]=s.y-o*c.y,i[6]=s.x,i[7]=s.y,new ne(i)}subdivide(t){const r=.1*t,i=t-r,n=Math.sqrt(i),s=Ai(this.weightsum(1,-3,3,-1)),o=Math.ceil(Math.pow(s/(432*r*r),1/6)),a=[];let c=0;for(let l=0;l<o;l++){const m=l/o,v=(l+1)/o,x=this.subsegment(m,v).midpoint_quadbez(),d=x.mapToBasic(),y=N(d.x0),b=N(d.x2),w=Math.sqrt(d.scale);let S=Math.abs(b-y)*w;if(Math.sign(d.x0)!=Math.sign(d.x2)){const M=n/w,C=n*Math.abs(b-y)/N(M);S=Math.max(S,C)}a.push({quad:x,a0:y,a2:b,val:S}),c+=S}const u=.5*c/n,f=Math.ceil(u),p=[{x:this.c[0],y:this.c[1]}];let h=0,g=0;for(let l=1;l<f;l++){const m=c*l/f;for(;h+a[g].val<m;)h+=a[g].val,g++;const v=a[g].a0,x=a[g].a2,d=_(v),y=_(x),b=v+(x-v)*(m-h)/a[g].val,S=(_(b)-d)/(y-d);p.push(a[g].quad.eval(S))}return p.push({x:this.c[6],y:this.c[7]}),p}}const Fi=/&?(xywh=)?(pixel:|percent:|pct:)?([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?)/,Mi=/&?(t=)(npt:)?([0-9]+(.[0-9]+)?)?(,([0-9]+(.[0-9]+)?))?/,xe=/^rgba\((\d+),(\d+),(\d+),([0-9.]+)\)$/;function E(e,{domParser:t,svgPreprocessor:r,iiifRenderingHints:i}={}){var n,s;if(Array.isArray(e))return k(e.reduce((o,a)=>{const{selector:c,selectors:u,iiifRenderingHints:f}=E(a,{domParser:t,svgPreprocessor:r,iiifRenderingHints:i});return c&&(o.selector||(o.selector=c),o.selectors.push(...u)),f&&(o.iiifRenderingHints=o.iiifRenderingHints||{type:"ImageApiSelector"},Object.assign(o.iiifRenderingHints,f)),o},{selector:null,selectors:[],iiifRenderingHints:i}));if(!e)return k({selector:null,selectors:[],iiifRenderingHints:i});if(typeof e=="string"){const[o,a]=e.split("#");return a?E({type:"FragmentSelector",value:a},{svgPreprocessor:r,iiifRenderingHints:i,domParser:t}):k({selector:null,selectors:[],iiifRenderingHints:i})}if(e.type&&e.type==="PointSelector"&&(e.t||e.t===0)){const o={type:"TemporalSelector",temporal:{startTime:e.t}};return k({selector:o,selectors:[o],iiifRenderingHints:i})}if(Xe(e)){const o=[];if(e.region){const a=E({type:"FragmentSelector",value:"xywh="+e.region},{domParser:t,svgPreprocessor:r,iiifRenderingHints:i});o.push(...a.selectors)}return k({selector:o[0],selectors:o,iiifRenderingHints:i?{...i,...e}:e})}if(e.type==="FragmentSelector"){const o=Fi.exec(e.value);if(o){const c={type:"BoxSelector",spatial:{unit:o[2]==="percent:"||o[2]==="pct:"?"percent":"pixel",x:parseFloat(o[3]),y:parseFloat(o[4]),width:parseFloat(o[5]),height:parseFloat(o[6])}};return k({selector:c,selectors:[c],iiifRenderingHints:i})}const a=e.value.match(Mi);if(a){const c={type:"TemporalSelector",temporal:{startTime:a[4]?parseFloat(a[4]):0,endTime:a[7]?parseFloat(a[7]):void 0}};return k({selector:c,selectors:[c],iiifRenderingHints:i})}return k({selector:null,selectors:[],iiifRenderingHints:i})}if(e.type==="SvgSelector"&&"value"in e){t||(typeof window!="undefined"?t=new window.DOMParser:console.warn("No DOMParser available, cannot parse SVG selector, `points`, `spatial` and `style` will be unavailable and the SVG will not be normalized."));let o=[],a,c,u=(n=r==null?void 0:r(e.value))!=null?n:e.value,f;if(t){const h=t.parseFromString(e.value,"image/svg+xml").querySelector("svg");if(!h)return console.warn(`Illegal SVG selector: ${e.value}`),k({selector:null,selectors:[],iiifRenderingHints:i});const g=Je(h);g&&(o=g.points,f=g.shapeType,a=[Math.min(...o.map(l=>l[0])),Math.min(...o.map(l=>l[1])),Math.max(...o.map(l=>l[0])),Math.max(...o.map(l=>l[1]))],{style:c,svg:u}=(s=ki(g.element))!=null?s:{svg:u})}const p={type:"SvgSelector",svg:u,svgShape:f,style:c,points:o.length?o:void 0,spatial:a?{unit:"pixel",x:a[0],y:a[1],width:a[2]-a[0],height:a[3]-a[1]}:void 0};return k({selector:p,selectors:[p],iiifRenderingHints:i})}return k({selector:null,selectors:[],iiifRenderingHints:i})}function Ci(e){const t=e.map(i=>i[0]).reduce((i,n)=>(i[n]+=1,i),{C:0,Q:0,L:0,M:0}),r=new Set(e.map(i=>i[0]));if(t.C>0||t.Q>0)return"path";if(t.L>0&&(r.size===1||r.size===2&&r.has("M"))){if(t.L===4)return"rect";const i=e.slice(-1)[0];return e[0][0]==="M"&&i[0]==="L"&&i[1]==e[0][1]&&i[2]===e[0][2]||i[1]===0&&i[2]===0?"polygon":"polyline"}return"path"}function Je(e){var t,r,i,n,s,o,a,c,u,f,p,h,g,l,m,v,x;for(const d of Array.from(e.children))switch(d==null?void 0:d.tagName.toLowerCase()){case"g":{const y=Je(d);if(y)return y}continue;case"path":{const y=d.getAttribute("d");if(!y)continue;const b=bi(y);return{element:d,points:Oi(b),shapeType:Ci(b)}}case"circle":{const y=parseFloat((t=d.getAttribute("cx"))!=null?t:"0"),b=parseFloat((r=d.getAttribute("cy"))!=null?r:"0"),w=parseFloat((i=d.getAttribute("r"))!=null?i:"0");if(!w)continue;const S=[];for(let M=0;M<=360;M+=12){const C=M*Math.PI/180;S.push([y+w*Math.cos(C),b+w*Math.sin(C)])}return{element:d,points:S,shapeType:"circle"}}case"ellipse":{const y=parseFloat((n=d.getAttribute("cx"))!=null?n:"0"),b=parseFloat((s=d.getAttribute("cy"))!=null?s:"0"),w=parseFloat((o=d.getAttribute("rx"))!=null?o:"0"),S=parseFloat((a=d.getAttribute("ry"))!=null?a:"0");if(!w&&!S)continue;const M=[];for(let C=0;C<=360;C+=12){const O=Math.tan(C/360*Math.PI),z=w*(1-O**2)/(1+O**2),R=S*2*O/(1+O**2);M.push([y+z,b+R])}return{element:d,points:M,shapeType:"ellipse"}}case"line":{const y=parseFloat((c=d.getAttribute("x0"))!=null?c:"0"),b=parseFloat((u=d.getAttribute("y0"))!=null?u:"0"),w=parseFloat((f=d.getAttribute("x1"))!=null?f:"0"),S=parseFloat((p=d.getAttribute("y1"))!=null?p:"0");if(y===w&&b===S)continue;return{element:d,points:[[y,b],[w,S]],shapeType:"polyline"}}case"polygon":case"polyline":{const y=(g=(h=d.getAttribute("points"))==null?void 0:h.split(" ").map(w=>w.split(",").map(parseFloat)))!=null?g:[];if(!y.length)continue;let b="polyline";return d.tagName.toLowerCase()==="polygon"&&(y.push(y[0]),b="polygon"),{element:d,points:y,shapeType:b}}case"rect":{const y=parseFloat((l=d.getAttribute("x"))!=null?l:"0"),b=parseFloat((m=d.getAttribute("y"))!=null?m:"0"),w=parseFloat((v=d.getAttribute("width"))!=null?v:"0"),S=parseFloat((x=d.getAttribute("height"))!=null?x:"0");if(!w||!S)continue;return{element:d,points:[[y,b],[y+w,b],[y+w,b+S],[y,b+S],[y,b]],shapeType:"rect"}}default:continue}return null}function Oi(e){var r;const t=[];for(let i=0;i<e.length;i++){const n=(r=t[t.length-1])!=null?r:[0,0],s=e[i];switch(s[0]){case"M":case"L":t.push([s[1],s[2]]);continue;case"C":t.push(...Si({x:n[0],y:n[1]},{x:s[1],y:s[2]},{x:s[3],y:s[4]},{x:s[5],y:s[6]}).map(o=>[o.x,o.y]).slice(1));continue;case"Q":t.push(...wi({x:n[0],y:n[1]},{x:s[1],y:s[2]},{x:s[3],y:s[4]}).map(o=>[o.x,o.y]).slice(1));continue}}return t}function ki(e){const t={};if(e.hasAttribute("fill")?(t.fill=e.getAttribute("fill"),e.removeAttribute("fill")):e.style.fill&&(t.fill=e.style.fill),t.fill){const i=xe.exec(t.fill);i&&(t.fillOpacity=parseFloat(i[4]),t.fill=`rgb(${i[1]}, ${i[2]}, ${i[3]})`)}if(e.hasAttribute("fill-opacity")?(t.fillOpacity=parseFloat(e.getAttribute("fill-opacity")),e.removeAttribute("fill-opacity")):e.style.fillOpacity&&(t.fillOpacity=parseFloat(e.style.fillOpacity)),e.hasAttribute("stroke")?(t.stroke=e.getAttribute("stroke"),e.removeAttribute("stroke")):e.style.stroke&&(t.stroke=e.style.stroke),t.stroke){const i=xe.exec(t.stroke);i&&(t.strokeOpacity=parseFloat(i[4]),t.stroke=`rgb(${i[1]}, ${i[2]}, ${i[3]})`)}e.hasAttribute("stroke-opacity")?(t.strokeOpacity=parseFloat(e.getAttribute("stroke-opacity")),e.removeAttribute("stroke-opacity")):e.style.strokeOpacity&&(t.strokeOpacity=parseFloat(e.style.strokeOpacity)),e.hasAttribute("stroke-width")?(t.strokeWidth=e.getAttribute("stroke-width"),e.removeAttribute("stroke-width")):e.style.strokeWidth&&(t.strokeWidth=e.style.strokeWidth),e.hasAttribute("stroke-dasharray")?(t.strokeDasharray=e.getAttribute("stroke-dasharray"),e.removeAttribute("stroke-dasharray")):e.style.strokeDasharray&&(t.strokeDasharray=e.style.strokeDasharray);let r=e;for(;r.tagName.toLowerCase()!=="svg";)if(r=r.parentElement,r===null)throw new Error("Could not find root SVG element");return{svg:r.outerHTML,style:Object.keys(t).length>0?t:void 0}}function Xe(e){return!!e&&e.type==="iiif:ImageApiSelector"&&e.type==="iiif:ImageApiSelector"}function k(e){if(e.iiifRenderingHints){const t=e.iiifRenderingHints;if(t.rotation){const r=Ge(t.rotation);if(r)if(e.selectors.length)for(const i of e.selectors)i.rotation=r;else e.selectors.push({type:"RotationSelector",rotation:r})}}else delete e.iiifRenderingHints;return e}function Ge(e){let t=parseFloat(e);return t&&e.startsWith("!")&&(t=360-t),t&&(t=t%360),t!==t?0:t||0}function T(e,t={}){if(Array.isArray(e))return T(e[0]);if(typeof e=="string"){const[r,i]=e.split("#");return i?T({type:"SpecificResource",source:{id:r,type:"Unknown"},selector:{type:"FragmentSelector",value:i}}):{type:"SpecificResource",source:{id:r,type:t.typeMap&&t.typeMap[r]||"Unknown"},selector:null,selectors:[]}}if(e.type==="Choice"||e.type==="List"||e.type==="Composite"||e.type==="Independents")return T(e.items[0]);if(e.type==="SpecificResource"){e.source.type==="Canvas"&&e.source.partOf&&typeof e.source.partOf=="string"&&(e.source.partOf=[{id:e.source.partOf,type:"Manifest"}]);const{selector:r,selectors:i}=e.selector?E(e.selector,t):{selector:null,selectors:[]};return{type:"SpecificResource",source:e.source,selector:r,selectors:i}}if(e.id){e.type==="Canvas"&&e.partOf&&typeof e.partOf=="string"&&(e.partOf=[{id:e.partOf,type:"Manifest"}]);const[r,i]=e.id.split("#");return i?T({type:"SpecificResource",source:{...e,id:r},selector:{type:"FragmentSelector",value:i}}):{type:"SpecificResource",source:{...e,id:r},selector:null,selectors:[]}}return{type:"SpecificResource",source:e,selector:null,selectors:[]}}function re(e,t=!1){if(typeof e=="string"){if(e.startsWith("{"))try{const r=JSON.parse(e);return re(r)}catch{return[!1,{reason:"Invalid JSON"}]}return[!0]}if(Array.isArray(e)){for(const r of e){const[i,n]=re(r);if(!i&&n)return[i,n]}return[!0]}return e.type==="Annotation"?[!0]:t&&e.type==="Canvas"&&!e.partOf?[!1,{reason:"Canvas without partOf cannot be loaded"}]:[!0]}function Ri(e){return Ze(typeof e=="string"?e:JSON.stringify(e))}function Ye(e,t){if(e=e.trim(),e[0]==="{")return t?Promise.resolve(JSON.parse(e)):JSON.parse(e);if(e.startsWith("http")){if(!t)throw new Error("Cannot fetch remote fetch with async=false in parseContentState");return fetch(e).then(r=>r.json())}return Ye(Ke(e),t)}function Ze(e){const t=encodeURIComponent(e);return(typeof btoa=="undefined"?Buffer.from(t,"utf-8").toString("base64"):btoa(t)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function Ke(e){const r=Ii(e).replace(/-/g,"+").replace(/_/g,"/"),i=typeof atob=="undefined"?Buffer.from(r,"base64").toString("utf-8"):atob(r);return decodeURIComponent(i).trim()}function Ii(e){const t=e.length%4;if(t===1)throw new Error("InvalidLengthError: Input base64url string is the wrong length to determine padding");return e+(t?"====".slice(0,4-t):"")}function ji(e){if(!e)throw new Error("Content state is empty");Array.isArray(e)||(e=[e]);let t="vault://virtual-annotation/"+new Date().getTime();const r=[];for(const i of e){if(typeof i=="string")throw new Error("Content state is a [String] type and cannot be inferred");if(i.type==="Annotation"){if(t=i.id,Array.isArray(i.motivation))for(const s of i.motivation);if(Array.isArray(i.target))for(const s of i.target){const o=T(s);r.push(o)}else{const s=T(i.target);r.push(s)}continue}const n=T(i);r.push(n)}return{id:t,type:"Annotation",motivation:["contentState",...e.motivation||[]],target:r,extensions:{}}}function et(e){return e.type==="SpecificResource"?[e.source,{selector:e.selector}]:[e,{selector:null}]}function Ti(e=I){function t(n){const s=n?typeof n=="string"?e.get(n):n:null;if(!s)return[];const o=e.get(s.items),a=[];for(const c of o)a.push(...e.get(c.items));return a}function r(n,s=[]){const o=Array.isArray(n)?n:t(n),a=[];let c=null;const u=[];for(const f of o){if(f.type!=="Annotation")throw new Error("getPaintables() accept either a canvas or list of annotations");const p=e.get(f.body),h=Array.isArray(p)?p:[p];for(const g of h){const[l,{selector:m}]=et(g),v=(l.type||"unknown").toLowerCase();if(v==="choice"){const x=e.get(l.items),d=s.length?s.map(y=>x.find(b=>b.id===y)).filter(Boolean):[x[0]];d.length===0&&d.push(x[0]),c={type:"single-choice",items:x.map(y=>({id:y.id,label:y.label,selected:d.indexOf(y)!==-1})),label:g.label},h.push(...d);continue}a.indexOf(v)===-1&&a.push(v),u.push({type:v,resource:l,target:f.target,selector:m})}}return{types:a,items:u,choice:c}}function i(n){const{choice:s}=r(n);return s}return{getAllPaintingAnnotations:t,getPaintables:r,extractChoices:i}}function F(e,t,r){t[Q]=t[Q]||[],t[Q].push(e),Object.defineProperty(t,e,{get(){if(typeof t[q][e]=="undefined")return;const i=t[q][e];return i&&j(r.get(t[q][e]),r)},set(i){t[q][e]!==i&&(this[q][e]=i)}})}const q=Symbol.for("_refs_"),L=Symbol.for("_reactive_"),Q=Symbol.for("_defined_");function zi(e,t=!1){const r={id:null,[Q]:[],[q]:{},[L]:null,is(i){return typeof i=="string"?this.id===i:i.id?i.id===this.id:!1},reactive(){if(!this[L])return this[L]=this.subscribe(()=>this.refresh(),!0),()=>{this.unreactive()}},refresh(){if(this.id){const i=this.unwrap();for(const n of Object.keys(i||{}))this[Q].includes(n)?this[q][n]=i[n]:this[n]=i[n]}},unreactive(){this[L]&&(this[L](),this[L]=null)},unwrap(){if(!this.id)throw new Error("Invalid object");return e.get(this.id)},toPresentation3(){return e.toPresentation3(this.unwrap())},toPresentation2(){return e.toPresentation2(this.unwrap())},toJSON(){const i=this;return{...i,items:i.items,annotations:i.annotations,structures:i.structures,seeAlso:i.seeAlso,service:i.service,services:i.services,rendering:i.rendering,partOf:i.partOf,start:i.start,supplementary:i.supplementary,homepage:i.homepage,thumbnail:i.thumbnail,placeholderCanvas:i.placeholderCanvas,accompanyingCanvas:i.accompanyingCanvas,provider:i.provider}},subscribe(i,n=!0){return e.subscribe(()=>this.id?e.get(this.id):null,i,n)}};return F("items",r,e),F("annotations",r,e),F("structures",r,e),F("seeAlso",r,e),F("service",r,e),F("services",r,e),F("rendering",r,e),F("partOf",r,e),F("start",r,e),F("supplementary",r,e),F("homepage",r,e),F("thumbnail",r,e),F("placeholderCanvas",r,e),F("accompanyingCanvas",r,e),F("provider",r,e),F("body",r,e),F("logo",r,e),r}function tt(e){return Array.isArray(e)?e.map(t=>tt(t)):!e||!e.type?e:{id:e.id,type:e.type}}function j(e,t,r=!1){if(Array.isArray(e))return e.map(o=>j(o,t,r));if(!e||!e.type||!e.id)return e;const i=zi(t,r),n=Object.create(i),s=Object.assign(n,e);return r&&s.reactive(),s}function $i(e){return{get(t,r=!1){return j(e.get(t),e,r)},async load(t,r){return j(await e.load(t,r),e)},async loadManifest(t,r){return j(await e.loadManifest(t,r),e)},async loadCollection(t,r){return j(await e.loadCollection(t,r),e)},wrapObject(t){return j(e.get(t,{skipSelfReturn:!1}),e)},isWrapped(t){return!!t[Q]}}}function Wi(e=I){return{findFirstCanvasFromRange:t=>se(e,t),findAllCanvasesInRange:t=>X(e,t),findManifestSelectedRange:(t,r)=>it(e,t,r),findSelectedRange:(t,r)=>G(e,t,r)}}function se(e,t){for(const r of t.items){if(r.type==="Canvas")return r;if(r.type==="Range"){const i=se(e,e.get(r));if(i)return i}}return null}function X(e,t){const r=[];for(const i of t.items)if(i.type==="Canvas"&&(i.id.indexOf("#")!==-1?r.push({id:i.id.split("#")[0],type:"Canvas"}):r.push(i)),i.type==="Range"&&r.push(...X(e,e.get(i))),i.type==="SpecificResource"){const n=typeof i.source=="string"?i.source:i.source.id;r.push({id:n,type:"Canvas"})}return r}function it(e,t,r){for(const i of t.structures){const n=G(e,e.get(i),r);if(n)return n}return null}function G(e,t,r){var i;for(const n of t.items){const s=(i=n.id)==null?void 0:i.split("#")[0];if(n.type==="SpecificResource"&&n.source===r||n.type==="Canvas"&&r===s)return t;if(n.type==="Range"){const o=G(e,e.get(n),r);if(o)return o}}return null}function Bi(e=I){return{getVisibleCanvasesFromCanvasId:(t,r,i=!1)=>rt(e,t,r,i),getManifestSequence:(t,r={})=>oe(e,t,r)}}function rt(e=I,t,r,i=!1){const n=t.behavior||[],s=r?e.get(r):null;if(!s)return[];const o=s.behavior||[],a=i?!1:n.includes("paged"),c=a?!1:n.includes("continuous"),u=a||c?!1:n.includes("individuals"),f=o.includes("facing-pages"),p=o.includes("non-paged");if(f||p||u||i)return[{id:s.id,type:"Canvas"}];const[h,g]=oe(e,t);if(c)return h;const l=h.findIndex(m=>m.id===r);if(l===-1)return[];for(const m of g)if(m.includes(l))return m.map(v=>h[v]);return[{id:s.id,type:"Canvas"}]}function oe(e=I,t,{disablePaging:r,skipNonPaged:i}={}){const n=t.behavior||[],s=n.includes("paged"),o=s?!1:n.includes("continuous"),a=s||o?!1:n.includes("individuals"),c=t.type==="Manifest"?t.items:X(e,t);if(o)return[c,[c.map((l,m)=>m)]];if(a||!s||r)return[c,c.map((l,m)=>[m])];const u=[];let f=[];const p=()=>{f.length&&(u.push([...f]),f=[])};let h=0,g=!1;for(let l=0;l<c.length;l++){const v=e.get(c[l]).behavior||[];if(v.includes("non-paged")){l===h&&h++,i||(p(),u.push([l]),p());continue}if(l===h||v.includes("facing-pages")){f.length&&(g=!0),p(),u.push([l]),p();continue}if(f.push(l),g){p(),g=!1;continue}f.length>1&&p()}return f.length&&p(),[c,u]}exports.buildLocaleString=Ue;exports.createEventsHelper=ft;exports.createObjectsHelper=$i;exports.createPaintingAnnotationsHelper=Ti;exports.createRangeHelper=Wi;exports.createSequenceHelper=Bi;exports.createStylesHelper=ut;exports.createThumbnailHelper=ai;exports.decodeContentState=Ke;exports.encodeContentState=Ze;exports.expandTarget=T;exports.findAllCanvasesInRange=X;exports.findFirstCanvasFromRange=se;exports.findManifestSelectedRange=it;exports.findSelectedRange=G;exports.getClosestLanguage=Ee;exports.getManifestSequence=oe;exports.getValue=ci;exports.getVisibleCanvasesFromCanvasId=rt;exports.isImageApiSelector=Xe;exports.normaliseContentState=ji;exports.parseContentState=Ye;exports.parseRotation=Ge;exports.parseSelector=E;exports.parseSpecificResource=et;exports.serialiseContentState=Ri;exports.unwrapObject=tt;exports.validateContentState=re;exports.wrapObject=j;
//# sourceMappingURL=index.js.map
