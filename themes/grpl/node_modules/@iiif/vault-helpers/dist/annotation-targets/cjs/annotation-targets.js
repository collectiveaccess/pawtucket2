"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});var tt=function(){function e(t,a){var r=[],o=!0,n=!1,s=void 0;try{for(var i=t[Symbol.iterator](),u;!(o=(u=i.next()).done)&&(r.push(u.value),!(a&&r.length===a));o=!0);}catch(h){n=!0,s=h}finally{try{!o&&i.return&&i.return()}finally{if(n)throw s}}return r}return function(t,a){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,a);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),L=Math.PI*2,I=function(t,a,r,o,n,s,i){var u=t.x,h=t.y;u*=a,h*=r;var y=o*u-n*h,f=n*u+o*h;return{x:y+s,y:f+i}},et=function(t,a){var r=a===1.5707963267948966?.551915024494:a===-1.5707963267948966?-.551915024494:1.3333333333333333*Math.tan(a/4),o=Math.cos(t),n=Math.sin(t),s=Math.cos(t+a),i=Math.sin(t+a);return[{x:o-n*r,y:n+o*r},{x:s+i*r,y:i-s*r},{x:s,y:i}]},D=function(t,a,r,o){var n=t*o-a*r<0?-1:1,s=t*r+a*o;return s>1&&(s=1),s<-1&&(s=-1),n*Math.acos(s)},rt=function(t,a,r,o,n,s,i,u,h,y,f,M){var x=Math.pow(n,2),c=Math.pow(s,2),g=Math.pow(f,2),b=Math.pow(M,2),d=x*c-x*b-c*g;d<0&&(d=0),d/=x*b+c*g,d=Math.sqrt(d)*(i===u?-1:1);var l=d*n/s*M,p=d*-s/n*f,v=y*l-h*p+(t+r)/2,m=h*l+y*p+(a+o)/2,A=(f-l)/n,w=(M-p)/s,S=(-f-l)/n,k=(-M-p)/s,O=D(1,0,A,w),T=D(A,w,S,k);return u===0&&T>0&&(T-=L),u===1&&T<0&&(T+=L),[v,m,O,T]},at=function(t){var a=t.px,r=t.py,o=t.cx,n=t.cy,s=t.rx,i=t.ry,u=t.xAxisRotation,h=u===void 0?0:u,y=t.largeArcFlag,f=y===void 0?0:y,M=t.sweepFlag,x=M===void 0?0:M,c=[];if(s===0||i===0)return[];var g=Math.sin(h*L/360),b=Math.cos(h*L/360),d=b*(a-o)/2+g*(r-n)/2,l=-g*(a-o)/2+b*(r-n)/2;if(d===0&&l===0)return[];s=Math.abs(s),i=Math.abs(i);var p=Math.pow(d,2)/Math.pow(s,2)+Math.pow(l,2)/Math.pow(i,2);p>1&&(s*=Math.sqrt(p),i*=Math.sqrt(p));var v=rt(a,r,o,n,s,i,f,x,g,b,d,l),m=tt(v,4),A=m[0],w=m[1],S=m[2],k=m[3],O=Math.abs(k)/(L/4);Math.abs(1-O)<1e-7&&(O=1);var T=Math.max(Math.ceil(O),1);k/=T;for(var Q=0;Q<T;Q++)c.push(et(S,k)),S+=k;return c.map(function(_){var V=I(_[0],s,i,b,g,A,w),Z=V.x,J=V.y,X=I(_[1],s,i,b,g,A,w),K=X.x,H=X.y,j=I(_[2],s,i,b,g,A,w),P=j.x,E=j.y;return{x1:Z,y1:J,x2:K,y2:H,x:P,y:E}})},st=ot,B={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0},nt=/([astvzqmhlc])([^astvzqmhlc]*)/ig;function ot(e){var t=[];return e.replace(nt,function(a,r,o){var n=r.toLowerCase();for(o=ct(o),n=="m"&&o.length>2&&(t.push([r].concat(o.splice(0,2))),n="l",r=r=="m"?"l":"L");;){if(o.length==B[n])return o.unshift(r),t.push(o);if(o.length<B[n])throw new Error("malformed path data");t.push([r].concat(o.splice(0,B[n])))}}),t}var it=/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/ig;function ct(e){var t=e.match(it);return t?t.map(Number):[]}var lt=ut;function ut(e){var t=0,a=0,r=0,o=0;return e.map(function(n){n=n.slice();var s=n[0],i=s.toUpperCase();if(s!=i)switch(n[0]=i,s){case"a":n[6]+=r,n[7]+=o;break;case"v":n[1]+=o;break;case"h":n[1]+=r;break;default:for(var u=1;u<n.length;)n[u++]+=r,n[u++]+=o}switch(i){case"Z":r=t,o=a;break;case"H":r=n[1];break;case"V":o=n[1];break;case"M":r=t=n[1],o=a=n[2];break;default:r=n[n.length-2],o=n[n.length-1]}return n})}function pt(e){const t=st(e),a=lt(t);let r,o=0,n=0,s=0,i=0,u,h,y=0,f=0;const M=[];for(let x=0;x<a.length;x++){let c=a[x];const g=c[0];switch(g){case"M":o=c[1],n=c[2];break;case"H":c=["L",c[1],n];break;case"V":c=["L",o,c[1]];break;case"S":{let b=y,d=f;(r==="C"||r=="S")&&(b+=b-s,d+=d-i),c=["C",b,d,c[1],c[2],c[3],c[4]]}break;case"T":r==="Q"||r=="T"?(u=y*2-u,h=f*2-h):(u=y,h=f),c=["Q",u,h,c[1],c[2]];break;case"Q":u=c[1],h=c[2];break;case"A":{const b=at({px:y,py:f,cx:c[6],cy:c[7],rx:c[1],ry:c[2],xAxisRotation:c[3],largeArcFlag:c[4],sweepFlag:c[5]});if(!b.length)continue;for(const[d,l]of b.entries())c=["C",l.x1,l.y1,l.x2,l.y2,l.x,l.y],d<b.length-1&&M.push(c);c=c}break;case"Z":c=["L",o,n];break}r=g,y=c[c.length-2],f=c[c.length-1],["C","Q","A"].indexOf(g)>-1?(s=c[c.length-4],i=c[c.length-3]):(s=y,i=f),M.push(c)}return M}/** Code to "flatten" quadratic and cubic Bézier curves to polylines.
 *
 * All code in this module is based on JavaScript code by Raph Levien, published on his blog at
 * https://raphlinus.github.io/.
 * I merely changed the structure a bit, removed some unneeded parts and added some comments and type hints.
 *
 * Flattening of quadratic Bézier curves:
 * - Article: https://raphlinus.github.io/graphics/curves/2019/12/23/flatten-quadbez.html
 * - Code: https://github.com/raphlinus/raphlinus.github.io/blob/master/_posts/2019-12-23-flatten-quadbez.md?plain=1#L73-L212
 *
 * Flattening of cubic Bézier curves: https://levien.com/tmp/flatten.html
 *
 * Note that the code in this module has a different license than the rest of the package,
 * due to the inclusion of Apache-licensed third party code.
 *
 * @license
 * Copyright 2022 Johannes Baiter <johannes.baiter@gmail.com>
 * Copyright 2019, 2022 Raph Levien <raph.levien@gmail.com>
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ht(e,t,a,r=1){return new U(e,t,a).subdivide(r)}function yt(e,t,a,r,o=1){return new $(new Float64Array([e.x,e.y,t.x,t.y,a.x,a.y,r.x,r.y])).subdivide(o)}function ft(e){return e.x*e.x+e.y*e.y}function z(e){return e/(1-.67+Math.pow(Math.pow(.67,4)+.25*e*e,.25))}function q(e){return e*(1-.39+Math.sqrt(.39*.39+.25*e*e))}class U{constructor(t,a,r){this.start=t,this.control=a,this.end=r}eval(t){const a=1-t;return{x:this.start.x*a*a+2*this.control.x*a*t+this.end.x*t*t,y:this.start.y*a*a+2*this.control.y*a*t+this.end.y*t*t}}mapToBasic(){const{x:t,y:a}=this.start,{x:r,y:o}=this.control,{x:n,y:s}=this.end,i=2*r-t-n,u=2*o-a-s,h=(r-t)*i+(o-a)*u,y=(n-r)*i+(s-o)*u,f=(n-t)*u-(s-a)*i,M=h/f,x=y/f,c=Math.abs(f)/(Math.hypot(i,u)*Math.abs(x-M));return{x0:t,x2:n,scale:c,cross:f}}subdivide(t){const a=this.mapToBasic(),r=z(a.x0),o=z(a.x2),n=.5*Math.abs(o-r)*Math.sqrt(a.scale/t),s=Math.ceil(n),i=q(r),u=q(o),h=[0];for(let y=1;y<s;y++){const M=(q(r+(o-r)*y/s)-i)/(u-i);h.push(M)}return h.push(1),h.map(y=>this.eval(y))}}class ${constructor(t){this.c=t}weightsum(t,a,r,o){const n=t*this.c[0]+a*this.c[2]+r*this.c[4]+o*this.c[6],s=t*this.c[1]+a*this.c[3]+r*this.c[5]+o*this.c[7];return{x:n,y:s}}eval(t){const a=1-t,r=a*a*a,o=3*a*a*t,n=3*a*t*t,s=t*t*t;return this.weightsum(r,o,n,s)}deriv(t){const a=1-t,r=-3*a*a,o=3*t*t,n=-6*t*a-r,s=6*t*a-o;return this.weightsum(r,n,s,o)}midpoint_quadbez(){const t=this.weightsum(-.25,.75,.75,-.25);return new U({x:this.c[0],y:this.c[1]},t,{x:this.c[6],y:this.c[7]})}subsegment(t,a){const r=new Float64Array(8),o=this.eval(t),n=this.eval(a);r[0]=o.x,r[1]=o.y;const s=(a-t)/3,i=this.deriv(t);r[2]=o.x+s*i.x,r[3]=o.y+s*i.y;const u=this.deriv(a);return r[4]=n.x-s*u.x,r[5]=n.y-s*u.y,r[6]=n.x,r[7]=n.y,new $(r)}subdivide(t){const a=.1*t,r=t-a,o=Math.sqrt(r),n=ft(this.weightsum(1,-3,3,-1)),s=Math.ceil(Math.pow(n/(432*a*a),1/6)),i=[];let u=0;for(let c=0;c<s;c++){const g=c/s,b=(c+1)/s,d=this.subsegment(g,b).midpoint_quadbez(),l=d.mapToBasic(),p=z(l.x0),v=z(l.x2),m=Math.sqrt(l.scale);let A=Math.abs(v-p)*m;if(Math.sign(l.x0)!=Math.sign(l.x2)){const w=o/m,S=o*Math.abs(v-p)/z(w);A=Math.max(A,S)}i.push({quad:d,a0:p,a2:v,val:A}),u+=A}const h=.5*u/o,y=Math.ceil(h),f=[{x:this.c[0],y:this.c[1]}];let M=0,x=0;for(let c=1;c<y;c++){const g=u*c/y;for(;M+i[x].val<g;)M+=i[x].val,x++;const b=i[x].a0,d=i[x].a2,l=q(b),p=q(d),v=b+(d-b)*(g-M)/i[x].val,A=(q(v)-l)/(p-l);f.push(i[x].quad.eval(A))}return f.push({x:this.c[6],y:this.c[7]}),f}}const vt=/&?(xywh=)?(pixel:|percent:|pct:)?([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?)/,xt=/&?(t=)(npt:)?([0-9]+(.[0-9]+)?)?(,([0-9]+(.[0-9]+)?))?/,N=/^rgba\((\d+),(\d+),(\d+),([0-9.]+)\)$/;function R(e,{domParser:t,svgPreprocessor:a,iiifRenderingHints:r}={}){var o,n;if(Array.isArray(e))return F(e.reduce((s,i)=>{const{selector:u,selectors:h,iiifRenderingHints:y}=R(i,{domParser:t,svgPreprocessor:a,iiifRenderingHints:r});return u&&(s.selector||(s.selector=u),s.selectors.push(...h)),y&&(s.iiifRenderingHints=s.iiifRenderingHints||{type:"ImageApiSelector"},Object.assign(s.iiifRenderingHints,y)),s},{selector:null,selectors:[],iiifRenderingHints:r}));if(!e)return F({selector:null,selectors:[],iiifRenderingHints:r});if(typeof e=="string"){const[s,i]=e.split("#");return i?R({type:"FragmentSelector",value:i},{svgPreprocessor:a,iiifRenderingHints:r,domParser:t}):F({selector:null,selectors:[],iiifRenderingHints:r})}if(e.type&&e.type==="PointSelector"&&(e.t||e.t===0)){const s={type:"TemporalSelector",temporal:{startTime:e.t}};return F({selector:s,selectors:[s],iiifRenderingHints:r})}if(W(e)){const s=[];if(e.region){const i=R({type:"FragmentSelector",value:"xywh="+e.region},{domParser:t,svgPreprocessor:a,iiifRenderingHints:r});s.push(...i.selectors)}return F({selector:s[0],selectors:s,iiifRenderingHints:r?{...r,...e}:e})}if(e.type==="FragmentSelector"){const s=vt.exec(e.value);if(s){const u={type:"BoxSelector",spatial:{unit:s[2]==="percent:"||s[2]==="pct:"?"percent":"pixel",x:parseFloat(s[3]),y:parseFloat(s[4]),width:parseFloat(s[5]),height:parseFloat(s[6])}};return F({selector:u,selectors:[u],iiifRenderingHints:r})}const i=e.value.match(xt);if(i){const u={type:"TemporalSelector",temporal:{startTime:i[4]?parseFloat(i[4]):0,endTime:i[7]?parseFloat(i[7]):void 0}};return F({selector:u,selectors:[u],iiifRenderingHints:r})}return F({selector:null,selectors:[],iiifRenderingHints:r})}if(e.type==="SvgSelector"&&"value"in e){t||(typeof window!="undefined"?t=new window.DOMParser:console.warn("No DOMParser available, cannot parse SVG selector, `points`, `spatial` and `style` will be unavailable and the SVG will not be normalized."));let s=[],i,u,h=(o=a==null?void 0:a(e.value))!=null?o:e.value,y;if(t){const M=t.parseFromString(e.value,"image/svg+xml").querySelector("svg");if(!M)return console.warn(`Illegal SVG selector: ${e.value}`),F({selector:null,selectors:[],iiifRenderingHints:r});const x=G(M);x&&(s=x.points,y=x.shapeType,i=[Math.min(...s.map(c=>c[0])),Math.min(...s.map(c=>c[1])),Math.max(...s.map(c=>c[0])),Math.max(...s.map(c=>c[1]))],{style:u,svg:h}=(n=mt(x.element))!=null?n:{svg:h})}const f={type:"SvgSelector",svg:h,svgShape:y,style:u,points:s.length?s:void 0,spatial:i?{unit:"pixel",x:i[0],y:i[1],width:i[2]-i[0],height:i[3]-i[1]}:void 0};return F({selector:f,selectors:[f],iiifRenderingHints:r})}return F({selector:null,selectors:[],iiifRenderingHints:r})}function bt(e){const t=e.map(r=>r[0]).reduce((r,o)=>(r[o]+=1,r),{C:0,Q:0,L:0,M:0}),a=new Set(e.map(r=>r[0]));if(t.C>0||t.Q>0)return"path";if(t.L>0&&(a.size===1||a.size===2&&a.has("M"))){if(t.L===4)return"rect";const r=e.slice(-1)[0];return e[0][0]==="M"&&r[0]==="L"&&r[1]==e[0][1]&&r[2]===e[0][2]||r[1]===0&&r[2]===0?"polygon":"polyline"}return"path"}function G(e){var t,a,r,o,n,s,i,u,h,y,f,M,x,c,g,b,d;for(const l of Array.from(e.children))switch(l==null?void 0:l.tagName.toLowerCase()){case"g":{const p=G(l);if(p)return p}continue;case"path":{const p=l.getAttribute("d");if(!p)continue;const v=pt(p);return{element:l,points:dt(v),shapeType:bt(v)}}case"circle":{const p=parseFloat((t=l.getAttribute("cx"))!=null?t:"0"),v=parseFloat((a=l.getAttribute("cy"))!=null?a:"0"),m=parseFloat((r=l.getAttribute("r"))!=null?r:"0");if(!m)continue;const A=[];for(let w=0;w<=360;w+=12){const S=w*Math.PI/180;A.push([p+m*Math.cos(S),v+m*Math.sin(S)])}return{element:l,points:A,shapeType:"circle"}}case"ellipse":{const p=parseFloat((o=l.getAttribute("cx"))!=null?o:"0"),v=parseFloat((n=l.getAttribute("cy"))!=null?n:"0"),m=parseFloat((s=l.getAttribute("rx"))!=null?s:"0"),A=parseFloat((i=l.getAttribute("ry"))!=null?i:"0");if(!m&&!A)continue;const w=[];for(let S=0;S<=360;S+=12){const k=Math.tan(S/360*Math.PI),O=m*(1-k**2)/(1+k**2),T=A*2*k/(1+k**2);w.push([p+O,v+T])}return{element:l,points:w,shapeType:"ellipse"}}case"line":{const p=parseFloat((u=l.getAttribute("x0"))!=null?u:"0"),v=parseFloat((h=l.getAttribute("y0"))!=null?h:"0"),m=parseFloat((y=l.getAttribute("x1"))!=null?y:"0"),A=parseFloat((f=l.getAttribute("y1"))!=null?f:"0");if(p===m&&v===A)continue;return{element:l,points:[[p,v],[m,A]],shapeType:"polyline"}}case"polygon":case"polyline":{const p=(x=(M=l.getAttribute("points"))==null?void 0:M.split(" ").map(m=>m.split(",").map(parseFloat)))!=null?x:[];if(!p.length)continue;let v="polyline";return l.tagName.toLowerCase()==="polygon"&&(p.push(p[0]),v="polygon"),{element:l,points:p,shapeType:v}}case"rect":{const p=parseFloat((c=l.getAttribute("x"))!=null?c:"0"),v=parseFloat((g=l.getAttribute("y"))!=null?g:"0"),m=parseFloat((b=l.getAttribute("width"))!=null?b:"0"),A=parseFloat((d=l.getAttribute("height"))!=null?d:"0");if(!m||!A)continue;return{element:l,points:[[p,v],[p+m,v],[p+m,v+A],[p,v+A],[p,v]],shapeType:"rect"}}default:continue}return null}function dt(e){var a;const t=[];for(let r=0;r<e.length;r++){const o=(a=t[t.length-1])!=null?a:[0,0],n=e[r];switch(n[0]){case"M":case"L":t.push([n[1],n[2]]);continue;case"C":t.push(...yt({x:o[0],y:o[1]},{x:n[1],y:n[2]},{x:n[3],y:n[4]},{x:n[5],y:n[6]}).map(s=>[s.x,s.y]).slice(1));continue;case"Q":t.push(...ht({x:o[0],y:o[1]},{x:n[1],y:n[2]},{x:n[3],y:n[4]}).map(s=>[s.x,s.y]).slice(1));continue}}return t}function mt(e){const t={};if(e.hasAttribute("fill")?(t.fill=e.getAttribute("fill"),e.removeAttribute("fill")):e.style.fill&&(t.fill=e.style.fill),t.fill){const r=N.exec(t.fill);r&&(t.fillOpacity=parseFloat(r[4]),t.fill=`rgb(${r[1]}, ${r[2]}, ${r[3]})`)}if(e.hasAttribute("fill-opacity")?(t.fillOpacity=parseFloat(e.getAttribute("fill-opacity")),e.removeAttribute("fill-opacity")):e.style.fillOpacity&&(t.fillOpacity=parseFloat(e.style.fillOpacity)),e.hasAttribute("stroke")?(t.stroke=e.getAttribute("stroke"),e.removeAttribute("stroke")):e.style.stroke&&(t.stroke=e.style.stroke),t.stroke){const r=N.exec(t.stroke);r&&(t.strokeOpacity=parseFloat(r[4]),t.stroke=`rgb(${r[1]}, ${r[2]}, ${r[3]})`)}e.hasAttribute("stroke-opacity")?(t.strokeOpacity=parseFloat(e.getAttribute("stroke-opacity")),e.removeAttribute("stroke-opacity")):e.style.strokeOpacity&&(t.strokeOpacity=parseFloat(e.style.strokeOpacity)),e.hasAttribute("stroke-width")?(t.strokeWidth=e.getAttribute("stroke-width"),e.removeAttribute("stroke-width")):e.style.strokeWidth&&(t.strokeWidth=e.style.strokeWidth),e.hasAttribute("stroke-dasharray")?(t.strokeDasharray=e.getAttribute("stroke-dasharray"),e.removeAttribute("stroke-dasharray")):e.style.strokeDasharray&&(t.strokeDasharray=e.style.strokeDasharray);let a=e;for(;a.tagName.toLowerCase()!=="svg";)if(a=a.parentElement,a===null)throw new Error("Could not find root SVG element");return{svg:a.outerHTML,style:Object.keys(t).length>0?t:void 0}}function W(e){return!!e&&e.type==="iiif:ImageApiSelector"&&e.type==="iiif:ImageApiSelector"}function F(e){if(e.iiifRenderingHints){const t=e.iiifRenderingHints;if(t.rotation){const a=Y(t.rotation);if(a)if(e.selectors.length)for(const r of e.selectors)r.rotation=a;else e.selectors.push({type:"RotationSelector",rotation:a})}}else delete e.iiifRenderingHints;return e}function Y(e){let t=parseFloat(e);return t&&e.startsWith("!")&&(t=360-t),t&&(t=t%360),t!==t?0:t||0}function C(e,t={}){if(Array.isArray(e))return C(e[0]);if(typeof e=="string"){const[a,r]=e.split("#");return r?C({type:"SpecificResource",source:{id:a,type:"Unknown"},selector:{type:"FragmentSelector",value:r}}):{type:"SpecificResource",source:{id:a,type:t.typeMap&&t.typeMap[a]||"Unknown"},selector:null,selectors:[]}}if(e.type==="Choice"||e.type==="List"||e.type==="Composite"||e.type==="Independents")return C(e.items[0]);if(e.type==="SpecificResource"){e.source.type==="Canvas"&&e.source.partOf&&typeof e.source.partOf=="string"&&(e.source.partOf=[{id:e.source.partOf,type:"Manifest"}]);const{selector:a,selectors:r}=e.selector?R(e.selector,t):{selector:null,selectors:[]};return{type:"SpecificResource",source:e.source,selector:a,selectors:r}}if(e.id){e.type==="Canvas"&&e.partOf&&typeof e.partOf=="string"&&(e.partOf=[{id:e.partOf,type:"Manifest"}]);const[a,r]=e.id.split("#");return r?C({type:"SpecificResource",source:{...e,id:a},selector:{type:"FragmentSelector",value:r}}):{type:"SpecificResource",source:{...e,id:a},selector:null,selectors:[]}}return{type:"SpecificResource",source:e,selector:null,selectors:[]}}exports.expandTarget=C;exports.isImageApiSelector=W;exports.parseRotation=Y;exports.parseSelector=R;
//# sourceMappingURL=annotation-targets.js.map
