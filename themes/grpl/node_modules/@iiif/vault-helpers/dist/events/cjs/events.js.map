{"version":3,"file":"events.js","sources":["../../../src/compat.ts","../../../src/events.ts"],"sourcesContent":["export type CompatVault = {\n  get: import('@iiif/vault').Vault['get'];\n  setMetaValue: import('@iiif/vault').Vault['setMetaValue'];\n  getResourceMeta: import('@iiif/vault').Vault['getResourceMeta'];\n};\n\nconst metaState: any = {};\nexport const compatVault: CompatVault = {\n  get(nonRef: any) {\n    return nonRef;\n  },\n  setMetaValue([id, meta, key], value) {\n    const oldValue = compatVault.getResourceMeta(id, meta);\n    const oldValueItem = oldValue ? oldValue[key] : undefined;\n    const newValue = typeof value === 'function' ? (value as any)(oldValueItem) : value;\n    metaState[id] = {\n      ...(metaState[id] || {}),\n      [meta]: {\n        ...((metaState[id] || {})[meta] || {}),\n        [key]: newValue,\n      },\n    };\n  },\n  getResourceMeta: ((resource: any, metaKey?: any) => {\n    const resourceMeta = metaState[resource as any] as any;\n\n    if (!resourceMeta) {\n      return undefined;\n    }\n    if (!metaKey) {\n      return resourceMeta;\n    }\n\n    return resourceMeta[metaKey];\n  }) as any,\n};\n","import type { Reference } from '@iiif/presentation-3';\nimport { compatVault, CompatVault } from './compat';\n\nexport function createEventsHelper(vault: CompatVault = compatVault) {\n  return {\n    addEventListener<T>(\n      resource: Reference<any>,\n      event: string,\n      listener: (e: any, resource: T) => void,\n      scope?: string[]\n    ) {\n      if (!resource) {\n        return;\n      }\n\n      vault.setMetaValue<Array<{ callback: any; scope?: string[] }>>(\n        [resource.id, 'eventManager', event],\n        (registeredCallbacks) => {\n          const callbacks = registeredCallbacks || [];\n          for (const registered of callbacks) {\n            if (registered.callback === listener) {\n              // @todo check for scopes matching, very edge-case as scopes should be fixed.\n              return callbacks;\n            }\n          }\n          return [...callbacks, { callback: listener, scope }];\n        }\n      );\n\n      return listener;\n    },\n\n    removeEventListener<T>(resource: Reference<any>, event: string, listener: (e: any, resource: T) => void) {\n      if (!resource) {\n        return;\n      }\n      vault.setMetaValue<Array<{ callback: () => void; scope?: string[] }>>(\n        [resource.id, 'eventManager', event],\n        (registeredCallbacks) => {\n          return (registeredCallbacks || []).filter((registeredCallback) => registeredCallback.callback !== listener);\n        }\n      );\n    },\n\n    getListenersAsProps(resourceOrId: string | Reference<any>, scope?: string[]) {\n      const resource = typeof resourceOrId === 'string' ? { id: resourceOrId } : resourceOrId;\n      if (!resource || !resource.id) {\n        return {};\n      }\n      const hooks = vault.getResourceMeta(resource.id, 'eventManager');\n      const props: any = {};\n      if (hooks && resource) {\n        for (const hook of Object.keys(hooks)) {\n          props[hook] = (e: any) => {\n            const fullResource = vault.get(resource);\n            for (const { callback, scope: _scope } of hooks[hook] || []) {\n              if (!_scope || (scope && _scope.indexOf(scope) !== -1)) {\n                callback(e, fullResource);\n              }\n            }\n          };\n        }\n      }\n      return props;\n    },\n  };\n}\n"],"names":["metaState","compatVault","nonRef","id","meta","key","value","oldValue","oldValueItem","newValue","resource","metaKey","resourceMeta","createEventsHelper","vault","event","listener","scope","registeredCallbacks","callbacks","registered","registeredCallback","resourceOrId","hooks","props","hook","e","fullResource","callback","_scope"],"mappings":"4GAMA,MAAMA,EAAiB,CAAA,EACVC,EAA2B,CACtC,IAAIC,EAAa,CACR,OAAAA,CACT,EACA,aAAa,CAACC,EAAIC,EAAMC,CAAG,EAAGC,EAAO,CACnC,MAAMC,EAAWN,EAAY,gBAAgBE,EAAIC,CAAI,EAC/CI,EAAeD,EAAWA,EAASF,GAAO,OAC1CI,EAAW,OAAOH,GAAU,WAAcA,EAAcE,CAAY,EAAIF,EAC9EN,EAAUG,GAAM,CACd,GAAIH,EAAUG,IAAO,CAAC,EACtB,CAACC,GAAO,CACN,IAAKJ,EAAUG,IAAO,CAAA,GAAIC,IAAS,CAAC,EACpC,CAACC,GAAMI,CACT,CAAA,CAEJ,EACA,gBAAkB,CAACC,EAAeC,IAAkB,CAClD,MAAMC,EAAeZ,EAAUU,GAE/B,GAAI,EAACE,EAGL,OAAKD,EAIEC,EAAaD,GAHXC,CAIX,CACF,EChCgB,SAAAC,EAAmBC,EAAqBb,EAAa,CAC5D,MAAA,CACL,iBACES,EACAK,EACAC,EACAC,EACA,CACA,GAAI,EAACP,EAIC,OAAAI,EAAA,aACJ,CAACJ,EAAS,GAAI,eAAgBK,CAAK,EAClCG,GAAwB,CACjB,MAAAC,EAAYD,GAAuB,GACzC,UAAWE,KAAcD,EACnB,GAAAC,EAAW,WAAaJ,EAEnB,OAAAG,EAGX,MAAO,CAAC,GAAGA,EAAW,CAAE,SAAUH,EAAU,MAAAC,EAAO,CACrD,CAAA,EAGKD,CACT,EAEA,oBAAuBN,EAA0BK,EAAeC,EAAyC,CACnG,CAACN,GAGCI,EAAA,aACJ,CAACJ,EAAS,GAAI,eAAgBK,CAAK,EAClCG,IACSA,GAAuB,CAAA,GAAI,OAAQG,GAAuBA,EAAmB,WAAaL,CAAQ,CAC5G,CAEJ,EAEA,oBAAoBM,EAAuCL,EAAkB,CAC3E,MAAMP,EAAW,OAAOY,GAAiB,SAAW,CAAE,GAAIA,CAAiB,EAAAA,EAC3E,GAAI,CAACZ,GAAY,CAACA,EAAS,GACzB,MAAO,GAET,MAAMa,EAAQT,EAAM,gBAAgBJ,EAAS,GAAI,cAAc,EACzDc,EAAa,CAAA,EACnB,GAAID,GAASb,EACX,UAAWe,KAAQ,OAAO,KAAKF,CAAK,EAC5BC,EAAAC,GAASC,GAAW,CAClB,MAAAC,EAAeb,EAAM,IAAIJ,CAAQ,EAC5B,SAAA,CAAE,SAAAkB,EAAU,MAAOC,KAAYN,EAAME,IAAS,IACnD,CAACI,GAAWZ,GAASY,EAAO,QAAQZ,CAAK,IAAM,KACjDW,EAASF,EAAGC,CAAY,CAE5B,EAIC,OAAAH,CACT,CAAA,CAEJ"}