{"version":3,"file":"events.mjs","sources":["../../../src/compat.ts","../../../src/events.ts"],"sourcesContent":["export type CompatVault = {\n  get: import('@iiif/vault').Vault['get'];\n  setMetaValue: import('@iiif/vault').Vault['setMetaValue'];\n  getResourceMeta: import('@iiif/vault').Vault['getResourceMeta'];\n};\n\nconst metaState: any = {};\nexport const compatVault: CompatVault = {\n  get(nonRef: any) {\n    return nonRef;\n  },\n  setMetaValue([id, meta, key], value) {\n    const oldValue = compatVault.getResourceMeta(id, meta);\n    const oldValueItem = oldValue ? oldValue[key] : undefined;\n    const newValue = typeof value === 'function' ? (value as any)(oldValueItem) : value;\n    metaState[id] = {\n      ...(metaState[id] || {}),\n      [meta]: {\n        ...((metaState[id] || {})[meta] || {}),\n        [key]: newValue,\n      },\n    };\n  },\n  getResourceMeta: ((resource: any, metaKey?: any) => {\n    const resourceMeta = metaState[resource as any] as any;\n\n    if (!resourceMeta) {\n      return undefined;\n    }\n    if (!metaKey) {\n      return resourceMeta;\n    }\n\n    return resourceMeta[metaKey];\n  }) as any,\n};\n","import type { Reference } from '@iiif/presentation-3';\nimport { compatVault, CompatVault } from './compat';\n\nexport function createEventsHelper(vault: CompatVault = compatVault) {\n  return {\n    addEventListener<T>(\n      resource: Reference<any>,\n      event: string,\n      listener: (e: any, resource: T) => void,\n      scope?: string[]\n    ) {\n      if (!resource) {\n        return;\n      }\n\n      vault.setMetaValue<Array<{ callback: any; scope?: string[] }>>(\n        [resource.id, 'eventManager', event],\n        (registeredCallbacks) => {\n          const callbacks = registeredCallbacks || [];\n          for (const registered of callbacks) {\n            if (registered.callback === listener) {\n              // @todo check for scopes matching, very edge-case as scopes should be fixed.\n              return callbacks;\n            }\n          }\n          return [...callbacks, { callback: listener, scope }];\n        }\n      );\n\n      return listener;\n    },\n\n    removeEventListener<T>(resource: Reference<any>, event: string, listener: (e: any, resource: T) => void) {\n      if (!resource) {\n        return;\n      }\n      vault.setMetaValue<Array<{ callback: () => void; scope?: string[] }>>(\n        [resource.id, 'eventManager', event],\n        (registeredCallbacks) => {\n          return (registeredCallbacks || []).filter((registeredCallback) => registeredCallback.callback !== listener);\n        }\n      );\n    },\n\n    getListenersAsProps(resourceOrId: string | Reference<any>, scope?: string[]) {\n      const resource = typeof resourceOrId === 'string' ? { id: resourceOrId } : resourceOrId;\n      if (!resource || !resource.id) {\n        return {};\n      }\n      const hooks = vault.getResourceMeta(resource.id, 'eventManager');\n      const props: any = {};\n      if (hooks && resource) {\n        for (const hook of Object.keys(hooks)) {\n          props[hook] = (e: any) => {\n            const fullResource = vault.get(resource);\n            for (const { callback, scope: _scope } of hooks[hook] || []) {\n              if (!_scope || (scope && _scope.indexOf(scope) !== -1)) {\n                callback(e, fullResource);\n              }\n            }\n          };\n        }\n      }\n      return props;\n    },\n  };\n}\n"],"names":[],"mappings":"AAMA,MAAM,YAAiB,CAAA;AAChB,MAAM,cAA2B;AAAA,EACtC,IAAI,QAAa;AACR,WAAA;AAAA,EACT;AAAA,EACA,aAAa,CAAC,IAAI,MAAM,GAAG,GAAG,OAAO;AACnC,UAAM,WAAW,YAAY,gBAAgB,IAAI,IAAI;AAC/C,UAAA,eAAe,WAAW,SAAS,OAAO;AAChD,UAAM,WAAW,OAAO,UAAU,aAAc,MAAc,YAAY,IAAI;AAC9E,cAAU,MAAM;AAAA,MACd,GAAI,UAAU,OAAO,CAAC;AAAA,MACtB,CAAC,OAAO;AAAA,QACN,IAAK,UAAU,OAAO,CAAA,GAAI,SAAS,CAAC;AAAA,QACpC,CAAC,MAAM;AAAA,MACT;AAAA,IAAA;AAAA,EAEJ;AAAA,EACA,iBAAkB,CAAC,UAAe,YAAkB;AAClD,UAAM,eAAe,UAAU;AAE/B,QAAI,CAAC,cAAc;AACV,aAAA;AAAA,IACT;AACA,QAAI,CAAC,SAAS;AACL,aAAA;AAAA,IACT;AAEA,WAAO,aAAa;AAAA,EACtB;AACF;AChCgB,SAAA,mBAAmB,QAAqB,aAAa;AAC5D,SAAA;AAAA,IACL,iBACE,UACA,OACA,UACA,OACA;AACA,UAAI,CAAC,UAAU;AACb;AAAA,MACF;AAEM,YAAA;AAAA,QACJ,CAAC,SAAS,IAAI,gBAAgB,KAAK;AAAA,QACnC,CAAC,wBAAwB;AACjB,gBAAA,YAAY,uBAAuB;AACzC,qBAAW,cAAc,WAAW;AAC9B,gBAAA,WAAW,aAAa,UAAU;AAE7B,qBAAA;AAAA,YACT;AAAA,UACF;AACA,iBAAO,CAAC,GAAG,WAAW,EAAE,UAAU,UAAU,OAAO;AAAA,QACrD;AAAA,MAAA;AAGK,aAAA;AAAA,IACT;AAAA,IAEA,oBAAuB,UAA0B,OAAe,UAAyC;AACvG,UAAI,CAAC,UAAU;AACb;AAAA,MACF;AACM,YAAA;AAAA,QACJ,CAAC,SAAS,IAAI,gBAAgB,KAAK;AAAA,QACnC,CAAC,wBAAwB;AACf,kBAAA,uBAAuB,CAAA,GAAI,OAAO,CAAC,uBAAuB,mBAAmB,aAAa,QAAQ;AAAA,QAC5G;AAAA,MAAA;AAAA,IAEJ;AAAA,IAEA,oBAAoB,cAAuC,OAAkB;AAC3E,YAAM,WAAW,OAAO,iBAAiB,WAAW,EAAE,IAAI,aAAiB,IAAA;AAC3E,UAAI,CAAC,YAAY,CAAC,SAAS,IAAI;AAC7B,eAAO;MACT;AACA,YAAM,QAAQ,MAAM,gBAAgB,SAAS,IAAI,cAAc;AAC/D,YAAM,QAAa,CAAA;AACnB,UAAI,SAAS,UAAU;AACrB,mBAAW,QAAQ,OAAO,KAAK,KAAK,GAAG;AAC/B,gBAAA,QAAQ,CAAC,MAAW;AAClB,kBAAA,eAAe,MAAM,IAAI,QAAQ;AAC5B,uBAAA,EAAE,UAAU,OAAO,YAAY,MAAM,SAAS,IAAI;AAC3D,kBAAI,CAAC,UAAW,SAAS,OAAO,QAAQ,KAAK,MAAM,IAAK;AACtD,yBAAS,GAAG,YAAY;AAAA,cAC1B;AAAA,YACF;AAAA,UAAA;AAAA,QAEJ;AAAA,MACF;AACO,aAAA;AAAA,IACT;AAAA,EAAA;AAEJ;;"}