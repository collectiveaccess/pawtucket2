(function(x,T){typeof exports=="object"&&typeof module!="undefined"?T(exports):typeof define=="function"&&define.amd?define(["exports"],T):(x=typeof globalThis!="undefined"?globalThis:x||self,T(x.VaultHelpers={}))})(this,function(x){"use strict";const T={},I={get(e){return e},setMetaValue([e,t,n],i){const r=I.getResourceMeta(e,t),s=r?r[n]:void 0,o=typeof i=="function"?i(s):i;T[e]={...T[e]||{},[t]:{...(T[e]||{})[t]||{},[n]:o}}},getResourceMeta:(e,t)=>{const n=T[e];if(!!n)return t?n[t]:n}};function st(e=I){return{addEventListener(t,n,i,r){if(!!t)return e.setMetaValue([t.id,"eventManager",n],s=>{const o=s||[];for(const a of o)if(a.callback===i)return o;return[...o,{callback:i,scope:r}]}),i},removeEventListener(t,n,i){!t||e.setMetaValue([t.id,"eventManager",n],r=>(r||[]).filter(s=>s.callback!==i))},getListenersAsProps(t,n){const i=typeof t=="string"?{id:t}:t;if(!i||!i.id)return{};const r=e.getResourceMeta(i.id,"eventManager"),s={};if(r&&i)for(const o of Object.keys(r))s[o]=a=>{const c=e.get(i);for(const{callback:u,scope:f}of r[o]||[])(!f||n&&f.indexOf(n)!==-1)&&u(a,c)};return s}}}function ot(e=I){return{applyStyles(t,n,i){const r=typeof t=="string"?t:t.id;return e.setMetaValue([r,"styles",n],i)},getAppliedStyles(t){const n=typeof t=="string"?t:t.id;return e.getResourceMeta(n,"styles")}}}function W(e){return e.endsWith("info.json")?e:e.endsWith("/")?`${e}info.json`:`${e}/info.json`}const at="http://library.stanford.edu/iiif/image-api/compliance.html#level0",ce="http://library.stanford.edu/iiif/image-api/compliance.html#level1",le="http://library.stanford.edu/iiif/image-api/compliance.html#level2",ct="http://library.stanford.edu/iiif/image-api/conformance.html#level0",fe="http://library.stanford.edu/iiif/image-api/conformance.html#level1",ue="http://library.stanford.edu/iiif/image-api/conformance.html#level2",lt="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level0",he="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level1",pe="http://library.stanford.edu/iiif/image-api/1.1/compliance.html#level2",ft="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level0",de="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level1",ge="http://library.stanford.edu/iiif/image-api/1.1/conformance.html#level2",ut="http://iiif.io/api/image/1/level0.json",ht="http://iiif.io/api/image/1/profiles/level0.json",ye="http://iiif.io/api/image/1/level1.json",me="http://iiif.io/api/image/1/profiles/level1.json",ve="http://iiif.io/api/image/1/level2.json",xe="http://iiif.io/api/image/1/profiles/level2.json",pt="http://iiif.io/api/image/2/level0.json",dt="http://iiif.io/api/image/2/profiles/level0.json",be="http://iiif.io/api/image/2/level1.json",we="http://iiif.io/api/image/2/profiles/level1.json",Se="http://iiif.io/api/image/2/level2.json",Ae="http://iiif.io/api/image/2/profiles/level2.json",gt="level0",Fe="level1",Me="level2",yt="http://iiif.io/api/image/2/level0",Ce="http://iiif.io/api/image/2/level1",Oe="http://iiif.io/api/image/2/level2",ke=[Oe,le,ue,pe,ge,ve,xe,Se,Ae,Me],Re=[...ke,Ce,ce,fe,he,de,ye,me,be,we,Fe],mt=[yt,Ce,Oe,at,ce,le,ct,fe,ue,lt,he,pe,ft,de,ge,ut,ht,ye,me,ve,xe,pt,dt,be,we,Se,Ae,gt,Fe,Me],vt={extraFormats:["jpg"],extraQualities:["default"],extraFeatures:["sizeByWhListed"]},xt={extraFormats:["jpg"],extraQualities:["default"],extraFeatures:["baseUriRedirect","cors","jsonldMediaType","regionByPx","regionSquare","sizeByWhListed","sizeByH","sizeByW","sizeByWh"]},bt={extraFormats:["jpg","png"],extraQualities:["default"],extraFeatures:["baseUriRedirect","cors","jsonldMediaType","regionByPct","regionByPx","regionSquare","rotationBy90s","sizeByWhListed","sizeByConfinedWh","sizeByH","sizeByPct","sizeByW","sizeByWh"]};function wt(e){return ke.indexOf(e)!==-1?bt:Re.indexOf(e)!==-1?xt:vt}function St(e){const t=e?Array.isArray(e.profile)?e.profile:[e.profile]:[],n={extraQualities:[],extraFormats:[],extraFeatures:[]};for(let i of t)if(typeof i=="string"&&(i=wt(i)),!!i){if(i.formats)for(const r of i.formats)n.extraFormats.indexOf(r)===-1&&n.extraFormats.push(r);if(i.qualities)for(const r of i.qualities)n.extraQualities.indexOf(r)===-1&&n.extraQualities.push(r);if(i.supports)for(const r of i.supports)n.extraFeatures.indexOf(r)===-1&&n.extraFeatures.push(r);if(i.maxHeight&&(n.maxHeight=i.maxHeight),i.maxWidth&&(n.maxWidth=i.maxWidth),i.maxArea&&(n.maxArea=i.maxArea),i.extraFormats)for(const r of i.extraFormats)n.extraFormats.indexOf(r)===-1&&n.extraFormats.push(r);if(i.extraQualities)for(const r of i.extraQualities)n.extraQualities.indexOf(r)===-1&&n.extraQualities.push(r);if(i.extraFeatures)for(const r of i.extraFeatures)n.extraFeatures.indexOf(r)===-1&&n.extraFeatures.push(r);i.maxHeight&&(n.maxHeight=i.maxHeight),i.maxWidth&&(n.maxWidth=i.maxWidth),i.maxArea&&(n.maxArea=i.maxArea)}if(e.extraFormats)for(const i of e.extraFormats)n.extraFormats.indexOf(i)===-1&&n.extraFormats.push(i);if(e.extraFeatures)for(const i of e.extraFeatures)n.extraFeatures.indexOf(i)===-1&&n.extraFeatures.push(i);if(e.extraQualities)for(const i of e.extraQualities)n.extraQualities.indexOf(i)===-1&&n.extraQualities.push(i);return n}function At(e){try{if(e==="full")return{full:!0};if(e==="square")return{square:!0};const t=e.startsWith("pct:"),n=e.substr(t?4:0).split(",").map(i=>parseFloat(i));return{x:n[0],y:n[1],w:n[2],h:n[3],percent:t}}catch{throw new Error("Expected 'full', 'square' or 'x,y,w,h'. Found "+e)}}function Ft(e){const t={upscaled:!1,max:!1,confined:!1};if(e[0]==="^"&&(t.upscaled=!0,e=e.slice(1)),e==="max"||e==="full")return t.max=!0,t.serialiseAsFull=e==="full",t;if(e[0]==="!"&&(t.confined=!0,e=e.slice(1)),e[0]==="p")return t.percentScale=parseFloat(e.slice(4)),t;const n=e.split(",").map(i=>i.trim());return n.length&&(n[0]!==""&&(t.width=parseInt(n[0],10)),n[1]!==""?(t.height=parseInt(n[1],10),t.version=2):t.version=3),t}function Mt(e){const t={angle:0};if(e[0]==="!"&&(t.mirror=!0,e=e.substr(1)),t.angle=parseFloat(e)%360,Number.isNaN(t.angle))throw new Error(`Invalid rotation ${e}`);return t}function Ct(e,t=""){const n=e.match(/^(([a-zA-Z]+):\/\/([^/]+))?((.*)+)/);if(!n)throw new Error(`Invalid or unknown input ${e}`);const i=n[2],r=n[3];let s=n[4];if(s[0]==="/"&&(s=s.substr(1)),t.length>0){if(t[0]==="/"&&(t=t.substr(1)),t!==s.substr(0,t.length))throw new Error(`Path does not start with prefix (path: ${s}, prefix: ${t})`);s=s.substr(t.length)}return{scheme:i,server:r,path:s,prefix:t}}function Ot(e,t=""){const{path:n,scheme:i,server:r,prefix:s}=Ct(e,t),o=n.split("/").reverse(),[a,c,u,f,...p]=o,h=p.reverse().filter(Boolean).join("/");if(o.length===1||a==="")return{type:"base",scheme:i,server:r,prefix:s,identifier:h};if(a==="info.json"){const[,...l]=o;return{type:"info",scheme:i,server:r,prefix:s,identifier:l.reverse().filter(Boolean).join("/")}}const g=a.split(".");return{type:"image",scheme:i,server:r,prefix:s,identifier:h,originalPath:n,region:At(f),size:Ft(u),rotation:Mt(c),quality:g[0],format:g[1]}}function kt(e){const t=Ot(W(e.id));if(t.type!=="info")throw new Error("Invalid service URL");const n=St(e);return{identifier:t.identifier,originalPath:"",server:t.server,prefix:t.prefix,scheme:t.scheme,type:"image",quality:n.extraQualities.indexOf("default")===-1?n.extraQualities[0]:"default",region:{full:!0},size:{max:!0,upscaled:!1,confined:!1},format:"jpg",rotation:{angle:0}}}function Rt(e,t,n){const i=n.length,r=[];for(let s=0;s<i;s++){const o=n[s].width;r.push(e/o)}return r}function jt(e,t,n){const i=n.length,r=[];for(let s=0;s<i;s++){const o=n[s];r.push({width:Math.floor(e/o),height:Math.floor(t/o)})}return r}function F(e){if(e["@id"])return e["@id"];if(e.id)return e.id}function J(e){if(!e||!e.profile||!F(e))return!1;const t=Array.isArray(e.profile)?e.profile:[e.profile];for(const n of t)if(typeof n=="string"&&mt.indexOf(n)!==-1)return!0;return!1}function It(e){if(!J(e))return!1;const t=Array.isArray(e.profile)?e.profile:[e.profile];for(const n of t)if(typeof n=="string"){if(Re.indexOf(n)!==-1)return!0}else{const i=[...n.supports||[],...n.extraFeatures||[]];if(i.indexOf("regionByPx")!==-1&&(i.indexOf("sizeByW")!==-1||i.indexOf("sizeByWh")!==-1))return!0}return!1}function X(e,t){if(t&&t.profile){const n=t.profile;if(n){const i=Array.isArray(n)?n:[n];return i.includes(`level${e}`)||i.includes(`http://iiif.io/api/image/2/level${e}.json`)||i.includes(`http://iiif.io/api/image/1/level${e}.json`)||i.includes(`http://iiif.io/api/image/1/profiles/level${e}.json`)}}return!1}function Z(e){return J(e)?X(0,e)?0:X(1,e)?1:X(2,e)?2:null:null}function je(e){return(e["@context"]?Array.isArray(e["@context"])?e["@context"]:[e["@context"]]:[]).indexOf("http://iiif.io/api/image/3/context.json")!==-1}function Tt(e){if(!It(e))return[];const t=[],n=Array.isArray(e.profile)?e.profile:[e.profile],i=n.length;for(let r=0;r<i;r++){const s=n[r];if(typeof s!="string"&&(s.maxHeight||s.maxWidth))return[{id:F(e),type:"variable",minWidth:0,minHeight:0,maxHeight:s.maxHeight||s.maxWidth,maxWidth:s.maxWidth||s.maxHeight,level:Z(e),version:e["@context"]==="http://iiif.io/api/image/3/context.json"?3:2}]}if(e.tiles){const r=e.tiles.length;for(let s=0;s<r;s++){const o=e.tiles[s];(o.height||o.width)&&t.push({id:F(e),type:"variable",minHeight:0,minWidth:0,maxHeight:o.height||o.width,maxWidth:o.width,level:Z(e),version:je(e)?3:2})}}return t}function Ie(e){const t=/^.*\/(full)\/(((\d+),(\d+)?)|max)\/(\d+)\/default\.(jpg|png|jpeg)$/,n=e.match(t);if(n){const i=n[1],r=parseInt(n[4],10),s=parseInt(n[5],10),o=n[7];if((i==="max"||i==="full")&&r&&s&&o)return{type:"fixed",id:e,height:s,width:r}}return{type:"unknown",id:e}}function zt(e){if(e["@type"])return e["@type"];if(e.type)return e.type}function K(e){if(typeof e=="string")return Ie(e);const t=zt(e);if(t!=="Image"&&t!=="sc:Image")return null;const n=e,i=F(n);return i?i&&n.width&&n.height?{id:i,type:"fixed",width:n.width,height:n.height,unsafe:!0}:Ie(i):null}function $t(e){return J(e)?(e&&e.sizes?e.sizes:[]).map(t=>({id:F(e),type:"fixed-service",height:t.height,width:t.width,level:Z(e),version:je(e)?3:2})):[]}function Te(e){const t=[],n=e.length;for(let i=0;i<n;i++){const r=$t(e[i]);r.length&&t.push(...r);const s=Tt(e[i]);s.length&&t.push(...s)}return t}function ze(e){const t=e.service?Array.isArray(e.service)?e.service:[e.service]:[],n=t.length,i=[];for(let r=0;r<n;r++)J(t[r])&&i.push(t[r]);return i}function Wt(e,t=!0,n){const i=[],r=K(e);if(r===null)return i;const s=e;if(i.push(r),t&&s.width&&s.height){const o=[],a=ze(s);for(const c of a){const u={id:F(c),width:s.width,height:s.height};if(n.canLoadSync(u)){const f=n.loadServiceSync(u);f&&(f.height||(f.height=s.height),f.width||(f.width=s.width),o.push(...Te([f])))}}if(o.length)return i.push(...o),i}return s.service&&i.push(...Te(s.service)),i}function Bt({x:e=0,y:t=0,w:n,h:i,full:r,square:s,percent:o}){if(r)return"full";if(s)return"square";if(typeof n>"u"||typeof i>"u")throw new Error("RegionParameter: invalid region");const a=`${e},${t},${n},${i}`;return o?`pct:${a}`:a}function Pt({max:e,percentScale:t,upscaled:n,confined:i,width:r,height:s,serialiseAsFull:o,version:a}){const c=[];return n&&c.push("^"),e?(c.push(o?"full":"max"),c.join("")):(i&&c.push("!"),t&&c.push(`pct:${t}`),r&&c.push(`${r}`),c.push(","),s&&a===3&&c.push(`${s}`),c.join(""))}function qt(e){return`${e.mirror?"!":""}${(e.angle||0)%360}`}var Ht=Object.defineProperty,Lt=Object.defineProperties,_t=Object.getOwnPropertyDescriptors,$e=Object.getOwnPropertySymbols,Qt=Object.prototype.hasOwnProperty,Vt=Object.prototype.propertyIsEnumerable,We=(e,t,n)=>t in e?Ht(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,B=(e,t)=>{for(var n in t||(t={}))Qt.call(t,n)&&We(e,n,t[n]);if($e)for(var n of $e(t))Vt.call(t,n)&&We(e,n,t[n]);return e},P=(e,t)=>Lt(e,_t(t));function Nt(e,t){const n=e.prefix.startsWith("/")?e.prefix.substr(1):e.prefix,i=`${e.scheme}://${e.server}/${n?`${n}/`:""}${e.identifier}`;if(e.type==="base")return i;if(e.type==="info")return`${i}/info.json`;let{size:r}=e;const{region:s,rotation:o,format:a,quality:c}=e;if(t){const u=t["@context"]?Array.isArray(t["@context"])?t["@context"]:[t["@context"]]:[],f=u.indexOf("http://iiif.io/api/image/2/context.json")!==-1,p=u.indexOf("http://iiif.io/api/image/3/context.json")!==-1;if((r.width===t.width&&!r.height||r.height===t.height&&!r.width||r.width===t.width&&r.height===t.height)&&(r=P(B({},r),{max:!0})),f&&(r.max&&!r.serialiseAsFull&&(r=P(B({},r),{serialiseAsFull:!0})),!r.max&&r.width&&r.height&&(r=P(B({},r),{height:void 0})),r=P(B({},r),{version:2})),p){if(r.max&&r.serialiseAsFull&&(r=P(B({},r),{serialiseAsFull:!1})),r.width&&!r.height&&t.width&&t.height){const h=t.height/t.width;r=P(B({},r),{height:Math.ceil(r.width*h)})}r=P(B({},r),{version:3})}}return[i,Bt(s),Pt(r),qt(o),`${c}.${a}`].filter(Boolean).join("/")}function ee(e,t,n){const i=kt({"@context":e.version===3?"http://iiif.io/api/image/3/context.json":"http://iiif.io/api/image/2/context.json",id:W(F(e)),profile:e.level===null||typeof e.level>"u"?"level0":`level${e.level}}`,type:e.version===3?"ImageService3":"ImageService2"});if(i.type!=="image")throw new Error("Invalid service");return i.size.max=!1,i.size.width=t,i.size.height=n,{id:Nt(i),type:"fixed",width:t,height:n||e.height/(e.width||1)*t,unsafe:e.width>t}}function _(e){const t=e.replace(/(https?:\/\/)?(www.)?/i,"");return t.indexOf("/")!==-1?t.split("/")[0]:t}function Et(e,t,n){const i=e.width?e.width:e.maxWidth;return n.height<=e.maxHeight&&n.width<=e.maxWidth&&n.height>=e.minHeight&&n.width>=e.minWidth&&(!t||Math.abs(n.width-i)<Math.abs(t.width-i))}function Ut(e,t){const n=[],i=Object.assign({unsafeImageService:!1,atAnyCost:!0,fallback:!0,minHeight:64,minWidth:64,maxHeight:1/0,maxWidth:1/0,returnAllOptions:!1,preferFixedSize:!1,allowUnsafe:!1,explain:!1,height:0,width:0},e),r=(f,p=0)=>i.explain?n.push(new Array(p).fill(0).map(h=>"    ").join("")+f().trim()):void 0,s=[],o=[];let a=null;r(()=>`Using configuration: ${JSON.stringify(i,null,2)}`);const c=(f,p)=>{if(r(()=>"Swapping choice",3),Et(i,p,f)){if(i.preferFixedSize&&f.unsafe){r(()=>`We found an image that was marked as unsafe, but it was the best size. (${f.id})`,4),o.push(f);return}i.returnAllOptions&&p&&o.push(p),r(()=>`We found a new image that was the best size. (${f.id})`,4),a=f}else i.returnAllOptions&&o.push(f)};r(()=>`The input shows we have ${t.length} list(s) of candidates to choose from.`);const u=t.length;for(let f=0;f<u;f++){const p=t[f]();r(()=>`Candidate group ${f}: ${JSON.stringify(p,null,2)}`,1);const h=p.length;r(()=>`Checking candidate list number ${f} and found ${h} potential ways of creating image(s)`,1);for(let g=0;g<h;g++){const l=p[g];if(r(()=>`-> Checking candidate ${g}`,1),l.type==="unknown"&&i.atAnyCost&&(r(()=>`We've found an unknown image type, adding this to the "last resort" list`,2),s.push(l)),l.type==="fixed"&&(l.unsafe?(r(()=>`We've found an unsafe fixed image type, adding this to the "last resort" list`,2),s.push(l)):(r(()=>"We've found a fixed size image, checking if it matches the request",2),c(l,a))),l.type==="fixed-service")if(i.unsafeImageService){r(()=>"Checking for an image from the tile source, without calculating the right height and width (unsafeImageService)",2);const m=ee(l,i.width,i.height);c(m,a)}else{r(()=>"Checking for an image from the tile source 3",2);const m=ee(l,l.width,l.height);c(m,a)}if(l.type==="variable"&&l.maxWidth){const m=ee({id:l.id,type:"fixed-service",width:l.maxWidth,height:l.maxWidth,level:l.level,version:l.version},l.maxWidth);c(m,a)}}if(a&&!i.returnAllOptions){if(a.unsafe||i.allowUnsafe)continue;r(()=>`We found a match in choice list number ${f}, no searching any more`);break}}return i.atAnyCost&&o.length===0?(r(()=>a?`We found an image! ${a.id} of type ${a.type}`:'We found no images, but "atAnyCost" is set, so returning that'),{best:a||s[0],fallback:s.slice(1),log:n}):i.returnAllOptions?(r(()=>"Returning all options that we have found"),{best:i.atAnyCost?a||o[0]||s[0]:a||o[0],fallback:[...o,...s],log:n}):(r(()=>"Returning the best image that we found, and a fallback"),{best:a||o[0]||null,fallback:a?o:o.slice(1),log:n})}var Dt=Object.defineProperty,Jt=Object.defineProperties,Xt=Object.getOwnPropertyDescriptors,Be=Object.getOwnPropertySymbols,Gt=Object.prototype.hasOwnProperty,Yt=Object.prototype.propertyIsEnumerable,Pe=(e,t,n)=>t in e?Dt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Zt=(e,t)=>{for(var n in t||(t={}))Gt.call(t,n)&&Pe(e,n,t[n]);if(Be)for(var n of Be(t))Yt.call(t,n)&&Pe(e,n,t[n]);return e},Kt=(e,t)=>Jt(e,Xt(t));function ei(e,t,n){const i=e>t?e:t,r=n.length,s=[];for(let o=0;o<r;o++){const a=n[o];let c=a.scaleFactors[0],u=i/c;const f=[c];for(;u>=a.width;)c=c*2,f.push(c),u=u/2;s.push(Kt(Zt({},a),{scaleFactors:f}))}return s}function ti(e,t){if(e.length!==t.length)return!1;if(e.length===0&&t.length===0)return!0;const n=e.length;let i=!0;for(let s=0;s<n;s++){const o=e[s],a=t[s];if(o.width!==a.width||o.height!==a.height){i=!1;break}}if(i)return!0;let r=0;for(let s=0;s<n;s++)for(let o=0;o<n;o++)if(e[s].width===t[o].width&&e[s].height===t[o].height){r++;break}return r===n}function qe(e){return X(0,e)}var q=(e,t,n)=>new Promise((i,r)=>{var s=c=>{try{a(n.next(c))}catch(u){r(u)}},o=c=>{try{a(n.throw(c))}catch(u){r(u)}},a=c=>c.done?i(c.value):Promise.resolve(c.value).then(s,o);a((n=n.apply(e,t)).next())});class He{constructor(){this.config={verificationsRequired:1,approximateServices:!0,enableFetching:!0,disableThrottling:!1},this.fetchingCount=0,this.imageServices={},this.knownImageServers={}}setConfig(t){Object.assign(this.config,t)}sample(t,n,i=!0){const r=_(F(t)),s=W(F(t)),o=this.knownImageServers[r];return this.imageServices[s]=Object.assign(t,{real:!0}),!o&&t.tiles&&!qe(t)?(this.knownImageServers[r]={verifications:0,malformed:!1,root:r,preLoaded:i,sampledId:F(t),verified:!1,server:null,result:{context:t["@context"]||[],sampledProfile:t.profile,resourceServiceRatio:n&&t.height?n.height/t.height:1,sampledSizes:t.sizes||[],sizeRatios:Rt(t.width,t.height,t.sizes||[]),sampledTiles:t.tiles||[]}},!0):this.verify(t)}preLoad(t,n=!0){this.knownImageServers[t.root]=t,n&&(this.knownImageServers[t.root].malformed=!1,this.knownImageServers[t.root].verifications=this.config.verificationsRequired)}predict(t,n=!1,i=!1){const r=t==null?void 0:t.source,s=_(F(t)),o=this.knownImageServers[s];if(!o||!o.result||!((r==null?void 0:r.height)||t.height)||!((r==null?void 0:r.width)||t.width)||!i&&(o.malformed||o.verifications<this.config.verificationsRequired)||qe(t.source))return null;const a=W(F(t));return this.imageServices[a]||(this.imageServices[a]={"@context":o.result.context,"@id":F(t),id:F(t),protocol:"http://iiif.io/api/image",tiles:(r==null?void 0:r.tiles)||ei(t.width,t.height,o.result.sampledTiles),sizes:(r==null?void 0:r.sizes)||jt(Math.round(t.width/o.result.resourceServiceRatio),Math.round(t.height/o.result.resourceServiceRatio),o.result.sizeRatios),profile:(r==null?void 0:r.profile)||o.result.sampledProfile,height:(r==null?void 0:r.height)||t.height,width:(r==null?void 0:r.width)||t.width,real:!1}),this.imageServices[a]}getThumbnailFromResource(t,n){return q(this,arguments,function*(i,r,s=!0,o=[]){const a=i?yield this.getImageCandidates(i,s):[];return Ut(r,[()=>o,()=>a])})}getImageCandidates(t,n=!0){return q(this,null,function*(){const i=t;if(n&&i.height&&i.width){const r=ze(i);for(const s of r){const o={id:F(s),width:s.width?s.width:i.width,height:s.height?s.height:i.height,source:s};yield this.loadService(o)}}return Wt(t,n,this)})}verify(t){return q(this,null,function*(){const n=this.predict(t,!1,!0),i=yield this.fetchService(F(t));if(!n)return!1;const r=n.height===i.height&&n.width===i.width&&n["@context"]===i["@context"]&&ti(n.sizes||[],i.sizes||[]);if(r){const s=_(F(t));this.knownImageServers[s].verifications+=1,this.knownImageServers[s].verifications>=this.config.verificationsRequired&&(this.knownImageServers[s].verified=!0)}return r})}canLoadSync(t){const n=typeof t=="string"?t:F(t),i=W(n);if(this.imageServices[i])return!0;const r=this.knownImageServers[_(n)];return r&&!r.malformed&&r.verifications>=this.config.verificationsRequired}markAsMalformed(t){return q(this,null,function*(){return this.knownImageServers[_(F(t))].malformed=!0,this.loadService(t,!0)})}fetchService(t,n=!1){return q(this,null,function*(){const i=W(t);if(this.imageServices[i]&&(!n||this.imageServices[i].real))return this.imageServices[i];if(!this.config.enableFetching)throw new Error("Fetching is not enabled");const r=yield this.fetch(i).then(s=>s.json());return!r.id&&r["@id"]&&(r.id=r["@id"]),r.id!==t&&(r.id=t,r["@id"]&&(r["@id"]=t)),this.imageServices[i]=Object.assign(r,{real:!0}),this.imageServices[i]})}fetch(t,n){return q(this,null,function*(){return fetch(t,n)})}loadService(t,n=!1){return q(this,null,function*(){if(!this.config.disableThrottling){let s=!0;for(;s;)if(this.fetchingCount>=this.config.verificationsRequired)yield new Promise(o=>setTimeout(o,500));else{s=!1;break}}const i=this.knownImageServers[_(F(t))];if(i&&!i.malformed&&!n){yield i.result;const s=this.loadServiceSync(t);if(s)return s}this.fetchingCount++;const r=yield this.fetchService(F(t),n);return this.fetchingCount--,r.real&&this.sample(r,t),r})}loadServiceSync(t){const n=W(F(t));return this.imageServices[n]?this.imageServices[n]:this.predict(t)}}new He;function ii(e=I,t={}){const n=t.imageServiceLoader||new He;async function i(r,s,o,a=[],c){const u=()=>n.getThumbnailFromResource(void 0,s,o,a);if(!r)return await n.getThumbnailFromResource(void 0,s,o,a);if(typeof r=="string"){const h=K(r);return h&&a.push(h),await n.getThumbnailFromResource(void 0,s,o,a)}const f=e.get(r,{skipSelfReturn:!1});if(typeof f=="string")return{best:K(f),fallback:[],log:[]};if(!f)return await u();switch(await(async h=>{if(h&&h.thumbnail&&h.thumbnail.length){const g=e.get(h.thumbnail[0]),l=await n.getImageCandidates(g,o);l&&l.length&&a.push(...l)}})(f),f.type){case"Annotation":{const h=Array.isArray(f.body)?f.body:[f.body],g=e.get(h[0]);return c&&!g.width&&(g.width=c.width,g.height=c.height),await n.getThumbnailFromResource(g,s,o,a)}case"Canvas":{const h=f;return i(h.items[0],s,o,a,{width:h.width,height:h.height})}case"AnnotationPage":return i(f.items[0],s,o,a,c);case"Choice":{const h=f;return!h.items||h.items[0]?await u():i(h.items[0],s,o,a,c)}case"Collection":{const g=f.items[0];return g?i(g,s,o,a,c):await u()}case"Manifest":{const g=f.items[0];return g?i(g,s,o,a,c):await u()}case"SpecificResource":case"Image":case"Dataset":case"Sound":case"Text":case"TextualBody":case"Video":return c&&!f.width&&(f.width=c.width,f.height=c.height),n.getThumbnailFromResource(f,s,o,a);case"Service":case"Range":case"AnnotationCollection":case"CanvasReference":case"ContentResource":return await u()}return await u()}return{getBestThumbnailAtSize:i}}function Le(e,t,n=[],i=!1){if(!e||!t||t.length===0)return;if(t.length===1)return t[0];if(t.indexOf(e)!==-1)return e;const r=e.indexOf("-")!==-1?e.slice(0,e.indexOf("-")):null;if(r&&t.indexOf(r)!==-1)return r;for(const s of n)if(t.indexOf(s)!==-1)return s;if(!i){const o=t.map(a=>a.indexOf("-")!==-1?a.slice(0,a.indexOf("-")):null).indexOf(e);if(o!==-1)return t[o];for(const a of n){const c=a.indexOf("-")!==-1?a.slice(0,a.indexOf("-")):null,u=c?t.indexOf(c):-1;if(u!==-1)return t[u]}}return t.indexOf("none")!==-1?"none":t.indexOf("@none")!==-1?"@none":t[0]}function _e(e,t,n={}){const{strictFallback:i=!1,defaultText:r="",separator:s=`
`,fallbackLanguages:o=[],closest:a}=n,c=Object.keys(e||{}),u=a?t:Le(t,c,o,i);if(!e)return r;if(typeof e=="string")return e;const f=u?e[u]:void 0;return f?typeof f=="string"?f:f.join(s):""}function ni(e,t={}){return _e(e,typeof navigator!="undefined"?navigator.language:void 0,t)}var ri=function(){function e(t,n){var i=[],r=!0,s=!1,o=void 0;try{for(var a=t[Symbol.iterator](),c;!(r=(c=a.next()).done)&&(i.push(c.value),!(n&&i.length===n));r=!0);}catch(u){s=!0,o=u}finally{try{!r&&a.return&&a.return()}finally{if(s)throw o}}return i}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),E=Math.PI*2,te=function(t,n,i,r,s,o,a){var c=t.x,u=t.y;c*=n,u*=i;var f=r*c-s*u,p=s*c+r*u;return{x:f+o,y:p+a}},si=function(t,n){var i=n===1.5707963267948966?.551915024494:n===-1.5707963267948966?-.551915024494:1.3333333333333333*Math.tan(n/4),r=Math.cos(t),s=Math.sin(t),o=Math.cos(t+n),a=Math.sin(t+n);return[{x:r-s*i,y:s+r*i},{x:o+a*i,y:a-o*i},{x:o,y:a}]},Qe=function(t,n,i,r){var s=t*r-n*i<0?-1:1,o=t*i+n*r;return o>1&&(o=1),o<-1&&(o=-1),s*Math.acos(o)},oi=function(t,n,i,r,s,o,a,c,u,f,p,h){var g=Math.pow(s,2),l=Math.pow(o,2),m=Math.pow(p,2),v=Math.pow(h,2),b=g*l-g*v-l*m;b<0&&(b=0),b/=g*v+l*m,b=Math.sqrt(b)*(a===c?-1:1);var d=b*s/o*h,y=b*-o/s*p,w=f*d-u*y+(t+i)/2,S=u*d+f*y+(n+r)/2,A=(p-d)/s,C=(h-y)/o,O=(-p-d)/s,R=(-h-y)/o,L=Qe(1,0,A,C),j=Qe(A,C,O,R);return c===0&&j>0&&(j-=E),c===1&&j<0&&(j+=E),[w,S,L,j]},ai=function(t){var n=t.px,i=t.py,r=t.cx,s=t.cy,o=t.rx,a=t.ry,c=t.xAxisRotation,u=c===void 0?0:c,f=t.largeArcFlag,p=f===void 0?0:f,h=t.sweepFlag,g=h===void 0?0:h,l=[];if(o===0||a===0)return[];var m=Math.sin(u*E/360),v=Math.cos(u*E/360),b=v*(n-r)/2+m*(i-s)/2,d=-m*(n-r)/2+v*(i-s)/2;if(b===0&&d===0)return[];o=Math.abs(o),a=Math.abs(a);var y=Math.pow(b,2)/Math.pow(o,2)+Math.pow(d,2)/Math.pow(a,2);y>1&&(o*=Math.sqrt(y),a*=Math.sqrt(y));var w=oi(n,i,r,s,o,a,p,g,m,v,b,d),S=ri(w,4),A=S[0],C=S[1],O=S[2],R=S[3],L=Math.abs(R)/(E/4);Math.abs(1-L)<1e-7&&(L=1);var j=Math.max(Math.ceil(L),1);R/=j;for(var tt=0;tt<j;tt++)l.push(si(O,R)),O+=R;return l.map(function(ae){var it=te(ae[0],o,a,v,m,A,C),Ti=it.x,zi=it.y,nt=te(ae[1],o,a,v,m,A,C),$i=nt.x,Wi=nt.y,rt=te(ae[2],o,a,v,m,A,C),Bi=rt.x,Pi=rt.y;return{x1:Ti,y1:zi,x2:$i,y2:Wi,x:Bi,y:Pi}})},ci=fi,ie={a:7,c:6,h:1,l:2,m:2,q:4,s:4,t:2,v:1,z:0},li=/([astvzqmhlc])([^astvzqmhlc]*)/ig;function fi(e){var t=[];return e.replace(li,function(n,i,r){var s=i.toLowerCase();for(r=hi(r),s=="m"&&r.length>2&&(t.push([i].concat(r.splice(0,2))),s="l",i=i=="m"?"l":"L");;){if(r.length==ie[s])return r.unshift(i),t.push(r);if(r.length<ie[s])throw new Error("malformed path data");t.push([i].concat(r.splice(0,ie[s])))}}),t}var ui=/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/ig;function hi(e){var t=e.match(ui);return t?t.map(Number):[]}var pi=di;function di(e){var t=0,n=0,i=0,r=0;return e.map(function(s){s=s.slice();var o=s[0],a=o.toUpperCase();if(o!=a)switch(s[0]=a,o){case"a":s[6]+=i,s[7]+=r;break;case"v":s[1]+=r;break;case"h":s[1]+=i;break;default:for(var c=1;c<s.length;)s[c++]+=i,s[c++]+=r}switch(a){case"Z":i=t,r=n;break;case"H":i=s[1];break;case"V":r=s[1];break;case"M":i=t=s[1],r=n=s[2];break;default:i=s[s.length-2],r=s[s.length-1]}return s})}function gi(e){const t=ci(e),n=pi(t);let i,r=0,s=0,o=0,a=0,c,u,f=0,p=0;const h=[];for(let g=0;g<n.length;g++){let l=n[g];const m=l[0];switch(m){case"M":r=l[1],s=l[2];break;case"H":l=["L",l[1],s];break;case"V":l=["L",r,l[1]];break;case"S":{let v=f,b=p;(i==="C"||i=="S")&&(v+=v-o,b+=b-a),l=["C",v,b,l[1],l[2],l[3],l[4]]}break;case"T":i==="Q"||i=="T"?(c=f*2-c,u=p*2-u):(c=f,u=p),l=["Q",c,u,l[1],l[2]];break;case"Q":c=l[1],u=l[2];break;case"A":{const v=ai({px:f,py:p,cx:l[6],cy:l[7],rx:l[1],ry:l[2],xAxisRotation:l[3],largeArcFlag:l[4],sweepFlag:l[5]});if(!v.length)continue;for(const[b,d]of v.entries())l=["C",d.x1,d.y1,d.x2,d.y2,d.x,d.y],b<v.length-1&&h.push(l);l=l}break;case"Z":l=["L",r,s];break}i=m,f=l[l.length-2],p=l[l.length-1],["C","Q","A"].indexOf(m)>-1?(o=l[l.length-4],a=l[l.length-3]):(o=f,a=p),h.push(l)}return h}/** Code to "flatten" quadratic and cubic Bézier curves to polylines.
 *
 * All code in this module is based on JavaScript code by Raph Levien, published on his blog at
 * https://raphlinus.github.io/.
 * I merely changed the structure a bit, removed some unneeded parts and added some comments and type hints.
 *
 * Flattening of quadratic Bézier curves:
 * - Article: https://raphlinus.github.io/graphics/curves/2019/12/23/flatten-quadbez.html
 * - Code: https://github.com/raphlinus/raphlinus.github.io/blob/master/_posts/2019-12-23-flatten-quadbez.md?plain=1#L73-L212
 *
 * Flattening of cubic Bézier curves: https://levien.com/tmp/flatten.html
 *
 * Note that the code in this module has a different license than the rest of the package,
 * due to the inclusion of Apache-licensed third party code.
 *
 * @license
 * Copyright 2022 Johannes Baiter <johannes.baiter@gmail.com>
 * Copyright 2019, 2022 Raph Levien <raph.levien@gmail.com>
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function yi(e,t,n,i=1){return new Ve(e,t,n).subdivide(i)}function mi(e,t,n,i,r=1){return new ne(new Float64Array([e.x,e.y,t.x,t.y,n.x,n.y,i.x,i.y])).subdivide(r)}function vi(e){return e.x*e.x+e.y*e.y}function U(e){return e/(1-.67+Math.pow(Math.pow(.67,4)+.25*e*e,.25))}function Q(e){return e*(1-.39+Math.sqrt(.39*.39+.25*e*e))}class Ve{constructor(t,n,i){this.start=t,this.control=n,this.end=i}eval(t){const n=1-t;return{x:this.start.x*n*n+2*this.control.x*n*t+this.end.x*t*t,y:this.start.y*n*n+2*this.control.y*n*t+this.end.y*t*t}}mapToBasic(){const{x:t,y:n}=this.start,{x:i,y:r}=this.control,{x:s,y:o}=this.end,a=2*i-t-s,c=2*r-n-o,u=(i-t)*a+(r-n)*c,f=(s-i)*a+(o-r)*c,p=(s-t)*c-(o-n)*a,h=u/p,g=f/p,l=Math.abs(p)/(Math.hypot(a,c)*Math.abs(g-h));return{x0:t,x2:s,scale:l,cross:p}}subdivide(t){const n=this.mapToBasic(),i=U(n.x0),r=U(n.x2),s=.5*Math.abs(r-i)*Math.sqrt(n.scale/t),o=Math.ceil(s),a=Q(i),c=Q(r),u=[0];for(let f=1;f<o;f++){const h=(Q(i+(r-i)*f/o)-a)/(c-a);u.push(h)}return u.push(1),u.map(f=>this.eval(f))}}class ne{constructor(t){this.c=t}weightsum(t,n,i,r){const s=t*this.c[0]+n*this.c[2]+i*this.c[4]+r*this.c[6],o=t*this.c[1]+n*this.c[3]+i*this.c[5]+r*this.c[7];return{x:s,y:o}}eval(t){const n=1-t,i=n*n*n,r=3*n*n*t,s=3*n*t*t,o=t*t*t;return this.weightsum(i,r,s,o)}deriv(t){const n=1-t,i=-3*n*n,r=3*t*t,s=-6*t*n-i,o=6*t*n-r;return this.weightsum(i,s,o,r)}midpoint_quadbez(){const t=this.weightsum(-.25,.75,.75,-.25);return new Ve({x:this.c[0],y:this.c[1]},t,{x:this.c[6],y:this.c[7]})}subsegment(t,n){const i=new Float64Array(8),r=this.eval(t),s=this.eval(n);i[0]=r.x,i[1]=r.y;const o=(n-t)/3,a=this.deriv(t);i[2]=r.x+o*a.x,i[3]=r.y+o*a.y;const c=this.deriv(n);return i[4]=s.x-o*c.x,i[5]=s.y-o*c.y,i[6]=s.x,i[7]=s.y,new ne(i)}subdivide(t){const n=.1*t,i=t-n,r=Math.sqrt(i),s=vi(this.weightsum(1,-3,3,-1)),o=Math.ceil(Math.pow(s/(432*n*n),1/6)),a=[];let c=0;for(let l=0;l<o;l++){const m=l/o,v=(l+1)/o,b=this.subsegment(m,v).midpoint_quadbez(),d=b.mapToBasic(),y=U(d.x0),w=U(d.x2),S=Math.sqrt(d.scale);let A=Math.abs(w-y)*S;if(Math.sign(d.x0)!=Math.sign(d.x2)){const C=r/S,O=r*Math.abs(w-y)/U(C);A=Math.max(A,O)}a.push({quad:b,a0:y,a2:w,val:A}),c+=A}const u=.5*c/r,f=Math.ceil(u),p=[{x:this.c[0],y:this.c[1]}];let h=0,g=0;for(let l=1;l<f;l++){const m=c*l/f;for(;h+a[g].val<m;)h+=a[g].val,g++;const v=a[g].a0,b=a[g].a2,d=Q(v),y=Q(b),w=v+(b-v)*(m-h)/a[g].val,A=(Q(w)-d)/(y-d);p.push(a[g].quad.eval(A))}return p.push({x:this.c[6],y:this.c[7]}),p}}const xi=/&?(xywh=)?(pixel:|percent:|pct:)?([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?),([0-9]+(?:\.[0-9]+)?)/,bi=/&?(t=)(npt:)?([0-9]+(.[0-9]+)?)?(,([0-9]+(.[0-9]+)?))?/,Ne=/^rgba\((\d+),(\d+),(\d+),([0-9.]+)\)$/;function D(e,{domParser:t,svgPreprocessor:n,iiifRenderingHints:i}={}){var r,s;if(Array.isArray(e))return k(e.reduce((o,a)=>{const{selector:c,selectors:u,iiifRenderingHints:f}=D(a,{domParser:t,svgPreprocessor:n,iiifRenderingHints:i});return c&&(o.selector||(o.selector=c),o.selectors.push(...u)),f&&(o.iiifRenderingHints=o.iiifRenderingHints||{type:"ImageApiSelector"},Object.assign(o.iiifRenderingHints,f)),o},{selector:null,selectors:[],iiifRenderingHints:i}));if(!e)return k({selector:null,selectors:[],iiifRenderingHints:i});if(typeof e=="string"){const[o,a]=e.split("#");return a?D({type:"FragmentSelector",value:a},{svgPreprocessor:n,iiifRenderingHints:i,domParser:t}):k({selector:null,selectors:[],iiifRenderingHints:i})}if(e.type&&e.type==="PointSelector"&&(e.t||e.t===0)){const o={type:"TemporalSelector",temporal:{startTime:e.t}};return k({selector:o,selectors:[o],iiifRenderingHints:i})}if(Ue(e)){const o=[];if(e.region){const a=D({type:"FragmentSelector",value:"xywh="+e.region},{domParser:t,svgPreprocessor:n,iiifRenderingHints:i});o.push(...a.selectors)}return k({selector:o[0],selectors:o,iiifRenderingHints:i?{...i,...e}:e})}if(e.type==="FragmentSelector"){const o=xi.exec(e.value);if(o){const c={type:"BoxSelector",spatial:{unit:o[2]==="percent:"||o[2]==="pct:"?"percent":"pixel",x:parseFloat(o[3]),y:parseFloat(o[4]),width:parseFloat(o[5]),height:parseFloat(o[6])}};return k({selector:c,selectors:[c],iiifRenderingHints:i})}const a=e.value.match(bi);if(a){const c={type:"TemporalSelector",temporal:{startTime:a[4]?parseFloat(a[4]):0,endTime:a[7]?parseFloat(a[7]):void 0}};return k({selector:c,selectors:[c],iiifRenderingHints:i})}return k({selector:null,selectors:[],iiifRenderingHints:i})}if(e.type==="SvgSelector"&&"value"in e){t||(typeof window!="undefined"?t=new window.DOMParser:console.warn("No DOMParser available, cannot parse SVG selector, `points`, `spatial` and `style` will be unavailable and the SVG will not be normalized."));let o=[],a,c,u=(r=n==null?void 0:n(e.value))!=null?r:e.value,f;if(t){const h=t.parseFromString(e.value,"image/svg+xml").querySelector("svg");if(!h)return console.warn(`Illegal SVG selector: ${e.value}`),k({selector:null,selectors:[],iiifRenderingHints:i});const g=Ee(h);g&&(o=g.points,f=g.shapeType,a=[Math.min(...o.map(l=>l[0])),Math.min(...o.map(l=>l[1])),Math.max(...o.map(l=>l[0])),Math.max(...o.map(l=>l[1]))],{style:c,svg:u}=(s=Ai(g.element))!=null?s:{svg:u})}const p={type:"SvgSelector",svg:u,svgShape:f,style:c,points:o.length?o:void 0,spatial:a?{unit:"pixel",x:a[0],y:a[1],width:a[2]-a[0],height:a[3]-a[1]}:void 0};return k({selector:p,selectors:[p],iiifRenderingHints:i})}return k({selector:null,selectors:[],iiifRenderingHints:i})}function wi(e){const t=e.map(i=>i[0]).reduce((i,r)=>(i[r]+=1,i),{C:0,Q:0,L:0,M:0}),n=new Set(e.map(i=>i[0]));if(t.C>0||t.Q>0)return"path";if(t.L>0&&(n.size===1||n.size===2&&n.has("M"))){if(t.L===4)return"rect";const i=e.slice(-1)[0];return e[0][0]==="M"&&i[0]==="L"&&i[1]==e[0][1]&&i[2]===e[0][2]||i[1]===0&&i[2]===0?"polygon":"polyline"}return"path"}function Ee(e){var t,n,i,r,s,o,a,c,u,f,p,h,g,l,m,v,b;for(const d of Array.from(e.children))switch(d==null?void 0:d.tagName.toLowerCase()){case"g":{const y=Ee(d);if(y)return y}continue;case"path":{const y=d.getAttribute("d");if(!y)continue;const w=gi(y);return{element:d,points:Si(w),shapeType:wi(w)}}case"circle":{const y=parseFloat((t=d.getAttribute("cx"))!=null?t:"0"),w=parseFloat((n=d.getAttribute("cy"))!=null?n:"0"),S=parseFloat((i=d.getAttribute("r"))!=null?i:"0");if(!S)continue;const A=[];for(let C=0;C<=360;C+=12){const O=C*Math.PI/180;A.push([y+S*Math.cos(O),w+S*Math.sin(O)])}return{element:d,points:A,shapeType:"circle"}}case"ellipse":{const y=parseFloat((r=d.getAttribute("cx"))!=null?r:"0"),w=parseFloat((s=d.getAttribute("cy"))!=null?s:"0"),S=parseFloat((o=d.getAttribute("rx"))!=null?o:"0"),A=parseFloat((a=d.getAttribute("ry"))!=null?a:"0");if(!S&&!A)continue;const C=[];for(let O=0;O<=360;O+=12){const R=Math.tan(O/360*Math.PI),L=S*(1-R**2)/(1+R**2),j=A*2*R/(1+R**2);C.push([y+L,w+j])}return{element:d,points:C,shapeType:"ellipse"}}case"line":{const y=parseFloat((c=d.getAttribute("x0"))!=null?c:"0"),w=parseFloat((u=d.getAttribute("y0"))!=null?u:"0"),S=parseFloat((f=d.getAttribute("x1"))!=null?f:"0"),A=parseFloat((p=d.getAttribute("y1"))!=null?p:"0");if(y===S&&w===A)continue;return{element:d,points:[[y,w],[S,A]],shapeType:"polyline"}}case"polygon":case"polyline":{const y=(g=(h=d.getAttribute("points"))==null?void 0:h.split(" ").map(S=>S.split(",").map(parseFloat)))!=null?g:[];if(!y.length)continue;let w="polyline";return d.tagName.toLowerCase()==="polygon"&&(y.push(y[0]),w="polygon"),{element:d,points:y,shapeType:w}}case"rect":{const y=parseFloat((l=d.getAttribute("x"))!=null?l:"0"),w=parseFloat((m=d.getAttribute("y"))!=null?m:"0"),S=parseFloat((v=d.getAttribute("width"))!=null?v:"0"),A=parseFloat((b=d.getAttribute("height"))!=null?b:"0");if(!S||!A)continue;return{element:d,points:[[y,w],[y+S,w],[y+S,w+A],[y,w+A],[y,w]],shapeType:"rect"}}default:continue}return null}function Si(e){var n;const t=[];for(let i=0;i<e.length;i++){const r=(n=t[t.length-1])!=null?n:[0,0],s=e[i];switch(s[0]){case"M":case"L":t.push([s[1],s[2]]);continue;case"C":t.push(...mi({x:r[0],y:r[1]},{x:s[1],y:s[2]},{x:s[3],y:s[4]},{x:s[5],y:s[6]}).map(o=>[o.x,o.y]).slice(1));continue;case"Q":t.push(...yi({x:r[0],y:r[1]},{x:s[1],y:s[2]},{x:s[3],y:s[4]}).map(o=>[o.x,o.y]).slice(1));continue}}return t}function Ai(e){const t={};if(e.hasAttribute("fill")?(t.fill=e.getAttribute("fill"),e.removeAttribute("fill")):e.style.fill&&(t.fill=e.style.fill),t.fill){const i=Ne.exec(t.fill);i&&(t.fillOpacity=parseFloat(i[4]),t.fill=`rgb(${i[1]}, ${i[2]}, ${i[3]})`)}if(e.hasAttribute("fill-opacity")?(t.fillOpacity=parseFloat(e.getAttribute("fill-opacity")),e.removeAttribute("fill-opacity")):e.style.fillOpacity&&(t.fillOpacity=parseFloat(e.style.fillOpacity)),e.hasAttribute("stroke")?(t.stroke=e.getAttribute("stroke"),e.removeAttribute("stroke")):e.style.stroke&&(t.stroke=e.style.stroke),t.stroke){const i=Ne.exec(t.stroke);i&&(t.strokeOpacity=parseFloat(i[4]),t.stroke=`rgb(${i[1]}, ${i[2]}, ${i[3]})`)}e.hasAttribute("stroke-opacity")?(t.strokeOpacity=parseFloat(e.getAttribute("stroke-opacity")),e.removeAttribute("stroke-opacity")):e.style.strokeOpacity&&(t.strokeOpacity=parseFloat(e.style.strokeOpacity)),e.hasAttribute("stroke-width")?(t.strokeWidth=e.getAttribute("stroke-width"),e.removeAttribute("stroke-width")):e.style.strokeWidth&&(t.strokeWidth=e.style.strokeWidth),e.hasAttribute("stroke-dasharray")?(t.strokeDasharray=e.getAttribute("stroke-dasharray"),e.removeAttribute("stroke-dasharray")):e.style.strokeDasharray&&(t.strokeDasharray=e.style.strokeDasharray);let n=e;for(;n.tagName.toLowerCase()!=="svg";)if(n=n.parentElement,n===null)throw new Error("Could not find root SVG element");return{svg:n.outerHTML,style:Object.keys(t).length>0?t:void 0}}function Ue(e){return!!e&&e.type==="iiif:ImageApiSelector"&&e.type==="iiif:ImageApiSelector"}function k(e){if(e.iiifRenderingHints){const t=e.iiifRenderingHints;if(t.rotation){const n=De(t.rotation);if(n)if(e.selectors.length)for(const i of e.selectors)i.rotation=n;else e.selectors.push({type:"RotationSelector",rotation:n})}}else delete e.iiifRenderingHints;return e}function De(e){let t=parseFloat(e);return t&&e.startsWith("!")&&(t=360-t),t&&(t=t%360),t!==t?0:t||0}function z(e,t={}){if(Array.isArray(e))return z(e[0]);if(typeof e=="string"){const[n,i]=e.split("#");return i?z({type:"SpecificResource",source:{id:n,type:"Unknown"},selector:{type:"FragmentSelector",value:i}}):{type:"SpecificResource",source:{id:n,type:t.typeMap&&t.typeMap[n]||"Unknown"},selector:null,selectors:[]}}if(e.type==="Choice"||e.type==="List"||e.type==="Composite"||e.type==="Independents")return z(e.items[0]);if(e.type==="SpecificResource"){e.source.type==="Canvas"&&e.source.partOf&&typeof e.source.partOf=="string"&&(e.source.partOf=[{id:e.source.partOf,type:"Manifest"}]);const{selector:n,selectors:i}=e.selector?D(e.selector,t):{selector:null,selectors:[]};return{type:"SpecificResource",source:e.source,selector:n,selectors:i}}if(e.id){e.type==="Canvas"&&e.partOf&&typeof e.partOf=="string"&&(e.partOf=[{id:e.partOf,type:"Manifest"}]);const[n,i]=e.id.split("#");return i?z({type:"SpecificResource",source:{...e,id:n},selector:{type:"FragmentSelector",value:i}}):{type:"SpecificResource",source:{...e,id:n},selector:null,selectors:[]}}return{type:"SpecificResource",source:e,selector:null,selectors:[]}}function re(e,t=!1){if(typeof e=="string"){if(e.startsWith("{"))try{const n=JSON.parse(e);return re(n)}catch{return[!1,{reason:"Invalid JSON"}]}return[!0]}if(Array.isArray(e)){for(const n of e){const[i,r]=re(n);if(!i&&r)return[i,r]}return[!0]}return e.type==="Annotation"?[!0]:t&&e.type==="Canvas"&&!e.partOf?[!1,{reason:"Canvas without partOf cannot be loaded"}]:[!0]}function Fi(e){return Xe(typeof e=="string"?e:JSON.stringify(e))}function Je(e,t){if(e=e.trim(),e[0]==="{")return t?Promise.resolve(JSON.parse(e)):JSON.parse(e);if(e.startsWith("http")){if(!t)throw new Error("Cannot fetch remote fetch with async=false in parseContentState");return fetch(e).then(n=>n.json())}return Je(Ge(e),t)}function Xe(e){const t=encodeURIComponent(e);return(typeof btoa=="undefined"?Buffer.from(t,"utf-8").toString("base64"):btoa(t)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function Ge(e){const n=Mi(e).replace(/-/g,"+").replace(/_/g,"/"),i=typeof atob=="undefined"?Buffer.from(n,"base64").toString("utf-8"):atob(n);return decodeURIComponent(i).trim()}function Mi(e){const t=e.length%4;if(t===1)throw new Error("InvalidLengthError: Input base64url string is the wrong length to determine padding");return e+(t?"====".slice(0,4-t):"")}function Ci(e){if(!e)throw new Error("Content state is empty");Array.isArray(e)||(e=[e]);let t="vault://virtual-annotation/"+new Date().getTime();const n=[];for(const i of e){if(typeof i=="string")throw new Error("Content state is a [String] type and cannot be inferred");if(i.type==="Annotation"){if(t=i.id,Array.isArray(i.motivation))for(const s of i.motivation);if(Array.isArray(i.target))for(const s of i.target){const o=z(s);n.push(o)}else{const s=z(i.target);n.push(s)}continue}const r=z(i);n.push(r)}return{id:t,type:"Annotation",motivation:["contentState",...e.motivation||[]],target:n,extensions:{}}}function Ye(e){return e.type==="SpecificResource"?[e.source,{selector:e.selector}]:[e,{selector:null}]}function Oi(e=I){function t(r){const s=r?typeof r=="string"?e.get(r):r:null;if(!s)return[];const o=e.get(s.items),a=[];for(const c of o)a.push(...e.get(c.items));return a}function n(r,s=[]){const o=Array.isArray(r)?r:t(r),a=[];let c=null;const u=[];for(const f of o){if(f.type!=="Annotation")throw new Error("getPaintables() accept either a canvas or list of annotations");const p=e.get(f.body),h=Array.isArray(p)?p:[p];for(const g of h){const[l,{selector:m}]=Ye(g),v=(l.type||"unknown").toLowerCase();if(v==="choice"){const b=e.get(l.items),d=s.length?s.map(y=>b.find(w=>w.id===y)).filter(Boolean):[b[0]];d.length===0&&d.push(b[0]),c={type:"single-choice",items:b.map(y=>({id:y.id,label:y.label,selected:d.indexOf(y)!==-1})),label:g.label},h.push(...d);continue}a.indexOf(v)===-1&&a.push(v),u.push({type:v,resource:l,target:f.target,selector:m})}}return{types:a,items:u,choice:c}}function i(r){const{choice:s}=n(r);return s}return{getAllPaintingAnnotations:t,getPaintables:n,extractChoices:i}}function M(e,t,n){t[N]=t[N]||[],t[N].push(e),Object.defineProperty(t,e,{get(){if(typeof t[H][e]=="undefined")return;const i=t[H][e];return i&&$(n.get(t[H][e]),n)},set(i){t[H][e]!==i&&(this[H][e]=i)}})}const H=Symbol.for("_refs_"),V=Symbol.for("_reactive_"),N=Symbol.for("_defined_");function ki(e,t=!1){const n={id:null,[N]:[],[H]:{},[V]:null,is(i){return typeof i=="string"?this.id===i:i.id?i.id===this.id:!1},reactive(){if(!this[V])return this[V]=this.subscribe(()=>this.refresh(),!0),()=>{this.unreactive()}},refresh(){if(this.id){const i=this.unwrap();for(const r of Object.keys(i||{}))this[N].includes(r)?this[H][r]=i[r]:this[r]=i[r]}},unreactive(){this[V]&&(this[V](),this[V]=null)},unwrap(){if(!this.id)throw new Error("Invalid object");return e.get(this.id)},toPresentation3(){return e.toPresentation3(this.unwrap())},toPresentation2(){return e.toPresentation2(this.unwrap())},toJSON(){const i=this;return{...i,items:i.items,annotations:i.annotations,structures:i.structures,seeAlso:i.seeAlso,service:i.service,services:i.services,rendering:i.rendering,partOf:i.partOf,start:i.start,supplementary:i.supplementary,homepage:i.homepage,thumbnail:i.thumbnail,placeholderCanvas:i.placeholderCanvas,accompanyingCanvas:i.accompanyingCanvas,provider:i.provider}},subscribe(i,r=!0){return e.subscribe(()=>this.id?e.get(this.id):null,i,r)}};return M("items",n,e),M("annotations",n,e),M("structures",n,e),M("seeAlso",n,e),M("service",n,e),M("services",n,e),M("rendering",n,e),M("partOf",n,e),M("start",n,e),M("supplementary",n,e),M("homepage",n,e),M("thumbnail",n,e),M("placeholderCanvas",n,e),M("accompanyingCanvas",n,e),M("provider",n,e),M("body",n,e),M("logo",n,e),n}function Ze(e){return Array.isArray(e)?e.map(t=>Ze(t)):!e||!e.type?e:{id:e.id,type:e.type}}function $(e,t,n=!1){if(Array.isArray(e))return e.map(o=>$(o,t,n));if(!e||!e.type||!e.id)return e;const i=ki(t,n),r=Object.create(i),s=Object.assign(r,e);return n&&s.reactive(),s}function Ri(e){return{get(t,n=!1){return $(e.get(t),e,n)},async load(t,n){return $(await e.load(t,n),e)},async loadManifest(t,n){return $(await e.loadManifest(t,n),e)},async loadCollection(t,n){return $(await e.loadCollection(t,n),e)},wrapObject(t){return $(e.get(t,{skipSelfReturn:!1}),e)},isWrapped(t){return!!t[N]}}}function ji(e=I){return{findFirstCanvasFromRange:t=>se(e,t),findAllCanvasesInRange:t=>G(e,t),findManifestSelectedRange:(t,n)=>Ke(e,t,n),findSelectedRange:(t,n)=>Y(e,t,n)}}function se(e,t){for(const n of t.items){if(n.type==="Canvas")return n;if(n.type==="Range"){const i=se(e,e.get(n));if(i)return i}}return null}function G(e,t){const n=[];for(const i of t.items)if(i.type==="Canvas"&&(i.id.indexOf("#")!==-1?n.push({id:i.id.split("#")[0],type:"Canvas"}):n.push(i)),i.type==="Range"&&n.push(...G(e,e.get(i))),i.type==="SpecificResource"){const r=typeof i.source=="string"?i.source:i.source.id;n.push({id:r,type:"Canvas"})}return n}function Ke(e,t,n){for(const i of t.structures){const r=Y(e,e.get(i),n);if(r)return r}return null}function Y(e,t,n){var i;for(const r of t.items){const s=(i=r.id)==null?void 0:i.split("#")[0];if(r.type==="SpecificResource"&&r.source===n||r.type==="Canvas"&&n===s)return t;if(r.type==="Range"){const o=Y(e,e.get(r),n);if(o)return o}}return null}function Ii(e=I){return{getVisibleCanvasesFromCanvasId:(t,n,i=!1)=>et(e,t,n,i),getManifestSequence:(t,n={})=>oe(e,t,n)}}function et(e=I,t,n,i=!1){const r=t.behavior||[],s=n?e.get(n):null;if(!s)return[];const o=s.behavior||[],a=i?!1:r.includes("paged"),c=a?!1:r.includes("continuous"),u=a||c?!1:r.includes("individuals"),f=o.includes("facing-pages"),p=o.includes("non-paged");if(f||p||u||i)return[{id:s.id,type:"Canvas"}];const[h,g]=oe(e,t);if(c)return h;const l=h.findIndex(m=>m.id===n);if(l===-1)return[];for(const m of g)if(m.includes(l))return m.map(v=>h[v]);return[{id:s.id,type:"Canvas"}]}function oe(e=I,t,{disablePaging:n,skipNonPaged:i}={}){const r=t.behavior||[],s=r.includes("paged"),o=s?!1:r.includes("continuous"),a=s||o?!1:r.includes("individuals"),c=t.type==="Manifest"?t.items:G(e,t);if(o)return[c,[c.map((l,m)=>m)]];if(a||!s||n)return[c,c.map((l,m)=>[m])];const u=[];let f=[];const p=()=>{f.length&&(u.push([...f]),f=[])};let h=0,g=!1;for(let l=0;l<c.length;l++){const v=e.get(c[l]).behavior||[];if(v.includes("non-paged")){l===h&&h++,i||(p(),u.push([l]),p());continue}if(l===h||v.includes("facing-pages")){f.length&&(g=!0),p(),u.push([l]),p();continue}if(f.push(l),g){p(),g=!1;continue}f.length>1&&p()}return f.length&&p(),[c,u]}x.buildLocaleString=_e,x.createEventsHelper=st,x.createObjectsHelper=Ri,x.createPaintingAnnotationsHelper=Oi,x.createRangeHelper=ji,x.createSequenceHelper=Ii,x.createStylesHelper=ot,x.createThumbnailHelper=ii,x.decodeContentState=Ge,x.encodeContentState=Xe,x.expandTarget=z,x.findAllCanvasesInRange=G,x.findFirstCanvasFromRange=se,x.findManifestSelectedRange=Ke,x.findSelectedRange=Y,x.getClosestLanguage=Le,x.getManifestSequence=oe,x.getValue=ni,x.getVisibleCanvasesFromCanvasId=et,x.isImageApiSelector=Ue,x.normaliseContentState=Ci,x.parseContentState=Je,x.parseRotation=De,x.parseSelector=D,x.parseSpecificResource=Ye,x.serialiseContentState=Fi,x.unwrapObject=Ze,x.validateContentState=re,x.wrapObject=$,Object.defineProperties(x,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
//# sourceMappingURL=index.umd.js.map
