{"version":3,"file":"annotorious-svelte.es4.js","sources":["../src/osd/OpenSeadragonPopup.svelte"],"sourcesContent":["<script lang=\"ts\">\n  import { onMount } from 'svelte';\n  import { draggable } from '@neodrag/svelte';\n  import OpenSeadragon from 'openseadragon';\n  import type { Selection, StoreChangeEvent, SvelteAnnotatorState } from '@annotorious/core';\n  import type { ImageAnnotation } from '@annotorious/annotorious';\n\n  export let state: SvelteAnnotatorState<ImageAnnotation>;\n\n  export let viewer: OpenSeadragon.Viewer;\n\n  let left: number;\n\n  let top: number;\n\n  let dragged = false;\n\n  let storeObserver: (event: StoreChangeEvent<ImageAnnotation>) => void;\n\n  const { selection, store } = state; \n\n  const isSelected = (selection: Selection) => selection.selected?.length > 0;\n\n  const onDragStart = () => {\n    dragged = true;\n    viewer.setMouseNavEnabled(false);\n  }\n\n  const onDragEnd = () => {\n    viewer.setMouseNavEnabled(true);\n  }\n\n  $: $selection, onSelect();\n\n  const onSelect = () => {\n    if (storeObserver)\n      store.unobserve(storeObserver);\n\n    if (isSelected($selection)) {\n      dragged = false;\n\n      setPosition($selection);\n\n      storeObserver = (event: StoreChangeEvent<ImageAnnotation>) => {\n        if (!dragged)\n          setPosition($selection);\n      }\n\n      store.observe(storeObserver, { annotations: $selection.selected.map(s => s.id) });\n    }\n  }\n\n  const setPosition = (selection: Selection) => {\n    // Note: this demo popup only supports a single selection\n    const selectedId = selection.selected[0].id;\n    const annotation = store.getAnnotation(selectedId);\n\n    const { minX, minY, maxX, maxY } = annotation.target.selector.geometry.bounds;\n\n    const PADDING = 14;\n\n    const topLeft = viewer.viewport.imageToViewerElementCoordinates(new OpenSeadragon.Point(minX, minY));\n    const bottomRight = viewer.viewport.imageToViewerElementCoordinates(new OpenSeadragon.Point(maxX, maxY));\n\n    // [left, top] = defaultStrategy(annotation, lastPointerDown);\n    left = bottomRight.x + PADDING;\n    top = topLeft.y;\n  }\n\n  onMount(() => {\n    const onUpdateViewport = () => {\n      if (isSelected($selection) && !dragged)\n        setPosition($selection);\n    }\n\n    viewer.addHandler('update-viewport', onUpdateViewport);\n\n    return () => {\n      viewer.removeHandler('update-viewport', onUpdateViewport);\n    }\n  });\n</script>\n\n{#if $selection}\n  <div \n    class=\"a9s-popup a9s-osd-popup\"\n    use:draggable={{ position: { x: left, y: top }}}\n    on:neodrag:start={onDragStart}\n    on:neodrag:end={onDragEnd}>\n    {$selection.selected.map(s => s.id).join(', ')}\n  </div>\n{/if}\n\n<style>\n  .a9s-osd-popup {\n    background-color: #fff;\n    border: 1px solid #a2a2a2;\n    height: 250px;\n    position: absolute;\n    width: 400px;\n    z-index: 1;\n  }\n</style>"],"names":["t_value","ctx","func","insert","target","div","anchor","dirty","set_data","create_if_block","s","state","$$props","viewer","left","top","dragged","storeObserver","selection","store","isSelected","_a","onDragStart","onDragEnd","onSelect","$selection","setPosition","event","selectedId","annotation","minX","minY","maxX","maxY","PADDING","topLeft","OpenSeadragon","bottomRight","$$invalidate","onMount","onUpdateViewport"],"mappings":";;;;;SAyFKA;AAAA;AAAA,IAAAC,KAAW,SAAS,IAAeC,CAAA,EAAA,KAAK,IAAI,IAAA;AAAA;;;;;;AAL/C,MAAAC,EAMKC,GAAAC,GAAAC,CAAA;;UAJc,YAAY;AAAA;AAAA,YAAGL,EAAM,CAAA;AAAA,aAAA;AAAA;AAAA,YAAGA,EAAG,CAAA;AAAA,YAAA;AAAA;;;;;UAC1BA,EAAW,CAAA;AAAA,QAAA;AAAA;;;;UACbA,EAAS,CAAA;AAAA,QAAA;AAAA;;;AACxB,MAAAM;AAAA,MAAA,KAAAP,OAAAA;AAAA,MAAAC,KAAW,SAAS,IAAeC,CAAA,EAAA,KAAK,IAAI,IAAA,OAAAM,EAAA,GAAAR,CAAA;;QAH5B,YAAY;AAAA;AAAA,UAAGC,EAAM,CAAA;AAAA,WAAA;AAAA;AAAA,UAAGA,EAAG,CAAA;AAAA,UAAA;AAAA;;;;;;;;;;IAH3CA,EAAU,CAAA,KAAAQ,EAAAR,CAAA;AAAA;;;;;;;;;;MAAVA,EAAU,CAAA;;;;;;;;;UAMc,CAAAS,MAAKA,EAAE;;WAlFvB,OAAAC,EAA4C,IAAAC,KAE5C,QAAAC,EAA4B,IAAAD,GAEnCE,GAEAC,GAEAC,IAAU,IAEVC;UAEI,WAAAC,GAAW,OAAAC,EAAK,IAAKR;;QAEvBS,IAAc,CAAAF,MAAyB;;AAAA,aAAAG,IAAAH,EAAU,aAAV,gBAAAG,EAAoB,UAAS;AAAA,KAEpEC,IAAW,MAAA;AACf,IAAAN,IAAU,IACVH,EAAO,mBAAmB,EAAK;AAAA,KAG3BU,IAAS,MAAA;AACb,IAAAV,EAAO,mBAAmB,EAAI;AAAA,KAK1BW,IAAQ,MAAA;AACR,IAAAP,KACFE,EAAM,UAAUF,CAAa,GAE3BG,EAAWK,CAAU,MACvBT,IAAU,IAEVU,EAAYD,CAAU,GAEtBR,IAAiB,CAAAU,MAAwC;MAClDX,KACHU,EAAYD,CAAU;AAAA,OAG1BN,EAAM,QAAQF,GAAa;AAAA,MAAI,aAAaQ,EAAW,SAAS,IAAI,CAAAf,MAAKA,EAAE,EAAE;AAAA;KAI3EgB,IAAe,CAAAR,MAAoB;AAEjC,UAAAU,IAAaV,EAAU,SAAS,CAAC,EAAE,IACnCW,IAAaV,EAAM,cAAcS,CAAU,GAEzC,EAAA,MAAAE,GAAM,MAAAC,GAAM,MAAAC,GAAM,MAAAC,EAAI,IAAKJ,EAAW,OAAO,SAAS,SAAS,QAEjEK,IAAU,IAEVC,IAAUtB,EAAO,SAAS,gCAAoC,IAAAuB,EAAc,MAAMN,GAAMC,CAAI,CAAA,GAC5FM,IAAcxB,EAAO,SAAS,gCAAoC,IAAAuB,EAAc,MAAMJ,GAAMC,CAAI,CAAA;AAGtG,IAAAK,EAAA,GAAAxB,IAAOuB,EAAY,IAAIH,CAAO,QAC9BnB,IAAMoB,EAAQ,CAAC;AAAA;AAGjB,SAAAI,EAAO,MAAA;UACCC,IAAgB,MAAA;AAChB,MAAApB,EAAWK,CAAU,KAAA,CAAMT,KAC7BU,EAAYD,CAAU;AAAA;AAG1B,WAAAZ,EAAO,WAAW,mBAAmB2B,CAAgB;AAGnD,MAAA3B,EAAO,cAAc,mBAAmB2B,CAAgB;AAAA;;;;;SA9C7ChB,EAAQ;AAAA;;;;;;;;"}